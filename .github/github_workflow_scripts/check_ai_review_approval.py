import sys
import argparse
from github import Github
import requests
import urllib3
from utils import timestamped_print

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
print = timestamped_print

SKIP_LABEL = "skip-ai-review"
BOT_USERNAME = "content-bot"
REQUIRED_TEXT = "please review and approve the results generated by the AI Reviewer by responding üëç on this comment."
REPO_OWNER = "demisto"
REPO_NAME = "content"


def arguments_handler():
    """Validates and parses script arguments.
    Return
        Namespace: Parsed arguments object.
    """
    parser = argparse.ArgumentParser(description="Check if AI review is approved.")
    parser.add_argument("-p", "--pr_number", help="The PR number to check.")
    parser.add_argument("-g", "--github_token", help="The GitHub token to authenticate the GitHub client.")
    return parser.parse_args()


def get_reactions_query():
    """Returns the GraphQL query to fetch reactions for a specific Node ID."""
    return """
    query($nodeId: ID!) {
      node(id: $nodeId) {
        ... on PullRequestReview {
          reactions(first: 20) {
            nodes {
              content
              user { login }
            }
          }
        }
      }
    }
    """


def fetch_reactions_via_graphql(node_id: str, token: str) -> list:
    """
    Uses GraphQL to fetch reactions for a specific GitHub Node ID (the review).
    This allows us to get the specific reaction content (THUMBS_UP) reliably.
    """
    url = "https://api.github.com/graphql"
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json",
    }
    variables = {"nodeId": node_id}

    try:
        response = requests.post(
            url, json={"query": get_reactions_query(), "variables": variables}, headers=headers, verify=False
        )
        response.raise_for_status()
        data = response.json()

        reactions = data.get("data", {}).get("node", {}).get("reactions", {}).get("nodes", [])
        return reactions
    except Exception as e:
        print(f"‚ö†Ô∏è GraphQL Request Failed for node {node_id}: {e}")
        return []


def find_reaction_on_review(reviews, github_token):
    ai_review_found = False
    for review in reviews:
        if review.user and review.user.login == BOT_USERNAME and REQUIRED_TEXT in review.body:
            ai_review_found = True
            print(f"Found Bot Review (Node ID: {review.raw_data['node_id']}). Checking reactions via GraphQL...")

            reactions = fetch_reactions_via_graphql(review.raw_data["node_id"], github_token)
            for reaction in reactions:
                content = reaction.get("content")
                user = reaction.get("user", {}).get("login")

                if content == "THUMBS_UP":
                    print(f"Found üëç reaction from user: {user}")
                    print("‚úÖ AI Review approved.")
                    sys.exit(0)
    return ai_review_found


def main():
    options = arguments_handler()
    pr_number = options.pr_number
    github_token = options.github_token
    print(f"Checking PR {pr_number}")

    g = Github(github_token, verify=False)
    repo = g.get_repo(f"{REPO_OWNER}/{REPO_NAME}")
    pr = repo.get_pull(int(pr_number))

    current_labels = [label.name for label in pr.get_labels()]

    if SKIP_LABEL in current_labels:
        print(f'‚úÖ Found "{SKIP_LABEL}" label. Skipping AI review check.')
        sys.exit(0)

    print("Fetching reviews...")
    reviews = pr.get_reviews()

    ai_review_found = find_reaction_on_review(reviews, github_token)

    if ai_review_found:
        print("‚ùå AI Review found, but no üëç reaction detected.")
        sys.exit(1)
    else:
        print("‚ùå AI Review check failed. No AI Review comment found.")
        sys.exit(1)


if __name__ == "__main__":
    main()
