import sys
import argparse
import urllib3
from github import Github
from github.Repository import Repository
from github.PullRequest import PullRequest
from utils import timestamped_print

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
print = timestamped_print

SKIP_LABEL = "skip-ai-review"
BOT_USERNAME = "content-bot"
REQUIRED_TEXT = "please review and approve the results generated by the AI Reviewer by responding üëç on this comment."
REPO = "demisto/content"
ORG_NAME = "demisto"
PERMITTED_TEAM_SLUG = "content-ai-reviewer-developers"
CONTRIB_BRANCH_PREFIX = "contrib/"


def arguments_handler():
    """Validates and parses script arguments.

    Returns:
       Namespace: Parsed arguments object.
    """
    parser = argparse.ArgumentParser(description="Check if AI review is approved.")
    parser.add_argument("-p", "--pr_number", help="The PR number to check.")
    parser.add_argument("-g", "--github_token", help="The GitHub token to authenticate the GitHub client.")
    return parser.parse_args()


def is_user_in_permitted_team(github_client: Github, username: str) -> bool:
    """
    Check if a user is a member of the content-ai-reviewer-developers team.

    Args:
        github_client: The authenticated GitHub client.
        username: The GitHub username to check.

    Returns:
        True if the user is a member of the permitted team, False otherwise.
    """
    try:
        org = github_client.get_organization(ORG_NAME)
        team = org.get_team_by_slug(PERMITTED_TEAM_SLUG)
        user = github_client.get_user(username)
        return team.has_in_members(user)
    except Exception as e:
        print(f"Error checking team membership for {username}: {e}")
        return False


def was_skip_label_added_by_permitted_user(pr: PullRequest, github_client: Github) -> tuple[bool, str]:
    """
    Check if the skip-ai-review label was added by a member of the permitted team.

    Args:
        pr: The pull request to check.
        github_client: The authenticated GitHub client.

    Returns:
        Tuple of (True, username) if the label was added by a permitted user,
        (False, "") otherwise.
    """
    for event in pr.get_issue_events():
        if event.event == "labeled" and event.label.name == SKIP_LABEL:
            actor_login = event.actor.login
            if is_user_in_permitted_team(github_client, actor_login):
                return True, actor_login
    return False, ""


def is_contrib_branch_by_content_bot(pr: PullRequest) -> bool:
    """
    Check if the PR is from a contrib branch and authored by content-bot.

    Args:
        pr: The pull request to check.

    Returns:
        True if the PR head branch starts with contrib/ and author is content-bot.
    """
    return pr.head.ref.startswith(CONTRIB_BRANCH_PREFIX) and pr.user.login == BOT_USERNAME


def main():
    """
    This script checks if the AI review has been approved by a human reviewer.
    It passes if:
    1. The PR there exists a 'skip-ai-review' label AND it was added by a permitted user
       OR the PR is from a contrib/* branch authored by content-bot.
    2. OR there is a comment from 'content-bot' with the required text AND a '+1' reaction.
    """
    options = arguments_handler()
    pr_number = options.pr_number
    github_token = options.github_token

    github_client: Github = Github(github_token, verify=False)
    content_repo: Repository = github_client.get_repo(REPO)
    pr: PullRequest = content_repo.get_pull(int(pr_number))

    # 1. Check for Bypass Label with proper authorization
    pr_label_names = [label.name for label in pr.labels]
    if SKIP_LABEL in pr_label_names:
        # Check if this is a contrib branch PR by content-bot
        if is_contrib_branch_by_content_bot(pr):
            print(f'‚úÖ Found "{SKIP_LABEL}" label on contrib branch PR by {BOT_USERNAME}. Skipping AI review check.')
            sys.exit(0)

        # Check if the label was added by a permitted team member
        is_permitted, added_by = was_skip_label_added_by_permitted_user(pr, github_client)
        if is_permitted:
            print(f'‚úÖ Found "{SKIP_LABEL}" label added by {added_by} (member of {PERMITTED_TEAM_SLUG}). Skipping AI review check.')
            sys.exit(0)

        # Label exists but not authorized
        print(f'‚ö†Ô∏è Found "{SKIP_LABEL}" label, but it was not added by a member of {PERMITTED_TEAM_SLUG}. Ignoring label.')

    print(f"Checking for AI review approval in PR {pr_number}...")

    # 2. Verify content-bot's comment existance and review approval.
    reviews = pr.get_reviews()
    found_bot_comment = False

    for review_comment in reviews:
        print(review_comment.body)
        # Check if comment is from the bot and has the required text
        if (review_comment.user.login == BOT_USERNAME) and (REQUIRED_TEXT in review_comment.body):
            found_bot_comment = True
            print(f"Found AI Review comment (ID: {review_comment.id})")

    if not found_bot_comment:
        print("‚ùå AI Review check failed. No AI Review comment found from content-bot.")
        sys.exit(1)


if __name__ == "__main__":
    main()
