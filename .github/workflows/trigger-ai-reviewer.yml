name: Trigger AI Reviewer

on:
  push:
  issue_comment:
    types: [created]
  pull_request:
    types: [review_requested]

env:
  IGNORED_BOTS: '["content-bot", "xsoar-bot", "dependabot"]'
  ALLOWED_COMMANDS: '["@content-bot start review", "@content-bot re-reviewv"]'

jobs:
  trigger-ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Trigger AI Review
        env:
          REPO: "${{ github.repository }}"
          GITHUB_TOKEN: ${{ secrets.MARKETPLACE_AI_REVIEWER_GITHUB_TOKEN}}
          COMMENT_ID: ${{ github.event.comment.id }}
          TRIGGER_TYPE: ${{ github.event_name }}
        run: |
          echo "ðŸš€ Triggering AI Reviewer (via $TRIGGER_TYPE)..."
          echo "$REPO"
          if [[ "$TRIGGER_TYPE" == "issue_comment" ]]; then
            PR_NUMBER="${{ github.event.issue.number }}"
          elif [[ "$TRIGGER_TYPE" == "pull_request" ]]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          echo "$PR_NUMBER"

          git config --global user.email "bot@demisto.com"
          git config --global user.name "Content Bot"
          
          gh api "repos/$REPO/issues/$PR_NUMBER/labels" -f name="ready-for-ai-review"
          git commit --allow-empty -m "Trigger AI Reviewer"

          git push
      
     