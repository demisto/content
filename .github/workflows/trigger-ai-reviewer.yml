name: Trigger AI Reviewer

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [review_requested]

jobs:
  trigger-ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    if: >-
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       (github.event.comment.author_association == 'MEMBER' || github.event.comment.author_association == 'OWNER') &&
       !contains(fromJson('["content-bot", "xsoar-bot", "dependabot"]'), github.event.comment.user.login) &&
       (contains(github.event.comment.body, '@content-bot start review') || 
        contains(github.event.comment.body, '@content-bot re-review'))) ||
      (github.event_name == 'pull_request' &&
       github.event.requested_reviewer.login == 'content-bot')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Trigger AI Review
        env:
          REPO: "${{ github.repository }}"
          GITHUB_TOKEN: ${{ secrets.MARKETPLACE_AI_REVIEWER_GITHUB_TOKEN}}
          COMMENT_ID: ${{ github.event.comment.id }}
          TRIGGER_TYPE: ${{ github.event_name }}
        run: |
          echo "üöÄ Triggering AI Reviewer (via $TRIGGER_TYPE)..."
          
          # --- 1. DETERMINE PR NUMBER ---
          if [[ "$TRIGGER_TYPE" == "issue_comment" ]]; then
            PR_NUMBER="${{ github.event.issue.number }}"
          elif [[ "$TRIGGER_TYPE" == "pull_request" ]]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          
          # --- 2. GET BRANCH ---
          PR_BRANCH=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json headRefName --jq '.headRefName')
          
          if [[ -z "$PR_BRANCH" ]]; then
             echo "‚ùå Error: Could not find branch name."
             exit 1
          fi

          echo "‚úÖ Target Branch: $PR_BRANCH"

          # --- 3. CHECKOUT & NUKE DEFAULT CONFIG ---
          git fetch origin "$PR_BRANCH"
          git checkout "$PR_BRANCH"

          # üî• CRITICAL STEP: Remove the default token headers that block the push
          git config --local --unset-all http.https://github.com/.extraheader || true
          git config --global --unset-all http.https://github.com/.extraheader || true

          # üî• CRITICAL STEP: Force 'origin' to use your PAT
          git remote set-url origin "https://${GITHUB_TOKEN}@github.com/${REPO}.git"

          # --- 4. CONFIG USER ---
          git config --global user.email "devtestdemisto@paloaltonetworks.com"
          git config --global user.name "Content Bot"
          
          # --- 5. ACTION ---
          gh issue edit "$PR_NUMBER" --add-label "ready-for-ai-review" --repo "$REPO"
          
          # --- 6. REAL COMMIT (To bypass empty-commit filters) ---
          date > .ai-review-trigger
          git add .ai-review-trigger
          git commit -m "Trigger AI Reviewer [skip ci]" || echo "Nothing to commit"

          # --- 7. PUSH ---
          # Now we can just push to origin, because origin IS the PAT.
          echo "‚¨ÜÔ∏è Pushing to $PR_BRANCH..."
          git push origin HEAD:refs/heads/"$PR_BRANCH"