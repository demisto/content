name: Check Devcontainer
on:
  pull_request:
    paths:
      - .devcontainer/**
      - pyproject.toml
      - poetry.lock
  push:
    branches:
      - master
    paths:
      - .devcontainer/**
jobs:
  Build-Devcontainer:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: install poetry
      run: pipx install poetry
    - name: setup python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        cache: poetry
    - name: Check if pyproject.toml or poetry.lock has been changed
      id: changed-files-poetry
      uses: tj-actions/changed-files@v35
      with:
        files: |
          pyproject.toml
          poetry.lock
    - name: install dependencies
      if: steps.changed-files-poetry.outputs.any_changed == 'true'
      run: poetry install
    - name: Write version file to .devcontainer
      if: steps.changed-files-poetry.outputs.any_changed == 'true'
      run: |
        echo -e "This file is autogenerated on every pyproject.toml/poetry.lock change, and is only used for generating new Codespace images. DO NOT CHANGE MANUALLY.\n\n $(poetry show | grep demisto-sdk)" > .devcontainer/demisto-sdk-version.txt
    - name: commit file
      if: steps.changed-files-poetry.outputs.any_changed == 'true'
      uses: stefanzweifel/git-auto-commit-action@v4
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        commit_message: Update demisto-sdk version in devcontainer
    - name: Run demisto-sdk in devcontainer
      uses: devcontainers/ci@v0.2
      with:    
        push: never
        runCmd: demisto-sdk --version
