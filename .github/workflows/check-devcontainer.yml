name: Check Devcontainer
on:
  pull_request:
    paths:
      - .devcontainer/**
      - pyproject.toml
      - poetry.lock
  push:
    branches:
      - master
    paths:
      - .devcontainer/**
jobs:
  Build-Devcontainer:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: install poetry
      run: pipx install poetry
    - name: setup python
      uses: actions/setup-python@v4
      with:
        python-version: 3.10
        cache: poetry
    - name: install dependencies
      run: poetry install
    - name: Check if pyproject.toml or poetry.lock has been changed
      id: changed-files-poetry
      uses: tj-actions/changed-files@v35
      with:
        files: |
          pyproject.toml
          poetry.lock
    - name: Write version file to .devcontainer
      if: steps.changed-files-poetry.outputs.any_changed == 'true'
      run: |
        echo $(poetry show | grep demisto-sdk) > .devcontainer/demisto-sdk-version.txt
    - name: commit file
      if: steps.changed-files-poetry.outputs.any_changed == 'true'
      uses: EndBug/add-and-commit@v9
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        add: .devcontainer/demisto-sdk-version.txt
        message: "Update demisto-sdk version in devcontainer"

    - name: Run demisto-sdk in devcontainer
      uses: devcontainers/ci@v0.2
      with:    
        push: never
        runCmd: demisto-sdk --version
