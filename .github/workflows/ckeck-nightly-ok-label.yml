name: Check nightly-ok Label

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]

jobs:
  check_label:
    runs-on: ubuntu-latest

    steps:
#      - name: Checkout repo
#        uses: actions/checkout@v4

      - name: Check if files under .gitlab directory are changed
        id: check-changes
        run: |
          diff=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep '^\.gitlab/')
          if (diff) {
              console.log('Files under .gitlab folder has changed, Will check if the PR has the nightly-ok label.');
            } else {
              console.log('PR does not have the `nightly-ok` label. it is required when changing files under tht `.gitlab` directory.');
              process.exit(0); // Will finish the process with exit code 0.
            }

      - name: Check if PR has the nightly-ok label
        uses: actions/github-script@v5
        id: check-label
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(label => label.name);
            const hasLabel = labels.includes('nightly-ok');
            if (hasLabel) {
              console.log('All good, the PR has the nightly-ok label.');
            } else {
              console.log('PR does not have the `nightly-ok` label. It is required when changing files under the `.gitlab` directory. Please run nightly using the Utils/gitlab_triggers/trigger_content_nightly_build.sh script, check that succeeded, and add the `nightly-ok` label');
              process.exit(1); // Exit with failure status if label is missing
            }
