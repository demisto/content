name: AI Reviewer Trigger (Debug)

on:
  issue_comment:
    types: [created]

jobs:
  trigger-ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Debug - Command Detection
        env:
          GITHUB_TOKEN: ${{ secrets.CONTENTBOT_GH_ADMIN_TOKEN }}
          IS_PR: ${{ !!github.event.issue.pull_request }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          AUTHOR_ASSOCIATION: ${{ github.event.comment.author_association }}
          USER_LOGIN: ${{ github.event.comment.user.login }}
        run: |
          echo "üîé Analyzing Comment:"
          echo "    \"\"\"$COMMENT_BODY\"\"\""

          # 1. Check if it's a PR
          if [[ "$IS_PR" != "true" ]]; then
            echo "‚ÑπÔ∏è Ignoring comment: Not a Pull Request"
            exit 0
          fi

          # 2. Check Author Association
          if [[ "$AUTHOR_ASSOCIATION" != "MEMBER" && "$AUTHOR_ASSOCIATION" != "OWNER" ]]; then
            echo "‚ÑπÔ∏è Ignoring comment: User is not a MEMBER or OWNER (Association: $AUTHOR_ASSOCIATION)"
            exit 0
          fi

          # 3. Check for Bots
          if [[ "$USER_LOGIN" == "content-bot" || "$USER_LOGIN" == "xsoar-bot" || "$USER_LOGIN" == "dependabot" ]]; then
            echo "‚ÑπÔ∏è Ignoring comment: User is a bot ($USER_LOGIN)"
            exit 0
          fi

          # 4. Check if no reviews in progress
          # Fetch the last 5 comments, reverse sort by date, and find the first one that is NOT the current comment
          # AND contains a command. Then check if it has a rocket reaction.
          
          PREV_COMMAND_ID=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            --jq 'sort_by(.created_at) | reverse | .[] | select(.id != ${{ github.event.comment.id }} and (.body | contains("@content_bot start review") or contains("@content_bot re-review"))) | .id' | head -n 1)

          if [[ -n "$PREV_COMMAND_ID" ]]; then
            echo "üîé Found previous command (ID: $PREV_COMMAND_ID)"
            if gh api repos/${{ github.repository }}/issues/comments/$PREV_COMMAND_ID/reactions --jq '.[].content' | grep -q "rocket"; then
              echo "‚ö†Ô∏è Review already in progress (Rocket reaction found on comment $PREV_COMMAND_ID)"
              echo "‚ÑπÔ∏è Ignoring new command."
              exit 0
            else
              echo "‚úÖ Previous command finished (No rocket reaction). Proceeding."
            fi
          fi

          # 5. Check for Commands
          if [[ "$COMMENT_BODY" == *"@content_bot start review"* || "$COMMENT_BODY" == *"@content_bot re-review"* ]]; then
            echo "‚úÖ Detected 'content-bot' execution command"

            # # push new empty commit so the ai reviewer is triggered in the build
            git config --global user.email "bot@demisto.com"
            git config --global user.name "Content Bot"

            # # Checkout the PR branch
            # gh pr checkout ${{ github.event.issue.number }}

            git commit --allow-empty -m "Trigger AI Reviewer"
            git push

            echo "‚úÖ Triggered AI Reviewer"
            
          else
             echo "‚ÑπÔ∏è Ignoring comment: No valid command detected"
          fi
      
     