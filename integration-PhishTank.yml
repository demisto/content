category: Data Enrichment & Threat Intelligence
commonfields:
  id: PhishTank
  version: -1
configuration:
- defaultvalue: "true"
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- defaultvalue: ""
  display: Trust any certificate (unsecure)
  name: insecure
  required: false
  type: 8
- defaultvalue: "1"
  display: Database refresh interval (hours)
  name: fetchIntervalHours
  required: false
  type: 0
description: PhishTank is a free community site where anyone can submit, verify, track
  and share phishing data
display: PhishTank
image: data:image/png;base64,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
name: PhishTank
script:
  commands:
  - arguments:
    - default: true
      description: URL to check
      name: url
      required: true
    description: Check URL Reputation
    name: url
    outputs:
    - contextPath: URL.Data
      description: Bad URLs found
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
  - arguments: []
    description: Reload PhishTank database
    name: phishtank-reload
  - arguments: []
    description: Show PhishTank database status
    name: phishtank-status
  runonce: false
  script: |
    var listSource = 'http://data.phishtank.com/data/online-valid.csv';
    var listUpdateIntervalHours = 1;

    var isNumber = function(obj) {
        return (obj == parseFloat(obj) && obj > 0);
    }

    if (isNumber(params.fetchIntervalHours)) {
        listUpdateIntervalHours = params.fetchIntervalHours;
    }

    var getList = function() {
        var res = http(listSource, {Method: 'GET'}, params.insecure, params.proxy);
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }
        console.log('LOADING');
        var list = res.Body.split("\n");

        var obj={};
        for (var i=0;i<list.length;i++) {
            var line = list[i].split(",");

            var url = removeLastSlash(line[1]);
            if (url) {
                obj[url] = {
                    phish_id: line[0],
                    submission_time: line[3],
                    verified: line[4],
                    verification_time: line[5],
                    online: line[6],
                    target: line[7]
                };
            }
        }

        return obj;
    };

    var reload = function() {
        var list = getList();
        var data={'list':list,'timestamp':new Date().getTime()};
        setIntegrationContext(data);
        return data;
    };

    var isReloadNeeded = function(data) {
        if (!data || !data.timestamp || !data.list) {
            return true;
        }
        now = new Date().getTime();
        if (data.timestamp < now-(3600*1000*listUpdateIntervalHours)) {
            return true;
        }
        return false;
    }

    var removeLastSlash=function(pUrl) {
        var url=pUrl;
        if (url) {
            if (url[url.length - 1] == '/') {
                url = url.substr(0,url.length - 1);
            }
        }
        return url;
    }
    var doURL = function(pUrl) {
        var data = getIntegrationContext();
        if (isReloadNeeded(data)) {
            data = reload();
        }
        var url = removeLastSlash(pUrl);
        var ec = {};
        var md = "### PhishTank Database - URL Query\n";

        if (data.list[url]) {

            var dbotScore = (data.list[url].verified === 'yes') ? 3 : 2;
            addMalicious(ec, outputPaths.url, {
                Data: args.url,
                Malicious: {Vendor: 'PhishTank', Description: 'Match found in PhishTank database'}
            });
            ec.DBotScore = {Indicator: args.url, Type: 'url', Vendor: 'PhishTank', Score: dbotScore};

            md += "#### Found matches for URL " + args.url + "\n";
            md += objToMd(data.list[url]);
            var phishTankURL = 'http://www.phishtank.com/phish_detail.php?phish_id=' + data.list[url].phish_id;
            md += 'Additional details at ['+phishTankURL+']('+phishTankURL+')\n';
        } else {
            md += "#### No matches for URL " + args.url + "\n";
            ec.URL = {
                Data: args.url
            };
            ec.DBotScore = {Indicator: args.url, Type: 'url', Vendor: 'PhishTank', Score: 0};
        }
        var res = {'url':args.url, 'match': true};
        return {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
    };

    switch (command) {
        case 'test-module':
            if (!isNumber(params.fetchIntervalHours)) {
                throw 'PhishTank error: Please provide a numeric value (and bigger than 0) for Database refresh interval (hours)';
            }
            var list=getList();
            if (Object.keys(list).length === 0) {
                throw 'Error - could not fetch PhishTank database';
            }
            return 'ok';
        case 'url':
            return doURL(args.url);
        case 'phishtank-reload':
            data=reload();
            var md = "PhishTank Database reloaded\n";
            md += "Total **" + Object.keys(data.list).length + "** URLs loaded.\n";
            return({Type: entryTypes.note, Contents: {}, ContentsFormat: formats.json, HumanReadable: md});
        case 'phishtank-status':
            data=getIntegrationContext();
            var md = "PhishTank Database Status\n";
            if (!data || !data.list) {
                md += "Database not loaded.\n"
            } else {
                md += "Total **" + Object.keys(data.list).length + "** URLs loaded.\n";
                md += "Last load time **" + new Date(data.timestamp).toString() + "**\n";
            }
            return({Type: entryTypes.note, Contents: {}, ContentsFormat: formats.json, HumanReadable: md});
        default:
            throw 'PhishTank error: unknown command';
    }
  type: javascript
system: true
