category: Messaging
commonfields:
  id: Cisco Spark
  version: -1
configuration:
- defaultvalue: https://api.ciscospark.com
  display: Server URL (e.g. https://192.168.0.1)
  name: server
  required: true
  type: 0
- defaultvalue: ""
  display: API Key
  name: apiKey
  required: true
  type: 4
- defaultvalue: ""
  display: Trust any certificate (unsecure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ""
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
description: Send messages, create rooms and more, via the Cisco Spark API.
detaileddescription: |-
  The Cisco Spark API uses a user token and enables:
  * Create a room and invite people
  * Search for people in your company
  * Post messages into a room
  * Get room history
  * All the other actions which are described in the docs

  For more information, please visit: [https://developer.ciscospark.com/getting-started.html](https://developer.ciscospark.com/getting-started.html).

  The API key is displayed in the "Getting Started" page, after logging in.
display: Cisco Webex Teams
image: data:image/png;base64,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
name: Cisco Spark
script:
  commands:
  - arguments:
    - description: List people with this email address. For non-admin requests, either
        this or displayName are required.
      name: email
    - description: List people whose name starts with this string. For non-admin requests,
        either this or email are required.
      name: displayName
    - description: List people in this organization. Only admin users of another organization
        (such as partners) may use this parameter.
      name: orgId
    - description: Limit the maximum number of people in the response.
      name: max
    description: List people
    name: cisco-spark-list-people
    outputs:
    - contextPath: CiscoSpark.People
      description: The list of people.
  - arguments:
    - description: Email addresses of the person (comma separated)
      isArray: true
      name: emails
    - description: Full name of the person
      name: displayName
    - description: First name of the person
      name: firstName
    - description: Last name of the person
      name: lastName
    - description: URL to the person's avatar in PNG format
      name: avatar
    - description: ID of the organization to which this person belongs
      name: orgId
    - description: Roles of the person (comma separated)
      isArray: true
      name: roles
    - description: Licenses allocated to the person
      isArray: true
      name: licenses
    description: Create a new user account for a given organization. Only an admin
      can create a new user account.
    name: cisco-spark-create-person
  - arguments:
    - description: The person ID
      name: personId
      required: true
    description: Shows details for a person, by ID.
    name: cisco-spark-get-person-details
  - arguments:
    - description: Email addresses of the person (comma separated)
      isArray: true
      name: emails
    - description: Full name of the person
      name: displayName
    - description: First name of the person
      name: firstName
    - description: Last name of the person
      name: lastName
    - description: URL to the person's avatar in PNG format
      name: avatar
    - description: ID of the organization to which this person belongs
      name: orgId
    - description: Roles of the person (comma separated)
      isArray: true
      name: roles
    - description: Licenses allocated to the person (comma separated)
      isArray: true
      name: licenses
    - description: The person ID
      name: personId
      required: true
    description: Update details for a person, by ID. Only an admin can update a person
      details.
    name: cisco-spark-update-person
  - arguments:
    - description: The person ID
      name: personId
      required: true
    description: Remove a person from the system. Only an admin can remove a person.
    name: cisco-spark-delete-person
  - arguments: []
    description: Show the profile for the authenticated user.
    name: cisco-spark-get-own-details
  - arguments:
    - description: Limit the rooms to those associatedwith a team, by ID.
      name: teamId
    - description: Limit the maximum number of rooms in the response.
      name: max
    - auto: PREDEFINED
      description: 'Available values: direct and group. direct returns all 1-to-1
        rooms. group returns all group rooms. If not specified or values not matched,
        will return all room types.'
      name: type
      predefined:
      - direct
      - group
    description: List rooms.
    name: cisco-spark-list-rooms
    outputs:
    - contextPath: CiscoSpark.Rooms
      description: The list of rooms.
  - arguments:
    - description: A user-friendly name for the room.
      name: title
      required: true
    - description: The ID for the team with which this room is associated.
      name: teamId
    description: Creates a room.
    name: cisco-spark-create-room
  - arguments:
    - description: The room ID.
      name: roomId
      required: true
    description: Shows details for a room, by ID.
    name: cisco-spark-get-room-details
  - arguments:
    - description: The room ID.
      name: roomId
      required: true
    - description: A user-friendly name for the room.
      name: title
      required: true
    description: ' Updates details for a room, by ID.'
    name: cisco-spark-update-room
  - arguments:
    - description: The room ID.
      name: roomId
      required: true
    description: Deletes a room, by ID. Deleted rooms cannot be recovered.
    name: cisco-spark-delete-room
  - arguments:
    - description: Limit results to a specific room, by ID.
      name: roomId
    - description: Limit results to a specific person, by ID.
      name: personId
    - description: Limit results to a specific person, by email address.
      name: personEmail
    - description: Limit the maximum number of items in the response.
      name: max
    description: Lists all room memberships. Use either personId or personEmail to
      filter the results.
    name: cisco-spark-list-memberships
    outputs:
    - contextPath: CiscoSpark.Memberships
      description: List of memberships.
  - arguments:
    - description: The room ID.
      name: roomId
      required: true
    - description: The person ID.
      name: personId
    - description: The email address of the person.
      name: personEmail
    - auto: PREDEFINED
      description: Set to true to make the person a room moderator.
      name: isModerator
      predefined:
      - "true"
      - "false"
    description: Add someone to a room by Person ID or email address; optionally making
      them a moderator.
    name: cisco-spark-create-membership
  - arguments:
    - description: The membership ID.
      name: membershipId
      required: true
    description: Get details for a membership by ID.
    name: cisco-spark-get-membership-details
  - arguments:
    - description: The membership ID.
      name: membershipId
      required: true
    - auto: PREDEFINED
      description: Set to true to make the person a room moderator.
      name: isModerator
      predefined:
      - "true"
      - "false"
      required: true
    description: Updates properties for a membership by ID.
    name: cisco-spark-update-membership
  - arguments:
    - description: The membership ID.
      name: membershipId
      required: true
    description: Deletes a membership by ID.
    name: cisco-spark-delete-membership
  - arguments:
    - description: List messages for a room, by ID.
      name: roomId
      required: true
    - description: List messages where the caller is mentioned by specifying "me"
        or the caller personId.
      name: mentionedPeople
    - description: List messages sent before a date and time, in ISO8601 format.
      name: before
    - description: List messages sent before a message, by ID.
      name: beforeMessage
    - description: Limit the maximum number of messages in the response.
      name: max
    description: Lists all messages in a room.
    name: cisco-spark-list-messages
    outputs:
    - contextPath: CiscoSpark.Messages
      description: List of messages, by roomId.
  - arguments:
    - description: The room ID.
      name: roomId
    - description: The ID of the recipient when sending a private 1:1 message.
      name: toPersonId
    - description: The email address of the recipient when sending a private 1:1 message.
      name: toPersonEmail
    - description: The message, in plain text. If markdown is specified this parameter
        may be optionally used to provide alternate text forUI clients that do not
        support rich text.
      name: text
    - description: The message, in markdown format.
      name: markdown
    - description: The public URL to a binary file to be posted into the room. Only
        one file is allowed per message. Uploaded files are automatically converted
        into a format that all Spark clients can render. For the supported media types
        and the behavior of uploads, see the Message AttachmentsGuide.
      name: files
    description: Posts a plain text message, and optionally, a media content attachment,
      to a room.
    name: cisco-spark-create-message
  - arguments:
    - description: The message ID.
      name: messageId
      required: true
    description: Shows details for a message, by message ID.
    name: cisco-spark-get-message-details
  - arguments:
    - description: The message ID.
      name: messageId
      required: true
    description: Deletes a message, by message ID.
    name: cisco-spark-delete-message
  - arguments:
    - description: Limit the maximum number of teams in the response.
      name: max
    description: Lists teams to which the authenticated user belongs.
    name: cisco-spark-list-teams
    outputs:
    - contextPath: CiscoSpark.Teams
      description: List of teams.
  - arguments:
    - description: A user-friendly name for the team.
      name: name
      required: true
    description: Creates a team. The authenticated user is automatically added as
      a member of the team.
    name: cisco-spark-create-team
  - arguments:
    - description: The team ID.
      name: teamId
      required: true
    description: Shows details for a team, by ID.
    name: cisco-spark-get-team-details
  - arguments:
    - description: The team ID.
      name: teamId
      required: true
    - description: A user-friendly name for the team.
      name: name
      required: true
    description: Updates details for a team, by ID.
    name: cisco-spark-update-team
  - arguments:
    - description: The team ID.
      name: teamId
      required: true
    description: Deletes a team, by ID.
    name: cisco-spark-delete-team
  - arguments:
    - description: List team memberships for a team, by ID.
      name: teamId
      required: true
    - description: Limit the maximum number of items in the response.
      name: max
    description: Lists all team memberships for a given team, specified by the teamId
      query parameter.
    name: cisco-spark-list-team-memberships
    outputs:
    - contextPath: CiscoSpark.TeamMemberships
      description: List of team memberships.
  - arguments:
    - description: The team ID.
      name: teamId
      required: true
    - description: The person ID.
      name: personId
    - description: The email address of the person.
      name: personEmail
    - auto: PREDEFINED
      description: Set to true to make the person a team moderator
      name: isModerator
      predefined:
      - "true"
      - "false"
    description: Add someone to a team by Person ID or email address; optionally making
      them a moderator.
    name: cisco-spark-create-team-membership
  - arguments:
    - description: The membership ID.
      name: membershipId
      required: true
    description: Shows details for a team membership, by ID.
    name: cisco-spark-get-team-membership-details
  - arguments:
    - description: The membership ID.
      name: membershipId
      required: true
    - auto: PREDEFINED
      description: Set to true to make the person a team moderator
      name: isModerator
      predefined:
      - "true"
      - "false"
      required: true
    description: Updates a team membership, by ID.
    name: cisco-spark-update-team-membership
  - arguments:
    - description: The membership ID.
      name: membershipId
      required: true
    description: Deletes a team membership, by ID.
    name: cisco-spark-delete-team-membership
  - arguments:
    - description: Limit the maximum number of webhooks in the response. Setting this
        to greater than 100 will return an error.
      name: max
    description: Lists all of your webhooks.
    name: cisco-spark-list-webhooks
    outputs:
    - contextPath: CiscoSpark.Webhooks
      description: List of webhooks.
  - arguments:
    - description: A user-friendly name for this webhook.
      name: name
      required: true
    - description: The URL that receives POST requests for each event.
      name: targetUrl
      required: true
    - description: The resource type for the webhook. Creating a webhook requires
        'read' scope on the resource the webhook is for.
      name: resource
      required: true
    - description: The event type for the webhook.
      name: event
      required: true
    - description: The filter that defines the webhook scope.
      name: filter
    - description: Secret used to generate payload signature
      name: secret
    description: Creates a webhook.
    name: cisco-spark-create-webhook
  - arguments:
    - description: The webhook ID.
      name: webhookId
      required: true
    description: Shows details for a webhook, by ID.
    name: cisco-spark-get-webhook-details
  - arguments:
    - description: The webhook ID.
      name: webhookId
      required: true
    - description: A user-friendly name for this webhook.
      name: name
      required: true
    - description: The URL that receives POST requests for each event.
      name: targetUrl
      required: true
    description: Updates a webhook, by ID.
    name: cisco-spark-update-webhook
  - arguments:
    - description: The webhook ID.
      name: webhookId
      required: true
    description: Deletes a webhook, by ID.
    name: cisco-spark-delete-webhook
  - arguments:
    - description: Limit the maximum number of entries in the response.
      name: max
    description: List all organizations visible by your account.
    name: cisco-spark-list-organizations
    outputs:
    - contextPath: CiscoSpark.Organizations
      description: List of organizations.
  - arguments:
    - description: The organization ID.
      name: orgId
      required: true
    description: Shows details for an organization, by ID.
    name: cisco-spark-get-organization-details
  - arguments:
    - description: Specify the organization.
      name: orgId
    - description: Limit the maximum number of entries in the response.
      name: max
    description: List all licenses for a given organization. If no orgId is specified,
      the default is the organization of the authenticated user.
    name: cisco-spark-list-licenses
    outputs:
    - contextPath: CiscoSpark.Licenses
      description: List of licenses.
  - arguments:
    - description: The license ID.
      name: licenseId
      required: true
    description: Shows details for a license, by ID.
    name: cisco-spark-get-license-details
  - arguments:
    - description: Limit the maximum number of entries in the response.
      name: max
    description: List all roles.
    name: cisco-spark-list-roles
    outputs:
    - contextPath: CiscoSpark.Roles
      description: List of roles.
  - arguments:
    - description: The role ID.
      name: roleId
      required: true
    description: Shows details for a role, by ID.
    name: cisco-spark-get-role-details
  - arguments:
    - description: Email address of the recipient.
      name: toPersonEmail
    - description: The personId of the recipient.
      name: toPersonId
    - description: The message, in plain text. If markdown is specified this parameter
        may be optionally used to provide alternate text forUI clients that do not
        support rich text.
      name: text
    - description: The message, in markdown format.
      name: markdown
    - description: The public URL to a binary file to be posted into the room. Only
        one file is allowed per message. Uploaded files are automatically converted
        into a format that all Spark clients can render. For the supported media types
        and the behavior of uploads, see the Message AttachmentsGuide.
      name: files
    description: Sends a message to a person, by email or person ID.
    name: cisco-spark-send-message-to-person
  - arguments:
    - description: The room name.
      name: toRoomName
    - description: The room ID.
      name: roomId
    - description: The message, in plain text. If markdown is specified this parameter
        may be optionally used to provide alternate text forUI clients that do not
        support rich text.
      name: text
    - description: The message, in markdown format.
      name: markdown
    - description: The public URL to a binary file to be posted into the room. Only
        one file is allowed per message. Uploaded files are automatically converted
        into a format that all Spark clients can render. For the supported media types
        and the behavior of uploads, see the Message AttachmentsGuide.
      name: files
    description: Sends a message to a room, by name or room ID.
    name: cisco-spark-send-message-to-room
  runonce: false
  script: |
    var apiKey = params.apiKey;
    var insecure = params.insecure;
    var proxy = params.proxy;
    var server = params.server;

    if (server[server.length - 1] === '/') {
        server = server.substring(0, server.length - 1);
    }

    server = params.server + '/v1';

    commandParams = {
        'cisco-spark-list-people':                  {'url': 'people', 'method': 'GET'},
        'cisco-spark-create-person':                {'url': 'people', 'method': 'POST'},
        'cisco-spark-get-person-details':           {'url': 'people/%personId%', 'method': 'GET'},
        'cisco-spark-update-person':                {'url': 'people/%personId%', 'method': 'PUT'},
        'cisco-spark-delete-person':                {'url': 'people/%personId%', 'method': 'DELETE'},
        'cisco-spark-get-own-details':              {'url': 'people/me', 'method': 'GET'},

        'cisco-spark-list-rooms':                   {'url': 'rooms', 'method': 'GET'},
        'cisco-spark-create-room':                  {'url': 'rooms', 'method': 'POST'},
        'cisco-spark-get-room-details':             {'url': 'rooms/%roomId%', 'method': 'GET'},
        'cisco-spark-update-room':                  {'url': 'rooms/%roomId%', 'method': 'PUT'},
        'cisco-spark-delete-room':                  {'url': 'rooms/%roomId%', 'method': 'DELETE'},

        'cisco-spark-list-memberships':             {'url': 'memberships', 'method': 'GET'},
        'cisco-spark-create-membership':            {'url': 'memberships', 'method': 'POST'},
        'cisco-spark-get-membership-details':       {'url': 'memberships/%membershipId%', 'method': 'GET'},
        'cisco-spark-update-membership':            {'url': 'memberships/%membershipId%', 'method': 'PUT'},
        'cisco-spark-delete-membership':            {'url': 'memberships/%membershipId%', 'method': 'DELETE'},

        'cisco-spark-list-messages':                {'url': 'messages', 'method': 'GET'},
        'cisco-spark-create-message':               {'url': 'messages', 'method': 'POST'},
        'cisco-spark-get-message-details':          {'url': 'messages/%messageId%', 'method': 'GET'},
        'cisco-spark-delete-message':               {'url': 'messages/%messageId%', 'method': 'DELETE'},

        'cisco-spark-list-teams':                   {'url': 'teams', 'method': 'GET'},
        'cisco-spark-create-team':                  {'url': 'teams', 'method': 'POST'},
        'cisco-spark-get-team-details':             {'url': 'teams/%teamId%', 'method': 'GET'},
        'cisco-spark-update-team':                  {'url': 'teams/%teamId%', 'method': 'PUT'},
        'cisco-spark-delete-team':                  {'url': 'teams/%teamId%', 'method': 'DELETE'},

        'cisco-spark-list-team-memberships':        {'url': 'team/memberships', 'method': 'GET'},
        'cisco-spark-create-team-membership':       {'url': 'team/memberships', 'method': 'POST'},
        'cisco-spark-get-team-membership-details':  {'url': 'team/memberships/%membershipId%', 'method': 'GET'},
        'cisco-spark-update-team-membership':       {'url': 'team/memberships/%membershipId%', 'method': 'PUT'},
        'cisco-spark-delete-team-membership':       {'url': 'team/memberships/%membershipId%', 'method': 'DELETE'},

        'cisco-spark-list-webhooks':                {'url': 'webhooks', 'method': 'GET'},
        'cisco-spark-create-webhook':               {'url': 'webhooks', 'method': 'POST'},
        'cisco-spark-get-webhook-details':          {'url': 'webhooks/%webhookId%', 'method': 'GET'},
        'cisco-spark-update-webhook':               {'url': 'webhooks/%webhookId%', 'method': 'PUT'},
        'cisco-spark-delete-webhook':               {'url': 'webhooks/%webhookId%', 'method': 'DELETE'},

        'cisco-spark-list-organizations':           {'url': 'organizations', 'method': 'GET'},
        'cisco-spark-get-organization-details':     {'url': 'organizations/%organizationId%', 'method': 'GET'},

        'cisco-spark-list-licenses':                {'url': 'licenses', 'method': 'GET'},
        'cisco-spark-get-license-details':          {'url': 'licenses/%licenseId%', 'method': 'GET'},

        'cisco-spark-list-roles':                   {'url': 'roles', 'method': 'GET'},
        'cisco-spark-get-role-details':             {'url': 'roles/%roleId%', 'method': 'GET'},
    }

    var buildEmptyEntryContext = function() {
        return {Type: entryTypes.note, Contents: null, ContentsFormat: formats.json, EntryContext: {}};
    }

    var cloneDict = function(x) {
        var y = {};
        Object.keys(x).forEach(function(key) {
            y[key] = x[key];
        })

        return y;
    }

    var capitalize = function(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    var capitalizeKeys = function(dict) {
        var capitalizedDict = {};
        for (var key in dict) {
            var capitalizedKey = capitalize(key);
            capitalizedDict[capitalizedKey] = dict[key];
        }

        return capitalizedDict;
    }

    var updateContext = function(entry, outputs, contextPath) {
        var contexts = [];
        for (var i = 0; i < outputs.length; i++) {
            contexts.push(capitalizeKeys(outputs[i]));
        }
        entry.EntryContext[contextPath] = contexts;
    }

    var sendRequest = function(method, url) {
        var body = null;
        var requestUrl = server + '/' + url;

        if (method == 'GET') {
            // query parameters
            requestUrl += encodeToURLQuery(args);
        } else {
            // request parameters (body)
            body = JSON.stringify(args);
        }

        var res = http(
            requestUrl,
            {
                Method: method,
                Body: body,
                Headers: {
                    'Content-Type': ['application/json'],
                    'Authorization': ['Bearer ' + apiKey],
                    'Accept': ['application/json']
                },
            },
            insecure,
            proxy
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nResponse: ' + JSON.stringify(res);
        }

        if (res.Body.length > 0) {
            return JSON.parse(res.Body);
        } else {
            return null;
        }
    }

    var processCommand = function(command) {
        return sendRequest(
            commandParams[command].method,
            replaceInTemplatesAndRemove(commandParams[command].url, args)
        );
    }

    var parseResponse = function(command, res) {
        var entry;
        if (res) {
            var isListCommand = (command.indexOf('list') != -1);
            var outputs = isListCommand ? res.items : res;

            if (outputs.length === 0) {
                return 'Response is empty.';
            }

            entry = buildEmptyEntryContext();
            entry.HumanReadable = tableToMarkdown('Cisco Spark Results', outputs);
            entry.Contents = res;
            entry.ContentsFormat = formats.json;

            if (isListCommand) {
                var splitCommand = command.split('-');
                var listType = capitalize(splitCommand[splitCommand.length - 1]);
                updateContext(entry, outputs, 'CiscoSpark.' + listType);
            }

        } else {
            // for commands which return nothing
            entry = 'Command succesful.';
        }

        return entry;
    }

    var sendMessageToPerson = function() {
        if ((!args.toPersonEmail) && (!args.toPersonId)) {
            throw 'Either email or personId must be provided.';
        }

        return processCommand('cisco-spark-create-message');
    }

    var sendMessageToRoom = function() {
        if (args.toRoomName) {
            var res = processCommand('cisco-spark-list-rooms');
            var rooms = res.items;
            var roomId;
            for (var i = 0; i < rooms.length; i++) {
                if (rooms[i].title.indexOf(args.toRoomName) != -1) {
                    if (roomId) {
                        throw 'More than one room starts with the given name: ' + args.toRoomName;
                    }

                    roomId = rooms[i].id;
                }
            }

            if (!roomId) {
                throw 'A room with the given name was not found: ' + args.toRoomName;
            }

            args.roomId = roomId;
            delete args.toRoomName;

        } else if (!args.roomId) {
            throw 'Either room name or roomId must be provided.';
        }

        return processCommand('cisco-spark-create-message');
    }

    var res;
    switch (command) {
        case 'test-module':
            command = 'cisco-spark-list-people';
            args = {'email': 'test@email.com'};

            // test successful authorization
            processCommand(command);
            return 'ok';

        case 'cisco-spark-send-message-to-person':
            res = sendMessageToPerson();
            break;

        case 'cisco-spark-send-message-to-room':
            res = sendMessageToRoom();
            break;

        default:
            res = processCommand(command);
            break;
    }

    return parseResponse(command, res);
  type: javascript
system: true
