category: Forensics & Malware Analysis
commonfields:
  id: Check Point Sandblast Appliance
  version: -1
configuration:
- defaultvalue: ""
  display: Server URL (e.g. https://192.168.0.1)
  name: server
  required: true
  type: 0
- defaultvalue: v1
  display: Version
  name: version
  required: true
  type: 0
- defaultvalue: ""
  display: Trust any certificate (unsecure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ""
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
description: Query, upload and download data using Check Point Sandblast on local
  gateway.
display: Check Point Sandblast Appliance
image: data:image/png;base64,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
name: Check Point Sandblast Appliance
script:
  commands:
  - arguments:
    - description: The md5 to query
      name: md5
    - description: The sha1 to query
      name: sha1
    - description: The sha256 to query
      name: sha256
    - description: File extension (although the service identifies the type)
      name: file_type
    - auto: PREDEFINED
      description: Available features - default is te and av
      name: features
      predefined:
      - te
      - av
      - extraction
      - all
    - description: Array of objects with id and revision of available OS images
      name: images
    - description: Array of supported report formats of - pdf | xml | tar
      name: reports
    - auto: PREDEFINED
      description: By default, reports are returned only for malicious files - you
        can mark this as true and get benign reports
      name: benign_reports
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: If true, response delivers the quota data (for cloud services only)
      name: quota
      predefined:
      - "true"
      - "false"
    - description: File name - service calculates the file name from the part name
      name: file_name
    deprecated: true
    description: Use the Query API to have a client application look for either the
      analysis report of a specific file on the Check Point Threat Prevention service
      databases or the status of a file, uploaded for analysis
    name: sb-query
  - arguments:
    - description: The md5 to query
      name: md5
    - description: The sha1 to query
      name: sha1
    - description: The sha256 to query
      name: sha256
    - description: File extension (although the service identifies the type)
      name: file_type
    - auto: PREDEFINED
      description: Available features - default is te and av
      name: features
      predefined:
      - te
      - av
      - extraction
      - all
    - description: Array of objects with id and revision of available OS images
      name: images
    - description: Array of supported report formats of - pdf | xml | tar
      name: reports
    - auto: PREDEFINED
      description: By default, reports are returned only for malicious files - you
        can mark this as true and get benign reports
      name: benign_reports
      predefined:
      - "true"
      - "false"
    - auto: PREDEFINED
      description: If true, response delivers the quota data (for cloud services only)
      name: quota
      predefined:
      - "true"
      - "false"
    - description: File name - service calculates the file name from the part name
      name: file_name
    description: Use the Query API to have a client application look for either the
      analysis report of a specific file on the Check Point Threat Prevention service
      databases or the status of a file, uploaded for analysis
    name: sandblast-query
    outputs:
    - contextPath: File.Malicious.Vendor
      description: The vendor which found the file as malicious
    - contextPath: File.Malicious.Description
      description: A description of the file as malicious
    - contextPath: File.Malicious.Confidence
      description: Level of confidence that the file is malicious
    - contextPath: File.Malicious.MalwareFamily
      description: The family of malware this file belong to
    - contextPath: File.Malicious.MalwareType
      description: The type of this malware
    - contextPath: File.Malicious.Severity
      description: The severity of this malware
    - contextPath: File.Malicious.SignatureName
      description: The file signature name
    - contextPath: File.MD5
      description: The file md5
    - contextPath: File.SHA1
      description: The file sha1
    - contextPath: File.SHA256
      description: The file sha256
  - arguments:
    - default: true
      description: File name - service calculates the file name from the part name
      name: file_name
      required: true
    - description: The md5 to upload
      name: md5
    - description: The sha1 to upload
      name: sha1
    - description: The sha256 to upload
      name: sha256
    - description: File extension (although the service identifies the type)
      name: file_type
    - auto: PREDEFINED
      description: Available features - default is te and av
      name: features
      predefined:
      - te
      - av
      - extraction
      - all
    - description: Array of objects with id and revision of available OS images
      name: images
    - description: Array of supported report formats of - pdf | xml | tar
      name: reports
    - auto: PREDEFINED
      description: By default, reports are returned only for malicious files - you
        can mark this as true and get benign reports
      name: benign_reports
      predefined:
      - "true"
      - "false"
    - description: The file id
      name: file_id
      required: true
    deprecated: true
    description: Use the Upload API to have a client application request that Check
      Point Threat Prevention modules scan and analyze a file. When you upload a file
      to the service, the file is encrypted. It is un-encrypted during analysis, and
      then deleted
    name: sb-upload
  - arguments:
    - default: true
      description: File name - service calculates the file name from the part name
      name: file_name
      required: true
    - description: The md5 to upload
      name: md5
    - description: The sha1 to upload
      name: sha1
    - description: The sha256 to upload
      name: sha256
    - description: File extension (although the service identifies the type)
      name: file_type
    - auto: PREDEFINED
      description: Available features - default is te and av
      name: features
      predefined:
      - te
      - av
      - extraction
      - all
    - description: Array of objects with id and revision of available OS images
      name: images
    - description: Array of supported report formats of - pdf | xml | tar
      name: reports
    - auto: PREDEFINED
      description: By default, reports are returned only for malicious files - you
        can mark this as true and get benign reports
      name: benign_reports
      predefined:
      - "true"
      - "false"
    - description: The file id
      name: file_id
      required: true
    description: Use the Upload API to have a client application request that Check
      Point Threat Prevention modules scan and analyze a file. When you upload a file
      to the service, the file is encrypted. It is un-encrypted during analysis, and
      then deleted
    name: sandblast-upload
    outputs:
    - contextPath: File.Malicious.Vendor
      description: The vendor which found the file as malicious
    - contextPath: File.Malicious.Description
      description: A description of the file as malicious
    - contextPath: File.Malicious.Confidence
      description: Level of confidence that the file is malicious
    - contextPath: File.Malicious.MalwareFamily
      description: The family of malware this file belong to
    - contextPath: File.Malicious.MalwareType
      description: The type of this malware
    - contextPath: File.Malicious.Severity
      description: The severity of this malware
    - contextPath: File.Malicious.SignatureName
      description: The file signature name
    - contextPath: File.MD5
      description: The file md5
    - contextPath: File.SHA1
      description: The file sha1
    - contextPath: File.SHA256
      description: The file sha256
  - arguments:
    - default: true
      description: File id to download
      name: id
      required: true
    deprecated: true
    description: 'Use the Download API to have a client application download files
      generated by the Check Point Threat Prevention service: analysis reports, Threat
      Emulation sandbox outputs, and more. The request must have the ID of the file
      to download'
    name: sb-download
  - arguments:
    - default: true
      description: File id to download
      name: id
      required: true
    description: 'Use the Download API to have a client application download files
      generated by the Check Point Threat Prevention service: analysis reports, Threat
      Emulation sandbox outputs, and more. The request must have the ID of the file
      to download'
    name: sandblast-download
    outputs:
    - contextPath: File.MD5
      description: The file md5
    - contextPath: File.SHA1
      description: The file sha1
    - contextPath: File.SHA256
      description: The file sha256
    - contextPath: File.Name
      description: The file name
  runonce: false
  script: |-
    var server = params.server;
    var insecure = params.insecure;
    var proxy = params.proxy;
    var version = params.version;
    var requestTemplate = JSON.stringify({request:[{features:['te']}]});
    var base = server.replace(/[\/]+$/, '') +':18194/tecloud/gw/' + version + '/file/';

    var urlDict = {
        'sb-query': 'query',
        'sb-upload': 'upload',
        'sb-download': 'download',
        'sandblast-query': 'query',
        'sandblast-upload': 'upload',
        'sandblast-download': 'download'
    };

    var sendRequest = function(url, body, queryName) {
        var res = http(
                base + url,
                {
                    Method: 'POST',
                    Body: body
                },
                insecure,
                proxy
            );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Failed to ' + queryName + ' , request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }
        return JSON.parse(res.Body);
    };

    var teArgs = {'images': 0, 'reports': 0, 'benign_reports': 1};

    var createRequest = function(args) {
        if (!args.features) {
            args.features = 'all';
        }
        if (args.features !== 'extraction' && args.features !== 'av') {
            var feature = {};
                var keys = Object.keys(teArgs);
                for (var i = 0; i < keys.length; i++) {
                    if (args[keys[i]]) {
                        if (teArgs[keys[i]] === 0) {
                            feature[keys[i]] = JSON.parse(args[keys[i]]);
                        } else if (teArgs[keys[i]] === 1) {
                            feature[keys[i]] = args[keys[i]] === 'true';
                        }
                        delete args[keys[i]];
                    }
                }
                if (Object.keys(feature).length) {
                    args['te'] = feature;
                }
        }
        if (args.features === 'all') {
            args.features = ['te', 'av', 'extraction'];
        } else {
            args.features = [args.features];
        }
        var request = {request: args};
        return JSON.stringify(request);
    };

    var raw;
    switch (command) {
        case 'test-module':
            if (sendRequest(urlDict['sb-query'], createRequest({md5:'31335bc6357f0eb6e3370803b9a6a318'}), 'test')) {
                return 'ok';
            }
            return 'not-cool';
        case 'sandblast-download':
        case 'sb-download':
            var res = http(
                base + urlDict[command] + encodeToURLQuery(args),
                {
                    Method: 'GET'
                },
                insecure,
                proxy
            );
            if (res.StatusCode < 200 || res.StatusCode >= 300) {
                throw 'Failed to ' + urlDict[command] + ' , request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
            }
            // Extract file name from response
            var currentTime = new Date();
            var fileName = command + '_at_' + currentTime.getTime();
            if (res.Headers && res.Headers['Content-Disposition']) {
                var match = /filename=\"(.*)\"/.exec(res.Headers['Content-Disposition']);
                if (match && match[1]) {
                    fileName = match[1];
                }
            }
            raw = {Type: 3, FileID: saveFile(res.Bytes), File: fileName, Contents: fileName};
            break;
        case 'sandblast-upload':
        case 'sb-upload':
            var file_id = args['file_id'];
            delete args['file_id'];
            var res = httpMultipart(
                base + urlDict[command],
                file_id,
                {
                    Method: 'POST'
                },
                {
                    'request': createRequest(args)
                },
                insecure,
                proxy
                );
            if (res.StatusCode < 200 || res.StatusCode >= 300) {
                throw 'Failed to sb-upload , request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
            }
            raw = {Type: entryTypes.note, ContentsFormat: formats.json, Contents: JSON.parse(res.Body)};
            break;
        default:
            var contents = sendRequest(
                urlDict[command],
                command === 'sb-query' || command === 'sandblast-query'? createRequest(args) : requestTemplate, command);
            raw = {Type: entryTypes.note, ContentsFormat: formats.json, Contents: contents};
    }

    if (command === 'sandblast-upload' || command === 'sandblast-query' || command === 'sb-upload' || command === 'sb-query') {
        var uniqueKeys = ['md5', 'sha1', 'sha256'];
        var ec = {};
        if (raw.Contents.response &&
            raw.Contents.response.av &&
            raw.Contents.response.av.malware_info &&
            raw.Contents.response.av.malware_info.malware_type) {
            var maliciousData = {
                Malicious: {
                    Vendor: 'Sandblast',
                    Description: 'Sandblast found this file malicious',
                    Confidence: raw.Contents.response.av.malware_info.confidence,
                    MalwareFamily: raw.Contents.response.av.malware_info.malware_family,
                    MalwareType: raw.Contents.response.av.malware_info.malware_type,
                    Severity: raw.Contents.response.av.malware_info.severity,
                    SignatureName: raw.Contents.response.av.malware_info.signature_name,
                }
            };
            for (var key in uniqueKeys) {
                if (raw.Contents.response[uniqueKeys[key]]) {
                    maliciousData[uniqueKeys[key].toUpperCase()] = raw.Contents.response[uniqueKeys[key]];
                }
            }
            addMalicious(ec, outputPaths.file, maliciousData);
        } else {
            for (var key in uniqueKeys) {
                if (raw.Contents.response[uniqueKeys[key]]) {
                    var val = {};
                    val[uniqueKeys[key].toUpperCase()] = raw.Contents.response[uniqueKeys[key]];
                    ec['File(val.' + uniqueKeys[key].toUpperCase() + ' == obj.' + uniqueKeys[key].toUpperCase() + ')'] = val;
                }
            }
        }
        raw.EntryContext = ec;
        var prefix = command === 'sandblast-upload' ? 'Upload' : 'Query';
        raw.HumanReadable = tableToMarkdown(
            prefix + ' status for file ' +
            raw.Contents.response.file_name + (raw.Contents.response.file_type ? (' file type ' + raw.Contents.response.file_type) : '') +
            ', md5 ' + raw.Contents.response.md5,
            raw.Contents.response.status
        ) + '\n' +
        tableToMarkdown(
            prefix + ' av for file ' +
            raw.Contents.response.file_name + (raw.Contents.response.file_type ? (' file type ' + raw.Contents.response.file_type) : '') +
            ', md5 ' + raw.Contents.response.md5,
            raw.Contents.response.av)+ '\n' +
        tableToMarkdown(
            prefix + ' extraction for file ' +
            raw.Contents.response.file_name + (raw.Contents.response.file_type ? (' file type ' + raw.Contents.response.file_type) : '') +
            ', md5 ' + raw.Contents.response.md5,
            raw.Contents.response.extraction)+ '\n' +
        tableToMarkdown(prefix + ' TE for file ' +
            raw.Contents.response.file_name + (raw.Contents.response.file_type ? (' file type ' + raw.Contents.response.file_type) : '') +
            ', md5 ' + raw.Contents.response.md5,
            raw.Contents.response.te);
    }
    return raw;
  type: javascript
system: true
