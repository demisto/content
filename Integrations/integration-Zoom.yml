commonfields:
  id: Zoom
  version: -1
name: Zoom
display: Zoom
category: Messaging
image: data:image/png;base64,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
description: Use the Zoom integration manage your Zoom users and meetings
configuration:
- display: ""
  name: apiKey
  defaultvalue: ""
  type: 4
  required: true
- display: ""
  name: apiSecret
  defaultvalue: ""
  type: 4
  required: true
- display: Use system proxy settings
  name: proxy
  defaultvalue: "true"
  type: 8
  required: false
script:
  script: |
    import datetime
    import jwt
    import requests
    import json
    import shutil
    from zipfile import ZipFile

    if not demisto.getParam('proxy'):
        del os.environ['HTTP_PROXY']
        del os.environ['HTTPS_PROXY']
        del os.environ['http_proxy']
        del os.environ['https_proxy']


    def get_jwt(apiKey, apiSecret):
        """
        Encode the JWT token given the api ket and secret
        """
        tt = datetime.datetime.now()
        expire_time = int(tt.strftime('%s')) + 5000
        payload  = {
            'iss': apiKey,
            'exp': expire_time
        }
        encoded = jwt.encode(payload, apiSecret, algorithm='HS256')
        return encoded


    URL = 'https://api.zoom.us/v2/'
    ACCESS_TOKEN = get_jwt(demisto.getParam('apiKey'), demisto.getParam('apiSecret'))
    PARAMS = {'access_token': ACCESS_TOKEN}
    HEADERS = {'Content-Type': 'application/json', 'Accept': 'application/json'}


    def return_error(data):
        """
        Return error as result and exit
        """
        demisto.results({
            'Type': entryTypes['error'],
            'ContentsFormat': formats['text'],
            'Contents' : data
        })
        sys.exit(0)


    if demisto.command() == 'test-module':
        res = requests.get(URL + 'users', headers=HEADERS, params=PARAMS)
        if res.status_code == requests.codes.ok:
            demisto.results('ok')
        else:
            return_error('Error testing [%d] - %s' % (res.status_code, res.text))

    elif demisto.command() == 'zoom-create-user':
        ut = demisto.getArg('user_type')
        user_type = 1  # Basic
        if ut == 'Pro':
            user_type = 2
        elif ut == 'Corporate':
            user_type = 3
        res = requests.post(URL + 'users', headers=HEADERS, params=PARAMS, json={
            'action': 'create',
            'user_info': {
                'email': demisto.getArg('email'),
                'type': user_type,
                'first_name': demisto.getArg('first_name'),
                'last_name': demisto.getArg('last_name')
            }
        })
        if res.status_code == requests.codes.created:
            data = res.json()
            demisto.results({
                'Type': entryTypes['note'],
                'ContentsFormat': formats['json'],
                'Contents': data,
                'HumanReadable': 'User created successfully with ID %s' % data.get('id'),
                'EntryContext': {'Zoom.User': data}
            })
        else:
            return_error('User creation failed: [%d] - %s' % (res.status_code, res.text))

    elif demisto.command() == 'zoom-list-users':
        params = {
            'access_token': ACCESS_TOKEN,
            'status': demisto.getArg('status'),
            'page_size': demisto.getArg('page-size'),
            'page_number': demisto.getArg('page-number')
        }
        res = requests.get(URL + 'users', headers=HEADERS, params=params)
        if res.status_code == requests.codes.ok:
            data = res.json()
            md = tableToMarkdown('Users', data.get('users'), ['id', 'first_name', 'last_name', 'email', 'type'])
            md += '\n' + tableToMarkdown('Metadata', [data], ['page_count', 'page_number', 'page_size', 'total_records'])
            demisto.results({
                'Type': entryTypes['note'],
                'ContentsFormat': formats['json'],
                'Contents': data,
                'HumanReadable': md,
                'EntryContext': {
                    'Zoom.User': data.get('users'),
                    'Zoom.Metadata': {
                        'Count': data.get('page_count'),
                        'Number': data.get('page_number'),
                        'Size': data.get('page_size'),
                        'Total': data.get('total_records')
                    }
                }
            })
        else:
            return_error('User creation failed: [%d] - %s' % (res.status_code, res.text))

    elif demisto.command() == 'zoom-delete-user':
        params = {
            'access_token': ACCESS_TOKEN,
            'action': demisto.getArg('action')
        }
        res = requests.delete(URL + 'users/' + demisto.getArg('user'), headers=HEADERS, params=params)
        if res.status_code == requests.codes.no_content:
            demisto.results('User %s deleted successfully' % demisto.getArg('user'))
        else:
            return_error('User creation failed: [%d] - %s' % (res.status_code, res.text))

    elif demisto.command() == 'zoom-create-meeting':
        auto_recording = "none"
        if (demisto.getArg('auto_record_meeting') == 'yes'):
            auto_recording = "cloud"
        params = {
            'type': 1,
            'topic': demisto.getArg('topic'),
            'settings': {
                'join_before_host': True,
                'auto_recording': auto_recording
            }
        }
        if (demisto.args()['type'] == 'Scheduled'):
            params.update({
                'type': 2,
                'start_time': demisto.getArg('start-time'),
                'timezone': demisto.getArg('timezone'),
            })
        res = requests.post(URL + "users/%s/meetings" % demisto.getArg('user'), headers=HEADERS, params=PARAMS, json=params)
        if res.status_code == requests.codes.created:
            data = res.json()
            md = 'Meeting created successfully.\nStart it [here](%s) and join [here](%s).' % (data.get('start_url'), data.get('join_url'))
            demisto.results({
                'Type': entryTypes['note'],
                'ContentsFormat': formats['json'],
                'Contents': data,
                'HumanReadable': md,
                'EntryContext': {'Zoom.Meeting': data}
            })
        else:
            return_error('Meeting creation failed: [%d] - %s' % (res.status_code, res.text))

    elif demisto.command() == 'zoom-fetch-recording':
        meeting = demisto.getArg('meeting_id')
        res = requests.get(URL + 'meetings/%s/recordings' % meeting, headers=HEADERS, params=PARAMS)
        if res.status_code == requests.codes.ok:
            data = res.json()
            recording_files = data['recording_files']
            for file in recording_files:
                download_url = file['download_url']
                r = requests.get(download_url, stream=True)
                if r.status_code < 200 or r.status_code > 299:
                    return_error('Unable to download recording for meeting %s: [%d] - %s' % (meeting, r.status_code, r.text))

                filename = 'recording_%s_%s.mp4' % (meeting, file['id'])
                with open(filename, 'wb') as f:
                    r.raw.decode_content = True
                    shutil.copyfileobj(r.raw, f)

                demisto.results(file_result_existing_file(filename))
                rf = requests.delete(URL + 'meetings/%s/recordings/%s' % (meeting, file['id']), headers=HEADERS, params=PARAMS)
                if rf.status_code == requests.codes.no_content:
                    demisto.results('File ' + filename + ' was moved to trash.')
                else:
                    demisto.results('Failed to delete file ' + filename + '.')
        else:
            return_error('Download of recording failed: [%d] - %s' % (res.status_code, res.text))
    else:
        return_error('Unrecognized command: ' + demisto.command())
  type: python
  commands:
  - name: zoom-create-user
    arguments:
    - name: first_name
      required: true
      description: First name of the new user
    - name: last_name
      required: true
      description: Last name of the new user
    - name: email
      required: true
      description: The email of the new user
    - name: user_type
      auto: PREDEFINED
      predefined:
      - Basic
      - Pro
      - Corporate
      description: The type of the newly created user
      defaultValue: Basic
    outputs:
    - contextPath: Zoom.User.id
      description: The ID of the created user
      type: string
    - contextPath: Zoom.User.first_name
      description: First name of the created user
      type: string
    - contextPath: Zoom.User.last_name
      description: Last name for the created user
      type: string
    - contextPath: Zoom.User.email
      description: Email of the created user
      type: string
    - contextPath: Zoom.User.created_at
      description: Created date of the user
      type: date
    - contextPath: Zoom.User.type
      description: The type of the user
      type: number
    description: Create a new user in zoom account
    execution: true
  - name: zoom-create-meeting
    arguments:
    - name: type
      required: true
      default: true
      auto: PREDEFINED
      predefined:
      - Instant
      - Scheduled
      description: The type of the meeting
      defaultValue: Instant
    - name: user
      required: true
      description: email address or id of user for meeting
    - name: topic
      required: true
      description: The topic of the meeting
    - name: auto-record-meeting
      auto: PREDEFINED
      predefined:
      - "yes"
      - "no"
      description: 'Record zoom meeting? '
      defaultValue: "no"
    - name: start-time
      description: Meeting start time. When using a format like “yyyy-MM-dd’T'HH:mm:ss'Z’”,
        always use GMT time. When using a format like “yyyy-MM-dd’T'HH:mm:ss”, you
        should use local time and you will need to specify the time zone. Only used
        for scheduled meetings and recurring meetings with fixed time.
    - name: timezone
      description: 'Timezone to format start_time. For example, “America/Los_Angeles”.
        For scheduled meetings only. '
    outputs:
    - contextPath: Zoom.Meeting.join_url
      description: Join url for the meeting
      type: string
    - contextPath: Zoom.Meeting.id
      description: Meeting id of the new meeting that is created
      type: string
    - contextPath: Zoom.Meeting.start_url
      description: The URL to start the meeting
      type: string
    description: Create a new zoom meeting (scheduled or instant)
  - name: zoom-fetch-recording
    arguments:
    - name: meeting_id
      required: true
      description: Meeting id to get the recording
    outputs:
    - contextPath: File.SHA256
      description: Attachment's SHA256
    - contextPath: File.SHA1
      description: Attachment's SHA1
    - contextPath: File.MD5
      description: Attachment's MD5
    - contextPath: File.Name
      description: Attachment's Name
    - contextPath: File.Info
      description: Attachment's Info
    - contextPath: File.Size
      description: Attachment's Size (In Bytes)
    - contextPath: File.Extension
      description: Attachment's Extension
    - contextPath: File.Type
      description: Attachment's Type
    - contextPath: File.EntryID
      description: Attachment's EntryID
    - contextPath: File.SSDeep
      description: Attachment's SSDeep hash
    description: Get meeting record and save as file in the warroom
  - name: zoom-list-users
    arguments:
    - name: status
      default: true
      auto: PREDEFINED
      predefined:
      - active
      - inactive
      - pending
      description: Which status of users to list
      defaultValue: active
    - name: page-size
      description: Number of users to return. Max 300.
      defaultValue: "30"
    - name: page-number
      description: Which page of results to return
      defaultValue: "1"
    outputs:
    - contextPath: Zoom.Metadata.Count
      description: Total page count available
      type: number
    - contextPath: Zoom.Metadata.Number
      description: Current page number
      type: number
    - contextPath: Zoom.Metadata.Size
      description: Number of results in current page
      type: number
    - contextPath: Zoom.Metadata.Total
      description: Total number of records
      type: number
    - contextPath: Zoom.User.id
      description: ID of the user
      type: string
    - contextPath: Zoom.User.first_name
      description: First name of user
      type: string
    - contextPath: Zoom.User.last_name
      description: Last name of user
      type: string
    - contextPath: Zoom.User.email
      description: Email of user
      type: string
    - contextPath: Zoom.User.type
      description: Type of user
      type: number
    - contextPath: Zoom.User.created_at
      description: Date when user was created
      type: date
    - contextPath: Zoom.User.dept
      description: Department for user
      type: string
    - contextPath: Zoom.User.verified
      description: Is the user verified
      type: number
    - contextPath: Zoom.User.last_login_time
      description: Last login time of the user
      type: date
    - contextPath: Zoom.User.timezone
      description: Default timezone for the user
      type: string
    - contextPath: Zoom.User.pmi
      description: PMI of user
      type: string
    - contextPath: Zoom.User.group_ids
      description: Groups user belongs to
      type: string
    description: List the existing users
  - name: zoom-delete-user
    arguments:
    - name: user
      required: true
      default: true
      description: The user ID or email to delete
    - name: action
      auto: PREDEFINED
      predefined:
      - disassociate
      - delete
      description: The action to take
      defaultValue: disassociate
    description: Delete a user from Zoom
    execution: true
  dockerimage: demisto/pyjwt:1.0
  runonce: false
