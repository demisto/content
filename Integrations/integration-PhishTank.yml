commonfields:
  id: PhishTank
  version: -1
name: PhishTank
display: PhishTank
category: Threat Intelligence
image: data:image/png;base64,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
description: PhishTank is a free community site where anyone can submit, verify, track
  and share phishing data
defaultEnabled: true
configuration:
- display: Use system proxy settings
  name: proxy
  defaultvalue: "true"
  type: 8
  required: false
- display: Database refresh interval (hours)
  name: fetchIntervalHours
  defaultvalue: "1"
  type: 0
  required: false
script:
  script: |
    var listSource = 'http://data.phishtank.com/data/online-valid.csv';
    var listUpdateIntervalHours = 1;

    var isNumber = function(obj) {
        return (obj == parseFloat(obj) && obj > 0);
    }

    if (isNumber(params.fetchIntervalHours)) {
        listUpdateIntervalHours = params.fetchIntervalHours;
    }

    var getList = function() {
        var res = http(listSource,{Method: 'GET'},false,params.proxy);
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }
        console.log('LOADING');
        var list = res.Body.split("\n");

        var obj={};
        for (var i=0;i<list.length;i++) {
            var line = list[i].split(",");

            var url = removeLastSlash(line[1]);
            if (url) {
                obj[url] = {
                    phish_id: line[0],
                    submission_time: line[3],
                    verified: line[4],
                    verification_time: line[5],
                    online: line[6],
                    target: line[7]
                };
            }
        }

        return obj;
    };

    var reload = function() {
        var list = getList();
        var data={'list':list,'timestamp':new Date().getTime()};
        setIntegrationContext(data);
        return data;
    };

    var isReloadNeeded = function(data) {
        if (!data || !data.timestamp || !data.list) {
            return true;
        }
        now = new Date().getTime();
        if (data.timestamp < now-(3600*1000*listUpdateIntervalHours)) {
            return true;
        }
        return false;
    }

    var removeLastSlash=function(pUrl) {
        var url=pUrl;
        if (url) {
            if (url[url.length - 1] == '/') {
                url = url.substr(0,url.length - 1);
            }
        }
        return url;
    }
    var doURL = function(pUrl) {
        var data = getIntegrationContext();
        if (isReloadNeeded(data)) {
            data = reload();
        }
        var url = removeLastSlash(pUrl);
        var ec = {};
        var md = "### PhishTank Database - URL Query\n";

        if (data.list[url]) {

            var dbotScore = (data.list[url].verified === 'yes') ? 3 : 2;
            addMalicious(ec, outputPaths.url, {
                Data: args.url,
                Malicious: {Vendor: 'PhishTank', Description: 'Match found in PhishTank database'}
            });
            ec.DBotScore = {Indicator: args.url, Type: 'url', Vendor: 'PhishTank', Score: dbotScore};

            md += "#### Found matches for URL " + args.url + "\n";
            md += objToMd(data.list[url]);
            var phishTankURL = 'http://www.phishtank.com/phish_detail.php?phish_id=' + data.list[url].phish_id;
            md += 'Additional details at ['+phishTankURL+']('+phishTankURL+')\n';
        } else {
            md += "#### No matches for URL " + args.url + "\n";
            ec.DBotScore = {Indicator: args.url, Type: 'url', Vendor: 'PhishTank', Score: 0};
        }
        var res = {'url':args.url, 'match': true};
        return {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
    };

    switch (command) {
        case 'test-module':
            if (!isNumber(params.fetchIntervalHours)) {
                throw 'PhishTank error: Please provide a numeric value (and bigger than 0) for Database refresh interval (hours)';
            }
            var list=getList();
            if (Object.keys(list).length === 0) {
                throw 'Error - could not fetch PhishTank database';
            }
            return 'ok';
        case 'url':
            return doURL(args.url);
        case 'phishtank-reload':
            data=reload();
            var md = "PhishTank Database reloaded\n";
            md += "Total **" + Object.keys(data.list).length + "** URLs loaded.\n";
            return({Type: entryTypes.note, Contents: {}, ContentsFormat: formats.json, HumanReadable: md});
        case 'phishtank-status':
            data=getIntegrationContext();
            var md = "PhishTank Database Status\n";
            if (!data || !data.list) {
                md += "Database not loaded.\n"
            } else {
                md += "Total **" + Object.keys(data.list).length + "** URLs loaded.\n";
                md += "Last load time **" + new Date(data.timestamp).toString() + "**\n";
            }
            return({Type: entryTypes.note, Contents: {}, ContentsFormat: formats.json, HumanReadable: md});
        default:
            throw 'PhishTank error: unknown command';
    }
  type: javascript
  commands:
  - name: url
    arguments:
    - name: url
      required: true
      default: true
      description: URL to check
    outputs:
    - contextPath: URL.Data
      description: Bad URLs found
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: Check URL Reputation
  - name: phishtank-reload
    arguments: []
    description: Reload PhishTank database
  - name: phishtank-status
    arguments: []
    description: Show PhishTank database status
