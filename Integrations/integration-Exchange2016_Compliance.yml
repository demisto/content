commonfields:
  id: Exchange 2016 Compliance Search
  version: -1
name: Exchange 2016 Compliance Search
display: Exchange 2016 Compliance Search
category: Messaging
image: data:image/png;base64,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
description: Exchange Server 2016 Compliance Search enables you to search for and delete an email message
  from all mailboxes in your organization.
detaileddescription: |-
  The Compliance Search feature in Exchange Server 2016 enables you to search all mailboxes in your organization. This integration must run on an engine that is installed on a target machine, which is part of a domain.
  The user need to be assigned permissions before running commands of the integration.
configuration:
- display: DOMAIN\USERNAME (e.g., DEMISTO.INT\admin)
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Exchange Server fully qualified domain name (FQDN)
  name: exchangeFQDN
  defaultvalue: ""
  type: 0
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |-
    import sys, subprocess
    import uuid

    USERNAME = demisto.params()['credentials']['identifier'].replace("'", "''")
    PASSWORD = demisto.params()['credentials']['password'].replace("'", "''")
    EXCHANGE_FQDN = demisto.params()['exchangeFQDN'].replace("'", "''")
    UNSECURE = demisto.params()['insecure']

    STARTCS = '''
    [CmdletBinding()]
    Param(
    [Parameter(Mandatory=$True)]
    [string]$username,
    [Parameter(Mandatory=$True)]
    [string]$password,
    [Parameter(Mandatory=$True)]
    [string]$query,
    [Parameter(Mandatory=$True)]
    [string]$server,
    [Parameter(Mandatory=$True)]
    [bool]$unsecure
    )
    $WarningPreference = "silentlyContinue"
    $secpasswd = ConvertTo-SecureString $password -AsPlainText -Force
    $UserCredential = New-Object System.Management.Automation.PSCredential ($username, $secpasswd)
    $searchName = [guid]::NewGuid().ToString() -replace '[-]'
    $searchName = "DemistoSearch" + $searchName
    if($unsecure){
        $url = "http://" + $server + "/PowerShell"
        $session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri $url -Credential $UserCredential -Authentication Kerberos
    }else{
        $url = "https://" + $server + "/PowerShell"
        $session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri $url -Credential $UserCredential -Authentication Basic -AllowRedirection
    }
    if (!$session)
    {
        "Failed to create remote PS session"
        return
    }
    Import-PSSession $session -CommandName *Compliance* -AllowClobber -DisableNameChecking -Verbose:$false | Out-Null
    $compliance = New-ComplianceSearch -Name $searchName -ExchangeLocation All -ContentMatchQuery $query -Confirm:$false
    Start-ComplianceSearch -Identity $searchName
    $complianceSearchName = "Action status: " + $searchName
    $complianceSearchName | ConvertTo-Json
    Remove-PSSession $session
    '''

    GETCS = '''
    [CmdletBinding()]
    Param(
    [Parameter(Mandatory=$True)]
    [string]$username,
    [Parameter(Mandatory=$True)]
    [string]$password,
    [Parameter(Mandatory=$True)]
    [string]$searchName,
    [Parameter(Mandatory=$True)]
    [string]$server,
    [Parameter(Mandatory=$True)]
    [bool]$unsecure
    )
    $WarningPreference = "silentlyContinue"
    $secpasswd = ConvertTo-SecureString $password -AsPlainText -Force
    $UserCredential = New-Object System.Management.Automation.PSCredential ($username, $secpasswd)
    if($unsecure){
        $url = "http://" + $server + "/PowerShell"
        $session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri $url -Credential $UserCredential -Authentication Kerberos
    }else{
        $url = "https://" + $server + "/PowerShell"
        $session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri $url -Credential $UserCredential -Authentication Basic -AllowRedirection
    }
    if (!$session)
    {
        "Failed to create remote PS session"
        return
    }
    Import-PSSession $session -CommandName Get-ComplianceSearch -AllowClobber -DisableNameChecking -Verbose:$false | Out-Null
    $searchStatus = Get-ComplianceSearch $searchName
    $searchStatus.Status
    if ($searchStatus.Status -eq "Completed")
    {
        $searchStatus.SuccessResults | ConvertTo-Json
    }
    Remove-PSSession $session
    '''

    REMOVECS = '''
    [CmdletBinding()]
    Param(
    [Parameter(Mandatory=$True)]
    [string]$username,
    [Parameter(Mandatory=$True)]
    [string]$password,
    [Parameter(Mandatory=$True)]
    [string]$searchName,
    [Parameter(Mandatory=$True)]
    [string]$server,
    [Parameter(Mandatory=$True)]
    [bool]$unsecure
    )
    $WarningPreference = "silentlyContinue"
    $secpasswd = ConvertTo-SecureString $password -AsPlainText -Force
    $UserCredential = New-Object System.Management.Automation.PSCredential ($username, $secpasswd)
    if($unsecure){
        $url = "http://" + $server + "/PowerShell"
        $session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri $url -Credential $UserCredential -Authentication Kerberos
    }else{
        $url = "https://" + $server + "/PowerShell"
        $session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri $url -Credential $UserCredential -Authentication Basic -AllowRedirection
    }
    if (!$session)
    {
        "Failed to create remote PS session"
        return
    }
    Import-PSSession $session -CommandName *Compliance* -AllowClobber -DisableNameChecking -Verbose:$false | Out-Null
    Remove-ComplianceSearch $searchName -Confirm:$false
    Remove-PSSession $session
    '''

    STARTPURGE = '''
    [CmdletBinding()]
    Param(
    [Parameter(Mandatory=$True)]
    [string]$username,
    [Parameter(Mandatory=$True)]
    [string]$password,
    [Parameter(Mandatory=$True)]
    [string]$searchName,
    [Parameter(Mandatory=$True)]
    [string]$server,
    [Parameter(Mandatory=$True)]
    [bool]$unsecure
    )
    $WarningPreference = "silentlyContinue"
    $secpasswd = ConvertTo-SecureString $password -AsPlainText -Force
    $UserCredential = New-Object System.Management.Automation.PSCredential ($username, $secpasswd)
    if($unsecure){
        $url = "http://" + $server + "/PowerShell"
        $session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri $url -Credential $UserCredential -Authentication Kerberos
    }else{
        $url = "https://" + $server + "/PowerShell"
        $session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri $url -Credential $UserCredential -Authentication Basic -AllowRedirection
    }
    if (!$session)
    {
        "Failed to create remote PS session"
        return
    }
    Import-PSSession $session -CommandName *Compliance* -AllowClobber -DisableNameChecking -Verbose:$false | Out-Null
    $newActionResult = New-ComplianceSearchAction -SearchName $searchName -Purge -PurgeType SoftDelete -Confirm:$false
    if (!$newActionResult)
    {
        "No action was created"
    }
    Remove-PSSession $session
    return
    '''

    CHECKPURGE = '''
    [CmdletBinding()]
    Param(
    [Parameter(Mandatory=$True)]
    [string]$username,
    [Parameter(Mandatory=$True)]
    [string]$password,
    [Parameter(Mandatory=$True)]
    [string]$searchName,
    [Parameter(Mandatory=$True)]
    [string]$server,
    [Parameter(Mandatory=$True)]
    [bool]$unsecure
    )
    $WarningPreference = "silentlyContinue"
    $secpasswd = ConvertTo-SecureString $password -AsPlainText -Force
    $UserCredential = New-Object System.Management.Automation.PSCredential ($username, $secpasswd)
    if($unsecure){
        $url = "http://" + $server + "/PowerShell"
        $session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri $url -Credential $UserCredential -Authentication Kerberos
    }else{
        $url = "https://" + $server + "/PowerShell"
        $session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri $url -Credential $UserCredential -Authentication Basic -AllowRedirection
    }
    if (!$session)
    {
        "Failed to create remote PS session"
        return
    }
    Import-PSSession $session -CommandName *Compliance* -AllowClobber -DisableNameChecking -Verbose:$false | Out-Null
    $actionName = $searchName + "_Purge"
    $actionStatus = Get-ComplianceSearchAction $actionName
    ""
    $actionStatus.Status
    Remove-PSSession $session
    '''

    TESTCON = '''
    [CmdletBinding()]
    Param(
    [Parameter(Mandatory=$True)]
    [string]$username,
    [Parameter(Mandatory=$True)]
    [string]$password,
    [Parameter(Mandatory=$True)]
    [string]$server,
    [Parameter(Mandatory=$True)]
    [bool]$unsecure
    )
    $errorActionPreference = 'Stop'
    $WarningPreference = "silentlyContinue"
    $secpasswd = ConvertTo-SecureString $password -AsPlainText -Force
    $UserCredential = New-Object System.Management.Automation.PSCredential ($username, $secpasswd)
    try{
        if($unsecure){
            $url = "http://" + $server + "/PowerShell"
            $session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri $url -Credential $UserCredential -Authentication Kerberos
        }else{
            $url = "https://" + $server + "/PowerShell"
            $session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri $url -Credential $UserCredential -Authentication Basic -AllowRedirection
        }
        echo "successful connection"
    } catch {
        $e = $_.Exception
        echo $e.Message
    } finally {
        Remove-PSSession $session
    }
    '''

    def prepare_args(d):
        return dict((k.replace("-", "_"), v) for k, v in d.items())

    def str_to_unicode(obj):
        if isinstance(obj, dict):
            obj = {k: str_to_unicode(v) for k,v in obj.iteritems()}
        elif isinstance(obj, list):
            obj = map(str_to_unicode, obj)
        elif isinstance(obj, str):
            obj = unicode(obj, "utf-8")
        return obj

    def encode_and_submit_results(obj):
        demisto.results(str_to_unicode(obj))

    def get_cs_status(search_name, status):
        return {
            'Type': entryTypes['note'],
            'ContentsFormat': formats['text'],
            'Contents': 'Search {} status: {}'.format(search_name, status),
            'EntryContext': {
                'EWS.ComplianceSearch(val.Name === obj.Name)': {'Name': search_name, 'Status': status}
            }
        }

    def create_ps_file(ps_name, ps_content):
        temp_path = os.getenv('TEMP')
        if not temp_path:
            return_error("Check that the integration is using single engine without docker. If so, add TEMP variable to the enviroment varibes.")

        ps_path = temp_path + '\\' + ps_name
        with open(ps_path, 'w+') as file:
            file.write(ps_content)
        return ps_path

    def delete_ps_file(ps_path):
        if os.path.exists(ps_path):
            os.remove(ps_path)

    def start_compliance_search(query):
        ps_path = create_ps_file('startcs_' + str(uuid.uuid4()).replace('-','') + '.ps1', STARTCS)
        output = subprocess.Popen(["powershell.exe", ps_path, "'" + USERNAME + "'", "'" + PASSWORD + "'", "'" + query.replace("'", "''") + "'", "'" + EXCHANGE_FQDN + "'", "$" + str(UNSECURE)], \
                                    stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = output.communicate()
        delete_ps_file(ps_path)

        if stderr:
            return_error(stderr)
        prefix = '"Action status: '
        pref_ind = stdout.find(prefix)
        sub_start = pref_ind + len(prefix)
        sub_end = sub_start + 45
        search_name = stdout[sub_start:sub_end]
        return {
            'Type': entryTypes['note'],
            'ContentsFormat': formats['text'],
            'Contents': 'Search started: {}'.format(search_name),
            'EntryContext': {
                'EWS.ComplianceSearch': {'Name': search_name, 'Status': 'Starting'}
            }
        }

    def get_compliance_search(search_name):
        ps_path = create_ps_file('getcs_' + search_name + '.ps1', GETCS)
        output = subprocess.Popen(["powershell.exe", ps_path, "'" + USERNAME + "'", "'" + PASSWORD + "'", "'" + search_name + "'", "'" + EXCHANGE_FQDN + "'", "$" + str(UNSECURE)], \
                                    stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = output.communicate()
        delete_ps_file(ps_path)

        if stderr:
            return_error(stderr)
        stdout = stdout.split('\n', 1)
        status = stdout[0].strip()
        results = [get_cs_status(search_name, status)]

        if status == 'Completed' and len(stdout[1].strip()) > 4:
            res = list(r[:-1].split(', ') if r[-1] == ',' else r.split(', ') for r in stdout[1][2:-4].split(r'\r\n'))
            res = map(lambda x: {k: v for k,v in (s.split(': ') for s in x)}, res)
            results.append(
                {
                    'Type': entryTypes['note'],
                    'ContentsFormat': formats['text'],
                    'Contents': stdout,
                    'ReadableContentsFormat': formats['markdown'],
                    'HumanReadable': tableToMarkdown('Exchange 2016 Compliance search results', res, ['Location', 'Item count', 'Total size'])
                }
            )
        return results

    def remove_compliance_search(search_name):
        ps_path = create_ps_file('removecs_' + search_name + '.ps1', REMOVECS)
        output = subprocess.Popen(["powershell.exe", ps_path, "'" + USERNAME + "'", "'" + PASSWORD + "'", "'" + search_name + "'", "'" + EXCHANGE_FQDN + "'", "$" + str(UNSECURE)], \
                                    stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = output.communicate()
        delete_ps_file(ps_path)

        return return_error(stderr) if stderr else get_cs_status(search_name, 'Removed')

    def purge_compliance_search(search_name):
        ps_path = create_ps_file('startpurge_' + search_name + '.ps1', STARTPURGE)
        output = subprocess.Popen(["powershell.exe", ps_path, "'" + USERNAME + "'", "'" + PASSWORD + "'", "'" + search_name + "'", "'" + EXCHANGE_FQDN + "'", "$" + str(UNSECURE)], \
                                    stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = output.communicate()
        delete_ps_file(ps_path)

        return return_error(stderr) if stderr else get_cs_status(search_name, 'Purging')

    def check_purge_compliance_search(search_name):
        ps_path = create_ps_file('checkpurge_' + search_name + '.ps1', CHECKPURGE)
        output = subprocess.Popen(["powershell.exe", ps_path, "'" + USERNAME + "'", "'" + PASSWORD + "'", "'" + search_name + "'", "'" + EXCHANGE_FQDN + "'", "$" + str(UNSECURE)], \
                                    stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout, stderr = output.communicate()
        delete_ps_file(ps_path)

        return return_error(stderr) if stderr else get_cs_status(search_name, 'Purged' if stdout.strip() == 'Completed' else 'Purging')

    def test_module():
        ps_path = create_ps_file('testcon_' + str(uuid.uuid4()).replace('-','') + '.ps1', TESTCON)
        output = subprocess.Popen(["powershell.exe", ps_path, "'" + USERNAME + "'", "'" + PASSWORD + "'", "'" + EXCHANGE_FQDN + "'", "$" + str(UNSECURE)], \
                                    stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        stdout = output.communicate()[0].strip()
        delete_ps_file(ps_path)

        if stdout == "successful connection":
            demisto.results('ok')
        else:
            return_error(stdout)


    args = prepare_args(demisto.args())
    try:
        if demisto.command() == 'exchange2016-start-compliance-search':
            encode_and_submit_results(start_compliance_search(**args))
        elif demisto.command() == 'exchange2016-get-compliance-search':
            encode_and_submit_results(get_compliance_search(**args))
        elif demisto.command() == 'exchange2016-remove-compliance-search':
            encode_and_submit_results(remove_compliance_search(**args))
        elif demisto.command() == 'exchange2016-purge-compliance-search-results':
            encode_and_submit_results(purge_compliance_search(**args))
        elif demisto.command() == 'exchange2016-get-compliance-search-purge-status':
            encode_and_submit_results(check_purge_compliance_search(**args))
        elif demisto.command() == 'test-module':
            test_module()
    except Exception, e:
        if isinstance(e, WindowsError):
            return_error("Could not open powershell on the target engine.")
        else:
            return_error(e)
  type: python
  commands:
  - name: exchange2016-start-compliance-search
    arguments:
    - name: query
      required: true
      default: true
      description: Query for finding mail messages
    outputs:
    - contextPath: EWS.ComplianceSearch.Name
      description: The name of the compliance search
      type: string
    - contextPath: EWS.ComplianceSearch.Status
      description: The status of the compliance search
      type: string
    description: Initiates a compliance search.
  - name: exchange2016-get-compliance-search
    arguments:
    - name: search-name
      required: true
      default: true
      description: Name of the compliance search
    outputs:
    - contextPath: EWS.ComplianceSearch.Status
      description: The status of the compliance search
      type: string
    description: Gets the status and results of a compliance search.
  - name: exchange2016-remove-compliance-search
    arguments:
    - name: search-name
      required: true
      default: true
      description: Name of the compliance search
    outputs:
    - contextPath: EWS.ComplianceSearch.Status
      description: The status of the compliance search
      type: string
    description: Removes the compliance search from the Exchange Server.
  - name: exchange2016-purge-compliance-search-results
    arguments:
    - name: search-name
      required: true
      default: true
      description: Name of the compliance search
    description: Purges the results found during the compliance search.
  - name: exchange2016-get-compliance-search-purge-status
    arguments:
    - name: search-name
      required: true
      default: true
      description: Name of the compliance search
    description: Checks the status of the purge operation on the compliance search.
  runonce: false
tests:
  - No test