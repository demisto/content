commonfields:
  id: FalconIntel
  version: -1
name: FalconIntel
display: CrowdStrike Falcon Intel
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: Actors, indicators and reports intelligence with indicator V2 api support
detaileddescription: |-
  Please provide the API id and key for the CrowsStrike Falcon Intelligence.
  API Key Pairs can be generated by accessing the CrowdStrike API tab located in the user settings on the Intelligence Portal.
  Indicator API v2 is supported.
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: url
  defaultvalue: https://intelapi.crowdstrike.com/
  type: 0
  required: true
- display: API ID
  name: id
  defaultvalue: ""
  type: 0
  required: true
- display: API Key
  name: key
  defaultvalue: ""
  type: 4
  required: true
- display: Use system proxy settings
  name: useproxy
  defaultvalue: "true"
  type: 8
  required: false
- display: Allow self-signed SSL certificates
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: Support indicator API V2
  name: version
  defaultvalue: "true"
  type: 8
  required: false
script:
  script: |
    // determine api version for api calls
    var version = (params.version ? "v2" : "v1");

    var serverUrl = params.url;
    if (serverUrl[serverUrl.length - 1] !== '/') {
        serverUrl += '/';
    }

    var doReq = function(method, path, query, body) {
        var result = http(
            serverUrl + path + encodeToURLQuery(query),
            {
                Headers: {
                    'X-CSIX-CUSTID': [params.id],
                    'X-CSIX-CUSTKEY': [params.key],
                    'Content-Type': ['application/json'],
                    'Accept': ['application/json'],
                    'X-INTEGRATION' : ['Demisto_demisto_3.6']
                },
                Method: method,
                Body: body ? JSON.stringify(body) : ''
            },
            params.insecure,
            params.useproxy
        );
        if (result.StatusCode < 200 || result.StatusCode > 299) {
            throw 'Failed to perform request ' + path + ', request status code: ' + result.StatusCode + ', body: ' + result.Body;
        }
        if (result.Body === '') {
            throw 'No content received.';
        }
        var obj;
        try {
            obj = JSON.parse(result.Body);
        } catch (ex) {
            throw 'Error parsing reply - ' + result.Body + ' - ' + ex;
        }
        if (obj.errors && obj.errors.length > 0) {
            throw JSON.stringify(obj.errors);
        }
        return {body: result.Body, obj: obj, statusCode: result.StatusCode};
    };

    var dateToEpoch = function(d) {
        return d ? new Date(d).getTime() : null;
    };

    var add = function(a, k, ok, f) {
        if (args[k]) {
            var parts = args[k].split(',');
            for (var i=0; i<parts.length; i++) {
                parts[i] = parts[i].trim();
            }
            a[ok ? ok : k] = f ? f(args[k]) : parts.length > 1 ? parts : args[k];
        }
    };

    var simpleValue = function(o, t) {
        return o ? '- ' + t + ': ' + o.map(function(curr) {return curr.value;}).join(', ') + '\n' : '';
    };

    // Not passing the arguments because there are a lot of them
    var doActors = function() {
        var a = {};
        add(a, 'q');
        add(a, 'name');
        add(a, 'desc');
        add(a, 'origins');
        add(a, 'targetContries', 'target_countries');
        add(a, 'targetIndustries', 'target_industries');
        add(a, 'motivations');
        add(a, 'slug');
        add(a, 'offset');
        add(a, 'limit');
        add(a, 'sort');
        add(a, 'minLastModifiedDate', 'min_last_modified_date', dateToEpoch);
        add(a, 'maxLastModifiedDate', 'max_last_modified_date', dateToEpoch);
        add(a, 'minLastActivityDate', 'min_last_activity_date', dateToEpoch);
        add(a, 'maxLastActivityDate', 'max_last_activity_date', dateToEpoch);
        var res = doReq('GET', 'actors/queries/actors/v1', a);
        var md = '## Falcon Intel Actor search\n';
        if (res.obj.resources) {
            // Now need to retrieve the full data for each id
            var fullArgs = {ids: res.obj.resources, fields: '__full__'};
            var resFull = doReq('GET', 'actors/entities/actors/v1', fullArgs);
            // Restore original pagination
            resFull.obj.meta.pagination = res.obj.meta.pagination;
            res = resFull;
            if (res.obj.resources) {
                var o = res.obj.resources;
                for (var i=0; i<o.length; i++) {
                    /*if (o[i].image && o[i].image.url) {
                        md += '![' + o[i].name +'](' + o[i].image.url + ' "' + o[i].name + '")\n';
                    }*/
                    md += '### ' + o[i].name + '\n';
                    md += '- ID: [' + o[i].id + '](' + o[i].url + ')\n';
                    md += '- Slug: ' + o[i].slug + '\n';
                    md += '- Description: ' + o[i].short_description + '\n';
                    md += '- First/Last activity: ' + new Date(o[i].first_activity_date * 1000) + ' / ' + new Date(o[i].last_activity_date * 1000) + '\n';
                    md += '- Active: ' + nvl(o[i].active) + '\n';
                    md += '- Known as: ' + nvl(o[i].known_as) + '\n';
                    md += simpleValue(o[i].target_industries, 'Target industries');
                    md += simpleValue(o[i].target_countries, 'Target countries');
                    md += simpleValue(o[i].origins, 'Origins');
                    md += simpleValue(o[i].motivations, 'Motivations');
                    md += '- Capability: ' + (o[i].capability ? o[i].capability.value : 'Unknown') + '\n';
                    md += '- Group: ' + (o[i].group ? o[i].group.value : 'Unknown') + '\n';
                    md += '- Region: ' + (o[i].region ? o[i].region.value : 'Unknown') + '\n';
                    if (o[i].kill_chain) {
                        md += '#### Kill chain\n';
                        var kkeys = Object.keys(o[i].kill_chain);
                        for (var j=0; j<kkeys.length; j++) {
                            if (kkeys[j].indexOf('rich_text') === 0) {
                                continue;
                            }
                            md += '- ' + kkeys[j] + ': ' + o[i].kill_chain[kkeys[j]] + '\n';
                        }
                    }
                    md += '\n';
                }
            } else {
                md = 'No result found';
            }
        } else {
            md = 'No result found';
        }
        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json, HumanReadable: md};
    };

    var indicatorToMd = function(o) {
        var md = '';
        if (o) {
            md += '### ' + o.indicator + '\n';
            md += '- Type: ' + nvl(o.type) + '\n';
            md += '- Last update: ' + nvl(o.last_update) + '\n';
            md += '- Publish date: ' + nvl(o.publish_date) + '\n';
            md += '- Malicious confidence: ' + nvl(o.malicious_confidence) + '\n';
            if (o.reports) {
                md += '- Reports: ' + o.reports.join(', ') + '\n';
            }
            if (o.actors) {
                md += '- Actors: ' + o.actors.join(', ') + '\n';
            }
            if (o.malware_families) {
                md += '- Malware families: ' + o.malware_families.join(', ') + '\n';
            }
            if (o.kill_chains) {
                md += '- Kill chains: ' + o.kill_chains.join(', ') + '\n';
            }
            if (o.domain_types) {
                md += '- Domain types: ' + o.domain_types.join(', ') + '\n';
            }
            if (o.ip_address_types) {
                md += '- IP Address types: ' + o.ip_address_types.join(', ') + '\n';
            }
            if (o.relations) {
                md += '#### Relations\n';
                md += arrToMd(o.relations) + '\n';
            }
            if (o.labels) {
                md += '#### Labels\n';
                md += arrToMd(o.labels) + '\n';
            }
        }
        return md;
    };

    var addIndicatorToContext = function(t, v, score, ec, path) {
        var n = {properties_to_append: ['Malicious', 'Reports', 'Actors', 'MalwareFamilies', 'KillChains']};
        n[t] = v.indicator;
        if (v.reports && v.reports.length > 0) {
            n.Reports = v.reports;
        }
        if (v.actors && v.actors.length > 0) {
            n.Actors = v.actors;
        }
        if (v.malware_families && v.malware_families.length > 0) {
            n.MalwareFamilies = v.malware_families;
        }
        if (v.kill_chains && v.kill_chains.length > 0) {
            n.KillChains = v.kill_chains;
        }
        if (score === 3) {
            n.Malicious = {Vendor: 'CrowdStrike', Description: 'High confidence'};
        }
        if (!ec[path]) {
            ec[path] = [];
        }
        ec[path].push(n);
    };

    // Not passing the arguments because there are a lot of them
    var doIndicators = function() {
        var a = {};
        a[args.filter] = args.value;
        add(a, 'page');
        add(a, 'pageSize');
        if (args.sort) {
            var parts = args.sort.split('.');
            a.sort = parts[0];
            if (parts.length > 1) {
                a.order = parts[1];
            }
        }
        var res = doReq('GET', 'indicator/'+ version +'/search/' + args.parameter, a);
        var md = '## Falcon Intel Indicator Search for: ' + args.value + '\n';
        var found = false;
        var ec = {};
        if (res.obj) {
            for (var i=0; i<res.obj.length; i++) {
                md += indicatorToMd(res.obj[i]);
                var dbotScore = 0;
                if (res.obj[i].malicious_confidence === 'high') {
                    dbotScore = 3;
                } else if (res.obj[i].malicious_confidence === 'medium') {
                    dbotScore = 2;
                } else {
                    dbotScore = 1;
                }
                var dbotType = '';
                if (res.obj[i].type === 'hash_md5') {
                    addIndicatorToContext('MD5', res.obj[i], dbotScore, ec, outputPaths.file);
                    dbotType = 'hash';
                } else if (res.obj[i].type === 'hash_sha1') {
                    addIndicatorToContext('SHA1', res.obj[i], dbotScore, ec, outputPaths.file);
                    dbotType = 'hash';
                } else if (res.obj[i].type === 'hash_sha256') {
                    addIndicatorToContext('SHA256', res.obj[i], dbotScore, ec, outputPaths.file);
                    dbotType = 'hash';
                } else if (res.obj[i].type === 'ip_address') {
                    addIndicatorToContext('Address', res.obj[i], dbotScore, ec, outputPaths.ip);
                    dbotType = 'ip';
                } else if (res.obj[i].type === 'url') {
                    addIndicatorToContext('Data', res.obj[i], dbotScore, ec, outputPaths.url);
                    dbotType = 'url';
                } else if (res.obj[i].type === 'domain') {
                    addIndicatorToContext('Name', res.obj[i], dbotScore, ec, outputPaths.domain);
                    dbotType = 'domain';
                }
                if (dbotType) {
                    if (!ec.DBotScore) {
                        ec.DBotScore = [];
                    }
                    ec.DBotScore.push({Indicator: res.obj[i].indicator, Type: dbotType, Vendor: 'CrowdStrike', Score: dbotScore});
                }
                found = true;
            }
        }
        if (!found) {
            md += 'No result found';
        }
        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
    };

    var doIndicator = function(ind, type, title, appendContextFunc) {
        var a = {equal: ind};
        var res = doReq('GET', 'indicator/'+ version +'/search/indicator', a);
        var md = '## ' + title + ': ' + ind + '\n';
        var ec = {};
        var found = false;
        if (res.obj) {
            for (var i=0; i<res.obj.length; i++) {
                md += indicatorToMd(res.obj[i]);
                var dbotScore = 0;
                if (res.obj[i].malicious_confidence === 'high') {
                    dbotScore = 3;
                    appendContextFunc(ec);
                } else if (res.obj[i].malicious_confidence === 'medium') {
                    dbotScore = 2;
                } else {
                    dbotScore = 1;
                }
                ec.DBotScore = {Indicator: ind, Type: type, Vendor: 'CrowdStrike', Score: dbotScore}; // ok to override, we expect only one
                found = true;
            }
        }
        if (!found) {
            md += 'No result found';
            ec.DBotScore = {Indicator: ind, Type: type, Vendor: 'CrowdStrike', Score: 0};
        }
        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
    };

    var doFile = function(hash) {
        return doIndicator(hash, 'hash', 'Falcon Intel file reputation for', function(ec) {
            var malFile = {Malicious: {Vendor: 'CrowdStrike', Description: 'High confidence'}};
            var hashType = hash.length === 32 ? 'MD5' : hash.length === 40 ? 'SHA1' : 'SHA256';
            malFile[hashType] = hash;
            addMalicious(ec, outputPaths.file, malFile);
        });
    };

    var doIP = function(ip) {
        return doIndicator(ip, 'ip', 'Falcon Intel IP reputation for', function(ec) {
            addMalicious(ec, outputPaths.ip, {Address: ip, Malicious: {Vendor: 'CrowdStrike', Description: 'High confidence'}});
        });
    };

    var doURL = function(url) {
        return doIndicator(url, 'url', 'Falcon Intel URL reputation for', function(ec) {
            addMalicious(ec, outputPaths.url, {Data: url, Malicious: {Vendor: 'CrowdStrike', Description: 'High confidence'}});
        });
    };

    var doDomain = function(domain) {
        return doIndicator(domain, 'domain', 'Falcon Intel domain reputation for', function(ec) {
            addMalicious(ec, outputPaths.domain, {Name: domain, Malicious: {Vendor: 'CrowdStrike', Description: 'High confidence'}});
        });
    };

    var doReports = function() {
        var a = {};
        add(a, 'q');
        add(a, 'name');
        add(a, 'actor');
        add(a, 'targetContries', 'target_countries');
        add(a, 'targetIndustries', 'target_industries');
        add(a, 'motivations');
        add(a, 'slug');
        add(a, 'description');
        add(a, 'type');
        add(a, 'subType', 'sub_type');
        add(a, 'tags');
        add(a, 'offset');
        add(a, 'limit');
        add(a, 'sort');
        add(a, 'minLastModifiedDate', 'min_last_modified_date', dateToEpoch);
        add(a, 'maxLastModifiedDate', 'max_last_modified_date', dateToEpoch);
        var res = doReq('GET', 'reports/queries/reports/v1', a);
        var md = '';
        if (res.obj.resources && Object.keys(res.obj.resources).length > 0) {
            // Now need to retrieve the full data for each id
            var resFull = doReq('GET', '/reports/entities/reports/v1', {ids: res.obj.resources});
            // Restore original pagination
            resFull.obj.meta.pagination = res.obj.meta.pagination;
            res = resFull;
            if (res.obj.resources) {
                var o = res.obj.resources;
                for (var i=0; i<o.length; i++) {
                    md += 'ID: [' + o[i].id + '](' + o[i].url + ')\n';
                    md += 'Name: ' + o[i].name + '\n';
                    md += 'Type: ' + o[i].type.name + '\n';
                    md += 'Sub type: ' + o[i].sub_type.name + '\n';
                    md += 'Slug: ' + o[i].slug + '\n';
                    md += 'Created: ' + new Date(o[i].created_date) + '\n';
                    md += 'Last modified: ' + new Date(o[i].last_modified_date) + '\n'
                    md += 'Description: ' + o[i].short_description + '\n';
                    if (o[i].target_industries) {
                      md += 'Target industries: ' + o[i].target_industries.map(function(curr) {return curr.value;}).join(', ') + '\n';
                    }
                    if (o[i].target_countries) {
                      md += 'Target countries: ' + o[i].target_countries.map(function(curr) {return curr.value;}).join(', ') + '\n';
                    }
                    if (o[i].motivations) {
                      md += 'Motivations: ' + o[i].motivations.map(function(curr) {return curr.value;}).join(', ') + '\n';
                    }
                    if (o[i].tags) {
                      md += 'Tags: ' + o[i].tags.map(function(curr) {return curr.value;}).join(', ') + '\n';
                    }
                  }
            } else {
                md = 'No result found';
            }
        } else {
            md = 'No result found';
        }
        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json, HumanReadable: md};
    };

    var doReport = function() {
        var result = http(
            serverUrl + 'reports/entities/report-files/v1' + encodeToURLQuery({ids: args.id}),
            {
                Headers: {
                    'X-CSIX-CUSTID': [params.id],
                    'X-CSIX-CUSTKEY': [params.key],
                    'Accept': ['application/pdf']
                },
                Method: 'GET',
                SaveToFile: true
            },
            params.insecure,
            params.useproxy
        );
        if (result.StatusCode < 200 || result.StatusCode > 299) {
            throw 'Failed to retrieve PDF, status code: ' + result.StatusCode + ', body: ' + result.Body;
        }
        // Try to extract the filename
        var disposition = result.Headers['Content-Disposition'];
        var filename = 'report-' + args.id + '.pdf';
        if (disposition) {
            disposition = disposition[0];
            if (disposition) {
                var parts = disposition.split(';');
                if (parts && parts.length > 1) {
                    var name = parts[1].split('=');
                    if (name && name.length > 1) {
                        filename = name[1].trim();
                    }
                }
            }
        }
        return {Type: entryTypes.entryInfoFile, FileID: result.Path, File: filename, Contents: filename};
    }

    switch (command) {
        case 'test-module':
            if(version === 'v2') {
                doReq('GET', 'indicator/'+ version +'/search/indicator', {equal: '4.4.4.4'});
                return true;
            } else {
                doReq('GET', 'actors/queries/actors/v1', {q: 'panda'});
                return true;
            }
        case 'file':
            return doFile(args.file);
        case 'ip':
            return doIP(args.ip);
        case 'url':
            return doURL(args.url);
        case 'domain':
            return doDomain(args.domain);
        case 'cs-actors':
            return doActors();
        case 'cs-indicators':
            return doIndicators();
        case 'cs-reports':
            return doReports();
        case 'cs-report-pdf':
            return doReport();
        default:
            throw 'Unknown command - ' + command;
    }
  type: javascript
  commands:
  - name: file
    arguments:
    - name: file
      required: true
      default: true
      description: The file hash md5/sha1/sha256 to check
    outputs:
    - contextPath: File.MD5
      description: Bad hash MD5
    - contextPath: File.SHA1
      description: Bad hash SHA1
    - contextPath: File.SHA256
      description: Bad hash SHA256
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision
    - contextPath: File.Malicious.Description
      description: For malicious files, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: Check file reputation
  - name: url
    arguments:
    - name: url
      required: true
      default: true
      description: URL to be checked
    outputs:
    - contextPath: URL.Data
      description: Bad URL
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: Check the given URL reputation
  - name: domain
    arguments:
    - name: domain
      required: true
      default: true
      description: Domain to be checked
    outputs:
    - contextPath: Domain.Name
      description: Bad domain
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: Check the given URL reputation
  - name: ip
    arguments:
    - name: ip
      required: true
      default: true
      description: IP to check
    outputs:
    - contextPath: IP.Address
      description: Bad IP
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: Check IP reputation
  - name: cs-actors
    arguments:
    - name: q
      default: true
      description: Search all fields for the given data
    - name: name
      description: Search based on actor name
    - name: desc
      description: Search based on description
    - name: minLastModifiedDate
      description: Search range from modified date. Dates are formatted as YYYY-MM-DD.
    - name: maxLastModifiedDate
      description: Search range to modified date. Dates are formatted as YYYY-MM-DD.
    - name: minLastActivityDate
      description: Search range from activity date. Dates are formatted as YYYY-MM-DD.
    - name: maxLastActivityDate
      description: Search range to activity date. Dates are formatted as YYYY-MM-DD.
    - name: origins
      description: Search by origins separated by ","
    - name: targetCountries
      description: Search by target countries separated by ","
    - name: targetIndustries
      description: Search by target industries separated by ","
    - name: motivations
      description: Search by motivations separated by ","
    - name: offset
      description: Which page of the results to retrieve. It is 0 based.
    - name: limit
      description: Number of results for the page
    - name: sort
      description: Sort is field_name.order, field_name.order where order is either
        asc or desc
    - name: slug
      description: 'Search by ''slug'' or short descriptive name. Ex: "anchor-panda"'
    description: Search known actors based on the given parameters. Dates are formatted
      as YYYY-MM-DD. Max date is taken automatically looking at end-of-day time. Origins,
      targetCountries, targetIndustries and motivations can all receive multiple values
      separated by ",". Offset is 0 based. Sort is field_name.order, field_name.order
      where order is either asc or desc.
  - name: cs-indicators
    arguments:
    - name: parameter
      required: true
      description: Based on what parameter to search. See CrowdStrike documentation
        for details. Can be one of indicator, type, report, actor, malicious_confidence,
        published_date, last_updated, malware_family, kill_chain, labels, DomainType,
        EmailAddressType, IntelNews, IPAddressType, Malware, Status, Target, ThreatType,
        Vulnerability
    - name: filter
      required: true
      auto: PREDEFINED
      predefined:
      - match
      - equal
      - gt
      - gte
      - lt
      - lte
      description: Can be either match, equal, gt(e), lt(e)
    - name: value
      required: true
      description: The value for the given parameter
    - name: sort
      description: Sort by a field. Should be field_name.order where order is either
        asc or desc. Fields are indicator, type, report, actor, malicious_confidence,
        published_date, last_updated.
    - name: page
      description: The page to retrieve - 1 based
    - name: pageSize
      description: The size of the page to retrieve
    outputs:
    - contextPath: File.MD5
      description: hash MD5
    - contextPath: File.SHA1
      description: hash SHA1
    - contextPath: File.SHA256
      description: hash SHA256
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision
    - contextPath: File.Malicious.Description
      description: For malicious files, the reason for the vendor to make the decision
    - contextPath: File.Reports
      description: For malicious files, the associated reports describing the hash
    - contextPath: File.Actors
      description: For malicious files, the associated actors
    - contextPath: File.MalwareFamilies
      description: For malicious files, the associated malware family
    - contextPath: File.KillChains
      description: For malicious files, the associated kill chain
    - contextPath: URL.Data
      description: Bad URL
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
    - contextPath: URL.Reports
      description: For malicious URL, the associated reports describing the URL
    - contextPath: URL.Actors
      description: For malicious URL, the associated actors
    - contextPath: URL.MalwareFamilies
      description: For malicious URL, the associated malware family
    - contextPath: URL.KillChains
      description: For malicious URL, the associated kill chain
    - contextPath: Domain.Name
      description: Bad domain
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    - contextPath: Domain.Reports
      description: For malicious domain, the associated reports describing the domain
    - contextPath: Domain.Actors
      description: For malicious domain, the associated actors
    - contextPath: Domain.MalwareFamilies
      description: For malicious domain, the associated malware family
    - contextPath: Domain.KillChains
      description: For malicious domain, the associated kill chain
    - contextPath: IP.Address
      description: IP Indicators
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the reason for the vendor to make the decision
    - contextPath: IP.Reports
      description: For malicious IP, the associated reports describing the IP
    - contextPath: IP.Actors
      description: For malicious IP, the associated actors
    - contextPath: IP.MalwareFamilies
      description: For malicious IP, the associated malware family
    - contextPath: IP.KillChains
      description: For malicious IP, the associated kill chain
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: Search known indicators based on the given parameters
  - name: cs-reports
    arguments:
    - name: q
      description: Perform a generic substring search across all fields in a report
    - name: name
      description: Search for keywords across report names (i.e. the reportâ€™s title)
    - name: actor
      description: Search for a report related to a particular actor. For a list of
        actors, refer to the Intel Actors API
    - name: targetCountries
      description: Search reports by targeted country/countries
    - name: targetIndustries
      description: Search reports by targeted industry/industries
    - name: motivations
      description: Search by motivation
    - name: slug
      description: Search by report 'slug' or short descriptive name
    - name: description
      description: Search the body of the report
    - name: type
      auto: PREDEFINED
      predefined:
      - intelligence report
      - alert
      - periodic report
      - tipper
      description: The type of object to search for.
    - name: subType
      auto: PREDEFINED
      predefined:
      - weekly
      - monthly
      - quarterly
      - annual
      description: The sub-type to search for.
    - name: tags
      description: Tags associated with a report (managed internally by CS)
    - name: minLastModifiedDate
      description: Constrain results to those modified on or after a certain date
        - format YYYY-MM-DD
    - name: maxLastModifiedDate
      description: Constrain results to those modified on or before a certain date
        - format YYYY-MM-DD
    - name: offset
      description: Used to paginate the response. You can then use limit to set the
        number of results for the next page.
    - name: limit
      description: Limits the number of results to return
    - name: sort
      description: 'The field and direction to sort results on in the format of: <field>.<asc>
        or <field>.<desc>. Valid values include: name, target_countries, target_industries,
        type, created_date, last_modified_date'
    description: The Falcon Intel Reports API allows to query CrowdStrike intelligence
      publications.
  - name: cs-report-pdf
    arguments:
    - name: id
      required: true
      default: true
      description: The ID of the report to retrieve
    description: Retrieve the Falcon Intel Report PDF
  runonce: false
