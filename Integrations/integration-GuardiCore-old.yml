commonfields:
  id: GuardiCore
  version: -1
name: GuardiCore
display: GuardiCore
category: Deception
image: data:image/png;base64,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
description: Data center breach detection
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Username
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |+
    var server = params.server.replace(/[\/]+$/, '') + '/api/v3.0/';

    var urlDictionary = {
        login: 'authenticate',
        logout: 'logout',

        'guardicore-get-incidents': 'incidents',
        'guardicore-get-incident': 'incidents/%id%',
        'guardicore-get-incident-iocs': 'incidents/%id%/iocs',
        'guardicore-get-incident-events': 'incidents/%id%/events',
        'guardicore-get-incident-pcap': 'honeypots/%honeypotId%/files/%fileId%',
        'guardicore-get-incident-attachments': 'honeypots/%honeypotId%/files/%fileId%',

        'guardicore-show-endpoint': 'assets/%host_id%',
        'guardicore-search-endpoint': 'assets',

        'guardicore-uncommon-domains': 'connections/stats/dns-stats',
        'guardicore-unresolved-domains': 'connections/stats/missing-hosts',
        'guardicore-dns-requests': 'labs/dns-requests',
        'guardicore-misconfigurations': 'connections/stats/network-misconfigurations',

        'guardicore-search-network-log': 'network-events',
    };

    var methodDictionary = {
        login: 'POST',
        logout: 'POST',
        'guardicore-get-incidents': 'GET',
        'guardicore-get-incident': 'GET',
        'guardicore-get-incident-iocs': 'GET',
        'guardicore-get-incident-events': 'GET',
        'guardicore-get-incident-pcap': 'GET',
        'guardicore-get-incident-attachments': 'GET',

        'guardicore-show-endpoint': 'GET',
        'guardicore-search-endpoint': 'GET',

        'guardicore-uncommon-domains' : 'GET',
        'guardicore-unresolved-domains': 'GET',
        'guardicore-dns-requests': 'GET',
        'guardicore-misconfigurations': 'GET',

        'guardicore-search-network-log': 'GET'
    };


    // converts raw data to readable strings, for both the war room and the context
    OUTPUT_DOMAINS = [
        {from: 'domain', to: 'Domain'},
        {from: 'count', to: 'Count'},
        {from: 'clients_count', to: 'Clients Count'},
        {from: 'clients', to: 'Clients', parser: function(clients) {
            var output = [];
            for (var i = 0; i < clients.length; i++) {
                clientStr = buildClientStr(clients[i].vm.display_name, clients[i].ip, clients[i].vm.id)
                output.push(clientStr);
            }

            return output.join('<br>');
        }}
    ];

    // Used for direct parsing/formatting.
    // In case several inputs are needed for a single output, it will be done in the specific parsing function.
    var outputsDictionary = {
        'guardicore-get-incident': [
            {from: 'source_ip', to: 'Source IP'},
            {from: 'source_port', to: 'Source Port'},
            {from: 'destination_ip', to: 'Destination IP'},
            {from: 'destination_port', to: 'Destination Port'},
            {from: '_id', to: 'ID'},
            {from: 'os', to: 'OS'},
            {from: 'incident_type', to: 'Incident Type'},
            {from: 'honeypot_id', to: 'Honeypot ID'},
            {from: 'start_time', to: 'Start Time', parser: convertTimestampToString},
            {from: 'end_time', to: 'End Time', parser: convertTimestampToString},
            {from: 'closed_time', to: 'Closed Time', parser: convertTimestampToString},
            {from: 'severity', to: 'Severity', parser: function(sev) {
                if (sev <= 30) {
                    return 'Low';
                } else if (sev >= 50) {
                    return 'High';
                } else {
                    return 'Medium';
                }
            }},
            {from: 'incident_group', to: 'Incident Group', parser: function(ig) {
                return ig[0].gname + ' ' + ig[0].gid;
            }},
            {from: 'concatenated_tags', to: 'Tags', parser: function(tags) {
                var str = '';
                for (var i = 0; i < tags.length; i++) {
                    str += tags[i].display_name + ', ';
                }

                return str.replace(/, $/, '');
            }}
        ],
        'guardicore-get-incident-iocs': [
            {from: '_id', to: 'ID'},
            {from: '_cls', to: 'Type'},
            {from: 'creation_time', to: 'Creation Time', parser: convertTimestampToString},
            {from: 'first_seen', to: 'First Seen', parser: convertTimestampToString},
            {from: 'last_seen', to: 'Last Seen', parser: convertTimestampToString},
        ],
        'guardicore-uncommon-domains': OUTPUT_DOMAINS,
        'guardicore-unresolved-domains': OUTPUT_DOMAINS,
        'guardicore-show-endpoint': [
            {from: '_id', to: 'ID'},
            {from: 'ip_addresses', to: 'IP Addresses', parser: function(ipAddresses) {
                return ipAddresses.join('<br>');
            }},
            {from: 'mac_addresses', to: 'MAC Addresses', parser: function(macAddresses) {
                return macAddresses.join('<br>');
            }},
            {from: 'recent_domains', to: 'Recent Domains', parser: function(recentDomains) {
                return recentDomains.join('<br>');
            }},
            {from: 'comments', to: 'Comments'},
            {from: 'first_seen', to: 'First Seen', parser: convertTimestampToString},
            {from: 'last_seen', to: 'Last Seen', parser: convertTimestampToString},
            {from: 'last_summary_update', to: 'Last Summary Update', parser: convertTimestampToString},
            {from: 'risk_title', to: 'Risk Level'},
            {from: 'status', to: 'Status'},
        ],
        'guardicore-misconfigurations': [
            {from: 'port_count', to: 'Port Count'},
            {from: 'flow_count', to: 'Flow Count'}
        ],
        'guardicore-dns-requests': [
            {from: 'client_ip', to: 'Client IP'},
            {from: 'packet_arrival_time', to: 'Packet Arrival Time', parser: convertTimestampToString},
            {from: 'requested_host_name', to: 'Requested Hostname'}
        ],
        'guardicore-search-network-log': [
            {from: '_cls', to: 'Class'},
            {from: '_id', to: 'ID'},
            {from: 'action', to: 'Action'},
            {from: 'description', to: 'Description'},
            {from: 'destination_ip', to: 'Destination IP'},
            {from: 'destination_mac', to: 'Destination MAC'},
            {from: 'destination_port', to: 'Destination Port'},
            {from: 'processed_time', to: 'Processed Time'},
            {from: 'received_time', to: 'Received Time'},
            {from: 'source_ip', to: 'Source IP'},
            {from: 'source_mac', to: 'Source MAC'},
            {from: 'source_port', to: 'Source Port'}
        ]
    };

    var mapObjFunction = function(mapFields) {
        return function(obj) {
            var res = {};
            mapFields.forEach(function(f) {
                if (f.parser) {
                    res[f.to] = f.parser(dq(obj, f.from)) || null;
                } else {
                    res[f.to] = dq(obj, f.from) || null;
                }
            });

            return res;
        }
    }

    var convertKeysToPascalCase = function(dict) {
        var pascalDict = {};
        for (var key in dict) {
            var pascalCaseKey = key.replace(/\w+/g, function(w) { return w[0].toUpperCase() + w.slice(1).toLowerCase(); }).replace(' ', '');
            pascalDict[pascalCaseKey] = dict[key];
        }

        return pascalDict;
    }

    var doesResultExist = function(result) {
        return (
            result &&
            (!(result instanceof Array) || result.length) &&
            (!(result instanceof Object) || Object.keys(result).length)
        );
    }

    var formatIncidentDescription = function(unformattedDescription) {
        var description = '';
        for (var j in unformattedDescription) {
            description += unformattedDescription[j].value;
        }

        return description;
    }

    var buildEmptyEntryContext = function() {
        return {Type: entryTypes.note, Contents: null, ContentsFormat: formats.json, EntryContext: {}};
    }

    var parseGetIncident = function(command, response) {
        var output = mapObjFunction(outputsDictionary[command])(response);
        output.Description = formatIncidentDescription(response.description);

        var entry = buildEmptyEntryContext();
        entry.HumanReadable = objToMd(output);
        entry.EntryContext['GuardiCore.Incidents'] = convertKeysToPascalCase(output);

        return entry;
    }

    IOCS_NON_VALUE_KEYS = ['_id', '_cls', 'creation_time', 'first_seen', 'last_seen', 'doc_version'];
    var parseGetIncidentIOCs = function(command, response) {
        var outputs = [];
        var contexts = [];
        for (var i = 0; i < response.length; i++) {
            var output = mapObjFunction(outputsDictionary[command])(response[i]);

            // collect data for the Values field
            var values = {};
            for (var responseKey in response[i]) {
                if (IOCS_NON_VALUE_KEYS.indexOf(responseKey) == -1) {
                    values[responseKey] = response[i][responseKey];
                }
            }

            var valueList = [];
            for (var valueKey in values) {
                valueList.push(valueKey + ': ' + values[valueKey]);
            }

            if (valueList.length > 0) {
                output.Values = valueList.join('<br>');
            }

            var contextData = convertKeysToPascalCase(output);

            // add endpoint
            if (response[i]['_cls'] == 'IoC.NetworkIoc.NetworkVmIoc') {
                contextData.Endpoint = {
                    Hostname: response[i]['vm_name'],
                    IPAddress: response[i]['ip']
                };
            }

            if (valueList.length > 0) {
                contextData.Values = values;
            }

            outputs.push(output);
            contexts.push(contextData);
        }

        if (outputs.length === 0) {
            return 'No IOCs for this incident.';
        }

        var entry = buildEmptyEntryContext();
        entry.HumanReadable = tblToMd('GuardiCore IOCs', outputs);
        entry.EntryContext['GuardiCore.IOCs'] = contexts;

        return entry;
    }

    var parseGetIncidents = function(command, response) {
        var internalCommand = 'guardicore-get-incident';
        var outputs = [];
        var contexts = [];
        for (var objects = dq(response, 'objects'), i = 0; i < objects.length; i++) {
            var output = mapObjFunction(outputsDictionary[internalCommand])(objects[i]);
            output.Description = formatIncidentDescription(objects[i].description);
            outputs.push(output);
            contexts.push(convertKeysToPascalCase(output));
        }

        if (outputs.length === 0) {
            return 'No matching incidents were found.';
        }

        var entry = buildEmptyEntryContext();
        entry.HumanReadable = tblToMd('GuardiCore Incidents', outputs);
        entry.EntryContext['GuardiCore.Incidents'] = contexts;

        return entry;
    }

    var parseGetIncidentEvents = function(command, response) {
        var outputs = [];
        var contexts = [];
        for (var events = dq(response, 'events'), i = 0; i < events.length; i++) {
            var output = {'Class': events[i]._cls, 'Data': ''};
            var context = {'Class' : events[i]._cls, 'Data': events[i]};

            var eventData = [];
            for (var key in events[i]) {
                eventData.push(key + ': ' + JSON.stringify(events[i][key]));
            }

            if (eventData.length > 0) {
                output.Data = eventData.join('<br>');
            }

            outputs.push(output);
            contexts.push(context);
        }

        var entry = buildEmptyEntryContext();
        entry.HumanReadable = tblToMd('GuardiCore Incident Events', outputs);
        entry.EntryContext['GuardiCore.IncidentEvents'] = contexts;

        return entry;
    }

    var buildClientStr = function(displayName, ip, id) {
        return '{0} - {1} - {2}'.format(displayName, ip, id);
    }

    var parseDomainClients = function(clients) {
        var contextData = [];
        for (var i = 0; i < clients.length; i++) {
            contextData.push({
                displayName: clients[i].vm.display_name,
                name: clients[i].vm.name,
                ip: clients[i].ip,
                id: clients[i].vm.id,
                domain: clients[i].vm.domain
            });
        }

        return contextData;
    }

    var parseDomains = function(command, response) {
        var outputs = [];
        var domains = [];
        var endpoints = [];
        for (var i = 0; i < response.length; i++) {
            var output = mapObjFunction(outputsDictionary[command])(response[i]);
            var contextData = {'Clients': parseDomainClients(response[i].clients)};
            outputs.push(output);

            var contextClientsData = [];
            for (var j = 0; j < contextData.Clients.length; j++) {
                endpoints.push({
                    Hostname: contextData.Clients[j].name,
                    IP: contextData.Clients[j].ip,
                    Domain: contextData.Clients[j].domain
                });

                contextClientsData.push({
                    DisplayName: contextData.Clients[j].displayName,
                    IP: contextData.Clients[j].ip,
                    ID: contextData.Clients[j].id,
                });
            }

            domains.push({
                Name: output.Domain,
                Count: output.Count,
                ClientsCount: output['Clients Count'],
                Clients: contextClientsData
            });
        }

        var domainType = (command == 'guardicore-uncommon-domains') ? 'Uncommon' : 'Unresolved';
        var tableTitle = 'GuardiCore {0} Domains'.format(domainType);
        var entryContextDomainType = 'GuardiCore.Domain.' + domainType;

        var entry = buildEmptyEntryContext();
        entry.HumanReadable = tblToMd(tableTitle, outputs);
        entry.EntryContext = {'GuardiCore.Endpoint.Suspicious': endpoints};
        entry.EntryContext[entryContextDomainType] = domains;

        return entry;
    }

    var parseMisconfigurations = function(command, response) {
        var outputs = [];
        var contexts = [];
        for (var i = 0; i < response.length; i++) {
            var output = mapObjFunction(outputsDictionary[command])(response[i]);
            if (response[i].destination && response[i].destination[0] && response[i].destination[0].vm) {
                destination = response[i].destination[0].vm.display_name + ' - ' + response[i].destination[0].ip;
            } else {
                destination = 'undefined';
            }

            output.Destination = destination;
            output.Port = response[i].port + ' - ' + response[i].port_name;

            var sources = [];
            for (var j = 0; j < response[i].source.length; j++) {
                var currentSource = response[i].source[j];
                if (currentSource && currentSource.vm) {
                    var sourceStr = currentSource.vm.display_name + ' (' + currentSource.ip + ') - ' + currentSource.count.toString();
                } else {
                    var sourceStr = 'undefined';
                }

                sources.push(sourceStr);
            }

            output.Sources = sources.join('<br>');
            var context = convertKeysToPascalCase(output);
            context.Sources = sources;
            outputs.push(output);
            contexts.push(context);
        }

        var entry = buildEmptyEntryContext();
        entry.HumanReadable = tblToMd('GuardiCore Misconfigurations', outputs);
        entry.EntryContext = {'GuardiCore.Misconfigurations': contexts};

        return entry;
    }

    var parseDnsRequests = function(command, response) {
        var outputs = [];
        var contexts = [];
        for (var objects = dq(response, 'objects'), i = 0; i < objects.length; i++) {
            var output = mapObjFunction(outputsDictionary[command])(objects[i]);
            var context = convertKeysToPascalCase(output);

            var answer = {};
            var answerDocumentsStr = '';
            if (objects[i].answer_infos[0]) {
                answer.ResponderIp = objects[i].answer_infos[0].responder_ip;
                var answerDocuments = [];
                objects[i].answer_infos[0].answer_documents.forEach(function(ans) {
                    if (ans.answer_type) {
                        answerDocuments.push({'AnswerType': ans.answer_type, 'Hostname': ans.host_name});
                        answerDocumentsStr += 'Type: ' + ans.answer_type + ', Hostname: ' + ans.host_name + '<br>';
                    }
                });

                answer.AnswerDocuments = answerDocuments;
            }

            output.Answers = 'Responder IP: ' + answer.ResponderIp;
            if (answerDocumentsStr.length > 0) {
                output.Answers += '<br>Answers:<br>' + answerDocumentsStr;
            }
            outputs.push(output)

            context.Answer = answer;
            contexts.push(context);
        }

        var entry = buildEmptyEntryContext();
        entry.HumanReadable = tblToMd('GuardiCore DNS Requests', outputs);
        entry.EntryContext = {'GuardiCore.DNSRequests': contexts};

        return entry;
    }

    RELEVANT_SUMMARY_KEYS = [
        'blocked_connections_count',
        'file_detected_incidents_count',
        'file_detection_rules_count',
        'file_quarantined_count',
        'honeypot_incidents_count',
        'network_rules_count',
        'network_scan_incidents_count',
        'total_incidents_count'
    ]
    var parseShowEndpoint = function(command, response) {
        var output = mapObjFunction(outputsDictionary[command])(response);
        var context = {
            'Hostname': response.full_name,
            'IP': (response.ip_addresses.length > 1) ? response.ip_addresses : response.ip_addresses[0]
        };

        var entries = [];
        var endpointDetailsEntry = buildEmptyEntryContext();
        endpointDetailsEntry.HumanReadable = tblToMd('GuardiCore Details for Endpoint ' + response.full_name, output);
        endpointDetailsEntry.EntryContext = {'GuardiCore.Endpoint': context};
        entries.push(endpointDetailsEntry)

        if (response.unhandled_recommendations && (response.unhandled_recommendations.length > 0)) {
            var recommendationsEntry = buildEmptyEntryContext();
            recommendationsEntry.HumanReadable = tblToMd('GuardiCore Details for Endpoint ' + response.full_name, response.unhandled_recommendations);
            entries.push(recommendationsEntry);
        }

        var summary = [];
        for (var key in response.summary) {
            if (RELEVANT_SUMMARY_KEYS.indexOf(key) != -1) {
                summary.push({'Key': key, 'Value': response.summary[key]});
            }
        }
        if (summary.length > 0) {
            var summaryEntry = buildEmptyEntryContext();
            summaryEntry.HumanReadable = tblToMd('GuardiCore Summary for Endpoint ' + response.full_name, summary);
            entries.push(summaryEntry);
        }

        return entries;
    }

    var parseHostIds = function(response) {
        var hostIds = [];
        for (var objects = dq(response, 'objects'), i = 0; i < objects.length; i++) {
            hostIds.push(objects[i]._id);
        }

        return hostIds;
    }

    var parseIncidentPcap = function(response) {
        return {'honeypotId': response.honeypot_id, 'fileId': response.pcap.file_id};
    }

    var parseIncidentAttachments = function(response) {
        var attachmentsInfo = {'honeypotId': response.honeypot_id, 'filesData': []};
        for (var events = dq(response, 'events'), i = 0; i < events.length; i++) {
            if (events[i].file_id) {
                var fileData = {'fileId': events[i].file_id, 'path': events[i].path};
                attachmentsInfo.filesData.push(fileData);
            }
        }

        return attachmentsInfo;
    }

    var parseSearchNetworkLog = function(command, response) {
        var outputs = [];
        var contexts = [];
        for (var objects = dq(response, 'objects'), i = 0; i < objects.length; i++) {
            var output = mapObjFunction(outputsDictionary[command])(objects[i]);
            outputs.push(output);
            contexts.push(convertKeysToPascalCase(output));
        }

        var entry = buildEmptyEntryContext();
        entry.HumanReadable = tblToMd('GuardiCore Network Log Results', outputs);
        entry.EntryContext = {'GuardiCore.NetworkLog': contexts};

        return entry;
    }

    var entriesFromResponse = function(command, response, token) {
        var entry;
        switch (command) {
            case 'guardicore-get-incidents':
                entry = parseGetIncidents(command, response);
                break;

            case 'guardicore-get-incident':
                entry = parseGetIncident(command, response);
                break;

            case 'guardicore-get-incident-iocs':
                entry = parseGetIncidentIOCs(command, response);
                break;

            case 'guardicore-get-incident-events':
                entry = parseGetIncidentEvents(command, response);
                break;

            case 'guardicore-get-incident-pcap':
                var incidentId = response._id;
                if (!response.pcap) {
                    return 'No PCAP was found for the given incident.';
                }

                var pcapInfo = parseIncidentPcap(response);
                args.honeypotId = pcapInfo.honeypotId;
                args.fileId = pcapInfo.fileId;

                var internalCommand = 'guardicore-get-incident-pcap';
                var pcapFile = sendRequest(
                    methodDictionary[internalCommand],
                    replaceInTemplatesAndRemove(urlDictionary[internalCommand], args),
                    token,
                    args,
                    true
                );

                var fileName = 'incident_' + incidentId + '.pcap';
                entry = {Type: 3, FileID: saveFile(pcapFile), File: fileName, Contents: fileName};
                break;

            case 'guardicore-get-incident-attachments':
                var incidentId = response._id;
                var attachments = parseIncidentAttachments(response);
                if (attachments.filesData.length === 0) {
                    return 'No attachments were found for the given incident.';
                }

                entry = [];
                for (var i = 0; i < attachments.filesData.length; i++) {
                    args.honeypotId = attachments.filesData[i].honeypotId;
                    args.fileId = attachments.filesData[i].fileId;
                    var internalCommand = 'guardicore-get-incident-attachments';
                    var attachment = sendRequest(
                        methodDictionary[internalCommand],
                        replaceInTemplatesAndRemove(urlDictionary[internalCommand], args),
                        token,
                        args,
                        true
                    );

                    var fileName = 'attachment_' + incidentId + '_' + attachments.filesData[i].path;
                    entry.push({Type: 3, FileID: saveFile(attachment), File: fileName, Contents: fileName});
                }
                break;

            case 'guardicore-uncommon-domains':
            case 'guardicore-unresolved-domains':
                entry = parseDomains(command, response);
                break;

            case 'guardicore-dns-requests':
                entry = parseDnsRequests(command, response);
                break;

            case 'guardicore-misconfigurations':
                entry = parseMisconfigurations(command, response);
                break;

            case 'guardicore-show-endpoint':
                entry = parseShowEndpoint(command, response);
                break;

            case 'guardicore-search-endpoint':
                if (!args.ip_address && !args.name) {
                    throw 'IP address or hostname must be provided.'
                }

                hostIds = parseHostIds(response);
                if (!hostIds || (hostIds.length === 0)) {
                    return 'Host was not found.'
                }

                entry = [];
                var internalCommand = 'guardicore-show-endpoint';
                for (var i = 0; i < hostIds.length; i++) {
                    args.host_id = hostIds[i];
                    var result = sendRequest(
                        methodDictionary[internalCommand],
                        replaceInTemplatesAndRemove(urlDictionary[internalCommand], args),
                        token,
                        args,
                        false,
                        true
                    );
                    var currentEntry;
                    try {
                        currentEntry = entriesFromResponse(internalCommand, result, token);
                    } catch (err) {
                        currentEntry = 'Failed parsing host ID: ' + hostIds[i];
                    }

                    entry.push(currentEntry);
                }

                return entry;

            case 'guardicore-search-network-log':
                entry = parseSearchNetworkLog(command, response);
                break;

            default:
                throw 'Unknown command';
        }

        if (command != 'guardicore-get-incident-pcap') {
            entry.Contents = response;
            entry.ContentsFormat = formats.json;
        }

        return entry;
    }

    var sendRequest = function(method, url, token, args, isRawOutput, shouldIgnoreUrlArgs) {
        var headers = {'Content-Type': ['application/json']};
        if (token) {
            headers.Authorization = ['Bearer ' + token];
        }

        var body = method !== 'GET' ? JSON.stringify(args) : '';
        var shouldIgnoreArgs = (shouldIgnoreUrlArgs !== undefined) && shouldIgnoreUrlArgs;
        var urlExtra = ((method === 'GET') && !shouldIgnoreArgs) ? encodeToURLQuery(args) : '';

        console.log('Sending request: ' + server + url + urlExtra);
        var res = http(
            server + url + urlExtra,
            {
                Method: method,
                Headers: headers,
                Body: body
            },
            params.insecure,
            params.proxy
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            if (token) {
                sendRequest(methodDictionary.logout, urlDictionary.logout, token);
            }

            throw 'Request to GuardiCore ' + url + ' failed, request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }

        if (isRawOutput) {
            return res.Body;
        } else {
            return JSON.parse(res.Body);
        }
    }

    // workaround - this parameter should not be visible in the BYOI integration code
    delete(args['raw-response']);

    var token = sendRequest(methodDictionary.login, urlDictionary.login, undefined, {username: params.credentials.identifier, password: params.credentials.password}).access_token;
    var commandUrlKey;
    switch (command) {
        case 'test-module':
            sendRequest(methodDictionary.logout, urlDictionary.logout, token);
            return 'ok';

        case 'guardicore-get-incident-pcap':
        case 'guardicore-get-incident-attachments':
            commandUrlKey = 'guardicore-get-incident';
            break;

        default:
            commandUrlKey = command;
            break
    }

    var result = sendRequest(
        methodDictionary[command],
        replaceInTemplatesAndRemove(urlDictionary[commandUrlKey], args),
        token,
        args
    );

    var entries = entriesFromResponse(command, result, token);
    sendRequest(methodDictionary.logout, urlDictionary.logout, token);

    return entries;

  type: javascript
  commands:
  - name: guardicore-get-incidents
    arguments:
    - name: severity
      auto: PREDEFINED
      predefined:
      - High
      - Low
      - Medium
      description: Filter by severity.
    - name: tag
      description: Filter by tag.
    - name: incident_type
      description: Filter by type of incidents, e.g. Deception, Lateral Movement.
    - name: source
      description: Filter by source (hostname or IP address).
    - name: destination
      description: Filter by destination (hostname or IP address).
    description: Display information about incidents (with filters).
  - name: guardicore-uncommon-domains
    arguments: []
    description: Display the uncommon domains.
  - name: guardicore-unresolved-domains
    arguments: []
    description: Display the unresolved domains.
  - name: guardicore-show-endpoint
    arguments:
    - name: host_id
      required: true
      description: The host ID.
    description: Display information about the endpoint given its ID.
  - name: guardicore-dns-requests
    arguments: []
    description: Display the DNS requests.
  - name: guardicore-search-endpoint
    arguments:
    - name: ip_address
      description: The IP address of the endpoint.
    - name: name
      description: The hostname of the endpoint.
    description: Display information about the endpoint by its hostname or IP address.
  - name: guardicore-misconfigurations
    arguments: []
    description: Display the misconfigurations.
  - name: guardicore-get-incident
    arguments:
    - name: id
      required: true
      default: true
      description: The ID of the incident.
    description: Display information about the given incident.
  - name: guardicore-get-incident-iocs
    arguments:
    - name: id
      required: true
      default: true
      description: The ID of the incident.
    description: Display the IOCs (Indicators of Compromise) of the given incident.
  - name: guardicore-get-incident-events
    arguments:
    - name: id
      required: true
      description: The ID of the incident.
    description: Display the events related to the given incidents.
  - name: guardicore-get-incident-pcap
    arguments:
    - name: id
      required: true
      description: The ID of the incident.
    description: Retrieve the PCAP file attached to the given incident.
  - name: guardicore-get-incident-attachments
    arguments:
    - name: id
      required: true
      description: The ID of the incident.
    description: Retrieve the files attached to the given incidents.
  - name: guardicore-search-network-log
    arguments:
    - name: source
      description: Filter by source (hostname or IP address).
    - name: destination
      description: Filter by destination (hostname or IP address).
    - name: port
      description: Filter by port number.
    - name: uuid
      description: Filter by Event ID.
    description: Searches within the network log (with filters).
toversion: 3.1.0
