commonfields:
  id: Cisco Umbrella Investigate
  version: -1
name: Cisco Umbrella Investigate
display: Cisco Umbrella Investigate
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEkAAAAyCAYAAAAQlvbeAAAGx0lEQVR42u1Za2xURRTeOzPbYikPeWgRWx7y8JXwQ/3HDw2JxldMBDXGBIhiFF+AihDFhJDwA8KjElhLd/c+lkIRQhtRjPKIKIokCshD9s7c3S0FSgVFnilQlPW77ez2lr3VLs0uNt6TnGxzz8ycc78558w3tz5PPPHEE0888cQTTzz5T4lini5jYb6IBPaPy4c/svz4WKYfWqys/mNYtwGJ1tRNZypPUt38nFRxJdf+WDCxnmlmkhqHZ3cbkFgoGmEaT0KPMNUsyKkvwyRMN0WrP3N99wFJM8MSpDhTo7kFSecEfn6R/tZ4IHU3kJSTF4uZJl6hmrgvG5AUPT6QRaJTybLfR2bVnCPx4SitqUr5uZJsQKJqbAyLiFd9FaJP/pvzuvgc9Bs7sDqqix6dBQnAaraNquL7rPxFxJbWwyBe3VmQaFXMz3TBW2xBMT//JRU2y2VgJxB8n86DxDdK28Gs/Kn8R9mcv+o0SCrviWdHbZtf4ytzWPOiyL3v8MUysEa8QO8sQKqVtn3u68aKO/C3S877otMgabwIz+olSAF3+mAWdY2kaYeegoMGqlobSDDuzzVIROfT7MwkRnRmzkHad4rSDXVrWMg8Tqri47uSRZp0ftFviJJcg0Q1sd22Uc36IdcgsUqzH1rGOTlP78JRzivlImcKInkASRWbZVPfnnOQNN4P+pucF+wC3Td1uUhTgSEGXWNbJm2nsCPZgLRJNuBoZibx1kwK8Z0uIO2xbSiPrVk0bhukxhaQVB5yAemsbUPFXH8m0W3HJiNLLlJd7FAisUKnjXzZ+BzAuUxXWZuU2nraWZBomM9kutlMVyYqM/yFjsxj4egVUlu/IMMWjn4Ef1fop/UfdhYkpcok1OA1eN5MDGtyO9ta4YdtK2yX6MfRKV3jQ4Y1mEbMm9zvaKKUVNcVuJDJVC9L4KUz7dW8jCw9QdyzN1rmSl6D+xVaaWbYALgN0iHpb23GYbDGAhhWqTtB5YXYtNt9+RbZgCta05gnsFsst5fpuMJUgUwy0csso/t8Tyo/PZyFogHyTeOj+fBHIsfHoa8ElKW7R/k88cST/7XQtYlCNOk7QBVGM8O6uf2lNKrYXAXaE3a/+5dFPhDz74IOw0lT9M+XXDGAaeJOrDWE6ryg43Exmx+NxPgRYO89bhg4RKvrhWa5iBnCZrR/Qq9CT0Ofd1CBUnkLP+nX+evtj/QDJZi/ATZ5NcB8jFUCP5W5nJYPws82x9hmALXbt1IUt4uppqE/C/EVsDdA/5JxHcXYxcRI9M7v6bWsaQBTrT0AwQ74Wp3hAGmYDDQJkGal56+wCA2LzY45l6EXoEkltHd0uxff1jCJhfnVDD8gub6KeN/0mocvDGZVsShT3WICPdCtvT7twoD8lZgki5LSJ1hEvI/fl1AKS/FsggOkoTajlSDNbCsxMVTudJIaYiPIXn/7mgBONUZZuCOdHUq4bjiuP02Ol11HVfNlAPQmSrgSmZQGiYVFbRogne/F70yMm50mmlDMieSnzEL8Njhskrt5hKjWIPeRHYMEBl8GptySYQDsAPrGw3RVLIPV09XxeekX1OILOy59MSoFOjZrD10dK3LY+lKNR+U6l4gaL805SHD0UDrwsFjig2QFkhQarF/NdEdp6LyRRsSsa75+bkyVI0Ac2pEfZNf4tmwTUzLt/N10zFXWI7kHaV18XNqhYS24XpCUJacLmWHOha3e0WeSxDj8hmNDPktlAPpShxlAdfOZdEy6mOTydWF62l6dyP0tgFYfHtLSaFUbpFiMVB/rkz1IzheI+QH2E/JkRPnxXY4MWJgCj0ZiczqMqfLg3ehHV5GNSYD5HQ1y0lZuvDD1mQXaTLTYsPw07gCvcZweaJJiMvQx/D0Lp8jj/wYSCe4rpmHzAezwLZhXzHTrXvSSRll236bHreT3sJB5JU0RjNhyNPonMW8C+th8X6h1g8iGOoWtsbY4Trav4fsFgD8R6+1s62uiJn8UYMeZUpxocTh2pwDtQWqWIL2Xeu7XrFFy7AXoqfRcvCSJ1L/Yrilv+nUGelPShQI0+SqsNgpQe34EaMkxaXfTuBL4uTS/TLs6VoLgNTg/4wjkCnSyA6Qh0n4RIM1oA0nY/On8NS/RQMOJd9x7jvU01tqbOsGkWuBJvdoBqteVoT99kuJcUs9CI0S3Snw3QgDSrfZ/cZnewnIrqc4/AIca4biW9EZfmQZ9G/b7HeD1sjMOWg4NQZeghJ4l4Xp/x9wsOhbj5kKDyKJyGrEm+gIxlkEHDA6gxFsYVwENUFW8hrgG+TzxxBNPPPHEE0888eRGyN8R98jGg6pa+wAAAABJRU5ErkJggg==
description: Cisco Umbrella Investigate
detaileddescription: 'Cisco Investigate is part of the Cisco Umbrella package. When
  you log into the CIsco Umbrella portal you will need to obtain the API Token for
  the Cisco Investigate Feature. '
configuration:
- display: Cisco Umbrella API token
  name: APIToken
  defaultvalue: ""
  type: 4
  required: true
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Base URL
  name: baseURL
  defaultvalue: https://investigate.api.umbrella.com
  type: 0
  required: true
script:
  script: |2+


    // This object describe the result of the http request of getDomainSecurity function
    // each field has Name,Info & ContextKey
    var SecurityResultInfo = {
        dga_score: { Name: 'DGA', Info: 'Domain Generation Algorithm. This score is generated based on the likeliness of the domain ' +
                            'name being generated by an algorithm rather than a human. This algorithm is designed to identify ' +
                            'domains which have been created using an automated randomization strategy, which is a common evasion ' +
                            'technique in malware kits or botnets. This score ranges from -100 (suspicious) to 0 (benign)' },
        perplexity: { Name: 'Perplexity', Info: 'A second score on the likeliness of the name to be algorithmically generated, ' +
                            'on a scale from 0 to 1. This score is to be used in conjunction with DGA' },
        entropy: { Name: 'Entropy', Info: 'The number of bits required to encode the domain name, as a score. This score is to ' +
                            'be used in conjunction with DGA and Perplexity' },
        securerank2: { Name: 'SecureRank', Info: 'Suspicious rank for a domain that reviews based on the lookup behavior of client ' +
                            'IP for the domain. Securerank is designed to identify hostnames requested by known infected clients but ' +
                            'never requested by clean clients, assuming these domains are more likely to be bad. Scores returned ' +
                            'range from -100 (suspicious) to 100 (benign)' },
        pagerank: { Name: 'PageRank', Info: 'Popularity according to Google\'s pagerank algorithm' },
        asn_score: { Name: 'ASN Score', ContextKey: 'ASNScore', Info: 'ASN reputation score, ranges from -100 to 0 with -100 being very suspicious' },
        prefix_score: { Name: 'Prefix Score', ContextKey: 'PrefixScore', Info: 'Prefix ranks domains given their IP prefixes (an IP prefix is the first ' +
                            'three octets in an IP address) and the reputation score of these prefixes. Ranges from -100 to 0,' +
                            ' -100 being very suspicious' },
        rip_score: { Name: 'RIP Score', ContextKey: 'RIPScore', Info: 'RIP ranks domains given their IP addresses and the reputation score of these IP ' +
                            'addresses. Ranges from -100 to 0, -100 being very suspicious' },
        popularity: { Name: 'Popularity', Info: 'The number of unique client IPs visiting this site, relative to the all ' +
                            'requests to all sites. A score of how many different client/unique IPs go to this domain compared to others' },
        geoscore: { Name: 'GeoScore', Info: 'A score that represents how far the different physical locations serving this name are from each other' },
        ks_test: { Name: 'Kolmoorov-Smirnov', ContextKey: 'KolmoorovSmirnov', Info: 'Kolmogorov–Smirnov test on geodiversity. 0 means that the client traffic matches what is expected for this TLD' },
        attack: { Name: 'Attack Name', ContextKey: 'AttackName', Info: 'The name of any known attacks associated with this domain. Returns blank if no known threat associated with domain' },
        threat_type: { Name: 'Threat Type', ContextKey: 'ThreatType',Info: 'The type of the known attack, such as botnet or APT. Returns blank if no known threat associated with domain' }
    }

    // used to describe result on getDomainDNSHistory function
    var IpDnsFeatureInfo = {
        rr_count: 'Number of records of that type mapping to the given IP',
        ld2_count: 'Number of 2-level names mapping to the given IP',
        ld3_count: 'Number of 3-level names mapping to the given IP',
        ld2_1_count: 'Number of 2-level names, without the TLD, mapping to the given IP',
        ld2_2_count: 'Number of 3-level names, without the TLD, mapping to a given IP',
        div_ld2: 'ld2_count divided by the number of records',
        div_ld3: 'ld3_count divided by the number of records',
        div_ld2_1: 'ld2_1_count divided by the number of records',
        div_ld2_2: 'ld2_2_count divided by the number of record'
    }

    var extractDomainName = function(url) {
        var hostname;
        //find & remove protocol (http, ftp, etc.) and get the hostname
        if (url.indexOf("://") > -1) {
            hostname = url.split('/')[2];
        }
        else {
            hostname = url ? url.split('/')[0] : '';
        }

        //find & remove port number
        hostname = hostname.split(':')[0];

        return hostname;
    }

    var insecure = params.insecure;
    var proxy = params.proxy;
    var apitoken = params.APIToken;
    var baseURL = params.baseURL;

    var domainArg = (args.domain) ? args.domain : '';
    domainArg = extractDomainName(domainArg);

    // "one_two" to "One Two"
    var keyToTableKey = function(s) {
        return s && s.replace(/_/g, ' ')
                .replace(/\w+/g, function(w){return w[0].toUpperCase() + w.slice(1).toLowerCase();});
    }

    // "one_two" to "OneTwo"
    var keyToContextKey = function(s) {
        return s && keyToTableKey(s).replace(/\s+/g, '');
    }

    var createTableEntry = function (name, contents, context, headers) {
        return {
            // type
            Type: entryTypes.note,
             // contents
            ContentsFormat: formats.json,
            Contents: contents,
            // human-readable
            ReadableContentsFormat: formats.markdown,
            HumanReadable: tableToMarkdown(name, contents, headers),
            // context
            EntryContext: context
        };
    }

    var sendRequest = function(requestUrl) {
        var res = http(
            requestUrl,
            {
                Method: 'GET',
                Headers: {
                    Authorization: ['Bearer ' + apitoken],
                    Accept: ['application/json']
                }
            },
            insecure,
            proxy
        );


        if (!res || res.StatusCode < 200 || res.StatusCode >= 300) {
            var errorString = '';
            var body = JSON.parse(res.Body);

            if (body && body.error == 'unauthorized') {
                errorString = '\n\nError: Unauthorized check your API token\n';
            }
            errorString += '\nRequest Failed'
                + '\nRequestUrl: ' + requestUrl
                + '\nStatus code: ' + res.StatusCode
                + '\nResponse: ' + JSON.stringify(res);
            throw errorString;
        }

        var resBody = JSON.parse(res.Body);
        if (resBody === undefined) {
           throw 'Request Failed, returned response with no body';
        }
        return resBody;
    };

    var getDomainCategorization = function(domain) {
        var url = baseURL + '/domains/categorization/' + encodeURIComponent(domain) + '?showLabels';

        var res = sendRequest(url);
        var categorization = res && res[domain];

        // build context & table
        var domainContext = {
            Name: domain
        };
        var table = {
            // will be override in case result contains any
            'Content Catecories': 'No Content Categories Were Found',
            'Security Catecories': 'No Security Categories Were Found'
        };
        if (categorization) {
            if (categorization.status !== undefined) {
                table['Status'] = categorization.status
            }
            if (categorization.content_categories && categorization.content_categories.length > 0) {
                var contentCategories = categorization.content_categories.join(',');
                table['Content Catecories'] = contentCategories;
                domainContext.ContentCategories = contentCategories;
            }
            if (categorization.security_categories && categorization.security_categories.length > 0) {
                var securityCategories = categorization.security_categories.join(',');
                table['Security Catecories'] = securityCategories
            }
        }

        if (categorization.status === -1) {
            domainContext.Malicious = {Vendor: 'Cisco Umbrella', Description: securityCategories};
        }
        // build context
        var context = {};
        addMalicious(context, outputPaths.domain, domainContext);
        return createTableEntry("Categorization:", table, context);
    }

    var getDomainSearch = function(regex, start) {
        var url = baseURL + '/search/' + encodeURIComponent(regex) + '?includecategory=true';
        var startParam = start ? encodeURIComponent(start.replace(/\s/g,'')) : '-31days';

        url += '&start=' + startParam;
        var res = sendRequest(url);
        var matches = res && res.matches;

        if (!matches || !(matches instanceof Array )) {
            return "No information found about this domain";
        }

        // build table
        var table = matches.map(function(match) {
           return {
                'Name': match.name,
                'First Seen': match.firstSeenISO,
                'Security Categories': match.securityCategories.join(',') || "-"
           };
        });

        // build context
        var domainContext = [];

        // map matches to domains & check if matches is malare
        matches.forEach(function (match) {
            var securityCategoriesStr = match.securityCategories.join(',');
            var domain = {
                SecurityCategories: securityCategoriesStr,
                FirstSeen: match.firstSeen,
                FirstSeenISO:match.firstSeenISO
            };
            if(securityCategoriesStr.indexOf('Malware') > -1) {
                domain.Malicious = {Vendor: 'Cisco Umbrella', Description: 'Tagged as malware'};
                domain.properties_to_append = ['Malicious'];
            }
            domainContext.push(domain);
        });

        var context = {};
        context[outputPaths.domain] = domainContext;
        return createTableEntry("Search Results:", table, context);
    }

    var getDomainCooccurrences = function(domain) {
        var url = baseURL + '/recommendations/name/' + encodeURIComponent(domain) + '.json';
        var res = sendRequest(url);

        var occurrences = res && res.pfs2;
        if (!occurrences || !(occurrences instanceof Array )) {
            return "No information found about this domain";
        }

        // table
        var table = occurrences.map(function(occurrence) {
           return {
               Name: occurrence[0],
               Score: occurrence[1]
           }
        });

        // context
        var context = {};
        if (occurrences.length > 0) {
            context.Domain = {
                Name: domain,
                CoOccurrences: table
            };
        }
        return createTableEntry("Co-occurrences:", table, context);
    }

    var getDomainRelated = function(domain) {
        var url = baseURL + '/links/name/' + encodeURIComponent(domain) + '.json';
        var res = sendRequest(url);

        var related = res && res.tb1;
        if (!related || !(related instanceof Array )) {
            return "No information found about this domain";
        }

        // table
        var table = related.map(function(r) {
           return {
               Name: r[0],
               Score: r[1]
           }
        });

        // context
        var context = {};
        if (related.length > 0) {
            context.Domain = {
                Name: domain,
                Related: table
            };
        }
        return createTableEntry("Related Domains:", table, context);
    }

    var getDomainSecurity = function(domain) {
        var url = baseURL + '/security/name/' + encodeURIComponent(domain) + '.json';
        var res = sendRequest(url);

        if (!res) {
            return "No information found about this domain";
        }

        // each key in SecurityResultInfo corrispond to a key in 'res'
        // we get the score from 'res' & add Name & Info from SecurityResultInfo
        var table = Object.keys(SecurityResultInfo).map(function(key) {
            var infoObj = SecurityResultInfo[key];
            return {
                Name: infoObj.Name,
                Score: res[key],
                Info: infoObj.Info
            }
        });

        // context
        var domainSecurityContext = {};
        Object.keys(SecurityResultInfo).forEach(function(key) {
            var contextKey = SecurityResultInfo[key].ContextKey || SecurityResultInfo[key].Name;
            domainSecurityContext[contextKey] = res[key];
        });
        var context = {
            Domain: {
                Name: domain,
                Security: domainSecurityContext
            }
        };

        return createTableEntry("Domain Security Info:", table, context);
    }

    var getDomainTags = function(domain) {
        var url = baseURL + '/domains/' + encodeURIComponent(domain) + '/latest_tags';
        var tags = sendRequest(url);

        var table = tags.map(function(tag) {
            return {
                'Period Begin': tag.period.begin,
                'Period End': tag.period.end,
                Category: tag.Category,
                Url: tag.url
            }
        });

        var context = {
            Name: domain,
            Tags: tags.map(function(tag) {
                return {
                    Period: {
                        Begin: tag.period.begin,
                        End: tag.period.end
                    },
                    Category: tag.Category,
                    Url: tag.url
                };
            })
        };

        return createTableEntry("Tags:", table, context);
    }

    var getDomainDNSHistory = function(domain) {
        var url = baseURL + '/dnsdb/name/a/' + encodeURIComponent(domain) + '.json';
        var res = sendRequest(url);

        var features = res && res.features;
        if (!features) {
            return "No information found about this domain";
        };
        var address = res.rrs_tf && res.rrs_tf[0] && res.rrs_tf[0].rrs && res.rrs_tf[0].rrs[0] && res.rrs_tf[0].rrs[0].rr;
        features.ip = address;

        var table = {};
        var DNSHistoryContext = {};

        // change features object with the following:
        // - change keys to pascal cases
        // - change array-values to string
        // - special handle 'locations' key
        Object.keys(features).forEach(function(key) {
            var tableKey = keyToTableKey(key);
            var contextKey = keyToContextKey(key);

            var value = features[key];

            // context
            DNSHistoryContext[contextKey] = value;

            if(key === 'locations') {
                table[tableKey] = value.map(function(location) {
                    return '[ ' + location.lat + ', ' + location.lon + ' ]';
                }).join();
            } else {
                // table
                if (value instanceof Array) {
                    // array-values
                    table[tableKey] = value.join();
                } else {
                    table[tableKey] = value;
                }
            }
        });

        context = {
            Domain: {
                Name: domain,
                DNSHistory: DNSHistoryContext
            }
        }
        return createTableEntry("DNS History:", table, context);
    }

    var getIpDNSHistory = function(ip) {
        var url = baseURL + '/dnsdb/ip/a/' + ip + '.json';
        var res = sendRequest(url);

        // this command return 2 entries - but the context update is done with the 2nd entry
        var rrs = res && res.rrs;
        var features = res && res.features;
        if (!rrs || !features) {
            return "No information found about this ip";
        };

        var rrsTable = rrs.map(function(obj) {
            return {
                RR: obj.rr,
                TTL: obj.ttl,
                Class: obj.class,
                Type: obj.type,
                Name: obj.name
            }
        });

        var rrsEntry = createTableEntry("RRS:", rrsTable, {});

        var featuresTable = {};
        var featuresContext = {};
        // transform feature to table & context
        Object.keys(IpDnsFeatureInfo).forEach(function(key) {
            // table
            var tableKey = keyToTableKey(key);
            featuresTable[tableKey] = features[key];
            // context
            var contextKey = keyToContextKey(key);
            featuresContext[contextKey] = features[key];
        });

        var context = {
            IP: {
                Address: ip,
                DNSHistory: {
                    RRS: rrsTable,
                    Features: featuresContext
                }
            }
        };

        var featuresEntry = createTableEntry("Features:", featuresTable, context);
        return [rrsEntry, featuresEntry];
    }

    var getIpMaliciousDomains = function(ip) {
        var url = baseURL + '/ips/' + ip + '/latest_domains';
        var res = sendRequest(url);

        var table = res.map(function(obj) {
            return {
                Name: obj.name,
                Malicious: {Vendor: 'Cisco Umbrella', Description: 'For IP: ' + ip},
                properties_to_append: ['Malicious']
            }
        });

        var context = {};
        if (table.length > 0) {
            context[outputPaths.domain] = table;
        }
        return createTableEntry("Malicious Domains:", table, context);
    }

    var getDomain = function(domain) {
        // set request url and send request
        var url = baseURL + '/ips/' + ip + '/latest_domains';
        var res = sendRequest(url);

        // create table content
        var table = res.map(function(obj) {
            return {
                Name: obj.name,
                Malicious: {Vendor: 'Cisco Umbrella', Description: 'For IP: ' + ip},
                properties_to_append: ['Malicious']
            }
        });

        // create context content
        var context = {};
        if (table.length > 0) {
            context[outputPaths.domain] = table;
        }

        // send data to create output
        return createTableEntry("Malicious Domains:", table, context);
    }

    var getRelatedDomains = function(domain, co_occurences) {
        // set request url and send request
        var url = baseURL + '/ips/' + ip + '/latest_domains';
        var res = sendRequest(url);

        // create table content
        var table = res.map(function(obj) {
            return {
                Name: obj.name,
                Malicious: {Vendor: 'Cisco Umbrella', Description: 'For IP: ' + ip},
                properties_to_append: ['Malicious']
            }
        });

        // create context content
        var context = {};
        if (table.length > 0) {
            context[outputPaths.domain] = table;
        }

        // send data to create output
        return createTableEntry("Malicious Domains:", table, context);
    }

    var getDomainClassifiers = function(domain) {
        // set request url and send request
        var url = baseURL + '/ips/' + ip + '/latest_domains';
        var res = sendRequest(url);

        // create table content
        var table = res.map(function(obj) {
            return {
                Name: obj.name,
                Malicious: {Vendor: 'Cisco Umbrella', Description: 'For IP: ' + ip},
                properties_to_append: ['Malicious']
            }
        });

        // create context content
        var context = {};
        if (table.length > 0) {
            context[outputPaths.domain] = table;
        }

        // send data to create output
        return createTableEntry("Malicious Domains:", table, context);
    }

    var getDomainQueryVolume = function(domain, start_ts, stop_ts, match) {
        // set request url and send request
        var url = baseURL + '/ips/' + ip + '/latest_domains';
        var res = sendRequest(url);

        // create table content
        var table = res.map(function(obj) {
            return {
                Name: obj.name,
                Malicious: {Vendor: 'Cisco Umbrella', Description: 'For IP: ' + ip},
                properties_to_append: ['Malicious']
            }
        });

        // create context content
        var context = {};
        if (table.length > 0) {
            context[outputPaths.domain] = table;
        }

        // send data to create output
        return createTableEntry("Malicious Domains:", table, context);
    }

    var getDomainDetails = function(domain) {
        // set request url and send request
        var url = baseURL + '/ips/' + ip + '/latest_domains';
        var res = sendRequest(url);

        // create table content
        var table = res.map(function(obj) {
            return {
                Name: obj.name,
                Malicious: {Vendor: 'Cisco Umbrella', Description: 'For IP: ' + ip},
                properties_to_append: ['Malicious']
            }
        });

        // create context content
        var context = {};
        if (table.length > 0) {
            context[outputPaths.domain] = table;
        }

        // send data to create output
        return createTableEntry("Malicious Domains:", table, context);
    }

    var getWhoisForEmailRegistrar = function(email, offset, sort, limit) {
        // set request url and send request
        var url = baseURL + '/ips/' + ip + '/latest_domains';
        var res = sendRequest(url);

        // create table content
        var table = res.map(function(obj) {
            return {
                Name: obj.name,
                Malicious: {Vendor: 'Cisco Umbrella', Description: 'For IP: ' + ip},
                properties_to_append: ['Malicious']
            }
        });

        // create context content
        var context = {};
        if (table.length > 0) {
            context[outputPaths.domain] = table;
        }

        // send data to create output
        return createTableEntry("Malicious Domains:", table, context);
    }

    var getWhoisForNameServer = function(nameserver, offset, sort, limit) {
        // set request url and send request
        var url = baseURL + '/ips/' + ip + '/latest_domains';
        var res = sendRequest(url);

        // create table content
        var table = res.map(function(obj) {
            return {
                Name: obj.name,
                Malicious: {Vendor: 'Cisco Umbrella', Description: 'For IP: ' + ip},
                properties_to_append: ['Malicious']
            }
        });

        // create context content
        var context = {};
        if (table.length > 0) {
            context[outputPaths.domain] = table;
        }

        // send data to create output
        return createTableEntry("Malicious Domains:", table, context);
    }

    var getWhoisForDomains = function(domain) {
        // set request url and send request
        var url = baseURL + '/ips/' + ip + '/latest_domains';
        var res = sendRequest(url);

        // create table content
        var table = res.map(function(obj) {
            return {
                Name: obj.name,
                Malicious: {Vendor: 'Cisco Umbrella', Description: 'For IP: ' + ip},
                properties_to_append: ['Malicious']
            }
        });

        // create context content
        var context = {};
        if (table.length > 0) {
            context[outputPaths.domain] = table;
        }

        // send data to create output
        return createTableEntry("Malicious Domains:", table, context);
    }

    var getMaliciousDomainsForIP = function(ip) {
        // set request url and send request
        var url = baseURL + '/ips/' + ip + '/latest_domains';
        var res = sendRequest(url);

        // create table content
        var table = res.map(function(obj) {
            return {
                Name: obj.name,
                Malicious: {Vendor: 'Cisco Umbrella', Description: 'For IP: ' + ip},
                properties_to_append: ['Malicious']
            }
        });

        // create context content
        var context = {};
        if (table.length > 0) {
            context[outputPaths.domain] = table;
        }

        // send data to create output
        return createTableEntry("Malicious Domains:", table, context);
    }

    var getDomainUsingRegex = function(expression, start, stop, includeCategory, limit, type) {
        // set request url and send request
        var url = baseURL + '/ips/' + ip + '/latest_domains';
        var res = sendRequest(url);

        // create table content
        var table = res.map(function(obj) {
            return {
                Name: obj.name,
                Malicious: {Vendor: 'Cisco Umbrella', Description: 'For IP: ' + ip},
                properties_to_append: ['Malicious']
            }
        });

        // create context content
        var context = {};
        if (table.length > 0) {
            context[outputPaths.domain] = table;
        }

        // send data to create output
        return createTableEntry("Malicious Domains:", table, context);
    }

    var getDomainTimeline = function(domain) {
        // set request url and send request
        var url = baseURL + '/ips/' + ip + '/latest_domains';
        var res = sendRequest(url);

        // create table content
        var table = res.map(function(obj) {
            return {
                Name: obj.name,
                Malicious: {Vendor: 'Cisco Umbrella', Description: 'For IP: ' + ip},
                properties_to_append: ['Malicious']
            }
        });

        // create context content
        var context = {};
        if (table.length > 0) {
            context[outputPaths.domain] = table;
        }

        // send data to create output
        return createTableEntry("Malicious Domains:", table, context);
    }

    var getIPTimeline = function(ip) {
        // set request url and send request
        var url = baseURL + '/ips/' + ip + '/latest_domains';
        var res = sendRequest(url);

        // create table content
        var table = res.map(function(obj) {
            return {
                Name: obj.name,
                Malicious: {Vendor: 'Cisco Umbrella', Description: 'For IP: ' + ip},
                properties_to_append: ['Malicious']
            }
        });

        // create context content
        var context = {};
        if (table.length > 0) {
            context[outputPaths.domain] = table;
        }

        // send data to create output
        return createTableEntry("Malicious Domains:", table, context);
    }

    var getURLTimeline = function(url) {
        // set request url and send request
        var url = baseURL + '/ips/' + ip + '/latest_domains';
        var res = sendRequest(url);

        // create table content
        var table = res.map(function(obj) {
            return {
                Name: obj.name,
                Malicious: {Vendor: 'Cisco Umbrella', Description: 'For IP: ' + ip},
                properties_to_append: ['Malicious']
            }
        });

        // create context content
        var context = {};
        if (table.length > 0) {
            context[outputPaths.domain] = table;
        }

        // send data to create output
        return createTableEntry("Malicious Domains:", table, context);
    }

    switch (command) {
        case 'test-module':
            getDomainSearch('www.demisto.com');
            return 'ok';
        case 'investigate-umbrella-domain-categorization':
        case 'umbrella-domain-categorization':
            return getDomainCategorization(domainArg);
        case 'investigate-umbrella-domain-search':
        case 'umbrella-domain-search':
            return getDomainSearch(args.regex, args.start);
        case 'investigate-umbrella-domain-co-occurrences':
        case 'umbrella-domain-co-occurrences':
            return getDomainCooccurrences(domainArg);
        case 'investigate-umbrella-domain-related':
        case 'umbrella-domain-related':
            return getDomainRelated(domainArg);
        case 'investigate-umbrella-domain-security':
        case 'umbrella-domain-security':
            return getDomainSecurity(domainArg);
        case 'investigate-umbrella-domain-tags':
        case 'umbrella-domain-tags':
            return getDomainTags(domainArg);
        case 'investigate-umbrella-domain-dns-history':
        case 'umbrella-domain-dns-history':
            return getDomainDNSHistory(domainArg);
        case 'investigate-umbrella-ip-dns-history':
        case 'umbrella-ip-dns-history':
            return getIpDNSHistory(args.ip);
        case 'investigate-umbrella-ip-malicious-domains':
        case 'umbrella-ip-malicious-domains':
            return getIpMaliciousDomains(args.ip);
        // new commands start here
        case 'domain':
            return getDomain(domainArg);
        case 'umbrella-get-related-domains':
            return getRelatedDomains(domainArg,args.coOccurences);
        case 'umbrella-get-domain-classifiers':
            return getDomainClassifiers(domainArg);
        case 'umbrella-get-domain-queryvolume':
            return getDomainQueryVolume(domainArg, args.start, args.stop, args.match);
        case 'umbrella-get-domain-details':
            return getDomainDetails(domainArg);
        case 'umbrella-get-whois-for-email-registrar':
            return getWhoisForEmailRegistrar(args.email, args.offset, args.sort, args.limit);
        case 'umbrella-get-whois-for-nameserver':
            return getWhoisForNameServer(args.nameserver, args.offset, args.sort, args.limit);
        case 'umbrella-get-whois-for-domain':
            return getWhoisForDomains(domainArg);
        case 'umbrella-get-malicious-domains-for-ip':
            return getMaliciousDomainsForIP(args.ip);
        case 'umbrella-get-domains-using-regex':
            return getDomainUsingRegex(args.expression, args.start, args.stop, args.includeCategory, args.limit, args.type);
        case 'umbrella-get-domain-timeline':
            return getDomainTimeline(domainArg);
        case 'umbrella-get-ip-timeline':
            return getIPTimeline(args.ip);
        case 'umbrella-get-url-timeline':
            return getURLTimeline(args.url);
    }

  type: javascript
  commands:
  - name: umbrella-domain-categorization
    deprecated: true
    arguments:
    - name: domain
      required: true
      default: true
      description: Enter the domain you would like to categorize (e.g. amazon.com)
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.SecurityCategories
      description: The Umbrella security category, or categories, that match this
        domain
    - contextPath: Domain.ContentCategories
      description: The Umbrella content category or categories that match this domain
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    description: Returns the category of a domain. e.g. domain=amazon.com returns
      Ecommerce/Shopping
  - name: investigate-umbrella-domain-categorization
    arguments:
    - name: domain
      required: true
      default: true
      description: Enter the domain you would like to categorize (e.g. amazon.com)
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.SecurityCategories
      description: The Umbrella security category, or categories, that match this
        domain
    - contextPath: Domain.ContentCategories
      description: The Umbrella content category or categories that match this domain
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    description: Returns the category of a domain. e.g. domain=amazon.com returns
      Ecommerce/Shopping
  - name: umbrella-domain-co-occurrences
    deprecated: true
    arguments:
    - name: domain
      required: true
      default: true
      description: Enter a domain (e.g. www.cnn.com)
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.Score
      description: Domain score - value range between 0 and 1
    description: Get a list of related domains back and returns a list of co-occurences
      for the specified domain. A co-occurrence is when two or more domains are being
      accessed by the same users within a small window of time. Being a co-occurrence
      isn't necessarily a bad thing, legitimate sites co-occur with each other as
      a part of normal web activity. However, unusual or suspicious co-occurence can
      provide additional information regarding attacks
  - name: investigate-umbrella-domain-co-occurrences
    arguments:
    - name: domain
      required: true
      default: true
      description: Enter a domain (e.g. www.cnn.com)
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.Score
      description: Domain score - value range between 0 and 1
    description: Get a list of related domains back and returns a list of co-occurences
      for the specified domain. A co-occurrence is when two or more domains are being
      accessed by the same users within a small window of time. Being a co-occurrence
      isn't necessarily a bad thing, legitimate sites co-occur with each other as
      a part of normal web activity. However, unusual or suspicious co-occurence can
      provide additional information regarding attacks
  - name: umbrella-domain-related
    deprecated: true
    arguments:
    - name: domain
      required: true
      default: true
      description: Enter a domain (e.g. www.cnn.com)
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.Score
      description: This is a score reflecting the number of client IPs looking up
        related sites within 60 seconds of the original request
    description: This will return a list of domain names that have been frequently
      seen requested b around the same time (up to 60 seconds before or after) as
      the given domain name, but that are not frequently associated with other domain
      names.
  - name: investigate-umbrella-domain-related
    arguments:
    - name: domain
      required: true
      default: true
      description: Enter a domain (e.g. www.cnn.com)
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.Score
      description: This is a score reflecting the number of client IPs looking up
        related sites within 60 seconds of the original request
    description: This will return a list of domain names that have been frequently
      seen requested b around the same time (up to 60 seconds before or after) as
      the given domain name, but that are not frequently associated with other domain
      names.
  - name: umbrella-domain-security
    deprecated: true
    arguments:
    - name: domain
      required: true
      default: true
      description: Enter a domain like (www.cnn.com)
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.Security.DGA
      description: Domain Generation Algorithm. This score is generated based on the
        likeliness of the domain name being generated by an algorithm rather than
        a human
    - contextPath: Domain.Security.Perplexity
      description: A second score on the likeliness of the name to be algorithmically
        generated, on a scale from 0 to 1
    - contextPath: Domain.Security.Entropy
      description: The number of bits required to encode the domain name, as a score
    - contextPath: Domain.Security.SecureRank
      description: Suspicious rank for a domain that reviews based on the lookup behavior
        of client IP for the domain
    - contextPath: Domain.Security.PageRank
      description: Popularity according to Google's pagerank algorithm
    - contextPath: Domain.Security.ASNScore
      description: ASN reputation score, ranges from -100 to 0 with -100 being very
        suspicious
    - contextPath: Domain.Security.PrefixScore
      description: Prefix ranks domains given their IP prefixes (an IP prefix is the
        first three octets in an IP address) and the reputation score of these prefixes.
        Ranges from -100 to 0, -100 being very suspicious
    - contextPath: Domain.Security.RipScore
      description: RIP ranks domains given their IP addresses and the reputation score
        of these IP addresses. Ranges from -100 to 0, -100 being very suspicious
    - contextPath: Domain.Security.Popularity
      description: The number of unique client IPs visiting this site, relative to
        the all requests to all sites
    - contextPath: Domain.Security.GeoScore
      description: A score that represents how far the different physical locations
        serving this name are from each other
    - contextPath: Domain.Security.KolmoorovSmirnov
      description: olmogorov–Smirnov test on geodiversity. 0 means that the client
        traffic matches what is expected for this TLD
    - contextPath: Domain.Security.AttackName
      description: The name of any known attacks associated with this domain, or blank
        if no known threat
    - contextPath: Domain.Security.ThreatType
      description: The type of the known attack, such as botnet or APT, or blank if
        no known threat
    description: This contains multiple scores or security features, each of which
      can be used to determine relevant datapoints to build insight on the reputation
      or security risk posed by the site. See security information about this specific
      domain at https://investigate-api.readme.io/docs/security-information-for-a-domain-1
  - name: investigate-umbrella-domain-security
    arguments:
    - name: domain
      required: true
      default: true
      description: Enter a domain like (www.cnn.com)
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.Security.DGA
      description: Domain Generation Algorithm. This score is generated based on the
        likeliness of the domain name being generated by an algorithm rather than
        a human
    - contextPath: Domain.Security.Perplexity
      description: A second score on the likeliness of the name to be algorithmically
        generated, on a scale from 0 to 1
    - contextPath: Domain.Security.Entropy
      description: The number of bits required to encode the domain name, as a score
    - contextPath: Domain.Security.SecureRank
      description: Suspicious rank for a domain that reviews based on the lookup behavior
        of client IP for the domain
    - contextPath: Domain.Security.PageRank
      description: Popularity according to Google's pagerank algorithm
    - contextPath: Domain.Security.ASNScore
      description: ASN reputation score, ranges from -100 to 0 with -100 being very
        suspicious
    - contextPath: Domain.Security.PrefixScore
      description: Prefix ranks domains given their IP prefixes (an IP prefix is the
        first three octets in an IP address) and the reputation score of these prefixes.
        Ranges from -100 to 0, -100 being very suspicious
    - contextPath: Domain.Security.RipScore
      description: RIP ranks domains given their IP addresses and the reputation score
        of these IP addresses. Ranges from -100 to 0, -100 being very suspicious
    - contextPath: Domain.Security.Popularity
      description: The number of unique client IPs visiting this site, relative to
        the all requests to all sites
    - contextPath: Domain.Security.GeoScore
      description: A score that represents how far the different physical locations
        serving this name are from each other
    - contextPath: Domain.Security.KolmoorovSmirnov
      description: olmogorov–Smirnov test on geodiversity. 0 means that the client
        traffic matches what is expected for this TLD
    - contextPath: Domain.Security.AttackName
      description: The name of any known attacks associated with this domain, or blank
        if no known threat
    - contextPath: Domain.Security.ThreatType
      description: The type of the known attack, such as botnet or APT, or blank if
        no known threat
    description: This contains multiple scores or security features, each of which
      can be used to determine relevant datapoints to build insight on the reputation
      or security risk posed by the site. See security information about this specific
      domain at https://investigate-api.readme.io/docs/security-information-for-a-domain-1
  - name: umbrella-domain-tags
    deprecated: true
    arguments:
    - name: domain
      required: true
      default: true
      description: Enter a domain like (www.cnn.com)
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.Category
      description: The Umbrella security category or categories that match this domain
    - contextPath: Domain.Url
      description: The full URL containing the malicious code at the domain requested.
        or null if URL is not available
    - contextPath: Domain.Period.Begin
      description: 'The beginning date of domain being added to block list '
    - contextPath: Domain.Period.End
      description: The end date of domain being added to block list, if domain is
        currently blocked - value will be 'Current'
    description: This command returns the date range when the domain being queried
      was a part of the Umbrella block list. A common use case is to find how long
      a domain has been in the block list for domains being blocked currently. However
      it will also show a record of the history of the domain in the Umbrella block
      list.
  - name: investigate-umbrella-domain-tags
    arguments:
    - name: domain
      required: true
      default: true
      description: Enter a domain like (www.cnn.com)
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.Category
      description: The Umbrella security category or categories that match this domain
    - contextPath: Domain.Url
      description: The full URL containing the malicious code at the domain requested.
        or null if URL is not available
    - contextPath: Domain.Period.Begin
      description: 'The beginning date of domain being added to block list '
    - contextPath: Domain.Period.End
      description: The end date of domain being added to block list, if domain is
        currently blocked - value will be 'Current'
    description: This command returns the date range when the domain being queried
      was a part of the Umbrella block list. A common use case is to find how long
      a domain has been in the block list for domains being blocked currently. However
      it will also show a record of the history of the domain in the Umbrella block
      list.
  - name: umbrella-domain-dns-history
    deprecated: true
    arguments:
    - name: domain
      required: true
      default: true
      description: Enter a domain like (www.cnn.com)
    outputs:
    - contextPath: IP.Address
      description: IP address
    - contextPath: IP.DNSHistory.Age
      description: The day in days between now and the last request for this domain.
        This value is only useful if present
    - contextPath: IP.DNSHistory.TtlsMin
      description: Minimum amount of time set that DNS records should be cached
    - contextPath: IP.DNSHistory.TtlsMax
      description: Maximum amount of time set that DNS records should be cached
    - contextPath: IP.DNSHistory.TtlsMean
      description: Average amount of time set that DNS records should be cached
    - contextPath: IP.DNSHistory.TtlsMedian
      description: Median amount of time set that DNS records should be cached
    - contextPath: IP.DNSHistory.TtlsStddev
      description: Standard deviation of the amount of time set that DNS records should
        be cached
    - contextPath: IP.DNSHistory.CountryCodes
      description: 'List of country codes (ex: US, FR, TW) for the IPs the name maps
        to'
    - contextPath: IP.DNSHistory.CountryCount
      description: Number of countries the IPs are hosted in
    - contextPath: IP.DNSHistory.Asns
      description: List of ASN numbers the IPs are in
    - contextPath: IP.DNSHistory.AsnsCount
      description: Number of ASNs the IPs map to
    - contextPath: IP.DNSHistory.Prefixes
      description: List of network prefixes the IPs map to
    - contextPath: IP.DNSHistory.PrefixesCount
      description: Number of network prefixes the IPs map to
    - contextPath: IP.DNSHistory.Rips
      description: Number of IPs seen for the domain name
    - contextPath: IP.DNSHistory.DivRips
      description: The number of prefixes over the number of IPs
    - contextPath: IP.DNSHistory.Locations
      description: List of geo coordinates (WGS84 datum, decimal format) the IPs are
        mapping to
    - contextPath: IP.DNSHistory.LocationsCount
      description: Number of distinct geo coordinates the IPs are mapping to
    - contextPath: IP.DNSHistory.GeoDistanceSum
      description: Minimum sum of distance between locations, in kilometers
    - contextPath: IP.DNSHistory.GeoDistancMean
      description: Mean distance between the geo median and each location, in kilometers
    - contextPath: IP.DNSHistory.MailExchanger
      description: Boolean, If an MX query for this domain name has been seen
    - contextPath: IP.DNSHistory.NonRoutable
      description: Boolean. If one of the IPs is in a reserved, non-routable IP range
    - contextPath: IP.DNSHistory.FfCandidate
      description: Boolean. If the domain name looks like a candidate for fast flux.
        This does not necessarily mean the domain is in fast flux, but rather that
        the IP address the domain resolves to changes rapidly
    - contextPath: IP.DNSHistory.RipsStability
      description: 1.0 divided by the number of times the set of IP addresses changed
    - contextPath: IP.DNSHistory.BaseDomain
      description: The base domain of the requested domain
    - contextPath: IP.DNSHistory.IsSubdomain
      description: Boolean. True if the requested domain is a subdomain of another
    description: 'The DNS database can be used to query the history that Umbrella
      has seen for a given domain. The most common use case is to obtain the RRs (Resource
      Record) history for a given domain, passing in the record query type as a parameter,
      to help build intelligence around an domain. '
  - name: investigate-umbrella-domain-dns-history
    arguments:
    - name: domain
      required: true
      default: true
      description: Enter a domain like (www.cnn.com)
    outputs:
    - contextPath: IP.Address
      description: IP address
    - contextPath: IP.DNSHistory.Age
      description: The day in days between now and the last request for this domain.
        This value is only useful if present
    - contextPath: IP.DNSHistory.TtlsMin
      description: Minimum amount of time set that DNS records should be cached
    - contextPath: IP.DNSHistory.TtlsMax
      description: Maximum amount of time set that DNS records should be cached
    - contextPath: IP.DNSHistory.TtlsMean
      description: Average amount of time set that DNS records should be cached
    - contextPath: IP.DNSHistory.TtlsMedian
      description: Median amount of time set that DNS records should be cached
    - contextPath: IP.DNSHistory.TtlsStddev
      description: Standard deviation of the amount of time set that DNS records should
        be cached
    - contextPath: IP.DNSHistory.CountryCodes
      description: 'List of country codes (ex: US, FR, TW) for the IPs the name maps
        to'
    - contextPath: IP.DNSHistory.CountryCount
      description: Number of countries the IPs are hosted in
    - contextPath: IP.DNSHistory.Asns
      description: List of ASN numbers the IPs are in
    - contextPath: IP.DNSHistory.AsnsCount
      description: Number of ASNs the IPs map to
    - contextPath: IP.DNSHistory.Prefixes
      description: List of network prefixes the IPs map to
    - contextPath: IP.DNSHistory.PrefixesCount
      description: Number of network prefixes the IPs map to
    - contextPath: IP.DNSHistory.Rips
      description: Number of IPs seen for the domain name
    - contextPath: IP.DNSHistory.DivRips
      description: The number of prefixes over the number of IPs
    - contextPath: IP.DNSHistory.Locations
      description: List of geo coordinates (WGS84 datum, decimal format) the IPs are
        mapping to
    - contextPath: IP.DNSHistory.LocationsCount
      description: Number of distinct geo coordinates the IPs are mapping to
    - contextPath: IP.DNSHistory.GeoDistanceSum
      description: Minimum sum of distance between locations, in kilometers
    - contextPath: IP.DNSHistory.GeoDistancMean
      description: Mean distance between the geo median and each location, in kilometers
    - contextPath: IP.DNSHistory.MailExchanger
      description: Boolean, If an MX query for this domain name has been seen
    - contextPath: IP.DNSHistory.NonRoutable
      description: Boolean. If one of the IPs is in a reserved, non-routable IP range
    - contextPath: IP.DNSHistory.FfCandidate
      description: Boolean. If the domain name looks like a candidate for fast flux.
        This does not necessarily mean the domain is in fast flux, but rather that
        the IP address the domain resolves to changes rapidly
    - contextPath: IP.DNSHistory.RipsStability
      description: 1.0 divided by the number of times the set of IP addresses changed
    - contextPath: IP.DNSHistory.BaseDomain
      description: The base domain of the requested domain
    - contextPath: IP.DNSHistory.IsSubdomain
      description: Boolean. True if the requested domain is a subdomain of another
    description: 'The DNS database can be used to query the history that Umbrella
      has seen for a given domain. The most common use case is to obtain the RRs (Resource
      Record) history for a given domain, passing in the record query type as a parameter,
      to help build intelligence around an domain. '
  - name: umbrella-ip-dns-history
    deprecated: true
    arguments:
    - name: ip
      required: true
      default: true
      description: 'Enter an IP Address:'
    outputs:
    - contextPath: IP.Address
      description: IP address
    - contextPath: IP.DNSHistory.RRS.Name
      description: The looked up IP addres
    - contextPath: IP.DNSHistory.RRS.Class
      description: DNS class type
    - contextPath: IP.DNSHistory.RRS.Type
      description: Query type
    - contextPath: IP.DNSHistory.RRS.RR
      description: Resource record owner
    - contextPath: IP.DNSHistory.RRS.TTL
      description: Time to live for this record
    - contextPath: IP.DNSHistory.Feature.RrCount
      description: Number of records of that type mapping to the given IP
    - contextPath: IP.DNSHistory.Feature.Ld2Count
      description: Number of 2-level names mapping to the given IP
    - contextPath: IP.DNSHistory.Feature.Ld3Count
      description: Number of 3-level names mapping to the given IP
    - contextPath: IP.DNSHistory.Feature.Ld21Count
      description: Number of 2-level names, without the TLD, mapping to the given
        IP
    - contextPath: IP.DNSHistory.Feature.Ld22Count
      description: Number of 3-level names, without the TLD, mapping to the given
        IP
    - contextPath: IP.DNSHistory.Feature.DivLd2
      description: ld2_count divided by the number of records
    - contextPath: IP.DNSHistory.Feature.DivLd3
      description: ld3_count divided by the number of records
    - contextPath: IP.DNSHistory.Feature.DivLd21
      description: ld2_1_count divided by the number of records
    - contextPath: IP.DNSHistory.Feature.DivLd22
      description: ld2_2_count divided by the number of records
    description: The DNS database can be used to query the history that Umbrella has
      seen for a given IP address. The most common use case is to obtain the DNS Resource
      Record (RR) history for a given IP, passing in the record query type as a parameter,
      to help build intelligence around an IP or a range of IPs. The information provided
      is from within the last 90 days.
  - name: investigate-umbrella-ip-dns-history
    arguments:
    - name: ip
      required: true
      default: true
      description: 'Enter an IP Address:'
    outputs:
    - contextPath: IP.Address
      description: IP address
    - contextPath: IP.DNSHistory.RRS.Name
      description: The looked up IP addres
    - contextPath: IP.DNSHistory.RRS.Class
      description: DNS class type
    - contextPath: IP.DNSHistory.RRS.Type
      description: Query type
    - contextPath: IP.DNSHistory.RRS.RR
      description: Resource record owner
    - contextPath: IP.DNSHistory.RRS.TTL
      description: Time to live for this record
    - contextPath: IP.DNSHistory.Feature.RrCount
      description: Number of records of that type mapping to the given IP
    - contextPath: IP.DNSHistory.Feature.Ld2Count
      description: Number of 2-level names mapping to the given IP
    - contextPath: IP.DNSHistory.Feature.Ld3Count
      description: Number of 3-level names mapping to the given IP
    - contextPath: IP.DNSHistory.Feature.Ld21Count
      description: Number of 2-level names, without the TLD, mapping to the given
        IP
    - contextPath: IP.DNSHistory.Feature.Ld22Count
      description: Number of 3-level names, without the TLD, mapping to the given
        IP
    - contextPath: IP.DNSHistory.Feature.DivLd2
      description: ld2_count divided by the number of records
    - contextPath: IP.DNSHistory.Feature.DivLd3
      description: ld3_count divided by the number of records
    - contextPath: IP.DNSHistory.Feature.DivLd21
      description: ld2_1_count divided by the number of records
    - contextPath: IP.DNSHistory.Feature.DivLd22
      description: ld2_2_count divided by the number of records
    description: The DNS database can be used to query the history that Umbrella has
      seen for a given IP address. The most common use case is to obtain the DNS Resource
      Record (RR) history for a given IP, passing in the record query type as a parameter,
      to help build intelligence around an IP or a range of IPs. The information provided
      is from within the last 90 days.
  - name: investigate-umbrella-ip-malicious-domains
    arguments:
    - name: ip
      required: true
      default: true
      description: An IP Address
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    description: This command  shows whether the IP address you’ve entered as input
      has any known malicious domains associated with it. The domains that appear
      when using this endpoint are those that currently exist in the Umbrella block
      list. This endpoint will return an array with a single domain name for each
      domain associated with the IP, along with an id number that can be ignored.
  - name: umbrella-ip-malicious-domains
    deprecated: true
    arguments:
    - name: ip
      required: true
      default: true
      description: An IP Address
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    description: This command  shows whether the IP address you’ve entered as input
      has any known malicious domains associated with it. The domains that appear
      when using this endpoint are those that currently exist in the Umbrella block
      list. This endpoint will return an array with a single domain name for each
      domain associated with the IP, along with an id number that can be ignored.
  - name: umbrella-domain-search
    deprecated: true
    arguments:
    - name: regex
      required: true
      default: true
      description: Enter a domain regular expression (e.g. "cn.*\\\\.com"). Note to
        use double backslash ("\\\\")
    - name: start
      description: 'Example: -2weeks, -1 day, -1000minutes, EPOCH unix time'
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.FirstSeean
      description: First seen time in Epoch format
    - contextPath: Domain.FirstSeeanISO
      description: First seen time in ISO format
    - contextPath: Domain. SecurityCategories
      description: Matching Umbrella Security Categories
    description: This produces a list of matching domains based on a regular expression.
      You could use this for domain squatting. The pattern search functionality in
      Investigate uses regular expressions (RegEx) to search against the Investigate
      database. There are several excellent tools online such as http://regexr.com
      to help if you’re not familiar with building RegEx.
  - name: investigate-umbrella-domain-search
    arguments:
    - name: regex
      required: true
      default: true
      description: Enter a domain regular expression (e.g. "cn.*\\\\.com"). Note to
        use double backslash ("\\\\")
    - name: start
      description: 'Example: -2weeks, -1 day, -1000minutes, EPOCH unix time'
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.FirstSeean
      description: First seen time in Epoch format
    - contextPath: Domain.FirstSeeanISO
      description: First seen time in ISO format
    - contextPath: Domain. SecurityCategories
      description: Matching Umbrella Security Categories
    description: This produces a list of matching domains based on a regular expression.
      You could use this for domain squatting. The pattern search functionality in
      Investigate uses regular expressions (RegEx) to search against the Investigate
      database. There are several excellent tools online such as http://regexr.com
      to help if you’re not familiar with building RegEx.
  - name: domain
    arguments:
    - name: domain
      required: true
      description: 'The domain name you would like to categorize. (e.g. : www.amazon.com)
        Comma separated list allowed. (e.g. : www.amazon.com,www.facebook.com,www.yahoo.com)'
    outputs:
    - contextPath: Domain.Name
      description: The domain's name.
      type: string
    - contextPath: Domain.Umbrella.RiskScore
      description: The status will be "-1" if the domain is believed to be malicious,
        "1" if the domain is believed to be benign, "0" if it hasn't been classified
        yet.
      type: number
    - contextPath: Domain.Umbrella.SecureRank 
      description: Suspicious rank for a domain that reviews based on the lookup behavior
        of client IP for the domain. Securerank is designed to identify hostnames
        requested by known infected clients but never requested by clean clients,
        assuming these domains are more likely to be bad. Scores returned range from
        -100 (suspicious) to 100 (benign).
      type: number
    - contextPath: Domain.Umbrella.FirstQueriedTime
      description: The time when the attribution for this Domain was made.
      type: number
    - contextPath: DBotScore.Indicator
      description: The Indicator
      type: string
    - contextPath: DBotScore.Score
      description: The DBot score
      type: number
    - contextPath: DBotScore.Type
      description: The Indicator type
      type: string
    - contextPath: DBotScore.Vendor
      description: The DBot score vendor
      type: string
    - contextPath: Domain.Umbrella.ContentCategories
      description: The Umbrella content category or categories that match this domain.
        If none of them match, the return will be blank.
      type: string
    - contextPath: Domain.Umbrella.MalwareCategories
      description: The Umbrella security category, or categories, that match this
        domain or that this domain is associated with. If none match, the return will
        be blank.
      type: string
    description: Get Domain Reputation info using Cisco Umbrella Investigate.
  - name: umbrella-get-related-domains
    arguments:
    - name: domain
      required: true
      description: 'The domain name you would like see related domains for. (e.g.
        : www.cnn.com)'
    - name: co-occurences
      auto: PREDEFINED
      predefined:
      - "false"
      - "true"
      description: Set to true to get a list of co-occurences. (A co-occurrence is
        when two or more domains are being accessed by the same users within a small
        window of time) By default, this value will be false.
      defaultValue: "false"
    outputs:
    - contextPath: Domain.Name
      description: The domain's name.
      type: string
    - contextPath: Domain.Umbrella.RelatedDomains.Name
      description: Domain names that have been frequently seen requested around the
        same time (up to 60 seconds before or after) as the given domain name.
      type: string
    - contextPath: Domain.Umbrella.CoOccurences.Name
      description: All co-occurences of requests from client IPs are returned for
        the previous seven days whether the co-occurence is suspicious or not.
      type: string
    - contextPath: Domain.Umbrella.CoOccurences.Score
      description: The values range between 0 and 1 and should not exceed 1.
      type: number
    description: Get a list of domain names that have been frequently seen requested
      around the same time (up to 60 seconds before or after) as the given domain
      name. And also a list of co-occurences.
  - name: umbrella-get-domain-classifiers
    arguments:
    - name: domain
      description: 'The domain name you would like see classifiers for. (e.g. : www.cnn.com)'
    outputs:
    - contextPath: Domain.Name
      description: The domain's name.
      type: string
    - contextPath: Domain.Umbrella.MalwareCategories
      description: Which Umbrella security category, if any, matched the input
      type: string
    - contextPath: Domain.Umbrella.AttackNames
      description: Which named attacks, if any, matched the input
      type: string
    - contextPath: Domain.Umbrella.ThreatTypes
      description: Which threat type, if any, matched in the input.
      type: string
    description: List all the classifiers used for a particular domain to assign a
      particular security categorization or threat type (indicators of compromise).
  - name: umbrella-get-domain-queryvolume
    arguments:
    - name: domain
      required: true
      description: 'The domain name you would like see volume for. (e.g. : www.cnn.com)'
    - name: start
      required: true
      description: '"Point in time in the past, expressed as a timestamp in the following
        format or relative time. Valid formats: start=-2days start=-2hours start=1997-07-16T19:20:30+01:00
        i.e YYYY-MM-DDThh:mm:ssTZD  Note the negative sign. The max is 30 days."'
    - name: stop
      description: '"Point in time in the past expressed as a timestamp in milliseconds
        or relative time. Also valid is ''now''. Valid formats: stop=-1days stop=now
        start=1997-07-16T19:20:30+01:00 i.e YYYY-MM-DDThh:mm:ssTZD  Note the negative
        sign. The max is 30 days."'
    - name: match
      description: 'Valid options are: exact, component, or all (default).     1.Using
        "cisco.com" as an example, "exact" only gives results for cisco.com.    2.
        Component gives results for every component of cisco.com, but not cisco.com.
        Examples are www.cisco.com, mail.cisco.com, wwwin.cisco.com, something.else.cisco.com.     3.All
        returns the sum of component and exact, this is the default.'
    outputs:
    - contextPath: Domain.Name
      description: The domain's name.
      type: string
    - contextPath: Domain.Umbrella.QueryVolume.StartDate
      description: Start date for which the volume data is returned.
      type: string
    - contextPath: Domain.Umbrella.QueryVolume.StopDate
      description: Stop date for which the volume data is returned.
      type: string
    - contextPath: Domain.Umbrella.QueryVolume.QueryHour
      description: Query hour for which the queries data is returned.
      type: string
    - contextPath: Domain.Umbrella.QueryVolume.Queries
      description: Number of DNS queries per hour, in ascending order, to the specified
        domain.
      type: string
    description: The domain volume command shows the number of DNS queries made per
      hour to the specified domain by users of Umbrella's recursive DNS servers.
  - name: umbrella-get-domain-details
    arguments:
    - name: domain
      description: 'The domain name you would like see the security info for. (e.g.
        : www.cnn.com)'
    outputs:
    - contextPath: Domain.Name
      description: The domain's name.
      type: string
    - contextPath: Domain.Umbrella.Details.DGA
      description: Domain Generation Algorithm. This score is generated based on the
        likeliness of the domain name being generated by an algorithm rather than
        a human. This score ranges from -100 (suspicious) to 0 (benign).
      type: string
    - contextPath: Domain.Umbrella.Details.Entropy
      description: The number of bits required to encode the domain name, as a score.
        This score is to be used in conjunction with DGA and Perplexity.
      type: number
    - contextPath: Domain.Umbrella.Details.SecureRank 
      description: Suspicious rank for a domain that reviews based on the lookup behavior
        of client IP for the domain. Securerank is designed to identify hostnames
        requested by known infected clients but never requested by clean clients,
        assuming these domains are more likely to be bad. Scores returned range from
        -100 (suspicious) to 100 (benign).
      type: number
    - contextPath: Domain.Umbrella.Details.PrefixScore
      description: Prefix ranks domains given their IP prefixes (an IP prefix is the
        first three octets in an IP address) and the reputation score of these prefixes.
        Ranges from -100 to 0, -100 being very suspicious.
      type: number
    - contextPath: Domain.Umbrella.Details.RipScore
      description: RIP ranks domains given their IP addresses and the reputation score
        of these IP addresses. Ranges from -100 to 0, -100 being very suspicious.
      type: number
    - contextPath: Domain.Umbrella.Details.Popularity
      description: The number of unique client IPs visiting this site, relative to
        the all requests to all sites. A score of how many different client/unique
        IPs go to this domain compared to others.
      type: number
    - contextPath: Domain.Umbrella.Details.Geodiversity
      description: A score representing the number of queries from clients visiting
        the domain, broken down by country. Score is a non-normalized ratio between
        0 and 1.
      type: number
    - contextPath: Domain.Umbrella.Details.TldGeodiversity
      description: A score that represents the TLD country code geodiversity as a
        percentage of clients visiting the domain. Occurs most often with domains
        that have a ccTLD. Score is normalized ratio between 0 and 1.
      type: number
    - contextPath: Domain.Umbrella.Details.KolmogorovSmirnovTest
      description: Kolmogorov–Smirnov test on geodiversity. 0 means that the client
        traffic matches what is expected for this TLD.
      type: number
    - contextPath: DBotScore.Indicator
      description: The Indicator
      type: string
    - contextPath: DBotScore.Score
      description: The DBot score
      type: number
    - contextPath: DBotScore.Type
      description: The Indicator type
      type: string
    - contextPath: DBotScore.Vendor
      description: The DBot score vendor
      type: string
    description: The security information API method contains multiple scores or security
      features, which can act as relevant datapoints to build insight on the reputation.
  - name: umbrella-get-whois-for-email-registrar
    arguments:
    - name: email
      required: true
      description: 'Enter the Nameserver’s domain name. (e.g. : ns2.google.com) Comma
        separated list allowed. (e.g. : ns2.google.com, ns1.google.com)'
      defaultValue: 'Email address following rfc5322 conventions. (e.g. : admin@google.com)
        Comma separated list allowed. (e.g. : admin@google.com, dns-admin@google.com,
        hostmaster@charter.com)'
    - name: offset
      description: For paging with offset for domains with more than 500 results,
        set the url-param limit. Default value is 10.
    - name: sort
      description: '"To sort the list of domains based on timestamp. By default, domains
        are simply sorted by name in alphabetical order.  Possible values are: ""created"",
        ""updated"", and ""expired"", each of which sorts from the most recent date
        for the value of the WHOIS entry."'
    - name: limit
      description: To limit the total number of results (domains).
    outputs:
    - contextPath: Email.Address
      description: Email address.
      type: string
    - contextPath: Email.Umbrella.Whois.TotalResults
      description: Total number of results for this email.
      type: number
    - contextPath: Email.Umbrella.Whois.MoreDataAvailable
      description: Whether or not there are more than 500 results for this email,
        either yes or no.
      type: boolean
    - contextPath: Email.Umbrella.Whois.ResultLimit
      description: Total number of results for this page of results, default 500.
      type: number
    - contextPath: Email.Umbrella.Whois.Domains.Name
      description: Domains registered by this email
      type: string
    - contextPath: Email.Umbrella.Whois.Domains.Name.SecurityCategories
      description: Security Categories associated with the domain.
      type: string
    - contextPath: Email.Umbrella.Whois.Domains.Name.ContentCategories
      description: Content Categories associated with the domain.
      type: string
    - contextPath: Email.Umbrella.Whois.Domains.LastObserved
      description: 'Whether the domain is current, meaning currently registered by
        this email address. Values : Past or Current'
      type: string
    description: The WHOIS email command will return the email address or addresses
      of the registrar for the domain or domains that are looked up.
  - name: umbrella-get-whois-for-nameserver
    arguments:
    - name: nameserver
      description: 'Enter the Nameserver’s domain name. (e.g. : ns2.google.com) Comma
        separated list allowed. (e.g. : ns2.google.com, ns1.google.com)'
    - name: offset
      description: For paging with offset for domains with more than 500 results,
        set the url-param limit. Default value is 10.
    - name: sort
      description: '"To sort the list of domains based on timestamp. By default, domains
        are simply sorted by name in alphabetical order.  Possible values are: ""created"",
        ""updated"", and ""expired"", each of which sorts from the most recent date
        for the value of the WHOIS entry."'
    - name: limit
      description: To limit the total number of results (domains).
    outputs:
    - contextPath: Nameserver.Name
      description: Nameserver's domain name.
      type: string
    - contextPath: Nameserver.Umbrella.Whois.TotalResults
      description: Total number of results for this nameserver domain name.
      type: string
    - contextPath: Nameserver.Umbrella.Whois.MoreDataAvailable
      description: Whether or not there are more than 500 results for this email,
        either yes or no.
      type: boolean
    - contextPath: Nameserver.Umbrella.Whois.ResultLimit
      description: Total number of results for this page of results, default 500.
      type: number
    - contextPath: Nameserver.Umbrella.Whois.Domains.Name
      description: Domains registered by this nameserver.
      type: string
    - contextPath: Nameserver.Umbrella.Whois.Domains.Name.SecurityCategories
      description: Security Categories associated with the domain.
      type: string
    - contextPath: Nameserver.Umbrella.Whois.Domains.Name.ContentCategories
      description: Content Categories associated with the domain.
      type: string
    - contextPath: Nameserver.Umbrella.Whois.Domains.LastObserved
      description: 'Whether the domain is current, meaning currently registered by
        this email address. Values : Past or Current'
      type: string
    description: The Nameserver command allows you to search a nameserver to find
      all domains registered by that nameserver. You can search against a single nameserver
      or multiple nameservers in a query.
  - name: umbrella-get-whois-for-domain
    arguments:
    - name: domain
      required: true
      description: 'Domain name without wildcards and including TLD. (e.g. : www.cnn.com)'
    outputs:
    - contextPath: Domain.Name
      description: Domain's name.
      type: string
    - contextPath: Domain.Umbrella.Whois.RegistrarName
      description: Domain registrar name
      type: string
    - contextPath: Domain.Umbrella.Whois.LastRetrieved
      description: Domain last retrieved date
      type: string
    - contextPath: Domain.Umbrella.Whois.Created
      description: Domain created date
      type: string
    - contextPath: Domain.Umbrella.Whois.Updated
      description: Domain updated date
      type: string
    - contextPath: Domain.Umbrella.Whois.Expires
      description: Domain expiry date
      type: string
    - contextPath: Domain.Umbrella.Whois.IANAID
      description: IANA ID
      type: string
    - contextPath: Domain.Umbrella.Whois.LastObserved
      description: Domain last observed
      type: string
    - contextPath: Domain.Umbrella.Whois.Nameservers.Name
      description: Domain's name servers
      type: string
    - contextPath: Domain.Umbrella.Whois.Emails.Name
      description: Domain's email
      type: string
    description: This command will provide a standard WHOIS response record for a
      single domain with all available WHOIS data returned. 
  - name: umbrella-get-malicious-domains-for-ip
    arguments:
    - name: ip
      required: true
      description: IP Address to check for malicious domains.
    outputs:
    - contextPath: IP.Address
      description: IP address.
      type: string
    - contextPath: IP.Umbrella.MaliciousDomains.Name
      description: The block list domain associated with the IP
      type: string
    - contextPath: IP.Umbrella.MaliciousDomains.LastObserved
      description: 'Whether the domain is current, meaning currently registered by
        this email address. Values : Past or Current'
      type: string
    description: Test whether the IP address you’ve entered as input has any known
      malicious domains associated with it.
  - name: umbrella-get-domains-using-regex
    arguments:
    - name: expression
      required: true
      description: 'A standard RegEx search pattern, must be encoded in a double quoted
        bracket. e.g. :'
    - name: start
      required: true
      description: '"Can either be specified in relative or absolute time. Point in
        time in the past, expressed as a timestamp in the following format or relative
        time. Valid formats: start=-2days start=-2hours start=-1000minutes start=-3weeks
        start=1997-07-16T19:20:30+01:00 i.e YYYY-MM-DDThh:mm:ssTZD  Note the negative
        sign for relative time. """'
    - name: includeCategory
      auto: PREDEFINED
      predefined:
      - "false"
      - "true"
      description: Default is false, if set to true this will include security categories
        in the results and may slow the return times.
      defaultValue: "false"
    - name: stop
      description: 'The exclusive end time in milliseconds absolute or relative time
        (eg: ''now'', ''-2days'',''1997-07-16T19:20:30+01:00'') for a query.'
    - name: limit
      description: The maximum number of items to return - combine with offset for
        result pagination
    - name: type
      description: Search database node type (URL, IP, HOST).
    outputs:
    - contextPath: Umbrella.DomainSearch.TotalResults
      description: Total results from this search string. The default number of results
        is 100 and can be expanded using the limit parameter. 
      type: number
    - contextPath: Umbrella.DomainSearch.Domain.Name
      description: Name of the domain found.
      type: string
    - contextPath: Umbrella.DomainSearch.Domain.FirstSeen
      description: First Seen of the domain found.
      type: string
    description: 'Get the list of matching domains (Investigate Database) based on
      a regular expression. '
  - name: umbrella-get-domain-timeline
    arguments:
    - name: domain
      description: 'The domain name you would like see timeline for. (e.g. : www.cnn.com)'
    outputs:
    - contextPath: Domain.Name
      description: Domain name
      type: string
    - contextPath: Domain.Umbrella.MalwareCategories
      description: Which Umbrella security category, if any, matched the input
      type: string
    - contextPath: Domain.Umbrella.Attacks
      description: Which named attacks, if any, matched the input
      type: string
    - contextPath: Domain.Umbrella.ThreatTypes
      description: Which threat type, if any, matched in the input.
      type: string
    - contextPath: Domain.Umbrella.Timestamp
      description: The time when the attribution for this Domain changed. 
      type: string
    description: The timeline command shows when a domain was given attribution of
      a particular security categorization or threat type (indicators of compromise).
  - name: umbrella-get-ip-timeline
    arguments:
    - name: ip
      description: 'The IP you would like see timeline for. (e.g. : 8.8.8.8)'
    outputs:
    - contextPath: IP.Address
      description: IP address
    - contextPath: IP.Umbrella.MalwareCategories
      description: Which Umbrella security category, if any, matched the input
    - contextPath: IP.Umbrella.Attacks
      description: Which named attacks, if any, matched the inputWhich threat type,
        if any, matched in the input.
    - contextPath: IP.Umbrella.ThreatTypes
      description: Which threat type, if any, matched in the input.
    - contextPath: IP.Umbrella.Timestamp
      description: The time when the attribution for this IP changed. 
    description: The timeline command shows when a IP was given attribution of a particular
      security categorization or threat type (indicators of compromise).
  - name: umbrella-get-url-timeline
    arguments:
    - name: url
      description: 'The URL you would like see timeline for. (e.g. : www.aws.amazon.com)'
    outputs:
    - contextPath: URL.Data
      description: URL value
      type: string
    - contextPath: URL.Umbrella.MalwareCategories
      description: Which Umbrella security category, if any, matched the input
      type: string
    - contextPath: URL.Umbrella.Attacks
      description: Which named attacks, if any, matched the input
      type: string
    - contextPath: URL.Umbrella.ThreatTypes
      description: Which threat type, if any, matched in the input.
      type: string
    - contextPath: URL.Umbrella.Timestamp
      description: The time when the attribution for this URL changed. 
      type: date
    description: The timeline command shows when a URL was given attribution of a
      particular security categorization or threat type (indicators of compromise).
  runonce: false
