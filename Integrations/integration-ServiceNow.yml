commonfields:
  id: ServiceNow
  version: -1
name: ServiceNow
display: ServiceNow
category: Case Management
image: data:image/png;base64,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
description: IT service management
configuration:
- display: ServiceNow URL, in the format https://company.service-now.com/
  name: url
  defaultvalue: ""
  type: 0
  required: true
- display: Username
  name: credentials
  defaultvalue: ""
  type: 9
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "True"
  type: 8
  required: false
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: Default ticket type of commands. Can be incident, sc_request, problem or
    change_reuquest. Commands also take ticket_type argument
  name: ticket_type
  defaultvalue: incident
  type: 0
  required: false
- display: ServiceNow API Version (e.g. 'v1')
  name: api_version
  defaultvalue: ""
  type: 0
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: The query to use when fetching ServiceNow incidents
  name: sysparm_query
  defaultvalue: stateNOT IN6,7
  type: 0
  required: false
- display: How many ServiceNow incidents to fetch each time
  name: fetch_limit
  defaultvalue: "10"
  type: 0
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Get incident attachments
  name: get_attachments
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |-
    import re
    import requests
    import json
    import datetime
    import time
    import shutil

    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    if not demisto.params().get('proxy', False):
        del os.environ['HTTP_PROXY']
        del os.environ['HTTPS_PROXY']
        del os.environ['http_proxy']
        del os.environ['https_proxy']

    ''' GLOBAL VARIABLESS '''
    def get_server_url():
        url = demisto.params()['url']
        url = re.sub('/[\/]+$/', '', url)
        url = re.sub('\/$', '', url)
        return url


    USERNAME = demisto.params()['credentials']['identifier']
    PASSWORD = demisto.params()['credentials']['password']
    VERIFY_SSL = not demisto.params().get('insecure', False)
    API = '/api/now/'
    VERSION = demisto.params().get('api_version')
    PARAMS_TICKET_TYPE = demisto.params().get('ticket_type', 'incident')
    SYSPARM_QUERY = demisto.params().get('sysparm_query')

    if VERSION:
        API += VERSION + '/'

    SERVER_URL = get_server_url() + API

    DEFAULTS = {
        'limit':10,
        'fetch_limit':10
    }

    SNOW_ARGS = ["active", "activity_due", "short_description", "additional_assignee_list", "approval_history", "approval_set", "assigned_to", "assignment_group",
         "business_duration", "business_service", "business_stc", "calendar_duration", "calendar_stc", "caller_id", "caused_by", "close_code", "close_notes",
         "closed_at", "closed_by", "cmdb_ci", "comments", "comments_and_work_notes", "company", "contact_type", "correlation_display", "correlation_id",
         "delivery_plan", "delivery_task", "description", "due_date", "expected_start", "follow_up", "group_list", "hold_reason", "impact", "incident_state",
         "knowledge", "location", "made_sla", "notify", "order", "parent", "parent_incident", "priority", "problem_id", "resolved_at", "resolved_by", "rfc",
         "severity", "sla_due", "state", "subcategory", "sys_tags", "time_worked", "urgency", "user_input", "watch_list", "work_end", "work_notes", "work_notes_list",
         "work_start", "impact", "incident_state", "title", "type", "category", "state"]

    ''' HELPER FUNCTIONS '''

    def send_request(path, method='get', body=None, params=None, headers=None, file=None):
        body = body if body is not None else {}
        params = params if params is not None else {}

        url = '{}{}'.format(SERVER_URL, path)
        if not headers:
            headers = {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
            }
        if file:
            # Not supported in v2
            url = url.replace('v2', 'v1')
            try:
                file_entry = file['id']
                file_name = file['name']
                shutil.copy(demisto.getFilePath(file_entry)['path'], file_name)
                with open(file_name, 'rb') as f:
                    files = {'file': f}
                    res = requests.request(method, url, headers=headers, params=params, data=body,files=files, auth=(USERNAME, PASSWORD),
                    verify=VERIFY_SSL)
                shutil.rmtree(demisto.getFilePath(file_entry)['name'], ignore_errors=True)
            except Exception as e:
                raise Exception('Failed to upload file - ' + e.message)
        else:
            res = requests.request(method, url, headers=headers, data=json.dumps(body), params=params, auth=(USERNAME, PASSWORD),
            verify=VERIFY_SSL)


        try:
            obj = res.json()
        except Exception as e:
            raise Exception('Error parsing reply - {} - {}'.format(res.content, e.message))

        if 'error' in obj:
            raise Exception('ServiceNow Error: {}, details: {}'.format(obj['error']['message'], obj['error']['detail']))

        if res.status_code < 200 or res.status_code >= 300:
            raise Exception('Got status code {} with url {} with body {} with headers {}'.format(str(res.status_code), url, str(res.content), str(res.headers)))

        return obj

    def get_table_name(ticket_type=None):
        if ticket_type:
            return ticket_type
        else:
            if PARAMS_TICKET_TYPE:
                return PARAMS_TICKET_TYPE
            else:
                return 'incident'

    def create_ticket_context(data):
        context =  {
            'ID': data["sys_id"],
        }

        if 'opened_by' in data:
            context['Creator'] = data["opened_by"]['value'] if 'value' in data['opened_by'] else ''
        if 'assigned_to' in data:
            context['Assignee'] = data["assigned_to"]['value'] if 'value' in data['assigned_to'] else ''

        context['State'] = data.get('state')
        context['Summary'] = data.get('short_description')
        context['Number'] = data.get('number')

        return context

    def get_ticket_context(data):
        if not isinstance(data, list):
            return create_ticket_context(data)

        tickets = []
        for d in data:
            tickets.append(create_ticket_context(d))
        return tickets

    def get_ticket_human_readable(tickets):
        if not isinstance(tickets, list):
            tickets = [tickets]

        result = []
        for ticket in tickets:
            hr = {
                'Number': ticket['number'],
                'System ID': ticket['sys_id'],
                'State': ticket['state'],
                'Impact': ticket.get('impact'),
                'Priority': ticket.get('priority'),
                'Severity': ticket.get('severity'),
                'Urgency': ticket.get('urgency'),
                'Created On': ticket.get('sys_created_on'),
                'Created By': ticket.get('sys_created_by'),
                'Active': ticket.get('active'),
                'Close notes': ticket.get('close_notes'),
                'Description': ticket.get('description'),
                'Opened at': ticket.get('opened_at'),
                'Due date': ticket.get('due_date'),
                'Resolved by': ticket.get('closed_by'),
                'Resolved at': ticket.get('resolved_at'),
                'SLA due': ticket.get('sla_due'),
                'Short description': ticket.get('short_description')
            }
            result.append(hr)

        return result

    def get_body(template_name, custom_fields):
        body = {}
        template = template_name

        if template:
            template = get_template(template_name)

        for arg in SNOW_ARGS:
            input_arg = demisto.args().get(arg)
            if input_arg:
                body[arg] = input_arg
            elif template_name and arg in template:
                body[arg] = template[arg]

        if custom_fields:
            for field in custom_fields:
                body['u_' + field] = custom_fields[field]

        return body


    def split_custom_fields(fields):
        dic_fields = {}
        arr_fields = fields.split(';')

        for f in arr_fields:
            field = f.split('=')
            if len(field) > 1:
                dic_fields[field[0]] = field[1]

        return dic_fields

    def get_snow_time(minutes_offset):
        now = datetime.datetime.now()
        ts = time.time()
        utc_offset_minutes = (datetime.datetime.utcfromtimestamp(ts) - datetime.datetime.fromtimestamp(ts)).total_seconds() / 60
        snow_time = now + datetime.timedelta(minutes = utc_offset_minutes)

        if minutes_offset:
            snow_time = snow_time + datetime.timedelta(minutes = minutes_offset)

        return snow_time.strftime('%Y-%m-%d %H:%M:%S')

    ''' FUNCTIONS '''
    def get_template(name):
        query_params={}
        query_params['sysparm_limit'] = 1
        query_params['sysparm_query'] = 'name='+name

        ticket_type = 'sys_template'
        path = 'table/' + ticket_type
        res = send_request('GET',path,params=query_params)

        if len(res['result']) == 0:
            raise ValueError("Incorrect template name")

        template = res['result'][0]['template'].split('^')
        dic_template = {}

        for i in range(len(template) - 1):
            template_value = template[i].split('=')
            if (len(template_value) > 1):
                dic_template[template_value[0]] = template_value[1]

        return dic_template

    def get_ticket_command():
        ticket_type = get_table_name(demisto.args().get('ticket_type'))
        ticket_id = demisto.args().get('id')
        number = demisto.args().get('number')
        get_attachments = demisto.args().get('get_attachments', 'false')

        res = get_ticket(ticket_id, number, ticket_type)
        if not res or 'result' not in res:
            return 'Cannot find ticket'

        if isinstance(res['result'], list):
            if len(res['result']) == 0:
                return 'Cannot find ticket'
            ticket = res['result'][0]
        else:
            ticket = res['result']

        entries = []

        if get_attachments.lower() != 'false':
            entries = get_ticket_attachment_entries(ticket['sys_id'])

        hr = get_ticket_human_readable(ticket)

        entry = {
            'Type': entryTypes['note'],
            'Contents': res,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ServiceNow ticket', hr, removeNull=True),
            'EntryContext': {
                  'Ticket(val.ID==obj.ID)': get_ticket_context(ticket)
            }
        }

        entries.append(entry)

        return entries


    def get_ticket(ticket_id, number, ticket_type):
        path = None
        query_params = {}
        if ticket_id:
            path = 'table/' + ticket_type + '/' + ticket_id
        elif number:
            path = 'table/' + ticket_type
            query_params = {
                'number': number
            }
        else:
            raise ValueError('servicenow-get requires either ticket ID (sys_id) or ticket number')

        return send_request(path, 'get', params = query_params)


    def get_ticket_attachments(ticket_id):
        path = 'attachment'
        query_params = {
            'sysparm_query': 'table_sys_id=' + ticket_id
        }

        return send_request(path, 'get', params = query_params)


    def get_ticket_attachment_entries(ticket_id):
        entries = []
        links = []
        attachments_res = get_ticket_attachments(ticket_id)
        if 'result' in attachments_res and len(attachments_res['result']) > 0:
            attachments = attachments_res['result']
            links = [(attachment['download_link'], attachment['file_name']) for attachment in attachments]

        for link in links:
            file_res = requests.get(link[0], auth=(USERNAME, PASSWORD), verify=VERIFY_SSL)
            if file_res is not None:
                entries.append(fileResult(link[1], file_res.content))

        return entries

    def update_command():
        custom_fields = demisto.args().get('custom_fields')
        template = demisto.args().get('template')
        ticket_type = get_table_name(demisto.args().get('ticket_type'))

        res = update(ticket_type, custom_fields, template)

        hr = get_ticket_human_readable(res['result'])

        entry = {
            'Type': entryTypes['note'],
            'Contents': res,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ServiceNow ticket updated\nTicket type: ' + ticket_type, hr, removeNull=True)
        }

        return entry


    def update(ticket_type, custom_fields, template):
        if custom_fields:
            custom_fields = split_custom_fields(custom_fields)

        body = get_body(template, custom_fields)
        path = 'table/' + ticket_type + '/' + demisto.args()['id']

        return send_request(path, 'patch', body = body)

    def create_command():
        custom_fields = demisto.args().get('custom_fields')
        template = demisto.args().get('template')
        ticket_type = get_table_name(demisto.args().get('ticket_type'))

        res = create(ticket_type, custom_fields, template)

        hr = get_ticket_human_readable(res['result'])

        entry = {
            'Type': entryTypes['note'],
            'Contents': res,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ServiceNow ticket created\nTicket type: ' + ticket_type, hr, removeNull=True),
            'EntryContext': {
                  'Ticket(val.ID==obj.ID)': get_ticket_context(res['result']),
            }
        }

        return entry

    def create(ticket_type, custom_fields, template):
        if custom_fields:
            custom_fields = split_custom_fields(custom_fields)

        body = get_body(demisto.args().get('template'), custom_fields)
        path = 'table/' + ticket_type

        return send_request(path, 'post', body = body)

    def add_link_command():
        ticket_id = demisto.args()['id']
        key = 'comments' if demisto.args().get('post-as-comment', 'false').lower() == 'true' else 'work_notes'
        text = demisto.args().get('text', demisto.args()['link'])
        link = '[code]<a class="web" target="_blank" href="' + demisto.args()['link'] + '" >'+text+'</a>[/code]'
        ticket_type = get_table_name(demisto.args().get('ticket_type'))

        res = add_link(ticket_id, ticket_type, key, link)

        hr = get_ticket_human_readable(res['result'])
        entry = {
            'Type': entryTypes['note'],
            'Contents': res,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Link added to ServiceNow ticket', hr, removeNull=True)
        }

        return entry


    def add_link(ticket_id, ticket_type, key, link):
        body = {}
        body[key] = link
        path = 'table/' + ticket_type + '/' + ticket_id

        return send_request(path, 'patch', body=body)

    def add_comment_command():
        ticket_id = demisto.args()['id']
        key = 'comments' if demisto.args().get('post-as-comment', 'false').lower() == 'true' else 'work_notes'
        text = demisto.args()['comment']
        ticket_type = get_table_name(demisto.args().get('ticket_type'))

        res = add_comment(ticket_id, ticket_type, key, text)

        hr = get_ticket_human_readable(res['result'])
        entry = {
            'Type': entryTypes['note'],
            'Contents': res,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Comment added to ServiceNow ticket', hr, removeNull=True)
        }

        return entry

    def add_comment(ticket_id, ticket_type, key, text):
        body = {}
        body[key] = text
        path = 'table/' + ticket_type + '/' + ticket_id

        return send_request(path, 'patch', body=body)

    def query_command():
        sysparm_limit = demisto.args().get('limit', DEFAULTS['limit'])
        sysparm_query = demisto.args().get('query')
        if not sysparm_query:
            #backward compatibility
            sysparm_query = demisto.args().get('sysparm_query')
        ticket_type = get_table_name(demisto.args().get('ticket_type'))

        res = query(ticket_type, sysparm_limit, sysparm_query)

        if not res or 'result' not in res:
            return 'Cannot find ticket'

        hr = get_ticket_human_readable(res['result'])

        entry = {
            'Type': entryTypes['note'],
            'Contents': res,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ServiceNow ticket', hr, removeNull=True),
            'EntryContext': {
                  'Ticket(val.ID==obj.ID)': get_ticket_context(res['result'])
            }
        }

        return entry


    def query(ticket_type, sysparm_limit, sysparm_query):
        query_params = {}
        query_params['sysparm_limit'] = sysparm_limit
        if sysparm_query:
            query_params['sysparm_query'] = sysparm_query

        path = 'table/' + ticket_type

        return send_request(path, 'get', params = query_params)


    def upload_file_command():
        ticket_type = get_table_name(demisto.args().get('ticket_type'))
        ticket_id = demisto.args()['id']
        file_id = demisto.args()['file_id']
        file_name = demisto.args().get('file_name',
                                    demisto.dt(demisto.context(), "File(val.EntryID=='"+file_id+"').Name"))
        file_name = file_name[0] if isinstance(file_name, list) else file_name

        res = upload_file(ticket_id, file_id, file_name, ticket_type)

        hr = {
            'Filename': res['result']['file_name'],
            'Download link': res['result']['download_link'],
            'System ID': res['result']['sys_id']
        }

        context = {
            'ID': ticket_id,
            'File': {}
        }
        context['File']['Filename'] = res['result']['file_name']
        context['File']['Link'] = res['result']['download_link']
        context['File']['SystemID'] = res['result']['sys_id']

        entry = {
            'Type': entryTypes['note'],
            'Contents': res,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('File Uploaded', hr),
            'EntryContext': {
                'Ticket(val.ID==obj.ID)' : context
            }
        }

        return entry


    def upload_file(ticket_id, file_id, file_name, ticket_type):
        headers = {
            'Accept': 'application/json'
        }

        body = {
            'table_name': ticket_type,
            'table_sys_id': ticket_id,
            'file_name': file_name
        }

        path = 'attachment/upload'

        return send_request(path, 'post', headers = headers, body = body, file = {'id': file_id, 'name': file_name})


    def get_computer_command():
        ticket_type = 'cmdb_ci_computer'
        computer_name = demisto.args()['computerName']

        res = get_computer(ticket_type, computer_name)

        if not res or 'result' not in res:
            return 'Cannot find computer'
        elif isinstance(res['result'], list):
            if len(res['result']) == 0:
                return 'Cannot find computer'
            computer = res['result'][0]
        else:
            computer = res['result']

        if computer['u_code'] != computer_name:
            return 'Computer not found'

        hr = {
            'ID': computer['sys_id'],
            'u_code (computer name)': computer['u_code'],
            'Support group': computer['support_group'],
            'Operating System': computer['os'],
            'Comments': computer['comments']
        }

        ec = createContext(computer, removeNull=True)
        if 'support_group' in computer:
            ec['support_group'] = computer['support_group']['value'] if 'value' in computer['support_group'] else ''

        entry = {
            'Type': entryTypes['note'],
            'Contents': computer,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ServiceNow Computer', hr),
            'EntryContext': {
                  'ServiceNowComputer(val.sys_id==obj.sys_id)': ec,
            }
        }

        return entry


    def get_computer(ticket_type, computer_name):
        path = 'table/' + ticket_type

        query_params = {
            'sysparm_query': 'u_code=' + computer_name
        }

        return send_request(path, 'get', params=query_params)

    def get_groups_command():
        ticket_type = 'sys_user_group'
        group_name = demisto.args()['name']
        res = get_groups(ticket_type, group_name)

        if not res or 'result' not in res:
            return 'Cannot find groups'

        hr_groups = []
        context_groups = []

        for group in res['result']:
            if group['name'] == group_name:
                hr_groups.append({
                    'ID': group['sys_id'],
                    'Name': group['name'],
                    'Description': group['description'],
                    'Email': group['email'],
                    'Active': group['active'],
                    'Manager': ['manager']
                })
                context_groups.append({
                    'GroupId': group['sys_id'],
                    'GroupName': group['name']
                })

        entry = {
            'Type': entryTypes['note'],
            'Contents': res,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ServiceNow Group', hr_groups),
            'EntryContext': {
                  'ServiceNowGroups(val.GroupId==obj.GroupId)': context_groups,
            }
        }

        return entry

    def get_groups(ticket_type, group_name):
        path = 'table/' + ticket_type

        query_params = {
            'sysparm_query': 'name=' + group_name
        }

        return send_request(path, 'get', params=query_params)

    def fetch_incidents():
        query_params = {}
        incidents = []
        sysparm_query = demisto.params().get('query')
        sysparm_query = demisto.params().get('sysparm_query')
        sysparm_limit = demisto.params().get('fetch_limit', DEFAULTS['fetch_limit'])
        ticket_type = demisto.params()['ticket_type']
        get_attachments = demisto.params().get('get_attachments', False)

        last_run = demisto.getLastRun()
        if 'time' not in last_run:
            snow_time = get_snow_time(-10)
        else:
            snow_time = last_run['time']

        query_params['sysparm_query'] = 'ORDERBYopened_at^opened_at>' + snow_time
        query_params['sysparm_limit'] = sysparm_limit
        if sysparm_query:
            query_params['sysparm_query'] += '^' + sysparm_query

        path = 'table/' + ticket_type

        res = send_request(path, 'get', params = query_params)

        for result in res['result']:
            labels = []

            for k,v in result.iteritems():
                if isinstance(v, basestring):
                    labels.append({
                        'type': k,
                        'value': v
                    })
                else:
                    labels.append({
                        'type': k,
                        'value': json.dumps(v)
                    })

            severity = int(result['severity']) if 'severity' in result else 0

            file_names = []
            if get_attachments:
                file_entries = get_ticket_attachment_entries(result['sys_id'])
                for file_result in file_entries:
                    if file_result['Type'] == entryTypes['error']:
                        return_error(file_result['Contents'])
                    file_names.append({
                        'path': file_result['FileID'],
                        'name': file_result['File']
                    })

            incidents.append({
                'name': 'ServiceNow Incident ' + result['number'],
                'labels': labels,
                'details': json.dumps(result),
                'severity': severity,
                'attachment': file_names,
                'rawJSON': json.dumps(result)
            })

            snow_time = result['opened_at']

        demisto.incidents(incidents)
        demisto.setLastRun({'time': snow_time})

    try:
        if demisto.command() == 'test-module':
            path = "table/incident?sysparm_limit=1"
            res = send_request(path, 'GET')
            if 'result' not in res:
                return_error('ServiceNow error: ' + str(res))
            demisto.results('ok')
        elif demisto.command() == 'fetch-incidents':
            fetch_incidents()
        elif demisto.command() == 'servicenow-get' or demisto.command() == 'servicenow-incident-update':
            demisto.results(get_ticket_command())
        elif demisto.command() == 'servicenow-update' or demisto.command() == 'servicenow-incident-update':
            demisto.results(update_command())
        elif demisto.command() == 'servicenow-create' or demisto.command() == 'servicenow-incident-create':
            demisto.results(create_command())
        elif demisto.command() == 'servicenow-add-link' or demisto.command() == 'servicenow-incident-add-link':
            demisto.results(add_link_command())
        elif demisto.command() == 'servicenow-add-comment' or demisto.command() == 'servicenow-incident-add-comment':
            demisto.results(add_comment_command())
        elif demisto.command() == 'servicenow-query' or demisto.command() == 'servicenow-incidents-query':
            demisto.results(query_command())
        elif demisto.command() == 'servicenow-upload-file' or demisto.command() == 'servicenow-incident-upload-file':
            demisto.results(upload_file_command())
        elif demisto.command() == 'servicenow-get-computer':
            demisto.results(get_computer_command())
        elif demisto.command() == 'servicenow-get-groups':
            demisto.results(get_groups_command())
    except Exception as e:
        LOG(e)
        LOG.print_log()
        return_error(e.message)
  type: python
  commands:
  - name: servicenow-get
    arguments:
    - name: id
      default: true
      description: Ticket System ID to retrieve
    - name: ticket_type
      auto: PREDEFINED
      predefined:
      - incident
      - problem
      - change_request
      - sc_request
      - sc_task
      description: Ticket type
      defaultValue: incident
    - name: number
      description: Ticket number to retrieve
    - name: get_attachments
      description: Whether to retrieve ticket attachments, default false
    outputs:
    - contextPath: Ticket.ID
      description: ServiceNow ticket System ID
      type: string
    - contextPath: Ticket.Creator
      description: ServiceNow ticket creator
      type: string
    - contextPath: Ticket.Assignee
      description: ServiceNow ticket assignee
      type: string
    - contextPath: Ticket.State
      description: ServiceNow ticket state
      type: string
    - contextPath: Ticket.Summary
      description: ServiceNow ticket short summary
      type: string
    - contextPath: Ticket.Number
      description: ServiceNow ticket number
      type: string
    - contextPath: File.Info
      description: Attachment file info
    - contextPath: File.Name
      description: Attachment file name
    - contextPath: File.Size
      description: Attachment file size
    - contextPath: File.SHA1
      description: Attachment file SHA1
    - contextPath: File.SHA256
      description: Attachment file SHA256
    - contextPath: File.EntryID
      description: Attachment file entry ID
    - contextPath: File.Type
      description: Attachment file type
    - contextPath: File.MD5
      description: Attachment file MD5
    description: Retrieve ticket information by specific ticket ID
  - name: servicenow-incident-get
    deprecated: true
    arguments:
    - name: id
      default: true
      description: Ticket System ID to retrieve
    - name: ticket_type
      auto: PREDEFINED
      predefined:
      - incident
      - problem
      - change_request
      description: Ticket type
      defaultValue: incident
    - name: number
      description: Ticket number to retrieve
    outputs:
    - contextPath: Ticket.ID
      description: ServiceNow ticket System ID
      type: string
    - contextPath: Ticket.Creator
      description: ServiceNow ticket creator
      type: string
    - contextPath: Ticket.Assignee
      description: ServiceNow ticket assignee
      type: string
    - contextPath: Ticket.State
      description: ServiceNow ticket state
      type: string
    - contextPath: Ticket.Summary
      description: ServiceNow ticket short summary
      type: string
    - contextPath: Ticket.Number
      description: ServiceNow ticket number
      type: string
    description: Retrieve ticket information by specific ticket ID
  - name: servicenow-create
    arguments:
    - name: short_description
      description: Short description of the ticket
    - name: ticket_type
      auto: PREDEFINED
      predefined:
      - incident
      - problem
      - change_request
      - sc_request
      - sc_task
      description: Ticket type
      defaultValue: incident
    - name: urgency
      description: Ticket urgency
    - name: severity
      description: Ticket severity
    - name: impact
      description: Ticket impact
    - name: active
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Set ticket as Active
    - name: activity_due
      description: Set ticket ActivityDue - format "2016-07-02 21:51:11" glide_date_time
    - name: additional_assignee_list
      description: List of assigned users to the ticket
    - name: approval_history
      description: Ticket history approval
    - name: approval_set
      description: Set ticket ApprovalSet - format "2016-07-02 21:51:11" glide_date_time
    - name: assigned_to
      description: To whom the ticket is assigned
    - name: business_duration
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: business_service
      description: Business service
    - name: business_stc
      description: Business source
    - name: calendar_duration
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: caller_id
      description: UID Format
    - name: category
      description: Category of ticket
    - name: caused_by
      description: UID Format
    - name: close_code
      description: Ticket's close code
    - name: close_notes
      description: Close notes of the ticket
    - name: closed_at
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: closed_by
      description: User who closed the ticket
    - name: cmdb_ci
      description: UID Format
    - name: comments
      description: Format type journal input
    - name: comments_and_work_notes
      description: Format type journal input
    - name: company
      description: UID Format
    - name: contact_type
      description: Contact type
    - name: correlation_display
      description: Correlation display
    - name: correlation_id
      description: Correlation id
    - name: delivery_plan
      description: UID Format
    - name: display
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: If you want to display comments, work_notes...
    - name: description
      description: Ticket description
    - name: due_date
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: escalation
      description: Escalation
    - name: expected_start
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: follow_up
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: group_list
      description: UID format list
    - name: knowledge
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Is the ticket solved in the knowledge base
    - name: location
      description: Location of the ticket
    - name: made_sla
      description: SLA of the ticket
    - name: notify
      auto: PREDEFINED
      predefined:
      - "1"
      - "0"
      description: Notify about this ticket
    - name: order
      description: Order number
    - name: parent
      description: UID Format
    - name: parent_incident
      description: UID Format
    - name: problem_id
      description: UID Format
    - name: reassignment_count
      description: How many users included in this ticket before
    - name: reopen_count
      description: How many time the ticket has been reopened
    - name: resolved_at
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: resolved_by
      description: UID Format
    - name: rfc
      description: UID
    - name: sla_due
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: subcategory
      description: Subcategory
    - name: sys_updated_by
      description: Last updated by
    - name: sys_updated_on
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: user_input
      description: Input from the end user
    - name: watch_list
      description: A list of watched tickets
    - name: work_end
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: work_notes
      description: Format journal list
    - name: work_notes_list
      description: List with UIDs
    - name: work_start
      description: Date when started to work on the ticket
    - name: assignment_group
      description: Set AssignmentGroup - uuid of group like 46b87022a9fe198101a78787e40d7547
    - name: incident_state
      description: integer
    - name: number
      description: Ticket number
    - name: priority
      description: Priority of the ticket (number)
    - name: template
      description: Template name to use as a base to create new tickets.
    - name: custom_fields
      description: 'Custom fields in this format: fieldname=value;fieldname=value...'
    - name: type
      auto: PREDEFINED
      predefined:
      - normal
      - standard
      - emergency
      description: Type of Change Request ticket
      defaultValue: normal
    - name: state
      description: State of the ticket (an integer)
    outputs:
    - contextPath: Ticket.ID
      description: ServiceNow ticket System ID
      type: string
    - contextPath: Ticket.Creator
      description: ServiceNow ticket creator
      type: string
    - contextPath: Ticket.Assignee
      description: ServiceNow ticket assignee
      type: string
    - contextPath: Ticket.State
      description: ServiceNow ticket state
      type: string
    - contextPath: Ticket.Summary
      description: ServiceNow ticket short summary
      type: string
    - contextPath: Ticket.Number
      description: ServiceNow ticket number
      type: string
    description: Create new ServiceNow ticket
  - name: servicenow-incident-create
    deprecated: true
    arguments:
    - name: short_description
      description: Short description of the ticket
    - name: ticket_type
      auto: PREDEFINED
      predefined:
      - incident
      - problem
      - change_request
      description: Ticket type
      defaultValue: incident
    - name: urgency
      description: Ticket urgency
    - name: severity
      description: Ticket severity
    - name: impact
      description: Ticket impact
    - name: active
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Set ticket as Active
    - name: activity_due
      description: Set ticket ActivityDue - format "2016-07-02 21:51:11" glide_date_time
    - name: additional_assignee_list
      description: List of assigned users to the ticket
    - name: approval_history
      description: Ticket history approval
    - name: approval_set
      description: Set ticket ApprovalSet - format "2016-07-02 21:51:11" glide_date_time
    - name: assigned_to
      description: To whom the ticket is assigned
    - name: business_duration
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: business_service
      description: Business service
    - name: business_stc
      description: Business source
    - name: calendar_duration
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: caller_id
      description: UID Format
    - name: category
      description: Category name
    - name: caused_by
      description: UID Format
    - name: close_code
      description: Ticket's close code
    - name: close_notes
      description: Close notes of the ticket
    - name: closed_at
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: closed_by
      description: User who closed the ticket
    - name: cmdb_ci
      description: UID Format
    - name: comments
      description: Format type journal input
    - name: comments_and_work_notes
      description: Format type journal input
    - name: company
      description: UID Format
    - name: contact_type
      description: Contact type
    - name: correlation_display
      description: Correlation display
    - name: correlation_id
      description: Correlation id
    - name: delivery_plan
      description: UID Format
    - name: display
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: If you want to display comments, work_notes...
    - name: description
      description: Ticket description
    - name: due_date
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: escalation
      description: Escalation
    - name: expected_start
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: follow_up
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: group_list
      description: UID format list
    - name: knowledge
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Is the ticket solved in the knowledge base
    - name: location
      description: Location of the ticket
    - name: made_sla
      description: SLA of the ticket
    - name: notify
      auto: PREDEFINED
      predefined:
      - "1"
      - "0"
      description: Notify about this ticket
    - name: order
      description: Order number
    - name: parent
      description: UID Format
    - name: parent_incident
      description: UID Format
    - name: problem_id
      description: UID Format
    - name: reassignment_count
      description: How many users included in this ticket before
    - name: reopen_count
      description: How many time the ticket has been reopened
    - name: resolved_at
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: resolved_by
      description: UID Format
    - name: rfc
      description: UID
    - name: sla_due
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: subcategory
      description: Subcategory
    - name: sys_updated_by
      description: Last updated by
    - name: sys_updated_on
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: user_input
      description: Input from the end user
    - name: watch_list
      description: A list of watched tickets
    - name: work_end
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: work_notes
      description: Format journal list
    - name: work_notes_list
      description: List with UIDs
    - name: work_start
      description: Date when started to work on the ticket
    - name: assignment_group
      description: Set AssignmentGroup - uuid of group like 46b87022a9fe198101a78787e40d7547
    - name: incident_state
      description: integer
    - name: number
      description: Ticket number
    - name: priority
      description: Priority of the ticket (number)
    - name: template
      description: Template name to use as a base to create new tickets.
    outputs:
    - contextPath: Ticket.ID
      description: ServiceNow ticket System ID
      type: string
    - contextPath: Ticket.Creator
      description: ServiceNow ticket creator
      type: string
    - contextPath: Ticket.Assignee
      description: ServiceNow ticket assignee
      type: string
    - contextPath: Ticket.State
      description: ServiceNow ticket state
      type: string
    - contextPath: Ticket.Summary
      description: ServiceNow ticket short summary
      type: string
    - contextPath: Ticket.Number
      description: ServiceNow ticket number
      type: string
    description: Create new ServiceNow ticket
  - name: servicenow-update
    arguments:
    - name: short_description
      description: Short description of the ticket
    - name: ticket_type
      auto: PREDEFINED
      predefined:
      - incident
      - problem
      - change_request
      - sc_request
      - sc_task
      description: Ticket type
      defaultValue: incident
    - name: urgency
      description: Ticket urgency
    - name: severity
      description: Ticket severity
    - name: impact
      description: Ticket impact
    - name: active
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Does the ticket active(true/false)
    - name: activity_due
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: additional_assignee_list
      description: List of assigned users to the ticket
    - name: approval_history
      description: Ticket history approval
    - name: approval_set
      description: Set ticket ApprovalSet - format "2016-07-02 21:51:11" glide_date_time
    - name: assigned_to
      description: To whom the ticket is assigned
    - name: business_duration
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: business_service
      description: Business service
    - name: business_stc
      description: Business source
    - name: calendar_duration
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: caller_id
      description: UID Format
    - name: category
      description: Category name
    - name: caused_by
      description: UID Format
    - name: close_code
      description: Ticket's close code
    - name: close_notes
      description: Close notes of the ticket
    - name: closed_at
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: closed_by
      description: User who closed the ticket
    - name: cmdb_ci
      description: UID Format
    - name: comments
      description: Format type journal input
    - name: comments_and_work_notes
      description: Format type journal input
    - name: company
      description: UID Format
    - name: contact_type
      description: Contact type
    - name: correlation_display
      description: Correlation display
    - name: correlation_id
      description: Correlation id
    - name: delivery_plan
      description: UID Format
    - name: display
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: If you want to display comments, work_notes...
    - name: description
      description: Ticket description
    - name: due_date
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: escalation
      description: Escalation
    - name: expected_start
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: follow_up
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: group_list
      description: UID format list
    - name: knowledge
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Is the ticket solved in the knowledge base
    - name: location
      description: Location of the ticket
    - name: made_sla
      description: SLA of the ticket
    - name: notify
      auto: PREDEFINED
      predefined:
      - "1"
      - "0"
      description: Notify about this ticket
    - name: order
      description: Order number
    - name: parent
      description: UID Format
    - name: parent_incident
      description: UID Format
    - name: problem_id
      description: UID Format
    - name: reassignment_count
      description: How many users included in this ticket before
    - name: reopen_count
      description: How many time the ticket has been reopened
    - name: resolved_at
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: resolved_by
      description: UID Format
    - name: rfc
      description: UID
    - name: sla_due
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: subcategory
      description: Subcategory
    - name: sys_updated_by
      description: Last updated by
    - name: sys_updated_on
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: user_input
      description: Input from the end user
    - name: watch_list
      description: A list of watched tickets
    - name: work_end
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: work_notes
      description: Format journal list
    - name: work_notes_list
      description: List with UIDs
    - name: work_start
      description: Date when started to work on the ticket
    - name: assignment_group
      description: UID
    - name: incident_state
      description: integer
    - name: number
      description: Ticket number
    - name: priority
      description: Priority of the ticket (number)
    - name: id
      required: true
      description: System ID of the ticket to update
    - name: custom_fields
      description: 'Custom fields in this format: fieldname=value;fieldname=value...'
    - name: type
      auto: PREDEFINED
      predefined:
      - normal
      - standard
      - emergency
      description: Type of Change Request ticket
      defaultValue: normal
    - name: state
      description: State of the ticket (an integer)
    description: Update specific ticket by providing ticket id
  - name: servicenow-incident-update
    deprecated: true
    arguments:
    - name: short_description
      description: Short description of the ticket
    - name: ticket_type
      auto: PREDEFINED
      predefined:
      - incident
      - problem
      - change_request
      description: Ticket type
      defaultValue: incident
    - name: urgency
      description: Ticket urgency
    - name: severity
      description: Ticket severity
    - name: impact
      description: Ticket impact
    - name: active
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Does the ticket active(true/false)
    - name: activity_due
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: additional_assignee_list
      description: List of assigned users to the ticket
    - name: approval_history
      description: Ticket history approval
    - name: approval_set
      description: Set ticket ApprovalSet - format "2016-07-02 21:51:11" glide_date_time
    - name: assigned_to
      description: To whom the ticket is assigned
    - name: business_duration
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: business_service
      description: Business service
    - name: business_stc
      description: Business source
    - name: calendar_duration
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: caller_id
      description: UID Format
    - name: category
      description: Category name
    - name: caused_by
      description: UID Format
    - name: close_code
      description: Ticket's close code
    - name: close_notes
      description: Close notes of the ticket
    - name: closed_at
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: closed_by
      description: User who closed the ticket
    - name: cmdb_ci
      description: UID Format
    - name: comments
      description: Format type journal input
    - name: comments_and_work_notes
      description: Format type journal input
    - name: company
      description: UID Format
    - name: contact_type
      description: Contact type
    - name: correlation_display
      description: Correlation display
    - name: correlation_id
      description: Correlation id
    - name: delivery_plan
      description: UID Format
    - name: display
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: If you want to display comments, work_notes...
    - name: description
      description: Ticket description
    - name: due_date
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: escalation
      description: Escalation
    - name: expected_start
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: follow_up
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: group_list
      description: UID format list
    - name: knowledge
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Is the ticket solved in the knowledge base
    - name: location
      description: Location of the ticket
    - name: made_sla
      description: SLA of the ticket
    - name: notify
      auto: PREDEFINED
      predefined:
      - "1"
      - "0"
      description: Notify about this ticket
    - name: order
      description: Order number
    - name: parent
      description: UID Format
    - name: parent_incident
      description: UID Format
    - name: problem_id
      description: UID Format
    - name: reassignment_count
      description: How many users included in this ticket before
    - name: reopen_count
      description: How many time the ticket has been reopened
    - name: resolved_at
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: resolved_by
      description: UID Format
    - name: rfc
      description: UID
    - name: sla_due
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: subcategory
      description: Subcategory
    - name: sys_updated_by
      description: Last updated by
    - name: sys_updated_on
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: user_input
      description: Input from the end user
    - name: watch_list
      description: A list of watched tickets
    - name: work_end
      description: 'Format: YYYY-MM-DD HH:MM:SS'
    - name: work_notes
      description: Format journal list
    - name: work_notes_list
      description: List with UIDs
    - name: work_start
      description: Date when started to work on the ticket
    - name: assignment_group
      description: UID
    - name: incident_state
      description: integer
    - name: number
      description: Ticket number
    - name: priority
      description: Priority of the ticket (number)
    - name: id
      required: true
      description: System ID of the ticket to update
    description: Update specific ticket by providing ticket id
  - name: servicenow-add-link
    arguments:
    - name: id
      required: true
      description: Ticket System ID
    - name: ticket_type
      auto: PREDEFINED
      predefined:
      - incident
      - problem
      - change_request
      - sc_request
      - sc_task
      description: Ticket type
      defaultValue: incident
    - name: link
      required: true
      description: The actual link to publish in ServiceNow ticket, valid url format,
        like http://www.demisto.com
    - name: post-as-comment
      description: Publish the link as comment on the ticket, if false will publish
        the link as WorkNote, format bool
    - name: text
      description: The text to represent the link
    description: Add link to specific ticket by providing ticket id
  - name: servicenow-incident-add-link
    deprecated: true
    arguments:
    - name: id
      required: true
      description: Ticket System ID
    - name: ticket_type
      auto: PREDEFINED
      predefined:
      - incident
      - problem
      - change_request
      description: Ticket type
      defaultValue: incident
    - name: link
      required: true
      description: The actual link to publish in ServiceNow ticket, valid url format,
        like http://www.demisto.com
    - name: post-as-comment
      description: Publish the link as comment on the ticket, by default true, if
        false will publish the link as WorkNote, format bool
    - name: text
      description: The text to represent the link
    description: Add link to specific ticket by providing ticket id
  - name: servicenow-add-comment
    arguments:
    - name: id
      required: true
      description: Ticket System ID
    - name: ticket_type
      auto: PREDEFINED
      predefined:
      - incident
      - problem
      - change_request
      - sc_request
      - sc_task
      description: Ticket type
      defaultValue: incident
    - name: comment
      required: true
      description: Comment to add
    - name: post-as-comment
      description: Publish the link as comment on the ticket, if false will publish
        the link as WorkNote, format bool
    description: Add comment to specific ticket by providing ticket id
  - name: servicenow-incident-add-comment
    deprecated: true
    arguments:
    - name: id
      required: true
      description: Ticket System ID
    - name: ticket_type
      auto: PREDEFINED
      predefined:
      - incident
      - problem
      - change_request
      description: Ticket type
      defaultValue: incident
    - name: comment
      required: true
      description: Comment to add
    - name: post-as-comment
      description: Publish the link as comment on the ticket, if false will publish
        the link as WorkNote, format bool
    description: Add comment to specific ticket by providing ticket id
  - name: servicenow-query
    arguments:
    - name: limit
      description: Limit for how many tickets to retrieve
      defaultValue: "10"
    - name: sysparm_query
      deprecated: true
      description: Query
    - name: ticket_type
      auto: PREDEFINED
      predefined:
      - incident
      - problem
      - change_request
      - sc_request
      - sc_task
      description: Ticket type
      defaultValue: incident
    - name: query
      description: The query to run. To learn about querying in ServiceNow, see https://docs.servicenow.com/bundle/istanbul-servicenow-platform/page/use/common-ui-elements/reference/r_OpAvailableFiltersQueries.html
    outputs:
    - contextPath: Ticket.ID
      description: ServiceNow ticket System ID
      type: string
    - contextPath: Ticket.Creator
      description: ServiceNow ticket creator
      type: string
    - contextPath: Ticket.Assignee
      description: ServiceNow ticket assignee
      type: string
    - contextPath: Ticket.State
      description: ServiceNow ticket state
      type: string
    - contextPath: Ticket.Summary
      description: ServiceNow ticket short summary
      type: string
    - contextPath: Ticket.Number
      description: ServiceNow ticket number
      type: string
    description: Retrieve ticket info with query
  - name: servicenow-incidents-query
    deprecated: true
    arguments:
    - name: limit
      description: Limit for how many tickets to retrieve
      defaultValue: "10"
    - name: sysparm_query
      description: Query
    - name: ticket_type
      auto: PREDEFINED
      predefined:
      - incident
      - problem
      - change_request
      description: Ticket type
      defaultValue: incident
    outputs:
    - contextPath: Ticket.ID
      description: ServiceNow ticket System ID
      type: string
    - contextPath: Ticket.Creator
      description: ServiceNow ticket creator
      type: string
    - contextPath: Ticket.Assignee
      description: ServiceNow ticket assignee
      type: string
    - contextPath: Ticket.State
      description: ServiceNow ticket state
      type: string
    - contextPath: Ticket.Summary
      description: ServiceNow ticket short summary
      type: string
    - contextPath: Ticket.Number
      description: ServiceNow ticket number
      type: string
    description: Retrieve ticket info with query
  - name: servicenow-upload-file
    arguments:
    - name: id
      required: true
      description: Ticket System ID
    - name: ticket_type
      auto: PREDEFINED
      predefined:
      - incident
      - problem
      - change_request
      - sc_request
      - sc_task
      description: Ticket type
      defaultValue: incident
    - name: file_id
      required: true
      description: War-room entry ID that includes the file
    - name: file_name
      description: Filename of uploaded file to override the existing file name in
        entry
    outputs:
    - contextPath: Ticket.File.Filename
      description: Name of the file
      type: string
    - contextPath: Ticket.File.Link
      description: Download link for the file
      type: string
    - contextPath: Ticket.File.SystemID
      description: System ID of the file
      type: string
    description: Upload new file
  - name: servicenow-incident-upload-file
    deprecated: true
    arguments:
    - name: id
      required: true
      description: Ticket System ID
    - name: ticket_type
      auto: PREDEFINED
      predefined:
      - incident
      - problem
      - change_request
      description: Ticket type
      defaultValue: incident
    - name: file_id
      required: true
      description: War-room entry ID that includes the file
    - name: file_name
      description: Filename of uploaded file to override the existing file name in
        entry
    outputs:
    - contextPath: Ticket.File.Filename
      description: Name of the file
      type: string
    - contextPath: Ticket.File.Link
      description: Download link for the file
      type: string
    - contextPath: Ticket.File.SystemID
      description: System ID of the file
      type: string
    description: Upload new file
  - name: servicenow-get-groups
    arguments:
    - name: name
      required: true
      description: Servicenow group name
    outputs:
    - contextPath: ServiceNowGroups.GroupId
      description: Group Id
      type: string
    - contextPath: ServiceNowGroups.GroupName
      description: Group name
      type: string
    description: Return information about specific servicenow group
  - name: servicenow-get-computer
    arguments:
    - name: computerName
      required: true
      description: machine name
    outputs:
    - contextPath: ServiceNowComputer.sys_id
      description: 'Id '
      type: string
    - contextPath: ServiceNowComputer.u_code
      description: Code
      type: string
    - contextPath: ServiceNowComputer.support_group
      description: Support group
      type: string
    - contextPath: ServiceNowComputer.os
      description: Operating System
      type: string
    - contextPath: ServiceNowComputer.comments
      description: Comments
      type: string
    description: query the cmdb_ci_computer table with a computer code
  isfetch: true
tests:
    - Run all tests
