commonfields:
  id: TruSTAR
  version: -1
name: TruSTAR
display: TruSTAR
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: TruSTAR's threat intelligence platform enriches every stage of the security
  operations workflow from the trusted and relevant data sources.
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: https://api.trustar.co
  type: 0
  required: true
- display: TruSTAR API Key
  name: key
  defaultvalue: ""
  type: 0
  required: true
- display: TruSTAR API Secret
  name: secret
  defaultvalue: ""
  type: 4
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: "true"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "false"
  type: 8
  required: false
script:
  script: |+
    ''' IMPORTS '''
    import requests
    import time
    import datetime
    import json
    import trustar
    import os
    import collections
    from trustar.models.indicator import Indicator
    from trustar.models.page import Page

    if not demisto.params()['proxy']:
        del os.environ['HTTP_PROXY']
        del os.environ['HTTPS_PROXY']
        del os.environ['http_proxy']
        del os.environ['https_proxy']

    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    ''' GLOBAL VARS '''
    SERVER=demisto.params()['server']
    API_KEY=str(demisto.params()['key'])
    API_SECRET=str(demisto.params()['secret'])
    BASE_URL=SERVER + '/api/1.3'
    INSECURE=demisto.params()['insecure']

    ''' HELPER FUNCTIONS '''
    def translate_indicators(ts_indicators):
        indicators = []
        file_context = []
        url_context = []
        ip_context = []
        email_context = []
        key_context = []
        cve_context = []
        for indicator in ts_indicators:
            current_indicator = indicator.to_dict(remove_nones=True)
            indicator_type = current_indicator['indicatorType']
            priority_level = current_indicator.get('priorityLevel')
            value = current_indicator['value']
            if indicator_type == 'SOFTWARE':
                # Extracts the filename out of file path
                if "\\" in r"%r" % value:
                    file_name = value.split('\\')[-1] # Handles file path with backslash
                else:
                    file_name = value.split('/')[-1] # Handles file path with slash
                current_indicator['value'] = file_name
                context_dict = {'Name': file_name}
                if priority_level:
                    context_dict.update({'priorityLevel': priority_level})
                file_context.append(context_dict)
            elif indicator_type in {'SHA256', 'SHA1', 'MD5'}:
                context_dict = {indicator_type: value}
                if priority_level:
                    context_dict.update({'priorityLevel': priority_level})
                file_context.append(context_dict)
            elif indicator_type == 'URL':
                context_dict = {'Address': value}
                if priority_level:
                    context_dict.update({'priorityLevel': priority_level})
                url_context.append(context_dict)
            elif indicator_type == 'IP':
                context_dict = {'Address': value}
                if priority_level:
                    context_dict.update({'priorityLevel': priority_level})
                ip_context.append(context_dict)
            elif indicator_type == 'EMAIL_ADDRESS':
                context_dict = {'Address': value}
                if priority_level:
                    context_dict.update({'priorityLevel': priority_level})
                email_context.append(context_dict)
            elif indicator_type == 'REGISTRY_KEY':
                context_dict = {'Path': value}
                if priority_level:
                    context_dict.update({'priorityLevel': priority_level})
                key_context.append(context_dict)
            elif indicator_type == 'CVE':
                context_dict = {'ID': value}
                if priority_level:
                    context_dict.update({'priorityLevel': priority_level})
                cve_context.append(context_dict)
            indicators.append(current_indicator)
        # Build Entry Context
        ec = {}
        if file_context:
            ec['File(val.Name && val.Name === obj.Name)'] = file_context
        if url_context:
            ec['URL(val.Address && val.Address === obj.Address)'] = url_context
        if ip_context:
            ec['IP(val.Address && val.Address === obj.Address)'] = ip_context
        if email_context:
            ec['Account'] = {}
            ec['Account']['Email(val.Address && val.Address === obj.Address)'] = email_context
        if key_context:
            ec['RegistryKey(val.Path && val.Path === obj.Path)'] = key_context
        if cve_context:
            ec['CVE(val.ID && val.ID === obj.ID)'] = cve_context
        return indicators, ec

    def normalize_time(timestamp):
        '''
        Converts unix epoch time to GMT
        '''
        if isinstance(timestamp, str):
            return timestamp
        return time.strftime('%Y-%m-%d %H:%M:%S', time.gmtime(timestamp/1000.0))

    def date_to_unix(timestamp):
        d = datetime.datetime.strptime(timestamp, "%Y-%m-%d %H:%M:%S")
        return int(d.strftime("%s")) * 1000


    ''' FUNCTIONS '''
    def get_related_indicators(indicators, enclave_ids, page_size, page_number):
        # To display priority score
        items_list = []
        indicators_json = dict()
        related_indicator_response = ts.get_related_indicators_page(indicators, enclave_ids, page_size, page_number)
        for related_indicator in related_indicator_response:
            current_indicator = related_indicator.to_dict(remove_nones=True)
            search_indicator_response = ts.search_indicators_page(current_indicator['value'], enclave_ids, page_size,
                                                                  page_number)
            for found_indicator in search_indicator_response:
                current_found_indicator = found_indicator.to_dict(remove_nones=True)
                if current_indicator['value'] == current_found_indicator['value']:
                    current_indicator['priorityLevel'] = current_found_indicator['priorityLevel']
                    break
            if not current_indicator.get('priorityLevel'):
                current_indicator['priorityLevel'] = "NOT_FOUND"
            items_list.append(current_indicator)
        indicators_json.update({'items': items_list})
        response = Page.from_dict(indicators_json, content_type=Indicator)
        related_indicators, ec = translate_indicators(response)
        if related_indicators:
            title = 'TruSTAR indicators related to ' + indicators
            entry = {
                'Type': entryTypes['note'],
                'Contents': related_indicators,
                'ContentsFormat': formats['json'],
                'ReadableContentsFormat': formats['markdown'],
                'HumanReadable': tableToMarkdown(title, related_indicators),
                'EntryContext': ec
            }
        else:
            entry = 'No indicators related to ' + indicators + ' were found.'
        return entry

    def get_trending_indicators(indicator_type, days_back):
        if indicator_type == 'other':
            indicator_type = None
        response = ts.get_community_trends(indicator_type, days_back)
        trending_indicators, ec = translate_indicators(response)
        if trending_indicators:
            title = 'TruSTAR Community Trending Indicators'
            entry = {
                'Type': entryTypes['note'],
                'Contents': trending_indicators,
                'ContentsFormat': formats['json'],
                'ReadableContentsFormat': formats['markdown'],
                'HumanReadable': tableToMarkdown(title, trending_indicators),
                'EntryContext': ec
            }
        else:
            entry = 'No trending indicators were found.'
        return entry

    def search_indicators(search_term, enclave_ids, page_size, page_number):
        response = ts.search_indicators_page(search_term, enclave_ids, page_size, page_number)
        indicators, ec = translate_indicators(response)
        if indicators:
            title = 'TruSTAR indicators that contain the term ' + search_term
            entry = {
                'Type': entryTypes['note'],
                'Contents': indicators,
                'ContentsFormat': formats['json'],
                'ReadableContentsFormat': formats['markdown'],
                'HumanReadable': tableToMarkdown(title, indicators),
                'EntryContext': ec
            }
        else:
            entry = 'No indicators were found.'
        return entry

    def submit_report(title, report_body, enclave_ids, external_url, time_began, distribution_type):
        if distribution_type == 'ENCLAVE' and enclave_ids is None:
            return 'Distribution type is ENCLAVE, but no enclave ID was given.'
        ts_report = trustar.models.Report(
            title=title,
            body=report_body,
            enclave_ids=[enclave_ids] if enclave_ids else enclave_ids,
            is_enclave=True if distribution_type == 'ENCLAVE' else False,
            time_began=time_began,
            external_url=external_url
        )
        response = ts.submit_report(ts_report)
        deep_link = '{server_url}/constellation/reports/{report_id}'.format(server_url=SERVER, report_id=response.id)
        report = collections.OrderedDict()
        report['id'] = response.id
        report['reportTitle'] = title
        report['reportDeepLink'] = '[{}]({})'.format(deep_link, deep_link)
        report['reportBody'] = report_body
        ec = {
            'TruSTAR.Report(val.id && val.id === obj.id)': report
        }
        title = 'TruSTAR report was successfully created'
        entry = {
            'Type': entryTypes['note'],
            'Contents': report,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown(title, report),
            'EntryContext': ec
        }
        return entry

    def update_report(report_id, title, report_body, enclave_ids, external_url, time_began, distribution_type):
        ts_report = trustar.models.Report(
            id=report_id,
            title=title,
            body=report_body,
            enclave_ids=[enclave_ids] if enclave_ids else enclave_ids,
            is_enclave=True if distribution_type == 'ENCLAVE' else False,
            time_began=time_began,
            external_url=external_url
        )
        response = ts.update_report(ts_report)
        deep_link = '{server_url}/constellation/reports/{report_id}'.format(server_url=SERVER, report_id=report_id)
        report = collections.OrderedDict()
        report['id'] = report_id
        report['reportTitle'] = title
        report['reportDeepLink'] = '[{}]({})'.format(deep_link, deep_link)
        report['reportBody'] = report_body
        ec = {
            'TruSTAR.Report(val.id && val.id === obj.id)': report
        }
        title = 'TruSTAR report was successfully updated'
        entry = {
            'Type': entryTypes['note'],
            'Contents': report,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown(title, report),
            'EntryContext': ec
        }
        return entry

    def get_report_details(report_id, id_type):
        response = ts.get_report_details(report_id, id_type)
        current_report_dict = response.to_dict(remove_nones=True)
        report_details = collections.OrderedDict()
        report_details['id'] = current_report_dict['id']
        report_details['title'] = current_report_dict['title']
        deep_link = '{server_url}/constellation/reports/{report_id}'.format(server_url=SERVER,
                                                                            report_id=current_report_dict['id'])
        report_details['reportDeepLink'] = '[{}]({})'.format(deep_link, deep_link)
        if current_report_dict['enclaveIds']:
            report_details['enclaveIds'] = ', '.join(current_report_dict['enclaveIds'])  # Prettify list of enclave IDs
        report_details['updated'] = normalize_time(current_report_dict['updated'])
        report_details['created'] = normalize_time(current_report_dict['created'])
        report_details['timeBegan'] = normalize_time(current_report_dict['timeBegan'])
        report_details['distributionType'] = current_report_dict['distributionType']
        if current_report_dict.get('externalUrl'):
            report_details['externalUrl'] = current_report_dict['externalUrl']
        report_details['reportBody'] = current_report_dict['reportBody']
        report_context = {
            'reportTitle': report_details['title'],
            'reportBody': report_details['reportBody'],
            'id': report_details['id']
        }
        ec = {
            'TruSTAR.Report(val.id && val.id === obj.id)': report_context
        }
        title = 'TruSTAR report ID ' + report_id + ' details'
        entry = {
            'Type': entryTypes['note'],
            'Contents': report_details,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown(title, report_details),
            'EntryContext': ec
        }
        return entry

    def delete_report(report_id, id_type):
        ts.delete_report(report_id, id_type)
        return 'Report ' + report_id + ' was successfully deleted'

    def get_reports(from_time, to_time, enclave_ids, distribution_type, tags, excluded_tags):
        is_encalve = True if distribution_type == 'ENCLAVE' else False
        from_time = date_to_unix(from_time) if from_time else from_time
        to_time = date_to_unix(to_time) if to_time else to_time
        response = ts.get_reports(is_encalve, enclave_ids, tags, excluded_tags, from_time, to_time)
        reports = []
        reports_context = []
        for report in response:
            current_report_dict = report.to_dict(remove_nones=True)
            current_report = collections.OrderedDict()
            current_report['id'] = current_report_dict['id']
            current_report['title'] = current_report_dict['title']
            deep_link = '{server_url}/constellation/reports/{report_id}'.format(server_url=SERVER, report_id=current_report_dict['id'])
            current_report['reportDeepLink'] = '[{}]({})'.format(deep_link, deep_link)
            if current_report_dict['enclaveIds']:
                current_report['enclaveIds'] = ', '.join(current_report_dict['enclaveIds'])  # Prettify list of enclave IDs
            current_report['updated'] = normalize_time(current_report_dict['updated'])
            current_report['created'] = normalize_time(current_report_dict['created'])
            current_report['timeBegan'] = normalize_time(current_report_dict['timeBegan'])
            current_report['distributionType'] = current_report_dict['distributionType']
            if current_report_dict.get('externalUrl'):
                current_report['externalUrl'] = current_report_dict['externalUrl']
            current_report['reportBody'] = current_report_dict['reportBody']
            reports.append(current_report)
            reports_context.append({
                'reportTitle': current_report['title'],
                'reportBody': current_report['reportBody'],
                'id': current_report['id']
            })
        if reports:
            ec = {
                'TruSTAR.Report(val.id && val.id === obj.id)': reports_context
            }
            title = 'TruSTAR reports'
            entry = {
                'Type': entryTypes['note'],
                'Contents': reports,
                'ContentsFormat': formats['json'],
                'ReadableContentsFormat': formats['markdown'],
                'HumanReadable': tableToMarkdown(title, reports),
                'EntryContext': ec
            }
        else:
            entry = 'No reports were found.'
        return entry

    def get_correlated_reports(indicators, enclave_ids, distribution_type, page_size, page_number):
        response = ts.get_correlated_reports_page(indicators, enclave_ids, page_number, page_size)
        correlated_reports = []
        for report in response:
            current_report = report.to_dict(remove_nones=True)
            current_report['updated'] = normalize_time(current_report['updated'])
            current_report['created'] = normalize_time(current_report['created'])
            current_report['timeBegan'] = normalize_time(current_report['timeBegan'])
            return current_report
            correlated_reports.append(current_report)
        if correlated_reports:
            title = 'TruSTAR correlated reports'
            entry = {
                'Type': entryTypes['note'],
                'Contents': correlated_reports,
                'ContentsFormat': formats['json'],
                'ReadableContentsFormat': formats['markdown'],
                'HumanReadable': tableToMarkdown(title, correlated_reports)
            }
        else:
            entry = 'No reports were found.'
        return entry

    def search_reports(search_term, enclave_ids):
        response = ts.search_reports(search_term, enclave_ids)
        reports = []
        report_context = []
        for report in response:
            current_report = report.to_dict(remove_nones=True)
            current_report['updated'] = normalize_time(current_report['updated'])
            current_report['created'] = normalize_time(current_report['created'])
            current_report['timeBegan'] = normalize_time(current_report['timeBegan'])
            reports.append(current_report)
            report_context.append({
                'reportTitle': current_report['title'],
                'id': current_report['id']
            })
            if 'reportBody' in current_report:
                report_context['reportBody'] =  current_report['reportBody']

        ec = {
            'TruSTAR.Report(val.id && val.id === obj.id)': report_context
        }

        title = 'TruSTAR reports that contain the term ' + search_term
        entry = {
            'Type': entryTypes['note'],
            'Contents': reports,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown(title, reports),
            'EntryContext': ec
        }
        return entry

    def add_to_whitelist(indicators):
        response = ts.add_terms_to_whitelist([indicators])
        if response:
            return 'Added to the whitelist successfully'
        else:
            return 'Indicator could not be added to the whitelist.'

    def remove_from_whitelist(indicator, indicator_type):
        ts_indicator = trustar.models.Indicator(
            value=indicator,
            type=indicator_type
        )
        response = ts.delete_indicator_from_whitelist(ts_indicator)
        if response:
            return 'Removed from the whitelist successfully'
        else:
            return 'Indicator could not be removed from the whitelist.'

    def get_enclaves():
        response = ts.get_user_enclaves()
        enclave_ids = []
        for enclave in response:
            enclave_ids.append(enclave.to_dict(remove_nones=True))
        title = 'TruSTAR Enclaves'
        entry = {
            'Type': entryTypes['note'],
            'Contents': enclave_ids,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown(title, enclave_ids),
        }
        return entry


    ''' EXECUTION CODE '''
    config = {
        'user_api_key': API_KEY,
        'user_api_secret': API_SECRET,
        'api_endpoint': BASE_URL,
        'verify': INSECURE
    }
    ts=trustar.TruStar(config=config)

    LOG('command is %s' % (demisto.command(), ))

    try:
        if demisto.command() == 'test-module':
            demisto.results('ok')

        elif demisto.command() == 'trustar-related-indicators':
            enclave_ids = demisto.args().get('enclave-ids', None)
            demisto.results(get_related_indicators(demisto.args()['indicators'], enclave_ids, demisto.args()['page-size'], demisto.args()['page-number']))

        elif demisto.command() == 'trustar-trending-indicators':
            demisto.results(get_trending_indicators(demisto.args()['type'], demisto.args()['days-back']))

        elif demisto.command() == 'trustar-search-indicators':
            enclave_ids = demisto.args().get('enclave-ids', None)
            demisto.results(search_indicators(demisto.args()['search-term'], enclave_ids, demisto.args()['page-size'], demisto.args()['page-number']))

        elif demisto.command() == 'trustar-submit-report':
            enclave_ids = demisto.args().get('enclave-ids', None)
            external_url = demisto.args().get('external-url', None)
            time_began = demisto.args().get('time-began', None)
            demisto.results(submit_report(demisto.args()['title'], demisto.args()['report-body'], enclave_ids, external_url, time_began, demisto.args()['distribution-type']))

        elif demisto.command() == 'trustar-update-report':
            enclave_ids = demisto.args().get('enclave-ids', None)
            external_url = demisto.args().get('external-url', None)
            time_began = demisto.args().get('time-began', None)
            demisto.results(update_report(demisto.args()['report-id'], demisto.args()['title'], demisto.args()['report-body'], enclave_ids, external_url, time_began, demisto.args()['distribution-type']))

        elif demisto.command() == 'trustar-report-details':
            demisto.results(get_report_details(demisto.args()['report-id'], demisto.args()['id-type']))

        elif demisto.command() == 'trustar-delete-report':
            demisto.results(delete_report(demisto.args()['report-id'], demisto.args()['id-type']))

        elif demisto.command() == 'trustar-get-reports':
            from_time = demisto.args().get('from', None)
            to_time = demisto.args().get('to', None)
            enclave_ids = demisto.args().get('enclave-ids', None)
            tags = demisto.args().get('tags', None)
            excluded_tags = demisto.args().get('excluded-tags', None)
            demisto.results(get_reports(from_time, to_time, enclave_ids, demisto.args()['distribution-type'], tags, excluded_tags))

        elif demisto.command() == 'trustar-correlated-reports':
            enclave_ids = demisto.args().get('enclave-ids', None)
            demisto.results(get_correlated_reports(demisto.args()['indicators'], enclave_ids, demisto.args()['distribution-type'], demisto.args()['page-size'], demisto.args()['page-number']))

        elif demisto.command() == 'trustar-search-reports':
            enclave_ids = demisto.args().get('enclave-ids', None)
            demisto.results(search_reports(demisto.args()['search-term'], enclave_ids))

        elif demisto.command() == 'trustar-add-to-whitelist':
            demisto.results(add_to_whitelist(demisto.args()['indicators']))

        elif demisto.command() == 'trustar-remove-from-whitelist':
            demisto.results(remove_from_whitelist(demisto.args()['indicator'], demisto.args()['indicator-type']))

        elif demisto.command() == 'trustar-get-enclaves':
            demisto.results(get_enclaves())

    except Exception, e:
        LOG(e.message)
        LOG.print_log()
        raise

  type: python
  commands:
  - name: trustar-related-indicators
    arguments:
    - name: indicators
      required: true
      default: true
      description: Indicator value of any type; i.e. an IP address, email address,
        URL, MD5, SHA1, SHA256, Registry Key, Malware name, etc.
    - name: enclave-ids
      description: Comma-separated list of enclave ids; only indicators found in reports
        from these enclaves will be returned (defaults to all of user’s enclaves).
        Defaults is all enclaves the user has READ access to.
    - name: page-number
      description: Which page of the result set to get
      defaultValue: "0"
    - name: page-size
      description: The number of results per page.
      defaultValue: "25"
    outputs:
    - contextPath: File.Name
      description: File name
      type: string
    - contextPath: File.MD5
      description: File MD5
      type: string
    - contextPath: File.SHA1
      description: File SHA1
      type: string
    - contextPath: File.SHA256
      description: File SHA256
      type: string
    - contextPath: File.priorityLevel
      description: File priority level
      type: string
    - contextPath: URL.Address
      description: URL address
      type: string
    - contextPath: URL.priorityLevel
      description: URL priority level
      type: string
    - contextPath: IP.Address
      description: IP address
      type: string
    - contextPath: IP.priorityLevel
      description: IP priority level
      type: string
    - contextPath: Account.Email.Address
      description: Email address
      type: string
    - contextPath: Account.Email.priorityLevel
      description: Email priority level
      type: string
    - contextPath: RegistryKey.Path
      description: Registry key path
      type: string
    - contextPath: RegistryKey.priorityLevel
      description: Registry key priority level
      type: string
    - contextPath: CVE.ID
      description: CVE ID
      type: string
    - contextPath: CVE.priorityLevel
      description: CVE priority level
      type: string
    description: Search all TruSTAR incident reports for provided indicators and return
      all correlated indicators from search results. Two indicators are considered
      “correlated” if they can be found in a common report.
  - name: trustar-trending-indicators
    arguments:
    - name: type
      auto: PREDEFINED
      predefined:
      - CVE
      - MALWARE
      - other
      description: The types of indicators to be returned. If other, then all indicator
        types except for CVE and MALWARE will be returned.
      defaultValue: other
    - name: days-back
      description: The number of days back to count correlations for.
      defaultValue: "3"
    outputs:
    - contextPath: File.Name
      description: File name
      type: string
    - contextPath: File.MD5
      description: File MD5
      type: string
    - contextPath: File.SHA1
      description: File SHA1
      type: string
    - contextPath: File.SHA256
      description: File SHA256
      type: string
    - contextPath: URL.Address
      description: URL address
      type: string
    - contextPath: IP.Address
      description: IP address
      type: string
    - contextPath: Account.Email.Address
      description: Email address
      type: string
    - contextPath: RegistryKey.Path
      description: Registry key path
      type: string
    - contextPath: CVE.ID
      description: CVE ID
      type: string
    description: Returns the 10 indicators that have recently appeared in the most
      community reports. This is analogous to the Community Trends section of the
      dashboard on Station.
  - name: trustar-search-indicators
    arguments:
    - name: search-term
      required: true
      default: true
      description: The term to search for
    - name: enclave-ids
      description: Comma-separated list of enclave ids; only indicators found in reports
        from these enclaves will be returned (defaults to all of user’s enclaves).
        Defaults is all enclaves the user has READ access to.
    - name: page-number
      description: Which page of the result set to get
      defaultValue: "0"
    - name: page-size
      description: The number of results per page.
      defaultValue: "25"
    outputs:
    - contextPath: File.Name
      description: File name
      type: string
    - contextPath: File.MD5
      description: File MD5
      type: string
    - contextPath: File.SHA1
      description: File SHA1
      type: string
    - contextPath: File.SHA256
      description: File SHA256
      type: string
    - contextPath: URL.Address
      description: URL address
      type: string
    - contextPath: IP.Address
      description: IP address
      type: string
    - contextPath: Account.Email.Address
      description: Email address
      type: string
    - contextPath: RegistryKey.Path
      description: Registry key path
      type: string
    - contextPath: CVE.ID
      description: CVE ID
      type: string
    description: Searches for all indicators that contain the given search term.
  - name: trustar-submit-report
    arguments:
    - name: title
      required: true
      description: Title of the report
    - name: report-body
      required: true
      description: Text content of report
    - name: enclave-ids
      description: CSV of TruSTAR-generated enclave ids. Use the enclave ID, NOT the
        enclave name. Mandatory if the distribution type is ENCLAVE.
    - name: distribution-type
      auto: PREDEFINED
      predefined:
      - COMMUNITY
      - ENCLAVE
      description: Distribution type of the report
      defaultValue: ENCLAVE
    - name: external-url
      description: URL for the external report that this originated from, if one exists.
        Limit 500 alphanumeric characters. Must be unique across all reports for a
        given company.
    - name: time-began
      description: ISO-8601 formatted incident time with timezone, e.g. 2016-09-22T11:38:35+00:00.
        Default is current time.
    outputs:
    - contextPath: TruSTAR.Report.reportTitle
      description: Title of the report
      type: string
    - contextPath: TruSTAR.Report.reportBody
      description: Body of the report
      type: string
    - contextPath: TruSTAR.Report.id
      description: ID of the report
      type: string
    description: Submit a new incident report, and receive the ID it has been assigned
      in TruSTAR’s system.
  - name: trustar-update-report
    arguments:
    - name: report-id
      required: true
      description: TruSTAR report id or external tracking id.
    - name: title
      required: true
      description: Title of the report
    - name: report-body
      required: true
      description: Text content of report
    - name: enclave-ids
      description: CSV of TruSTAR-generated enclave ids. Use the enclave ID, NOT the
        enclave name. Mandatory if the distribution type is ENCLAVE.
    - name: external-url
      description: URL for the external report that this originated from, if one exists.
        Limit 500 alphanumeric characters. Must be unique across all reports for a
        given company.
    - name: distribution-type
      auto: PREDEFINED
      predefined:
      - COMMUNITY
      - ENCLAVE
      description: Distribution type of the report
      defaultValue: ENCLAVE
    - name: time-began
      description: ISO-8601 formatted incident time with timezone, e.g. 2016-09-22T11:38:35+00:00.
        Default is current time.
    outputs:
    - contextPath: TruSTAR.Report.reportTitle
      description: Title of the report
      type: string
    - contextPath: TruSTAR.Report.reportBody
      description: Body of the report
      type: string
    - contextPath: TruSTAR.Report.id
      description: ID of the report
      type: string
    description: Update the report with the specified ID. Either the internal TruSTAR
      report ID or an external tracking ID can be used. Only the fields passed will
      be updated. All others will be left unchanged.
  - name: trustar-report-details
    arguments:
    - name: report-id
      required: true
      description: Finds a report by its internal or external id.
    - name: id-type
      auto: PREDEFINED
      predefined:
      - internal
      - external
      description: Type of report ID
      defaultValue: internal
    outputs:
    - contextPath: TruSTAR.Report.reportTitle
      description: Title of the report
      type: string
    - contextPath: TruSTAR.Report.reportBody
      description: Body of the report
      type: string
    - contextPath: TruSTAR.Report.id
      description: ID of the report
      type: string
    description: Finds a report by its internal or external id.
  - name: trustar-delete-report
    arguments:
    - name: report-id
      required: true
      description: Finds a report by its internal or external id.
    - name: id-type
      auto: PREDEFINED
      predefined:
      - internal
      - external
      description: Type of report ID
      defaultValue: internal
    description: Deletes a report as specified by given id (id can be TruSTAR report
      id or external id).
  - name: trustar-get-reports
    arguments:
    - name: from
      description: Start of time window (format is YY-MM-DD HH:MM:SS, i.e. 2018-01-01
        10:30:00). Based on updated time, and not created time. Default is 1 day ago.
    - name: to
      description: End of time window (format is YY-MM-DD HH:MM:SS, i.e. 2018-01-01
        10:30:00). Based on updated time, and not created time. Default is current
        time.
    - name: distribution-type
      auto: PREDEFINED
      predefined:
      - ENCLAVE
      - COMMUNITY
      description: Whether to search for reports in the community, or only in enclaves
      defaultValue: ENCLAVE
    - name: enclave-ids
      description: Comma separated list of enclave ids to search for reports in. Even
        if distributionType is COMMUNITY, these enclaves will still be searched as
        well. Default is All enclaves the user has READ access to.
    - name: tags
      description: a list of names of tags to filter by; only reports containing ALL
        of these tags will be returned
    - name: excluded-tags
      description: reports containing ANY of these tags will be excluded from the
        results.
    outputs:
    - contextPath: TruSTAR.Report.reportTitle
      description: Title of the report
    - contextPath: TruSTAR.Report.reportBody
      description: Body of the report
    - contextPath: TruSTAR.Report.id
      description: ID of the report
    description: 'Returns incident reports matching the specified filters. All parameters
      are optional: if nothing is specified, the latest 25 reports accessible by the
      user will be returned (matching the view the user would have by logging into
      Station).'
  - name: trustar-correlated-reports
    arguments:
    - name: indicators
      required: true
      description: Indicator value of any type; i.e. an IP address, email address,
        URL, MD5, SHA1, SHA256, Registry Key, Malware name, etc.
    - name: enclave-ids
      description: Comma-separated list of enclave ids; only indicators found in reports
        from these enclaves will be returned (defaults to all of user’s enclaves).
        Defaults is all enclaves the user has READ access to.
    - name: page-number
      description: Which page of the result set to get
      defaultValue: "0"
    - name: page-size
      description: The number of results per page.
      defaultValue: "25"
    - name: distribution-type
      auto: PREDEFINED
      predefined:
      - COMMUNITY
      - ENCLAVE
      description: Distribution type of the report
      defaultValue: ENCLAVE
    description: Returns a paginated list of all reports that contain any of the provided
      indicator values.
  - name: trustar-search-reports
    arguments:
    - name: search-term
      required: true
      default: true
      description: The term to search for
    - name: enclave-ids
      description: Comma-separated list of enclave ids; only indicators found in reports
        from these enclaves will be returned (defaults to all of user’s enclaves)
    description: Searches for all reports that contain the given search term.
  - name: trustar-add-to-whitelist
    arguments:
    - name: indicators
      required: true
      default: true
      description: CSV of indicators to whitelist, i.e. evil.com,101.43.52.224
    description: Whitelist a list of indicator values for the user’s company.
  - name: trustar-remove-from-whitelist
    arguments:
    - name: indicator
      required: true
      description: The value of the indicator to delete.
    - name: indicator-type
      required: true
      auto: PREDEFINED
      predefined:
      - URL
      - IP
      - SHA256
      - SHA1
      - MD5
      - SOFTWARE
      - EMAIL_ADDRESS
      - BITCOIN_ADDRESS
      - CIDR_BLOCK
      - CVE
      - REGISTRY_KEY
      description: The type of the indicator to delete.
    description: Delete an indicator from the user’s company whitelist.
  - name: trustar-get-enclaves
    arguments: []
    description: Returns the list of all enclaves that the user has access to, as
      well as whether they can read, create, and update reports in that enclave.
  dockerimage: demisto/trustar
