commonfields:
  id: Demisto Lock
  version: -1
name: Demisto Lock
display: Demisto Lock
category: Utilities
image: data:image/png;base64,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
description: Locking mechanism that prevents concurrent execution of different tasks
detaileddescription: "The Demisto Locking integration allows prevention of concurrent
  execution of scripts or commands, using a wait-lock-release flow (mutex). \nUse
  the lock name argument to support multiple locks in different flows."
configuration:
- display: Default timeout (seconds) for wait on locks to be released
  name: timeout
  defaultvalue: "600"
  type: 0
  required: true
script:
  script: |
    function guid() {
      function s4() {
        return Math.floor((1 + Math.random()) * 0x10000)
          .toString(16)
          .substring(1);
      }
      return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
    }

    function setLock(guid, info) {
        var integrationContext = getIntegrationContext() || {};
        integrationContext[lockName] = {guid: guid, info: info};
        setIntegrationContext(integrationContext);
    }
    function getLock() {
        var integrationContext = getIntegrationContext() || {};
        if (!integrationContext[lockName]) {
            integrationContext[lockName] = {};
        }
        return integrationContext[lockName];
    }

    var lockName = args.name || 'Default';

    switch (command) {
        case 'test-module':
            return 'ok';

        case 'demisto-lock-get':
            var lockTimeout = args.timeout || params.timeout;
            var lockInfo = 'Locked by incident #' + incidents[0].id + '.';
            lockInfo += (args.info) ? ' Additional info: ' + args.info :'';

            var guid = guid();
            var time = 0;
            var lock = getLock();

            while (lock.guid !== guid && time++ < lockTimeout) {
                wait(1);
                lock = getLock();
                if (lock.guid === guid) {
                    continue;
                }
                if (!lock.guid) {
                    setLock(guid, lockInfo);
                }
            }

            if (lock.guid === guid) {
                var md = '### Demisto Locking Mechanism\n';
                md += 'Lock acquired successfully\n';
                md += 'GUID: ' + guid;
                return { ContentsFormat: formats.markdown, Type: entryTypes.note, Contents: md } ;
            } else {
                var md = 'Timeout waiting for lock\n';
                md += 'Lock name: ' + lockName + '\n';
                md += 'Lock info: ' + lock.info + '\n';
                return { ContentsFormat: formats.text, Type: entryTypes.error, Contents: md };
            }
            break;

        case 'demisto-lock-release':
            integrationContext = getIntegrationContext();
            integrationContext[lockName] = {};
            setIntegrationContext(integrationContext);

            var md = '### Demisto Locking Mechanism\n';
            md += 'Lock released successfully';
            return { ContentsFormat: formats.markdown, Type: entryTypes.note, Contents: md } ;

        case 'demisto-lock-release-all':
            setIntegrationContext({});

            var md = '### Demisto Locking Mechanism\n';
            md += 'All locks released successfully';
            return { ContentsFormat: formats.markdown, Type: entryTypes.note, Contents: md } ;

        case 'demisto-lock-info':
            integrationContext = getIntegrationContext();
            var obj = [];

            var res;
            var md = '### Demisto Locking Mechanism\n';
            var locks = (lockName === 'Default') ? Object.keys(integrationContext) : [lockName];

            locks.forEach(function(lock){
                md += 'Lock name: ' + lock + ' - ';
                if (integrationContext[lock] && integrationContext[lock].guid) {
                    md += 'Locked.\n';
                    md += '- GUID: ' + integrationContext[lock].guid + '\n';
                    md += '- Info: ' + integrationContext[lock].info + '\n\n';
                    obj.push({lock: lock, state: integrationContext[lock]});
                } else {
                    md += 'Not locked\n\n';
                }

            });
            return { ContentsFormat: formats.json, Type: entryTypes.note, Contents: obj, HumanReadable: md } ;

        default:
            var md = 'Unknown command ' + command;
            return { ContentsFormat: formats.text, Type: entryTypes.error, Contents: md };
    }
  type: javascript
  commands:
  - name: demisto-lock-get
    arguments:
    - name: name
      default: true
      description: Name of lock. When omitted, name is set to Default
    - name: info
      description: Additional information to provide for the lock instance
    - name: timeout
      description: Timeout (seconds) for wait on lock to be freed
      defaultValue: "600"
    description: Get a lock. If the lock is already in use - will wait until it is
      released or until timeout is reached
  - name: demisto-lock-release
    arguments:
    - name: name
      default: true
      description: Name of lock to release. When omitted, name is set to Default
    description: Release a lock
  - name: demisto-lock-info
    arguments:
    - name: name
      default: true
      description: Specific lock to show info for. If not specified, shows info for
        all locks
    description: Show information on locks
  - name: demisto-lock-release-all
    arguments: []
    description: Release all locks
  runonce: false
