commonfields:
  id: Mimecast
  version: -1
name: Mimecast
display: Mimecast
category: Authentication & Messaging
fromversion: 1.6.2
image: data:image/png;base64,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
description: Mimecast unified email management offers cloud email services for email
  security, continuity and archiving emails
configuration:
- display: 'BaseUrl - API url including region, For example https://eu-api.mimecast.com  '
  name: baseUrl
  defaultvalue: https://api.mimecast.com
  type: 0
  required: true
- display: AccessKey
  name: accessKey
  defaultvalue: ""
  type: 0
  required: true
- display: SecretKey
  name: secretKey
  defaultvalue: ""
  type: 4
  required: true
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: "true"
  type: 8
  required: false  
script:
  script: |-
    var insecure = params.insecure;

    var accessKey = params.accessKey;

    var secret = params.secretKey;

    var baseUrl = params.baseUrl;

    var searchURI = '/api/archive/search';



    var defaultQueryXml =
    "<?xml version=\"1.0\"?> \n\
        <xmlquery trace=\"iql,muse\">\n\
        <metadata query-type=\"emailarchive\" archive=\"true\" active=\"false\" page-size=\"25\" startrow=\"0\">\n\
            <smartfolders/>\n\
            <return-fields>\n\
                <return-field>attachmentcount</return-field>\n\
                <return-field>status</return-field>\n\
                <return-field>subject</return-field>\n\
                <return-field>size</return-field>\n\
                <return-field>receiveddate</return-field>\n\
                <return-field>displayfrom</return-field>\n\
                <return-field>id</return-field>\n\
                <return-field>displayto</return-field>\n\
                <return-field>smash</return-field>\n\
            </return-fields>\n\
        </metadata>\n\
        <muse>\n\
            <text></text>\n\
            <date select=\"last_year\"/>\n\
            <sent></sent>\n\
            <docs select=\"optional\"></docs>\n\
            <route/>\n\
        </muse>\n\
    </xmlquery>";

    var sendRequest = function(method, url, body) {
            var res = http(
                    url,
                    {
                        Method: method,
                        Body: body,
                        AuthProtocol: ['mimecast', '', '', secret, accessKey]
                    },
                    insecure
                );
            if (res.StatusCode < 200 || res.StatusCode >= 300) {
                throw 'Failed to use url ' + url + ', request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
            }
            return JSON.parse(res.Body);
    };

    var query = function(queryXML, isAdmin) {
            var body = {};
            var q = {};
            q.query = queryXML;
            q.admin = isAdmin;
            body.data = [q];
            bodyAsString = JSON.stringify(body);
            return sendRequest('POST', baseUrl + searchURI, bodyAsString);
    };

    var parseQueryArgs = function(args) {
            var queryXml = defaultQueryXml;
            if ((args.pageSize) && (args.pageSize > 0) ){
                queryXml = queryXml.replace('page-size=\"25\"','page-size=\"'+args.pageSize+'\"');
            }
            if ((args.startRow) && (args.startRow > 0) ){
                queryXml = queryXml.replace('startrow=\"0\"','startrow=\"'+args.startRow+'\"');
            }
            if ((args.active) && (args.active == 'true') ){
                queryXml = queryXml.replace('active=\"false\"','active=\"true\"');
            }
            if ((args.body) && (args.body.length > 0) ){
                queryXml = queryXml.replace('<text></text>','<text>(body: '+args.body+')</text>');
            }
            if ((args.subject) && (args.subject.length > 0) ){
                queryXml = queryXml.replace('<text></text>','<text>(subject: '+args.subject+')</text>');
            }
            if ((args.text) && (args.text.length > 0) ){
                queryXml = queryXml.replace('<text></text>','<text>'+args.text+'</text>');
            }

            if ((args.date) && (args.date.length > 0) ){
                queryXml = queryXml.replace('<date select=\"last_year\"/>','<date select=\"'+args.date+'\"/>');

                if (((args.dateTo) && (args.dateTo.length > 0) ) || ((args.dateFrom) && (args.dateFrom.length > 0) )){
                     throw 'Cannot use both date and dateFrom/dateTo arguments';
                }
            }
            var dateTo = "";
            var dateFrom = "";
            if ((args.dateTo) && (args.dateTo.length > 0) ){
                dateTo = args.dateTo;
            }
            if ((args.dateFrom) && (args.dateFrom.length > 0) ){
                dateFrom = args.dateFrom;
            }
            if ((dateFrom.length > 0) && (dateTo.length > 0)){
                queryXml = queryXml.replace('<date select=\"last_year\"/>','<date select=\"between\" from=\"'+dateFrom+'\" to=\"'+dateTo+'\" />');
            } else if (dateFrom.length > 0){
                queryXml = queryXml.replace('<date select=\"last_year\"/>','<date select=\"between\" from=\"'+dateFrom+'\" />');
            } else if (dateTo.length > 0){
                queryXml = queryXml.replace('<date select=\"last_year\"/>','<date select=\"between\" to=\"'+dateTo+'\" />');
            }

            if ((args.sentFrom) && (args.sentFrom.length > 0) ){
                queryXml = queryXml.replace('<sent></sent>','<sent select=\"from\" >'+args.sentFrom+'</sent>');
            }
            if ((args.sentTo) && (args.sentTo.length > 0) ){
                queryXml = queryXml.replace('<sent></sent>','<sent select=\"to\" >'+args.sentTo+'</sent>');
            }
            queryXml = queryXml.replace('<sent></sent>','');//no empty tag
            if ((args.attachmentText) && (args.attachmentText.length > 0) ){
                queryXml = queryXml.replace('</docs>',args.attachmentText+'</docs>');
            }
            if ((args.attachmentType) && (args.attachmentType.length > 0) ){
                queryXml = queryXml.replace('<docs select=\"optional\">','<docs select=\"'+args.attachmentType+'\">');
            }
            return queryXml;
    };

    switch (command) {
        case 'test-module':
            var testArgs = {};
            testArgs.pageSize = 1;
            testArgs.text = 'Demisto';
            var queryXml = parseQueryArgs(testArgs);
            query(queryXml, true);
            return 'ok';
        case 'query':
            var queryXml = '';
            if ((args.queryXml) && (args.queryXml.length > 0)) {
                queryXml = args.queryXml;
            } else {
                queryXml = parseQueryArgs(args);
            }
            if ((args.dryRun) && (args.dryRun == 'true')){
                return queryXml;
            }

            return query(queryXml, true);
        default:
    }
  type: javascript
  commands:
  - name: query
    arguments:
    - name: queryXml
      default: true
      description: The query string xml for the search using Mimecast Unified Search
        Experience (MUSE) - read more on https://community.mimecast.com/docs/DOC-2262,
        using this will override other query arguments
    - name: text
      auto: PREDEFINED
      predefined:
      - search for this text in api messages
    - name: dryRun
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Will no execute the query, but just return the query string builded
    - name: date
      auto: PREDEFINED
      predefined:
      - today
      - yesterday
      - last_week
      - last_month
      - last_year
      description: Search in specific dates only
    - name: dateFrom
      description: search emails from date, format 2015-09-21T23:00:00Z
    - name: dateTo
      description: search emails to date, format 2015-09-21T23:00:00Z
    - name: sentTo
      description: filter on messages to a specific address
    - name: sentFrom
      description: filter on messages from a specific address
    - name: subject
      description: search email by subject, will override the text argument
    - name: attachmentType
      auto: PREDEFINED
      predefined:
      - optional
      - any
      - documents
      - spreadsheets
      - presentations
      - text
      - images
      - media
      - zips
      - none
      description: optional - messages with and without attachments any - messages
        with any attachment documents - messages with doc, dot, docx, docm, dotx,
        dotm, pdf, rtf, html attachments spreadsheets - messages with xls, xlt, xlsx,
        xlsm, xltx, xltm, xlsb, xlam, csv attachments presentations - messages with
        ppt, pptx, pptm, potx, potm, ppam, ppsx, ppsm, sldx, sldm, thms, pps attachments
        text - messages with txt, text, html, log attachments images - messages with
        jpg, jpeg, png, bmp, gif, psd, tif, tiff attachments media - messages with
        mp3, mp4, m4a, mpg, mpeg, avi, wav, aac, wma, mov attachments zips - messages
        with zip, rar, cab, gz, gzip, 7z attachments none - No attachments are to
        be present in the results
    - name: attachmentText
      description: search for text in attachments
    - name: body
      description: search email by text in body, will override the text and subject
        arguments
    - name: pageSize
      description: Sets the number of results to return per page (default 25)
    - name: startRow
      description: Sets the result to start returning results (default 0)
    - name: active
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Defines if the search should query recently received messages that
        are not fully indexed yet (default false). You can search by mailbox and date
        time across active messages
    description: query mimecast emails
