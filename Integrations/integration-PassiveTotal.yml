commonfields:
  id: PassiveTotal
  version: -1
name: PassiveTotal
display: PassiveTotal
category: Data Enrichment & Threat Intelligence
system: true
image: data:image/png;base64,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
description: Analyze and understand threat infrastructure from a variety of sources–passive
  DNS, active DNS, WHOIS, SSL certificates and more–without devoting resources to
  time-intensive manual threat research and analysis
configuration:
- display: Server URL
  name: ServerURL
  defaultvalue: https://api.passivetotal.org/
  type: 0
  required: false
- display: Username/API Key
  name: Username
  defaultvalue: ""
  type: 0
  required: true
- display: API Secret
  name: APIKey
  defaultvalue: ""
  type: 4
  required: true
- display: Use system proxy
  name: proxy
  defaultvalue: "true"
  type: 8
  required: false
- display: Trust self-signed certificate (insecure)
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: Tags to signify this is a malicious domain
  name: tags
  defaultvalue: "malware,blacklist,phishing,typo-squatting"
  type: 0
  required: true
script:
  script: |-
    // Use pt-enrichment for IP, URL and domain enrichment
    if (command === 'url' || command === 'ip' || command === 'domain') {
        if (command === 'url') {
            // Need to extract the domain from the URL
            var u = args.url.toLowerCase();
            // Strip prefix
            u = u.replace('http://', '').replace('https://', '').replace('hxxp://', '').replace('hxxps://', '');
            // Strip path and everything after
            if (u.indexOf('/') > 0) {
                u = u.substring(0, u.indexOf('/'));
            }
            // Strip parameters and after just in case there is no path separator
            if (u.indexOf('?') > 0) {
                u = u.substring(0, u.indexOf('?'));
            }
            // Strip credentials
            if (u.indexOf('@') > 0) {
                u = u.substring(u.indexOf('@') + 1);
            }
            // Strip port
            if (u.indexOf(':') > 0) {
                u = u.substring(0, u.indexOf(':'));
            }
            args.query = u;
            delete args.url;
        } else if (command === 'domain') {
            args.query = args.domain;
            delete args.domain;
        } else {
            args.query = args.ip;
            delete args.ip;
        }
        command = 'pt-enrichment';
    }

    var serverUrl = params.ServerURL;
    if (serverUrl[serverUrl.length - 1] !== '/') {
        serverUrl += '/';
    }

    if (!params.hasOwnProperty('proxy')) {
        params.proxy = true;
    }

    // Handle upgrade scenarios where there is no default
    var tags = params.tags;
    if (tags === undefined) {
        tags = 'malware,blacklist,phishing,typo-squatting';
    }

    var doReq = function(method, path, parameters, body) {
        var result = http(
            serverUrl + path + encodeToURLQuery(parameters),
            {
                Headers: {'Content-Type': ['application/json']},
                Method: method,
                Username: params.Username,
                Password: params.APIKey,
                Body: body ? body : ''
            },
            params.insecure || false,
            params.proxy
        );
        if (result.StatusCode !== 200 && result.StatusCode !== 201) {
            throw 'Failed to perform request ' + path + ', request status code: ' + result.StatusCode + ', request body: ' + result.Body;
        }
        return result.Body;
    };

    var commandToPath = {
        'pt-get-subdomains': 'v2/enrichment/subdomains',
        'pt-account': 'v2/account',
        'pt-monitors': 'v2/account/monitors',
        'pt-passive-dns': 'v2/dns/passive',
        'pt-passive-unique': 'v2/dns/passive/unique',
        'pt-dns-keyword': 'v2/dns/search/keyword',
        'pt-enrichment': 'v2/enrichment',
        'pt-malware': 'v2/enrichment/malware',
        'pt-osint': 'v2/enrichment/osint',
        'pt-whois': 'v2/whois',
        'pt-whois-keyword': 'v2/whois/search/keyword',
        'pt-whois-search': 'v2/whois/search',
        'pt-get-components': 'v2/host-attributes/components',
        'pt-get-pairs': 'v2/host-attributes/pairs',
        'pt-ssl-cert': 'v2/ssl-certificate',
        'pt-ssl-cert-history': 'v2/ssl-certificate/history',
        'pt-ssl-cert-keyword': 'v2/ssl-certificate/search/keyword',
        'pt-ssl-cert-search': 'v2/ssl-certificate/search'
    };

    // This is the call made when pressing the integration test button.
    if (command === 'test-module') {
        var res = doReq('GET', 'v2/account');
        if (JSON.parse(res).username)
            return true;
        throw 'Unable to retrieve username';
    }
    var res = doReq('GET', commandToPath[command], args);
    var jsonRes = JSON.parse(res);
    // The command input arg holds the command sent from the user.
    switch (command) {
        case 'pt-get-subdomains':
            var md = '## Subdomains for ' + args.query + '\n';
            md += objToMd(jsonRes);
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md, EntryContext: {subdomains: jsonRes.subdomains}};
        case 'pt-account':
            var md = '## PassiveTotal Account\n';
            md += objToMd(jsonRes);
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md, EntryContext: {'passivetotal.username': jsonRes.username}};
        case 'pt-monitors':
            var md = '## PassiveTotal Monitors\n';
            md += arrToMd(jsonRes);
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
        case 'pt-passive-dns':
            var md = '## PassiveTotal Passive DNS for ' + args.query + ' [' + jsonRes.queryType + '] - total: ' + jsonRes.totalRecords + '\n';
            if (jsonRes.pager) {
                md += 'Pager:\n';
                md += objToMd(jsonRes.pager) + '\n';
            }
            var contextDomain = {Name: args.query, DNS: []};
            if (jsonRes.results && jsonRes.results.length > 0) {
                md += 'Query Type | First Seen | Last Seen\n';
                md += '---------- | ---------- | ---------\n';
                md += jsonRes.queryType + ' | ' + jsonRes.firstSeen + ' | ' + jsonRes.lastSeen + '\n\n';
                md += 'Source | Resolve | First Seen | Last Seen\n';
                md += '------ | ------- | ---------- | ---------\n';
                for (var i=0; i<jsonRes.results.length; i++) {
                    md += jsonRes.results[i].source.join(',') + ' | ' + jsonRes.results[i].resolve + ' | ' + jsonRes.results[i].firstSeen + ' | ' + jsonRes.results[i].lastSeen + '\n';
                    if (jsonRes.queryType === 'domain') {
                        contextDomain.DNS.push({Address: jsonRes.results[i].resolve, FirstSeen: jsonRes.results[i].firstSeen, LastSeen: jsonRes.results[i].lastSeen});
                    }
                }
            } else {
                md += 'No results found!';
            }
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md, EntryContext: {Domain: contextDomain}};
        case 'pt-passive-unique':
            var md = '## PassiveTotal Passive Unique DNS for ' + args.query + ' [' + jsonRes.queryType + '] - total: ' + jsonRes.total + '\n';
            if (jsonRes.pager) {
                md += 'Pager:\n';
                md += objToMd(jsonRes.pager) + '\n';
            }
            var contextDomain = {Name: args.query, DNS: []};
            if (jsonRes.results && jsonRes.results.length > 0) {
                var frequency = jsonRes.frequency.reduce(function(f, v) {f[v[0]] = v[1]; return f;}, {});
                md += 'Result | Frequency\n';
                md += '------ | ---------\n';
                for (var i=0; i<jsonRes.results.length; i++) {
                    md += jsonRes.results[i] + ' | ' + frequency[jsonRes.results[i]] + '\n';
                    contextDomain.DNS.push({Address: jsonRes.results[i]});
                }
            } else {
                md += 'No results found!';
            }
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md, EntryContext: {Domain: contextDomain}};
        case 'pt-dns-keyword':
            var md = '## PassiveTotal Passive DNS Keyword Query: ' + args.query + '\n';
            if (jsonRes.results && jsonRes.results.length > 0) {
                md += arrToMd(jsonRes.results);
            } else {
                md += 'No results found!';
            }
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
        case 'pt-enrichment':
            var md = '## PassiveTotal Metadata Enrichment for: ' + args.query + '\n';
            md += objToMd(jsonRes);
            var context = {};
            var mal = false;
            if (jsonRes.classification === 'malicious') {
                mal = true;
            } else {
                var badTags = argToList(tags);
                var allTags = [jsonRes.tags, jsonRes.system_tags, jsonRes.global_tags];
                for (var i=0; i<allTags.length && !mal; i++) {
                    for (var j=0; j<badTags.length && !mal; j++) {
                        if (allTags[i].indexOf(badTags[j]) >= 0) {
                            mal = true;
                        }
                    }
                }
            }
            if (mal) {
                if (jsonRes.queryType === 'domain') {
                    addMalicious(context, outputPaths.domain, {
                        Name: jsonRes.queryValue, Malicious: {Vendor: 'PassiveTotal', Description: 'Tagged as malware'}
                    });
                    context.DBotScore = {Indicator: args.query, Type: 'domain', Vendor: 'PassiveTotal', Score: 3};
                } else {
                    addMalicious(context, outputPaths.ip, {
                        Address: jsonRes.queryValue,
                        Malicious: {Vendor: 'PassiveTotal', Description: 'Tagged as malware'},
                        Geo: {Country: jsonRes.country, Location: '' + jsonRes.latitude + ',' + jsonRes.longitude}
                    });
                    context.DBotScore = {Indicator: args.query, Type: 'ip', Vendor: 'PassiveTotal', Score: 3};
                }
            } else {
                if (jsonRes.queryType === 'domain') {
                    context.DBotScore = {Indicator: args.query, Type: 'domain', Vendor: 'PassiveTotal', Score: 1};
                    context[outputPaths.domain] = {Name: jsonRes.queryValue};
                } else {
                    context.DBotScore = {Indicator: args.query, Type: 'ip', Vendor: 'PassiveTotal', Score: 1};
                    context[outputPaths.domain] = {
                        Address: jsonRes.queryValue,
                        Geo: {Country: jsonRes.country, Location: '' + jsonRes.latitude + ',' + jsonRes.longitude}
                    };
                }
            }
            var fullResult = [{Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md, EntryContext: context}];
            if (jsonRes.queryType === 'ip' && jsonRes.latitude && jsonRes.longitude) {
                fullResult.push({Type: entryTypes.map, Contents: {lat: jsonRes.latitude, lng: jsonRes.longitude}, ContentsFormat: formats.json});
            }
            return fullResult;
        case 'pt-malware':
            var md = '## PassiveTotal Malware Report for: ' + args.query + '\n';
            var context = {};
            if (!args.threshold) {
                args.threshold = 10;
            }
            if (!args.samples) {
                args.samples = 10;
            }
            var samples = [];
            if (jsonRes.results && jsonRes.results.length > 0) {
                // Sort based on date to display the latest
                jsonRes.results.sort(function(a, b) {
                    if (a.collectionDate < b.collectionDate) {
                        return 1;
                    } else if (a.collectionDate > b.collectionDate) {
                        return -1;
                    }
                    return 0;
                });
                md += 'Source | Sample | Date\n';
                md += '------ | ------ | ----\n';
                for (var i=0; i<jsonRes.results.length && i<args.samples; i++) {
                    md += '[' + jsonRes.results[i].source + '](' + jsonRes.results[i].sourceUrl + ') | ' + jsonRes.results[i].sample + ' | ' + jsonRes.results[i].collectionDate + '\n';
                    samples.push(jsonRes.results[i].sample);
                }
                context[outputPaths.file] = [];
                context.DBotScore = [];
                for (var hash = 0; hash < samples.length; hash++) {
                    var hashType = samples[hash].length === 32 ? 'MD5' : samples[hash].length === 40 ? 'SHA1' : 'SHA256';
                    var hashObj = {Malicious: {Vendor: 'PassiveTotal', Description: 'Malware sample'}};
                    hashObj[hashType] = samples[hash];
                    var malFile = {};
                    addMalicious(malFile, outputPaths.file, hashObj);
                    context[outputPaths.file].push(malFile[outputPaths.file]);
                    context.DBotScore.push({Indicator: samples[hash], Type: 'hash', Vendor: 'PassiveTotal', Score: 3});
                }

                var recentSampleCount = 0;
                var now = Date.now();
                for (var i=0; i<jsonRes.results.length; i++) {
                    var d = new Date(jsonRes.results[i].collectionDate.replace(' ', 'T'));
                    if ((now - d.getTime()) / 1000 / 60 / 60 / 24 < 30) {
                          recentSampleCount++;
                    } else {
                        break; // it is sorted
                    }
                }
                var dbotScore = 0;
                if (recentSampleCount >= args.threshold) {
                    dbotScore = 3;
                    if (isIp(args.query)) {
                        addMalicious(context, outputPaths.ip, {
                            Address: args.query, Malicious: {Vendor: 'PassiveTotal', Description: 'Recent sample count: ' + recentSampleCount}
                        });
                    } else {
                        addMalicious(context, outputPaths.domain, {
                            Name: args.query, Malicious: {Vendor: 'PassiveTotal', Description: 'Recent sample count: ' + recentSampleCount}
                        });
                    }
                } else if (recentSampleCount >= args.threshold / 2) {
                    dbotScore = 2;
                } else {
                    dbotScore = 1;
                }
                context.DBotScore.push({Indicator: args.query, Type: 'domain', Vendor: 'PassiveTotal', Score: dbotScore});
            } else {
                md += 'No results found!';
            }
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md, EntryContext: context};
        case 'pt-osint':
            var md = '## PassiveTotal OSINT Report for: ' + args.query + '\n';
            if (jsonRes.results && jsonRes.results.length > 0) {
                md += 'Source | Report | Tags\n';
                md += '------ | ------ | ----\n';
                for (var i=0; i<jsonRes.results.length; i++) {
                    md += '[' + jsonRes.results[i].source + '](' + jsonRes.results[i].sourceUrl + ') | ' + jsonRes.results[i].inReport.join(',') + ' | ' + jsonRes.results[i].tags.join(',') + '\n';
                }
            } else {
                md += 'No results found!';
            }
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
        case 'pt-whois':
            var md = '## PassiveTotal WHOIS Query for: ' + args.query + '\n';
            md += objToMd(jsonRes);
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md, EntryContext: {'passivetotal.whois.email': jsonRes.contactEmail}};
        case 'pt-whois-keyword':
            var md = '## PassiveTotal WHOIS Query by Keyword for: ' + args.query + '\n';
            if (jsonRes.results && jsonRes.results.length > 0) {
                md += 'Focus Point | Match Type | Field\n';
                md += '----------- | ---------- | -----\n';
                for (var i=0; i<jsonRes.results.length; i++) {
                    md += jsonRes.results[i].focusPoint + ' | ' + jsonRes.results[i].matchType + ' | ' + jsonRes.results[i].fieldMatch + '\n';
                }
            } else {
                md += 'No results found!';
            }
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
        case 'pt-whois-search':
            var md = '## PassiveTotal WHOIS Query by Field Matching for: ' + args.field + '=' + args.query + '\n';
            if (jsonRes.results && jsonRes.results.length > 0) {
                for (var i=0; i<jsonRes.results.length; i++) {
                    md += "### Result from " + jsonRes.results[i].registrar + '\n';
                    md += objToMd(jsonRes.results[i]) + '\n';
                }
            } else {
                md += 'No results found!';
            }
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
        case 'pt-get-components':
            var md = '## PassiveTotal Components for: ' + args.query + '\n';
            if (jsonRes.results && jsonRes.results.length > 0) {
                md += 'Category | Label | First Seen | Last Seen | Hostname\n';
                md += '-------- | ----- | ---------- | --------- | --------\n';
                for (var i=0; i<jsonRes.results.length; i++) {
                    md += jsonRes.results[i].category + ' | ' + jsonRes.results[i].label + ' | ' + jsonRes.results[i].firstSeen + ' | ' +
                        jsonRes.results[i].lastSeen + ' | ' + jsonRes.results[i].hostname + '\n';
                }
            } else {
                md += 'No results found!';
            }
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
        case 'pt-get-pairs':
            var md = '## PassiveTotal Pairs for: ' + args.query + '\n';
            if (jsonRes.results && jsonRes.results.length > 0) {
                md += 'Parent | Child | Cause | First Seen | Last Seen\n';
                md += '------ | ----- | ----- | ---------- | ---------\n';
                for (var i=0; i<jsonRes.results.length; i++) {
                    md += jsonRes.results[i].parent + ' | ' + jsonRes.results[i].child + ' | ' + jsonRes.results[i].cause + ' | ' +
                        jsonRes.results[i].firstSeen + ' | ' + jsonRes.results[i].lastSeen + '\n';
                }
            } else {
                md += 'No results found!';
            }
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
        case 'pt-ssl-cert':
            var md = '## PassiveTotal SSL Certificate for: ' + args.query + '\n';
            md += objToMd(jsonRes);
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
        case 'pt-ssl-cert-history':
            var md = '## PassiveTotal SSL Certificate History for: ' + args.query + '\n';
            md += arrToMd(jsonRes);
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
        case 'pt-ssl-cert-keyword':
            var md = '## PassiveTotal SSL Certificate by Keyword for: ' + args.query + '\n';
            md += arrToMd(jsonRes.results);
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
        case 'pt-ssl-cert-search':
            var md = '## PassiveTotal SSL Certificate Search for: ' + args.field + '=' + args.query + '\n';
            md += arrToMd(jsonRes.results);
            return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
        default:
            throw 'Unknown command'; // should never happen
    }
  type: javascript
  commands:
  - name: pt-get-subdomains
    arguments:
    - name: query
      required: true
      description: The name of the domain to retrieve sub domains for
    outputs:
    - contextPath: subdomains
      description: List of subdomains as strings
    description: Get subdomains using a wildcard query.
  - name: pt-account
    arguments: []
    outputs:
    - contextPath: passivetotal.username
      description: Username / Key used for PassiveTotal
    description: Retrieve account details from PassiveTotal
  - name: pt-monitors
    arguments: []
    description: Get monitors associated with your account
  - name: pt-passive-dns
    arguments:
    - name: query
      required: true
      default: true
      description: Query value to use in your request
    - name: direction
      description: 'Pagination direction: next or previous'
    - name: page
      description: Page ID to request
    - name: sources
      description: Comma seperated list of sources to process with
    - name: start
      description: 'Only show data starting from date: YYYY-mm-dd'
    - name: end
      description: 'Only show data up to date: YYYY-mm-dd'
    - name: timeout
      description: Timeout to use on all source requests
    outputs:
    - contextPath: Domain.Name
      description: The name of the queries domain
    - contextPath: Domain.DNS.Address
      description: The resolved address of the domain
    description: Get passive DNS data
  - name: pt-passive-unique
    arguments:
    - name: query
      required: true
      default: true
      description: Query value to use in your request
    - name: direction
      description: 'Pagination direction: next or previous'
    - name: page
      description: Page ID to request
    - name: sources
      description: Comma seperated list of sources to process with
    - name: start
      description: 'Only show data starting from date: YYYY-mm-dd'
    - name: from
      description: 'Only show data up to date: YYYY-mm-dd'
    outputs:
    - contextPath: Domain.Name
      description: The name of the queries domain
    - contextPath: Domain.DNS.Address
      description: The resolved address of the domain
    description: Get unique resolutions from passive DNS data
  - name: pt-dns-keyword
    arguments:
    - name: query
      required: true
      default: true
      description: Query value to use in your request
    description: Search DNS data for keywords
  - name: pt-enrichment
    arguments:
    - name: query
      required: true
      default: true
      description: The data to enrich
    outputs:
    - contextPath: IP.Address
      description: IP address
    - contextPath: IP.Geo.Country
      description: Country of IP address
    - contextPath: IP.Geo.Location
      description: Location of IP as latitude,longitude
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the reason for the vendor to make the decision
    - contextPath: Domain.Name
      description: Bad domains found during enrichment
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: Enrich the given query with metadata
  - name: pt-malware
    arguments:
    - name: query
      required: true
      default: true
      description: The data to get malware for
    - name: samples
      required: false
      default: false
      description: The number of malware samples to return
      defaultValue: "10"
    - name: threshold
      required: false
      default: false
      description: Above this number of samples we will consider this to be malicious
      defaultValue: "10"
    outputs:
    - contextPath: IP.Address
      description: Bad IPs found during enrichment
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the reason for the vendor to make the decision
    - contextPath: Domain.Name
      description: Bad domains found during enrichment
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    - contextPath: File.MD5
      description: Bad hash MD5
    - contextPath: File.SHA1
      description: Bad hash SHA1
    - contextPath: File.SHA256
      description: Bad hash SHA256
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision
    - contextPath: File.Malicious.Description
      description: For malicious files, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: Get malware data
  - name: url
    arguments:
    - name: url
      required: true
      default: true
      description: The URL to check reputation for
    - name: samples
      description: The number of malware samples to return
      defaultValue: "10"
      deprecated: true
    - name: threshold
      description: Above this number of samples we will consider this to be malicious
      defaultValue: "10"
      deprecated: true
    outputs:
    - contextPath: IP.Address
      description: IP address
    - contextPath: IP.Geo.Country
      description: Country of IP address
    - contextPath: IP.Geo.Location
      description: Location of IP as latitude,longitude
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the reason for the vendor to make the decision
    - contextPath: Domain.Name
      description: Bad domains found during enrichment
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: Check URL reputation data
  - name: domain
    arguments:
    - name: domain
      required: true
      default: true
      description: The domain to get malware for
    outputs:
    - contextPath: Domain.Name
      description: Bad domains found during enrichment
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: Check domain reputation data
  - name: ip
    arguments:
    - name: ip
      required: true
      default: true
      description: The IP to check reputation for
    outputs:
    - contextPath: IP.Address
      description: IP address
    - contextPath: IP.Geo.Country
      description: Country of IP address
    - contextPath: IP.Geo.Location
      description: Location of IP as latitude,longitude
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: Check IP reputation
  - name: pt-osint
    arguments:
    - name: query
      required: true
      default: true
      description: The data to get OSINT for
    description: Get opensource intelligence data
  - name: pt-whois
    arguments:
    - name: query
      required: true
      default: true
      description: Query value to use in your request
    - name: compact_record
      description: Compress the WHOIS record into a deduplicated format - true or
        false
      defaultValue: true
    outputs:
    - contextPath: passivetotal.whois.email
      description: Contact email for the queried domain
    description: Get WHOIS data for a domain or IP address
  - name: pt-whois-keyword
    arguments:
    - name: query
      required: true
      default: true
      description: Keyword to search WHOIS database
    description: Search WHOIS details based on keywords
  - name: pt-whois-search
    arguments:
    - name: query
      required: true
      default: true
      description: Query value to use in your request
    - name: field
      required: true
      description: 'WHOIS field to execute the search on: domain, email, name, organization,
        address, phone, nameserver'
    description: Get WHOIS records based on field matching queries
  - name: pt-get-components
    arguments:
    - name: query
      required: true
      default: true
      description: Query value to use in your request
    description: Get detailed information about a host
  - name: pt-get-pairs
    arguments:
    - name: query
      required: true
      default: true
      description: Query value to use in your request
    - name: direction
      required: true
      default: false
      description: Relationship direction - parents, children.
      defaultValue: children
    description: Get host pairs based on dependent requests observed in web crawls
  - name: pt-ssl-cert
    arguments:
    - name: query
      required: true
      default: true
      description: The SHA1 to retrieve SSL certificate data for
    description: Get the SSL certificate associated with the SHA-1
  - name: pt-ssl-cert-history
    arguments:
    - name: query
      required: true
      default: true
      description: The SHA1 or IP to retrieve SSL certificate data for
    description: Get the SSL certificate history associated with an IP address or
      SHA-1
  - name: pt-ssl-cert-keyword
    arguments:
    - name: query
      required: true
      default: true
      description: Query value to use in your request
    description: Search for SSL certificates based on a keyword
  - name: pt-ssl-cert-search
    arguments:
    - name: query
      required: true
      default: true
      description: Query value to use in your request
    - name: field
      required: true
      description: 'Field to search against: issuerSurname, subjectOrganizationName,
        issuerCountry, issuerOrganizationUnitName, fingerprint, subjectOrganizationUnitName,
        serialNumber, subjectEmailAddress, subjectCountry, issuerGivenName, subjectCommonName,
        issuerCommonName, issuerStateOrProvinceName, issuerProvince, subjectStateOrProvinceName,
        sha1, sslVersion, subjectStreetAddress, subjectSerialNumber, issuerOrganizationName,
        subjectSurname, subjectLocalityName, issuerStreetAddress, issuerLocalityName,
        subjectGivenName, subjectProvince, issuerSerialNumber, issuerEmailAddress'
    description: Search for SSL certificates based on field values
  runonce: false
