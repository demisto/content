commonfields:
  id: WildFire
  version: -1
name: WildFire
fromversion: 4.0.0
display: Palo Alto Networks WildFire (Deprecated)
deprecated: true
category: Forensics & Malware Analysis
image: data:image/png;base64,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
description: Perform malware dynamic analysis
detaileddescription: |-
  Don’t have a WildFire API key?
  Go to your WildFire account,
  Login to: https://wildfire.paloaltonetworks.com/wildfire/account
  Select the “Account” tab
  Copy your API Key
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: https://wildfire.paloaltonetworks.com/publicapi
  type: 0
  required: true
- display: API Key
  name: token
  defaultvalue: ""
  type: 4
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |-
    //DICTIONARIES//
    var URL_DICT = {
        verdict: '/get/verdict',
        verdicts: '/get/verdicts',
        upload: '/submit/file',
        uploadUrl: '/submit/link',
        report: '/get/report',
        remoteFile: '/submit/url',
        getSample: '/get/sample'
    };

    var ERROR_DICT = {
        401 : 'Unauthorized, API key invalid',
        404 : 'Not Found, The report was not found',
        405 : 'Method Not Allowed, Method other than POST used',
        413 : 'Request Entity Too Large, Sample file size over max limit',
        415 : 'Unsupported Media Type',
        418 : 'Unsupported File Type Sample, file type is not supported',
        419 : 'Request quota exceeded',
        420 : 'Insufficient arguments',
        421 : 'Invalid arguments',
        500 : 'Internal error',
        502 : 'Bad Gateway',
        513 : 'File upload failed'
    };

    var VERDICTS_DICT = {
        '0': 'benign',
        '1': 'malware',
        '2': 'grayware',
        '4': 'phishing',
        '-100': 'pending, the sample exists, but there is currently no verdict',
        '-101': 'error',
        '-102': 'unknown, cannot find sample record in the database',
        '-103': 'invalid hash value'
    };

    var VERDICTS_TO_DBOTSCORE = {
        '0': 1,
        '1': 3,
        '2': 2,
        '4': 3,
        '-100': 0,
        '-101': 0,
        '-102': 0,
        '-103': 0
    };

    //GLOBALS//
    var URL = params.server.replace(/[\/]+$/, '');
    var DEFAULT_HEADERS = {'Content-Type': ['application/x-www-form-urlencoded']};
    var TOKEN = params.token;

    var MD5_REGEX = /\b[a-fA-F\d]{32}\b/m;
    var SHA1_REGEX = /\b[a-fA-F\d]{40}\b/m;
    var SHA256_REGEX = /\b[a-fA-F\d]{64}\b/m;

    //HELPERS//
    function sendRequest(url, body, headers) {
        url.replace(/[\/]+$/, '');
        var res = http(
            url,
            {
                Method: 'POST',
                Body: body,
                Headers: headers
            },
            params.insecure,
            params.proxy
        );

        if (res.StatusCode !== 200) {
            if (res.StatusCode === 404) {
                return undefined;
            } else if (ERROR_DICT[res.StatusCode]) {
                throw 'Request Failed.\nStatus code: ' + res.StatusCode + ' ' + ERROR_DICT[res.StatusCode];
            } else {
                throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
            }
        }
        return res;
    }


    function sendMultipartRequest(url, headers, file, body) {
        var res = httpMultipart(
          url,
          file,
          {
            Method: 'POST',
            Headers: headers,
          },
          body,
          params.insecure,
          params.proxy
        );

        if (res.StatusCode !== 200) {
            if (ERROR_DICT[res.StatusCode]) {
                throw 'Request Failed.\nStatus code: ' + res.StatusCode + ' ' + ERROR_DICT[res.StatusCode];
            } else {
                throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
            }
        }
        return JSON.parse(x2j(res.Body));
    }


    function prettifyUploadBody(body) {
        var prettyUploadBody = {
            'MD5': body.md5,
            'SHA256': body.sha256,
            'Status': 'Pending'
        };
        if (body.filetype) {
            prettyUploadBody.FileType = body.filetype;
        }
        if (body.size) {
            prettyUploadBody.Size = body.size;
        }
        if (body.url) {
            prettyUploadBody.URL = body.url;
        }
        return prettyUploadBody;
    }


    function prettifyVerdict(verdictData) {
        var prettyVerdict = {};
        if (verdictData.md5) {
            prettyVerdict.MD5 = verdictData.md5;
        }
        if (verdictData.sha256) {
            prettyVerdict.SHA256 = verdictData.sha256;
        }
        prettyVerdict.Verdict = Number(verdictData.verdict);
        prettyVerdict.VerdictDescription = VERDICTS_DICT[verdictData.verdict];

        return prettyVerdict;
    }


    function createDBotScoreFromVerdict(prettyVerdict) {
        if (!prettyVerdict.SHA256 && !prettyVerdict.MD5) {
            throw 'Hash is missing in WildFire verdict.';
        }
        if (VERDICTS_TO_DBOTSCORE[prettyVerdict.Verdict] === undefined) {
            throw 'This hash verdict is not mapped to a DBotScore. Contact Demisto support for more information.';
        }
        var DbotScore = {
            'Indicator': prettyVerdict.SHA256? prettyVerdict.SHA256 : prettyVerdict.MD5,
            'Type': 'hash',
            'Vendor': 'WildFire',
            'Score': VERDICTS_TO_DBOTSCORE[prettyVerdict.Verdict]
        };
        return DbotScore;
    }


    function prettifyVerdicts(verdictsData) {
        var prettyVerdictsArr = [];
        for (var i = 0; i < verdictsData.length; i++) {
            var prettyVerdict = {};
            if (verdictsData[i].md5) {
                prettyVerdict.MD5 = verdictsData[i].md5;
            }
            if (verdictsData[i].sha256) {
                prettyVerdict.SHA256 = verdictsData[i].sha256;
            }
            prettyVerdict.Verdict = Number(verdictsData[i].verdict);
            prettyVerdict.VerdictDescription = VERDICTS_DICT[verdictsData[i].verdict];

            prettyVerdictsArr.push(prettyVerdict);
        }
        return prettyVerdictsArr;
    }


    function createDBotScoreFromVerdicts(prettyVerdicts) {
        var DbotScoreArr = [];
        for (var i = 0; i < prettyVerdicts.length; i++) {
            if (!prettyVerdicts[i].SHA256 && !prettyVerdicts[i].MD5) {
                throw 'Hash is missing in WildFire verdict.';
            }
            if (VERDICTS_TO_DBOTSCORE[prettyVerdicts[i].Verdict] === undefined) {
                throw 'This hash verdict is not mapped to a DBotScore. Contact Demisto support for more information.';
            }
            var DbotScore = {
                'Indicator': prettyVerdicts[i].SHA256? prettyVerdicts[i].SHA256 : prettyVerdicts[i].MD5,
                'Type': 'hash',
                'Vendor': 'WildFire',
                'Score': VERDICTS_TO_DBOTSCORE[prettyVerdicts[i].Verdict]
            };
        DbotScoreArr.push(DbotScore);
        }
        return DbotScoreArr;
    }


    function createUploadEntry(body, title, result) {
        var md = tableToMarkdown(title, body);
        return {
            Type: entryTypes.note,
            Contents: result,
            ContentsFormat: formats.json,
            HumanReadable: md,
            ReadableContentsFormat: formats.markdown,
            EntryContext: {
                "WildFire.Report(val.SHA256 === obj.SHA256 || val.MD5 === obj.MD5)": prettifyUploadBody(body)
            }
        };
    }


    function createEntry(body, title, result, verbose, report, ec) {
        var md = tableToMarkdown(title, body, Object.keys(body));
        if (verbose) {
            for (var i = 0; i < report.length; i++) {
                md += tableToMarkdown('Report ' + i, report[i], Object.keys(report[i]));
            }
        }
        return {
            Type: entryTypes.note,
            Contents: result,
            ContentsFormat: formats.json,
            HumanReadable: md,
            ReadableContentsFormat: formats.markdown,
            EntryContext: ec
        };
    }


    function hashArgsHandler(sha256, md5) {
        // sha256, md5 arguments are used in wildfire-report, wildfire-verdict commands
        var inputs = sha256? argToList(sha256) : argToList(md5);
        for (i = 0; i < inputs.length; i++) {
            if (SHA256_REGEX.test(inputs[i]) || MD5_REGEX.test(inputs[i])) {
                continue;
            } else {
                throw 'Invalid hash. Only SHA256 and MD5 are supported.';
            }
        }
        return inputs;
    }

    function fileArgsHandler(file, sha256, md5) {
        var inputs;
        // file/md5/sha256 are used in file command
        if ((file && !md5 && !sha256) || (!file && md5 && !sha256) || (!file && md5 && !sha256)) {
            if (file) {
                inputs = argToList(file);
            } else if (md5) {
                inputs = argToList(md5);
            } else {
                inputs = argToList(sha256);
            }
            for (i = 0; i < inputs.length; i++) {
                if (SHA1_REGEX.test(inputs[i])) { // validate hash is not sha1
                    inputs[i] = 'SHA1';
                }
                else if (SHA256_REGEX.test(inputs[i]) || MD5_REGEX.test(inputs[i])) {
                    continue;
                } else {
                    throw 'Invalid hash. Only SHA256 and MD5 are supported.';
                }
            }
        } else {
            throw 'Specify exactly 1 of the following arguments: file, sha256, md5';
        }

        return inputs;
    }


    //COMMANDS//
    function uploadFile(upload) {
        uri = URL + URL_DICT.upload;
        var body = {
            'apikey': TOKEN,
            'file' : upload
        };
        var result = sendMultipartRequest(uri, DEFAULT_HEADERS, upload, body);
        var uploadData = dq(result, 'wildfire.upload-file-info');
        var returnObj = {
            res: result,
            data: uploadData
        };
        return returnObj;
    }


    function getVerdicts(EntryID) {
        uri = URL + URL_DICT.verdicts;
        var body = {'apikey': TOKEN};
        var result = sendMultipartRequest(uri, DEFAULT_HEADERS, EntryID, body);

        var verdictsData = dq(result, 'wildfire.get-verdict-info');

        var prettyVerdicts = prettifyVerdicts(verdictsData);
        var md = tableToMarkdown('WildFire Verdicts', prettyVerdicts);

        var dbotScore = createDBotScoreFromVerdicts(prettyVerdicts);
        var ec = {
            "WildFire.Verdicts(val.SHA256 === obj.SHA256 || val.MD5 === obj.MD5)": prettyVerdicts,
            "DBotScore(val.Indicator === obj.Indicator)": dbotScore
        };

        return {
            Type: entryTypes.note,
            Contents: result,
            ContentsFormat: formats.json,
            HumanReadable: md,
            ReadableContentsFormat: formats.markdown,
            EntryContext: ec
        };
    }


    function getVerdict(hash) {
        var uri = URL + URL_DICT.verdict;

        var body = 'apikey='+TOKEN+'&hash='+hash;
        var result = sendRequest(uri, body, DEFAULT_HEADERS);
        var jres = JSON.parse(x2j(result.Body));

        var verdictData = dq(jres, 'wildfire.get-verdict-info');

        var prettyVerdict = prettifyVerdict(verdictData);
        var md = tableToMarkdown('WildFire Verdict', prettyVerdict);

        var dbotScore = createDBotScoreFromVerdict(prettyVerdict);
        var ec = {
            "WildFire.Verdicts(val.SHA256 === obj.SHA256 || val.MD5 === obj.MD5)": prettyVerdict,
            "DBotScore(val.Indicator === obj.Indicator)": dbotScore
        };

        return {
            Type: entryTypes.note,
            Contents: jres,
            ContentsFormat: formats.json,
            HumanReadable: md,
            ReadableContentsFormat: formats.markdown,
            EntryContext: ec
        };
    }


    function uploadFileRemote(upload) {
        var uri = URL + URL_DICT.remoteFile;

        var body = {
            apikey: TOKEN,
            url: upload
        };
        var result = sendMultipartRequest(uri, DEFAULT_HEADERS, '', body);

        var uploadData = dq(result, 'wildfire.upload-file-info');

        var returnObj = {
            res: result,
            data: uploadData
        };
        return returnObj;
    }


    function uploadUrl(upload) {
       var uri = URL + URL_DICT.uploadUrl;

        var body = {
            apikey: TOKEN,
            link: upload
        };
        var result = sendMultipartRequest(uri, DEFAULT_HEADERS, '', body);

        var uploadData = dq(result, 'wildfire.submit-link-info');

        var returnObj = {
            res: result,
            data: uploadData
        };
        return returnObj;
    }


    function getSample(hash) {

        var sampleUrl = URL + URL_DICT.getSample;

        var body = 'apikey='+TOKEN+'&hash='+hash;
        var result = sendRequest(sampleUrl, body, DEFAULT_HEADERS);

        if (!result) {
            return 'Sample was not found. Grayware and benign samples are available for 14 days. For more information, contact your WildFire representative.';
        } else {
            var fileName;
            if (result.Headers['Content-Disposition']) {
                var str = String(result.Headers['Content-Disposition']);
                var n = str.lastIndexOf('filename=');
                fileName = str.substring(n + 9);
            } else {
                fileName = 'file_' + hash;
            }

            var createdFileID = saveFile(result.Bytes);
            return {
                Type: 3,
                FileID: createdFileID,
                File: fileName,
                Contents: fileName
            };
        }
    }



    function getReport(hash) {
        var reportUrl = URL + URL_DICT.report;

        var bodyXML = 'apikey='+TOKEN+'&format=xml&hash='+hash;
        var resXML = sendRequest(reportUrl, bodyXML, DEFAULT_HEADERS);

        if(!resXML){
          return {error: 'Report not found'};
        }
        var resXMLBody = resXML.Body;
        if(!resXMLBody){
          return {error: 'No results yet'};
        }

        var result = JSON.parse(x2j(resXMLBody));
        var report =  dq(result, 'wildfire.task_info.report');
        var file_info = dq(result, 'wildfire.file_info');
        if (!report || !file_info) {
            return {error: 'No results yet'};
        }

        var returnObj = {
            hash: hash,
            result: result,
            report: report,
            info: file_info
        };
        return returnObj;
    }


    function createReport(reportResponse, format, verbose) {
        var reportUrl = URL + URL_DICT.report;
        var result = reportResponse.result;
        var report = reportResponse.report;
        var file_info = reportResponse.info;
        var hash = reportResponse.hash;

        udp_ip = [];
        udp_port = [];
        tcp_ip = [];
        tcp_port = [];
        dns_query = [];
        dns_response = [];
        evidence_md5 = [];
        evidence_text = [];

        for (var i = 0; i < report.length; i++) {
            if ('network' in report[i]) {
                if (report[i].network) {
                    if ('UDP' in report[i].network) {
                        if ('-ip' in report[i].network.UDP) {
                            udp_ip.push(report[i].network.UDP['-ip']);
                        }
                        if ('-port' in report[i].network.UDP) {
                            udp_port.push(report[i].network.UDP['-port']);
                        }
                    }
                    if ('TCP' in report[i].network) {
                        if ('-ip' in report[i].network.TCP) {
                            tcp_ip.push(report[i].network.TCP['-ip']);
                        }
                        if ('-port' in report[i].network.TCP) {
                            tcp_port.push(report[i].network.TCP['-port']);
                        }
                    }
                    if ('dns' in report[i].network) {
                        for (var j = 0; j < report[i].network.dns.length; j++) {
                            if ('-query' in report[i].network.dns[j]) {
                                dns_query.push(report[i].network.dns[j]['-query']);
                            }
                            if ('-response' in report[i].network.dns[j]) {
                                dns_response.push(report[i].network.dns[j]['-response']);
                            }
                        }
                    }
                }
            }
            if ('evidence' in report[i]) {
                if ('file' in report[i].evidence) {
                    if (typeof report[i].evidence.file == 'object' && 'entry' in report[i].evidence.file) {
                        if ('-md5' in report[i].evidence.file.entry) {
                            evidence_md5.push(report[i].evidence.file.entry['-md5']);
                        }
                        if (typeof report[i].evidence.file == 'object' && '-text' in report[i].evidence.file.entry) {
                            evidence_text.push(report[i].evidence.file.entry['-text']);
                        }
                    }
                }
            }
        }

        var context = {
            DBotScore: {Indicator: hash, Type: 'hash', Vendor: 'WildFire', Score: 0 }
        };

        var outputs = {
            'Status': 'Success',
            'SHA256': reportResponse.info.sha256,
        };

        if (udp_ip.length || udp_port.length || tcp_ip.length || tcp_port.length || dns_query || dns_response) {

            outputs.Network = {};

            if (udp_ip.length || udp_port.length) {
                outputs.Network.UDP = {};
                if (udp_ip.length) {
                    outputs.Network.UDP.IP = udp_ip;
                }
                if (udp_port.length) {
                    outputs.Network.UDP.Port = udp_port;
                }
            }
            if (tcp_ip.length || tcp_port.length) {
                outputs.Network.TCP = {};
                if (tcp_ip.length) {
                    outputs.Network.TCP.IP = tcp_ip;
                }
                if (tcp_port.length) {
                    outputs.Network.TCP.Port = tcp_port;
                }
            }
            if (dns_query.length || dns_response.length) {
                outputs.Network.DNS = {};
                if (dns_query.length) {
                    outputs.Network.DNS.Query = dns_query;
                }
                if (dns_response.length) {
                    outputs.Network.DNS.Response = dns_response;
                }
            }
        }

        if (evidence_md5.length || evidence_text.length) {
            outputs.Evidence = {};
            if (evidence_md5.length) {
                outputs.Evidence.md5 = evidence_md5;
            }
            if (evidence_text.length) {
                outputs.Evidence.Text = evidence_text;
            }
        }

        context["WildFire.Report(val.SHA256 === obj.SHA256)"] = outputs;

        if (file_info) {
            if (file_info.malware === 'yes') {
                context.DBotScore.Score = 3;
                addMalicious(context, outputPaths.file, {
                    Type : file_info.filetype,
                    MD5 : file_info.md5,
                    SHA1 : file_info.sha1,
                    SHA256 : file_info.sha256,
                    Size : file_info.size,
                    Name : file_info.filename,
                    Malicious: {Vendor: 'WildFire'}
                });
            } else {
                context.DBotScore.Score = 1;
            }
        }
        if(format === 'pdf'){
            var bodyPDF = 'apikey=' + TOKEN + '&format=pdf&hash=' + hash;
            var resPDF = sendRequest(reportUrl, bodyPDF, DEFAULT_HEADERS).Bytes;
            var currentTime = new Date();
            var fileName = command + '_at_' + currentTime.getTime();
            return {
                Type: 9,
                FileID: saveFile(resPDF),
                File: fileName,
                Contents: fileName,
                EntryContext: context
            };
        }
        else{
            return createEntry(file_info, 'WildFire Report', result, verbose, report, context);
        }
    }


    function doReports(inputs) {
        var entries = [];
        for (i=0; i < inputs.length; i++) {
            if (inputs[i] == 'SHA1') {
                entries.push({
                    Type: 11, // warning type
                    Contents: 'WildFire file hash reputation supports only MD5, SHA256 hashes',
                    ContentsFormat: formats.markdown
                });
            } else {
                var reportResponse = getReport(inputs[i]);
                if (reportResponse.error) {
                    return reportResponse.error;
                }
                entries.push(createReport(reportResponse, args.format, args.verbose));
            }
        }
        return entries;
    }


    function detonate(type, upload, format, delay, timeout, verbose) {
        var uploadData;
        if (type === 'file') {
            uploadData = uploadFile(upload).data;
        } else { //type is remote file
            uploadData = uploadFileRemote(upload).data;
        }
        var sha = uploadData.sha256;
        delayTime = parseInt(delay);
        timeOut = parseInt(timeout);
        var waitTime = delayTime;
        wait(delayTime);

        while (waitTime<timeOut) {
            var reportResponse = getReport(undefined, sha);
            if (reportResponse.result) {
                return createReport(reportResponse, format, verbose);
            } else {
                waitTime = waitTime + delayTime;
                wait(delayTime);
            }
        }
        throw ('Timeout due to no answer after ' + timeOut + ' seconds.');
    }

    try {
        switch (command) {
            case 'test-module': // This is the call made when pressing the integration test button.
                testUrl = URL + URL_DICT.report;
                var res = http(
                    testUrl,
                    {
                        Method: 'POST',
                        Body: 'apikey=' + TOKEN + '&format=xml&hash=7f638f13d0797ef9b1a393808dc93b94',
                        Headers: DEFAULT_HEADERS
                    },
                    params.insecure,
                    params.proxy
                    );
                if (res.StatusCode === 200) {
                    return 'ok';
                }
                else {
                    return 'Something went wrong.\n Status code: ' + res.StatusCode + '\nBody: '+ JSON.stringify(res) + '.';
                }
                break;

            case 'file':
                var inputs = fileArgsHandler(args.file, args.md5, sha256);
                return doReports(inputs);

            case 'wildfire-upload':
                inputs = argToList(args.upload);
                entries = [];
                for (i=0; i < inputs.length; i++) {
                    var response = uploadFile(inputs[i]);
                    var uploadData = response.data;
                    var result = response.res;
                    entries.push(createUploadEntry(uploadData, 'WildFire Upload File', result));
                }
                return entries;

            case 'wildfire-upload-file-remote': //deprecated
            case 'wildfire-upload-file-url':
                var response = uploadFileRemote(args.upload);
                var uploadData = response.data;
                var result = response.res;
                return createUploadEntry(uploadData, 'WildFire Upload File URL', result);

            // case 'wildfire-upload-url':
            //     inputs = argToList(args.upload);
            //     entries = [];
            //     for (i=0; i < inputs.length; i++) {
            //         var response = uploadUrl(inputs[i]);
            //         var uploadData = response.data;
            //         var result = response.res;
            //         entries.push(createUploadEntry(uploadData, 'WildFire Upload URL', result));
            //     }
            //     return entries;

            case 'wildfire-report':
                var sha256 = args.sha256? args.sha256 : args.hash;
                var inputs = hashArgsHandler(sha256, args.md5);
                return doReports(inputs);

            case 'wildfire-get-verdict':
                var inputs = hashArgsHandler(args.hash, undefined);
                var entries = [];
                for (i=0; i < inputs.length; i++) {
                    var entry = getVerdict(inputs[i]);
                    entries.push(entry);
                }
                return entries;

            case 'wildfire-get-verdicts':
                var inputs = argToList(args.EntryID);
                var entries = [];
                for (i=0; i < inputs.length; i++) {
                    var entry = getVerdicts(inputs[i]);
                    entries.push(entry);
                }
                return entries;

            case 'wildfire-get-sample':
                var inputs = hashArgsHandler(args.sha256, args.md5);
                var entries = [];
                for (i=0; i < inputs.length; i++) {
                    var entry = getSample(inputs[i]);
                    entries.push(entry);
                }
                return entries;

            case 'detonate-file': //deprecated, please use WildFire Detonate playbook
                return detonate('file', args.upload, args.format, args.delay, args.timeout, args.verbose);

            case 'detonate-file-remote': //deprecated, please use WildFire Detonate playbook
                return detonate('remoteFile', args.upload, args.format, args.delay, args.timeout);
        }
    } catch (err) {
        return {
            Type: entryTypes.error,
            Contents: err,
            HumanReadable: err,
            ReadableContentsFormat: formats.text,
        };
    }

  type: javascript
  commands:
  - name: file
    deprecated: true
    arguments:
    - name: file
      default: true
      description: file hash to check
      isArray: true
    - name: md5
      description: md5 hash to check
      isArray: true
    - name: sha256
      description: sha256 hash to check
      isArray: true
    outputs:
    - contextPath: File.Name
      description: Filename
      type: string
    - contextPath: File.Type
      description: File type e.g. "PE"
      type: string
    - contextPath: File.Size
      description: File size
      type: string
    - contextPath: File.MD5
      description: MD5 hash of the file
      type: string
    - contextPath: File.SHA1
      description: SHA1 hash of the file
      type: string
    - contextPath: File.SHA256
      description: SHA256 hash of the file
      type: string
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision
      type: string
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
      type: string
    - contextPath: DBotScore.Type
      description: The type of the indicator
      type: string
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: DBotScore.Score
      description: The actual score
      type: number
    - contextPath: WildFire.Report.Status
      description: The status of the submission
      type: string
    - contextPath: WildFire.Report.SHA256
      description: SHA256 of the submission
      type: string
    - contextPath: InfoFile.EntryID
      description: The EntryID of the report file
    - contextPath: InfoFile.Extension
      description: The extension of the report file
      type: string
    - contextPath: InfoFile.Name
      description: The name of the report file
      type: string
    - contextPath: InfoFile.Info
      description: The info of the report file
      type: string
    - contextPath: InfoFile.Size
      description: The size of the report file
      type: number
    - contextPath: InfoFile.Type
      description: The type of the report file
      type: string
    description: Retrieve results for a file hash using WildFire
  - name: wildfire-upload
    deprecated: true
    arguments:
    - name: upload
      required: true
      description: ID of the entry containing the file to upload
      isArray: true
    outputs:
    - contextPath: WildFire.Report.MD5
      description: MD5 of the submission
      type: string
    - contextPath: WildFire.Report.SHA256
      description: SHA256 of the submission
      type: string
    - contextPath: WildFire.Report.FileType
      description: The type of the submission
      type: string
    - contextPath: WildFire.Report.Size
      description: The size of the submission
      type: number
    - contextPath: WildFire.Report.Status
      description: The status of the submission
      type: string
    description: Upload file to WildFire for analysis
  - name: wildfire-upload-file-url
    deprecated: true
    arguments:
    - name: upload
      required: true
      description: URL of remote file to be uploaded
    outputs:
    - contextPath: WildFire.Report.MD5
      description: MD5 of the submission
      type: string
    - contextPath: WildFire.Report.SHA256
      description: SHA256 of the submission
      type: string
    description: URL of remote file to be uploaded
  - name: wildfire-report
    deprecated: true
    arguments:
    - name: md5
      description: MD5 hash to check
      isArray: true
    - name: sha256
      description: SHA256 hash to check
      isArray: true
    - name: hash
      deprecated: true
      description: Deprecated - use sha256 argument
      isArray: true
    - name: format
      auto: PREDEFINED
      predefined:
      - xml
      - pdf
      description: Optional - request a structured report (formatted as XML/PDF)
      defaultValue: pdf
    - name: verbose
      description: Receive extended information from WildFire
    outputs:
    - contextPath: File.Name
      description: Filename
      type: string
    - contextPath: File.Type
      description: File type e.g. "PE"
      type: string
    - contextPath: File.Size
      description: File size
      type: number
    - contextPath: File.MD5
      description: MD5 hash of the file
      type: string
    - contextPath: File.SHA1
      description: SHA1 hash of the file
      type: string
    - contextPath: File.SHA256
      description: SHA256 hash of the file
      type: string
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision
      type: string
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
      type: string
    - contextPath: DBotScore.Type
      description: The type of the indicator
      type: string
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: DBotScore.Score
      description: The actual score
      type: number
    - contextPath: WildFire.Report.Status
      description: The status of the submissiom
      type: string
    - contextPath: WildFire.Report.SHA256
      description: SHA256 of the submission
      type: string
    - contextPath: InfoFile.EntryID
      description: The EntryID of the report file
      type: string
    - contextPath: InfoFile.Extension
      description: The extension of the report file
      type: string
    - contextPath: InfoFile.Name
      description: The name of the report file
      type: string
    - contextPath: InfoFile.Info
      description: The info of the report file
      type: string
    - contextPath: InfoFile.Size
      description: The size of the report file
      type: number
    - contextPath: InfoFile.Type
      description: The type of the report file
      type: string
    - contextPath: WildFire.Report.Network.UDP.IP
      description: Submission related IPs in UDP protocol
      type: string
    - contextPath: WildFire.Report.Network.UDP.Port
      description: Submission related ports in UDP protocol
      type: string
    - contextPath: WildFire.Report.Network.TCP.IP
      description: Submission related IPs in TCP protocol
      type: string
    - contextPath: WildFire.Report.Network.TCP.Port
      description: Submission related ports in TCP protocol
      type: string
    - contextPath: WildFire.Report.Network.DNS.Query
      description: Submission DNS queries
      type: string
    - contextPath: WildFire.Report.Network.DNS.Response
      description: Submission DNS responses
      type: string
    - contextPath: WildFire.Report.Evidence.md5
      description: Submission evidence md5
      type: string
    - contextPath: WildFire.Report.Evidence.Text
      description: Submission evidence text
      type: string
    description: Retrieve results for a file hash using WildFire
  - name: wildfire-get-verdict
    deprecated: true
    arguments:
    - name: hash
      required: true
      description: Hash to get verdict for
      isArray: true
    outputs:
    - contextPath: WildFire.Verdicts.MD5
      description: File MD5
      type: string
    - contextPath: WildFire.Verdicts.SHA256
      description: File SHA256
      type: string
    - contextPath: WildFire.Verdicts.Verdict
      description: File verdict
      type: number
    - contextPath: WildFire.Verdicts.VerdictDescription
      description: File verdict description
      type: string
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
      type: string
    - contextPath: DBotScore.Type
      description: The type of the indicator
      type: string
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: DBotScore.Score
      description: The actual score
      type: number
    description: Get a verdict regarding a hash
  - name: wildfire-get-verdicts
    deprecated: true
    arguments:
    - name: EntryID
      required: true
      description: EntryID of the text file that contains multiple hashes. Limit is
        500 hashes.
      isArray: true
    outputs:
    - contextPath: WildFire.Verdicts.MD5
      description: File MD5
      type: string
    - contextPath: WildFire.Verdicts.SHA256
      description: File SHA256
      type: string
    - contextPath: WildFire.Verdicts.Verdict
      description: File verdict
      type: number
    - contextPath: WildFire.Verdicts.VerdictDescription
      description: File verdict description
      type: string
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
      type: string
    - contextPath: DBotScore.Type
      description: The type of the indicator
      type: string
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: DBotScore.Score
      description: The actual score
      type: number
    description: Get a verdict regarding multiple hashes, stored in a txt file
  - name: wildfire-get-sample
    arguments:
    - name: md5
      description: MD5 hash to retrieve
      isArray: true
    - name: sha256
      description: SHA256 hash to retrieve
      isArray: true
    outputs:
    - contextPath: File.Size
      description: File size
      type: number
    - contextPath: File.SHA1
      description: SHA1 hash of the file
      type: string
    - contextPath: File.SHA256
      description: SHA256 hash of the file
      type: string
    - contextPath: File.Name
      description: The sample name
      type: string
    - contextPath: File.SSDeep
      description: SSDeep hash of the file
      type: string
    - contextPath: File.EntryID
      description: War-Room Entry ID of the file
      type: string
    - contextPath: File.Info
      description: Basic information of the file
      type: string
    - contextPath: File.Type
      description: File type e.g. "PE"
      type: string
    - contextPath: File MD5
      description: MD5 hash of the file
      type: string
    - contextPath: File.Extension
      description: File Extension
      type: string
    description: Retrieve a sample from WildFire
  - name: wildfire-upload-file-remote
    deprecated: true
    arguments:
    - name: upload
      required: true
      description: URL of remote file to be uploaded
    outputs:
    - contextPath: WildFire.Report.MD5
      description: MD5 of the submission
      type: string
    - contextPath: WildFire.Report.SHA256
      description: SHA256 of the submission
      type: string
    - contextPath: WildFire.Report.FileType
      description: The type of the submission
      type: string
    - contextPath: WildFire.Report.Size
      description: The size of the submission
      type: number
    - contextPath: WildFire.Report.Status
      description: The status of the submission
      type: string
    description: Deprecated, use wildfire-upload-file-url instead
  - name: detonate-file
    deprecated: true
    arguments:
    - name: upload
      required: true
      description: ID of the entry containing the file to upload
    - name: delay
      description: Delay wait time between calls (in seconds)
      defaultValue: "7"
    - name: timeout
      description: Total wait time (in seconds)
      defaultValue: "60"
    - name: format
      auto: PREDEFINED
      predefined:
      - xml
      - pdf
      description: Optional - request a structured report (formatted as XML/PDF)
    outputs:
    - contextPath: File.Name
      description: Filename
    - contextPath: File.Type
      description: File type e.g. "PE"
    - contextPath: File.Size
      description: File size
    - contextPath: File.MD5
      description: MD5 hash of the file
    - contextPath: File.SHA1
      description: SHA1 hash of the file
    - contextPath: File.SHA256
      description: SHA256 hash of the file
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: Deprecated, use detonate playbook instead.
  - name: detonate-file-remote
    deprecated: true
    arguments:
    - name: upload
      required: true
      description: URL of remote file to be uploaded
    - name: delay
      description: Delay wait time between calls (in seconds)
      defaultValue: "7"
    - name: timeout
      description: Total wait time (in seconds)
      defaultValue: "60"
    - name: format
      auto: PREDEFINED
      predefined:
      - xml
      - pdf
      description: Optional - request a structured report (formatted as XML/PDF)
    description: Deprecated, use detonate playbook instead
  runonce: false
tests:
- No test
