commonfields:
  id: epo
  version: -1
name: epo
display: McAfee ePO
category: Endpoint
image: data:image/png;base64,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
description: McAfee ePolicy Orchestrator
detaileddescription: 'Integration with Intel Security''s ePolicy Orchestrator using
  the official API. '
configuration:
- display: https://<address>:port
  name: address
  defaultvalue: ""
  type: 0
  required: true
- display: Username
  name: authentication
  defaultvalue: ""
  type: 9
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "true"
  type: 8
  required: false
script:
  script: |-
    //GLOBALS//
    var serverUrl = params.address;
    if (serverUrl[serverUrl.length - 1] !== '/') {
        serverUrl += '/';
    }

    var EPO_SYSTEM_ATTRIBUTE_MAP = {
        'EPOComputerProperties.ComputerName': 'Name',
        'EPOComputerProperties.DomainName': 'Domain',
        'EPOComputerProperties.IPHostName': 'Hostname',
        'EPOComputerProperties.IPAddress': 'IPAddress',
        'EPOComputerProperties.OSType': 'OS',
        'EPOComputerProperties.OSVersion': 'OSVersion',
        'EPOComputerProperties.CPUType': 'Processor',
        'EPOComputerProperties.NumOfCPU': 'Processors',
        'EPOComputerProperties.TotalPhysicalMemory': 'Memory',
    };

    //HELPER//
    function callEpo(pCommand, pArgs) {
        var url = serverUrl + 'remote/' + pCommand;
        url += encodeToURLQuery(pArgs);
        url += (Object.keys(pArgs).length > 0) ? '&' : '?';
        url += ':output=json';
        var result = http(
            url,
            {
                Method: 'GET',
                Username: params.authentication.identifier,
                Password: params.authentication.password
            },
            params.insecure,
            params.proxy
        );

        if (isResponseOK(result)) {
            trimmedRes = result.Body.substring(okStr.length);
            trimmedRes = trimmedRes.replace('\n',' ');
            parsedRes = JSON.parse(trimmedRes);
            return parsedRes;
        } else if (result.StatusCode == 200){
            throw 'Error accessing ePO interface. Command: ' + url + ". Body: " + result.Body;
        } else {
            throw 'Error accessing ePO interface. Command: ' + url + ". Response: " + JSON.stringify(result);
        }
    }

    function doRawHttp(method, url, parameters, body) {
        if (!parameters) {
            parameters = {};
        }
        var result = http(
            url + encodeToURLQuery(parameters),
            {
                Headers: {'Content-Type': ['application/json']},
                Method: method,
                Body: ''
            }
        );
        if (result.StatusCode < 200 && result.StatusCode > 299) {
            throw 'Failed to perform request ' + url + encodeToURLQuery(parameters) + ', request status code: ' + result.StatusCode;
        }
        return result;
    }

    function isResponseOK(response) {
        // EPO response if of format: OK -> data. Error: error string
        if (response.StatusCode === 200) {
            okStr = 'OK:';
            if (response.Body.indexOf(okStr) === 0) {
                return true;
            }
        }
        return false;
    }

    function systemsToMd(systems,verbose) {
        var i;
        var md='';
        if (verbose=="true") {
            for (i=0;i<systems.length;i++) {
                md += systemToMd(systems[i],verbose);
            }
        } else {
            var tmpHead='|';
            var tmpLine='|';
            for (var key in EPO_SYSTEM_ATTRIBUTE_MAP) {
                tmpHead += EPO_SYSTEM_ATTRIBUTE_MAP[key] + '|';
                tmpLine += '-|';
            }
            md += tmpHead + '\n'+tmpLine+'\n';
            for (i=0;i<systems.length;i++) {
                md += systemToMd(systems[i],verbose);
            }
        }
        return md;
    }

    function systemToMd(system,verbose) {
        var md='';
        var key;
        if (verbose=="true") {
            md += '#### '+ system["EPOComputerProperties.ComputerName"]+'\n';
            md += "Attribute|Value\n-|-\n";
            for (key in system) {
                md += key +"|"+system[key]+"\n";
            }
            md += "---\n";
        } else {
            md +='|';
            for (key in EPO_SYSTEM_ATTRIBUTE_MAP) {
                md += system[key] +"|";
            }
            md += '\n';
        }
        return md;
    }

    //COMMANDS//
    function epoHelp() {
        var pArgs = {};
        if (args.command) {
            pArgs.command = args.command;
        }
        var readyRes = callEpo('core.help',pArgs);
        var md;
        var line;
        var cmd;
        var desc;

        if (args.command) {
            md = '#### ePO Help - ' + args.command + '\n';
            md += readyRes;
        } else {
            parsedRes = Array.isArray(parsedRes) ? parsedRes : [parsedRes];
            md = '#### ePO Help\n';
            for (var i=0;i<parsedRes.length;i++) {
                line = parsedRes[i];
                line = line.replace(/(\r\n|\n|\r)/gm," ");
                if (!args.search || (args.search.toLowerCase() && line.toLowerCase().indexOf(args.search.toLowerCase())>=0)) {
                    desc = line.split('-')[1] ? line.split('-')[1].trim() : 'N/A';
                    cmd = line.split('-')[0] ? line.split('-')[0].trim() : 'N/A';
                    md += '- **' + cmd + "** - " + desc + '\n';
                }
            }
        }
        return {
            Type: entryTypes.note,
            Contents: readyRes,
            ContentsFormat: formats.json,
            HumanReadable: md
        };
    }

    function epoGetLatestDatRaw() {
        var url = "http://update.nai.com/products/commonupdater/gdeltaavv.ini"
        //Another option is to use avvdat.ini - provided here in case any additional data from that file is needed in the future
        //var url = "http://update.nai.com/Products/CommonUpdater/avvdat.ini"
        result = doRawHttp("GET",url);
        var res = '';
        var sections = result.Body.split('\r\n\r\n');
        var lines = sections[0].split('\r\n');
        for (var i=0;i<lines.length;i++) {
            if (lines[i].indexOf("CurrentVersion")===0){
                return lines[i].split('=')[1];
            }
        }
        throw 'Cannot get McAfee latest DAT file version';
    }

    function epoGetLatestDat() {
        var datVersion = epoGetLatestDatRaw();
        var md='McAfee Latest DAT file version is: **' + datVersion + '**\n';
        ec = {};
        ec.mcafee = {"latestDAT": datVersion};
        return {
            Type: entryTypes.note,
            Contents: datVersion,
            ContentsFormat: formats.json,
            HumanReadable: md,
            EntryContext: {
                    "mcafee(val.latestDAT === obj.latestDAT)": ec.mcafee, //backward compatability
                    "McAfee.ePO.latestDAT": datVersion
            }
        };
    }

    function epoGetCurrentDat() {
        var pArgs = {"searchText":"VSCANDAT1000"};
        var result = callEpo('repository.findPackages', pArgs);
        if (result && result.length>0) {
            result = result[0];
            var epoDAT = result.productDetectionProductVersion.split('.')[0];
            ec = {};
            ec.mcafee = {"epoDAT": epoDAT};
            var md = "McAfee ePO Current DAT file version in repository is: **" + epoDAT + '**\n';
            return {
                Type: entryTypes.note,
                Contents: result,
                ContentsFormat: formats.json,
                HumanReadable: md,
                EntryContext: {
                    "mcafee(val.epoDAT==obj.epoDAT)": ec.mcafee, //backward compatability
                    "McAfee.ePO.epoDAT": epoDAT
                }
            };
        } else {
            throw 'Error getting current DAT version. Please check that the DAT file exists. Response: ' + JSON.stringify(result);
        }
    }

    function epoUpdateClientDatTask() {
        var pArgs = {'searchText': 'VSEContentUpdateDemisto'}; //need to configure this task in ePO beforehand
        var result = callEpo('clienttask.find', pArgs);
        if (result && Array.isArray(result)) {
            result = result[0];
        }
        if (result) {
              return result.objectId;
            }
             // If reached here then the response is an empty "OK:", which means VSEContentUpdateDemisto was not found in the server
            throw 'Error getting DAT update task. It seems the task "VSEContentUpdateDemisto" is missing from the EPO server. Please contact support for more details';
    }

    function epoUpdateClientDat() {
        var clientTask = epoUpdateClientDatTask();
        var pArgs = {'names':args.systems, 'productId':'EPOAGENTMETA', 'taskId':clientTask};

        var options = ['retryAttempts', 'retryIntervalInSeconds', 'abortAfterMinutes', 'stopAfterMinutes', 'randomizationInterval'];
        for (var i=0;i<options.length;i++) {
            if (args[options[i]]) {
                pArgs[options[i]] = args[options[i]];
            }
        }
        var result = callEpo('clienttask.run', pArgs);
        var md = "ePO client DAT update task started: " + result;
        return {
            Type: entryTypes.note,
            Contents: result,
            ContentsFormat: formats.json,
            HumanReadable: md
        };
    }

    function epoUpdateRepository() {
        var pArgs = {
            'sourceRepository': 'McAfeeHttp',
            'targetBranch':'Current'
        };
        var result = callEpo('repository.pull', pArgs);

        var md = "ePO repository update started.\n";
        md += result;
        return {
            Type: entryTypes.note,
            Contents: result,
            ContentsFormat: formats.json,
            HumanReadable: md
        };
    }

    function prettifySystemTree(SystemTree) {
        var prettySystemTree = [];
        for (i=0; i < SystemTree.length; i++) {
            var system = SystemTree[i];
            prettySystemTree[i] = {
                'groupId': system.groupId,
                'groupPath': system.groupPath
            };
        }
        return prettySystemTree;
    }

    function epoGetSystemTreeGroups() {
        var pArgs = {};
        if (args.search) {
            pArgs.searchText=args.search;
        }
        var result = callEpo('system.findGroups', pArgs);
        if (result.length === 0) {
            return 'System Tree Group was not found.';
        }
        var md = "#### ePO System Tree groups\n";
        md += "Group ID | Group path\n-|-\n";
        for (var i=0;i<result.length;i++) {
            md += result[i].groupId + "|" + result[i].groupPath + "\n";
        }
        return {
            Type: entryTypes.note,
            Contents: result,
            ContentsFormat: formats.json,
            HumanReadable: md,
            EntryContext: {
                "McAfee.ePO(val.groupId==obj.groupId)": {'SystemTreeGroups': prettifySystemTree(result)}
            }
        };
    }

    function epoGetSystemGroupPath(groupId) {
        var result = epoGetSystemTreeGroups();
        result = result.Contents;
        for (var i=0;i<result.length;i++) {
            if (groupId == result[i].groupId) {
                return result[i].groupPath;
            }
        }
        return null;
    }

    function prettifyFindSystem(FindSystem) {
        var prettyFindSystem = [];
        for (i=0; i < FindSystem.length; i++) {
            var system = FindSystem[i];
            prettyFindSystem[i] = {
                'Name': system['EPOComputerProperties.ComputerName'],
                'Domain': system['EPOComputerProperties.DomainName'],
                'Hostname': system['EPOComputerProperties.IPHostName'],
                'IPAddress': system['EPOComputerProperties.IPAddress'],
                'OS': system['EPOComputerProperties.OSType'],
                'OSVersion': system['EPOComputerProperties.OSVersion'],
                'Processor': system['EPOComputerProperties.CPUType'],
                'Processors': system['EPOComputerProperties.NumOfCPU'],
                'Memory': system['EPOComputerProperties.TotalPhysicalMemory'],
            };
        }
        return prettyFindSystem;
    }

    function epoFindSystems() {
        var name = epoGetSystemGroupPath(args.groupId);

        if (!name) {
            throw 'System Tree group not found';
        }
        var pArgs = {'groupId':args.groupId};
        var result = callEpo('epogroup.findSystems', pArgs);
        if (result) {
            var md = '#### Systems in '+name+'\n';
            if (result.length>0) {
                md += systemsToMd(result,args.verbose);
            } else {
                md += 'No systems found\n';
            }
            return {
                Type: entryTypes.note,
                Contents: result,
                ContentsFormat: formats.json,
                HumanReadable: md,
                EntryContext: {
                    'Endpoint(val.IPAddress==obj.IPAddress)': prettifyFindSystem(result),
                    'McAfee.ePO.Endpoint(val.IPAddress==obj.IPAddress)': prettifyFindSystem(result),
                }
            };
        } else {
            throw 'No systems found. Response: ' + JSON.stringify(result);
        }
    }

    function epoFindSystem() {
        var pArgs = {'searchText':args.searchText};
        var result = callEpo('system.find', pArgs);
        if (result) {
            var md = '#### Systems in the System Tree\n';
            if (result.length>0) {
                md += systemsToMd(result,args.verbose);
            } else {
                md += 'No systems found\n';
            }
            return {
                Type: entryTypes.note,
                Contents: result,
                ContentsFormat: formats.json,
                HumanReadable: md,
                EntryContext: {
                    'Endpoint(val.IPAddress==obj.IPAddress)': prettifyFindSystem(result),
                    'McAfee.ePO.Endpoint(val.IPAddress==obj.IPAddress)': prettifyFindSystem(result),
                }
            };
        } else {
            throw 'No systems found. Response: ' + JSON.stringify(result);
        }
    }

    function epoWakeupAgent() {
        var pArgs = {'names':args.names};
        var result = callEpo('system.wakeupAgent', pArgs);

        var md = "ePO agent was awaken.\n";
        md += result;

        return {
            Type: entryTypes.note,
            Contents: result,
            ContentsFormat: formats.json,
            HumanReadable: md
        };
    }

    function epoApplyTag() {
        var pArgs = {
            'names': args.names,
            'tagName': args.tagName
        };
        var result = callEpo('system.applyTag', pArgs);

        var md = "ePO applied the tags on the hostnames successfully.\n";

        return {
            Type: entryTypes.note,
            Contents: result,
            ContentsFormat: formats.json,
            HumanReadable: md
        };
    }

    function epoClearTag() {
        var pArgs = {
            'names': args.names,
            'tagName': args.tagName
        };
        var result = callEpo('system.clearTag', pArgs);

        var md = "ePO cleared the tags from the hostnames successfully.\n";

        return {
            Type: entryTypes.note,
            Contents: result,
            ContentsFormat: formats.json,
            HumanReadable: md
        };
    }

    function epoGetTables() {
        var result;
        var pArgs = {};
        if (args.table) {
            pArgs.table = args.table;
        }

        result = callEpo('core.listTables', pArgs);

        var md = tableToMarkdown(
                'ePO tables:',
                Object.keys(result || {}).map(function (k) { return result[k]; }), // object keys
                args.headers && args.headers.split(',')
            );

        return {
            Type: entryTypes.note,
            Contents: result,
            ContentsFormat: formats.json,
            HumanReadable: md
        };
    }

    function epoQueryTable() {
        var pArgs = {'target': args.target};
        var result;
        var ec = {};
        var ec_key = '';
        if (args.select) {
            pArgs.select = args.select;
        }
        if (args.where) {
            pArgs.where = args.where;
        }
        if (args.order) {
            pArgs.order = args.order;
        }
        if (args.group) {
            pArgs.group = args.group;
        }
        if (args.joinTables) {
            pArgs.joinTables = args.joinTables;
        }

        result = callEpo('core.executeQuery', pArgs);

        var md = tableToMarkdown(
                'ePO Table Query:',
                Object.keys(result || {}).map(function (k) { return result[k]; }), // object keys
                args.headers && args.headers.split(',')
            );

        if (args.query_name) {
            ec_key = 'McAfee.ePO.Query.' + args.query_name;
        } else {
            var ts = (new Date()).getTime() / 1000;
            ec_key = 'McAfee.ePO.Query.' + ts;
        }
        ec[ec_key] = result;

        return {
            Type: entryTypes.note,
            Contents: result,
            ContentsFormat: formats.json,
            HumanReadable: md,
            EntryContext: ec
        };
    }

    function epoGetVersion() {
        var pArgs = {};
        var result;

        result = callEpo('epo.getVersion', pArgs);

        var md = "### ePO version is:\n" + result;
        var ec = {"McAfee.ePO.Version": result};

        return {
            Type: entryTypes.note,
            Contents: result,
            ContentsFormat: formats.text,
            HumanReadable: md,
            EntryContext: ec
        };

    }

    function parseCommandArgs(command, commandArgs) {
        //commandArgs should be in the format of:  keyName1:keyValue1, keyName2:KeyValue2
        if (!commandArgs) {
            return null;
        }
        var commandArgsDict = {};
        commandArgsDict.command = command;
        var commandArgsList = commandArgs.split(',');
        var temp = [];
        for (i=0; i < commandArgsList.length; i++) {
            //commandArgsVal in commandArgsList:
            temp = commandArgsList[i].split(':');
            commandArgsDict[temp[0]] = temp[1];
        }
        return commandArgsDict;
    }

    function epoCommand(parsedArgs) {
        if (parsedArgs) {
            args = parsedArgs;
        }
        var pArgs = {};
        for (var key in args) {
            if (key != 'command' && key != 'headers') {
                pArgs[key] = args[key];
            }
        }
        var result = callEpo(args.command, pArgs);

        var md;
        var contents;
        if (typeof result === 'string') {
            md = "#### ePO command *" + args.command + "* results:\n" + result;
            contents = {result: result};
        } else {

            md = tableToMarkdown(
                'ePO command *' + args.command + '* results:',
                Object.keys(result || {}).map(function (k) { return result[k]; }), // object keys
                args.headers && args.headers.split(',')
            );
            contents = result;
        }
        return {
            Type: entryTypes.note,
            Contents: contents,
            ContentsFormat: formats.json,
            HumanReadable: md
        };
    }

    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            epoHelp();
            return 'ok';

        case 'epo-help':
            return epoHelp();

        case 'epo-get-latest-dat':
            return epoGetLatestDat();

        case 'epo-get-current-dat':
            return epoGetCurrentDat();

        case 'epo-update-client-dat':
            return epoUpdateClientDat();

        case 'epo-update-repository':
            return epoUpdateRepository();

        case 'epo-get-system-tree-group':
            return epoGetSystemTreeGroups();

        case 'epo-find-systems':
            return epoFindSystems();

        case 'epo-find-system':
            return epoFindSystem();

        case 'epo-wakeup-agent':
            return epoWakeupAgent();

        case 'epo-apply-tag':
            return epoApplyTag();

        case 'epo-clear-tag':
            return epoClearTag();

        case 'epo-get-tables':
            return epoGetTables();

        case 'epo-query-table':
            return epoQueryTable();

        case 'epo-get-version':
            return epoGetVersion();

        case 'epo-command':
            if (!args.command) {
                throw 'ePO error: command argument is missing';
            }
            return epoCommand(undefined);

        case 'epo-advanced-command':
            if (!args.command) {
                throw 'ePO error: command argument is missing';
            }
            if (!args.commandArgs) {
                throw 'ePO error: commandArgs argument is missing';
            }
            var parsedArgs = parseCommandArgs(args.command, args.commandArgs);
            return epoCommand(parsedArgs);

        default:
            throw 'ePO Error: unknown command';
    }
  type: javascript
  commands:
  - name: epo-help
    arguments:
    - name: search
      default: true
      description: String to search in help
    - name: command
      description: Command to get help on
    description: print help on ePO commands
  - name: epo-get-latest-dat
    arguments: []
    outputs:
    - contentPath: mcAfeeLatestDatVersion
      contextPath: McAfee.ePO.latestDAT
      description: Latest McAfee DAT file version
      type: number
    description: Check the latest DAT file in McAfee repository
  - name: epo-get-current-dat
    arguments: []
    outputs:
    - contextPath: McAfee.ePO.epoDAT
      description: Current McAfee DAT file in ePO repository
      type: number
    description: check the existing DAT file version in ePO
  - name: epo-update-client-dat
    arguments:
    - name: systems
      required: true
      description: IP or system name. Can be comma separated list or system names
        or IP addresses
    - name: retryAttempts
      description: Number of times the server will attempt to send the task to the
        client. Defaults to 1.
    - name: retryIntervalInSeconds
      description: Retry interval in seconds. Defaults to 30.
    - name: abortAfterMinutes
      description: Maximum number of minutes before aborting all attempts. Defaults
        to 5.
    - name: stopAfterMinutes
      description: Maximum duration in minutes the client task is allowed to run.
        Defaults to 20.
    - name: randomizationInterval
      description: Duration in minutes over which to randomly spread task execution.
        Defaults to 0 (execute on all clients immediately).
    description: Run client task to update the DAT file
  - name: epo-update-repository
    arguments: []
    description: Trigger a Server Task in specific ePO servers to pull latest signatures
      from update server
  - name: epo-get-system-tree-group
    arguments:
    - name: search
      description: Search string for system tree group
    outputs:
    - contextPath: McAfee.ePO.SystemTreeGroups.groupId
      description: System Tree group ID
      type: number
    - contextPath: McAfee.ePO.SystemTreeGroups.groupPath
      description: System Tree group path
      type: string
    description: Get System Tree groups
  - name: epo-find-systems
    arguments:
    - name: groupId
      required: true
      description: System Tree Group ID
    - name: verbose
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Print all system data
    outputs:
    - contextPath: Endpoint.Name
      description: Endpoint name
      type: string
    - contextPath: Endpoint.Domain
      description: Endpoint domain
      type: string
    - contextPath: Endpoint.Hostname
      description: Endpoint hostname
      type: string
    - contextPath: Endpoint.IPAddress
      description: Endpoint IP address
      type: string
    - contextPath: Endpoint.OS
      description: Endpoint operation system
      type: string
    - contextPath: Endpoint.OSVersion
      description: Endpoint operation system version
      type: string
    - contextPath: Endpoint.Processor
      description: 'Model of the processor '
      type: string
    - contextPath: Endpoint.Processors
      description: Number of processors
      type: number
    - contextPath: Endpoint.Memory
      description: 'Amount of memory on this endpoint '
      type: number
    - contextPath: McAfee.ePO.Endpoint.Name
      description: Endpoint name
      type: string
    - contextPath: McAfee.ePO.Endpoint.Domain
      description: Endpoint domain
      type: string
    - contextPath: McAfee.ePO.Endpoint.Hostname
      description: Endpoint hostname
      type: string
    - contextPath: McAfee.ePO.Endpoint.IPAddress
      description: Endpoint IP address
      type: string
    - contextPath: McAfee.ePO.Endpoint.OS
      description: Endpoint operation system
      type: string
    - contextPath: McAfee.ePO.Endpoint.OSVersion
      description: Endpoint operation system version
      type: string
    - contextPath: McAfee.ePO.Endpoint.Processor
      description: Model of the processor
      type: string
    - contextPath: McAfee.ePO.Endpoint.Processors
      description: Number of processors
      type: number
    - contextPath: McAfee.ePO.Endpoint.Memory
      description: 'Amount of memory on this endpoint '
      type: number
    description: Find computers within a given group in the ePO tree
  - name: epo-command
    arguments: []
    description: Execute ePO command. Receives mandatory 'command' argument and other
      specific commands other arguments - Run 'epo-help' command to see a list available
      commands. You can also specify 'headers' argument  to filter tables headers.
      e.g. '!epo-command command=system.find searchText=10.0.0.1 headers=EPOBranchNode.AutoID,EPOComputerProperties.ComputerName'
  - name: epo-advanced-command
    arguments:
    - name: command
      required: true
      description: Command to execute. Run a core.help command or !epo-help to identify
        all possible commands.
    - name: commandArgs
      required: true
      description: Comma separated key value pairs as additional arguments to pass.  E.g.
        argName1:argValue1,argName2:argValue2
    description: 'Execute ePO command. Run ''epo-help'' command to see a list available
      commands. e.g:  !epo-advanced-command command="clienttask.find" commandArgs="searchText:On-demand".
      You can also specify ''headers'' argument  to filter tables headers. e.g: ''!epo-command
      command=system.find searchText=10.0.0.1 headers=EPOBranchNode.AutoID,EPOComputerProperties.ComputerName''. '
  - name: epo-wakeup-agent
    arguments:
    - name: names
      required: true
      description: Agent hostname
    description: Wakeup an agent
  - name: epo-apply-tag
    arguments:
    - name: names
      required: true
      description: Hostnames to apply tags on
    - name: tagName
      required: true
      description: Tag name
    description: Applies a tag
  - name: epo-clear-tag
    arguments:
    - name: names
      required: true
      description: Hostnames to clear tags from
    - name: tagName
      required: true
      description: Tag name
    description: Clears a tag
  - name: epo-query-table
    arguments:
    - name: target
      required: true
      description: Table name
    - name: select
      description: 'Which columns to select. Please use SQUID syntax. Example: "(select
        EPOEvents.AutoID EPOEvents.DetectedUTC EPOEvents.ReceivedUTC)"'
    - name: where
      description: 'Filter results. Please use SQUID syntax. Example: "(where ( eq
        ( OrionTaskLogTask .UserName "ga" )))"'
    - name: order
      description: 'Order the results. Please use SQUID syntax. Example: "(order (asc
        OrionTaskLogTask.StartDate) )")'
    - name: group
      description: 'Group the results. Please use SQUID Syntax. Example: "(group EPOBranchNode.NodeName)"'
    - name: joinTables
      description: Perform join. Please use SQUID Syntax.
    - name: query_name
      description: Name for the query to appear in the context
    outputs:
    - contextPath: McAfee.ePO.Query
      description: Query result
    description: Queries an ePO table
  - name: epo-get-tables
    arguments:
    - name: table
      description: Name of the table
    description: Get an ePO table
  - name: epo-find-system
    arguments:
    - name: searchText
      description: Hostname to search
    - name: verbose
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Print all system data
      isArray: true
    outputs:
    - contextPath: Endpoint.Name
      description: Endpoint name
      type: string
    - contextPath: Endpoint.Domain
      description: Endpoint domain
      type: string
    - contextPath: Endpoint.Hostname
      description: Endpoint hostname
      type: string
    - contextPath: Endpoint.IPAddress
      description: Endpoint IP address
      type: string
    - contextPath: Endpoint.OS
      description: Endpoint operation system
      type: string
    - contextPath: Endpoint.OSVersion
      description: Endpoint operation system version
      type: string
    - contextPath: Endpoint.Processor
      description: Model of the processor
      type: string
    - contextPath: Endpoint.Processors
      description: Number of processors
      type: number
    - contextPath: Endpoint.Memory
      description: 'Amount of memory on this endpoint '
      type: number
    - contextPath: McAfee.ePO.Endpoint.Name
      description: Endpoint name
      type: string
    - contextPath: McAfee.ePO.Endpoint.Domain
      description: Endpoint domain
      type: string
    - contextPath: McAfee.ePO.Endpoint.Hostname
      description: Endpoint hostname
      type: string
    - contextPath: McAfee.ePO.Endpoint.IPAddress
      description: Endpoint IP address
      type: string
    - contextPath: McAfee.ePO.Endpoint.OS
      description: Endpoint operation system
      type: string
    - contextPath: McAfee.ePO.Endpoint.OSVersion
      description: Endpoint operation system version
      type: string
    - contextPath: McAfee.ePO.Endpoint.Processor
      description: Model of the processor
      type: string
    - contextPath: McAfee.ePO.Endpoint.Processors
      description: Number of processors
      type: number
    - contextPath: McAfee.ePO.Endpoint.Memory
      description: 'Amount of memory on this endpoint '
      type: number
    description: Finds systems in the System Tree
  - name: epo-get-version
    arguments: []
    outputs:
    - contextPath: McAfee.ePO.Version
      description: ePO version
      type: string
    description: Gets the ePO version. This requires global admin permissions.
  runonce: false
releaseNotes: "-"
tests:
- Test Playbook McAfee ePO