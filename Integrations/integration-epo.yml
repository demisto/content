commonfields:
  id: epo
  version: -1
name: epo
display: McAfee ePO
category: Endpoint
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGwAAAAtCAYAAABLYo4EAAAFhklEQVR4AewUA4wdUbC2bdu2bdu2bdu227Nt29a3bSxvb86I1Q03ycPYUws1mepjFNURp6haOEkOQFCkddm/5imkepMU1bL0j+JYI6tU1aKShugNjVGDsUEZDbPUw0iifumfnsOcWvJXf/YL9t9It8qVLQSHb3KVv13sajJgKFJPfON5nPKniw9qMLQXnnwYwV5yXC3/bBum+unqxFpwkC++8iJWFxF3k7vydB5308UsY2r2dCa5NBVMdOrJ+azOs0DnHfwyq/fcIum1N25WgbiD+MrLu5YczmRUrRub0Xd+EXvF0QxUqZlWMHUHaP54hltZvPOCbdcyJOefizCOcLj6p8fVgsm7wJKYvQdR61oxyaVrwp5825s/ezcITtyF3MmbQfbkW6bk8ptE9vxDIDr/NNqSkrOIt+E0cNedFppY3NGc5ccVosP3PMzZBV3Fp1++5a0+g5kSM+bofWPX5Q/dBJqfLh4YijBrka6CaWy9L3DXnwLW+G3A23oepPfeg2DDZTBFpj2xCoS9dA6+6zlLDgNr8SHQRyd+4K46JRedfOKJqJTtZTc+P+MuOw7mnIJXptCkA/mD1ps1f92fYlZrAya5dBXsn49SuPcaCDZdAtGxeyC5/gJEO26A8rVtnuKDTZD05jtOwagtwJq6F5TvbIC34QxYUrLeAsACyYlnybLLb4BU60HnGlzKI0PyeUtQqbw9k1yaCmbwj96hevU7T+cTkqH67ZKt+urwSe8Wsos194BJ/uirWPnRTqX3CP1uCom3V739q5DdeSu2ZOT9AICRml/uj9jT9xDCXTf4Ws+gHO6iY1z2rH2Y1sn7CJNcek7ZRVSsMILA65I4XvYnFdquJEHULzkDSZJsW0hRTQgU7UTgWNsqBSZjA9JsGYpp9M3KZDC0Ma7RbSMQpBuTXPoK9l9PEUD7klOvuH0zOpITBoJoDPz5fkmBFEiBFEiBFEiBFEhBKZACKZCCzYdc1dXVtq4XcbCsPrrKO8wNkp53NJrT3X7yBVhRAearAPv69dXu+k1ad43kV+2adq3RZ9k1oA/8fIt29Zzsw64lPgsYF+3xcw1xugIMRAsXom2Df4OPCQxggR3jjvR8i5878Kk+GhjYxmhb1GLTQoaDwAKCF4Aa+LkGni+PTIkxhcy7Np3GGBjb0j4HgaFNxoU03CPgpwILsOdsfyf+RsDwGz/BHNpnAoN8D+lkMlLijwJj0b61Yrp8NDDed4yi41Jg4LeB71yAoXCvuw+wGXz7hwNjaWA6yG2A9eBbfwKwABrvCAwO6C36qPd9Skqs48SbuwLDuAUY7GHvBawAm92FuKjTkQZWDs4sv5co1L7YS0wDK60plt+t18D8bv1HAmNDUQFW9CbAigqwIqNgkD3FGQ/ZHAsqxg58kmcrtrHoXYMeN1aYUsGcV08+ta6SpYZ/FFBrXKvqu+ucLsnTC7j+p7xfwK/LCSzxrsEHlpwXx2otYPqIsuFYvjMe59CLi8p3J2oFgyYyu8DYBuLLNg39ni6kDuXGvBjIhhCc4wU2AbRvejzkcKzVxD4MPxcw410WsETHZaXD++QD81tv7PO+wMR1NrjTMeYGBjaez/2BwYJZi5wNmE5TjfPOV+fF/mcD4/F4wPSG2R8AxtLvE8UCXnEDaK0BzJlXD1VoBf71mcB4PEeAoaZLgPFi8jfNB8aadFrnWKcCQ00vAxML1VyQEvnW1AbQKh+YnhdXd/z5PGB6POcXHfhb7IzA+KoApccpY9GBFSJrKlVinrJ+zQoscfj2gRVg2pYBGO0pNaepHwfmdzp0oIs7He1Z3zAFhyGe2enQwLxeogZ2w15iJmCD+EudyokXZfcSNTC/W68CdRd26/W48wDr4D9FUPHMKxVGt16P5w9kq+W6Nl2cegAAAABJRU5ErkJggg==
description: McAfee ePolicy Orchestrator
detaileddescription: 'Integration with Intel Security''s ePolicy Orchestrator using
  the official API. '
configuration:
- display: https://<address>:port
  name: address
  defaultvalue: ""
  type: 0
  required: true
- display: Username
  name: authentication
  defaultvalue: ""
  type: 9
  required: true
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "true"
  type: 8
  required: false
script:
  script: |-
    var serverUrl = params.address;
    if (serverUrl[serverUrl.length - 1] !== '/') {
        serverUrl += '/';
    }

    var epoSystemAttributesMap = {
        'EPOComputerProperties.ComputerName':'Name',
        'EPOComputerProperties.DomainName':'Domain name',
        'EPOComputerProperties.IPHostName':'Hostname',
        'EPOComputerProperties.IPAddress':'IP Address',
        'EPOComputerProperties.OSType':'Operating System'
    };

    var callEpo = function(pCommand, pArgs) {
        var url = serverUrl + 'remote/' + pCommand;
        url += encodeToURLQuery(pArgs);
        url += (Object.keys(pArgs).length > 0) ? '&' : '?';
        url += ':output=json';
        var result = http(
            url,
            {
                Method: 'GET',
                Username: params.authentication.identifier,
                Password: params.authentication.password
            },
            params.insecure,
            params.proxy
        );
        if (isResponseOK(result)) {
            trimmedRes = result.Body.substring(okStr.length);
            trimmedRes = trimmedRes.replace('\n',' ');
            parsedRes = JSON.parse(trimmedRes);
            return parsedRes;
        } else if (result.StatusCode == 200){
            throw 'Error accessing ePO interface. Command: ' + url + ". Body: " + result.Body;
        } else {
            throw 'Error accessing ePO interface. Command: ' + url + ". Response: " + JSON.stringify(result);
        }
    };

    var doRawHttp = function(method, url, parameters, body) {
        if (!parameters) {
            parameters = {};
        }
        var result = http(
            url + encodeToURLQuery(parameters),
            {
                Headers: {'Content-Type': ['application/json']},
                Method: method,
                Body: ''
            }
        );
        if (result.StatusCode < 200 && result.StatusCode > 299) {
            throw 'Failed to perform request ' + url + encodeToURLQuery(parameters) + ', request status code: ' + result.StatusCode;
        }
        return result;
    };

    var isResponseOK = function(response) {
        // EPO response if of format: OK -> data. Error: error string
        if (response.StatusCode === 200) {
            okStr = 'OK:';
            if (response.Body.indexOf(okStr) === 0) {
                return true;
            }
        }
        return false;
    };

    var systemsToMd = function(systems,verbose) {
        var i;
        var md='';
        if (verbose=="true") {
            for (i=0;i<systems.length;i++) {
                md += systemToMd(systems[i],verbose);
            }
        } else {
            var tmpHead='|';
            var tmpLine='|';
            for (var key in epoSystemAttributesMap) {
                tmpHead += epoSystemAttributesMap[key] + '|';
                tmpLine += '-|';
            }
            md += tmpHead + '\n'+tmpLine+'\n';
            for (i=0;i<systems.length;i++) {
                md += systemToMd(systems[i],verbose);
            }
        }
        return md;
    };

    var systemToMd = function(system,verbose) {
        var md='';
        var key;
        if (verbose=="true") {
            md += '#### '+ system["EPOComputerProperties.ComputerName"]+'\n';
            md += "Attribute|Value\n-|-\n";
            for (key in system) {
                md += key +"|"+system[key]+"\n";
            }
            md += "---\n";
        } else {
            md +='|';
            for (key in epoSystemAttributesMap) {
                md += system[key] +"|";
            }
            md += '\n';
        }
        return md;
    };

    var epoHelp = function () {
        var pArgs = {};
        if (args.command) {
            pArgs.command = args.command;
        }
        var readyRes = callEpo('core.help',pArgs);
        var md;
        var line;
        var cmd;
        var desc;

        if (args.command) {
            md = '#### ePO Help - ' + args.command + '\n';
            md += readyRes;
        } else {
            parsedRes = Array.isArray(parsedRes) ? parsedRes : [parsedRes];
            md = '#### ePO Help\n';
            for (var i=0;i<parsedRes.length;i++) {
                line = parsedRes[i];
                line = line.replace(/(\r\n|\n|\r)/gm," ");
                if (!args.search || (args.search.toLowerCase() && line.toLowerCase().indexOf(args.search.toLowerCase())>=0)) {
                    desc = line.split('-')[1] ? line.split('-')[1].trim() : 'N/A';
                    cmd = line.split('-')[0] ? line.split('-')[0].trim() : 'N/A';
                    md += '- **' + cmd + "** - " + desc + '\n';
                }
            }
        }

        return {Type: entryTypes.note, Contents: readyRes, ContentsFormat: formats.json, HumanReadable: md};
    };
    var epoGetDatUpdateTask = function() {
        var pArgs = {'searchText':'VSEContentUpdateDemisto'};
        var result = callEpo('clienttask.find', pArgs);
        if (result && Array.isArray(result)) {
            result = result[0];
        }
        return result.objectId;
    };

    var epoUpdateCLientDat = function() {
        var clientTask = epoGetDatUpdateTask();

        var pArgs = {'names':args.systems, 'productId':'EPOAGENTMETA', 'taskId':clientTask};

        var options = ['retryAttempts', 'retryIntervalInSeconds', 'abortAfterMinutes', 'stopAfterMinutes', 'randomizationInterval'];
        for (var i=0;i<options.length;i++) {
            if (args[options[i]]) {
                pArgs[options[i]] = args[options[i]];
            }
        }
        var result = callEpo('clienttask.run', pArgs);
        var md = "ePO client DAT update task started: " + result;
        return {Type: entryTypes.note, Contents: result, ContentsFormat: formats.json, HumanReadable: md};
    }
    var epoUpdateRepository = function() {
        var pArgs = {'sourceRepository':'McAfeeHttp','targetBranch':'Current'};
        var result = callEpo('repository.pull', pArgs);

        var md = "ePO repository update started.\n";
        md += result;
        return {Type: entryTypes.note, Contents: result, ContentsFormat: formats.json, HumanReadable: md};
    }
    var epoGetSystemTreeGroups = function () {
        var pArgs = {};
        if (args.search) {
            pArgs.searchText=args.search;
        }
        var result = callEpo('system.findGroups', pArgs);
        var md = "#### ePO System Tree groups\n";
        md += "Group ID | Group path\n-|-\n"
        for (var i=0;i<result.length;i++) {
            md += result[i].groupId + "|" + result[i].groupPath + "\n";
        }
        return {Type: entryTypes.note, Contents: result, ContentsFormat: formats.json, HumanReadable: md};
    }
    var epoGetSystemGroupPath = function(groupId) {
        var result = epoGetSystemTreeGroups();
        result = result.Contents;
        for (var i=0;i<result.length;i++) {
            if (groupId == result[i].groupId) {
                return result[i].groupPath;
            }
        }
        return null;
    }
    var epoGetCurrentDat = function () {
        var pArgs = {"searchText":"VSCANDAT1000"};
        var result = callEpo('repository.findPackages', pArgs);
        if (result && result.length>0) {
            result = result[0];
            var epoDAT = result.productDetectionProductVersion.split('.')[0];
            var ec = {};
            ec.mcafee = {epoDAT:epoDAT};
            var md = "McAfee ePO Current DAT file version in repository: **" + epoDAT + '**\n';
            return {Type: entryTypes.note, Contents: result, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
        } else {
            throw 'Error getting current DAT version. Response: ' + JSON.stringify(result);
        }
    }
    var epoFindSystems = function() {
        var name = epoGetSystemGroupPath(args.groupId);

        if (!name) {
            throw 'System Tree group not found';
        }
        var pArgs = {'groupId':args.groupId};
        var result = callEpo('epogroup.findSystems', pArgs);
        if (result) {
            var md = '#### Systems in '+name+'\n';
            if (result.length>0) {
                md += systemsToMd(result,args.verbose);
            } else {
                md += 'No systems found\n';
            }
            return {Type: entryTypes.note, Contents: result, ContentsFormat: formats.json, HumanReadable: md};
        } else {
            throw 'No systems found. Response: ' + JSON.stringify(result);
        }
    }
    var epoGetLatestDat = function() {
        var url = "http://update.nai.com/products/commonupdater/gdeltaavv.ini"
        //Another option is to use avvdat.ini - provided here in case any additional data from that file is needed in the future
        //var url = "http://update.nai.com/Products/CommonUpdater/avvdat.ini"
        result = doRawHttp("GET",url);
        var res = '';
        var sections = result.Body.split('\r\n\r\n');
        var lines = sections[0].split('\r\n');
        for (var i=0;i<lines.length;i++) {
            if (lines[i].indexOf("CurrentVersion")===0){
                return lines[i].split('=')[1];
            }
        }
        throw 'Cannot get McAfee latest DAT file version';
    }
    var epoCheckLatestDat = function() {
        var datVersion = epoGetLatestDat();
        var md='McAfee Latest DAT file version is **' + datVersion + '**\n';
        return {Type: entryTypes.note, Contents: {mcAfeeLatestDatVersion:datVersion}, ContentsFormat: formats.json, HumanReadable: md};
    }
    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            epoHelp();
            return 'ok';
        case 'epo-help':
            return epoHelp();
        case 'epo-get-latest-dat':
            return epoCheckLatestDat();
        case 'epo-get-current-dat':
            return epoGetCurrentDat();
        case 'epo-update-client-dat':
            return epoUpdateCLientDat();
        case 'epo-update-repository':
            return epoUpdateRepository();
        case 'epo-get-system-tree-group':
            return epoGetSystemTreeGroups();
        case 'epo-find-systems':
            return epoFindSystems();
        case 'epo-command':
            if (!args.command) {
                throw 'ePO error: command argument is missing';
            }
            var pArgs = {};
            for (var key in args) {
                if (key != 'command') {
                    pArgs[key] = args[key];
                }
            }
            var result = callEpo(args.command,pArgs);
            var md = "#### ePO command *"+args.command+"* results:\n";
            md += objToMd(result);
            result = (typeof result === 'string') ? {result:result} : result;
            return {Type: entryTypes.note, Contents: result, ContentsFormat: formats.json, HumanReadable: md};
        default:
            throw 'ePO Error: unknown command';
    }
  type: javascript
  commands:
  - name: epo-help
    arguments:
    - name: search
      default: true
      description: String to search in help
    - name: command
      description: Command to get help on
    description: print help on ePO commands
  - name: epo-get-latest-dat
    arguments: []
    outputs:
    - contentPath: mcAfeeLatestDatVersion
      contextPath: mcafee.latestDAT
      description: Latest McAfee DAT file version
    description: Check the latest DAT file in McAfee repository
  - name: epo-get-current-dat
    arguments: []
    outputs:
    - contextPath: mcafee.epoDAT
      description: Current McAfee DAT file in ePO repository
    description: check the existing DAT file version in ePO
  - name: epo-update-client-dat
    arguments:
    - name: systems
      required: true
      description: IP or system name. Can be comma separated list or system names
        or IP addresses
    - name: retryAttempts
      description: Number of times the server will attempt to send the task to the
        client. Defaults to 1.
    - name: retryIntervalInSeconds
      description: Retry interval in seconds. Defaults to 30.
    - name: abortAfterMinutes
      description: Maximum number of minutes before aborting all attempts. Defaults
        to 5.
    - name: stopAfterMinutes
      description: Maximum duration in minutes the client task is allowed to run.
        Defaults to 20.
    - name: randomizationInterval
      description: Duration in minutes over which to randomly spread task execution.
        Defaults to 0 (execute on all clients immediately).
    description: Run client task to update the DAT file
  - name: epo-update-repository
    arguments: []
    description: Trigger a Server Task in specific ePO servers to pull latest signatures
      from update server
  - name: epo-get-system-tree-group
    arguments:
    - name: search
      description: Search string for system tree group
    description: Get System Tree groups
  - name: epo-find-systems
    arguments:
    - name: groupId
      required: true
      default: true
      description: System Tree Group ID
    - name: verbose
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Print all system data
    description: Find systems in the System Tree - by group ID or by search
  - name: epo-command
    arguments: []
    description: Execute ePO command
