commonfields:
  id: KeyLight
  version: -1
name: KeyLight
display: KeyLight
category: Utilities
image: data:image/png;base64,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
description: Use LockPath KeyLight to manage tickets
detaileddescription: For more information regarding thee integrations specific fields,
  please advise the Cylance API Guide for version 1.7.
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Port
  name: port
  defaultvalue: "4443"
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |
    var server = params.server.replace(/[\/]+$/, '') + ':' + params.port + '/';

    var sendRequest = function(method, url, body, authCookies, recursive) {
        var httpParams = {
                Method: method,
                Headers: {
                    'Content-Type': ['application/xml;charset=utf-8']
                }
            };
        if (authCookies) {
            httpParams.Cookies = authCookies;
        }
        if (method !== 'GET' && body) {
            httpParams.Body = body;
        }
        var res = http(server + url, httpParams, params.insecure, params.proxy, undefined, true);
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            if (authCookies && !recursive) {
                sendRequest(
                    methodDictionary['logout'],
                    getUrl('logout'),
                    undefined,
                    loginCookies,
                    true);
            }
            throw 'Request to KeyLight URL ' + url + ' Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + x2j(res.Body) + '.';
        }
        return res;
    };

    var filtersFields = ['fieldPath', 'filterType', 'value'];

    var urlDictionary = {
        'login' : 'SecurityService/Login',
        'logout': 'SecurityService/Logout',
        'kl-get-component-list': 'ComponentService/GetComponentList',
        'kl-get-component': 'ComponentService/GetComponent',
        'kl-get-component-by-alias': 'ComponentService/GetComponentByAlias',
        'kl-get-field-list': 'ComponentService/GetFieldList',
        'kl-get-field': 'ComponentService/GetFieldList',
        'kl-get-record-count': 'ComponentService/GetRecordCount',
        'kl-get-record': 'ComponentService/GetRecord',
        'kl-get-records': 'ComponentService/GetRecords',
        'kl-delete-record': 'ComponentService/DeleteRecord',
        'kl-create-record': 'ComponentService/CreateRecord',
        'kl-update-record': 'ComponentService/UpdateRecord',
        'kl-get-detail-record': 'ComponentService/GetDetailRecord',
        'kl-get-lookup-report-column-fields': 'ComponentService/GetLookupReportColumnFields',
        'kl-get-detail-records': 'ComponentService/GetDetailRecords',
        'kl-get-record-attachment': 'ComponentService/GetRecordAttachment',
        'kl-get-record-attachments': 'ComponentService/GetRecordAttachments',
        'kl-delete-record-attachments': 'ComponentService/DeleteRecordAttachments'
    };

    var methodDictionary = {
        'login': 'POST',
        'logout': 'GET',
        'kl-get-component-list': 'GET',
        'kl-get-component': 'GET',
        'kl-get-component-by-alias': 'GET',
        'kl-get-field-list': 'GET',
        'kl-get-field': 'GET',
        'kl-get-record-count': 'POST',
        'kl-get-record': 'GET',
        'kl-get-records': 'POST',
        'kl-delete-record': 'DELETE',
        'kl-create-record': 'POST',
        'kl-update-record': 'POST',
        'kl-get-detail-record': 'GET',
        'kl-get-lookup-report-column-fields': 'GET',
        'kl-get-detail-records': 'GET',
        'kl-get-record-attachment': 'GET',
        'kl-get-record-attachments': 'GET',
        'kl-delete-record-attachments': 'POST'
    };

    var bodyDictionary = {
        'login': '<Login><username>%username%</username><password>%password%</password></Login>',
        'kl-get-record-count': '<GetRecordCount><componentId>%componentID%</componentId>%filters%</GetRecordCount>',
        'kl-get-records': '<GetRecords><componentId>%componentID%</componentId><pageIndex>%pageIndex%</pageIndex><pageSize>%pageSize%</pageSize>%filters%</GetRecords>',
        'kl-delete-record': '<DeleteRecord><componentId>%componentID%</componentId><recordId>%recordId%</recordId></DeleteRecord>',
        'kl-create-record': '<CreateRecord><componentId>%componentID%</componentId>%values%</CreateRecord>',
        'kl-update-record': '<UpdateRecord><componentId>%componentID%</componentId>%values%</UpdateRecord>',
        'kl-delete-record-attachments': '<DeleteRecordAttachments><componentId>%componentID%</componentId>%values%</DeleteRecordAttachments>'
    };

    var createFiltersFromArgs = function(args) {
        var res = replaceInTemplates(!!args.value ?
                '<filters><SearchCriteriaItem><FieldPath><int>%field-path%</int>/FieldPath><FilterType>%filter-type%</FilterType></SearchCriteriaItem></filters>' :
                '<filters><SearchCriteriaItem><FieldPath><int>%field-path%</int>/FieldPath><FilterType>%filter-type%</FilterType><Value>%value%</Value></SearchCriteriaItem></filters>',
            args)
        for (var i = 0; i < filtersFields.length; i++) {
            delete(args[filtersFields[i]]);
        }
        return res;
    }

    var createValuesFromArgs = function(values, id) {
        var res = '';
        for (var i = 0; i < values.length; i++) {
            res += replaceInTemplates(values[i].value === 'nil' ?
                    '<KeyValuePair><key>%key%</key><value i:nil="true"/></KeyValuePair>' :
                    '<KeyValuePair><key>%key%</key><value i:type="a:%type%">%value%</value></KeyValuePair>',
                args)
        }
        return '<dynamicRecord xmlns:i="http://www.w3.org/2001/XMLSchema-instance" xmlns:a="http://www.w3.org/2001/XMLSchema">'+
                    '<FieldValues>'+
                        (id ? '<Id>' + id + '</Id>' : '')+
                        res +
                    '</FieldValues>'+
                '</dynamicRecord>';
    }

    var includeRecord = ['kl-create-record', 'kl-update-record', 'kl-delete-record-attachments'];

    var buildBodyForCommand = function(command, args) {
        var keys = Object.keys(args);
        var filters;
        for (var i = 0; i < filtersFields.length && !filters; i++) {
            if (keys.indexOf(filtersFields[i]) !== -1) {
                filters = createFiltersFromArgs(args);
                args.filters = filters;
            }
        }
        if (!args.filters) {
            args.filters = '';
        }

        if (includeRecord.indexOf(command) !== -1) {
            var values = args.values && JSON.parse(args.values);
            if (command === 'kl-delete-record-attachments') {
                values = [{type: 'DynamicRecordList', key: args.fieldId, value: '<Record><Id>' + args.attachmentId + '</Id></Record>'}];
            }
            args.values = createValuesFromArgs(values, args.id);
        }
        return replaceInTemplates(bodyDictionary[command], args);
    }

    var filterFields = ['field-path', 'filter-type', 'value'];

    var getUrl = function(command, args) {
        return urlDictionary[command] + (methodDictionary[command] === 'GET' ? encodeToURLQuery(args) : '');
    }

    var createBody = function(command, args) {
        return bodyDictionary[command] ? replaceInTemplates(bodyDictionary[command], args) : undefined;
    }

    var sendRequestAndParse = function(method, url, body, cookies) {
        var res = sendRequest(method, url, body, cookies).Body;
        return JSON.parse(x2j(res));
    }

    var loginCookies = sendRequest(
        methodDictionary['login'],
        getUrl('login'),
        createBody('login', {username: params.credentials.identifier, password: params.credentials.password})
        ).Cookies;
    var result;
    switch (command) {
        case 'test-module':
            result = 'something is wrong';
            if (loginCookies) {
                result = 'ok';
            }
            break;
        case 'kl-get-record-attachment':
            result = saveFile(sendRequest(
                    methodDictionary[command],
                    getUrl(command),
                    createBody(command, args),
                    loginCookies).
                Body);
            break;
        default:
            result = sendRequestAndParse(
                methodDictionary[command],
                getUrl(command),
                createBody(command, args),
                loginCookies);
    }
    if (loginCookies) {
        // if we managed to log in, log out
        sendRequest(
            methodDictionary['logout'],
            getUrl('logout'),
            undefined,
            loginCookies);
    }
    return result;
  type: javascript
  commands:
  - name: kl-get-component-list
    arguments: []
    description: Returns a complete list of all Keylight components available to the
      user based on account permissions
  - name: kl-get-component
    arguments:
    - name: id
      required: true
      default: true
      description: The ID of the desired component
    description: Retrieves a component specified by its ID
  - name: kl-get-component-by-alias
    arguments:
    - name: alias
      required: true
      default: true
      description: The Alias of the desired component
    description: Retrieves a component specified by its Alias
  - name: kl-get-field-list
    arguments:
    - name: componentId
      required: true
      default: true
      description: The ID of the desired component
    description: Retrieves detail field listing for a component specified by its ID
  - name: kl-get-field
    arguments:
    - name: id
      required: true
      default: true
      description: The field ID for the individual field within the component
    description: Retrieves details for a field specified by its ID
  - name: kl-get-record-count
    arguments:
    - name: componentID
      required: true
      default: true
      description: The ID of the desired component
    - name: fieldPath
      description: Describes the field ID for the column that the records will be
        filtered on
    - name: filterType
      description: Describes the ID for the filter being implemented
    - name: value
      description: Matches value (if applicable)
    description: ' Return the number of records in a given component'
  - name: kl-get-record
    arguments:
    - name: componentId
      required: true
      default: true
      description: ID of the desired component
    - name: recordId
      description: ID for the individual record within the component
    description: Returns the complete set of fields for a given record within a component
  - name: kl-get-records
    arguments:
    - name: componentID
      description: The ID of the desired component
    - name: pageIndex
      description: The index of the page of result to return. Must be > 0
    - name: pageSize
      description: The size of the page results to return. Must be >= 1
    - name: fieldPath
      description: Describes the field ID for the column that the records will be
        filtered on
    - name: filterType
      description: Describes the ID for the filter being implemented
    - name: value
      description: Matches value (if applicable)
    description: Return the title/default field for a set of records within a chosen
      component
  - name: kl-delete-record
    arguments:
    - name: componentID
      description: ID of the desired component
    - name: recordId
      description: ID for the individual record within the component
    description: Delete a selected record from within a chosen component
  - name: kl-create-record
    arguments:
    - name: componentId
      required: true
      default: true
      description: The ID of the desired component
    - name: values
      required: true
      description: A list of key-value-type triplets in a JSON format. Type will be
        used only if value is not nil
    description: Create a new record within the specified component of the Keylight
      application
  - name: kl-update-record
    arguments:
    - name: componentId
      required: true
      default: true
      description: The ID of the desired component
    - name: values
      required: true
      description: A list of key-value-type triplets in a JSON format. Type will be
        used only if value is not nil
    - name: id
      required: true
      description: Record id
    description: Update an existing record within the specified component of the Keylight
      application
  - name: kl-get-detail-record
    arguments:
    - name: componentID
      required: true
      default: true
      description: ID of the desired component
    - name: recordId
      required: true
      description: ID for the individual record within the component
    description: Retrieves record information based on the provided component ID and
      record ID, with lookup field report details
  - name: kl-get-lookup-report-column-fields
    arguments:
    - name: lookupFieldId
      required: true
      default: true
      description: ID of the desired lookup field
    - name: fieldPathId
      required: true
      description: ID for the desired lookup field path
    description: Gets the field information of each field in a field path that corresponds
      to a lookup report column
  - name: kl-get-detail-records
    arguments:
    - name: componentID
      required: true
      description: ID of the desired component
    - name: pageIndex
      description: The index of the page of result to return. Must be > 0
    - name: pageSize
      description: The size of the page results to return. Must be >= 1
    description: GetDetailRecords provides the ability to run a search with filters
      and paging (GetRecords) while returning a high level of detail for each record
      (GetRecord)
  - name: kl-get-record-attachments
    arguments:
    - name: componentID
      required: true
      description: ID of the desired component
    - name: recordId
      required: true
      description: ID for the individual record within the component
    - name: fieldId
      required: true
      description: ' ID for the individual field within the component'
    description: Gets information for all attachments associated with the provided
      component ID, record ID, and Documents field id. No file data is returned, only
      file name, field ID, and document ID information
  - name: kl-get-record-attachment
    arguments:
    - name: componentID
      required: true
      default: true
      description: ID of the desired component
    - name: recordId
      required: true
      description: ID for the individual record within the component
    - name: fieldId
      required: true
      description: ID for the individual field within the component
    - name: documentId
      required: true
      description: ID for the individual document within the component
    description: Gets a single attachment associated with the provided component ID,
      record ID, documents field ID, and document ID
  - name: kl-delete-record-attachments
    arguments:
    - name: componentID
      required: true
      default: true
      description: ID of the desired component
    - name: id
      required: true
      description: ID for the individual record within the component
    - name: fieldId
      required: true
      description: ID for the individual field within the component
    - name: attachmentId
      required: true
      description: ID for the individual attachment within the component
    description: Deletes the specified attachments from the provided document fields
      on a specific record
