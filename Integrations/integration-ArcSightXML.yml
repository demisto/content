commonfields:
  id: ArcSight XML
  version: -1
name: ArcSight XML
display: ArcSight XML
category: Analytics & SIEM
description: Create incidents and updates cases of ArcSight ESM SIEM through XML files. By Micro Focus (Formerly HPE Software).
image: data:image/png;base64,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
configuration:
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Directory from which to get XML files and create incidents.
  name: inputDirPath
  defaultvalue: ""
  type: 0
  required: true
- display: Directory to which put command XML files.
  name: commandsDirPath
  defaultvalue: ""
  type: 0
  required: true
script:
  script: |+
    import glob
    import xml.etree.ElementTree as ET
    import lxml.etree
    import datetime
    import json
    import os

    SECURITY_EVENT_START_TAG = '<SecurityEvent id="%s"'
    SECURITY_EVENT_END_TAG = '</SecurityEvent>'

    LIST_CASE_ENTRIES = ['caseEvents', 'childOf', 'ownedBy']
    TIME_CASE_ENTRIES = ['detectionTime', 'estimatedStartTime']

    SYSTEM = ''
    URI_PREFIX = ''
    TOREPLACE = '\\"\\<\\>\\(\\)'

    XML_TEMPLATE = """<?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE archive SYSTEM "../../schema/xml/archive/arcsight-archive.dtd">
    <archive buildVersion="6.9.1.2195.0" buildTime="2-9-2016_19:0:8" createTime="{0}">
        <ArchiveCreationParameters>
            <action>insert</action>
            <format>xml.external.case</format>
            <include>
                <list>
                    <ref type="Case" uri="{2}" id="{1}"/>
                </list>
            </include>
        </ArchiveCreationParameters>
        <Case id="{1}" name="{3}" action="insert" >
            <stage>{4}</stage>
        </Case>
    </archive>"""

    FILENAME_TEMPLATE = 'ExternalEventTrackingData_{0}.xml'


    def ref_to_dict(item):
        return {'type': item.get('type'), 'uri': item.get('uri'), 'id': item.get('id')}


    def build_case_data(case):
        case_data = {case_child.tag: case_child.text for case_child in case}

        # fix timestamp entries
        for name in TIME_CASE_ENTRIES:
            if name in case_data:
                case_data[name] = str(datetime.datetime.fromtimestamp(int(case_data[name]) / 1000))

        # fix list entries
        for name in LIST_CASE_ENTRIES:
            list_entry = case.find(name)
            if list_entry is not None:
                case_data[name] = json.dumps([ref_to_dict(item) for item in list_entry[0]])

        # convert to a list of 'type' and 'value'
        case_data = [{'type': key, 'value': value} for key, value in case_data.iteritems()]

        return case_data


    def create_incidents(names, all_labels, all_details):
        incidents = []
        # for labels, details in zip(all_labels, all_details):
        for i in xrange(len(names)):
            incident = {
                'Name': names[i],
                'Labels': all_labels[i],
                'Details': all_details[i],
                'RawJSON': xml2json(all_details[i])
            }

            incidents.append(incident)

        return incidents


    def parse_arcsight_xml(filepath):
        with open(filepath, 'rb') as f:
            xml_content = f.read()

        tree = ET.parse(filepath)
        root = tree.getroot()

        security_events = root.findall('SecurityEvent')
        case_names = []
        all_cases = []
        all_events = []
        for case in root.findall('Case'):
            case_names.append(case.get('name'))
            case_data  = build_case_data(case)
            event_ids = [event_ref.get('id') for event_ref in case.find('caseEvents')[0]]
            events_xml = []
            for event_id in event_ids:
                start_index = xml_content.find(SECURITY_EVENT_START_TAG % (event_id))
                end_index = start_index + xml_content[start_index:].find(SECURITY_EVENT_END_TAG) + len(SECURITY_EVENT_END_TAG)
                events_xml.append('   ' + xml_content[start_index : end_index])

            case_events = '\n\n'.join(events_xml)

            all_cases.append(case_data)
            all_events.append(case_events)

        os.remove(filepath)

        return create_incidents(case_names, all_cases, all_events)


    def get_incidents_from_xmls():
        filepaths = glob.glob(os.path.join(demisto.params()['inputDirPath'], '*.xml'))
        incidents = []
        for filepath in filepaths:
            incidents += parse_arcsight_xml(filepath)

        return incidents


    def create_file_locally(data, filepath):
        with open(filepath, 'w') as f:
            f.write(data)


    def update_case():
        case_id = demisto.args()['caseId']
        name = demisto.args()['name']
        stage = demisto.args()['stage']
        uri = URI_PREFIX + demisto.args()['name']
        now = time.strftime('%m-%d-%Y_%H-%M-%S.000')

        filename = FILENAME_TEMPLATE.format(now)
        filepath = os.path.join(demisto.params()['commandsDirPath'], filename)
        data = XML_TEMPLATE.format(now, case_id, uri, name, stage)

        create_file_locally(data, filepath)

        demisto.results('Modified stage to %s in case %s.' % (stage, case_id))


    if demisto.command() == 'test-module':
        demisto.results('ok')
        sys.exit(0)

    elif demisto.command() == 'fetch-incidents':
        incidents = get_incidents_from_xmls()
        demisto.incidents(incidents)
        sys.exit(0)

    elif demisto.command() == 'arcsight-update-case':
        update_case()

  type: python
  commands:
  - name: arcsight-update-case
    arguments:
    - name: caseId
      required: true
      description: ID of the case.
    - name: name
      required: true
      description: Name of the case.
    - name: stage
      required: true
      description: The stage of the case.
    description: Create an XML to update a case.
  isfetch: true
hidden: false
releaseNotes: "-"