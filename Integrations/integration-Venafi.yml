commonfields:
  id: Venafi
  version: -1
name: Venafi
system: true
display: Venafi
category: IT Services
image: data:image/png;base64,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
description: Manage certificates using Venafi
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |
    var server = params.server.replace(/[\/]+$/, '');
    var username = params.credentials.identifier;
    var password = params.credentials.password;
    var insecure = params.insecure;
    var proxy = params.proxy;

    var sendRequest = function(method, url, body, apiKey) {
        var httpParams = {
                Method: method,
                Headers: {
                    'Content-Type': ['application/json'],
                    'X-Venafi-Api-Key': [apiKey]
                }
            };
        if (!apiKey) {
            delete(httpParams.Headers['X-Venafi-Api-Key']);
        }
        if (body) {
            httpParams.Body = body;
        }
        var res = http(server + url, httpParams, insecure, proxy, false);

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request to Venafi Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }
        return JSON.parse(res.Body);
    };

    var auth = sendRequest('POST', '/VedSDK/Authorize/', JSON.stringify({ Username: username, Password: password }));
    switch (command) {
        case 'test-module':
            if (auth) {
                return 'ok';
            }
            return 'something is wrong';
        case 'venafi-get-certificates':

            var raw = sendRequest('GET', '/vedsdk/certificates/' + encodeToURLQuery(args), undefined, auth.APIKey);

            var certs = [];
            for (var i in raw.Certificates) {
                certs.push({
                    CreatedOn: raw.Certificates[i].CreatedOn,
                    DN: raw.Certificates[i].DN,
                    Name: raw.Certificates[i].Name,
                    ParentDN: raw.Certificates[i].ParentDn,
                    SchemaClass: raw.Certificates[i].SchemaClass,
                    ID: raw.Certificates[i].Guid.substring(1, raw.Certificates[i].Guid.length - 1),
                });
            }
            var ec = {
                'Venafi.Certificats(val.ID==obj.ID)': certs,
                'Venafi.Certificate(val.ID==obj.ID)': certs
            };
            entry = {
                Type: entryTypes.note,
                Contents: raw,
                ContentsFormat: formats.json,
                ReadableContentsFormat: formats.markdown,
                EntryContext: ec,
                HumanReadable: tableToMarkdown('Venafi certificats query response', certs),
            };
            return entry;
        case 'venafi-get-details':

            var raw = sendRequest('GET', '/vedsdk/certificates/' + args.guid, undefined, auth.APIKey);
            raw.ParentDN = raw.ParentDn
            raw.ID = raw.Guid.substring(1, raw.Guid.length - 1)
            ec = {
                'Venafi.Certificate(val.ID==obj.ID)': raw
            }
            return JSON.stringify(raw)
            entry = {
                Type: entryTypes.note,
                Contents: raw,
                ContentsFormat: formats.json,
                ReadableContentsFormat: formats.markdown,
                EntryContext: ec,
                HumanReadable: tableToMarkdown('Venafi certificats details', raw),
            };
            return entry;
        default:
            throw 'No can do';
    }
  type: javascript
  commands:
  - name: venafi-get-certificates
    arguments:
    - name: CreatedOn
      description: Exact date and time on which the certificate object was created
    - name: CreatedOnGreater
      description: Certificate objects created after this date and time
    - name: CreatedOnLess
      description: Certificate objects created before this date and time
    - name: Disabled
      description: Include only certificates that are disabled (1) or enabled (0)
    - name: InError
      description: Include only certificates that are in an error state (1) or not
        in an error state (0)
    - name: ValidationState
      auto: PREDEFINED
      predefined:
      - Blank
      - Success
      - Failure
      description: Validation state of Blank, Success, or Failure
    - name: ManagementType
      auto: PREDEFINED
      predefined:
      - Unassigned
      - Monitoring
      - Enrollment
      - Provisioning
      description: Management type of Unassigned, Monitoring, Enrollment, or Provisioning
    - name: Name
      description: Name of the certificate object
    - name: NetworkValidationDisabled
      description: Include only certificates with network validation disabled (1)
        or enabled (0)
    - name: ParentDn
      description: ParentDn One or more folders in which to search for certificates
        (e.g., \VED\Policy\Engineering,\VED\Policy\HR)
    - name: ParentDnRecursive
      description: Certificates within a specific folder and its subfolders. Accepts
        a single value
    - name: PendingWorkflow
      description: Include only certificates that are pending workflow resolution
        (have an outstanding workflow ticket). This parameter does not require a value
        to be specified
    - name: Stage
      description: Certificates at one or more stages in the certificate lifecycle.
        Accepts multiple comma separated values
    - name: StageGreater
      description: Certificates with a stage greater than the specified stage (does
        not include specified stage)
    - name: StageLess
      description: Certificates a stage less than the specified stage.
    - name: ValidationDisabled
      description: Include only certificates with validation disabled (1) or enabled
        (0)
    - name: C
      description: Country attribute of Subject DN
    - name: CN
      description: Common name attribute of Subject DN
    - name: Issuer
      description: Issuer DN. Note, since most Issuer DNs include commas between DN
        components, it is important to surround the complete Issuer DN within double
        quotes (“). In addition, if the Issuer DN includes double quotes, each double
        quote should be prefixed by another double quote
    - name: KeyAlgorithm
      description: Algorithm for the public key in the certificate (e.g., RSA, DSA)
    - name: KeySize
      description: Size of the public key in the certificate (e.g., 2048). Accepts
        multiple comma separated values
    - name: KeySizeGreater
      description: Key size greater than the specified value
    - name: KeySizeLess
      description: Key size less than the specified value
    - name: L
      description: Locality/City attribute of Subject DN in certificates
    - name: O
      description: Organization attribute of Subject DN in certificates
    - name: S
      description: State/Province attribute of Subject DN in certificates
    - name: Serial
      description: Serial number of the certificate
    - name: SignatureAlgorithm
      description: The algorithm used to sign the certificate (e.g. SHA1RSA)
    - name: ValidFrom
      description: Date on which the certificate was issued (e.g., 2015- 10-08T19:15:35.6431456Z
        or 2015-10-08)
    - name: ValidTo
      description: Date on which the certificate expires (e.g., 2015-10- 08T19:15:35.6431456Z
        or 2015-10-08)
    - name: ValidToGreater
      description: Certificates that expire after the specified date
    - name: ValidToLess
      description: Certificates that expire before the specified date
    - name: guid
      description: Certificate Guid
    outputs:
    - contextPath: Venafi.Certificate.CreatedOn
      description: Certificate creation date
      type: date
    - contextPath: Venafi.Certificate.DN
      description: Certificate DN
      type: string
    - contextPath: Venafi.Certificate.Name
      description: Certificate name
      type: string
    - contextPath: Venafi.Certificate.ParentDN
      description: Certificate parent DN
      type: string
    - contextPath: Venafi.Certificate.SchemaClass
      description: Certificate schema
      type: string
    - contextPath: Venafi.Certificate.ID
      description: Certificate ID (GUID)
      type: string
    description: Get Venafi certificates query. All dates are in the 2016-11-12T00:00:00.0000000Z
      format. Additional fields can be used in the query by adding them in a key=value
      manner
  - name: venafi-get-certificate-details
    arguments:
    - name: guid
      required: true
      description: Certificate GUID to get details of
    outputs:
    - contextPath: Venafi.Certificate.ID
      description: Certificate ID (GUID)
      type: string
    - contextPath: Venafi.Certificate.ParentDN
      description: Certificate parent DN
      type: string
    - contextPath: Venafi.Certificate.CreatedOn
      description: Certificate creation date
      type: date
    - contextPath: Venafi.Certificate.DN
      description: Certificate DN
      type: string
    - contextPath: Venafi.Certificate.Name
      description: Certificate name
      type: string
    - contextPath: Venafi.Certificate.SchemaClass
      description: Certificate schema
      type: string
    - contextPath: Venafi.Certificate.Approver
      description: Certificate approver
      type: string
    - contextPath: Venafi.Certificate.CertificateAuthorityDN
      description: Certificate authority DN
      type: string
    - contextPath: Venafi.Certificate.Contact
      description: Certificate contacts
      type: string
    - contextPath: Venafi.Certificate.Description
      description: Certificate description
      type: string
    - contextPath: Venafi.Certificate.ManagedBy
      description: Certificate manager
      type: string
    - contextPath: Venafi.Certificate.ManagementType
      description: Certificate management type
      type: string
    - contextPath: Venafi.Certificate.CertificateDetails.AIAKeyIdentifier
      description: Certificate AIA key identifier
      type: string
    - contextPath: Venafi.Certificate.CertificateDetails.Issuer
      description: Certificate issuer
      type: string
    - contextPath: Venafi.Certificate.CertificateDetails.Serial
      description: Certificate serial
      type: string
    - contextPath: Venafi.Certificate.CertificateDetails.Subject
      description: Certificate subject
      type: string
    - contextPath: Venafi.Certificate.CertificateDetails.Thumbprint
      description: Certificate thumbprint
      type: string
    - contextPath: Venafi.Certificate.CertificateDetails.ValidFrom
      description: Certificate validation start date
      type: string
    - contextPath: Venafi.Certificate.CertificateDetails.ValidTo
      description: Certificate validation end time
      type: string
    description: Use a certificate guid to extract more details from the cert store.
releaseNotes: "Added venafi-get-certificate-details command and improved venafi-get-certificates command outputs"
tests:
- Forgive me for my sins but I did not create any test
