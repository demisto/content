commonfields:
  id: Microsoft Graph User
  version: -1
name: Microsoft Graph User
display: Microsoft Graph User
category: Analytics & SIEM
image: data:image/png;base64,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
description: Unified gateway to manage users in Microsoft Active Directory enabled
  by Microsoft Graph User APIs.
detaileddescription: |-
  To allow us access to the user graph, an admin has to approve our app using an admin consent flow. To generate an admin link, please run`!ms-graph-admin-url`command in your playground and then specify the tenant.
  To be able to generate tokens, please open support ticket with Demisto support and provide the tenant id received in the admin consent flow above.
configuration:
- display: Host URL (e.g. https://graph.microsoft.com)
  name: host
  defaultvalue: https://graph.microsoft.com
  type: 0
  required: true
- display: The tenant ID as received from the admin consent - see detailed instructions
    (?)
  name: tenant
  defaultvalue: ""
  type: 0
  required: false
- display: The token received from Demisto support to allow access to generate MS
    tokens
  name: token
  defaultvalue: ""
  type: 4
  required: false
- display: Trust any certificate (unsecure)
  name: unsecure
  defaultvalue: "true"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "false"
  type: 8
  required: false
script:
  script: |-
    import requests
    import urllib
    from datetime import datetime, timedelta

    if not demisto.params()['proxy']:
        del os.environ['HTTP_PROXY']
        del os.environ['HTTPS_PROXY']
        del os.environ['http_proxy']
        del os.environ['https_proxy']

    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    ''' GLOBAL VARS '''
    SERVER = demisto.params()['host'][:-1] if demisto.params()['host'].endswith('/') else demisto.params()['host']
    BASE_URL = SERVER + '/v1.0/'
    TENANT = demisto.params()['tenant']
    TOKEN = demisto.params()['token']
    USE_SSL = not demisto.params().get('unsecure', False)

    ''' HELPER FUNCTIONS '''
    def epoch_seconds(d=None):
        """
        Return the number of seconds for given date. If no date, return current.
        """
        if not d:
            d = datetime.utcnow()
        return int((d - datetime.utcfromtimestamp(0)).total_seconds())

    def get_timestamp(time_description):
        if time_description == 'Last24Hours':
            time_delta = 1
        elif time_description == 'Last48Hours':
            time_delta = 2
        else:
            time_delta = 7
        return datetime.strftime(datetime.now() - timedelta(time_delta), '%Y-%m-%d')

    def get_token():
        """
        Check if we have a valid token and if not get one
        """
        if not TENANT:
            return_error('Please make sure to approve the app and specify the tenant')
        ctx = demisto.getIntegrationContext()
        if ctx.get('token') and ctx.get('stored'):
            if epoch_seconds() - ctx.get('stored') < 60 * 60 - 30:
                return ctx.get('token')
        r = requests.get('https://demistobot.demisto.com/ms-token',
                        params={'tenant': TENANT},
                        headers={
                            'Authorization': TOKEN,
                            'Accept': 'application/json'
                        })
        data = r.json()
        if r.status_code != requests.codes.ok:
            return_error('Error: %s\nDescription:%s' % (data.get('title'), data.get('detail')))
        demisto.setIntegrationContext({'token': data.get('token'), 'stored': epoch_seconds()})
        return data.get('token')

    def http_request(method, url_suffix, json=None, params=None):
        """
        Generic request to the graph
        """
        token = get_token()
        r = requests.request(
            method,
            BASE_URL + url_suffix,
            json=json,
            params=params,
            headers={
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        )
        if r.status_code not in {200, 201, 202, 204}:
            return_error('Error in API call to Microsoft Graph [%d] - %s' % (r.status_code, r.text))
        if not r.text:
            return {}
        return r.json()

    ''' FUNCTIONS '''
    def get_users_command():
        users = get_users()['value']
        outputs = []
        for user in users:
            outputs.append({
                'Name': user['displayName'],
                'Title': user['jobTitle'],
                'Email': user['userPrincipalName'],
                'MailIsEnabled': user.get('mail', None) is not None,
                'Id': user['id']
            })
        entry = {
            'Type': entryTypes['note'],
            'Contents': users,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Microsoft Graph - Get Users', outputs,
                ['Name', 'Title', 'Email', 'Id', 'MailIsEnabled'], removeNull=True),
            'EntryContext': {'MsGraph.User(val.Id && val.Id === obj.Id)': outputs}
        }
        demisto.results(entry)

    def get_users():
        cmd_url = 'users'
        response = http_request('GET', cmd_url)
        return response

    def get_user_command():
        userId = demisto.args().get('userId')
        raw_user = get_user(userId)
        user = {
            'Name': raw_user['displayName'],
            'Title': raw_user['jobTitle'],
            'Email': raw_user['userPrincipalName'],
            'Department': raw_user.get('department'),
            'Phone': raw_user.get('mobilePhone'),
            'Id': raw_user['id'],
            'MailIsEnabled': raw_user.get('mail', None) is not None
        }
        entry = {
            'Type': entryTypes['note'],
            'Contents': raw_user,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Microsoft Graph - Get User', user, ['Name', 'Title', 'Department', 'Email', 'Phone', 'MailIsEnabled', 'Id'], removeNull=True),
            'EntryContext': {'MsGraph.User(val.Id && val.Id === obj.Id)': user}
        }
        demisto.results(entry)

    def get_user(userId):
        cmd_url = 'users/' + userId
        response = http_request('GET', cmd_url)
        return response

    def create_user_command():
        displayName = demisto.args().get('displayName')
        password = demisto.args().get('password')
        mailNickname = demisto.args().get('mailNickname')
        accountEnabled = demisto.args().get('accountEnabled')
        userPrincipalName = demisto.args().get('userPrincipalName')
        onPremisesImmutableId = demisto.args().get('onPremisesImmutableId')
        response = create_user(displayName, password, mailNickname, accountEnabled, userPrincipalName, onPremisesImmutableId)
        user = {
            'Email': response['userPrincipalName'],
            'Id': response['id'],
            'MailIsEnabled': response.get('mail', None) is not None
        }
        entry = {
            'Type': entryTypes['note'],
            'Contents': response,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Microsoft Graph - Create User', user, ['Id', 'Email', 'Enabled'], removeNull=True),
            'EntryContext': {'MsGraph.User(val.Id && val.Id === obj.Id)': user}
        }
        demisto.results(entry)

    def create_user(displayName, password, mailNickname, accountEnabled, userPrincipalName, onPremisesImmutableId):
        cmd_url = 'users/'
        data = {
            "accountEnabled": accountEnabled,
            "displayName": displayName,
            "mailNickname": mailNickname,
            "userPrincipalName": userPrincipalName,
            "passwordProfile" : {
                "forceChangePasswordNextSignIn": True,
                "password": password
            }
        }
        if onPremisesImmutableId:
            data['onPremisesImmutableId'] = onPremisesImmutableId
        response = http_request('POST', cmd_url, json=data)
        return response

    def delete_user_command():
        userId = demisto.args().get('userId')
        response = delete_user(userId)
        output = {
            'Id': userId,
            'Action': 'deleted'
        }
        entry = {
            'Type': entryTypes['note'],
            'Contents': "User - {} has been deleted.".format(userId),
            'ContentsFormat': formats['text'],
            'EntryContext': {'MsGraph.User(val.Id && val.Id === obj.Id)': output}
        }
        demisto.results(entry)

    def delete_user(userId):
        cmd_url = '/users/' + userId
        response = http_request('DELETE', cmd_url)
        return response

    def update_user_command():
        userId = demisto.args().get('userId')
        displayName = demisto.args().get('displayName')
        password = demisto.args().get('password')
        mailNickname = demisto.args().get('mailNickname')
        accountEnabled = demisto.args().get('accountEnabled')
        userPrincipalName = demisto.args().get('userPrincipalName')
        jobTitle = demisto.args().get('jobTitle')
        department = demisto.args().get('department')
        city = demisto.args().get('city')
        response = update_user(userId, displayName, password, mailNickname, accountEnabled, userPrincipalName, jobTitle, department, city)
        output = {
            'Id': response['id'],
            'MailIsEnabled': response.get('mail', None) is not None,
            'Email': response['userPrincipalName']
        }
        entry = {
            'Type': entryTypes['note'],
            'Contents': "User - {} has been updated.".format(userId),
            'ContentsFormat': formats['text'],
            'EntryContext': {'MsGraph.User(val.Id && val.Id === obj.Id)': output}
        }
        demisto.results(entry)

    def update_user(userId, displayName, password, mailNickname, accountEnabled, userPrincipalName, jobTitle, department, city):
        cmd_url = 'users/' + userId
        data = {}
        if displayName:
            data['displayName'] = displayName
        if password:
            data['passwordProfile'] = {"forceChangePasswordNextSignIn": True,"password": password}
        if mailNickname:
            data['mailNickname'] = mailNickname
        if accountEnabled:
            data['accountEnabled'] = accountEnabled
        if userPrincipalName:
            data['userPrincipalName'] = userPrincipalName
        if jobTitle:
            data['jobTitle'] = jobTitle
        if department:
            data['department'] = department
        if city:
            data['city'] = city
        response = http_request('PATCH', cmd_url, json=data)
        return response

    def generate_url():
        u = 'https://login.microsoftonline.com/common/adminconsent?' + urllib.urlencode({
            'client_id': 'd96bc816-4e4c-4d71-8aef-299d312db20d',
            'state': '1q2w3e4r',
            'redirect_uri': 'https://demistobot.demisto.com/ms'
        })
        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': {'url': u},
            'HumanReadable': '[%s](%s)' % (u, u)
        })
    ''' EXECUTION CODE '''

    LOG('command is %s' % (demisto.command(), ))

    try:
        if demisto.command() == 'test-module':
            http_request('GET', 'users', {'$select': 'displayName'})
            demisto.results('ok')

        elif demisto.command() == 'msg-graph-admin-url':
            generate_url()

        elif demisto.command() == 'msg-get-users':
            get_users_command()

        elif demisto.command() == 'msg-get-user':
            get_user_command()

        elif demisto.command() == 'msg-create-user':
            create_user_command()

        elif demisto.command() == 'msg-delete-user':
            delete_user_command()

        elif demisto.command() == 'msg-update-user':
            update_user_command()

    except Exception, e:
        LOG(e.message)
        LOG.print_log()
        raise
  type: python
  commands:
  - name: msg-graph-admin-url
    arguments: []
    description: Generate URL for admin consent to approve our app.
  - name: msg-get-users
    arguments: []
    outputs:
    - contextPath: MsGraph.User.Email
      description: User email address
      type: string
    - contextPath: MsGraph.User.Id
      description: User ID
      type: string
    - contextPath: MsGraph.User.Title
      description: User job title
      type: string
    - contextPath: MsGraph.User.Name
      description: User name
      type: string
    - contextPath: MsGraph.User.MailIsEnabled
      description: Indicate whether mail service of the account is enabled or disabled.
      type: boolean
    description: Retrieve all users.
  - name: msg-get-user
    arguments:
    - name: userId
      required: true
      default: true
      description: The User Id or User Email of the existing user to retrieve.
    outputs:
    - contextPath: MsGraph.User.Email
      description: User email address
      type: string
    - contextPath: MsGraph.User.Id
      description: User ID
      type: string
    - contextPath: MsGraph.User.Title
      description: User job title
      type: string
    - contextPath: MsGraph.User.Name
      description: User name
      type: string
    - contextPath: MsGraph.User.MailIsEnabled
      description: Indicate whether mail service of the account is enabled or disabled.
      type: boolean
    description: Retrieve detailed information of a user.
  - name: msg-create-user
    arguments:
    - name: displayName
      required: true
      description: The name to display in the address book for the user.
    - name: userPrincipalName
      required: true
      description: The user principal name (UPN) of the user. The UPN is an Internet-style
        login name for the user based on the Internet standard RFC 822. By convention,
        this should map to the user's email name. The general format is alias@domain,
        where domain must be present in the tenant’s collection of verified domains.
    - name: mailNickname
      required: true
      description: The mail alias for the user.
    - name: password
      required: true
      description: The password for the user.
    - name: onPremisesImmutableId
      description: Only needs to be specified when creating a new user account if
        you are using a federated domain for the user's userPrincipalName (UPN) property.
    - name: accountEnabled
      default: true
      description: Indicate whether the account is enabled or disabled, the default
        value is true.
      defaultValue: "true"
    outputs:
    - contextPath: MsGraph.User.Email
      description: User email address
      type: string
    - contextPath: MsGraph.User.Id
      description: User ID
      type: string
    - contextPath: MsGraph.User.MailIsEnabled
      description: Indicate whether mail service of the account is enabled or disabled.
      type: boolean
    description: Create a new user.
  - name: msg-delete-user
    arguments:
    - name: userId
      required: true
      default: true
      description: The User Id or User Email of the existing user to delete.
    outputs:
    - contextPath: MsGraph.User.Id
      description: User ID
      type: string
    - contextPath: MsGraph.User.Action
      description: Action on the user, should be 'deleted'
      type: string
    description: Delete an existing user.
  # TODO: perimission error, this command doesn't work.
  # - name: msg-update-user
  #   arguments:
  #   - name: userId
  #     required: true
  #     description: The User Id or User Email of the existing user to update.
  #   - name: displayName
  #     description: The name to display in the address book for the user.
  #   - name: userPrincipalName
  #     description: The user principal name (UPN) of the user. The UPN is an Internet-style
  #       login name for the user based on the Internet standard RFC 822. By convention,
  #       this should map to the user's email name. The general format is alias@domain,
  #       where domain must be present in the tenant’s collection of verified domains.
  #   - name: mailNickname
  #     description: The mail alias for the user.
  #   - name: password
  #     description: The password for the user.
  #   - name: jobTitle
  #     description: The user’s job title.
  #   - name: department
  #     description: The name for the department in which the user works.
  #   - name: city
  #     description: The city in which the user is located.
  #   - name: accountEnabled
  #     description: Indicate whether the account is enabled or disabled.
  #   outputs:
  #   - contextPath: MsGraph.User.Email
  #     description: User email address
  #     type: string
  #   - contextPath: MsGraph.User.Id
  #     description: User ID
  #     type: string
  #   - contextPath: MsGraph.User.MailIsEnabled
  #     description: Indicate whether mail service of the account is enabled or disabled.
  #     type: boolean
  #   description: Update an existing user.
  runonce: false
