commonfields:
  id: McAfee Threat Intelligence Exchange
  version: -1
name: McAfee Threat Intelligence Exchange
display: McAfee Threat Intelligence Exchange
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAAiCAYAAACUcR1DAAAAAXNSR0IArs4c6QAAGA9JREFUaAXtWwmYVNWVPnd5VfWquroBg4ACSdyiGHdHEYGm2eI6LowI0dFE1LjPxLiNJsYsjl/UZDRRictEMkaNW0aNQlTo6m4Q0RjjgkKMEVFxA9mqqqvqvXfvnf+86sLqhgYCMTjfl/t9Ve/VXc4995xzz3ZviQ5fPSCcuXRUmd6krSz/nqZBXlIdkFllZl5FZDcEbl42+aVVVPn46Dyt2FD7purmpr0D3u8MX5xMZDbVd3Pb5xFlTdab6gxpD2AjY99trtCjmzue+7Wn6IvCS+xNoekrPLXGVoLFmYDeOJAo/Gvg/K37ivnZhDPOrnKRvc8Ye2tLSC/+tZNc1JT6olLRaVK4aZGjhdetNBN7g9GW9s5OkDuzHEZfGxvSS73161n/BFEm48vrQimHtRSjMT3bt+b3q0SJFWn5TFbp/Q05KloqCqv3aC6V3tkU3LlNTX3Jlq+RNpoipWoSXQMCZ9e6IBreHNCiTcH4NNtl6Bi86Jv09FmelvPnZrz7OlK6eXMmvbQP7XPpduoWqYLntZDfVkSDQJ/KxsYKayspJfdNJPWcXMY7dWN9a23tCdojnU3Oymh9tuxFM9T6bslzT6LACXUDI97pBPlSZKysfHVTsHJEKRMW7vad/YYVsikALSv4cHHWLfgwoNerv7bdN+jFFBNUBmJWKd+TYrJU1Do3o5/syCaOeZ7I64nepQ00+pJ+6tdOqmc0qbOFkP1CQGE4m1OCuJPYDjt5RnuDuplVZG/jcr46UXsq55GDFYlLFwl7G7Fl9RA85k9cIssrkafOJ/I3Bs1lvMm+UocX0ZtHeFi+dlUqANYNf0szsjE8Ntam6xsdkGQJFOCYJ8QEGNEJnRn9XIdx01doM3O+UAcrj87DmPEafdgIMmO3pBjMJUCQlJDnVBrEfu1B9A2os1dqsJi4oS9/oKS40AEhxiuxefIDJUJQJmTRHa+bLvejP9Z+bq1nJCTPtUeQVuOp0/y2Vt/zKYWYVJtAW2MDoa53JnqqolM7lfNBa8/+n/bv2UQDUtnkwSasFESZFrmUOrwbgxkBAZowo2vi7El5kJJ0UF7R+6TkIIXWCP34s7WF52HNkRDykCihW3Mp+c2WtcGv5maTuxlrbk1JOabiqvhsaq55WT0Km2cSVOO+c6Xsi1GVuST+bK19tFgyDx8B7dkbjAEpfagSbkTVXFV7xapNqDPgy22QwUBbtjs31EBKmSYY+36iM7hqBFGJyl26pm7C9sbkrsqExxorhgP29k6KCknxMmz+b1ryEZRY7wUIpJt8dYQTbgL21c5knSe1fNtZ+2S+aB7B2tby6JV4Dgyjfk7pXWyaRgslvrkegx0EUSmZgHQy0vHHMsutGOiwL2qMZQLwhjKWAoLA8wRbWliYFInPKevuas94R9koHJHUeggzvzpL75BzWcI47wZh7NQEEI+AGA+DfgBa9E8k1VeVTx2tWp85Nl/504YgWS3OSQqpTDxftUcAwVLWjJ/dQMPGF+i1nuOwdpvjSbqKULJ0CJn1hCgHra3S+nJlogvBlSYLpFjn8UCQc1xg7AUdvryXSvbC0UTLa/Bqz/aUHi2V+C8txf5Mcx7r8MLvWNvJTRmxcE4UfWtchZ48gajcZs3zHhhmPT3YCLk67sd9uSQxq5PywdDYKfCs57NksloUWCxKHJaw7mOpQNVrsFXnANMf6ep03OevLhJz8DyssrlAsk5USg2JTQXq2ab1VkC8Psrph31JJxkpZRlIMRTGjxcW4jfD8bQa7Tn7eDvRrj1htSJsk84dxQzlwhqMC0NKaO1rlzg1rqj7Qmg5ZUFD4kF0+YLBuJjojga1p9UDzzR497WldAt3Z9Uv0uoWOJXfYyeM8ePCNGQ8WTtZuN4prU8WDfpRFlZur5U5TcmJSrnHmLm8CZgBvC4ez+8xjaT8ckqph3NpOhYwXUtAC0cG9OroYvREy9rKDd0YzJMCTqmlZO6LClGzDcOjImNmgcEGqlpzZ2PdM5Fxp+RXRgdft8pOx9ZeweO2pDBzYbreDq1dFgsXll1dSFXt8fqhRXoN22Ta+4EvxKHs+TIOwNMC1pxOa28sR+YeZ80qjQYmZFbQzrbB+z7W1w1dFYWnwxRkmKGMD9TezRjXyYxmASFnpuYgSN3WZ91+KeEmwXA38bh4rKAMCH18SojJTrqduX//tPo6nLAzSusmdXkw+Y5OG12G5+2YbY3CHNwODTIconhdbR7MOVAH4R3gf5ZpwoIeRaa9ZOyVZRNdDT68xE4da1k4M76S+rZcir5QG197rqeiMSYmQAtr4wo9DpY+/kxWHwrCTYq0yzWtMrOu+kRTs0TI7iSrgd70E44alZX6I4XBRaEQt4HQLcwMOHgUObfcCscagjXLA7xILnC44mcuSbuAG6eVoa+YMSBz3lr39dEl81DcAV8dCdrbCPcIiLPjGqLbIE3XY3QXJLSDB1bqk5mRvCuQ4FhaSDR8pzEofBk4NPOcYNqQUkYeQ8XwlzW4kKfYz64DFTfxruLdrMAL7N6EcOIS9sjZ3IGZy2F/j2jpDBGYcLGUS9BPyfNmQoPF5kg7d1Kuj3djy+rwRZHWZ4JrQ5j5iCAcsiU/ai6Z/6iO5ZntdzrScoan9CkhKOAL6l8SEg6wvajWh5/rMbi+sfZ+SD56Gu/8+ZsXAX6OqdAb91eiIwdl9HexyItCKRZE8KrHQtW0+Wqq2ACWQnkTU1CAbKd591eM+zEIsI65jOjogF5uVeEU53SyuRyBn92L9eVUqPeBZXAsBRiRVPcdtWbNqlxa3QWnopl7AzyUlJuG513oEtsLmOu3KyZ6wTmxB2xvHEpBE1WsEK+hD6RFvN/fp/21ErtGEL3YBBlaJYU5ti2TQPRULVA4gXVuBYRriIPnnpLCiyJ7FFpZax3D/g6LBoQ9gmA35jKJa+IqfLXHuMBnh1STkAIbELXy6BzZb7fAFuNHXDZAulrT3/eJVZeoGF3W7tOjqkCvjCXKbxQDSchPVAlQsXANE+IR6lx/xNgSPVuvcGo9cticTqkz45iXNYl1RSvVL7g96jQPln26Sis5mFUgoohD2nw6CBgu4PbRneHPsQ3vqGS8P0AL7eVYlSu5rKkQjtobuRJmMjJ257AmYseN/QvkFnZLCH0Fj/+kyNgMsBBwiVnkxJdnEjUCxFC276yboII9COA5Xcpr3XCOuJGhiX+zNw8Ig02KdgB736x1+swwuIZQc4kQAm9GsdYjxYoVxTorO6P1PNhq44a/RTZxOHbpniGIFCtQfMPT/SkcJd61FnTz8YwJnJRCG+GdBosXM5irQUG7fQ/QRdSBzDyMJS9Z31xlQ31N9Z2FwOuq5lAEW29AA5QSnK91vGH8GGDPIlHBmocLr8LAX6eyaarWVL/XAamv/H/xbt1bbDhZwhNaeWVJB1Ng1sv7zs7SduU8sd5bVVsXyCXanDsX+ZO4imEgj57xpJpY6wO1iB1VbY89bGuPh47/7mhCPgClfw+Ko6/7uK5OWvs2NEIMjh290Lg/ws94EjLQjeZgEpQEOlqrInSEYL0OW54HbivhNPZh5iKW7yxJ+Qth2BR/UuAKGCe1EzaKZQTTIMKkjz7psZk2uH7AZ+Udq2qF3YHZE6AlSCTkFXNTpqP+VAxqNF006h4/I4a2W3cFHLCHmQhQtwfD1jdXqVX1nnldzNT6Env5YDIzGt7wdp2+ORFq+ob6Pr29G0o8C9doDTzQpliDO5tWOrp2xFrOR3xS2n1/yJgNHGp0RNF8T+ud2McA95KBFM+OKYS/+mQkUQ4bONkYpEcUu8Os79NNmuIGKWu5jPp+vb87FXQJeu99PoWW5SX6/YC0mw3Pe2IZCCBk2AWBfa4tRbciS/SysNS/qMXpnpAjmG1JSQ+1N8hbqBCeS0KdlYAKZOLFOwThinOyxGgiW1TdtniH5CDJxlkxqD/8hmP39ZkUTkfmaJPmoKVUerc9Je/lQ5zYE9b6S1EUzW337dVSJ5+H19BgpZgEK3zB3Ab9MoT06mKnmVODjX07PbB2CgRYc6ysjL29o0HvYSrRAzKkIiRuf+B2OeAMbEu5G72yveNQ6r57eT2sxteV2OGw9iDOnqyr3MjLRX1pb8j3EXzM8PcucMqMicyF2MUfcTKGnSGh1NCUp69OKvXblKd+wcyN40R4mNaYQIThEznfH4z89nGsdpm5zpiyNdFhZZXaM6GCPY0I131w+DICSmIF72SGA3u5t5+pJjE2Z722bL9XiqLFbCd5vBJymKcTd5soegnG+jnUXw4sGhhP4Px4qkHBklQL+yIRyR8jrsbsKEKkIG2Xi4T3e+HLl5C8+TXWsTcSKNv39dTVYVpNh8aqmfMuKGBw1/C4gpPsmty+sAi5jox+oj1J/7yhQRdnadQlfb17pVALpBRHsnTXCtO59t7bkzvwvJvs2AWgt/4cRgWV6Hio1tcRB4IG7FXGYUX8RAjC8SF7PsuR9TmFD/GRAj4LBxyNTLQEE0+IXAu848PWrl3J6nN8nj6ufVrywWKEL49wP8aX1R3s4hldaLG9BP3iOo7F+bVbaSH6wGp9XBCZ52P8pIRXjShKSUR4pNgkJAEbQlosR9GlKwo98t7F4Nuo/4mGlDEOcbwuSEOQfYbDu5OdtDXGPhlZc/GGLhfwIUg5pVWKJ2N3npmMxfBp0kQgN7Gk6dl2ctOXCjPrRaEOwpWH87CSCUjO4zSpqrp4Vbw6TlyEnMTcSLFwJxC9hTh/RZ4CqXapujkOPYcCLvgE5wJgoScENGg3EzI2oqc7CuHIclqfhYTCcSDzzmCCD88kxA5cVrF2JlTjTS2ItdnhclafhDrcS+CsHLtGdEfPOet/w4m5s2LDk9ETKh1JCynGzybabQzRn9sBArjxB0IUH67VD43fWUjmEY2tZMQZmHMKBOpL6J6RUCno8EEg1RyEOjeNK9kXeg5u4fiuZL/Vjs0mnT0b45Dtou3wQeqe1iIIfhnux52Lyubub0BJ9BzPv0Uum9gd4cFULPRryL0OZTXNTK4VToexL7hImfcWKrkDznDXHThwH+6p8B26aCV20L2RM7f8eOX6yXnuyyWHtJ+XoB3BLM6Zi5Ly8xNKpberret/P0XU1JSgwQU0NeBTlFRsKdNb6/eMYWvp+4OUKTWGOPnMVug9SPW66PgJ3ApJe7RLhbcjCtZlswH9aUOSX4N/FZY4GhcOPGxgpmDK82QlkVnSsnr1as5je9am4nWIMJhXoMXo36u9QnZLDfD9HWRU6getEgQBvTeBCEm2zStxrrpCAxMeFLTVK4bDzm9qJNhXLR3w/F1j8qsiCs9E+msYUyC2X3hyZPgmMvJIfvK+iwdgUXE9+rwDPs2wRt95/ZrykrjxH1+fGQqsY3ANoxw2is4oqDpxNpLph+CQhuMw+ouiCAzWvIN5EHQcYk57mwrs3dcU1j/mqsH7x3PbUmA9BtfQAaO1TtJhSOedC+diwlIctr4AjiN0WAAeT8+vNr+5hYg15z/KZ5gCvTK4HucFWT3ydUGT/ihdW3G1mXlbLwa9fkxv70/5/tAGKh1Y1gkrEbpAgOKUnlPpHNu13sZtST37FwimfohrN6e3EG017Jwvz4MLuhyHGvdtCT7bYgw256bL8OqVEjiDW1+UZ/egSH0TJzRNCNT3gv5/Ds5pRYrSQkDfeiZk5GWyaB9qhpdrogAhojehMU5TbD3uOEXyrBIeleoDw62H+2lC2Kwd/GkgkGv0h4soeCyvzO58CR4mISXTcppHYj/kbBevLka3HoOcLHuO0iAEIjcQaQmk+WRYkNHPGwqkZVqfh0h0O8SHD+Ou9O9a0+pI3Ai5G2HSzEhK3GShV3Ab4n8x7jLEnaNcZJZUyvYW9lw5vi+mvdMSZA6Ao/iKKdnbscvLuYz6GhLHz2tPn4Ro6hUkHO6prb8tmzgOQevqMeUo19qY/EoiCI/FSR0u24nf8vy1fljLQEqro0DcZciYHQt/ZbEphtNj+FinTtM0RWo/nAAt8ovR9Lzv98OypiwvRje/hizZmIz3b8B5EcPEleG9rJLNLSV7Uy7tHeiRPRWxWhQG4X/z7Y32tLefoXAo4IW4jXOkK4RXYJ51G4Wd4W1SENPFmfh++TjSIpnxbkLi5CxmLrIHk3DJ7JcOjrow6lbEmfsgAn4MSYfTcd1oSB/kC6yvH8XNiT4Uhb+HNri9NUXjEOpl0eIB9sc4YFoDOBx2fw4O4yTA+LNU8jzP11fygvO+/k8E1aeFWncI7Z0gMt6PuB65iwtVwnsI14d3RGpsHaG4DRH52U6LY+YkaWfEpQ/YhPcn3Mh4E4cAg+L2ri/n0QAl5e3AfxpuxPwFUdnFEmfd3Ix5bibhxevEZP9SaEjMCDO48SbEdz/X5A1rSdHn0e1afC7j/k57Z8AbOqw9vm5kH4bwLsHFwo+B4yMc+eCweq+UUP8D5n4LuZY1/XqYz23GYEaeS5Aly7sUQfEJOLS/oLkYXV+haBqkdOLT2eQuYOzuzlOPjII0g0kLkQZ6Kwxpd/j2wyInn4ODv0JLuUJ5ycljSuYBo1SxEpo7WwrmQeVCiastkY6CC3FH6TrspBmY54CZfEdAyZNwPWc+1HgBB+9/AOkn51iLcGhvzGPD8+EpzZ0GXeuLKCPREkjpV+A/RHA4P19y9qExZXNnfS9oCwQetlMrffnokr0WQvtDmKFJc4h2xN+EJuHK0/m8TvzzYRpyqEfKQmcK459TgRkJmR6L0Y/B1qfYX4EQDHdRcI9LyROwznJZ6yWRdIvB+u1tNjESOfdiJISVhXDKmGJw+T5IFdTjss0ZjNsY1osoDc9cKhvFtwoTqfQqJnNQrqSwO36C25ZXzkurO3Fw1OiC4H5kqHYAg/iQ50BI+HhPUit2yaw2XKAH0wROUvlolRMySAjKoitXLw84SDd2ikHCNiWsSSHgG0zSw87HEQNFNw4G1Qz0Kgj2aj2R6t/5aI4PEgzx0aIYmtLegraMvrhbHzQATCWKZCfXa2M/BOgEEjw4q8Xpfdc6qTG9Cn4IBAUX7J37HbJm4yCAyO3TvcjILdWu9K9sgnQJ+SGpBkKgcPJgm6WVzUhJ3CoqwRvGmRQSgh+Mog3/12ubMhhEkNFaZHdK9CHW/RGYdgRneyiIxuEarDEhvQU16uPE5GXOklWK4fGccsT9HCyMj1loRnNneP7SfHhJIR/MMllcYMfBEnYLLsPFeWJo7/hUFlMxt6EXjMVtdspD3b+LM+DXWgrh+dAO/x4U7c92gUIBoRXGx+aDx9QXaI0Yznxcyg86w0UjC8EkSMyNGHN+jHdXZ7hgED7RKCk4FFpBQ30ejt/LdEBLEDWswJXWeJ22FI7Hbo1EQMukE3NYYKFmh1lt5gBCGzTAOSKy747GGTQyTAuRTvaSxehKXvM7+fA7OeTiodEg33wZl5fHmUk9cm6Kdqrhvc0YDBHHfTiXLzWQ2BXSLow5H4dipw/y1QLs2u9jgRexM2SU7IPrnGOQ9742ndGtcCp+lg3pVWfCa7DL72/3VccOWe/ZdEqPGJfHuaiQv0snEj/vSMmbORWJLZwHwcFvfNmogh1aAiUs5jgPWbkTcAQ3f15aL0im9aWoxzEzFWCrq/+uqVGp6wndUMKnUMkmPu9nvKfx956nlLVTYZunT+abOV0FRIUmF3kw9izPF89gnsPAxyv5UjzE9gII6xm8TuD3Pazz4hY4RaYzfA0IroJAL+XDDrhR7aBPE9jWymAz+fBXyNvPMw2JBXOx5v5p/dThWepLKlEGTqyWHRxHDWV9l1EJpKarhbm+TQrbwYzvb/9hqfRejTh8GJA19MVKJy1jqW1t8g7A6fQMHPNNDgNaqbN6N6jVWTYI98FF77/wYTlilkG497Ti/TItZTjYSYkvZLxhq0y4ZnCZlq3w/QG1ObCb+viYFxl7qEwi4NDYmKbdMEcFe/cNZgBiwR2Qc14Loq+XxHmigbZPq6Zw5Jo1q+fg76IZQ/0DRR81l2lJPRH5NicU8mxcQhgJ9dxQ7gzfA7wPan16rrNWj/tAAwpZipjBkEgxG+uzpdLHX6mzq/HZQRQ04uLBO0wjrKkBJqcRxvs9hsP5cZ2vrERbbO62GYNri9rYsyPt7Y9D8cdkZK6EM7JcanU0DkJ2gqo+un7RG4OxLdqYwRZ/mBM2se/m/AX108Rxm6nozVkUbi++gDDgRARLpztP3+yUfM7BDn+WmVu/LhVbg/qav//7/wH4JfbRE0Fu5QAAAABJRU5ErkJggg==
description: Connect to TIE using its DXL client
detaileddescription: |-
  ### Prerequisites - Connect to McAfee Threat Intelligence Exchange (TIE) using the DXL TIE client.
  [Create certificates & configure dxl](https://opendxl.github.io/opendxl-client-python/pydoc/index.html). After this phase you must have:
   * Broker CA certificates ('brokercerts.crt'  file)
   * Client certificate ('client.crt' file)
   * Client private key ('client.key' file)
   * Broker list properties file ('brokerlist.properties' file)

   To use 'tie-set-file-reputation' - you must have an appropriate permission. Follow [this insructions](https://opendxl.github.io/opendxl-client-python/pydoc/marsendauth.html), and ** with the exception of swapping the 'Active Response Server API' in 'TIE Server Set Enterprise Reputation'**

  ### Dependencies (Python packages) - No need to install, already installed in docker image :
  dxlclient [docs](https://opendxl.github.io/opendxl-client-python/pydoc/index.html)
  dxltieclient [docs](https://opendxl.github.io/opendxl-tie-client-python/pydoc/)
configuration:
- display: Broker CA certificates content (see `brokercerts.crt` in instructions)
  name: broker_ca_bundle
  defaultvalue: ""
  type: 12
  required: true
- display: Client certificates content (see `client.crt` in instructions)
  name: cert_file
  defaultvalue: ""
  type: 12
  required: true
- display: Client private key path (e.g. /usr/config/client.key)
  name: private_key
  defaultvalue: ""
  type: 14
  required: true
- display: Brokers urls (comma separated list in the form of - [ssl://]<hostname>[:port])
    - get hostname & port from `brokerlist.properties` file in instructions. Note
    that the broker should be reachable from demisto server
  name: broker_urls
  defaultvalue: ""
  type: 0
  required: true
script:
  script: |
    from dxlclient.client_config import DxlClientConfig
    from dxlclient.client import DxlClient
    from dxlclient.broker import Broker
    from dxltieclient import TieClient
    from dxltieclient.constants import HashType
    from datetime import datetime

    VENDOR_NAME = 'McAfee Threat Intelligence Exchange'

    broker_ca_bundle = './brokercerts.crt'
    with open(broker_ca_bundle, "w") as text_file:
        text_file.write(demisto.params()['broker_ca_bundle'])

    cert_file = './cert_file.crt'
    with open(cert_file, "w") as text_file:
        text_file.write(demisto.params()['cert_file'])

    private_key = './private_key.key'
    with open(private_key, "w") as text_file:
        text_file.write(demisto.params()['private_key'])

    broker_urls = demisto.params()['broker_urls'].split(',')

    HASH_TYPE_KEYS = {
        'md5': HashType.MD5,
        'sha1': HashType.SHA1,
        'sha256': HashType.SHA256
    }

    TRUST_LEVELS = {
        '0': 'NOT_SET',
        '1': 'KNOWN_MALICIOUS',
        '15': 'MOST_LIKELY_MALICIOUS',
        '30': 'MIGHT_BE_MALICIOUS',
        '50': 'UNKNOWN',
        '70': 'MIGHT_BE_TRUSTED',
        '85': 'MOST_LIKELY_TRUSTED',
        '99': 'KNOWN_TRUSTED',
        '100': 'KNOWN_TRUSTED_INSTALLER'
    }

    POVIDER = {
        '1': 'Global Threat Intelligence (GTI)',
        '3': 'Enterprise reputation',
        '5': 'Advanced Threat Defense (ATD)',
        '7': 'Web Gateway (MWG)'
    }

    def create_error_entry(contents):
        return { 'ContentsFormat': formats['text'], 'Type': entryTypes['error'], 'Contents': contents };

    def get_client_config():
        config = DxlClientConfig(
            broker_ca_bundle=broker_ca_bundle,
            cert_file=cert_file,
            private_key=private_key,
            brokers=[Broker.parse(url) for url in broker_urls]
        )

        config.connect_retries = 1
        config.reconnect_delay = 1
        config.reconnect_delay_max = 10

        return config

    def get_provider(provider_id):
        provider_id_str = str(provider_id)
        return POVIDER.get(provider_id_str, provider_id_str)

    def parse_reputation(rep):
        # get trust level
        trust_level = str(rep.get('trustLevel'))
        verbose_trust_level = TRUST_LEVELS.get(trust_level, trust_level)

        # get provider
        provider_id = rep.get('providerId')
        provider = get_provider(provider_id)

        # get date
        create_date = rep.get('createDate')
        create_date_str = str(datetime.fromtimestamp(create_date))

        res = {
            'Trust level': trust_level,
            'Trust level (verbose)': verbose_trust_level,
            'Provider ID': provider_id,
            'Provider (verbose)': provider,
            'Created date': create_date_str
        }

        return res

    def parse_reference(reference):
        agent_guid = reference.get('agentGuid')
        return {
            'Date': str(datetime.fromtimestamp(reference.get('date'))),
            'AgentGuid': agent_guid.replace('{', '').replace('}', '') # remove brackets if exist
        }

    def reputations_to_table(reputations):
        return [parse_reputation(rep) for rep in reputations]

    def references_to_table(references):
        return [parse_reference(ref) for ref in references]

    def trust_level_to_score(trust_level):
        if (trust_level >= 70):
            return 1
        elif (trust_level == 30):
            return 2
        elif (trust_level < 30):
            return 3
        else:
            # If reached here, then the value is either 0 or 50, as the API doesn't support 31-69 values except for 50)
            return 0

    def get_thrust_level_and_score(reputations):
        trust_level = 101 # more than the highst possible trust level
        vendor = VENDOR_NAME

        for rep in reputations:
            rep_trust_level = rep.get('trustLevel', 0)
            if  rep_trust_level != 0 and rep_trust_level < trust_level:
                trust_level = rep.get('trustLevel')
                vendor = get_provider(rep.get('providerId'))

        if trust_level == 101:
            # no trust_level found
            return {
                'trust_level': 0,
                'score': 0,
                'vendor': vendor
            }

        score = trust_level_to_score(trust_level)

        if (vendor == 'Enterprise reputation'):
            vendor = VENDOR_NAME
        return {
            'trust_level': trust_level,
            'score': score,
            'vendor': vendor
            }

    def test():
        config = get_client_config()
        with DxlClient(config) as client:
            client.connect()
            client.disconnect()

    def file(hash):
        config = get_client_config()
        with DxlClient(config) as client:
            client.connect()
            # Create the McAfee Threat Intelligence Exchange (TIE) client
            tie_client = TieClient(client)

            hash_type = get_hash_type(hash)
            hash_type_key = HASH_TYPE_KEYS.get(hash_type)
            if not hash_type_key:
                return create_error_entry('file argument must be sha1(40 charecters) or sha256(64 charecters) or md5(32 charecters)')

            hash_param = {}
            hash_param[hash_type_key] = hash

            res = tie_client.get_file_reputation(hash_param)
            reputations = res.values()

            table = reputations_to_table(reputations)

            # creaet context
            context_file = {}
            hash_type_uppercase = hash_type.upper()
            tl_score = get_thrust_level_and_score(reputations)

            context_file[hash_type_uppercase] = hash
            context_file['TrustLevel'] = tl_score['trust_level']
            context_file['Vendor'] = tl_score['vendor']

            dbot_score = {'Indicator': hash, 'Type': 'hash', 'Vendor': tl_score['vendor'], 'Score': tl_score['score']};
            if tl_score['score'] >= 2:
                context_file['Malicious'] = {
                   'Vendor': tl_score['vendor'],
                   'Score': tl_score['score'],
                   'Description': 'Trust level is ' + str(tl_score['trust_level'])
               }
            ec = {
                'DBotScore': dbot_score
            }
            ec[outputPaths['file']] = context_file

            return {
                'Type': entryTypes['note'],
                'ContentsFormat': formats['json'],
                'Contents': reputations,
                'ReadableContentsFormat': formats['markdown'],
                'HumanReadable': tableToMarkdown('McAfee TIE Hash Reputations For %s:' % (hash,), table),
                'EntryContext': ec
            }

    def file_references(hash):
        config = get_client_config()
        with DxlClient(config) as client:
            client.connect()
            # Create the McAfee Threat Intelligence Exchange (TIE) client
            tie_client = TieClient(client)

            hash_type = get_hash_type(hash)
            hash_type_key = HASH_TYPE_KEYS.get(hash_type)
            if not hash_type_key:
                return create_error_entry('file argument must be sha1(40 charecters) or sha256(64 charecters) or md5(32 charecters)')

            hash_param = {}
            hash_param[hash_type_key] = hash

            references = tie_client.get_file_first_references(hash_param)

            table = references_to_table(references)

            # creaet context
            context_file = {}
            hash_type_uppercase = hash_type.upper()

            context_file[hash_type_uppercase] = hash
            context_file['References'] = table
            ec = {}
            ec[outputPaths['file']] = context_file
            return {
                'Type': entryTypes['note'],
                'ContentsFormat': formats['json'],
                'Contents': references,
                'ReadableContentsFormat': formats['markdown'],
                'HumanReadable': tableToMarkdown('References for hash %s' % (hash,), table),
                'EntryContext': ec
            }

            return res

    def set_file_reputation(hash, trust_level, filename, comment):
        config = get_client_config()

        # find trust_level key
        trust_level_key = None
        for k, v in TRUST_LEVELS.iteritems():
            if v == trust_level:
                trust_level_key = k

        if not trust_level_key:
            return create_error_entry('illigale argument trust_level %s. Choose value from predefined values' % (trust_level, ))


        with DxlClient(config) as client:
            client.connect()
            tie_client = TieClient(client)

            hash_type = get_hash_type(hash)
            hash_type_key = HASH_TYPE_KEYS.get(hash_type)
            if not hash_type_key:
                return create_error_entry('file argument must be sha1(40 charecters) or sha256(64 charecters) or md5(32 charecters)')

            hash_param = {}
            hash_param[hash_type_key] = hash

            try:
                tie_client.set_file_reputation(trust_level_key, hash_param, filename, comment)
                return 'Successfully set file repuation'
            except Exception as ex:
                return create_error_entry(str(ex))


    args = demisto.args()
    if demisto.command() == 'test-module':
        test()
        demisto.results('ok')
        sys.exit(0)
    elif demisto.command() == 'file':
        results = file(args.get('file'))
        demisto.results(results)
        sys.exit(0)
    elif demisto.command() == 'tie-file-references':
        results = file_references(args.get('file'))
        demisto.results(results)
        sys.exit(0)
    elif demisto.command() == 'tie-set-file-reputation':
        results = set_file_reputation(
            args.get('file'),
            args.get('trust_level'),
            args.get('filename'),
            args.get('comment')
        )
        demisto.results(results)
        sys.exit(0)
  type: python
  commands:
  - name: file
    arguments:
    - name: file
      required: true
      default: true
      description: '  Hash of the file to query. Supports MD5 SHA1 & SHA256'
    outputs:
    - contextPath: File.MD5
      description: file's hash MD5 (if supplied)
    - contextPath: File.SHA1
      description: file's hash SHA1 (if supplied)
    - contextPath: File.SHA256
      description: file's hash MD5 (if supplied)
    - contextPath: File.TrustLevel
      description: File lowest trust level
    - contextPath: File.Vendor
      description: File lowest trust level's vendor
    - contextPath: DBotScore.Score
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Vendor
      description: The actual score
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Indicator
      description: The given file's hash
    important:
    - contextPath: File(val.Malicious)
      description: Malicious Files
      related: ""
    description: Retrieves the reputations for the specified hash ( Supports MD5 SHA1
      & SHA256)
  - name: tie-set-file-reputation
    arguments:
    - name: file
      required: true
      default: true
      description: '  Hash of the file to set. Supports MD5 SHA1 & SHA256'
    - name: trust_level
      required: true
      auto: PREDEFINED
      predefined:
      - NOT_SET
      - KNOWN_MALICIOUS
      - MOST_LIKELY_MALICIOUS
      - MIGHT_BE_MALICIOUS
      - UNKNOWN
      - MIGHT_BE_TRUSTED
      - MOST_LIKELY_TRUSTED
      - KNOWN_TRUSTED
      - KNOWN_TRUSTED_INSTALLER
      description: The new trust level for the file
    - name: filename
      description: A file name to associate with the file
    - name: comment
      description: A comment to associate with the file
    description: Sets the “Enterprise” reputation (trust level) of a specified file.
      NOTE - invoking this method must have permissions - 'How-to' in instance instruction)
  - name: tie-file-references
    arguments:
    - name: file
      required: true
      default: true
      description: '  Hash of the file to search on. Supports MD5 SHA1 & SHA256'
    outputs:
    - contextPath: File.MD5
      description: file's hash MD5 (if supplied)
    - contextPath: File.SHA1
      description: file's hash SHA1 (if supplied)
    - contextPath: File.SHA256
      description: file's hash SHA256 (if supplied)
    - contextPath: File.References.AgentGuid
      description: The GUID of the system that referenced the file
    - contextPath: File.References.Date
      description: The time the system first referenced the file
    description: Retrieves the set of systems which have referenced (typically executed)
      the specified file
  dockerimage: demisto/dxl
  runonce: false
tests:
  - No test - no instance
releaseNotes: "Dbot score for indicator with reputation of 30 is now set to suspicious"
