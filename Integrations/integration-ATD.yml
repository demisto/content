commonfields:
  id: McAfee Advanced Threat Defense
  version: -1
name: McAfee Advanced Threat Defense
display: McAfee Advanced Threat Defense
category: Forensics & Malware Analysis
image: data:image/png;base64,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
description: 'Integrated advanced threat detection: Enhancing protection from network
  edge to endpoint'
detaileddescription: |
  When entering a is a user to use the API with, please make sure the user has capability of "Allow Multiple Logins".
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: baseUrl
  defaultvalue: ""
  type: 0
  required: true
- display: username
  name: username
  defaultvalue: ""
  type: 0
  required: true
- display: password
  name: password
  defaultvalue: ""
  type: 4
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: "true"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |2-

    var base = params.baseUrl;

    var getSession = function() {
        res = sendRequest('/php/session.php','GET', loginHeaders);
        if (res) {
            return res.results;
        }
    };


    // handle '/' at the end of the url
    if (base[base.length - 1] === '/') {
        base = base.substring(0, base.length - 1);
    }

    var username = params.username;
    var password = params.password;
    var insecure = params.insecure;
    var proxy = params.proxy;

    var loginHeaders = {'Accept': ['application/vnd.ve.v1.0+json'], 'Content-Type': ['application/json'], 'VE-SDK-API':[Base64.encode(username + ':' + password)]};

    var heartbeatHeaders = {'Accept': ['application/vnd.ve.v1.0+json'], 'Content-Type': ['application/json']};

    var verifyHash = function() {
        var body = {};
        holder = {};
        holder.md5 = args.hash;
        body.data = JSON.stringify(holder);
        return sendRequest('/php/atdHashLookup.php','POST', getHeaders(), body);
    };

    var listUsers = function() {
        var userType = 'STAND_ALONE';
        if (args.userType) {
            userType = args.userType;
        }
        var result = sendRequest('/php/briefUserList.php?userType='+userType,'GET', getHeaders());

        var md = tableToMarkdown('ATD User List',result.results);
        return {Type: entryTypes.note,
              Contents: JSON.stringify(result),
              ContentsFormat: formats.json,
              HumanReadable: md
        };
    };

    var listProfiles = function() {
        var result =  sendRequest('/php/vmprofiles.php','GET', getHeaders());
        var md = tableToMarkdown('ATD VM Profile List',result.results,['name','vmProfileid','vmDesc','sandbox','summary','internet','locBlackList']);
        return {Type: entryTypes.note,
              Contents: JSON.stringify(result),
              ContentsFormat: formats.json,
              HumanReadable: md
        };
    };

    var heartBeat = function() {
        return sendRequest('/php/heartbeat.php','GET', getHeaders(), heartbeatHeaders);
    };

    var getTaskIDs = function() {
        return sendRequest('/php/getTaskIdList.php?jobId='+args.jobId,'GET', getHeaders());
    };

    var buildReportContext = function(reportSummary) {
        var context = {};
        if ((reportSummary) && (reportSummary.Subject)) {
            var subject = reportSummary.Subject;
            context = { DBotScore: {Vendor: 'McAfee-Advanced-Threat-Defense', Score: 0 }};
            if ( subject.FileType ) {//file
                context.DBotScore.Indicator = subject.md5;
                context.DBotScore.Type = 'hash';
                if (reportSummary.Verdict.Severity > 3) {
                    context.DBotScore.Score = 3;
                    addMalicious(context, outputPaths.file, {
                        Type : subject.Type,
                        MD5 : subject.md5,
                        SHA1 : subject['sha-1'],
                        SHA256 : subject['sha-256'],
                        Size : subject.size,
                        Name : subject.Name,
                        Malicious: {Vendor: 'McAfee-Advanced-Threat-Defense',
                            Description: 'Severity: ' + reportSummary.Verdict.Severity}
                    });
                } else {
                    context.DBotScore.Score = 1;
                }
            }
        }

        return context;
    };

    var getReport = function() {
        uriSuffix = jobOrTaskId();
        if ((args.type) && ( (args.type === 'table') || (args.type === 'json') )) {
            var res = sendRequest('/php/showreport.php?'+uriSuffix+'&iType=json', 'GET', getHeaders());
            var resString = JSON.stringify(res);

            var summary = res.Summary;
            summary.VerdictDescription = summary.Verdict.Description;
            summary.VerdictSeverity = summary.Verdict.Severity ;
            var context = buildReportContext(summary);
            summary = formatTableValues(summary);
            var md = resToMD(summary,'ATD Sandbox Report');

            return {
                Type: entryTypes.note,
                Contents: resString,
                ContentsFormat: formats.json,
                HumanReadable: md,
                EntryContext: context
            };
        }
        if (args.type === 'pdf') {
            if (!getSession().isAdmin) {
                return 'No permission to download PDF'
            }
            var filename = args.jobId;
            if ((!filename) || (filename.length === 0)) {
                filename = args.taskId;
            }
            filename = filename + '.pdf';
            return downloadReport('/php/showreport.php?'+uriSuffix+'&iType='+args.type, 'GET', getHeaders(), filename);
        }
        if (args.type === 'sample') {
            var permissionCheck = sendRequestRaw('/php/showreport.php?'+uriSuffix+'&iType='+args.type, 'GET', getHeaders()).Body;
            if (permissionCheck.substring(11,16) === 'false') {
                return 'No permission to download sample'
            }
            var filename = args.jobId;
            if ((!filename) || (filename.length === 0)) {
                filename = args.taskId;
            }
            filename = filename + '.zip';
            return downloadReport('/php/showreport.php?'+uriSuffix+'&iType='+args.type, 'GET', getHeaders(), filename);
        }
        return sendRequestRaw('/php/showreport.php?'+uriSuffix+'&iType='+args.type, 'GET', getHeaders()).Body;
    };


    var getTaskStatus = function() {
        uriSuffix = jobOrTaskId();

        var res = sendRequest('/php/samplestatus.php?'+uriSuffix,'GET', getHeaders());

        var status = res.status;
        resForMd = res;
        if ((res) && (res.results)) { // when you use TaskID, you get results in res.results
            resForMd = res.results;
            status = res.results.status;
        }
        var md = resToMD(resForMd,'ATD Sandbox Task Status');
        return {Type: entryTypes.note,
              Contents: JSON.stringify(res),
              ContentsFormat: formats.json,
              HumanReadable: md,
              EntryContext: {"ATD.status": status}
        };
    };

    var jobOrTaskId = function() {
        uriSuffix = '';
        if ((args.jobId) && (args.jobId.length > 0)) {
            uriSuffix = 'jobId='+ args.jobId;
        }
        if (args.taskId) {
            uriSuffix = 'iTaskId='+ args.taskId;
        }

        return uriSuffix;
    };

    var getBulkStatus = function() {
        var body = {};
        var data = {};

        data.data = {};
        data.data.bulkrequest = {};
        var total = 0;
        if (args.jobIDs) {
            data.data.bulkrequest.jobIDs = stringArrToIntArr(args.jobIDs.split(","));
            total = data.data.bulkrequest.jobIDs.length;
        }
        if (args.taskIDs) {
            data.data.bulkrequest.taskIDs = stringArrToIntArr(args.taskIDs.split(","));
            total = total + data.data.bulkrequest.taskIDs.length;
        }
        data.data.bulkrequest.numRequest = total;
        body.data = JSON.stringify(data);
        return sendRequest('/php/getBulkStatus.php','POST', getHeaders(), body.data);
    };

    var stringArrToIntArr = function(stringArr){
        var intArr = [];
        for (index = 0; index < stringArr.length; ++index) {
            intArr.push(parseInt(stringArr[index]));
        }
        return intArr;
    }

    var resToMD = function(body, title) {
        return tblToMd(title, body, Object.keys(body));
    };

    var castToInt = function(val) {
        if (typeof val === 'string') {
            return parseInt(val);
        } else {
            return val;
        }
    };

    var fileUpload = function() {
        var body = {};
        body.data = {};

        data = {};
        data.data = {};
        data.data.vmProfileList = castToInt(args.vmProfileList);
        data.data.submitType = castToInt(args.submitType);

        data.data.url = args.url;
        data.data.messageId = args.messageId;
        data.data.srcIp = args.srcIp;
        data.data.destIp = args.destIp;
        if (args.skipTaskId) {
            data.data.skipTaskId = castToInt(args.skipTaskId);
        }
        if (args.analyzeAgain) {
            data.data.analyzeAgain = castToInt(args.analyzeAgain);
        }
        if (args.xMode) {
            data.data.xMode = castToInt(args.xMode);
        }
        data.filePriorityQ = args.filePriorityQ;
        if (!data.filePriorityQ) {
            data.filePriorityQ = 'run_now';
        }
        body.data = JSON.stringify(data);
        var result =  uploadFile(body,args.entryID);

        var resultObj = JSON.parse(result);
        var results = resultObj.results;
        var taskId = '';
        if ((results) && (results.length > 0)) {
            var subId = resultObj.subId;
            resultObj = results[0];
            taskId = resultObj.taskId;
            resultObj.subId = subId;// need subId too sometimes
            if (taskId === -1) {
                taskId = subId;
            }
        }
        var md = resToMD(resultObj,'ATD sandbox file upload');
        return {Type: entryTypes.note,
              Contents: result,
              ContentsFormat: formats.json,
              HumanReadable: md,
              EntryContext: {"ATD.taskId": taskId}
        };
    };

    var uploadFile = function(body,fileParam) {
        uri = '/php/fileupload.php'
        filenameDq = dq(invContext, 'File(val=val.EntryID==="' + fileParam +'")=val.Name')
        filename = undefined
        if (filenameDq && filenameDq[0]) {
            filename = filenameDq[0]
        }
        res = httpMultipart(
            base+uri,
            fileParam,
            {
                Method: 'POST',
                Headers: getHeaders(),
            },
            body,
            insecure,
            proxy,
            false,
            'amas_filename',
            filename
        );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Failed to use uri ' + base+uri + ', request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }
        var b = res.Body;
        var uriStr = String(uri);
        if (uriStr.indexOf("session") === -1) {
            logout();
        }
        return b;
    };

    var logout = function() {
        res = sendRequest('/php/session.php','DELETE', getHeaders());
        if (res) {
            return res.results;
        }
    };

    var getHeaders = function() {
        var sess = getSession();
        return {'Accept': ['application/vnd.ve.v1.0+json'],'VE-SDK-API':[Base64.encode(sess.session + ':' + sess.userId)]};
    };

    var sendRequestRaw = function(uri, method, headers, body) {
        var res = http(
                base+uri,
                {
                    Method: method,
                    Headers: headers,
                    Body: body
                },
                insecure,
                proxy
            );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Failed to use uri ' + base+uri + ', request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }
        var uriStr = String(uri);
        if (uriStr.indexOf("session") === -1) {
            logout();
        }
        return res;
    };

    var downloadReport = function(uri,method, headers, filename) {
        var res = sendRequestRaw(uri, method, headers);
        return {
            Type: 9,
            FileID: saveFile(res.Bytes),
            File: filename,
            Contents: filename
        };
    }

    var sendRequest = function(uri, method, headers, body) {
        var body = sendRequestRaw(uri,method, headers, body).Body;
        var res = JSON.parse(body);
        if (res.success) {
            if (res.success === 'false') {
                throw 'ATD Api call to '+uri+' failed with body: '+body;
            }
        }
        return res;
    };

    // The command input arg holds the command sent from the user.
    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            getSession();
            return 'ok';
        case 'atd-login':
            return getSession();
        case 'atd-file-upload':
            return fileUpload();
        case 'atd-get-task-ids':
            return getTaskIDs();
        case 'atd-get-bulk-status':
            return getBulkStatus();
        case 'atd-check-status':
            return getTaskStatus();
        case 'atd-get-report':
            return getReport();
        case 'atd-list-analyzer-profiles':
            return listProfiles();
        case 'atd-list-user':
            return listUsers();
        case 'atd-verify-blacklisted-whitelisted-hashs':
            return verifyHash();
        default:
    }
  type: javascript
  commands:
  - name: atd-file-upload
    arguments:
    - name: vmProfileList
      description: Analyzer profile ID. The profile ID number can be found in the
        UI Policy/Analyzer Profile page, OR using command atd-list-analyzer-profiles,
        under vmProfileid key result
    - name: submitType
      required: true
      auto: PREDEFINED
      predefined:
      - "0"
      - "1"
      - "2"
      - "3"
      description: This parameter accepts four values — '0', '1', '2' and '3'. • 0
        — Regular file upload • 1 — URL submission — URL link is processed inside
        analyzer VM • 2 — Submit file with URL • 3 — URL Download — File from URL
        is firstly downloaded and then analyzed
    - name: url
      description: Any valid web URL.
    - name: messageId
      description: Maximum 128-character string.
    - name: srcIp
      description: ' IPv4 address of the source system or gateway from where the file
        is downloaded.'
    - name: dstIp
      description: ' IPv4 address of the target endpoint.'
    - name: skipTaskId
      auto: PREDEFINED
      predefined:
      - "0"
      - "1"
      description: Value '0' indicates corresponding taskid in API response. Value
        '1' indicates -1 as taskid in API response.
    - name: analyzeAgain
      auto: PREDEFINED
      predefined:
      - "0"
      - "1"
      description: Value '0' indicates skip sample analysis if it is analyzed previously
        . Value '1' indicates do not skip sample analysis if it is not analyzed previously.
    - name: xMode
      auto: PREDEFINED
      predefined:
      - "0"
      - "1"
      description: Value '0' indicates no user interaction is needed during sample
        analysis. Value '1' indicates user interaction is needed during sample analysis.
    - name: filePriorityQ
      auto: PREDEFINED
      predefined:
      - run_now
      - add_to_q
      description: ' This parameter indicates priority of sample analysis. run_now
        assigns highest priority (i.e., sample is analyzed right away), add_to_q puts
        sample in waiting state if there is a waiting queue of samples, default is
        run_now'
    - name: entryID
      description: entry ID
    outputs:
    - contextPath: ATD.taskId
      description: The task ID of the file upload
    description: upload a file/web URL for dynamic analysis by using the provided
      Analyzer Profile. Only single file/web URL can be submitted at a time.
  - name: atd-get-task-ids
    arguments:
    - name: jobId
      required: true
      default: true
      description: Serves as an identifier for the previously submitted file.
    description: fetches the list of task id's associated with a job id
  - name: atd-check-status
    arguments:
    - name: taskId
      description: This is the returned TaskId value in the submission step, previously
        returned value in the File/URL submission step
    - name: jobId
      description: Job id
    outputs:
    - contextPath: ATD.status
      description: The task ID statues (Completed or Analyzing)
    description: checks the analysis status
  - name: atd-get-report
    arguments:
    - name: taskId
      description: This is the returned TaskId value in the submission step, previously
        returned value in the File/URL submission step
    - name: jobId
      description: Job id
    - name: type
      required: true
      auto: PREDEFINED
      predefined:
      - html
      - txt
      - xml
      - zip
      - table
      - ioc
      - stix
      - pdf
      - sample
      description: 'iType can be one of the following types: • html — HTML report
        • txt — Text report • xml — XML report • zip — All files packaged in a single
        zip file • json — Same as xml but in the JSON format • ioc - Indicators of
        Compromise format • stix - Structured Threat Information expression. Stix
        generation is disabled, by default. Use set stixreportstatus enable to enable
        it. • pdf - Portable Document Format • sample - Download sample from McAfee
        Advanced Threat Defense'
    outputs:
    - contextPath: File.Name
      description: Filename (only in case of report type=json)
    - contextPath: File.Type
      description: File type e.g. "PE" (only in case of report type=json)
    - contextPath: File.Size
      description: File size (only in case of report type=json)
    - contextPath: File.MD5
      description: MD5 hash of the file (only in case of report type=json)
    - contextPath: File.SHA1
      description: SHA1 hash of the file (only in case of report type=json)
    - contextPath: File.SHA256
      description: SHA256 hash of the file (only in case of report type=json)
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision
    - contextPath: File.Malicious.Description
      description: For malicious files, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested (only in case of report type=json)
    - contextPath: DBotScore.Type
      description: The type of the indicator (only in case of report type=json)
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score (only in case of report type=json)
    - contextPath: DBotScore.Score
      description: The actual score (only in case of report type=json)
    description: ' download the analysis report files'
  - name: atd-list-analyzer-profiles
    arguments: []
    description: ' display the analyzer profiles. Only the analyzer profiles to which
      the user has access are displayed.'
  - name: atd-list-user
    arguments:
    - name: userType
      default: true
      description: This is the user type associated with a user profile. For example
        NSP, MWG, STAND_ALONE (default) and so on.
    description: ' displays the user profile information present on the McAfee Advanced
      Threat Defense.'
  - name: atd-login
    arguments: []
    description: Returns a logon result for ATD
  runonce: false
