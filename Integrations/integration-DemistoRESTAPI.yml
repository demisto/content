commonfields:
  id: Demisto REST API
  version: -1
name: Demisto REST API
display: Demisto REST API
category: Utilities
image: data:image/png;base64,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
description: Use Demisto REST APIs
detaileddescription: Creating API keys is done in the Demisto interface, under Settings
  -> Integrations -> API Keys
configuration:
- display: Demisto Server URL
  name: url
  defaultvalue: https://127.0.0.1
  type: 0
  required: true
- display: Demisto Server API Key
  name: apikey
  defaultvalue: ""
  type: 4
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: User system proxy settings
  name: proxy
  defaultvalue: "true"
  type: 8
  required: false
script:
  script: |
    var serverURL = params.url;
    if (serverURL.slice(-1) === '/') {
        serverURL = serverURL.slice(0,-1);
    }

    sendMultipart = function (uri, entryID, body) {
        var requestUrl = serverURL;
        if (uri.slice(-1) !== '/') {
            requestUrl += '/';
        }
        requestUrl += uri;

        var res = httpMultipart(
            requestUrl,
            entryID,
            {
                Headers: {
                    'Authorization': [params.apikey],
                    'Content-Type': ['multipart/form-data'],
                    'Accept': ['application/json']
                },
            },
            body,
            params.insecure,
            params.proxy,
            undefined,
            'file'
        );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Demisto REST APIs - Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }
        try {
            var response = res.Body;
            try {
                response = JSON.parse(res.Body);
            } catch (ex) {
                // do nothing, already handled prior the try/catch
            }
            return {response: response};
        } catch (ex) {
            throw 'Demisto REST APIs - Error parsing response - ' + ex + '\nBody:' + res.Body;
        }

    };

    var sendRequest = function(method, uri, body, raw) {
        var requestUrl = serverURL;
        if (uri.slice(-1) !== '/') {
            requestUrl += '/';
        }
        requestUrl += uri;

        var res = http(
            requestUrl,
            {
                Method: method,
                Headers: {
                    'Accept': ['application/json'],
                    'content-type': ['application/json'],
                    'authorization': [params.apikey]
                },
                Body: body,
                SaveToFile: raw
            },
            params.insecure,
            params.proxy
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Demisto REST APIs - Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }
        if (raw) {
            return res;
        } else {
            try {
                var response = res.Body;
                try {
                    response = JSON.parse(res.Body);
                } catch (ex) {
                    // do nothing, already handled prior the try/catch
                }
                return {response: response};
            } catch (ex) {
                throw 'Demisto REST APIs - Error parsing response - ' + ex + '\nBody:' + res.Body;
            }
        }
    };

    switch (command) {
        case 'test-module':
            sendRequest('GET','user');
            return 'ok';
        case 'demisto-api-post':
            var body = JSON.parse(args.body);
            return sendRequest('POST',args.uri, args.body);
        case 'demisto-api-get':
            return sendRequest('GET',args.uri);
        case 'demisto-api-put':
            var body = JSON.parse(args.body);
            return sendRequest('PUT',args.uri, args.body);
        case 'demisto-api-delete':
            return sendRequest('DELETE',args.uri);
        case 'demisto-api-multipart':
            return sendMultipart(args.uri, args.entryID, args.body);
        case 'demisto-api-download':
            var res = sendRequest('GET',args.uri,args.body,true);
            var filename = res.Path;
            if (args.filename) {
                filename = args.filename;
            } else {
                var disposition = res.Headers['Content-Disposition'][0].split('=');
                if (disposition.length === 2) {
                    filename = disposition[1];
                }
            }
            var desc = args.description || '';
            return ({Type: entryTypes.file, FileID: res.Path, File: filename, Contents: desc});
        default:
            throw 'Demisto REST APIs - unknown command';
    }
  type: javascript
  commands:
  - name: demisto-api-post
    arguments:
    - name: uri
      required: true
      default: true
      description: Request URI (i.e. /incident)
    - name: body
      description: Body of HTTP POST
    description: send HTTP POST request
    execution: true
  - name: demisto-api-get
    arguments:
    - name: uri
      required: true
      default: true
      description: Request URI (i.e. /user)
    description: send HTTP GET requests
  - name: demisto-api-put
    arguments:
    - name: uri
      required: true
      default: true
      description: Request URI (i.e. /user)
    - name: body
      description: Request body
    description: send HTTP PUT request
    execution: true
  - name: demisto-api-delete
    arguments:
    - name: uri
      required: true
      default: true
      description: Request URI (i.e. /user)
    description: send HTTP DELETE request
    execution: true
  - name: demisto-api-download
    arguments:
    - name: uri
      required: true
      description: Request URI
    - name: filename
      description: File name of download
    - name: description
      description: Description of file entry
    description: Download files from Demisto server
  - name: demisto-api-multipart
    arguments:
    - name: uri
      required: true
      description: Request URI
    - name: entryID
      required: true
      description: File entry ID
    - name: body
      description: Request body
    description: Send HTTP Multipart request to upload files to Demisto server
  runonce: false
