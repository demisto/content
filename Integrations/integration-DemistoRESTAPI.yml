commonfields:
  id: Demisto REST API
  version: -1
name: Demisto REST API
display: Demisto REST API
category: Utilities
image: data:image/png;base64,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
description: Use Demisto REST APIs
detaileddescription: Creating API keys is done in the Demisto interface, under Settings
  -> Integrations -> API Keys
configuration:
- display: Demisto Server URL
  name: url
  defaultvalue: https://127.0.0.1
  type: 0
  required: true
- display: Demisto Server API Key
  name: apikey
  defaultvalue: ""
  type: 4
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: User system proxy settings
  name: proxy
  defaultvalue: "true"
  type: 8
  required: false
script:
  script: |
    var serverURL = params.url;
    if (serverURL.slice(-1) === '/') {
        serverURL = serverURL.slice(0,-1);
    }

    sendMultipart = function (uri, entryID, body) {
        var requestUrl = serverURL;
        if (uri.slice(-1) !== '/') {
            requestUrl += '/';
        }
        requestUrl += uri;

        var res = httpMultipart(
            requestUrl,
            entryID,
            {
                Headers: {
                    'Authorization': [params.apikey],
                    'Content-Type': ['multipart/form-data'],
                    'Accept': ['application/json']
                },
            },
            body,
            params.insecure,
            params.proxy,
            undefined,
            'file'
        );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Demisto REST APIs - Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }
        try {
            var response = res.Body;
            try {
                response = JSON.parse(res.Body);
            } catch (ex) {
                // do nothing, already handled prior the try/catch
            }
            return {response: response};
        } catch (ex) {
            throw 'Demisto REST APIs - Error parsing response - ' + ex + '\nBody:' + res.Body;
        }

    };

    var sendRequest = function(method, uri, body, raw) {
        var requestUrl = serverURL;
        if (uri.slice(-1) !== '/') {
            requestUrl += '/';
        }
        requestUrl += uri;

        var res = http(
            requestUrl,
            {
                Method: method,
                Headers: {
                    'Accept': ['application/json'],
                    'content-type': ['application/json'],
                    'authorization': [params.apikey]
                },
                Body: body,
                SaveToFile: raw
            },
            params.insecure,
            params.proxy
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Demisto REST APIs - Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }
        if (raw) {
            return res;
        } else {
            try {
                var response = res.Body;
                try {
                    response = JSON.parse(res.Body);
                } catch (ex) {
                    // do nothing, already handled prior the try/catch
                }
                return {response: response};
            } catch (ex) {
                throw 'Demisto REST APIs - Error parsing response - ' + ex + '\nBody:' + res.Body;
            }
        }
    };

    var deleteIncidents = function(ids_to_delete) {
        var body = {
            ids: ids_to_delete,
            all: false,
            filter: {}
        };

        var res = sendRequest('POST', '/incident/batchDelete', JSON.stringify(body));
        if (isError(res[0])) {
            throw res[0].Contents;
        }

        var response = res['response']
        var md = tableToMarkdown('Demisto delete incidents', response, ['data', 'total', "notUpdated"]);

        return {
            ContentsFormat: formats.json,
            Type: entryTypes.note,
            Contents: res,
            HumanReadable: md
        };
    };

    switch (command) {
        case 'test-module':
            sendRequest('GET','user');
            return 'ok';
        case 'demisto-api-post':
            var body = JSON.parse(args.body);
            return sendRequest('POST',args.uri, args.body);
        case 'demisto-api-get':
            return sendRequest('GET',args.uri);
        case 'demisto-api-put':
            var body = JSON.parse(args.body);
            return sendRequest('PUT',args.uri, args.body);
        case 'demisto-api-delete':
            return sendRequest('DELETE',args.uri);
        case 'demisto-api-multipart':
            return sendMultipart(args.uri, args.entryID, args.body);
        case 'demisto-api-download':
            var res = sendRequest('GET',args.uri,args.body,true);
            var filename = res.Path;
            if (args.filename) {
                filename = args.filename;
            } else {
                var disposition = res.Headers['Content-Disposition'][0].split('=');
                if (disposition.length === 2) {
                    filename = disposition[1];
                }
            }
            var desc = args.description || '';
            return ({Type: entryTypes.file, FileID: res.Path, File: filename, Contents: desc});
        case 'demisto-delete-incidents':
            var ids = argToList(args.ids);
            return deleteIncidents(ids);
        default:
            throw 'Demisto REST APIs - unknown command';
    }
  type: javascript
  commands:
  - name: demisto-api-post
    arguments:
    - name: uri
      required: true
      default: true
      description: Request URI (i.e. /incident)
    - name: body
      description: Body of HTTP POST
    description: send HTTP POST request
    execution: true
  - name: demisto-api-get
    arguments:
    - name: uri
      required: true
      default: true
      description: Request URI (i.e. /user)
    description: send HTTP GET requests
  - name: demisto-api-put
    arguments:
    - name: uri
      required: true
      default: true
      description: Request URI (i.e. /user)
    - name: body
      description: Request body
    description: send HTTP PUT request
    execution: true
  - name: demisto-api-delete
    arguments:
    - name: uri
      required: true
      default: true
      description: Request URI (i.e. /user)
    description: send HTTP DELETE request
    execution: true
  - name: demisto-api-download
    arguments:
    - name: uri
      required: true
      description: Request URI
    - name: filename
      description: File name of download
    - name: description
      description: Description of file entry
    description: Download files from Demisto server
  - name: demisto-api-multipart
    arguments:
    - name: uri
      required: true
      description: Request URI
    - name: entryID
      required: true
      description: File entry ID
    - name: body
      description: Request body
    description: Send HTTP Multipart request to upload files to Demisto server
  - name: demisto-delete-incidents
    arguments:
    - name: ids
      required: true
      description: IDs of the incidents to delete
    description: Delete Demisto incidents
    execution: true
  runonce: false
