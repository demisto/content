commonfields:
  id: AMP
  version: -1
name: AMP
display: Cisco AMP
category: Endpoint
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEkAAAAyCAYAAAAQlvbeAAAGx0lEQVR42u1Za2xURRTeOzPbYikPeWgRWx7y8JXwQ/3HDw2JxldMBDXGBIhiFF+AihDFhJDwA8KjElhLd/c+lkIRQhtRjPKIKIokCshD9s7c3S0FSgVFnilQlPW77ez2lr3VLs0uNt6TnGxzz8ycc78558w3tz5PPPHEE0888cQTTzz5T4lini5jYb6IBPaPy4c/svz4WKYfWqys/mNYtwGJ1tRNZypPUt38nFRxJdf+WDCxnmlmkhqHZ3cbkFgoGmEaT0KPMNUsyKkvwyRMN0WrP3N99wFJM8MSpDhTo7kFSecEfn6R/tZ4IHU3kJSTF4uZJl6hmrgvG5AUPT6QRaJTybLfR2bVnCPx4SitqUr5uZJsQKJqbAyLiFd9FaJP/pvzuvgc9Bs7sDqqix6dBQnAaraNquL7rPxFxJbWwyBe3VmQaFXMz3TBW2xBMT//JRU2y2VgJxB8n86DxDdK28Gs/Kn8R9mcv+o0SCrviWdHbZtf4ytzWPOiyL3v8MUysEa8QO8sQKqVtn3u68aKO/C3S877otMgabwIz+olSAF3+mAWdY2kaYeegoMGqlobSDDuzzVIROfT7MwkRnRmzkHad4rSDXVrWMg8Tqri47uSRZp0ftFviJJcg0Q1sd22Uc36IdcgsUqzH1rGOTlP78JRzivlImcKInkASRWbZVPfnnOQNN4P+pucF+wC3Td1uUhTgSEGXWNbJm2nsCPZgLRJNuBoZibx1kwK8Z0uIO2xbSiPrVk0bhukxhaQVB5yAemsbUPFXH8m0W3HJiNLLlJd7FAisUKnjXzZ+BzAuUxXWZuU2nraWZBomM9kutlMVyYqM/yFjsxj4egVUlu/IMMWjn4Ef1fop/UfdhYkpcok1OA1eN5MDGtyO9ta4YdtK2yX6MfRKV3jQ4Y1mEbMm9zvaKKUVNcVuJDJVC9L4KUz7dW8jCw9QdyzN1rmSl6D+xVaaWbYALgN0iHpb23GYbDGAhhWqTtB5YXYtNt9+RbZgCta05gnsFsst5fpuMJUgUwy0csso/t8Tyo/PZyFogHyTeOj+fBHIsfHoa8ElKW7R/k88cST/7XQtYlCNOk7QBVGM8O6uf2lNKrYXAXaE3a/+5dFPhDz74IOw0lT9M+XXDGAaeJOrDWE6ryg43Exmx+NxPgRYO89bhg4RKvrhWa5iBnCZrR/Qq9CT0Ofd1CBUnkLP+nX+evtj/QDJZi/ATZ5NcB8jFUCP5W5nJYPws82x9hmALXbt1IUt4uppqE/C/EVsDdA/5JxHcXYxcRI9M7v6bWsaQBTrT0AwQ74Wp3hAGmYDDQJkGal56+wCA2LzY45l6EXoEkltHd0uxff1jCJhfnVDD8gub6KeN/0mocvDGZVsShT3WICPdCtvT7twoD8lZgki5LSJ1hEvI/fl1AKS/FsggOkoTajlSDNbCsxMVTudJIaYiPIXn/7mgBONUZZuCOdHUq4bjiuP02Ol11HVfNlAPQmSrgSmZQGiYVFbRogne/F70yMm50mmlDMieSnzEL8Njhskrt5hKjWIPeRHYMEBl8GptySYQDsAPrGw3RVLIPV09XxeekX1OILOy59MSoFOjZrD10dK3LY+lKNR+U6l4gaL805SHD0UDrwsFjig2QFkhQarF/NdEdp6LyRRsSsa75+bkyVI0Ac2pEfZNf4tmwTUzLt/N10zFXWI7kHaV18XNqhYS24XpCUJacLmWHOha3e0WeSxDj8hmNDPktlAPpShxlAdfOZdEy6mOTydWF62l6dyP0tgFYfHtLSaFUbpFiMVB/rkz1IzheI+QH2E/JkRPnxXY4MWJgCj0ZiczqMqfLg3ehHV5GNSYD5HQ1y0lZuvDD1mQXaTLTYsPw07gCvcZweaJJiMvQx/D0Lp8jj/wYSCe4rpmHzAezwLZhXzHTrXvSSRll236bHreT3sJB5JU0RjNhyNPonMW8C+th8X6h1g8iGOoWtsbY4Trav4fsFgD8R6+1s62uiJn8UYMeZUpxocTh2pwDtQWqWIL2Xeu7XrFFy7AXoqfRcvCSJ1L/Yrilv+nUGelPShQI0+SqsNgpQe34EaMkxaXfTuBL4uTS/TLs6VoLgNTg/4wjkCnSyA6Qh0n4RIM1oA0nY/On8NS/RQMOJd9x7jvU01tqbOsGkWuBJvdoBqteVoT99kuJcUs9CI0S3Snw3QgDSrfZ/cZnewnIrqc4/AIca4biW9EZfmQZ9G/b7HeD1sjMOWg4NQZeghJ4l4Xp/x9wsOhbj5kKDyKJyGrEm+gIxlkEHDA6gxFsYVwENUFW8hrgG+TzxxBNPPPHEE0888eRGyN8R98jGg6pa+wAAAABJRU5ErkJggg==
description: Uses CISCO AMP Endpoint
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |-
    var username = params.credentials.identifier;
    var password = params.credentials.password;
    var server = params.server;
    var insecure = params.insecure;

    var fixArgs = function(command, args) {
        var newArgs = {};
        if (args) {
            var keys = Object.keys(args);
            for (var i = 0; i<keys.length; i++) {
                if (i !== 0) {
                    query += '&';
                }
                newArgs[fixBracketsArgs(command, keys[i])] = args[keys[i]];
            }
        }
        return newArgs;
    };

    var sendRequest = function(method, url, queryName, body) {
        var res = http(
                url,
                {
                    Method: method,
                    Username: username,
                    Password: password,
                    Body: body,
                    Headers: {
                        'accept': ['application/json'],
                        'content-type': ['application/json'],
                    },
                },
                insecure
            );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Failed to ' + queryName + ', request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }
        return res.Body;
    }

    var methodDict = {
        'amp_get_computers': 'GET',
        'amp_get_computer_by_connector': 'GET',
        'amp_get_computer_trajctory': 'GET',
        'amp_move_computer': 'PATCH',
        'amp_get_computer_actvity': 'GET',
        'amp_get_events': 'GET',
        'amp_get_event_types': 'GET',
        'amp_get_application_blocking': 'GET',
        'amp_get_file_list_by_guid': 'GET',
        'amp_get_simple_custom_detections': 'GET',
        'amp_get_file_list_files': 'GET',
        'amp_get_file_list_files_by_sha': 'GET',
        'amp_set_file_list_files_by_sha': 'POST',
        'amp_delete_file_list_files_by_sha': 'DELETE',
        'amp_get_groups': 'GET',
        'amp_get_group': 'GET',
        'amp_set_group_policy': 'PATCH',
        'amp_get_policies': 'GET',
        'amp_get_policy': 'GET',
        'amp_get_version': 'GET',
    }

    var urlDict = {
        'amp_get_computers': '/v1/computers',
        'amp_get_computer_by_connector': '/v1/computers',
        'amp_get_computer_trajctory': '/v1/computers',
        'amp_move_computer': '/v1/computers',
        'amp_get_computer_actvity': '/v1/computers/activity',
        'amp_get_events': '/v1/events',
        'amp_get_event_types': '/v1/event_types',
        'amp_get_application_blocking': '/v1/file_lists/application_blocking',
        'amp_get_file_list_by_guid': '/v1/file_lists',
        'amp_get_simple_custom_detections': '/v1/file_lists/simple_custom_detections',
        'amp_get_file_list_files': '/v1/file_lists',
        'amp_get_file_list_files_by_sha': '/v1/file_lists',
        'amp_set_file_list_files_by_sha': '/v1/file_lists',
        'amp_delete_file_list_files_by_sha': '/v1/file_lists',
        'amp_get_groups': '/v1/groups',
        'amp_get_group': '/v1/groups',
        'amp_set_group_policy': '/v1/groups',
        'amp_get_policies': '/v1/policies',
        'amp_get_policy': '/v1/policies',
        'amp_get_version': '/v1/version',
    }

    var getURL = function(command, args) {
        var base = urlDict[command];
        switch (command) {
            case 'amp_get_computer_by_connector':
                base += '/' + args['connector_guid'];
                delete args['connector_guid'];
                break;
            case 'amp_get_computer_trajctory':
                base += '/' + args['connector_guid'] + '/trajectory';
                delete args['connector_guid'];
                break;
            case 'amp_get_file_list_by_guid':
                base += '/' + args['file_list_guid'];
                delete args['file_list_guid'];
                break;
            case 'amp_get_file_list_files':
                base += '/' + args['file_list_guid'] + '/files';
                delete args['file_list_guid'];
                break;
            case 'amp_set_file_list_files_by_sha':
            case 'amp_get_file_list_files_by_sha':
            case 'amp_delete_file_list_files_by_sha':
                base += '/' + args['file_list_guid'] + '/files/' + args['sha256'];
                delete args['file_list_guid'];
                delete args['sha256'];
                break;
            case 'amp_get_group':
            case 'amp_set_group_policy':
                base += '/' + args['group_guid'];
                delete args['group_guid'];
                break;
            case 'amp_get_policy':
                base += '/' + args['policy_guid'];
                delete args['policy_guid'];
                break;
        }
        return base
    }

    var bracketsArgs = [
        'group_guid',
        'hostname',
        'connector_guid',
        'event_type',
        'name',
        'product'
        ];

    var fixBracketsArgs = function(command, arg) {
        if (bracketsArgs.indexOf(arg) !== -1) {
            if (command !== 'amp_get_groups') {
                return arg + '[]';
            }
        }
        return arg;
    }

    var encodeBody = function(args) {
        if (args) {
            return JSON.stringify(args);
        }
        return undefined;
    }

    switch (command) {
        case 'test-module':
            command = 'amp_get_version';
        default:
            var method = methodDict[command];
            var url = getURL(command, args);
            var query = '';
            var body = '';
            if (method === 'GET') {
                query = encodeToURLQuery(fixArgs(command, args));
            } else {
                body = encodeBody(args);
            }
            var res= sendRequest(
                method,
                server + url + query,
                urlDict[command],
                body
            );
            if (command === 'test-module') {
              return 'ok';
            } else {
              return res;
            }
    }
  type: javascript
  commands:
  - name: amp_get_computers
    arguments:
    - name: limit
      description: amount of results
    - name: hostname
      description: filter by hostname
    - name: internal_ip
      description: filter by internal ip
    - name: external_ip
      description: filter by external ip
    - name: group_guid
      description: filter by group guid
    description: Returns a list of computers with agents deployed on them. You can
      use parameters to narrow the search by IP address or hostname
  - name: amp_get_computer_by_connector
    arguments:
    - name: connector_guid
      required: true
      default: true
      description: the connector guid
    description: Shows information about a specific computer
  - name: amp_get_computer_trajctory
    arguments:
    - name: q
      description: hash
    - name: limit
      description: amount of results
    - name: connector_guid
      required: true
      default: true
      description: the connector guid
    description: Provides a list of all activities associated with a particular computer.
      This is analogous to the Device Trajectory on the FireAMP Console.  Using the
      Q parameter, you can search for an IP Address, SHA256 or URL
  - name: amp_move_computer
    arguments:
    - name: connector_guid
      required: true
      default: true
      description: the connector guid
    - name: group_guid
      required: true
      description: the group id
    description: Moves computer to a group with given connector_guid and group_guid
  - name: amp_get_computer_actvity
    arguments:
    - name: q
      required: true
      default: true
      description: an IPv4 address or SHA256 or filename or URL fragment
    - name: limit
      description: amount of results
    - name: offset
      description: 'offset '
    description: This endpoint provides you with the ability to search all computers
      across your organization for any events or activities associated with a file
      or network operation, and returns computers matching that criteria. You can
      then query the /computers/{connector-guid}/trajectory endpoint for specific
      details
  - name: amp_get_events
    arguments:
    - name: limit
      description: amount of results
    - name: connector_guid
      description: The connector guid
    - name: group_guid
      description: The group guid
    - name: detection_sha256
      description: The detected sha 256
    - name: application_sha256
      description: The application sha 256
    - name: event_type
      description: The event type
    - name: offset
      description: The offset
    - name: start_date
      description: The start date (Time ISO8601)
    description: This is a general query interface for events. This is analogous to
      the Events view on the FireAMP Console
  - name: amp_get_event_types
    arguments: []
    description: Events are identified and filtered by a unique ID, This endpoint
      provides a human readable name, and short description of each event by ID
  - name: amp_get_application_blocking
    arguments:
    - name: limit
      description: amount of results
    - name: offset
      description: The offset
    - name: name
      description: Name of file
    description: Returns a list of application blocking file lists. You can filter
      this list by name
  - name: amp_get_file_list_by_guid
    arguments:
    - name: file_list_guid
      required: true
      default: true
      description: The file_list_guid to retrieve information about a particular file_list
    description: Returns a particular file list for application blocking or simple
      custom detection. You need to provide a file_list_guid to retrieve information
      about a particular file_list.
  - name: amp_get_simple_custom_detections
    arguments:
    - name: limit
      description: amount of results
    - name: offset
      description: The offset
    - name: name
      description: Name of the detection
    description: Returns a list of simple custom detection file lists. You can filter
      this list by name
  - name: amp_get_file_list_files
    arguments:
    - name: limit
      description: amount of results
    - name: offset
      description: The offset
    - name: file_list_guid
      required: true
      default: true
      description: The file_list_guid to retrieve information about a particular file_list
    description: Returns a list of items for a particular file_list. You need to provide
      file_list_guid to retrieve these items
  - name: amp_get_file_list_files_by_sha
    arguments:
    - name: file_list_guid
      required: true
      default: true
      description: The file_list_guid to retrieve information about a particular file_list
    - name: sha256
      required: true
      description: The sha 256
    description: Returns a particular item for a given file_list. You need to provide
      a SHA-256 and file_list_guid to get an item
  - name: amp_set_file_list_files_by_sha
    arguments:
    - name: file_list_guid
      required: true
      default: true
      description: The file_list_guid to retrieve information about a particular file_list
    - name: sha256
      required: true
      description: The sha 256
    - name: description
      description: The sha256 description
    description: This endpoint can be used to add a SHA-256 to a file list using file_list_guid
  - name: amp_delete_file_list_files_by_sha
    arguments:
    - name: file_list_guid
      required: true
      default: true
      description: The file_list_guid to retrieve information about a particular file_list
    - name: sha256
      required: true
      description: The sha 256
    description: Deletes an item from a file_list using SHA-256 and file_list_guid.
      When SHA-256 is removed from file_list with file_list_guid
  - name: amp_get_groups
    arguments:
    - name: limit
      description: amount of results
    - name: name
      description: name of the group
    description: Provides basic information about groups in your organization. This
      endpoint is provided so that you can map group names to guids for filtering
      on the events endpoint
  - name: amp_get_group
    arguments:
    - name: group_guid
      required: true
      default: true
      description: The particular group guid
    description: Returns a particular group
  - name: amp_set_group_policy
    description: Set a security policy to group of endpoints
    arguments:
    - name: group_guid
      required: true
      default: true
      description: The particular group guid
    - name: linux_policy_guid
      description: The linux policy guide
    - name: android_policy_guid
      description: The android policy guide
    - name: mac_policy_guid
      description: The mac policy guide
    - name: windows_policy_guid
      description: The windows policy guide
  - name: amp_get_policies
    arguments:
    - name: limit
      description: amount of results
    - name: offset
      description: The offset
    - name: name
      description: The policy name
    - name: product
      description: The policy product
    description: Returns a list of policies. You can filter this list by name and
      product
  - name: amp_get_policy
    arguments:
    - name: policy_guid
      required: true
      default: true
      description: The policy guid
    description: Using this API, you can retrieve information about a particular policy
      based on policy_guid
  - name: amp_get_version
    arguments: []
    description: Fetch list of versions
system: true
