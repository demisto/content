commonfields:
  id: Pwned
  version: -1
name: Pwned
display: Have I Been Pwned?
category: Data Enrichment
image: data:image/png;base64,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
description: Check whether emails or domains have been compromised in recent breaches
  using the Have I Been Pwned? service
configuration:
- display: Use system proxy settings
  name: proxy
  defaultvalue: "true"
  type: 8
  required: false
script:
  script: |2

    var sendRequest = function(url) {
        var res = http(
            url,
            {
                Method: 'GET',
                Headers: {
                    'Accept': ['application/json'],
                }
            },
            false,
            params.proxy
        );

        if (res.StatusCode == 404) {
            return null;
        } else if (res.StatusCode < 200 || res.StatusCode>299) {
            throw 'Error ' + res.StatusCode + '. ' + res.Status;
        }

        var obj;
        try {
            obj = JSON.parse(res.Body);
        } catch (ex) {
            throw 'Error parsing reply - ' + result.Body + ' - ' + ex;
        }
        return obj;
    };

    var fixDesc = function(desc) {
        var newDesc = desc.replace(/<a href="(.+?)"(.+?)\>(.+?)<\/a>/g,'[$3]($1)');
        return newDesc;
    }

    var dataToMd = function(type,arg,obj) {
        var md = "### Have I Been Pwned query for " + type.toLowerCase() + ": *" + arg + "*\n";
        if (obj && obj.length>0) {
            for (var i=0;i<obj.length;i++) {
                var breach=obj[i];
                md += "#### " + breach.Title + " ("+breach.Domain+"): " + breach.PwnCount + " records breached\n";
                md += "Date: **" + breach.BreachDate + "**\n";
                md += fixDesc(breach.Description) + "\n";
                md += "Data breached: **" + breach.DataClasses + "**\n";
            }
        } else {
            md += "No records found";
        }
        return md;
    }
    function addCompromised(context, path, obj) {
      obj['properties_to_append'] = ['Compromised'];
      context[path] = obj;
    }
    var personsOutputPath= 'Persons(val.Emails && val.Emails == obj.Emails)';

    var emailToEc = function(email,obj) {
        var compSites = [];
        obj.forEach(function (item) {
            compSites.push(item.Domain);
        });
        compSites = compSites.sort();
        var compEmail = {};
        if (compSites.length > 0) {
            addCompromised(compEmail, personsOutputPath, {
                'Emails': email,
                'Compromised': {Vendor:'Pwned', Description: compSites.join(', ')}
            });
        }
        return compEmail;
    }
    var domainToEc = function(domain,obj) {
        var compSites = [];
        obj.forEach(function (item) {
            compSites.push(item.Domain);
        });
        compSites = compSites.sort();
        var compDomain = {};
        if (compSites.length > 0) {
            addCompromised(compDomain, outputPaths.domain, {
                'Name': domain,
                'Compromised': {Vendor:'Pwned', Description: compSites.join(', ')}
            });
        }
        return compDomain;
    }

    switch (command) {
        case 'test-module':
            var url = 'https://haveibeenpwned.com/api/v2/breaches?domain=demisto.com';
            var res = sendRequest(url);
            return 'ok';
        case 'pwned-email':
            var url = 'https://haveibeenpwned.com/api/v2/breachedaccount/' + args.email;
            var res = sendRequest(url);
            var md = dataToMd("Email",args.email,res);
            var ec = emailToEc(args.email,res || []);
            return {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
        case 'pwned-domain':
            var url = 'https://haveibeenpwned.com/api/v2/breaches?domain=' + args.domain;
            var res = sendRequest(url);
            var md = dataToMd("Domain",args.domain,res);
            var ec = domainToEc(args.domain,res || []);
            return {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
        default:
            throw 'Unknown command - ' + command;
    }
  type: javascript
  commands:
  - name: pwned-email
    arguments:
    - name: email
      required: true
      default: true
      description: Email to check
    outputs:
    - contextPath: Persons.Compromised.Vendor
      description: For comporomised emails, the vendor that made the decision
    - contextPath: Persons.Compromised.Reason
      description: For comporomised emails, the reason for the vendor to make the
        compromised decision
    - contextPath: Persons.Emails
      description: Email address
    important:
    - contextPath: Persons(val.Compromised)
      description: Compromised Persons
      related: ""
    description: Check if an email has been compromised as part of past breaches
  - name: pwned-domain
    arguments:
    - name: domain
      required: true
      default: true
      description: Domain to check
    outputs:
    - contextPath: Domain.Compromised.Vendor
      description: For comporomised domains, the vendor that made the decision
    - contextPath: Domain.Compromised.Reason
      description: For comporomised domains, the reason for the vendor to make the
        compromised decision
    - contextPath: Domain.Name
      description: Domain name
    important:
    - contextPath: Domain(val.Compromised)
      description: Compromised Domains
      related: ""
    description: Check if domain has been compromised
hidden: false
