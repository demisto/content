commonfields:
  id: Salesforce
  version: -1
name: Salesforce
display: Salesforce
category: Case Management
image: data:image/png;base64,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
description: CRM Services
configuration:
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Consumer Key
  name: clientID
  defaultvalue: ""
  type: 0
  required: true
- display: Consumer Secret
  name: clientSecret
  defaultvalue: ""
  type: 4
  required: true
- display: Instance URL
  name: InstanceURL
  defaultvalue: https://login.salesforce.com
  type: 0
  required: true
script:
  script: |-
    var authUrl = params.InstanceURL + '/services/oauth2/token';
    var uriPrefix = '/services/data/v20.0/';
    var sessionData = '';

    function getNewToken() {
        var request = {
                grant_type: 'password',
                client_id: params.clientID,
                client_secret: params.clientSecret,
                username: params.credentials.identifier,
                password: params.credentials.password
            };

        var body = encodeToURLQuery(request).substr(1);
        var response = http(
                    authUrl,
                    {
                        Method: 'POST',
                        Headers: {'Content-Type': ['application/x-www-form-urlencoded']},
                        Body: body,
                    },
                    false
                );
        if (response.StatusCode < 200 || response.StatusCode >= 300) {
            throw 'Failed to get new token, request status code: ' + response.StatusCode + ' and Body: ' + response.Body + '.';
        }
        return JSON.parse(response.Body);
    }


    function sendRequest(method, url, body, token) {
        var headers = {};
        if (token) {
            headers['Authorization'] = ['Bearer ' + token];
        }
        if (method == 'POST' || method == 'PATCH') {
            headers['Content-Type'] = ['application/json'];
        }
        return http(
                url,
                {
                    Method: method,
                    Headers: headers,
                    Body: body,
                },
                false
            );
    }

    function sendRequestInSession(method, uri, body) {
        if (!sessionData || !sessionData.access_token) {
            throw "Faield to get access token for Salesforce integration.";
        }
        var response = sendRequest(method, sessionData.instance_url + uriPrefix + uri, body, sessionData.access_token);
        if (response.StatusCode === 401) {
            sessionData = getNewToken();
            response = sendRequest(method, sessionData.instance_url + uriPrefix + uri, body, sessionData.access_token);
        }
        if (response.StatusCode < 200 || response.StatusCode >= 300) {
                throw 'Failed to run command uri: ' + uri + ', request status code: ' + response.StatusCode + ' and Body: ' + response.Body + '.';
        }
        return response;
    }


    sessionData = getNewToken();


    // The command input arg holds the command sent from the user.
    var response;
    switch (command) {
        case 'salesforce-search':
            response = sendRequestInSession('GET','search/?q=FIND+%7B' + args.pattern +'%7D','');
            return JSON.parse(response.Body);
        case 'salesforce-query':
            response = sendRequestInSession('GET','query/?q=' + args.query,'');
            return JSON.parse(response.Body);
        case 'salesforce-get-object':
            response = sendRequestInSession('GET','sobjects/' + args.path,'');
            return JSON.parse(response.Body);
        case 'salesforce-update-object':
            response = sendRequestInSession('PATCH','sobjects/' + args.path, args.json);
            if (response.StatusCode != 204) {
                throw  'object '+ args.path + ' update failed with status code: ' + response.StatusCode;
            }
            return 'object ' + args.path + ' updated';
        case 'salesforce-create-object':
            response = sendRequestInSession('POST','sobjects/' + args.path, args.json);
            return JSON.parse(response.Body);
        case 'test-module':
            try {
                sendRequestInSession('GET','','');
            } catch (err) {
                return 'Connection test failed with error: ' + err + '.';
            }
            return 'ok';
        default:
    }
  type: javascript
  commands:
  - name: salesforce-search
    arguments:
    - name: pattern
      required: true
      description: string or number to search
    description: Search records that contain values with pattern
  - name: salesforce-query
    arguments:
    - name: query
      required: true
      description: 'Query in SOQL format. Use ''+'' instead of spaces: SELECT+name+from+Account'
    description: Query Salesforce with SOQL
    execution: true
  - name: salesforce-get-object
    arguments:
    - name: path
      required: true
      description: 'Object path. Example: "Case/5000Y000001EjzRQAS" for Object "Case"
        with ID "5000Y000001EjzRQAS"'
    description: Get object by path
  - name: salesforce-update-object
    arguments:
    - name: path
      required: true
      description: 'Object path. Example: "Case/5000Y000001EjzRQAS" for Object "Case"
        with ID "5000Y000001EjzRQAS"'
    - name: json
      required: true
      description: JSON with fields and values of the object to be updated
    description: Update object fields
    execution: true
  - name: salesforce-create-object
    arguments:
    - name: path
      required: true
      description: 'Object path. Example: "Case/5000Y000001EjzRQAS" for Object "Case"
        with ID "5000Y000001EjzRQAS"'
    - name: json
      required: true
      description: JSON with fields and values of the object to be created
    description: Create new object
    execution: true
system: true
