commonfields:
  id: Salesforce
  version: -1
name: Salesforce
display: Salesforce
category: Case Management
image: data:image/png;base64,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
description: CRM Services
detaileddescription: |-
  To set up Salesforce to work with Demisto:
  Add a new connected App in salesforce by following the instruction [here](https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/intro_defining_remote_access_applications.htm)
  If you already have a connected App, go to “Setup” -> “App Manager” -> choose the correct App from the list and press “View”.
  The Consumer Key / Secret is under “API (Enable OAuth Settings)”
  For detailed instructions see the Credentials walkthrough section at [demisto support](https://support.demisto.com/hc/en-us/articles/360001848133-Integration-Salesforce).
configuration:
- display: Instance URL
  name: InstanceURL
  defaultvalue: https://login.salesforce.com
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Consumer Key
  name: clientID
  defaultvalue: ""
  type: 0
  required: true
- display: Consumer Secret
  name: clientSecret
  defaultvalue: ""
  type: 4
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: 'Fetch type: cases/comments (Only fetch comments when using the SalesforceAskUser
    automation)'
  name: fetchType
  defaultvalue: cases
  type: 0
  required: false
- display: Use system proxy settings
  name: useproxy
  defaultvalue: ""
  type: 8
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
script:
  script: |
    var URI_PREFIX = '/services/data/v39.0/';

    var SESSION_DATA = '';
    function getNewToken() {
        var request = {
            grant_type: 'password',
            client_id: params.clientID,
            client_secret: params.clientSecret,
            username: params.credentials.identifier,
            password: params.credentials.password
            };

        var body = encodeToURLQuery(request).substr(1);
        var response = http(
            params.InstanceURL + '/services/oauth2/token',
            {
                Method: 'POST',
                Headers: {'Content-Type': ['application/x-www-form-urlencoded']},
                Body: body,
            },
            params.insecure === false,
            params.useproxy
        );
        if (response.StatusCode < 200 || response.StatusCode >= 300) {
            throw 'Failed to get new token, request status code: ' + response.StatusCode + ' and Body: ' + response.Body + '.';
        }
        return JSON.parse(response.Body);
    }


    function sendRequest(method, url, body, token) {
        var headers = {};
        if (token) {
            headers['Authorization'] = ['Bearer ' + token];
        }
        if (method == 'POST' || method == 'PATCH') {
            headers['Content-Type'] = ['application/json'];
        }

        return http(
            url,
            {
                Method: method,
                Headers: headers,
                Body: body,
            },
            params.insecure === false,
            params.useproxy
        );
    }

    function sendRequestInSession(method, uri, body) {
        if (!SESSION_DATA || !SESSION_DATA.access_token) {
            throw "Faield to get access token for Salesforce integration.";
        }
        var response = sendRequest(method, SESSION_DATA.instance_url + URI_PREFIX + uri, body, SESSION_DATA.access_token);
        if (response.StatusCode === 401) {
            SESSION_DATA = getNewToken();
            response = sendRequest(method, SESSION_DATA.instance_url + URI_PREFIX + uri, body, SESSION_DATA.access_token);
        }
        if (response.StatusCode < 200 || response.StatusCode >= 300) {
                throw 'Failed to run command uri: ' + uri + ', request status code: ' + response.StatusCode + ' and Body: ' + response.Body + '.';
        }
        return response;
    }

    function getUserNames() {
        var res = queryObjects(['Id', 'Name'], 'User');
        var users = {};
        for (var i in res.records) {
            users[res.records[i].Id] = res.records[i].Name;
        }

        return users;
    }

    function casesToEntry(raw_info, title, userMapping) {
        // fix owner field
        if (userMapping) {
            for (var i in raw_info) {
                // use OwnerId if no user was found
                raw_info[i].OwnerId = userMapping[raw_info[i].OwnerId] || raw_info[i].OwnerId;
            }
        }

        return createEntry(raw_info, {
            contextPath: 'SalesForce.Case(val.ID && val.ID == obj.ID)',
            title: title,
            data: [
                {to: 'ID', from: 'Id', humanReadable: false},
                {to: 'CaseNumber', from: 'CaseNumber'},
                {to: 'Subject', from: 'Subject'},
                {to: 'Description', from: 'Description'},
                {to: 'CreatedDate', from: 'CreatedDate'},
                {to: 'ClosedDate', from: 'ClosedDate'},
                {to: 'Owner', from: 'OwnerId'},
                {to: 'Priority', from: 'Priority'},
                {to: 'Origin', from: 'Origin'},
                {to: 'Status', from: 'Status'},
                {to: 'Reason', from: 'Reason'},
            ]
        });
    }

    function contactsToEntry(raw_info, title, userMapping, accountMapping) {
        var i;
        // fix owner field
        if (userMapping) {
            for (i in raw_info) {
                // use OwnerId if no user was found
                raw_info[i].OwnerId = userMapping[raw_info[i].OwnerId] || raw_info[i].OwnerId;
            }
        }
        if (accountMapping) {
            for (i in raw_info) {
                // use AccountId if no account was found
                raw_info[i].AccountId = accountMapping[raw_info[i].AccountId] || raw_info[i].AccountId;
            }
        }

        return createEntry(raw_info, {
            contextPath: 'SalesForce.Contact(val.ID && val.ID == obj.ID)',
            title: title,
            data: [
                {to: 'ID', from: 'Id', humanReadable: false},
                {to: 'Name', from: 'Name'},
                {to: 'Account', from: 'AccountId'},
                {to: 'Title', from: 'Title'},
                {to: 'Phone', from: 'Phone'},
                {to: 'Mobile', from: 'MobilePhone'},
                {to: 'Email', from: 'Email'},
                {to: 'Owner', from: 'OwnerId'},
            ]
        });
    }

    function leadsToEntry(raw_info, title, userMapping) {
        // fix owner field
        if (userMapping) {
            for (var i in raw_info) {
                // use OwnerId if no user was found
                raw_info[i].OwnerId = userMapping[raw_info[i].OwnerId] || raw_info[i].OwnerId;
            }
        }
        return createEntry(raw_info, {
            contextPath: 'SalesForce.Lead(val.ID && val.ID == obj.ID)',
            title: title,
            data: [
                {to: 'ID', from: 'Id', humanReadable: false},
                {to: 'Name', from: 'Name'},
                {to: 'Title', from: 'Title'},
                {to: 'Company', from: 'Company'},
                {to: 'Phone', from: 'Phone'},
                {to: 'Mobile', from: 'MobilePhone'},
                {to: 'Email', from: 'Email'},
                {to: 'Owner', from: 'OwnerId'},
                {to: 'Status', from: 'Status'}
            ]
        });
    }

    function tasksToEntry(raw_info, title, lead_dict) {
        // fix owner field
        if (leadMapping) {
            for (var i in raw_info) {
                // use WhoId if no lead was found
                raw_info[i].WhoId = leadMapping[raw_info[i].WhoId] || raw_info[i].WhoId;
            }
        }

        return createEntry(raw_info, {
            contextPath: 'SalesForce.Task(val.ID && val.ID == obj.ID)',
            title: title,
            data: [
                {to: 'ID', from: 'Id', humanReadable: false},
                {to: 'Subject', from: 'Subject'},
                {to: 'Lead', from: 'WhoId'},
                {to: 'RelatedTo', from: 'RelatedTo'},
                {to: 'DueDate', from: 'ActivityDate'}
            ]
        });
    }

    function usersToEntry(raw_info, title, user_dict) {
        return createEntry(raw_info, {
            contextPath: 'SalesForce.User(val.ID && val.ID == obj.ID)',
            title: title,
            data: [
                {to: 'ID', from: 'Id', humanReadable: false},
                {to: 'Name', from: 'Name'},
                {to: 'Title', from: 'Title'},
                {to: 'Phone', from: 'Phone'},
                {to: 'Email', from: 'Email'}
            ]
        });
    }

    function objectToEntry(obj_type, obj) {
        var userMapping = getUserNames();
        switch (obj_type) {
            case 'Case':
                return casesToEntry([obj], 'Case:', userMapping);
            case 'Contact':
                accountMapping = undefined; // TODO: implement
                return contactsToEntry([obj], 'Contact:', userMapping, accountMapping);
            case 'Lead':
                return leadsToEntry([obj], 'Lead:', userMapping);
            case 'Task':
                leadMapping = undefined; // TODO: implement
                return tasksToEntry([obj], 'Lead:', leadMapping);
            case 'User':
                return usersToEntry([obj], 'User:');
            default:
                return obj;
        }
    }

    function queryToEntry(query) {
        return {
            Type : entryTypes.note,
            Contents : query.records,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            HumanReadable : tableToMarkdown('Query Results', query.records)
        };
    }

    function searchToEntry(searchRecords) {
        if (searchRecords.length === 0) {
            return {
                Type : entryTypes.Note,
                Contents : 'No records matched the search.',
                // ContentsFormat: formats.json,
                ReadableContentsFormat: formats.markdown
            };
        }

        var case_ids = [];
        var contact_ids = [];
        var lead_ids = [];
        var task_ids = [];
        var user_ids = [];
        var general = [];

        for (var i in searchRecords) {
            switch (searchRecords[i].attributes.type) {
                case 'Case':
                    case_ids.push(searchRecords[i].Id);
                    break;
                case 'Contact':
                    contact_ids.push(searchRecords[i].Id);
                    break;
                case 'Lead':
                    lead_ids.push(searchRecords[i].Id);
                    break;
                case 'Task':
                    task_ids.push(searchRecords[i].Id);
                    break;
                case 'User':
                    user_ids.push(searchRecords[i].Id);
                    break;
                default:
                    // in case we don't know how to parse the object
                    general.push(searchRecords[i]);
                    break;
            }
        }

        var condition, properties;
        var entries = [];
        var userMapping = getUserNames();
        if (case_ids.length > 0) {
            condition = "ID IN ('" + case_ids.join("','") + "')";
            properties = ['ID', 'CaseNumber', 'Subject', 'Description', 'CreatedDate', 'ClosedDate', 'OwnerID', 'Priority', 'Origin', 'Status', 'Reason'];
            var cases = queryObjects(properties, "Case", condition).records;
            entries.push(casesToEntry(cases, 'Cases:', userMapping));
        }
        if (contact_ids.length > 0) {
            condition = "ID IN ('" + contact_ids.join("','") + "')";
            properties = ['ID', 'Name', 'Title', 'AccountId', 'Phone', 'MobilePhone', 'Email', 'OwnerId'];
            var contacts = queryObjects(properties, "Contact", condition).records;
            entries.push(contactsToEntry(contacts, 'Contacts:', userMapping));
        }
        if (lead_ids.length > 0) {
            condition = "ID IN ('" + lead_ids.join("','") + "')";
            properties = ['ID', 'Name', 'Title', 'Company', 'Phone', 'MobilePhone', 'Email', 'Status', 'OwnerId'];
            var leads = queryObjects(properties, "Lead", condition).records;
            entries.push(leadsToEntry(leads, 'Leads:', userMapping));
        }
        if (task_ids.length > 0) {
            condition = "ID IN ('" + task_ids.join("','") + "')";
            properties = ['ID', 'Subject', 'WhoId', 'ActivityDate'];
            var tasks = queryObjects(properties, "Task", condition).records;
            entries.push(tasksToEntry(tasks, 'Tasks:'));
        }
        if (user_ids.length > 0) {
            condition = "ID IN ('" + user_ids.join("','") + "')";
            properties = ['ID', 'Name', 'Title', 'Phone', 'Email'];
            var users = queryObjects(properties, "User", condition).records;
            entries.push(usersToEntry(users, 'Users:'));
        }

        if (general.length > 0) entries.push({'unparsed' : general});
        return entries;
    }

    function queryRaw(query) {
        var url = 'query/' + encodeToURLQuery({q : query});
        response = sendRequestInSession('GET', url, '');
        return JSON.parse(response.Body);
    }

    function queryObjects(fields, table, condition) {
        query = 'SELECT ' + fields.join(',') + ' FROM ' + table;
        if (condition !== undefined) {
            query += ' WHERE ' + condition;
        }

        return queryRaw(query);
    }

    function getObject(path) {
        response = sendRequestInSession('GET', 'sobjects/' + path, '');
        return objectToEntry(path.split('/')[0], JSON.parse(response.Body));
    }

    function createObject(path, json_obj) {
        response = sendRequestInSession('POST','sobjects/' + path, json_obj);
        response = JSON.parse(response.Body);

        if (response.success !== true) {
            return {
                Type: entryTypes.note,
                Contents: response,
                ContentsFormat: formats.json,
                ReadableContentsFormat: formats.markdown,
                HumanReadable : tableToMarkdown('Request failed with errors', response.errors, undefined, undefined, dotToSpace)
            };
        }

        return getObject(path + '/' + response.id);
    }

    function updateObject(path, json_obj) {
        response = sendRequestInSession('PATCH','sobjects/' + path, json_obj);
        if (response.StatusCode != 204) {
            throw 'object '+ path + ' update failed with status code: ' + response.StatusCode;
        }

        return getObject(path);
    }

    function deleteObject(path) {
        response = sendRequestInSession('DELETE', 'sobjects/' + path);
        if (response.StatusCode != 204) {
            throw 'object ' + path + ' delete failed with status code: ' + response.StatusCode;
        }

        return 'object ' + path + 'was successfully deleted.';
    }

    function getCase(oid, caseNumber) {
        if (caseNumber !== undefined) {
            var condition = "CaseNumber='" + caseNumber + "'";
            var properties = ['ID', 'CaseNumber', 'Subject', 'Description', 'CreatedDate', 'ClosedDate', 'OwnerID', 'Priority', 'Origin', 'Status', 'Reason'];
            cases = queryObjects(properties, 'Case', condition).records;
            return casesToEntry(cases, 'Case #' + caseNumber + ':', getUserNames());
        }

        if (oid !== undefined) {
            return getObject('Case/' + oid);
        }

        return {
            Type : entryTypes.error,
            Contents : 'You must specify object ID or a Case Number',
            // ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown
        };
    }

    function createCase(subject, description, status, origin, priority, caseType) {
        var data = {
            Subject : subject,
            Description : description,
            Status : status,
            Origin : origin,
            Priority : priority,
            Type : caseType
        };

        return createObject('Case', JSON.stringify(data));
    }

    function updateCase(oid, caseNumber, subject, description, status, origin, priority, caseType) {
        if ((oid === undefined) && (caseNumber === undefined)) {
            return {
                Type : entryTypes.error,
                Contents : 'You must specify object ID or a Case Number',
                // ContentsFormat: formats.json,
                ReadableContentsFormat: formats.markdown
            };
        }

        if (oid === undefined) {
            var condition = "CaseNumber='" + caseNumber + "'";
            cases = queryObjects(['ID'], 'Case', condition).records;
            oid = (cases.length === 1) ? cases[0].Id : undefined;
        }

        var data = {
            Subject : subject,
            Description : description,
            Status : status,
            Origion : origin,
            Priority : priority,
            Type : caseType
        };

        return updateObject('Case/' + oid, JSON.stringify(data));
    }

    function getCases() {
        var properties = ['ID', 'CaseNumber', 'Subject', 'Description', 'CreatedDate', 'ClosedDate', 'OwnerID', 'Priority', 'Origin', 'Status', 'Reason'];
            cases = queryObjects(properties, 'Case').records;
            return casesToEntry(cases, 'Cases:', getUserNames());
    }

    function closeCase(oid, caseNumber) {
        return updateCase(oid, caseNumber, undefined, undefined, 'Closed');
    }

    function deleteCase(oid, caseNumber) {
        if ((oid === undefined) && (caseNumber === undefined)) {
            return {
                Type : entryTypes.error,
                Contents : 'You must specify object ID or a Case Number',
                // ContentsFormat: formats.json,
                ReadableContentsFormat: formats.markdown
            };
        }

        if (oid === undefined) {
            var condition = "CaseNumber='" + caseNumber + "'";
            cases = queryObjects(['ID'], 'Case', condition).records;
            oid = (cases.length === 1) ? cases[0].Id : undefined;
        }

        return deleteObject('Case/' + oid);
    }

    function pushComment(oid, text, linkUrl) {
        data = {
            body : {
                messageSegments : [{
                    type : 'Text',
                    text : text
                }],
            },
            feedElementType : 'FeedItem',
            subjectId : oid
        };

        if (linkUrl !== undefined) {
            data.body.messageSegments.push({
                type : 'Link',
                url : linkUrl});
        }

        response = sendRequestInSession('POST', 'chatter/feed-elements', JSON.stringify(data));
        message = JSON.parse(response.Body);

        return createEntry(message, {
            title : 'New Message',
            contextPath: 'SalesForce.Comment(val.URL && val.URL == obj.URL)',
            data : [
                {to : 'Body', from : 'body.text'},
                {to : 'CreatedDate', from : 'createdDate'},
                {to : 'Title', from : 'header.text'},
                {to : 'ParentType', from : 'parent.type'},
                {to : 'ParentName', from : 'parent.name'},
                {to : 'URL', from : 'url'},
                {to : 'Visibility', from : 'visibility'}
                ]
        });
    }

    function pushCommentThread(id, text) {
        var data = {
            body : {
                messageSegments : [{
                    type : 'Text',
                    text : text
                }]
            }
        };

        var response = sendRequestInSession('POST', 'chatter/feed-elements/'+ id +'/capabilities/comments/items', JSON.stringify(data));
        var message = JSON.parse(response.Body);
        var output = {
            Body: message.body.text,
            CreatedDate: message.createdDate,
            URL: message.url
        }

        ec = {
            'SalesForce.Comment(val.URL && val.URL == obj.URL)': {
                URL: URI_PREFIX + 'chatter/feed-elements/' + id,
                Reply: output
            }
        }

        return {
            Type: entryTypes.note,
            Contents: message,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: tableToMarkdown('New Reply', output),
            EntryContext: ec
        };
    }

    function casesToIncidents(raw_info, userMapping) {
        var cases = [];
        for (var i in raw_info) {
            cases.push({
                name : raw_info[i].Id + " " + raw_info[i].Subject,
                details : raw_info[i].Description,
                rawJSON : JSON.stringify(raw_info[i]),
                Reason : raw_info[i].Reason
            });
        }
        if (cases.length == 0) {
            return '[]';
        } else {
            return JSON.stringify(cases);
        }
    }


    function fetchIncident() {
        var fetchType = params.fetchType

        lastRun = getLastRun();
        if (lastRun.last_case_time === undefined) {
            current_time = new Date();
            current_time.setMonth(current_time.getMonth() - 1); // TODO - remove this line
            lastRun.last_case_time = dateToString(current_time, "%Y-%m-%dT%H:%M:%S.%fZ");
            setLastRun(lastRun);
        }

        var condition;
        var properties;
        var incidents;

        if (fetchType === 'cases') {
            // query cases from last time
            condition = "CreatedDate>" + lastRun.last_case_time + " ORDER BY CreatedDate DESC";
            properties = ['ID', 'CaseNumber', 'Subject', 'Description', 'CreatedDate', 'ClosedDate', 'OwnerID', 'Priority', 'Origin', 'Status', 'Reason'];

            var cases = queryObjects(properties, "Case", condition).records;

            if (cases.length > 0) {
                new_time = stringToDate(cases[0].CreatedDate, "%Y-%m-%dT%H:%M:%S.%fZ");
                lastRun.last_case_time = dateToString(new_time, "%Y-%m-%dT%H:%M:%S.%fZ");

                setLastRun(lastRun);
                var userMapping = getUserNames();
                incidents = casesToIncidents(cases, userMapping);
            }

        } else { //fetchType === 'comment'

            //query comments from last time

            incidents = '[]';

            //Fetch comment replies
            properties = ['Id', 'CommentBody', 'CreatedDate'];
            condition = "CreatedDate>" + lastRun.last_case_time + " ORDER BY CreatedDate DESC LIMIT 10";
            var replies = queryObjects(properties, "FeedComment", condition).records;

            if (replies.length > 0) {

                var newTime = stringToDate(replies[0].CreatedDate, "%Y-%m-%dT%H:%M:%S.%fZ");
                lastRun.last_case_time = dateToString(newTime, "%Y-%m-%dT%H:%M:%S.%fZ");
                setLastRun(lastRun);

                for (var i = 0; i < replies.length; i++) {

                    //Get reply details
                    var replyDetails = sendRequestInSession('GET', 'chatter/comments/' + replies[i].Id);
                    var data = JSON.parse(replyDetails.Body);
                    var feedElement = data.feedElement;
                    var parentID = feedElement.id;

                    //Get parent details
                    var parentDetails = getObject('CaseFeed/' + parentID);
                    var parentText = parentDetails.Body;

                    if (parentText.indexOf('DemistoID') !== -1) {

                        var messageSegments = data.body.messageSegments;
                        for (var j = 0; j < messageSegments.length; j++)
                        if (messageSegments[j].type === 'Text') {
                            // Found the relavent comment (there's only one), so we return it
                            return JSON.stringify([{
                                name: parentText,
                                details: messageSegments[j].text
                            }]);
                        }
                    }
                }
            }
        }
        return incidents;
    }

    SESSION_DATA = getNewToken();
    // The command input arg holds the command sent from the user.
    var response;
    switch (command) {
        case 'fetch-incidents':
            return fetchIncident();
        case 'salesforce-search':
            response = sendRequestInSession('GET','search/?q=FIND+%7B' + args.pattern +'%7D','');
            logInfo(response.Body);
            return searchToEntry(JSON.parse(response.Body).searchRecords);
        case 'salesforce-query':
            return queryToEntry(queryRaw(args.query));
        case 'salesforce-get-object':
            return getObject(args.path);
        case 'salesforce-update-object':
            return updateObject(args.path, args.json);
        case 'salesforce-create-object':
            return createObject(args.path, args.json);
        case 'salesforce-get-case':
            return getCase(args.oid, args.caseNumber);
        case 'salesforce-create-case':
            return createCase(args.subject, args.description, args.status, args.origin, args.priority, args.type);
        case 'salesforce-update-case':
            return updateCase(args.oid, args.caseNumber, args.subject, args.description, args.status, args.origin, args.priority, args.type);
        case 'salesforce-get-cases':
            return getCases();
        case 'salesforce-close-case':
            return closeCase(args.oid, args.caseNumber);
        case 'salesforce-delete-case':
            return deleteCase(args.oid, args.caseNumber);
        case 'salesforce-push-comment':
            return pushComment(args.oid, args.text, args.link);
        case 'salesforce-push-comment-threads':
            return pushCommentThread(args.id, args.text);
        case 'test-module':
            try {
                sendRequestInSession('GET', '', '');
            } catch (err) {
                return 'Connection test failed with error: ' + err + '.';
            }
            return 'ok';
        default:
    }
  type: javascript
  commands:
  - name: salesforce-search
    arguments:
    - name: pattern
      required: true
      description: string or number to search
    outputs:
    - contextPath: SalesForce.Case.ID
      description: Case Object ID
      type: string
    - contextPath: SalesForce.Case.CaseNumber
      description: Case Number
      type: string
    - contextPath: SalesForce.Case.Subject
      description: Case Subject
      type: string
    - contextPath: SalesForce.Case.Description
      description: Case Description
      type: string
    - contextPath: SalesForce.Case.CreateDate
      description: Creation Time of Case
      type: date
    - contextPath: SalesForce.Case.ClosedDate
      description: Closure Time of Case
      type: date
    - contextPath: SalesForce.Case.Owner
      description: Case Owner
      type: string
    - contextPath: SalesForce.Case.Priority
      description: Priority of the Case. one of Low, Medium, High.
      type: string
    - contextPath: SalesForce.Case.Origin
      description: Origin of the Case. one of Web, Phone, Email
      type: string
    - contextPath: SalesForce.Case.Status
      description: 'Case Status. one of the following: New, Escalated, On Hold or
        Closed'
      type: string
    - contextPath: SalesForce.Case.Reason
      description: Reason for case creation
      type: string
    - contextPath: SalesForce.Contact.ID
      description: Contact ID
      type: string
    - contextPath: SalesForce.Contact.Name
      description: Contact Name
      type: string
    - contextPath: SalesForce.Contact.Account
      description: Account associated with the Contact info
      type: string
    - contextPath: SalesForce.Contact.Title
      description: Contact Title
      type: string
    - contextPath: SalesForce.Contact.Phone
      description: Contact Phone Number
      type: string
    - contextPath: SalesForce.Contact.MobliePhone
      description: Contact Mobile Number
      type: string
    - contextPath: SalesForce.Contact.Email
      description: Contact Email
      type: string
    - contextPath: SalesForce.Contact.Owner
      description: Contact Owner
      type: string
    - contextPath: SalesForce.Lead.ID
      description: Lead ID
      type: string
    - contextPath: SalesForce.Lead.Name
      description: Lead Name
      type: string
    - contextPath: SalesForce.Lead.Title
      description: Lead Title
      type: string
    - contextPath: SalesForce.Lead.Company
      description: Lead Company
      type: string
    - contextPath: SalesForce.Lead.Phone
      description: Lead Phone Number
      type: string
    - contextPath: SalesForce.Lead.Mobile
      description: Lead Mobile Number
      type: string
    - contextPath: SalesForce.Lead.Email
      description: Lead Email
      type: string
    - contextPath: SalesForce.Lead.Owner
      description: Lead Owner
      type: string
    - contextPath: SalesForce.Lead.Status
      description: 'Lead Status. can be one of the following: New, Nurturing, Working,
        Qualified or Unqualified'
      type: string
    - contextPath: SalesForce.Task.ID
      description: Task ID
      type: string
    - contextPath: SalesForce.Task.Subject
      description: Task Subject
      type: string
    - contextPath: SalesForce.Task.Lead
      description: Task Leader
      type: string
    - contextPath: SalesForce.Task.RelatedTo
      description: Relevant Account
      type: string
    - contextPath: SalesForce.Task.DueDate
      description: Task Due Date
      type: date
    - contextPath: SalesForce.User.ID
      description: User ID
      type: string
    - contextPath: SalesForce.User.Name
      description: User Name
      type: string
    - contextPath: SalesForce.User.Title
      description: User Title
      type: string
    - contextPath: SalesForce.User.Phone
      description: User Phone Number
      type: string
    - contextPath: SalesForce.User.Email
      description: User Email
      type: string
    description: Search records that contain values with pattern
  - name: salesforce-query
    arguments:
    - name: query
      required: true
      description: 'Query in SOQL format: "SELECT name from Account"'
    description: Query Salesforce with SOQL
    execution: true
  - name: salesforce-get-object
    arguments:
    - name: path
      required: true
      description: 'Object path. Example: "Case/5000Y000001EjzRQAS" for Object "Case"
        with ID "5000Y000001EjzRQAS"'
    outputs:
    - contextPath: SalesForce.Case.ID
      description: Case Object ID
      type: string
    - contextPath: SalesForce.Case.CaseNumber
      description: Case Number
      type: string
    - contextPath: SalesForce.Case.Subject
      description: Case Subject
      type: string
    - contextPath: SalesForce.Case.Description
      description: Case Description
      type: string
    - contextPath: SalesForce.Case.CreateDate
      description: Creation Time of Case
      type: date
    - contextPath: SalesForce.Case.ClosedDate
      description: Closure Time of Case
      type: date
    - contextPath: SalesForce.Case.Owner
      description: Case Owner
      type: string
    - contextPath: SalesForce.Case.Priority
      description: Priority of the Case. one of Low, Medium, High.
      type: string
    - contextPath: SalesForce.Case.Origin
      description: Origin of the Case. one of Web, Phone, Email
      type: string
    - contextPath: SalesForce.Case.Status
      description: 'Case Status. one of the following: New, Escalated, On Hold or
        Closed'
      type: string
    - contextPath: SalesForce.Case.Reason
      description: Reason for case creation
      type: string
    - contextPath: SalesForce.Contact.ID
      description: Contact ID
      type: string
    - contextPath: SalesForce.Contact.Name
      description: Contact Name
      type: string
    - contextPath: SalesForce.Contact.Account
      description: Account associated with the Contact info
      type: string
    - contextPath: SalesForce.Contact.Title
      description: Contact Title
      type: string
    - contextPath: SalesForce.Contact.Phone
      description: Contact Phone Number
      type: string
    - contextPath: SalesForce.Contact.MobliePhone
      description: Contact Mobile Number
      type: string
    - contextPath: SalesForce.Contact.Email
      description: Contact Email
      type: string
    - contextPath: SalesForce.Contact.Owner
      description: Contact Owner
      type: string
    - contextPath: SalesForce.Lead.ID
      description: Lead ID
      type: string
    - contextPath: SalesForce.Lead.Name
      description: Lead Name
      type: string
    - contextPath: SalesForce.Lead.Title
      description: Lead Title
      type: string
    - contextPath: SalesForce.Lead.Company
      description: Lead Company
      type: string
    - contextPath: SalesForce.Lead.Phone
      description: Lead Phone Number
      type: string
    - contextPath: SalesForce.Lead.Mobile
      description: Lead Mobile Number
      type: string
    - contextPath: SalesForce.Lead.Email
      description: Lead Email
      type: string
    - contextPath: SalesForce.Lead.Owner
      description: Lead Owner
      type: string
    - contextPath: SalesForce.Lead.Status
      description: 'Lead Status. can be one of the following: New, Nurturing, Working,
        Qualified or Unqualified'
      type: string
    - contextPath: SalesForce.Task.ID
      description: Task ID
      type: string
    - contextPath: SalesForce.Task.Subject
      description: Task Subject
      type: string
    - contextPath: SalesForce.Task.Lead
      description: Task Leader
      type: string
    - contextPath: SalesForce.Task.RelatedTo
      description: Relevant Account
      type: string
    - contextPath: SalesForce.Task.DueDate
      description: Task Due Date
      type: date
    - contextPath: SalesForce.User.ID
      description: User ID
      type: string
    - contextPath: SalesForce.User.Name
      description: User Name
      type: string
    - contextPath: SalesForce.User.Title
      description: User Title
      type: string
    - contextPath: SalesForce.User.Phone
      description: User Phone Number
      type: string
    - contextPath: SalesForce.User.Email
      description: User Email
      type: string
    description: Get object by path
  - name: salesforce-update-object
    arguments:
    - name: path
      required: true
      description: 'Object path. Example: "Case/5000Y000001EjzRQAS" for Object "Case"
        with ID "5000Y000001EjzRQAS"'
    - name: json
      required: true
      description: JSON with fields and values of the object to be updated
    outputs:
    - contextPath: SalesForce.Case.ID
      description: Case Object ID
      type: string
    - contextPath: SalesForce.Case.CaseNumber
      description: Case Number
      type: string
    - contextPath: SalesForce.Case.Subject
      description: Case Subject
      type: string
    - contextPath: SalesForce.Case.Description
      description: Case Description
      type: string
    - contextPath: SalesForce.Case.CreateDate
      description: Creation Time of Case
      type: date
    - contextPath: SalesForce.Case.ClosedDate
      description: Closure Time of Case
      type: date
    - contextPath: SalesForce.Case.Owner
      description: Case Owner
      type: string
    - contextPath: SalesForce.Case.Priority
      description: Priority of the Case. one of Low, Medium, High.
      type: string
    - contextPath: SalesForce.Case.Origin
      description: Origin of the Case. one of Web, Phone, Email
      type: string
    - contextPath: SalesForce.Case.Status
      description: 'Case Status. one of the following: New, Escalated, On Hold or
        Closed'
      type: string
    - contextPath: SalesForce.Case.Reason
      description: Reason for case creation
      type: string
    - contextPath: SalesForce.Contact.ID
      description: Contact ID
      type: string
    - contextPath: SalesForce.Contact.Name
      description: Contact Name
      type: string
    - contextPath: SalesForce.Contact.Account
      description: Account associated with the Contact info
      type: string
    - contextPath: SalesForce.Contact.Title
      description: Contact Title
      type: string
    - contextPath: SalesForce.Contact.Phone
      description: Contact Phone Number
      type: string
    - contextPath: SalesForce.Contact.MobliePhone
      description: Contact Mobile Number
      type: string
    - contextPath: SalesForce.Contact.Email
      description: Contact Email
      type: string
    - contextPath: SalesForce.Contact.Owner
      description: Contact Owner
      type: string
    - contextPath: SalesForce.Lead.ID
      description: Lead ID
      type: string
    - contextPath: SalesForce.Lead.Name
      description: Lead Name
      type: string
    - contextPath: SalesForce.Lead.Title
      description: Lead Title
      type: string
    - contextPath: SalesForce.Lead.Company
      description: Lead Company
      type: string
    - contextPath: SalesForce.Lead.Phone
      description: Lead Phone Number
      type: string
    - contextPath: SalesForce.Lead.Mobile
      description: Lead Mobile Number
      type: string
    - contextPath: SalesForce.Lead.Email
      description: Lead Email
      type: string
    - contextPath: SalesForce.Lead.Owner
      description: Lead Owner
      type: string
    - contextPath: SalesForce.Lead.Status
      description: 'Lead Status. can be one of the following: New, Nurturing, Working,
        Qualified or Unqualified'
      type: string
    - contextPath: SalesForce.Task.ID
      description: Task ID
      type: string
    - contextPath: SalesForce.Task.Subject
      description: Task Subject
      type: string
    - contextPath: SalesForce.Task.Lead
      description: Task Leader
      type: string
    - contextPath: SalesForce.Task.RelatedTo
      description: Relevant Account
      type: string
    - contextPath: SalesForce.Task.DueDate
      description: Task Due Date
      type: date
    - contextPath: SalesForce.User.ID
      description: User ID
      type: string
    - contextPath: SalesForce.User.Name
      description: User Name
      type: string
    - contextPath: SalesForce.User.Title
      description: User Title
      type: string
    - contextPath: SalesForce.User.Phone
      description: User Phone Number
      type: string
    - contextPath: SalesForce.User.Email
      description: User Email
      type: string
    description: Update object fields
    execution: true
  - name: salesforce-create-object
    arguments:
    - name: path
      required: true
      description: 'Object path. Example: "Case" for Object "Case"'
    - name: json
      required: true
      description: JSON with fields and values of the object to be created
    outputs:
    - contextPath: SalesForce.Case.ID
      description: Case Object ID
      type: string
    - contextPath: SalesForce.Case.CaseNumber
      description: Case Number
      type: string
    - contextPath: SalesForce.Case.Subject
      description: Case Subject
      type: string
    - contextPath: SalesForce.Case.Description
      description: Case Description
      type: string
    - contextPath: SalesForce.Case.CreateDate
      description: Creation Time of Case
      type: date
    - contextPath: SalesForce.Case.ClosedDate
      description: Closure Time of Case
      type: date
    - contextPath: SalesForce.Case.Owner
      description: Case Owner
      type: string
    - contextPath: SalesForce.Case.Priority
      description: Priority of the Case. one of Low, Medium, High.
      type: string
    - contextPath: SalesForce.Case.Origin
      description: Origin of the Case. one of Web, Phone, Email
      type: string
    - contextPath: SalesForce.Case.Status
      description: 'Case Status. one of the following: New, Escalated, On Hold or
        Closed'
      type: string
    - contextPath: SalesForce.Case.Reason
      description: Reason for case creation
      type: string
    - contextPath: SalesForce.Contact.ID
      description: Contact ID
      type: string
    - contextPath: SalesForce.Contact.Name
      description: Contact Name
      type: string
    - contextPath: SalesForce.Contact.Account
      description: Account associated with the Contact info
      type: string
    - contextPath: SalesForce.Contact.Title
      description: Contact Title
      type: string
    - contextPath: SalesForce.Contact.Phone
      description: Contact Phone Number
      type: string
    - contextPath: SalesForce.Contact.MobliePhone
      description: Contact Mobile Number
      type: string
    - contextPath: SalesForce.Contact.Email
      description: Contact Email
      type: string
    - contextPath: SalesForce.Contact.Owner
      description: Contact Owner
      type: string
    - contextPath: SalesForce.Lead.ID
      description: Lead ID
      type: string
    - contextPath: SalesForce.Lead.Name
      description: Lead Name
      type: string
    - contextPath: SalesForce.Lead.Title
      description: Lead Title
      type: string
    - contextPath: SalesForce.Lead.Company
      description: Lead Company
      type: string
    - contextPath: SalesForce.Lead.Phone
      description: Lead Phone Number
      type: string
    - contextPath: SalesForce.Lead.Mobile
      description: Lead Mobile Number
      type: string
    - contextPath: SalesForce.Lead.Email
      description: Lead Email
      type: string
    - contextPath: SalesForce.Lead.Owner
      description: Lead Owner
      type: string
    - contextPath: SalesForce.Lead.Status
      description: 'Lead Status. can be one of the following: New, Nurturing, Working,
        Qualified or Unqualified'
      type: string
    - contextPath: SalesForce.Task.ID
      description: Task ID
      type: string
    - contextPath: SalesForce.Task.Subject
      description: Task Subject
      type: string
    - contextPath: SalesForce.Task.Lead
      description: Task Leader
      type: string
    - contextPath: SalesForce.Task.RelatedTo
      description: Relevant Account
      type: string
    - contextPath: SalesForce.Task.DueDate
      description: Task Due Date
      type: date
    - contextPath: SalesForce.User.ID
      description: User ID
      type: string
    - contextPath: SalesForce.User.Name
      description: User Name
      type: string
    - contextPath: SalesForce.User.Title
      description: User Title
      type: string
    - contextPath: SalesForce.User.Phone
      description: User Phone Number
      type: string
    - contextPath: SalesForce.User.Email
      description: User Email
      type: string
    description: Create new object
    execution: true
  - name: salesforce-push-comment
    arguments:
    - name: oid
      required: true
      description: Object ID of Subject
    - name: text
      required: true
      description: Chat text
    - name: link
      description: Add a link to the message
    outputs:
    - contextPath: SalesForce.Comment.Body
      description: Comment body
      type: string
    - contextPath: SalesForce.Comment.CreatedDate
      description: Comment created date
      type: date
    - contextPath: SalesForce.Comment.Title
      description: Comment title
      type: string
    - contextPath: SalesForce.Comment.ParentType
      description: Comment parent type
      type: string
    - contextPath: SalesForce.Comment.ParentName
      description: Comment parent name
      type: string
    - contextPath: SalesForce.Comment.URL
      description: Comment URL link
      type: string
    - contextPath: SalesForce.Comment.Visibility
      description: Comment visibility
      type: string
    description: Add a comment  to chatter
  - name: salesforce-get-case
    arguments:
    - name: oid
      description: Object ID of desired case
    - name: caseNumber
      description: Case number of desired case
    outputs:
    - contextPath: SalesForce.Case.ID
      description: Case Object ID
      type: string
    - contextPath: SalesForce.Case.CaseNumber
      description: Case Number
      type: string
    - contextPath: SalesForce.Case.Subject
      description: Case Subject
      type: string
    - contextPath: SalesForce.Case.Description
      description: Case Description
      type: string
    - contextPath: SalesForce.Case.CreateDate
      description: Creation Time of Case
      type: date
    - contextPath: SalesForce.Case.ClosedDate
      description: Closure Time of Case
      type: date
    - contextPath: SalesForce.Case.Owner
      description: Case Owner
      type: string
    - contextPath: SalesForce.Case.Priority
      description: Priority of the Case. one of Low, Medium, High.
      type: string
    - contextPath: SalesForce.Case.Origin
      description: Origin of the Case. one of Web, Phone, Email
      type: string
    - contextPath: SalesForce.Case.Status
      description: 'Case Status. one of the following: New, Escalated, On Hold or
        Closed'
      type: string
    - contextPath: SalesForce.Case.Reason
      description: Reason for case creation
      type: string
    description: Get info on a case
  - name: salesforce-create-case
    arguments:
    - name: subject
      required: true
      default: true
      description: Case Subject
    - name: description
      description: Case Description
    - name: status
      required: true
      auto: PREDEFINED
      predefined:
      - New
      - On Hold
      - Closed
      - Escalated
      description: Case Status
      defaultValue: New
    - name: origin
      auto: PREDEFINED
      predefined:
      - Email
      - Phone
      - Web
      description: Case Origin
    - name: priority
      auto: PREDEFINED
      predefined:
      - Low
      - Medium
      - High
      description: Case Priority
      defaultValue: Low
    - name: type
      auto: PREDEFINED
      predefined:
      - Question
      - Problem
      - Feature Request
      description: Case Type
    outputs:
    - contextPath: SalesForce.Case.ID
      description: Case Object ID
      type: string
    - contextPath: SalesForce.Case.CaseNumber
      description: Case Number
      type: string
    - contextPath: SalesForce.Case.Subject
      description: Case Subject
      type: string
    - contextPath: SalesForce.Case.Description
      description: Case Description
      type: string
    - contextPath: SalesForce.Case.CreateDate
      description: Creation Time of Case
      type: date
    - contextPath: SalesForce.Case.ClosedDate
      description: Closure Time of Case
      type: date
    - contextPath: SalesForce.Case.Owner
      description: Case Owner
      type: string
    - contextPath: SalesForce.Case.Priority
      description: Priority of the Case. one of Low, Medium, High.
      type: string
    - contextPath: SalesForce.Case.Origin
      description: Origin of the Case. one of Web, Phone, Email
      type: string
    - contextPath: SalesForce.Case.Status
      description: 'Case Status. one of the following: New, Escalated, On Hold or
        Closed'
      type: string
    - contextPath: SalesForce.Case.Reason
      description: Reason for case creation
      type: string
    description: Create a new case
  - name: salesforce-update-case
    arguments:
    - name: oid
      description: Case Object ID
    - name: caseNumber
      description: Case Number
    - name: subject
      description: Case Subject
    - name: description
      description: Case Description
    - name: status
      auto: PREDEFINED
      predefined:
      - New
      - On Hold
      - Closed
      - Escalated
      description: Case Status
    - name: origin
      auto: PREDEFINED
      predefined:
      - Email
      - Phone
      - Web
      description: Case Origin
    - name: priority
      auto: PREDEFINED
      predefined:
      - Low
      - Medium
      - High
      description: Case Priority
    - name: type
      auto: PREDEFINED
      predefined:
      - Question
      - Problem
      - Feature Request
      description: Case Type
    outputs:
    - contextPath: SalesForce.Case.ID
      description: Case Object ID
      type: string
    - contextPath: SalesForce.Case.CaseNumber
      description: Case Number
      type: string
    - contextPath: SalesForce.Case.Subject
      description: Case Subject
      type: string
    - contextPath: SalesForce.Case.Description
      description: Case Description
      type: string
    - contextPath: SalesForce.Case.CreateDate
      description: Creation Time of Case
      type: date
    - contextPath: SalesForce.Case.ClosedDate
      description: Closure Time of Case
      type: date
    - contextPath: SalesForce.Case.Owner
      description: Case Owner
      type: string
    - contextPath: SalesForce.Case.Priority
      description: Priority of the Case. one of Low, Medium, High.
      type: string
    - contextPath: SalesForce.Case.Origin
      description: Origin of the Case. one of Web, Phone, Email
      type: string
    - contextPath: SalesForce.Case.Status
      description: 'Case Status. one of the following: New, Escalated, On Hold or
        Closed'
      type: string
    - contextPath: SalesForce.Case.Reason
      description: Reason for case creation
      type: string
    description: Update case fields
  - name: salesforce-get-cases
    arguments: []
    description: Get all cases
  - name: salesforce-close-case
    arguments:
    - name: oid
      description: Case Object ID
    - name: caseNumber
      description: Case Number
    outputs:
    - contextPath: SalesForce.Case.ID
      description: Case Object ID
      type: string
    - contextPath: SalesForce.Case.CaseNumber
      description: Case Number
      type: string
    - contextPath: SalesForce.Case.Subject
      description: Case Subject
      type: string
    - contextPath: SalesForce.Case.Description
      description: Case Description
      type: string
    - contextPath: SalesForce.Case.CreateDate
      description: Creation Time of Case
      type: date
    - contextPath: SalesForce.Case.ClosedDate
      description: Closure Time of Case
      type: date
    - contextPath: SalesForce.Case.Owner
      description: Case Owner
      type: string
    - contextPath: SalesForce.Case.Priority
      description: Priority of the Case. one of Low, Medium, High.
      type: string
    - contextPath: SalesForce.Case.Origin
      description: Origin of the Case. one of Web, Phone, Email.
      type: string
    - contextPath: SalesForce.Case.Status
      description: 'Case Status. one of the following: New, Escalated, On Hold or
        Closed.'
      type: string
    - contextPath: SalesForce.Case.Reason
      description: Reason for case creation
      type: string
    important:
    - contextPath: SalesForce.Case.Status
      description: Case Status. Will be 'Closed'.
      related: ""
    description: Close a case
  - name: salesforce-push-comment-threads
    arguments:
    - name: id
      required: true
      description: The Chatter comment Thread ID
    - name: text
      required: true
      description: The comment text
    outputs:
    - contextPath: SalesForce.Comment.Reply.Body
      description: Reply body
      type: string
    - contextPath: SalesForce.Comment.Reply.CreatedDate
      description: Reply created date
      type: date
    - contextPath: SalesForce.Comment.Reply.URL
      description: Reply URL link
      type: string
    description: Add the comment to the chatter thread. Use this command only after
      salesforce-push-comment
  - name: salesforce-delete-case
    arguments:
    - name: oid
      description: Case Object ID
    - name: caseNumber
      description: Case Number
    description: Delete a case
  isfetch: true
  runonce: false
