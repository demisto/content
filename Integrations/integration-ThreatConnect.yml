commonfields:
  id: ThreatConnect
  version: -1
name: ThreatConnect
display: ThreatConnect
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: Threat Intelligence platform
configuration:
- display: Access ID
  name: accessId
  defaultvalue: ""
  type: 0
  required: true
- display: Secret Key
  name: secretKey
  defaultvalue: ""
  type: 4
  required: true
- display: baseUrl
  name: baseUrl
  defaultvalue: https://api.threatconnect.com
  type: 0
  required: true
- display: Default Organization
  name: defaultOrg
  defaultvalue: ""
  type: 0
  required: false
- display: ProxyIP  (or http://${ip} )
  name: proxyIp
  defaultvalue: ""
  type: 0
  required: false
- display: ProxyPort
  name: proxyPort
  defaultvalue: ""
  type: 0
  required: false
- display: Rating threshold for Malicious Indicators
  name: rating
  defaultvalue: "3"
  type: 0
  required: false
- display: Confidence threshold for Malicious Indicators
  name: confidence
  defaultvalue: "50"
  type: 0
  required: false
- display: Indicator Reputation Freshness (in days)
  name: freshness
  defaultvalue: "7"
  type: 0
  required: false
script:
  script: |
    ''' IMPORTS '''
    import urllib
    import datetime
    from urlparse import urlparse

    from threatconnect import ThreatConnect
    from threatconnect.RequestObject import RequestObject
    from threatconnect.Config.IndicatorType import IndicatorType
    from threatconnect.Config.ResourceType import ResourceType
    from threatconnect.Config.FilterOperator import FilterOperator

    '''GLOBAL VARS'''
    FRESHNESS = int(demisto.params()['freshness'])
    MAX_CONTEXT = 100

    ''' HELPER FUNCTIONS '''
    def get_client():
        params = demisto.params()
        access = params['accessId']
        secret = params['secretKey']
        default_org = params['defaultOrg']
        url = params['baseUrl']
        proxy_ip = params['proxyIp']
        proxy_port = params['proxyPort']

        tc = ThreatConnect(access, secret, default_org, url)
        if proxy_ip and proxy_port and len(proxy_ip) > 0 and len(proxy_port) > 0:
            tc.set_proxies(proxy_ip, int(proxy_port))

        return tc


    def calculate_freshness_time(freshness):
        t = datetime.datetime.now() - datetime.timedelta(days=7)
        return t.strftime('%Y-%m-%dT00:00:00Z')


    def create_context(indicators, include_dbot_score=False):
        context = {
            'DBotScore' : [],
            outputPaths['ip'] : [],
            outputPaths['url'] : [],
            outputPaths['domain'] : [],
            outputPaths['file'] : [],
            'TC.Indicator(val.ID && val.ID === obj.ID)' : [],
        }
        tc_type_to_demisto_type = {
            'Address' : 'ip',
            'URL' : 'url',
            'Host' : 'domain',
            'File' : 'file'
        }
        type_to_value_field = {
            'Address' : 'ip',
            'URL' : 'text',
            'Host' : 'hostName',
            'File' : 'md5',
        }

        for ind in indicators:
            dbotScore = 0
            indicator_type = tc_type_to_demisto_type.get(ind['type'], ind['type'])
            value_field = type_to_value_field.get(ind['type'], 'summary')
            value = ind.get(value_field, ind.get('summary', ''))

            confidence = 0
            if ind.get('confidence') is not None: # returned in specific indicator request - SDK
                confidence = int(ind['confidence'])
            else:
                # returned in general indicator request - REST API
                confidence = int(ind.get('threatAssessConfidence', 0))

            rating = 0
            if ind.get('rating') is not None: # returned in specific indicator request - SDK
                rating = int(ind['rating'])
            else:
                # returned in general indicator request - REST API
                rating = int(ind.get('threatAssessRating', 0))

            if confidence >= demisto.params()['rating'] and rating >= demisto.params()['confidence']:
                dbotScore = 3
                desc = ''
                if hasattr(ind, 'description'):
                    desc = ind.description
                mal = {
                    'Malicious':{
                        'Vendor' : 'ThreatConnect',
                        'Description' : desc,
                    }
                }
                if indicator_type == 'ip':
                    mal['Address'] = value

                elif indicator_type == 'file':
                    mal['MD5'] = value
                    mal['SHA1'] = ind.get('sha1')
                    mal['SHA256'] = ind.get('sha256')

                elif indicator_type == 'url':
                    mal['Data'] = value

                elif indicator_type == 'domain':
                    mal['Name'] = value

                contextPath = outputPaths.get(indicator_type)
                if contextPath is not None:
                    context[contextPath].append(mal)

            elif rating >= 1:
                dbotScore = 2
            else:
                dbotScore = 1

            if include_dbot_score:
                context['DBotScore'].append({
                    'Indicator': value,
                    'Score': dbotScore,
                    'Type': indicator_type,
                    'Vendor': 'ThreatConnect',
                })

            context['TC.Indicator(val.ID && val.ID === obj.ID)'].append({
                'ID' : ind['id'],
                'Name' : value,
                'Type' : ind['type'],
                'Owner' : ind['ownerName'],
                'Description' : ind.get('description'),
                'CreateDate' : ind['dateAdded'],
                'LastModified' : ind['lastModified'],
                'Rating' : rating,
                'Confidence' : confidence,

                # relevant for domain
                'Active' : ind.get('whoisActive'),

                # relevant for file
                'File.MD5' : ind.get('md5'),
                'File.SHA1' : ind.get('sha1'),
                'File.SHA256' : ind.get('sha256'),
            })

        context = {k : createContext(v, removeNull=True)[:MAX_CONTEXT] for k, v in context.items() if len(v) > 0}
        return context, context.get('TC.Indicator(val.ID && val.ID === obj.ID)', [])


    @logger
    def get_indicators(indicator_value=None, indicator_type=None, owners=None, rating_threshold=-1, confidence_threshold=-1, freshness=None):
        tc = get_client()
        indicators_obj = tc.indicators()
        _filter = indicators_obj.add_filter()

        if indicator_value is not None:
            _filter.add_indicator(indicator_value)
        if indicator_type is not None:
            _filter.add_pf_type(indicator_type, FilterOperator.EQ)

        if owners is not None:
            owners = owners.split(",")
            _filter.add_owner(owners)

        if rating_threshold != -1:
            _filter.add_pf_rating(rating_threshold, FilterOperator.GE)
        if confidence_threshold != -1:
            _filter.add_pf_confidence(confidence_threshold, FilterOperator.GE)
        if freshness is not None:
            _filter.add_pf_last_modified(calculate_freshness_time(freshness), FilterOperator.GE)

        raw_indicators = indicators_obj.retrieve()
        indicators = [json.loads(indicator.json) for indicator in raw_indicators]

        return indicators


    ''' FUNCTIONS '''
    def ip_command():
        args = demisto.args()
        owners = args.get('owners')
        rating_threshold = int(args.get('ratingThreshold', -1))
        confidence_threshold = int(args.get('confidenceThreshold', -1))
        ip_addr = args['ip']

        ec, indicators = ip(ip_addr, owners, rating_threshold, confidence_threshold)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': indicators,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ThreatConnect IP Reputation for: {}'.format(ip_addr), indicators, headerTransform=pascalToSpace),
            'EntryContext': ec,
        })


    @logger
    def ip(ip_addr, owners, rating_threshold, confidence_threshold):
        indicators = get_indicators(ip_addr, 'Address', owners, rating_threshold, confidence_threshold, freshness=FRESHNESS)
        ec, indicators = create_context(indicators, include_dbot_score=True)

        return ec, indicators


    def url_command():
        args = demisto.args()
        owners = args.get('owners')
        url_addr = args['url']
        parsed_url = urlparse(url_addr)
        if not parsed_url.scheme:
            return_error('Please provide a valid URL including a protocol (http/https)')
        rating_threshold = int(args.get('ratingThreshold', -1))
        confidence_threshold = int(args.get('confidenceThreshold', -1))

        ec, indicators = url(url_addr, owners, rating_threshold, confidence_threshold)
        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': indicators,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ThreatConnect URL Reputation for: {}'.format(url_addr), indicators, headerTransform=pascalToSpace),
            'EntryContext': ec,
        })


    @logger
    def url(url_addr, owners, rating_threshold, confidence_threshold):
        indicators = get_indicators(url_addr, 'URL', owners, rating_threshold, confidence_threshold, freshness=FRESHNESS)
        ec, indicators = create_context(indicators, include_dbot_score=True)

        return ec, indicators


    def file_command():
        args = demisto.args()
        owners = args.get('owners')
        file_name = args['file']
        rating_threshold = int(args.get('ratingThreshold', -1))
        confidence_threshold = int(args.get('confidenceThreshold', -1))

        ec, indicators = _file(file_name, owners, rating_threshold, confidence_threshold)
        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': indicators,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ThreatConnect File Report for: {}'.format(file_name), indicators, headerTransform=pascalToSpace),
            'EntryContext': ec,
        })


    @logger
    def _file(url_addr, owners, rating_threshold, confidence_threshold):
        indicators = get_indicators(url_addr, 'File', owners, rating_threshold, confidence_threshold, freshness=FRESHNESS)
        ec, indicators = create_context(indicators, include_dbot_score=True)

        return ec, indicators


    def domain_command():
        args = demisto.args()
        owners = args.get('owners')
        rating_threshold = int(args.get('ratingThreshold', -1))
        confidence_threshold = int(args.get('confidenceThreshold', -1))
        domain_addr = args['domain']

        ec, indicators = domain(domain_addr, owners, rating_threshold, confidence_threshold)
        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': indicators,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ThreatConnect Domain Reputation for: {}'.format(domain_addr), indicators, headerTransform=pascalToSpace),
            'EntryContext': ec,
        })


    @logger
    def domain(domain_addr, owners, rating_threshold, confidence_threshold):
        indicators = get_indicators(domain_addr, 'Host', owners, rating_threshold, confidence_threshold, freshness=FRESHNESS)
        ec, indicators = create_context(indicators, include_dbot_score=True)

        return ec, indicators


    def tc_owners_command():
        raw_owners = tc_owners()
        owners = []
        for owner in raw_owners['data']['owner']:
            owners.append({
                'ID' : owner['id'],
                'Type' : owner['type'],
                'Name' : owner['name'],
            })

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': raw_owners,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ThreatConnect Owners:', owners),
            'EntryContext': {'TC.Owner(val.ID && val.ID === obj.ID)' : owners},
        })


    @logger
    def tc_owners():
        tc = get_client()
        ro = RequestObject()
        ro.set_http_method('GET')
        ro.set_request_uri('/v2/owners')
        results = tc.api_request(ro)

        return results.json()


    def tc_indicators_command():
        args = demisto.args()
        limit = int(args.get('limit', 500))
        owners = args.get('owners')
        ec, indicators, raw_response = tc_indicators(owners, limit)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': raw_response,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ThreatConnect Indicators:', indicators, headerTransform=pascalToSpace),
            'EntryContext': ec,
        })


    @logger
    def tc_indicators(owners, limit):
        tc = get_client()
        tc.set_api_result_limit(limit)
        ro = RequestObject()
        ro.set_http_method('GET')
        ro.set_request_uri('/v2/indicators?resultLimit={}'.format(limit))

        if owners is not None:
            ro.set_owner(owners)
            ro.set_owner_allowed(True)

        response = tc.api_request(ro).json()
        indicators = response['data']['indicator']
        ec, indicators = create_context(indicators, include_dbot_score=True)

        return ec, indicators, response


    def tc_get_tags_command():
        raw_response = tc_get_tags()
        tags = [t['name'] for t in raw_response['data']['tag']]

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': raw_response,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ThreatConnect Tags:', tags, headers='Name'),
            'EntryContext': {'TC.Tags' : tags},
        })


    @logger
    def tc_get_tags():
        tc = get_client()
        ro = RequestObject()
        ro.set_http_method('GET')
        ro.set_request_uri('/v2/tags')

        return tc.api_request(ro).json()


    def tc_tag_indicator_command():
        args = demisto.args()
        indicator = args['indicator']
        tag = args['tag']
        owners = args.get('owner')
        indicators = tc_tag_indicator(indicator, tag, owners)

        md = []
        for ind in indicators:
            md.append('Indicator {} with ID {}, was tagged with: {}'.format(indicator, ind.id, tag))

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['text'],
            'Contents': '\n'.join(md),
        })


    def tc_tag_indicator(indicator, tag, owners=None):
        tc = get_client()
        indicators = tc.indicators()
        filter1 = indicators.add_filter()
        filter1.add_indicator(indicator)

        if owners is not None:
            owners = owners.split(",")
            filter1.add_owner(owners)

        indicators = indicators.retrieve()
        for indicator in indicators:
            indicator.add_tag(tag)
            indicator.commit()

        return indicators


    def tc_get_indicator_command():
        args = demisto.args()
        owners = args.get('owners')
        rating_threshold = int(args.get('ratingThreshold', -1))
        confidence_threshold = int(args.get('confidenceThreshold', -1))
        indicator = args['indicator']

        ec, indicators, raw_indicators = tc_get_indicator(indicator, owners, rating_threshold, confidence_threshold)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': raw_indicators,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ThreatConnect indicator for: {}'.format(indicator), indicators, headerTransform=pascalToSpace),
            'EntryContext': ec,
        })


    @logger
    def tc_get_indicator(indicator, owners, rating_threshold, confidence_threshold):
        raw_indicators = get_indicators(indicator, owners=owners, rating_threshold=rating_threshold, confidence_threshold=confidence_threshold)
        ec, indicators = create_context(raw_indicators, include_dbot_score=True)

        return ec, indicators, raw_indicators


    def tc_get_indicators_by_tag_command():
        args = demisto.args()
        tag = args['tag']
        owner = args.get('owner')
        response = tc_get_indicators_by_tag(tag, owner)
        raw_indicators = response['data']['indicator']
        ec, indicators = create_context(raw_indicators, include_dbot_score=True)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': response,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('ThreatConnect Indicators with tag: {}'.format(tag), indicators, headerTransform=pascalToSpace),
            'EntryContext': ec,
        })


    @logger
    def tc_get_indicators_by_tag(tag, owner):
        tc = get_client()
        ro = RequestObject()
        ro.set_http_method('GET')
        cmd = '/v2/tags/{}/indicators'.format(tag)
        if owner is not None:
            cmd += '?owner={}'.format(owner)

        ro.set_request_uri(cmd)

        return tc.api_request(ro).json()


    def tc_add_indicator_command():
        args = demisto.args()
        indicator = args['indicator']
        owner = args.get('owner', demisto.params()['defaultOrg'])
        if owner == '':
            return_error('you must specify an owner via the command or the Organization parameter')

        rating = int(args.get('rating', 0))
        confidence = int(args.get('confidence', 0))

        _indicator = tc_add_indicator(indicator, owner, rating, confidence)
        # get the indicator for full object data
        raw_indicators = get_indicators(indicator)
        ec, indicators = create_context(raw_indicators)
        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': raw_indicators,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Created new indicator successfully:', indicators, headerTransform=pascalToSpace),
            'EntryContext': ec,
        })


    @logger
    def tc_add_indicator(indicator, organization, rating=0, confidence=0):
        tc = get_client()
        indicators = tc.indicators()
        indicator = indicators.add(indicator, organization)
        indicator.set_rating(rating)
        indicator.set_confidence(confidence)

        return json.loads(indicator.commit().json)


    def tc_create_incident_command():
        args = demisto.args()
        incident_name = args['incidentName']
        owner = args.get('owner', demisto.params()['defaultOrg'])
        if owner == '':
            return_error('you must specify an owner via the command or the Organization parameter')

        event_date = args.get('eventDate', datetime.datetime.utcnow().isoformat().split('.')[0] + 'Z')
        tag = args.get('tag')
        security_label = args.get('securityLabel')
        description = args.get('description')

        raw_incident = tc_create_incident(incident_name, owner, event_date, tag, security_label, description)
        ec = {
                'ID' : raw_incident['id'],
                'Name' : raw_incident['name'],
                'Owner' : raw_incident['ownerName'],
                'EventDate' : raw_incident['eventDate'],
                'Tag' : tag,
                'SecurityLabel' : security_label,
        }

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': raw_incident,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': 'Incident {} Created Successfully'.format(incident_name),
            'EntryContext': {
                'TC.Incident(val.ID && val.ID === obj.ID)' : createContext([ec], removeNull=True),
            },
        })


    @logger
    def tc_create_incident(incident_name, owner, event_date, tag=None, security_label=None, description=None):
        tc = get_client()
        incidents = tc.incidents()
        incident = incidents.add(incident_name, owner)
        incident.set_event_date(event_date)
        if tag is not None:
            incident.add_tag(tag)
        if security_label is not None:
            incident.set_security_label(security_label)
        if description is not None:
            incident.add_attribute('Description', description)

        return json.loads(incident.commit().json)


    def tc_fetch_incidents_command():
        args = demisto.args()
        incident_id = args.get('incidentId')
        incident_name = args.get('incidentName')
        owner = args.get('owner')

        raw_incidents = tc_fetch_incidents(incident_id, incident_name, owner)
        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': raw_incidents,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Incidents:', raw_incidents, headerTransform=pascalToSpace),
            'EntryContext': {
                'TC.Incident(val.ID && val.ID === obj.ID)' : createContext(raw_incidents, removeNull=True),
                'ThreatConnect.incidents' : raw_incidents, # backward compatible
            },
        })


    @logger
    def tc_fetch_incidents(incident_id, incident_name, owner):
        tc = get_client()
        incidents = tc.incidents()
        if any((incident_id, owner, incident_name)):
            filter1 = incidents.add_filter()
            if incident_id is not None:
                filter1.add_id(int(incident_id))
            if owner is not None:
                filter1.add_owner(owner)
            if incident_name is not None:
                filter1.add_pf_name(incident_name)

        incidents.retrieve()
        return [json.loads(incident.json) for incident in incidents]


    def tc_get_incident_associate_indicators_command():
        args = demisto.args()
        incident_id = int(args['incidentId'])
        owners = args.get('owner')
        if owners is not None:
            owners = owners.split(",")

        raw_indicators = tc_get_incident_associate_indicators(incident_id, owners)
        ec, indicators = create_context(raw_indicators, include_dbot_score=True)
        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': raw_indicators,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Incident Associated Indicators:', indicators, headerTransform=pascalToSpace),
            'EntryContext': ec,
        })


    @logger
    def tc_get_incident_associate_indicators(incident_id, owners):
        tc = get_client()
        incidents = tc.incidents()
        _filter = incidents.add_filter()
        _filter.add_id(incident_id)

        incidents = incidents.retrieve()
        indicators = []
        for incident in incidents:
            for ind in incident.indicator_associations:
                if ind.type == 'File':
                    indicators.append(ind.indicator['md5'])
                else:
                    indicators.append(ind.indicator)
        if len(indicators) == 0:
            return []

        indicators_obj = tc.indicators()
        _filter = indicators_obj.add_filter()
        if owners is not None:
            _filter.add_owner(owners)
        for ind in indicators:
            _filter.add_indicator(ind)

        raw_indicators = indicators_obj.retrieve()
        return [json.loads(indicator.json) for indicator in raw_indicators]


    def tc_incident_associate_indicator_command():
        args = demisto.args()
        incident_id = int(args['incidentId'])
        indicator = args['indicator']
        types = {
            'ADDRESSES' : ResourceType.ADDRESSES,
            'EMAIL_ADDRESSES' : ResourceType.EMAIL_ADDRESSES,
            'FILES' : ResourceType.FILES,
            'HOSTS' : ResourceType.HOSTS,
            'URLS' : ResourceType.URLS,
        }
        indicator_type = types.get(args['indicatorType'], args['indicatorType'])
        owners = args.get('owner')
        if owners is not None:
            owners = owners.split(",")

        incidents = tc_incident_associate_indicator(incident_id, indicator_type, indicator, owners)
        md = []
        for inc in incidents:
            md.append('Incident {} with ID {}, was tagged with: {}'.format(inc['name'], inc['id'], indicator))

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['text'],
            'Contents': incidents,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable' : '\n'.join(md),
            'EntryContext': {
            'TC.Incident(val.ID && val.ID === obj.ID)' : createContext(incidents, removeNull=True),
            }
        })


    @logger
    def tc_incident_associate_indicator(incident_id, indicator_type, indicator, owners):
        tc = get_client()
        incidents = tc.incidents()
        filter1 = incidents.add_filter()
        filter1.add_id(incident_id)
        if owners is not None:
            filter1.add_owner(owners)
        raw_incidents = incidents.retrieve()

        incidents = []
        for incident in raw_incidents:
            incident.associate_indicator(indicator_type, indicator)
            incidents.append(json.loads(incident.commit().json))

        return incidents


    def tc_update_indicator_command():
        args = demisto.args()
        indicator = args['indicator']
        rating = args.get('rating')
        confidence = args.get('confidence')
        size = args.get('size')
        dns_active = args.get('dnsActive')
        whois_active = args.get('whoisActive')
        false_positive = args.get('falsePositive', 'False') == 'True'
        observations = int(args.get('observations', 0))
        security_label = args.get('securityLabel')
        threat_assess_confidence = int(args.get('threatAssessConfidence', -1))
        threat_assess_rating = int(args.get('threatAssessRating', -1))

        raw_indicators = tc_update_indicator(indicator, rating=rating, confidence=confidence, size=size, dns_active=dns_active,
            whois_active=whois_active, false_positive=false_positive, observations=observations, security_label=security_label,
            threat_assess_confidence=threat_assess_confidence, threat_assess_rating=threat_assess_rating)
        ec, indicators = create_context(raw_indicators)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': raw_indicators,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': '\n'.join('Indicator {} Updated Successfully'.format(ind['ID']) for ind in indicators),
            'EntryContext': ec,
        })


    @logger
    def tc_update_indicator(indicator, rating=None, confidence=None, size=None, dns_active=None, whois_active=None,
            false_positive=False, observations=0, security_label=None, threat_assess_confidence=-1, threat_assess_rating=-1):
        tc = get_client()
        indicators = tc.indicators()
        filter1 = indicators.add_filter()
        filter1.add_indicator(indicator)

        raw_indicators = []
        for ind in indicators.retrieve():
            if rating is not None:
                ind.set_rating(rating)
            if confidence is not None:
                ind.set_confidence(int(confidence))
            if false_positive:
                ind.add_false_positive()
            if observations != 0:
                ind.add_observation(observations)
            if security_label is not None:
                ind.add_security_label(security_label)
            if threat_assess_confidence != -1:
                ind.set_threat_assess_confidence(threat_assess_confidence)
            if threat_assess_rating != -1:
                ind.set_threat_assess_rating(threat_assess_rating)

            if ind.type == 'File' and size is not None:
                ind.add_size(size)
            if ind.type == 'Host' and dns_active is not None:
                ind.set_dns_active(dns_active)
            if ind.type == 'Host' and whois_active is not None:
                ind.set_whois_active(whois_active)

            raw_indicators.append(json.loads(ind.commit().json))

        return raw_indicators


    def tc_delete_indicator_command():
        args = demisto.args()
        indicator = args['indicator']

        tc_delete_indicator(indicator)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['text'],
            'Contents': 'Indicator {} removed Successfully'.format(indicator),
        })


    @logger
    def tc_delete_indicator(indicator):
        tc = get_client()
        indicators = tc.indicators()
        filter1 = indicators.add_filter()
        filter1.add_indicator(indicator)
        indicators = indicators.retrieve()
        for ind in indicators:
            ind.delete()


    def tc_delete_indicator_tag_command():
        args = demisto.args()
        indicator = args['indicator']
        tag = args['tag']

        indicators = tc_delete_indicator_tag(indicator, tag)
        raw_indicators = [json.loads(ind.json) for ind in indicators]
        ec, _ = create_context(raw_indicators)

        md = []
        for ind in indicators:
            md.append('Removed tag {} from indicator {}.'.format(tag, ind.indicator))
        if len(md) == 0:
            md.append('No indicators found')

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['text'],
            'Contents': raw_indicators,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable' : '\n'.join(md),
            'EntryContext': ec,
        })


    @logger
    def tc_delete_indicator_tag(indicator, tag, owners=None):
        tc = get_client()
        indicators = tc.indicators()
        filter1 = indicators.add_filter()
        filter1.add_indicator(indicator)

        if owners is not None:
            owners = owners.split(",")
            filter1.add_owner(owners)

        indicators = indicators.retrieve()
        for indicator in indicators:
            indicator.delete_tag(tag)
            indicator.commit()

        return indicators


    def tc_create_campaign_command():
        args = demisto.args()
        name = args['name']
        owner = args.get('owner', demisto.params()['defaultOrg'])
        if owner == '':
            return_error('you must specify an owner via the command or the Organization parameter')

        first_seen = args.get('firstSeen', datetime.datetime.utcnow().isoformat().split('.')[0] + 'Z')
        tag = args.get('tag')
        security_label = args.get('securityLabel')
        description = args.get('description')

        raw_campaign = tc_create_campaign(name, owner, first_seen, tag, security_label, description)
        ec = {
            'ID' : raw_campaign['id'],
            'Name' : raw_campaign['name'],
            'Owner' : raw_campaign['owner']['name'],
            'FisrtSeen' : raw_campaign['firstSeen'],
            'Tag' : tag,
            'SecurityLabel' : security_label,
        }

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': raw_campaign,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': 'Campaign {} Created Successfully'.format(name),
            'EntryContext': {
                'TC.Campaign(val.ID && val.ID === obj.ID)' : createContext([ec], removeNull=True),
            },
        })


    @logger
    def tc_create_campaign(name, owner, first_seen, tag=None, security_label=None, description=None):
        tc = get_client()
        ro = RequestObject()
        ro.set_http_method('POST')
        ro.set_request_uri('/v2/groups/campaigns')
        body = {
            'name': name,
            'firstSeen': first_seen,
        }
        ro.set_body(json.dumps(body))
        response = tc.api_request(ro).json()

        if response.get('status') == 'Success':
            output = response.get('data', {}).get('campaign', {})
            event_id = output['id']
            if description is not None:
                #Associate Attribute description
                ro = RequestObject()
                ro.set_http_method('POST')
                ro.set_request_uri('/v2/groups/events/{}/attributes'.format(event_id))
                body = {
                    'type' : 'Description',
                    'value' : description,
                    'displayed': 'true'
                }
                ro.set_body(json.dumps(body))
                response = tc.api_request(ro).json()

            return output
        else:
            return_error('Failed to create event')


    def tc_create_event_command():
        args = demisto.args()
        name = args['name']
        event_date = args.get('EventDate', datetime.datetime.utcnow().isoformat().split('.')[0] + 'Z')
        status = args.get('status')
        owner = args.get('owner', demisto.params()['defaultOrg'])
        if owner == '':
            return_error('you must specify an owner via the command or the Organization parameter')

        description = args.get('description')
        tag = args.get('tag')

        raw_event = tc_create_event(name, owner, event_date, tag, status, description)
        ec = {
            'ID' : raw_event['id'],
            'Name' : raw_event['name'],
            'Owner' : raw_event['owner']['name'],
            'Date' : raw_event['eventDate'],
            'Tag' : tag,
            'Status' : status,
        }

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': raw_event,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': 'Incident {} Created Successfully'.format(name),
            'EntryContext': {
                'TC.Event(val.ID && val.ID === obj.ID)' : createContext([ec], removeNull=True),
            },
        })


    def tc_create_event(name, owner, event_date, tag=None, status=None, description=None):
        tc = get_client()
        ro = RequestObject()
        ro.set_http_method('POST')
        ro.set_request_uri('/v2/groups/events')
        body = {
            'name': name,
            'eventDate': event_date,
            'status': status
        }
        ro.set_body(json.dumps(body))
        response = tc.api_request(ro).json()

        if response.get('status') == 'Success':
            output = response.get('data', {}).get('event', {})
            event_id = output['id']
            if description is not None:
                #Associate Attribute description
                ro = RequestObject()
                ro.set_http_method('POST')
                ro.set_request_uri('/v2/groups/events/{}/attributes'.format(event_id))
                body = {
                    'type' : 'Description',
                    'value' : description,
                    'displayed': 'true'
                }
                ro.set_body(json.dumps(body))
                response = tc.api_request(ro).json()

            return output
        else:
            return_error('Failed to create event')


    def tc_create_threat_command():
        args = demisto.args()
        name = args['name']
        date = args.get('dateAdded', datetime.datetime.utcnow().isoformat().split('.')[0] + 'Z')
        owner = args.get('owner', demisto.params()['defaultOrg'])
        if owner == '':
            return_error('you must specify an owner via the command or the Organization parameter')

        raw_threat = tc_create_threat(name, owner, date)
        ec = {
            'ID' : raw_threat['id'],
            'Name' : raw_threat['name'],
        }

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': raw_threat,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': 'Threat {} Created Successfully'.format(name),
            'EntryContext': {
                'TC.Threat(val.ID && val.ID === obj.ID)' : createContext([ec], removeNull=True),
            },
        })


    def tc_create_threat(name, owner, date):
        tc = get_client()
        threats = tc.threats()
        threat = threats.add(name, owner)
        threat.set_date_added(date)

        return json.loads(threat.commit().json)


    def tc_delete_group_command():
        args = demisto.args()
        group_id = int(args['groupID'])
        group_type = args['type']

        success = tc_delete_group(group_id, group_type.lower())
        if success:
            demisto.results({
                'Type': entryTypes['note'],
                'ContentsFormat': formats['text'],
                'Contents': '{} {} deleted Successfully'.format(group_type.lower(), group_id),
            })
        else:
            return_error('Failed to delete {} {}'.format(group_type, group_id))


    def tc_delete_group(group_id, group_type):
        tc = get_client()
        ro = RequestObject()
        ro.set_http_method('DELETE')
        ro.set_request_uri('/v2/groups/{}/{}'.format(group_type, group_id))
        response = tc.api_request(ro).json()

        return response['status'] == 'Success'


    def test_integration():
        tc = get_client()
        owners = tc.owners()
        owners.retrieve()
        demisto.results('ok')


    ''' EXECUTION CODE '''
    COMMANDS = {
        'test-module' : test_integration,
        'ip' : ip_command,
        'url' : url_command,
        'file' : file_command,
        'domain' : domain_command,

        'tc-owners' : tc_owners_command,
        'tc-indicators' : tc_indicators_command,
        'tc-get-tags' : tc_get_tags_command,
        'tc-tag-indicator' : tc_tag_indicator_command,
        'tc-get-indicator' : tc_get_indicator_command,
        'tc-get-indicators-by-tag' : tc_get_indicators_by_tag_command,
        'tc-add-indicator' : tc_add_indicator_command,

        'tc-create-incident' : tc_create_incident_command,
        'tc-fetch-incidents' : tc_fetch_incidents_command,
        'tc-get-incident-associate-indicators' : tc_get_incident_associate_indicators_command,
        'tc-incident-associate-indicator' : tc_incident_associate_indicator_command,
        'tc-update-indicator' : tc_update_indicator_command,
        'tc-delete-indicator' : tc_delete_indicator_command,
        'tc-delete-indicator-tag' : tc_delete_indicator_tag_command,
        'tc-create-campaign' : tc_create_campaign_command,
        'tc-create-event' : tc_create_event_command,
        'tc-create-threat' : tc_create_threat_command,
        'tc-delete-group' : tc_delete_group_command,
    }

    try:
        LOG('command is %s' % (demisto.command(), ))
        command_func = COMMANDS.get(demisto.command())
        if command_func is not None:
            command_func()

    except Exception, e:
        LOG(e.message)
        LOG.print_log()
        return_error('error has occurred: {}'.format(e.message, ))

  type: python
  commands:
  - name: ip
    arguments:
    - name: ip
      required: true
      default: true
      description: IPv4/IPv6 address
    - name: owners
      description: 'client’s Organization or any Sources or Communities to which a
        client’s API User has been granted permission, comma separated: owner1,owner2,owner3'
    - name: ratingThreshold
      description: filter on indicators rating greater then given value(value between
        0 to 5)
    - name: confidenceThreshold
      description: filter on indicators confidence greater then given value(value
        between 0 to 100)
    outputs:
    - contextPath: TC.Indicator.Name
      description: Indicator's name
      type: string
    - contextPath: TC.Indicator.Type
      description: Indicator type
      type: string
    - contextPath: TC.Indicator.ID
      description: Indicator ID
      type: string
    - contextPath: TC.Indicator.Description
      description: Indicator's description
      type: string
    - contextPath: TC.Indicator.Owner
      description: Indicator's owner
      type: string
    - contextPath: TC.Indicator.CreateDate
      description: Indicator's creation time
      type: date
    - contextPath: TC.Indicator.LastModified
      description: Indicator's last modification date
      type: date
    - contextPath: TC.Indicator.Rating
      description: Indicator's rating
      type: number
    - contextPath: TC.Indicator.Confidence
      description: Indicator's confidence
      type: number
    - contextPath: DBotScore.Indicator
      description: Indicator's value
      type: string
    - contextPath: DBotScore.Type
      description: Indicator's Type
      type: string
    - contextPath: DBotScore.Score
      description: Indicator's actual score
      type: number
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: IP.Address
      description: IP Indicator's address
      type: string
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
      type: string
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the full Description
      type: string
    description: Search for IP indicator
  - name: url
    arguments:
    - name: url
      required: true
      default: true
      description: url like www.demisto.com
    - name: owners
      description: client’s Organization or any Sources or Communities to which a
        client’s API User has been granted permission.
    - name: ratingThreshold
      description: filter on indicators rating grater then given value(value between
        0 to 5)
    - name: confidenceThreshold
      description: filter on indicators confidence grater then given value(value between
        0 to 100)
    outputs:
    - contextPath: TC.Indicator.Name
      description: Indicator's name
      type: string
    - contextPath: TC.Indicator.Type
      description: Indicator type
      type: string
    - contextPath: TC.Indicator.ID
      description: Indicator ID
      type: string
    - contextPath: TC.Indicator.Description
      description: Indicator's description
      type: string
    - contextPath: TC.Indicator.Owner
      description: Indicator's owner
      type: string
    - contextPath: TC.Indicator.CreateDate
      description: Indicator's creation time
      type: date
    - contextPath: TC.Indicator.LastModified
      description: Indicator's last modification date
      type: date
    - contextPath: TC.Indicator.Rating
      description: Indicator's rating
      type: number
    - contextPath: TC.Indicator.Confidence
      description: Indicator's confidence
      type: number
    - contextPath: DBotScore.Indicator
      description: Indicator's value
      type: string
    - contextPath: DBotScore.Type
      description: Indicator's Type
      type: string
    - contextPath: DBotScore.Score
      description: Indicator's actual score
      type: number
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: URL.Data
      description: URL Indicator's data
      type: string
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
      type: string
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the full Description
      type: string
    description: Search for URL indicator
  - name: file
    arguments:
    - name: file
      required: true
      default: true
      description: hash of the file (MD5, SHA-1, or SHA-256)
    - name: owners
      description: client’s Organization or any Sources or Communities to which a
        client’s API User has been granted permission.
    - name: ratingThreshold
      description: filter on indicators rating grater then given value(value between
        0 to 5)
    - name: confidenceThreshold
      description: filter on indicators confidence grater then given value(value between
        0 to 100)
    outputs:
    - contextPath: TC.Indicator.Name
      description: Indicator's name
      type: string
    - contextPath: TC.Indicator.Type
      description: Indicator type
      type: string
    - contextPath: TC.Indicator.ID
      description: Indicator ID
      type: string
    - contextPath: TC.Indicator.Description
      description: Indicator's description
      type: string
    - contextPath: TC.Indicator.Owner
      description: Indicator's owner
      type: string
    - contextPath: TC.Indicator.CreateDate
      description: Indicator's creation time
      type: date
    - contextPath: TC.Indicator.LastModified
      description: Indicator's last modification date
      type: date
    - contextPath: TC.Indicator.Rating
      description: Indicator's rating
      type: number
    - contextPath: TC.Indicator.Confidence
      description: Indicator's confidence
      type: number
    - contextPath: TC.Indicator.File.MD5
      description: Indicator's md5. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA1
      description: Indicator's sha1. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA256
      description: Indicator's sha256. Relevant for files only
      type: string
    - contextPath: DBotScore.Indicator
      description: Indicator's value
      type: string
    - contextPath: DBotScore.Type
      description: Indicator's Type
      type: string
    - contextPath: DBotScore.Score
      description: Indicator's actual score
      type: number
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: File.MD5
      description: File Indicator's md5
      type: string
    - contextPath: File.SHA1
      description: File Indicator's sha1
      type: string
    - contextPath: File.SHA256
      description: File Indicator's sha256
      type: string
    - contextPath: File.Malicious.Vendor
      description: For malicious Files, the vendor that made the decision
      type: string
    - contextPath: File.Malicious.Description
      description: For malicious Files, the full Description
      type: string
    description: Search for File indicator
  - name: tc-owners
    arguments: []
    outputs:
    - contextPath: TC.Owner.Name
      description: Owner Name
      type: string
    - contextPath: TC.Owner.ID
      description: Owner ID
      type: string
    - contextPath: TC.Owner.Type
      description: Owner Type
      type: string
    description: Retrieve all owners for this account
  - name: tc-indicators
    arguments:
    - name: owner
      description: Filter by indicator's owner
    - name: limit
      description: int limit of results, default is 500
    outputs:
    - contextPath: TC.Indicator.Name
      description: Indicator's name
      type: string
    - contextPath: TC.Indicator.Type
      description: Indicator type
      type: string
    - contextPath: TC.Indicator.ID
      description: Indicator ID
      type: string
    - contextPath: TC.Indicator.Description
      description: Indicator's description
      type: string
    - contextPath: TC.Indicator.Owner
      description: Indicator's owner
      type: string
    - contextPath: TC.Indicator.CreateDate
      description: Indicator's creation time
      type: date
    - contextPath: TC.Indicator.LastModified
      description: Indicator's last modification date
      type: date
    - contextPath: TC.Indicator.Rating
      description: Indicator's rating
      type: number
    - contextPath: TC.Indicator.Confidence
      description: Indicator's confidence
      type: number
    - contextPath: TC.Indicator.WhoisActive
      description: Indicator's Whois Active. Relevant for domains only
      type: string
    - contextPath: TC.Indicator.File.MD5
      description: Indicator's md5. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA1
      description: Indicator's sha1. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA256
      description: Indicator's sha256. Relevant for files only
      type: string
    - contextPath: DBotScore.Indicator
      description: Indicator's value
      type: string
    - contextPath: DBotScore.Type
      description: Indicator's Type
      type: string
    - contextPath: DBotScore.Score
      description: Indicator's actual score
      type: number
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: IP.Address
      description: IP Indicator's address
      type: string
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
      type: string
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the full Description
      type: string
    - contextPath: URL.Data
      description: URL Indicator's data
      type: string
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
      type: string
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the full Description
      type: string
    - contextPath: Domain.Name
      description: Domain Indicator's name
      type: string
    - contextPath: Domain.Malicious.Vendor
      description: For malicious Domains, the vendor that made the decision
      type: string
    - contextPath: Domain.Malicious.Description
      description: For malicious Domains, the full Description
      type: string
    - contextPath: File.MD5
      description: File Indicator's md5
      type: string
    - contextPath: File.SHA1
      description: File Indicator's sha1
      type: string
    - contextPath: File.SHA256
      description: File Indicator's sha256
      type: string
    - contextPath: File.Malicious.Vendor
      description: For malicious Files, the vendor that made the decision
      type: string
    - contextPath: File.Malicious.Description
      description: For malicious Files, the full Description
      type: string
    description: Retrieve a list of all indicators
  - name: tc-get-tags
    arguments: []
    outputs:
    - contextPath: TC.Tags
      description: A list of tag names
    description: Get a list of all ThreatConnect Tags
  - name: tc-tag-indicator
    arguments:
    - name: tag
      required: true
      description: Tag value
    - name: indicator
      required: true
      description: Indicator to tag (This is the value of indicator like ip, file
        hash, url)
    - name: owner
      description: Filter by owner
    description: Tag an exiting indicator
  - name: tc-get-indicator
    arguments:
    - name: indicator
      required: true
      default: true
      description: Indicator value to search by, can be an IP, url, file Hash. will
        retrieve from all owners
    - name: ratingThreshold
      description: filter on indicators rating grater then given value(value between
        0 to 5)
    - name: confidenceThreshold
      description: filter on indicators confidence grater then given value(value between
        0 to 100)
    outputs:
    - contextPath: TC.Indicator.Name
      description: Indicator's name
      type: string
    - contextPath: TC.Indicator.Type
      description: Indicator type
      type: string
    - contextPath: TC.Indicator.ID
      description: Indicator ID
      type: string
    - contextPath: TC.Indicator.Description
      description: Indicator's description
      type: string
    - contextPath: TC.Indicator.Owner
      description: Indicator's owner
      type: string
    - contextPath: TC.Indicator.CreateDate
      description: Indicator's creation time
      type: date
    - contextPath: TC.Indicator.LastModified
      description: Indicator's last modification date
      type: date
    - contextPath: TC.Indicator.Rating
      description: Indicator's rating
      type: number
    - contextPath: TC.Indicator.Confidence
      description: Indicator's confidence
      type: number
    - contextPath: TC.Indicator.WhoisActive
      description: Indicator's Whois Active. Relevant for domains only
      type: string
    - contextPath: TC.Indicator.File.MD5
      description: Indicator's md5. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA1
      description: Indicator's sha1. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA256
      description: Indicator's sha256. Relevant for files only
      type: string
    - contextPath: DBotScore.Indicator
      description: Indicator's value
      type: string
    - contextPath: DBotScore.Type
      description: Indicator's Type
      type: string
    - contextPath: DBotScore.Score
      description: Indicator's actual score
      type: number
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: IP.Address
      description: IP Indicator's address
      type: string
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
      type: string
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the full Description
      type: string
    - contextPath: URL.Data
      description: URL Indicator's data
      type: string
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
      type: string
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the full Description
      type: string
    - contextPath: Domain.Name
      description: Domain Indicator's name
      type: string
    - contextPath: Domain.Malicious.Vendor
      description: For malicious Domains, the vendor that made the decision
      type: string
    - contextPath: Domain.Malicious.Description
      description: For malicious Domains, the full Description
      type: string
    - contextPath: File.MD5
      description: File Indicator's md5
      type: string
    - contextPath: File.SHA1
      description: File Indicator's sha1
      type: string
    - contextPath: File.SHA256
      description: File Indicator's sha256
      type: string
    - contextPath: File.Malicious.Vendor
      description: For malicious Files, the vendor that made the decision
      type: string
    - contextPath: File.Malicious.Description
      description: For malicious Files, the full Description
      type: string
    description: Retrieve information about a specific indicator
  - name: tc-get-indicators-by-tag
    arguments:
    - name: tag
      required: true
      default: true
      description: Tag value to filter by
    - name: owner
      description: Filter by owner
    outputs:
    - contextPath: TC.Indicator.Name
      description: Indicator's name
      type: string
    - contextPath: TC.Indicator.Type
      description: Indicator type
      type: string
    - contextPath: TC.Indicator.ID
      description: Indicator ID
      type: string
    - contextPath: TC.Indicator.Description
      description: Indicator's description
      type: string
    - contextPath: TC.Indicator.Owner
      description: Indicator's owner
      type: string
    - contextPath: TC.Indicator.CreateDate
      description: Indicator's creation time
      type: date
    - contextPath: TC.Indicator.LastModified
      description: Indicator's last modification date
      type: date
    - contextPath: TC.Indicator.Rating
      description: Indicator's rating
      type: number
    - contextPath: TC.Indicator.Confidence
      description: Indicator's confidence
      type: number
    - contextPath: TC.Indicator.WhoisActive
      description: Indicator's Whois Active. Relevant for domains only
      type: string
    - contextPath: TC.Indicator.File.MD5
      description: Indicator's md5. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA1
      description: Indicator's sha1. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA256
      description: Indicator's sha256. Relevant for files only
      type: string
    - contextPath: DBotScore.Indicator
      description: Indicator's value
      type: string
    - contextPath: DBotScore.Type
      description: Indicator's Type
      type: string
    - contextPath: DBotScore.Score
      description: Indicator's actual score
      type: number
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: IP.Address
      description: IP Indicator's address
      type: string
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
      type: string
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the full Description
      type: string
    - contextPath: URL.Data
      description: URL Indicator's data
      type: string
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
      type: string
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the full Description
      type: string
    - contextPath: Domain.Name
      description: Domain Indicator's name
      type: string
    - contextPath: Domain.Malicious.Vendor
      description: For malicious Domains, the vendor that made the decision
      type: string
    - contextPath: Domain.Malicious.Description
      description: For malicious Domains, the full Description
      type: string
    - contextPath: File.MD5
      description: File Indicator's md5
      type: string
    - contextPath: File.SHA1
      description: File Indicator's sha1
      type: string
    - contextPath: File.SHA256
      description: File Indicator's sha256
      type: string
    - contextPath: File.Malicious.Vendor
      description: For malicious Files, the vendor that made the decision
      type: string
    - contextPath: File.Malicious.Description
      description: For malicious Files, the full Description
      type: string
    description: Fetch all indicators that have given tag
  - name: tc-add-indicator
    arguments:
    - name: indicator
      required: true
      description: The value of the indicator (hash, ip, domain, url, email address
        etc...)
    - name: rating
      description: indicator rating, like 2.5
    - name: confidence
      description: confidence in indicator, in scale of 1-100
    - name: owner
      description: Owner of new indicator, default will be defaultOrg param
    outputs:
    - contextPath: TC.Indicator.Name
      description: Indicator's name
      type: string
    - contextPath: TC.Indicator.Type
      description: Indicator type
      type: string
    - contextPath: TC.Indicator.ID
      description: Indicator ID
      type: string
    - contextPath: TC.Indicator.Description
      description: Indicator's description
      type: string
    - contextPath: TC.Indicator.Owner
      description: Indicator's owner
      type: string
    - contextPath: TC.Indicator.CreateDate
      description: Indicator's creation time
      type: date
    - contextPath: TC.Indicator.LastModified
      description: Indicator's last modification date
      type: date
    - contextPath: TC.Indicator.Rating
      description: Indicator's rating
      type: number
    - contextPath: TC.Indicator.Confidence
      description: Indicator's confidence
      type: number
    - contextPath: TC.Indicator.WhoisActive
      description: Indicator's Whois Active. Relevant for domains only
      type: string
    - contextPath: TC.Indicator.File.MD5
      description: Indicator's md5. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA1
      description: Indicator's sha1. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA256
      description: Indicator's sha256. Relevant for files only
      type: string
    - contextPath: IP.Address
      description: IP Indicator's address
      type: string
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
      type: string
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the full Description
      type: string
    - contextPath: URL.Data
      description: URL Indicator's data
      type: string
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
      type: string
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the full Description
      type: string
    - contextPath: Domain.Name
      description: Domain Indicator's name
      type: string
    - contextPath: Domain.Malicious.Vendor
      description: For malicious Domains, the vendor that made the decision
      type: string
    - contextPath: Domain.Malicious.Description
      description: For malicious Domains, the full Description
      type: string
    - contextPath: File.MD5
      description: File Indicator's md5
      type: string
    - contextPath: File.SHA1
      description: File Indicator's sha1
      type: string
    - contextPath: File.SHA256
      description: File Indicator's sha256
      type: string
    - contextPath: File.Malicious.Vendor
      description: For malicious Files, the vendor that made the decision
      type: string
    - contextPath: File.Malicious.Description
      description: For malicious Files, the full Description
      type: string
    description: Add a new indicator to ThreatConnect
  - name: tc-create-incident
    arguments:
    - name: owner
      description: Owner of new incident, default will be defaultOrg param
    - name: incidentName
      required: true
      default: true
      description: Incident group name
    - name: eventDate
      description: incident time in the format 2017-03-21T00:00:00Z
    - name: tag
      description: incident tag
    - name: securityLabel
      auto: PREDEFINED
      predefined:
      - TLP:RED
      - TLP:GREEN
      - TLP:AMBER
      - TLP:WHITE
      description: security label like 'TLP Green'
    - name: description
      description: incident description attribute
    outputs:
    - contextPath: TC.Incident.Name
      description: Incident group name
      type: string
    - contextPath: TC.Incident.Owner
      description: Incident Owner
      type: string
    - contextPath: TC.Incident.EventDate
      description: Event date
      type: date
    - contextPath: TC.Incident.Tag
      description: Tag name
      type: string
    - contextPath: TC.Incident.SecurityLabel
      description: Incident's security label
      type: string
    - contextPath: TC.Incident.ID
      description: Incident's ID
    description: Create a new incident group
  - name: tc-fetch-incidents
    arguments:
    - name: incidentId
      default: true
      description: filter by incident id
    - name: owner
      description: filter by owner
    - name: incidentName
      description: filter by incident name
    outputs:
    - contextPath: TC.Incident
      description: Incident group name
      type: string
    - contextPath: TC.Incident.ID
      description: Incident ID
      type: string
    - contextPath: TC.Incident.Owner
      description: Incident's owner
      type: string
    description: Fetch TC incidents
  - name: tc-incident-associate-indicator
    arguments:
    - name: indicatorType
      required: true
      auto: PREDEFINED
      predefined:
      - ADDRESSES
      - EMAIL_ADDRESSES
      - URLS
      - HOSTS
      - FILES
      - CUSTOM_INDICATORS
      description: indicator type
    - name: incidentId
      required: true
      description: incident id to associate
    - name: indicator
      required: true
      default: true
      description: value of indicator (hash,ip, url...)
    - name: owner
      description: filter by owner
    outputs:
    - contextPath: TC.Indicator.Name
      description: Indicator's name
      type: string
    - contextPath: TC.Indicator.Type
      description: Indicator type
      type: string
    - contextPath: TC.Indicator.ID
      description: Indicator ID
      type: string
    - contextPath: TC.Indicator.Description
      description: Indicator's description
      type: string
    - contextPath: TC.Indicator.Owner
      description: Indicator's owner
      type: string
    - contextPath: TC.Indicator.CreateDate
      description: Indicator's creation time
      type: date
    - contextPath: TC.Indicator.LastModified
      description: Indicator's last modification date
      type: date
    - contextPath: TC.Indicator.Rating
      description: Indicator's rating
      type: number
    - contextPath: TC.Indicator.Confidence
      description: Indicator's confidence
      type: number
    - contextPath: TC.Indicator.WhoisActive
      description: Indicator's Whois Active. Relevant for domains only
      type: string
    - contextPath: TC.Indicator.File.MD5
      description: Indicator's md5. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA1
      description: Indicator's sha1. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA256
      description: Indicator's sha256. Relevant for files only
      type: string
    - contextPath: IP.Address
      description: IP Indicator's address
      type: string
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
      type: string
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the full Description
      type: string
    - contextPath: URL.Data
      description: URL Indicator's data
      type: string
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
      type: string
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the full Description
      type: string
    - contextPath: Domain.Name
      description: Domain Indicator's name
      type: string
    - contextPath: Domain.Malicious.Vendor
      description: For malicious Domains, the vendor that made the decision
      type: string
    - contextPath: Domain.Malicious.Description
      description: For malicious Domains, the full Description
      type: string
    - contextPath: File.MD5
      description: File Indicator's md5
      type: string
    - contextPath: File.SHA1
      description: File Indicator's sha1
      type: string
    - contextPath: File.SHA256
      description: File Indicator's sha256
      type: string
    - contextPath: File.Malicious.Vendor
      description: For malicious Files, the vendor that made the decision
      type: string
    - contextPath: File.Malicious.Description
      description: For malicious Files, the full Description
      type: string
    description: Associate an indicator to an existing incident, please note indicator
      MUST exist prior to using this command, look at tc-add-indicator for that
  - name: domain
    arguments:
    - name: domain
      required: true
      description: Domain name
    outputs:
    - contextPath: TC.Indicator.Name
      description: Indicator's name
      type: string
    - contextPath: TC.Indicator.Type
      description: Indicator type
      type: string
    - contextPath: TC.Indicator.ID
      description: Indicator ID
      type: string
    - contextPath: TC.Indicator.Description
      description: Indicator's description
      type: string
    - contextPath: TC.Indicator.Owner
      description: Indicator's owner
      type: string
    - contextPath: TC.Indicator.CreateDate
      description: Indicator's creation time
      type: date
    - contextPath: TC.Indicator.LastModified
      description: Indicator's last modification date
      type: date
    - contextPath: TC.Indicator.Rating
      description: Indicator's rating
      type: number
    - contextPath: TC.Indicator.Confidence
      description: Indicator's confidence
      type: number
    - contextPath: TC.Indicator.WhoisActive
      description: Indicator's Whois Active. Relevant for domains only
      type: string
    - contextPath: DBotScore.Indicator
      description: Indicator's value
      type: string
    - contextPath: DBotScore.Type
      description: Indicator's Type
      type: string
    - contextPath: DBotScore.Score
      description: Indicator's actual score
      type: number
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: Domain.Name
      description: Domain Indicator's name
      type: string
    - contextPath: Domain.Malicious.Vendor
      description: For malicious Domains, the vendor that made the decision
      type: string
    - contextPath: Domain.Malicious.Description
      description: For malicious Domains, the full Description
      type: string
    description: Search for domain indicator
  - name: tc-get-incident-associate-indicators
    arguments:
    - name: incidentId
      required: true
      default: true
      description: incident ID
    - name: owner
      description: filter indicators by owner
    outputs:
    - contextPath: TC.Indicator.Name
      description: Indicator's name
      type: string
    - contextPath: TC.Indicator.Type
      description: Indicator type
      type: string
    - contextPath: TC.Indicator.ID
      description: Indicator ID
      type: string
    - contextPath: TC.Indicator.Description
      description: Indicator's description
      type: string
    - contextPath: TC.Indicator.Owner
      description: Indicator's owner
      type: string
    - contextPath: TC.Indicator.CreateDate
      description: Indicator's creation time
      type: date
    - contextPath: TC.Indicator.LastModified
      description: Indicator's last modification date
      type: date
    - contextPath: TC.Indicator.Rating
      description: Indicator's rating
      type: number
    - contextPath: TC.Indicator.Confidence
      description: Indicator's confidence
      type: number
    - contextPath: TC.Indicator.WhoisActive
      description: Indicator's Whois Active. Relevant for domains only
      type: string
    - contextPath: TC.Indicator.File.MD5
      description: Indicator's md5. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA1
      description: Indicator's sha1. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA256
      description: Indicator's sha256. Relevant for files only
      type: string
    - contextPath: DBotScore.Indicator
      description: Indicator's value
      type: string
    - contextPath: DBotScore.Type
      description: Indicator's Type
      type: string
    - contextPath: DBotScore.Score
      description: Indicator's actual score
      type: number
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: IP.Address
      description: IP Indicator's address
      type: string
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
      type: string
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the full Description
      type: string
    - contextPath: URL.Data
      description: URL Indicator's data
      type: string
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
      type: string
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the full Description
      type: string
    - contextPath: Domain.Name
      description: Domain Indicator's name
      type: string
    - contextPath: Domain.Malicious.Vendor
      description: For malicious Domains, the vendor that made the decision
      type: string
    - contextPath: Domain.Malicious.Description
      description: For malicious Domains, the full Description
      type: string
    - contextPath: File.MD5
      description: File Indicator's md5
      type: string
    - contextPath: File.SHA1
      description: File Indicator's sha1
      type: string
    - contextPath: File.SHA256
      description: File Indicator's sha256
      type: string
    - contextPath: File.Malicious.Vendor
      description: For malicious Files, the vendor that made the decision
      type: string
    - contextPath: File.Malicious.Description
      description: For malicious Files, the full Description
      type: string
    description: Get indicator that are related to a specific incident
  - name: tc-update-indicator
    arguments:
    - name: indicator
      required: true
      description: Indicator's name
    - name: rating
      description: Indicator's rating
    - name: confidence
      description: Indicator's confidence
    - name: size
      description: Indicator's size (only for file indicators)
    - name: dnsActive
      description: Indicator's dnsActive (only for hosts indicator)
    - name: whoisActive
      description: Indicator's whoisActive (only for hosts indicator)
    - name: updatedValues
      description: 'A comma separated pair of field and value to be updated. For example:
        "rating=3,confidence=42,description=helloWorld"'
    - name: falsePositive
      auto: PREDEFINED
      predefined:
      - "True"
      - "False"
      description: mark indicator as false positive
    - name: observations
      description: Number observations on this Indicator
    - name: securityLabel
      auto: PREDEFINED
      predefined:
      - TLP:RED
      - TLP:GREEN
      - TLP:AMBER
      - TLP:WHITE
      description: security label like 'TLP Green'
    - name: threatAssessConfidence
      description: Assess confidence
    - name: threatAssessRating
      description: Assess rating
    outputs:
    - contextPath: TC.Indicator.Name
      description: Indicator's name
      type: string
    - contextPath: TC.Indicator.Type
      description: Indicator type
      type: string
    - contextPath: TC.Indicator.ID
      description: Indicator ID
      type: string
    - contextPath: TC.Indicator.Description
      description: Indicator's description
      type: string
    - contextPath: TC.Indicator.Owner
      description: Indicator's owner
      type: string
    - contextPath: TC.Indicator.CreateDate
      description: Indicator's creation time
      type: date
    - contextPath: TC.Indicator.LastModified
      description: Indicator's last modification date
      type: date
    - contextPath: TC.Indicator.Rating
      description: Indicator's rating
      type: number
    - contextPath: TC.Indicator.Confidence
      description: Indicator's confidence
      type: number
    - contextPath: TC.Indicator.WhoisActive
      description: Indicator's Whois Active. Relevant for domains only
      type: string
    - contextPath: TC.Indicator.File.MD5
      description: Indicator's md5. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA1
      description: Indicator's sha1. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA256
      description: Indicator's sha256. Relevant for files only
      type: string
    - contextPath: IP.Address
      description: IP Indicator's address
      type: string
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
      type: string
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the full Description
      type: string
    - contextPath: URL.Data
      description: URL Indicator's data
      type: string
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
      type: string
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the full Description
      type: string
    - contextPath: Domain.Name
      description: Domain Indicator's name
      type: string
    - contextPath: Domain.Malicious.Vendor
      description: For malicious Domains, the vendor that made the decision
      type: string
    - contextPath: Domain.Malicious.Description
      description: For malicious Domains, the full Description
      type: string
    - contextPath: File.MD5
      description: File Indicator's md5
      type: string
    - contextPath: File.SHA1
      description: File Indicator's sha1
      type: string
    - contextPath: File.SHA256
      description: File Indicator's sha256
      type: string
    - contextPath: File.Malicious.Vendor
      description: For malicious Files, the vendor that made the decision
      type: string
    - contextPath: File.Malicious.Description
      description: For malicious Files, the full Description
      type: string
    description: Update a ThreatConnect indicator
  - name: tc-delete-indicator-tag
    arguments:
    - name: indicator
      required: true
      description: Indicator name
    - name: tag
      required: true
      description: Tag name
    outputs:
    - contextPath: TC.Indicator.Name
      description: Indicator's name
      type: string
    - contextPath: TC.Indicator.Type
      description: Indicator type
      type: string
    - contextPath: TC.Indicator.ID
      description: Indicator ID
      type: string
    - contextPath: TC.Indicator.Description
      description: Indicator's description
      type: string
    - contextPath: TC.Indicator.Owner
      description: Indicator's owner
      type: string
    - contextPath: TC.Indicator.CreateDate
      description: Indicator's creation time
      type: date
    - contextPath: TC.Indicator.LastModified
      description: Indicator's last modification date
      type: date
    - contextPath: TC.Indicator.Rating
      description: Indicator's rating
      type: number
    - contextPath: TC.Indicator.Confidence
      description: Indicator's confidence
      type: number
    - contextPath: TC.Indicator.WhoisActive
      description: Indicator's Whois Active. Relevant for domains only
      type: string
    - contextPath: TC.Indicator.File.MD5
      description: Indicator's md5. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA1
      description: Indicator's sha1. Relevant for files only
      type: string
    - contextPath: TC.Indicator.File.SHA256
      description: Indicator's sha256. Relevant for files only
      type: string
    - contextPath: IP.Address
      description: IP Indicator's address
      type: string
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
      type: string
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the full Description
      type: string
    - contextPath: URL.Data
      description: URL Indicator's data
      type: string
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
      type: string
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the full Description
      type: string
    - contextPath: Domain.Name
      description: Domain Indicator's name
      type: string
    - contextPath: Domain.Malicious.Vendor
      description: For malicious Domains, the vendor that made the decision
      type: string
    - contextPath: Domain.Malicious.Description
      description: For malicious Domains, the full Description
      type: string
    - contextPath: File.MD5
      description: File Indicator's md5
      type: string
    - contextPath: File.SHA1
      description: File Indicator's sha1
      type: string
    - contextPath: File.SHA256
      description: File Indicator's sha256
      type: string
    - contextPath: File.Malicious.Vendor
      description: For malicious Files, the vendor that made the decision
      type: string
    - contextPath: File.Malicious.Description
      description: For malicious Files, the full Description
      type: string
    description: Remove a tag from an indicator
  - name: tc-delete-indicator
    arguments:
    - name: indicator
      required: true
      description: Indicator name
    description: Delete an indicator from ThreatConnect
  - name: tc-create-campaign
    arguments:
    - name: name
      required: true
      description: Campaign name
    - name: firstSeen
      description: The first seen date for the Campaign
    - name: owner
      description: Owner of new incident, default will be defaultOrg param
    - name: description
      description: Add description to the campaign
    - name: tag
      description: campaign tag
    - name: securityLabel
      description: Security label like 'TLP Green'
    outputs:
    - contextPath: TC.Campaign.Name
      description: Campaign's name
      type: string
    - contextPath: TC.Campaign.Owner
      description: Campaign's owner
      type: string
    - contextPath: TC.Campaign.FirstSeen
      description: First seen date for the Campaign
      type: date
    - contextPath: TC.Campaign.Tag
      description: Campaign's tag
      type: string
    - contextPath: TC.Campaign.SecurityLevel
      description: Campaign's Security label
      type: string
    - contextPath: TC.Campaign.ID
      description: Campaign ID
      type: string
    description: Create a ThreatConnect group from type Campaign
  - name: tc-create-event
    arguments:
    - name: name
      required: true
      description: event Name
    - name: eventDate
      description: Event Date. if not specified, will use current date
    - name: status
      auto: PREDEFINED
      predefined:
      - Needs Review
      - False Positive
      - No Further Action
      - Escalated
      description: Event's status
    - name: owner
      description: Event's owner
    - name: description
      description: Event description
    - name: tag
      description: Tag the event
    outputs:
    - contextPath: TC.Event.Name
      description: Event name
      type: string
    - contextPath: TC.Event.Date
      description: Event Date
      type: date
    - contextPath: TC.Event.Status
      description: Event status
      type: string
    - contextPath: TC.Event.Owner
      description: Event's owner
      type: string
    - contextPath: TC.Event.Tag
      description: Event's tag
      type: string
    - contextPath: TC.Event.ID
      description: Event ID
      type: string
    description: Create a ThreatConnect group from type Event
  - name: tc-create-threat
    arguments:
    - name: name
      required: true
      description: Threats group name
    outputs:
    - contextPath: TC.Threat.Name
      description: Threat's name
      type: string
    - contextPath: TC.Threat.ID
      description: Threat's ID
      type: string
    description: Create a ThreatConnect group from type Threats
  - name: tc-delete-group
    arguments:
    - name: groupID
      required: true
      description: Group's ID
    - name: type
      required: true
      auto: PREDEFINED
      predefined:
      - Incidents
      - Events
      - Campaigns
      - Threats
      description: Group type (Incident,Event,Campaign,Threat)
    description: Delete a Group from ThreatConnect (Incident, Event, Campaign, Threat)
  dockerimage: demisto/threatconnect-sdk
  runonce: false
releaseNotes: "add support in updating indicator's fields"
tests:
  - test-ThreatConnect