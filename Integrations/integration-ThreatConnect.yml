commonfields:
  id: ThreatConnect
  version: -1
name: ThreatConnect
display: ThreatConnect
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: Threat Intelligence platform
configuration:
- display: Access ID
  name: accessId
  defaultvalue: ""
  type: 0
  required: true
- display: Secret Key
  name: secretKey
  defaultvalue: ""
  type: 4
  required: true
- display: baseUrl
  name: baseUrl
  defaultvalue: https://api.threatconnect.com
  type: 0
  required: true
- display: defaultOrg
  name: defaultOrg
  defaultvalue: ""
  type: 0
  required: false
- display: ProxyIP  (or http://${ip} )
  name: proxyIp
  defaultvalue: ""
  type: 0
  required: false
- display: ProxyPort
  name: proxyPort
  defaultvalue: ""
  type: 0
  required: false
script:
  script: |-
    from threatconnect import ThreatConnect
    from threatconnect.RequestObject import RequestObject
    from threatconnect.Config.IndicatorType import IndicatorType
    from threatconnect.Config.ResourceType import ResourceType
    from threatconnect.Config.FilterOperator import FilterOperator
    import urllib
    import datetime
    from urlparse import urlparse

    filePath= 'File(val.MD5 && val.MD5 == obj.MD5 || val.SHA1 && val.SHA1 == obj.SHA1 || val.SHA256 && val.SHA256 == obj.SHA256)'
    ipPath= 'IP(val.Address && val.Address == obj.Address)'
    urlPath= 'URL(val.Data && val.Data == obj.Data)'
    domainPath= 'Domain(val.Name && val.Name == obj.Name)'

    defaultMaliciosConfidenceThreshold = 50
    defaultMaliciosRatingThreshold = 3

    def escapeNewLines(indJson):
        indJson = indJson.replace('\r', '<br>')
        indJson = indJson.replace('\\n', '<br>')
        return indJson

    def getClient():
        access = demisto.params()['accessId']
        secert = demisto.params()['secretKey']
        url = demisto.params()['baseUrl']
        default_org = demisto.params()['defaultOrg']
        proxy_ip = demisto.params()['proxyIp']
        proxy_port = demisto.params()['proxyPort']
        tc = ThreatConnect(access, secert, default_org, url)
        if proxy_ip and proxy_port and len(proxy_ip) > 0 and len(proxy_port) > 0:
            tc.set_proxies(proxy_ip, int(proxy_port))
        return tc

    def buildFilters(args):
        filters = '?'
        if demisto.get(args, 'ratingThreshold'):
            filters = filters + 'rating%3E' + demisto.args()['ratingThreshold']
        if demisto.get(args, 'confidenceThreshold'):
            if len(filters) > 1:
                filters = filters + '&'
            filters = filters + 'threatAssessConfidence%3E' + demisto.args()['confidenceThreshold']
        if len(filters) == 1:
            return '' # no filters at all in this case
        return filters

    def createContext(indicators,contextPath,ratingThreshold,confidenceThreshold,indicatorType):
        ec = {};
        ec['DBotScore'] = [];
        ec[contextPath] = [];
        if ratingThreshold < 0:
            ratingThreshold = defaultMaliciosRatingThreshold
        if confidenceThreshold < 0:
            confidenceThreshold = defaultMaliciosConfidenceThreshold
        for ind in indicators:
            dbotScore = 0
            if ind.confidence >= confidenceThreshold and ind.rating>= ratingThreshold:
                dbotScore = 3
                desc = ''
                if hasattr(ind, 'description'):
                    desc = ind.description
                mal = {'Malicious':{'Vendor':'ThreatConnect','Description':desc}}
                if indicatorType == 'ip':
                    if hasattr(ind, 'summary'):
                        mal['Address'] = ind.summary
                elif indicatorType == 'hash':
                    if hasattr(ind, 'md5'):
                        mal['MD5'] = ind.md5
                    if hasattr(ind, 'sha1'):
                        mal['SHA1'] = ind.sha1
                    if hasattr(ind, 'sha256'):
                        mal['SHA256'] = ind.sha256
                elif indicatorType == 'url':
                    if hasattr(ind, 'indicator'):
                        mal['Data'] = ind.indicator
                elif indicatorType == 'domain':
                    if hasattr(ind, 'hostName'):
                        mal['Name'] = ind.hostName
                mal['properties_to_append'] = ['Malicious'];
                ec[contextPath] = mal;
            elif ind.rating >=1:
                dbotScore = 2
            else:
                dbotScore = 1
            ec['DBotScore'].append({'Indicator': ind.indicator, 'Type': indicatorType, 'Vendor': 'ThreatConnect', 'Score': dbotScore});
        return ec

    def getIndicatorsForDbot(args, indicatorValue, indicatorType):
        tc = getClient()
        indicators = tc.indicators()
        filter1 = indicators.add_filter()
        filter1.add_indicator(indicatorValue)
        owners_arr = []
        if demisto.get(demisto.args(), 'owners'):
            owners = demisto.args()['owners'].split(",")
            owners_arr.extend(owners)
        else:
            owners = tc.owners()
            owners.retrieve()
            for owner in owners:
                owners_arr.append(owner.name)
        filter1.add_owner(owners_arr)
        if demisto.get(demisto.args(), 'ratingThreshold'):
            filter1.add_pf_rating(int(demisto.args()['ratingThreshold']), FilterOperator.GE)
        if demisto.get(demisto.args(), 'confidenceThreshold'):
            filter1.add_pf_confidence(int(demisto.args()['confidenceThreshold']), FilterOperator.GE)
        if indicatorType:
            filter1.add_pf_type(indicatorType, FilterOperator.EQ)
        indicators.retrieve()
        return indicators

    def getIndicator(indicatorType, value, owners, limit, filters):
        tc = getClient()
        tc.set_api_result_limit(limit)
        ro = RequestObject()
        ro.set_http_method('GET')
        ro.set_request_uri('/v2/indicators/'+indicatorType+'/'+value+filters)
        if len(owners) > 0:
            ro.set_owner(owners)
            ro.set_owner_allowed(True)
        results = tc.api_request(ro)
        if results.headers['content-type'] == 'application/json':
            data = results.json()
            return json.dumps(data, indent=4)

    # The command demisto.command() holds the command sent from the user.
    if demisto.command() == 'test-module':
        tc = getClient()
        owners = tc.owners()
        owners.retrieve()
        demisto.results('ok')
        sys.exit(0)
    if demisto.command() == 'ip':
        ip = demisto.args()['ip']
        malRatingThreshold = -1
        malConfidenceThreshold = -1
        if demisto.get(demisto.args(), 'ratingThreshold'):
            malRatingThreshold = int(demisto.args()['ratingThreshold'])
        if demisto.get(demisto.args(), 'confidenceThreshold'):
            malConfidenceThreshold = int(demisto.args()['confidenceThreshold'])
        indicators = getIndicatorsForDbot(demisto.args(), ip, 'Address')
        ec = createContext(indicators,ipPath,malRatingThreshold,malConfidenceThreshold,'ip')
        indicatorsArr = []
        for indicator in indicators:
            indJson = escapeNewLines(indicator.json)
            indicatorsArr.append(json.loads(indJson))
        if len(indicators) == 0:
            md = "## ThreatConnect IP Report for: " + ip + "\nNo results found!"
            demisto.results({"Type": 1, "ContentsFormat": "text", "Contents": md,"EntryContext": ec, "HumanReadable": md})
        else:
            demisto.results({"Type": 1, "ContentsFormat": "json", "HumanReadable": tableToMarkdown("ThreatConnect IP Reputation for: "+ip, indicatorsArr, ""),"Contents": json.dumps(indicatorsArr),"EntryContext": ec})
        sys.exit(0)
    if demisto.command() == 'url':
        url = demisto.args()['url']
        parsed_url = urlparse(url)
        if not parsed_url.scheme:
            return_error('Please provide a valid URL including a protocol (http/https)')
        malRatingThreshold = -1
        malConfidenceThreshold = -1
        if demisto.get(demisto.args(), 'ratingThreshold'):
            malRatingThreshold = int(demisto.args()['ratingThreshold'])
        if demisto.get(demisto.args(), 'confidenceThreshold'):
            malConfidenceThreshold = int(demisto.args()['confidenceThreshold'])
        indicators = getIndicatorsForDbot(demisto.args(), url, 'URL')
        ec = createContext(indicators,urlPath,malRatingThreshold,malConfidenceThreshold,'url')
        indicatorsArr = []
        for indicator in indicators:
            indJson = escapeNewLines(indicator.json)
            indicatorsArr.append(json.loads(indJson))
        if len(indicators) == 0:
            md = "## ThreatConnect URL Report for: " + url + "\nNo results found!"
            demisto.results({"Type": 1, "ContentsFormat": "text", "Contents": md,"EntryContext": ec, "HumanReadable": md})
        else:
            demisto.results({"Type": 1, "ContentsFormat": "json", "HumanReadable": tableToMarkdown("ThreatConnect URL Reputation for: "+url, indicatorsArr, ""), "Contents": json.dumps(indicatorsArr),"EntryContext": ec})
        sys.exit(0)
    if demisto.command() == 'file':
        file = demisto.args()['file']
        malRatingThreshold = -1
        malConfidenceThreshold = -1
        if demisto.get(demisto.args(), 'ratingThreshold'):
            malRatingThreshold = int(demisto.args()['ratingThreshold'])
        if demisto.get(demisto.args(), 'confidenceThreshold'):
            malConfidenceThreshold = int(demisto.args()['confidenceThreshold'])
        indicators = getIndicatorsForDbot(demisto.args(), file, 'File')
        ec = createContext(indicators,filePath,malRatingThreshold,malConfidenceThreshold,'hash')
        indicatorsArr = []
        for indicator in indicators:
            indJson = escapeNewLines(indicator.json)
            indicatorsArr.append(json.loads(indJson))
        if len(indicators) == 0:
            md = "## ThreatConnect File Report for: " + file + "\nNo results found!"
            demisto.results({"Type": 1, "ContentsFormat": "text", "Contents": md,"EntryContext": ec, "HumanReadable": md})
        else:
            demisto.results({"Type": 1, "ContentsFormat": "json", "HumanReadable": tableToMarkdown("ThreatConnect File Reputation for: "+file, indicatorsArr, ""), "Contents": json.dumps(indicatorsArr),"EntryContext": ec})
        sys.exit(0)
    if demisto.command() == 'domain':
        domain = demisto.args()['domain']
        malRatingThreshold = -1
        malConfidenceThreshold = -1
        if demisto.get(demisto.args(), 'ratingThreshold'):
            malRatingThreshold = int(demisto.args()['ratingThreshold'])
        if demisto.get(demisto.args(), 'confidenceThreshold'):
            malConfidenceThreshold = int(demisto.args()['confidenceThreshold'])
        indicators = getIndicatorsForDbot(demisto.args(), domain, 'Host')
        ec = createContext(indicators,domainPath,malRatingThreshold,malConfidenceThreshold,'domain')
        indicatorsArr = []
        for indicator in indicators:
            indJson = escapeNewLines(indicator.json)
            indicatorsArr.append(json.loads(indJson))
        if len(indicators) == 0:
            md = "## ThreatConnect Domain Report for: " + domain + "\nNo results found!"
            demisto.results({"Type": 1, "ContentsFormat": "text", "Contents": md,"EntryContext": ec, "HumanReadable": md})
        else:
            demisto.results({"Type": 1, "ContentsFormat": "json", "HumanReadable": tableToMarkdown("ThreatConnect Domain Reputation for: "+domain, indicatorsArr, ""), "Contents": json.dumps(indicatorsArr),"EntryContext": ec})
        sys.exit(0)
    if demisto.command() == 'tc-owners':
        tc = getClient()
        ro = RequestObject()
        ro.set_http_method('GET')
        ro.set_request_uri('/v2/owners')
        results = tc.api_request(ro)
        if results.headers['content-type'] == 'application/json':
            data = results.json()
            res = json.dumps(data, indent=4)
            demisto.results({"Type": 1, "ContentsFormat": "json", "Contents": res})
    if demisto.command() == 'tc-indicators':
        tc = getClient()
        limit = 500
        if demisto.get(demisto.args(), 'limit'):
            limit = int(demisto.args()['limit'])
        tc.set_api_result_limit(limit)
        ro = RequestObject()
        ro.set_http_method('GET')
        ro.set_request_uri('/v2/indicators/')
        owners = ''
        if demisto.get(demisto.args(), 'owners'):
            owners = demisto.args()['owners']
        if len(owners) > 0:
            ro.set_owner(owners)
            ro.set_owner_allowed(True)
        results = tc.api_request(ro)
        if results.headers['content-type'] == 'application/json':
            data = results.json()
            res = json.dumps(data, indent=4)
            demisto.results({"Type": 1, "ContentsFormat": "json", "Contents": res})
        sys.exit(0)
    if demisto.command() == 'tc-get-tags':
        tc = getClient()
        ro = RequestObject()
        ro.set_http_method('GET')
        ro.set_request_uri('/v2/tags')
        results = tc.api_request(ro)
        if results.headers['content-type'] == 'application/json':
            data = results.json()
            res = json.dumps(data, indent=4)
            demisto.results({"Type": 1, "ContentsFormat": "json", "Contents": res})
        sys.exit(0)
    if demisto.command() == 'tc-tag-indicator':
        tc = getClient()
        indicators = tc.indicators()
        filter1 = indicators.add_filter()
        filter1.add_indicator(demisto.args()['indicator'])
        owners_arr = []
        if "owner" in demisto.args():
            owners_arr.append(demisto.args()['owner'])
        else:
            owners = tc.owners()
            owners.retrieve()
            for owner in owners:
                owners_arr.append(owner.name)
        filter1.add_owner(owners_arr)
        indicators.retrieve()

        for indicator in indicators:
            indicator.add_tag(demisto.args()['tag'])
            indicator.commit()
            demisto.results({"Type": 1, "ContentsFormat": "text", "Contents": "Indicator: "+demisto.args()['indicator']+" With id: "+str(indicator.id)+", was tagged with tag: "+demisto.args()['tag']})
        sys.exit(0)
    if demisto.command() == 'tc-get-indicator':
        tc = getClient()
        indicators = tc.indicators()
        filter1 = indicators.add_filter()
        filter1.add_indicator(demisto.args()['indicator'])
        owners_arr = []
        owners = tc.owners()
        owners.retrieve()
        for owner in owners:
            owners_arr.append(owner.name)
        filter1.add_owner(owners_arr)
        if demisto.get(demisto.args(), 'ratingThreshold'):
            filter1.add_pf_rating(int(demisto.args()['ratingThreshold']), FilterOperator.GT)
        if demisto.get(demisto.args(), 'confidenceThreshold'):
            filter1.add_pf_confidence(int(demisto.args()['confidenceThreshold']), FilterOperator.GT)
        indicators.retrieve()

        indicatorsArr = []
        for indicator in indicators:
            indicatorsArr.append(json.loads(indicator.json))
        if len(indicators) == 0:
            demisto.results({"Type": 1, "ContentsFormat": "text", "Contents": "Found no results for given indicator: "+demisto.args()['indicator']})
        else:
            demisto.results({"Type": 1, "ContentsFormat": "json", "Contents": json.dumps(indicatorsArr)})
        sys.exit(0)
    if demisto.command() == 'tc-get-indicators-by-tag':
        tc = getClient()
        ro = RequestObject()
        ro.set_http_method('GET')
        ro.set_request_uri('/v2/tags/'+demisto.args()['tag']+'/indicators')
        results = tc.api_request(ro)
        if results.headers['content-type'] == 'application/json':
            data = results.json()
            res = json.dumps(data, indent=4)
            demisto.results({"Type": 1, "ContentsFormat": "json", "Contents": res})
        sys.exit(0)
    if demisto.command() == 'tc-add-indicator':
        tc = getClient()
        indicators = tc.indicators()
        indicator = indicators.add(demisto.args()['indicator'], demisto.params()['defaultOrg'])
        if demisto.get(demisto.args(), 'rating'):
            indicator.set_rating(int(demisto.args()['rating']))
        if demisto.get(demisto.args(), 'confidence'):
            indicator.set_confidence(int(demisto.args()['confidence']))
        indicator.commit()
        demisto.results({"Type": 1, "ContentsFormat": "text", "Contents": "Created new indicator: "+demisto.args()['indicator']})
        sys.exit(0)
    if demisto.command() == 'tc-create-incident':
        tc = getClient()
        incidents = tc.incidents()
        owner = demisto.params()['defaultOrg']
        if demisto.get(demisto.args(), 'owner'):
            owner = demisto.args()['owner']
        incident = incidents.add(demisto.args()['incidentName'], owner)
        eventDate = ""
        if demisto.get(demisto.args(), 'eventDate'):
            eventDate = demisto.args()['eventDate']
        else:
            d = datetime.datetime.utcnow()
            dateStr = d.isoformat("T")
            dateStr = dateStr[:dateStr.rfind(".")]
            eventDate = dateStr + "Z"
        incident.set_event_date(eventDate)
        if demisto.get(demisto.args(), 'tag'):
            incident.add_tag(demisto.args()['tag'])
        if demisto.get(demisto.args(), 'securityLabel'):
            incident.set_security_label(demisto.args()['securityLabel'])
        if demisto.get(demisto.args(), 'description'):
            incident.add_attribute('Description', demisto.args()['description'])
        incident.commit()
        demisto.results({"Type": 1, "ContentsFormat": "text", "Contents": "Created new incident: "+demisto.args()['incidentName']})
        sys.exit(0)
    if demisto.command() == 'tc-fetch-incidents':
        tc = getClient()
        incidents = tc.incidents()
        if demisto.get(demisto.args(), 'incidentId') or demisto.get(demisto.args(), 'owner') or demisto.get(demisto.args(), 'incidentName'):
            filter1 = incidents.add_filter()
            if demisto.get(demisto.args(), 'incidentId'):
                filter1.add_id(int(demisto.args()['incidentId']))
            if demisto.get(demisto.args(), 'owner'):
                filter1.add_owner(demisto.args()['owner'])
            if demisto.get(demisto.args(), 'incidentName'):
                filter1.add_pf_name(demisto.args()['incidentName'])
        incidents.retrieve()
        incidentsJsonArr = []
        for incident in incidents:
            incidentsJsonArr.append(json.loads(incident.json))
        demisto.results({"Type": 1, "ContentsFormat": "json", "Contents": json.dumps(incidentsJsonArr), "EntryContext": {"ThreatConnect.incidents": incidentsJsonArr}})
        sys.exit(0)
    if demisto.command() == 'tc-get-incident-associate-indicators':
        tc = getClient()
        incidents = tc.incidents()
        filter1 = incidents.add_filter()
        filter1.add_id(int(demisto.args()['incidentId']))
        if demisto.get(demisto.args(), 'owner'):
            filter1.add_owner(demisto.args()['owner'])
        incidents.retrieve()
        indicatorsArr = []
        for incident in incidents:
            for indicator in incident.indicator_associations:
                indicatorsArr.append(indicator.indicator)
        demisto.results({"Type": 1, "ContentsFormat": "json", "Contents": json.dumps(indicatorsArr)})
        sys.exit(0)
    if demisto.command() == 'tc-incident-associate-indicator':
        tc = getClient()
        incidents = tc.incidents()
        filter1 = incidents.add_filter()
        filter1.add_id(int(demisto.args()['incidentId']))
        if demisto.get(demisto.args(), 'owner'):
            filter1.add_owner(demisto.args()['owner'])
        indType = ResourceType.URLS
        indTypeStr = demisto.get(demisto.args(), 'indicatorType')
        if indTypeStr == 'ADDRESSES':
            indType = ResourceType.ADDRESSES
        elif indTypeStr == 'EMAIL_ADDRESSES':
            indType = ResourceType.EMAIL_ADDRESSES
        elif indTypeStr == 'FILES':
            indType = ResourceType.FILES
        elif indTypeStr == 'HOSTS':
            indType = ResourceType.HOSTS
        elif indTypeStr == 'CUSTOM_INDICATORS':
            indType = ResourceType.CUSTOM_INDICATORS
        incidents.retrieve()
        for incident in incidents:
            incident.associate_indicator(indType, demisto.args()['indicator'])

            incident.commit()
            demisto.results({"Type": 1, "ContentsFormat": "json", "Contents": incident.json})
        sys.exit(0)
  type: python
  commands:
  - name: ip
    arguments:
    - name: ip
      required: true
      default: true
      description: IPv4/IPv6 address
    - name: owners
      description: 'client’s Organization or any Sources or Communities to which a
        client’s API User has been granted permission, comma separated: owner1,owner2,owner3'
    - name: ratingThreshold
      description: filter on indicators rating grater then given value(value between
        0 to 5)
    - name: confidenceThreshold
      description: filter on indicators confidence grater then given value(value between
        0 to 100)
    outputs:
    - contextPath: IP.Address
      description: Bad IP Address found
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the full Description
    description: search for IP indicator
  - name: url
    arguments:
    - name: url
      required: true
      default: true
      description: url like www.demisto.com
    - name: owners
      description: client’s Organization or any Sources or Communities to which a
        client’s API User has been granted permission.
    - name: ratingThreshold
      description: filter on indicators rating grater then given value(value between
        0 to 5)
    - name: confidenceThreshold
      description: filter on indicators confidence grater then given value(value between
        0 to 100)
    outputs:
    - contextPath: URL.Data
      description: Bad URLs found
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: search for URL indicator
  - name: file
    arguments:
    - name: file
      required: true
      default: true
      description: hash of the file (MD5, SHA-1, or SHA-256)
    - name: owners
      description: client’s Organization or any Sources or Communities to which a
        client’s API User has been granted permission.
    - name: ratingThreshold
      description: filter on indicators rating grater then given value(value between
        0 to 5)
    - name: confidenceThreshold
      description: filter on indicators confidence grater then given value(value between
        0 to 100)
    outputs:
    - contextPath: File.MD5
      description: Bad hash found
    - contextPath: File.SHA1
      description: Bad hash SHA1
    - contextPath: File.SHA256
      description: Bad hash SHA256
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision
    - contextPath: File.Malicious.Description
      description: For malicious files, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: search for File indicator
  - name: tc-owners
    arguments: []
    description: retrieve possible owners from this account
  - name: tc-indicators
    arguments:
    - name: owner
      description: client’s Organization or any Sources or Communities to which a
        client’s API User has been granted permission.
    - name: limit
      description: int limit of results, default is 500
    description: 'retrieve all indicators '
  - name: tc-get-tags
    arguments: []
    description: Get all ThreatConnect Tags in system
  - name: tc-tag-indicator
    arguments:
    - name: tag
      required: true
      description: Tag value
    - name: indicator
      required: true
      default: true
      description: Indicator to tag, this is the value of indicator like ip, file
        hash, url
    - name: owner
      description: filter by owner
    description: Tag an exiting indicator
  - name: tc-get-indicator
    arguments:
    - name: indicator
      required: true
      default: true
      description: Indicator value to search by, can be an IP, url, file Hash. will
        retrieve from all owners
    - name: ratingThreshold
      description: filter on indicators rating grater then given value(value between
        0 to 5)
    - name: confidenceThreshold
      description: filter on indicators confidence grater then given value(value between
        0 to 100)
    description: Get indicator
  - name: tc-get-indicators-by-tag
    arguments:
    - name: tag
      required: true
      default: true
      description: Tag value to filter by
    description: Fetch all indicators that have given tag
  - name: tc-add-indicator
    arguments:
    - name: indicator
      required: true
      description: The value of the indicator, can be hash/ip/domain/url
    - name: rating
      description: indicator rating, like 2.5
    - name: confidence
      description: confidence in indicator, in scale of 1-100
    description: Add a new indicator to ThreatConnect
  - name: tc-create-incident
    arguments:
    - name: owner
      description: Owner of new incident, default will be defaultOrg param
    - name: incidentName
      required: true
      default: true
      description: Incident group name
    - name: eventDate
      description: incident time in the format 2017-03-21T00:00:00Z
    - name: tag
      description: incident tag
    - name: securityLabel
      description: security label like 'TLP Green'
    - name: description
      description: incident description attribute
    description: Create a new incident group
  - name: tc-fetch-incidents
    arguments:
    - name: incidentId
      default: true
      description: filter by incident id too
    - name: owner
      description: filter by owner
    - name: incidentName
      description: filter by incident name
    outputs:
    - contextPath: ThreatConnect.incidents
      description: Incidents from ThreatConnect
    description: Fetch TC incidents
  - name: tc-incident-associate-indicator
    arguments:
    - name: indicatorType
      required: true
      auto: PREDEFINED
      predefined:
      - ADDRESSES
      - EMAIL_ADDRESSES
      - URLS
      - HOSTS
      - FILES
      - CUSTOM_INDICATORS
      description: indicator type
    - name: incidentId
      required: true
      description: incident id to associate
    - name: indicator
      required: true
      default: true
      description: value of indicator (hash,ip, url...)
    - name: owner
      description: filter by owner
    description: associate an indicator to an existing incident, please note indicator
      MUST exist prior to using this command, look at tc-add-indicator for that
  - name: domain
    arguments:
    - name: domain
      required: true
      default: true
      description: Domain name to check reputation
    outputs:
    - contextPath: Domain.Name
      description: Bad domain found
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    description: Check domain reputation
  - name: tc-get-incident-associate-indicators
    arguments:
    - name: incidentId
      required: true
      default: true
      description: incident ID
    - name: owner
      description: filter by owner too
    description: Get incidents that are related to a specific indicator
  dockerimage: demisto/threatconnect-sdk
tests:
  - "test-ThreatConnect"
