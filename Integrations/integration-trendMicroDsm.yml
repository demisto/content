commonfields:
  id: Trend Micro
  version: -1
name: Trend Micro
system: true
display: Trend Micro
category: Endpoint
image: data:image/png;base64,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
description: Uses Trend Micro Deep Security
detaileddescription: |+
  To enable API access, configure the following using the Web UI of the Trend Micro Deep Security Manager:
  - Enable the SOAP API:
  Administration -> System Settings -> Advanced -> SOAP Web Service API -> Enable
  -  Connecting user must have the role "Allow Access to web services API" checked.

configuration:
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Server URL and port (e.g. https://192.168.0.1:4119)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
script:
  script: |2+

    var username = params.credentials.identifier;
    var password = params.credentials.password;
    var server = params.server.replace(/[\/]+$/, '');
    var insecure = params.insecure;
    var proxy = params.proxy;
    var url = server + '/webservice/Manager';


    var responseDict = {
        'authenticate': /<authenticateReturn>(.*)<\/authenticateReturn/,
        'hostRetrieveAll': /<soapenv:Body>((.|\n)*)<\/soapenv:Body>/,
        'endSession': /<soapenv:Body><endSessionResponse xmlns=(.*)\/><\/soapenv:Body>/,
        'systemEventRetrieve': /<systemEventRetrieveResponse xmlns="urn:Manager">((.|\n)*)<\/systemEventRetrieveResponse>/,
        'antiMalwareEventRetrieve':/<antiMalwareEventRetrieveResponse xmlns="urn:Manager">((.|\n)*)<\/antiMalwareEventRetrieveResponse>/,
        'hostAntiMalwareScan':/<soapenv:Body>((.|\n)*)<\/soapenv:Body>/,
        'alertStatusRetrieve':/<soapenv:Body>((.|\n)*)<\/soapenv:Body>/,
        'securityProfileRetrieveAll': /<soapenv:Body>((.|\n)*)<\/soapenv:Body>/,
        'securityProfileAssignToHost': /<soapenv:Body>((.|\n)*)<\/soapenv:Body>/
    };



    var commandToMethod = {
        'trendmicro-host-antimalware-scan': 'hostAntiMalwareScan',
        'trendmicro-host-retrieve-all': 'hostRetrieveAll',
        'trendmicro-system-event-retrieve': 'systemEventRetrieve',
        'trendmicro-anti-malware-event-retrieve': 'antiMalwareEventRetrieve',
        'trendmicro-alert-status': 'alertStatusRetrieve',
        'trendmicro-security-profile-retrieve-all': 'securityProfileRetrieveAll',
        'trendmicro-security-profile-assign-to-host': 'securityProfileAssignToHost'
    };

    var sessionData = '<urn:sID>%sessionId%</urn:sID>';

    var methodDict = {
            'authenticate': '<urn:authenticate><urn:username>%username%</urn:username><urn:password>%password%</urn:password></urn:authenticate>',
            'endSession': '<urn:endSession>' + sessionData + '</urn:endSession>',
            'hostRetrieveAll': '<urn:hostRetrieveAll>' + sessionData + '</urn:hostRetrieveAll>',
            'systemEventRetrieve': '<urn:systemEventRetrieve>%timeFilter%%hostFilter%%eventIdFilter%<urn:includeNonHostEvents>%includeNonHostEvents%</urn:includeNonHostEvents>'+ sessionData +'</urn:systemEventRetrieve>',
            'antiMalwareEventRetrieve': '<urn:antiMalwareEventRetrieve>%timeFilter%%hostFilter%%eventIdFilter%'+ sessionData +'</urn:antiMalwareEventRetrieve>',
            'hostAntiMalwareScan': '<urn:hostAntiMalwareScan>%hostIDs%' + sessionData + '</urn:hostAntiMalwareScan>',
            'alertStatusRetrieve': '<urn:alertStatusRetrieve><urn:count>%count%</urn:count>' + sessionData + '</urn:alertStatusRetrieve>',
            'securityProfileRetrieveAll': '<urn:securityProfileRetrieveAll>' + sessionData + '</urn:securityProfileRetrieveAll>',
            'securityProfileAssignToHost':'<urn:securityProfileAssignToHost><urn:securityProfileID>%securityProfileID%</urn:securityProfileID>%hostIDs%' + sessionData + '</urn:securityProfileAssignToHost>'
    };

    var filterDict = {
        'timeFilter': '<urn:timeFilter>%timeFilter%</urn:timeFilter>',
        'hostFilter': '<urn:hostFilter>%hostFilter%</urn:hostFilter>',
        'eventIdFilter': '<urn:eventIdFilter>%eventIdFilter%</urn:eventIdFilter>'

    };



    var hostFilterDict = {
        'hostGroupID': '<urn:hostGroupID>%hostGroupID%</urn:hostGroupID>',
        'hostID': '<urn:hostID>%hostID%</urn:hostID>',
        'securityProfileID': '<urn:securityProfileID>%securityProfileID%</urn:securityProfileID>',
        'hostFilterType': '<urn:type>%hostFilterType%</urn:type>'

    };

    var timeFilterDict = {
      'rangeFrom': '<urn:rangeFrom>%rangeFrom%</urn:rangeFrom>',
      'rangeTo': '<urn:rangeTo>%rangeTo%</urn:rangeTo>',
      'specificTime': '<urn:specificTime>%specificTime%</urn:specificTime>',
      'timeFilterType': '<urn:type>%timeFilterType%</urn:type>'
    };

    var eventIdFilterDict = {
      'eventID': '<urn:id>%eventID%</urn:id>',
      'eventFilterOperator': '<urn:operator>%eventFilterOperator%</urn:operator>'
    };

    var filterContentDict = {
        'hostFilter': hostFilterDict,
        'timeFilter': timeFilterDict,
        'eventIdFilter': eventIdFilterDict
    };

    // Wrap host IDs array if exists
    if ('hostIDs' in args) {
            args.hostIDs = '<urn:hostIDs>' + args.hostIDs.split(',').join('</urn:hostIDs><urn:hostIDs>') + '</urn:hostIDs>';
    }

    function getFilterContent(filterName, args) {
        var filterContent = '';
        filterArgsDict = filterContentDict[filterName];
        var argNames = Object.keys(args);
        for (var i = 0; i < argNames.length; i++) {
            if (argNames[i] in filterArgsDict){
            filterContent += filterArgsDict[argNames[i]];
            }
        }
        if (!filterContent) {
            return '';
        }

        var  filterContents = {};
        filterContents[filterName] = filterContent;
        return replaceInTemplates(filterDict[filterName], filterContents);
    }

    // In requests with optional filters, the command arguemnts will determine which filters to add
    function AddFiltersIfNeeded(reqTemplate, args) {
        var filtersForRequest = {};
        var filterNames = Object.keys(filterDict);
        for (var i = 0; i < filterNames.length; i++) {
            var patt = new RegExp(filterNames[i]);
            if (patt.exec(reqTemplate)) {
                var filterContent = getFilterContent(filterNames[i], args);
                filtersForRequest[filterNames[i]] = filterContent;
            }
        }
        return  replaceInTemplates(reqTemplate, filtersForRequest);
    }

    function createSOAPRequest(methodName, args) {
        var request = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:urn="urn:Manager"><soapenv:Header/><soapenv:Body>%content%</soapenv:Body></soapenv:Envelope>';
        var bodyWithFilters = AddFiltersIfNeeded(methodDict[methodName], args);
        request = replaceInTemplates(request, {'content': bodyWithFilters}); // add body to request
        request = replaceInTemplates(request, args); // fill arguemnts
        return request;
    }

    function sendSOAPRequest(methodName, args) {
        var req = createSOAPRequest(methodName, args);
        var res = http(
            url,
            {
                Method: 'POST',
                Headers: {
                SOAPAction: [""]
                },
                Body: req
            },
            insecure,
            proxy
        );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
                throw 'Failed to ' + methodName + ', request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
            }
        return res.Body;
    }

    function sendAndParse(method, args) {
        var responseXML = sendSOAPRequest(method, args);
        var match = responseDict[method].exec(responseXML);
        if (match && match[1]) {
            return match[1];
        }
        throw method +' failed';
    }


    function createIncidentFromAlert(singleAlert) {
        var keys = Object.keys(singleAlert);
        var labels = [];
        for (var i = 0; i < keys.length; i++) {
            labels.push({'type': keys[i], 'value': String(singleAlert[keys[i]])});
        }
        var alertTime = new Date(singleAlert.alertDate);
        return {
                "name": singleAlert.alertType,
                "occurred": alertTime,
                "labels": labels,
                "rawJSON": JSON.stringify(singleAlert).replace(/\\"/g, '"'),
            }
    }

    function fetchIncidents() {
        var lastRun = getLastRun();
        var startTime = lastRun && lastRun.startTime ? lastRun.startTime : 0;
        var maxTime = startTime;
        args.sessionId = sendAndParse('authenticate', {username: username, password: password});
        args.count = 1000;
        var res = JSON.parse(x2j(sendAndParse('alertStatusRetrieve', args)));
        sendAndParse('endSession',args);
        var incidents = [];
        if (res && res.alertStatusRetrieveResponse){
            var alertsDict = res.alertStatusRetrieveResponse.alertStatusRetrieveReturn;
            for (var i in alertsDict) {
                var alertTime = new Date(alertsDict[i].alertDate);
                if (alertTime > startTime) {
                    incidents.push(createIncidentFromAlert(alertsDict[i]));
                    maxTime = Math.max(alertTime, maxTime);
                }
            }
        }
        setLastRun({startTime: maxTime});
        return JSON.stringify(incidents);
    }

    switch (command) {
        case 'test-module':
            if (sendAndParse('authenticate', {username: username, password: password})) {
                return 'ok';
            }
            return 'something is wrong';
        case 'fetch-incidents':
            return fetchIncidents();
        default:
            args.sessionId = sendAndParse('authenticate', {username: username, password: password});
            var res = JSON.parse(x2j(sendAndParse(commandToMethod[command], args)));
            sendAndParse('endSession',args);
            return res;
    }

  type: javascript
  commands:
  - name: trendmicro-host-retrieve-all
    arguments: []
    description: Get all hosts info
  - name: trendmicro-system-event-retrieve
    arguments:
    - name: rangeFrom
      description: Time interval start
    - name: rangeTo
      description: Time interval end
    - name: specificTime
      description: Specific time
    - name: timeFilterType
      auto: PREDEFINED
      predefined:
      - LAST_HOUR
      - LAST_24_HOURS
      - LAST_7_DAYS
      - CUSTOM_RANGE
      - SPECIFIC_TIME
      description: Define time filter mode. mandatory if filtering by time.
    - name: hostGroupID
      description: Filter by host group ID
    - name: hostID
      description: Filter by host ID
    - name: securityProfileID
      description: Filter by host security profile ID
    - name: hostFilterType
      auto: PREDEFINED
      predefined:
      - ALL_HOSTS
      - HOSTS_IN_GROUP
      - HOSTS_USING_SECURITY_PROFILE
      - HOSTS_IN_GROUP_AND_ALL_SUBGROUPS
      - SPECIFIC_HOST
      - MY_HOSTS
      description: Define host filter mode. mandatory if filtering by host/s.
    - name: eventID
      description: filter by event ID
    - name: eventFilterOperator
      auto: PREDEFINED
      predefined:
      - GREATER_THAN
      - LESS_THAN
      - EQUAL
      description: event ID operator
    - name: includeNonHostEvents
      description: Include non-host hevents in filter 
      required: true
      auto: PREDEFINED
      predefined:
      - "false"
      - "true"
    description: Get system events
  - name: trendmicro-host-antimalware-scan
    arguments:
    - name: hostIDs
      required: true
      description: list of host ids to scan, separated by commas
    description: scan computers by host ID list
    execution: true
  - name: trendmicro-alert-status
    arguments:
    - name: count
      required: true
      description: Number of alerts to fetch
    description: Get last alerts
  - name: trendmicro-security-profile-retrieve-all
    arguments: []
    description: Get all security profiles
  - name: trendmicro-security-profile-assign-to-host
    arguments:
    - name: securityProfileID
      required: true
      description: security profile ID that will be assigned to the hosts
    - name: hostIDs
      required: true
      description: list of host IDs, separated by commas
    execution: true
    description: Assign security profile to host
  - name: trendmicro-anti-malware-event-retrieve
    description: Retrive anti malware event
    arguments:
    - name: rangeFrom
      description: Time interval start
    - name: rangeTo
      description: Time interval end
    - name: specificTime
      description: Specific Time
    - name: timeFilterType
      auto: PREDEFINED
      predefined:
      - LAST_HOUR
      - LAST_24_HOURS
      - LAST_7_DAYS
      - CUSTOM_RANGE
      - SPECIFIC_TIME
      description: Define time filter mode. mandatory if filtering by time.
    - name: hostGroupID
      description: Filter by host group ID
    - name: hostID
      description: Filter by host ID
    - name: securityProfileID
      description: Filter by host security profile ID
    - name: hostFilterType
      auto: PREDEFINED
      predefined:
      - ALL_HOSTS
      - HOSTS_IN_GROUP
      - HOSTS_USING_SECURITY_PROFILE
      - HOSTS_IN_GROUP_AND_ALL_SUBGROUPS
      - SPECIFIC_HOST
      - MY_HOSTS
      description: Define host filter mode. mandatory if filtering by host/s.
    - name: eventID
      description: filter by event ID
    - name: eventFilterOperator
      auto: PREDEFINED
      predefined:
      - GREATER_THAN
      - LESS_THAN
      - EQUAL
      description: event ID operator
    description: Get anti malware events
  isfetch: true
