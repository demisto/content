commonfields:
  id: McAfee Active Response
  version: -1
name: McAfee Active Response
display: McAfee Active Response
category: Endpoint
image: data:image/png;base64,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
description: Connect to MAR using its DXL client
detaileddescription: |+
  ### Prerequisites - Connect to McAfee Active Response (MAR) using the DXL MAR client.
   - [Create certificates & configure dxl](https://opendxl.github.io/opendxl-client-python/pydoc/index.html). After this phase you must have:
       * Broker CA certificates ('brokercerts.crt' file)
       * Client certificate ('client.crt' file)
       * Client private key ('client.key' file)
       * Broker list properties file ('brokerlist.properties' file)

   - [Enable MAR Search API](https://opendxl.github.io/opendxl-client-python/pydoc/marsendauth.html)

  ### API Documentation:
  MAR docs - [Here](https://kc.mcafee.com/resources/sites/MCAFEE/content/live/PRODUCT_DOCUMENTATION/26000/PD26820/en_US/mar_200_pg_0-00_en-us.pdf)

  ### Dependencies (Python packages) - No need to install, already installed in docker image :
  dxlclient [docs](https://opendxl.github.io/opendxl-client-python/pydoc/index.html)
  dxlmarclient [docs](https://opendxl.github.io/opendxl-mar-client-python/pydoc/)

configuration:
- display: Broker CA certificates content (see `brokercerts.crt` in instructions)
  name: broker_ca_bundle
  defaultvalue: ""
  type: 12
  required: true
- display: Client certificates content (see `client.crt` in instructions)
  name: cert_file
  defaultvalue: ""
  type: 12
  required: true
- display: Client private key content (see `client.key` in instructions)
  name: private_key
  defaultvalue: ""
  type: 14
  required: true
- display: Brokers urls (comma separated list in the form of - [ssl://]<hostname>[:port])
    - get hostname & port from `brokerlist.properties` file in instructions. Note
    that the broker should be reachable from demisto server
  name: broker_urls
  defaultvalue: ""
  type: 0
  required: true
script:
  script: |
    from dxlclient.client_config import DxlClientConfig
    from dxlclient.client import DxlClient
    from dxlclient.broker import Broker
    from dxlmarclient import MarClient, ResultConstants, ProjectionConstants, ConditionConstants, SortConstants, OperatorConstants
    import json

    broker_ca_bundle = './brokercerts.crt'
    with open(broker_ca_bundle, "w") as text_file:
        text_file.write(demisto.params()['broker_ca_bundle'])

    cert_file = './cert_file.crt'
    with open(cert_file, "w") as text_file:
        text_file.write(demisto.params()['cert_file'])

    private_key = './private_key.key'
    with open(private_key, "w") as text_file:
        text_file.write(demisto.params()['private_key'])

    broker_urls = demisto.params()['broker_urls'].split(',')

    FILTER_OPERATORS = {
        'GreaterEqualThan': OperatorConstants.GREATER_EQUAL_THAN,
        'GreaterThan': OperatorConstants.GREATER_THAN,
        'LessEqualThan': OperatorConstants.LESS_EQUAL_THAN,
        'LessThan': OperatorConstants.LESS_THAN,
        'Equals': OperatorConstants.EQUALS,
        'Contains': OperatorConstants.CONTAINS,
        'StartWith': OperatorConstants.STARTS_WITH,
        'EndsWith': OperatorConstants.ENDS_WITH,
        'Before': OperatorConstants.BEFORE,
        'After': OperatorConstants.AFTER
    }


    MAR_COLLECTORS = {
        'CommandLineHistory': ['user', 'id'], # according to docs also includes 'CommandLine'
        'CurrentFlow': ['local_ip', 'local_port', 'remote_ip', 'remote_port', 'status', 'process_id', 'user', 'user_id', 'proto', 'md5', 'sha1'],
        'DNSCache': ['hostname', 'ipaddress'],
        'EnvironmentVariables': ['username', 'process_id', 'name', 'value'],
        'Files': ['name', 'dir', 'full_name', 'size', 'last_write', 'md5' , 'sha1', 'created_at', 'deleted_at',],
        'HostEntries': ['hostname', 'ipaddress'],
        'HostInfo': ['hostname', 'ip_address', 'os'],
        'InstalledCertificates': ['issued_to', 'issued_by', 'expiration_date', 'purposes', 'purposes_extended', 'friendly_name'],
        'InstalledDrivers': ['displayname', 'description', 'last_modified_date', 'name', 'servicetype', 'startmode', 'state', 'path'],
        'InstalledUpdates': ['description', 'hotfix_id', 'install_date', 'installed_by'],
        'InteractiveSessions': ['userid', 'name'],
        'LocalGroups': ['groupname', 'groupdomain', 'groupdescription', 'islocal', 'sid'],
        'LoggedInUsers': ['id', 'userdomain', 'username'],
        'NetworkFlow': ['src_ip', 'src_port', 'dst_ip', 'dst_port', 'time', 'status', 'process', 'process_id', 'user', 'user_id', 'proto', 'direction', 'ip_class', 'seq_number', 'src_mac', 'dst_mac', 'md5', 'sha1'], # according to docs also includes 'flags'
        'NetworkInterfaces': ['bssid', 'displayname', 'gwipaddress', 'gwmacaddress', 'ipaddress', 'ipprefix', 'macaddress', 'name', 'ssid', 'type', 'wifisecurity'],
        'NetworkSessions': ['computer', 'user', 'client', 'file', 'idletime'],
        'NetworkShares': ['name', 'description', 'path'],
        'Processes': ['name', 'id', 'parentname', 'size', 'md5', 'sha1', 'cmdline', 'imagepath', 'kerneltime', 'usertime', 'uptime', 'user', 'user_id'], # according to docs also includes 'thread_count', 'parentId'
        'ScheduledTasks': ['folder', 'taskname', 'status', 'last_run' ,'username', 'schedule_on'], # according to docs also includes 'nextruntime', 'task_run', 'log_on_type'
        'Services': ['description', 'name', 'startuptype', 'status', 'user'],
        'Software': ['displayname', 'installdate', 'publisher', 'version'],
        'Startup': ['caption', 'command', 'description', 'name', 'user'],
        'UsbConnectedStorageDevices': ['vendor_id', 'product_id', 'serial_number', 'device_type', 'guid', 'last_connection_time', 'user_name', 'last_time_used_by_user'],
        'UserProfiles': ['accountdisabled', 'domain', 'fullname', 'installdate', 'localaccount', 'lockedout', 'accountname', 'sid', 'passwordexpires'],
        'WinRegistry': ['keypath', 'keyvalue', 'valuedata', 'valuetype']
    }

    def create_error_entry(contents):
        return {
            'ContentsFormat': formats['text'],
            'Type': entryTypes['error'],
            'Contents': "Error - " + contents
        }

    def create_entry(header, contents, table, context = {}, headers = None):
        return {
            'ContentsFormat': formats['json'],
            'Type': entryTypes['note'],
            'Contents': contents,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown(header, table, headers) if table else 'No result were found',
            'EntryContext': context
        }

    def translate_dict(d, translator):
        res = {}
        for key, value in d.iteritems():
            new_key = translator.get(key, key)
            res[new_key] = value
        return res

    # translate_list - map each lst dict by translator
    def translate_list(lst, translator):
        return [translate_dict(d, translator) for d in lst]

    def get_client_config():
        config = DxlClientConfig(
            broker_ca_bundle=broker_ca_bundle,
            cert_file=cert_file,
            private_key=private_key,
            brokers=[Broker.parse(url) for url in broker_urls]
        )

        config.connect_retries = 1
        config.reconnect_delay = 1
        config.reconnect_delay_max = 10

        return config


    def test():
        config = get_client_config()
        with DxlClient(config) as client:
            client.connect()
            client.disconnect()
            mar_client = MarClient(client)

    def extract_item_output(item):
        output = item['output']
        res = {
            'created_at': item['created_at']
        }

        # map <CollectorName>|<OutputName> to <OutputName>
        for key, value in output.iteritems():
            splited_key = key.split('|')
            if(len(splited_key) > 1):
                new_key = splited_key[1]
            else:
                new_key = splited_key[0]
            res[new_key] = value or "-"
        return res

    def search_result_to_table(search_result):
        items = search_result['items']
        table = [extract_item_output(item) for item in items]
        return table

    def get_projection(collector, outputs):
        return {
            ProjectionConstants.NAME: collector,
            ProjectionConstants.OUTPUTS: outputs or MAR_COLLECTORS.get(collector)
        }

    def search(collector, outputs, filter_by, filter_operator, filter_value):
        config = get_client_config()
        with DxlClient(config) as client:
            client.connect()
            mar_client = MarClient(client)

            if (not filter_by and not filter_operator and not filter_value):
                result_context = mar_client.search(
                    projections=[{
                        ProjectionConstants.NAME: collector,
                        ProjectionConstants.OUTPUTS: outputs
                    }]
                )
            else:
                if (not filter_by or not filter_operator or not filter_value):
                    raise Exception('you must specify filter-by, filter-operator & filter-value (or specify none of them)')
                else:
                    result_context = mar_client.search(
                        projections=[{
                            ProjectionConstants.NAME: collector,
                            ProjectionConstants.OUTPUTS: outputs
                        }],
                        conditions={ ConditionConstants.OR: [{
                            ConditionConstants.AND: [{
                                ConditionConstants.COND_NAME: collector,
                                ConditionConstants.COND_OUTPUT: filter_by,
                                ConditionConstants.COND_OP: FILTER_OPERATORS[filter_operator],
                                ConditionConstants.COND_VALUE: filter_value
                            }]
                        }]}
                    )

            if result_context.has_results:
                return result_context.get_results()

            return None

    def search_multiple(collectors, filter_collector, filter_by, filter_operator, filter_value):
        config = get_client_config()
        with DxlClient(config) as client:
            client.connect()
            mar_client = MarClient(client)
            if (not filter_collector):
                result_context = mar_client.search(
                    projections=[get_projection(c, None) for c in collectors]
                )
            else:
                if (not filter_by or not filter_operator or not filter_value):
                    raise Exception('you must specify filter-by, filter-operator & filter-value when you provide filter_collector argument')
                else:
                    result_context = mar_client.search(
                        projections=[get_projection(c, None) for c in collectors],
                        conditions={ ConditionConstants.OR: [{
                            ConditionConstants.AND: [{
                                ConditionConstants.COND_NAME: filter_collector,
                                ConditionConstants.COND_OUTPUT: filter_by,
                                ConditionConstants.COND_OP: FILTER_OPERATORS[filter_operator],
                                ConditionConstants.COND_VALUE: filter_value
                            }]
                        }]}
                    )

            if result_context.has_results:
                return result_context.get_results()

            return None

    def search_wrapper(collector, outputs_str, filter_by, filter_operator, filter_value):
        try:
            if outputs_str:
                outputs = outputs_str.split(',')
            else:
                # get all outputs
                outputs = MAR_COLLECTORS.get(collector)

            result = search(collector, outputs, filter_by, filter_operator, filter_value)
        except Exception as ex:
            return create_error_entry(str(ex))

        if not result:
            return 'No items were found'

        table = search_result_to_table(result)
        context = {
            'MAR.' + collector: table
        }
        return create_entry('Search Result For ' + collector, result, table, context)

    def search_multiple_wrapper(collectors, filter_collector, filter_by, filter_operator, filter_value):
        try:
            result = search_multiple(collectors, filter_collector, filter_by, filter_operator, filter_value)
        except Exception as ex:
            return create_error_entry(str(ex))

        if not result:
            return 'No items were found'

        table = search_result_to_table(result)
        context = {
            'MAR.SearchMultiple': table
        }
        return create_entry('Search-Multiple Results', result, table, context)


    def mar_collectors_list():
        collectors_table = [{'Name': c, 'Outputs': ', '.join(MAR_COLLECTORS[c])} for c in MAR_COLLECTORS]
        return create_entry('Collectors', collectors_table, collectors_table, {}, ['Name', 'Outputs'])

    args = demisto.args()
    if demisto.command() == 'test-module':
        test()
        demisto.results('ok')
        sys.exit(0)
    elif demisto.command() == 'mar-search':
        results = search_wrapper(
            args.get('collector'),
            args.get('outputs'),
            args.get('filter-by'),
            args.get('filter-operator'),
            args.get('filter-value')
        )
        demisto.results(results)
        sys.exit(0)
    elif demisto.command() == 'mar-search-multiple':
        results = search_multiple_wrapper(
            args.get('collectors').split(','),
            args.get('filter_collector'),
            args.get('filter-by'),
            args.get('filter-operator'),
            args.get('filter-value')
        )
        demisto.results(results)
        sys.exit(0)
    elif demisto.command() == 'mar-collectors-list':
        results = mar_collectors_list()
        demisto.results(results)
        sys.exit(0)
  type: python
  commands:
  - name: mar-search
    arguments:
    - name: collector
      required: true
      auto: PREDEFINED
      predefined:
      - CommandLineHistory
      - CurrentFlow
      - DNSCache
      - EnvironmentVariables
      - Files
      - HostEntries
      - HostInfo
      - InstalledCertificates
      - InstalledDrivers
      - InstalledUpdates
      - InteractiveSessions
      - LocalGroups
      - LoggedInUsers
      - NetworkFlow
      - NetworkInterfaces
      - NetworkSessions
      - NetworkShares
      - Processes
      - ScheduledTasks
      - Services
      - Software
      - Startup
      - UsbConnectedStorageDevices
      - UserProfiles
      - WinRegistry
      description: The collector to query
    - name: outputs
      description: Comma separated fields (outputs). Run `mar-collectors-list` to view all collectors & fields
        command for all collectors outputs, shows all outputs if not supplied
    - name: filter-by
      description: Field name (output) to filter by (e.g. ip_address).  Run `mar-collectors-list` to view all collectors & fields
        command for all collectors outputs
    - name: filter-operator
      auto: PREDEFINED
      predefined:
      - GreaterEqualThan
      - GreaterThan
      - LessEqualThan
      - LessThan
      - Equals
      - Contains
      - StartsWith
      - EndsWith
      - Before
      - After
      description: Filtering operator
    - name: filter-value
      description: Filtering value of the `filter-by` field
    outputs:
    - contextPath: MAR
      description: MAR Results in given collector(e.g. 'MAR.HostInfo`
    - contextPath: MAR
      description: Search results in collector field (e.g. 'MAR.NetworkInterfaces')
    description: Search endpoint data
  - name: mar-collectors-list
    arguments: []
    description: Returns a list of all collectors and their outputs
  - name: mar-search-multiple
    arguments:
    - name: collectors
      required: true
      default: true
      auto: PREDEFINED
      predefined:
      - CommandLineHistory
      - CurrentFlow
      - DNSCache
      - EnvironmentVariables
      - Files
      - HostEntries
      - HostInfo
      - InstalledCertificates
      - InstalledDrivers
      - InstalledUpdates
      - InteractiveSessions
      - LocalGroups
      - LoggedInUsers
      - NetworkFlow
      - NetworkInterfaces
      - NetworkSessions
      - NetworkShares
      - Processes
      - ScheduledTasks
      - Services
      - Software
      - Startup
      - UsbConnectedStorageDevices
      - UserProfiles
      - WinRegistry
      description: The collectors to query
      isArray: true
    - name: filter_collector
      auto: PREDEFINED
      predefined:
      - CommandLineHistory
      - CurrentFlow
      - DNSCache
      - EnvironmentVariables
      - Files
      - HostEntries
      - HostInfo
      - InstalledCertificates
      - InstalledDrivers
      - InstalledUpdates
      - InteractiveSessions
      - LocalGroups
      - LoggedInUsers
      - NetworkFlow
      - NetworkInterfaces
      - NetworkSessions
      - NetworkShares
      - Processes
      - ScheduledTasks
      - Services
      - Software
      - Startup
      - UsbConnectedStorageDevices
      - UserProfiles
      - WinRegistry
      description: The collector to filter by (e.g. HostInfo)
    - name: filter-by
      description: Field name (output) of `filter_collector` to filter by (e.g. ip_address)
        . Run `mar-collectors-list` to view all collectors & fields
    - name: filter-operator
      auto: PREDEFINED
      predefined:
      - GreaterEqualThan
      - GreaterThan
      - LessEqualThan
      - LessThan
      - Equals
      - Contains
      - StartsWith
      - EndsWith
      - Before
      - After
      description: Filtering operatior
    - name: filter-value
      description: Filtering value of the `filter-by` field
    outputs:
    - contextPath: Mar.SearchMultiple
      description: The result of the search query
    description: Search endpoint data crossed by multiple collectors
  dockerimage: demisto/dxl
