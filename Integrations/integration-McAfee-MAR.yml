commonfields:
  id: McAfee Active Response
  version: -1
name: McAfee Active Response
display: McAfee Active Response
category: Endpoint
image: data:image/png;base64,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
description: Connect to MAR using its DXL client
detaileddescription: |+
  ### Prerequisites - Connect to McAfee Active Response (MAR) using the DXL MAR client.
   - [Create certificates & configure dxl](https://opendxl.github.io/opendxl-client-python/pydoc/index.html). After this phase you must have:
       * Broker CA certificates ('brokercerts.crt' file)
       * Client certificate ('client.crt' file)
       * Client private key ('client.key' file)
       * Broker list properties file ('brokerlist.properties' file)

   - [Enable MAR Search API](https://opendxl.github.io/opendxl-client-python/pydoc/marsendauth.html)

  ### API Documentation:
  MAR docs - [Here](https://kc.mcafee.com/resources/sites/MCAFEE/content/live/PRODUCT_DOCUMENTATION/26000/PD26820/en_US/mar_200_pg_0-00_en-us.pdf)

  ### Dependencies (Python packages) - No need to install, already installed in docker image :
  dxlclient [docs](https://opendxl.github.io/opendxl-client-python/pydoc/index.html)
  dxlmarclient [docs](https://opendxl.github.io/opendxl-mar-client-python/pydoc/)

configuration:
- display: Broker CA certificates content (see `brokercerts.crt` in instructions)
  name: broker_ca_bundle
  defaultvalue: ""
  type: 12
  required: true
- display: Client certificates content (see `client.crt` in instructions)
  name: cert_file
  defaultvalue: ""
  type: 12
  required: true
- display: Client private key content (see `client.key` in instructions)
  name: private_key
  defaultvalue: ""
  type: 14
  required: true
- display: Brokers urls (comma separated list in the form of - [ssl://]<hostname>[:port])
    - get hostname & port from `brokerlist.properties` file in instructions. Note
    that the broker should be reachable from demisto server
  name: broker_urls
  defaultvalue: ""
  type: 0
  required: true
script:
  script: |
    from dxlclient.client_config import DxlClientConfig
    from dxlclient.client import DxlClient
    from dxlclient.broker import Broker
    from dxlmarclient import MarClient, ResultConstants, ProjectionConstants, ConditionConstants, SortConstants, OperatorConstants
    import json

    broker_ca_bundle = './brokercerts.crt'
    with open(broker_ca_bundle, "w") as text_file:
        text_file.write(demisto.params()['broker_ca_bundle'])

    cert_file = './cert_file.crt'
    with open(cert_file, "w") as text_file:
        text_file.write(demisto.params()['cert_file'])

    private_key = './private_key.key'
    with open(private_key, "w") as text_file:
        text_file.write(demisto.params()['private_key'])

    broker_urls = demisto.params()['broker_urls'].split(',')

    FILTER_OPERATORS = {
        'GreaterEqualThan': OperatorConstants.GREATER_EQUAL_THAN,
        'GreaterThan': OperatorConstants.GREATER_THAN,
        'LessEqualThan': OperatorConstants.LESS_EQUAL_THAN,
        'LessThan': OperatorConstants.LESS_THAN,
        'Equals': OperatorConstants.EQUALS,
        'Contains': OperatorConstants.CONTAINS,
        'StartWith': OperatorConstants.STARTS_WITH,
        'EndsWith': OperatorConstants.ENDS_WITH,
        'Before': OperatorConstants.BEFORE,
        'After': OperatorConstants.AFTER
    }


    MAR_COLLECTORS = {
        'CommandLineHistory': ['user', 'id'], # according to docs also includes 'CommandLine'
        'CurrentFlow': ['local_ip', 'local_port', 'remote_ip', 'remote_port', 'status', 'process_id', 'user', 'user_id', 'proto', 'md5', 'sha1'],
        'DNSCache': ['hostname', 'ipaddress'],
        'EnvironmentVariables': ['username', 'process_id', 'name', 'value'],
        'Files': ['name', 'dir', 'full_name', 'size', 'last_write', 'md5' , 'sha1', 'created_at', 'deleted_at',],
        'HostEntries': ['hostname', 'ipaddress'],
        'HostInfo': ['hostname', 'ip_address', 'os'],
        'InstalledCertificates': ['issued_to', 'issued_by', 'expiration_date', 'purposes', 'purposes_extended', 'friendly_name'],
        'InstalledDrivers': ['displayname', 'description', 'last_modified_date', 'name', 'servicetype', 'startmode', 'state', 'path'],
        'InstalledUpdates': ['description', 'hotfix_id', 'install_date', 'installed_by'],
        'InteractiveSessions': ['userid', 'name'],
        'LocalGroups': ['groupname', 'groupdomain', 'groupdescription', 'islocal', 'sid'],
        'LoggedInUsers': ['id', 'userdomain', 'username'],
        'NetworkFlow': ['src_ip', 'src_port', 'dst_ip', 'dst_port', 'time', 'status', 'process', 'process_id', 'user', 'user_id', 'proto', 'direction', 'ip_class', 'seq_number', 'src_mac', 'dst_mac', 'md5', 'sha1'], # according to docs also includes 'flags'
        'NetworkInterfaces': ['bssid', 'displayname', 'gwipaddress', 'gwmacaddress', 'ipaddress', 'ipprefix', 'macaddress', 'name', 'ssid', 'type', 'wifisecurity'],
        'NetworkSessions': ['computer', 'user', 'client', 'file', 'idletime'],
        'NetworkShares': ['name', 'description', 'path'],
        'Processes': ['name', 'id', 'parentname', 'size', 'md5', 'sha1', 'cmdline', 'imagepath', 'kerneltime', 'usertime', 'uptime', 'user', 'user_id'], # according to docs also includes 'thread_count', 'parentId'
        'ScheduledTasks': ['folder', 'taskname', 'status', 'last_run' ,'username', 'schedule_on'], # according to docs also includes 'nextruntime', 'task_run', 'log_on_type'
        'Services': ['description', 'name', 'startuptype', 'status', 'user'],
        'Software': ['displayname', 'installdate', 'publisher', 'version'],
        'Startup': ['caption', 'command', 'description', 'name', 'user'],
        'UsbConnectedStorageDevices': ['vendor_id', 'product_id', 'serial_number', 'device_type', 'guid', 'last_connection_time', 'user_name', 'last_time_used_by_user'],
        'UserProfiles': ['accountdisabled', 'domain', 'fullname', 'installdate', 'localaccount', 'lockedout', 'accountname', 'sid', 'passwordexpires'],
        'WinRegistry': ['keypath', 'keyvalue', 'valuedata', 'valuetype']
    }

    def create_error_entry(contents):
        return {
            'ContentsFormat': formats['text'],
            'Type': entryTypes['error'],
            'Contents': "Error - " + contents
        }

    def create_entry(header, contents, table, context = {}, headers = None):
        return {
            'ContentsFormat': formats['json'],
            'Type': entryTypes['note'],
            'Contents': contents,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown(header, table, headers) if table else 'No result were found',
            'EntryContext': context
        }

    def translate_dict(d, translator):
        res = {}
        for key, value in d.iteritems():
            new_key = translator.get(key, key)
            res[new_key] = value
        return res

    # translate_list - map each lst dict by translator
    def translate_list(lst, translator):
        return [translate_dict(d, translator) for d in lst]

    def get_client_config():
        config = DxlClientConfig(
            broker_ca_bundle=broker_ca_bundle,
            cert_file=cert_file,
            private_key=private_key,
            brokers=[Broker.parse(url) for url in broker_urls]
        )

        config.connect_retries = 1
        config.reconnect_delay = 1
        config.reconnect_delay_max = 10

        return config


    def test():
        config = get_client_config()
        with DxlClient(config) as client:
            client.connect()
            client.disconnect()
            mar_client = MarClient(client)

    def extract_item_output(item):
        output = item['output']
        res = {
            'created_at': item['created_at']
        }

        # map <CollectorName>|<OutputName> to <OutputName>
        for key, value in output.iteritems():
            splited_key = key.split('|')
            if(len(splited_key) > 1):
                new_key = splited_key[1]
            else:
                new_key = splited_key[0]
            res[new_key] = value or "-"
        return res

    def search_result_to_table(search_result):
        items = search_result['items']
        table = [extract_item_output(item) for item in items]
        return table

    def get_projection(collector, outputs):
        return {
            ProjectionConstants.NAME: collector,
            ProjectionConstants.OUTPUTS: outputs or MAR_COLLECTORS.get(collector)
        }

    def search(collector, projection_collector, outputs, filter_by, filter_operator, filter_value):
        config = get_client_config()
        with DxlClient(config) as client:
            client.connect()
            mar_client = MarClient(client)

            if (not filter_by and not filter_operator and not filter_value):
                result_context = mar_client.search(
                    projections=[{
                        ProjectionConstants.NAME: collector,
                        ProjectionConstants.OUTPUTS: outputs
                    }]
                )
            else:
                if (not filter_by or not filter_operator or not filter_value):
                    raise Exception('you must specify filter-by, filter-operator & filter-value (or specify none of them)')
                else:
                    result_context = mar_client.search(
                         projections=[{
                            ProjectionConstants.NAME: projection_collector,
                            ProjectionConstants.OUTPUTS: outputs
                        }],
                        conditions={ ConditionConstants.OR: [{
                            ConditionConstants.AND: [{
                                ConditionConstants.COND_NAME: collector,
                                ConditionConstants.COND_OUTPUT: filter_by,
                                ConditionConstants.COND_OP: FILTER_OPERATORS[filter_operator],
                                ConditionConstants.COND_VALUE: filter_value
                            }]
                        }]}
                    )

            if result_context.has_results:
                return result_context.get_results()

            return None

    def search_multiple(collectors, filter_collector, filter_by, filter_operator, filter_value):
        config = get_client_config()
        with DxlClient(config) as client:
            client.connect()
            mar_client = MarClient(client)
            if (not filter_collector):
                result_context = mar_client.search(
                    projections=[get_projection(c, None) for c in collectors]
                )
            else:
                if (not filter_by or not filter_operator or not filter_value):
                    raise Exception('you must specify filter-by, filter-operator & filter-value when you provide filter_collector argument')
                else:
                    result_context = mar_client.search(
                        projections=[get_projection(c, None) for c in collectors],
                        conditions={ ConditionConstants.OR: [{
                            ConditionConstants.AND: [{
                                ConditionConstants.COND_NAME: filter_collector,
                                ConditionConstants.COND_OUTPUT: filter_by,
                                ConditionConstants.COND_OP: FILTER_OPERATORS[filter_operator],
                                ConditionConstants.COND_VALUE: filter_value
                            }]
                        }]}
                    )

            if result_context.has_results:
                return result_context.get_results()

            return None

    def search_wrapper(collector, projection_collector, outputs_str, filter_by, filter_operator, filter_value):
        try:
            if outputs_str:
                outputs = outputs_str.split(',')
            else:
                # get all outputs
                outputs = MAR_COLLECTORS.get(collector)

            result = search(collector, projection_collector, outputs, filter_by, filter_operator, filter_value)
        except Exception as ex:
            return create_error_entry(str(ex))

        if not result:
            return 'No items were found'

        table = search_result_to_table(result)
        context = {
            'MAR.' + collector: table
        }
        return create_entry('Search Result For ' + collector, result, table, context)

    def search_multiple_wrapper(collectors, filter_collector, filter_by, filter_operator, filter_value):
        try:
            result = search_multiple(collectors, filter_collector, filter_by, filter_operator, filter_value)
        except Exception as ex:
            return create_error_entry(str(ex))

        if not result:
            return 'No items were found'

        table = search_result_to_table(result)
        context = {
            'MAR.SearchMultiple': table
        }
        return create_entry('Search-Multiple Results', result, table, context)


    def mar_collectors_list():
        collectors_table = [{'Name': c, 'Outputs': ', '.join(MAR_COLLECTORS[c])} for c in MAR_COLLECTORS]
        return create_entry('Collectors', collectors_table, collectors_table, {}, ['Name', 'Outputs'])

    args = demisto.args()
    if demisto.command() == 'test-module':
        test()
        demisto.results('ok')
        sys.exit(0)
    elif demisto.command() == 'mar-search':
        results = search_wrapper(
            args.get('collector'),
            args.get('projection-collector', args.get('collector')),
            args.get('outputs'),
            args.get('filter-by'),
            args.get('filter-operator'),
            args.get('filter-value')
        )
        demisto.results(results)
        sys.exit(0)
    elif demisto.command() == 'mar-search-multiple':
        results = search_multiple_wrapper(
            args.get('collectors').split(','),
            args.get('filter_collector'),
            args.get('filter-by'),
            args.get('filter-operator'),
            args.get('filter-value')
        )
        demisto.results(results)
        sys.exit(0)
    elif demisto.command() == 'mar-collectors-list':
        results = mar_collectors_list()
        demisto.results(results)
        sys.exit(0)
  type: python
  commands:
  - name: mar-search
    arguments:
    - name: collector
      required: true
      auto: PREDEFINED
      predefined:
      - CommandLineHistory
      - CurrentFlow
      - DNSCache
      - EnvironmentVariables
      - Files
      - HostEntries
      - HostInfo
      - InstalledCertificates
      - InstalledDrivers
      - InstalledUpdates
      - InteractiveSessions
      - LocalGroups
      - LoggedInUsers
      - NetworkFlow
      - NetworkInterfaces
      - NetworkSessions
      - NetworkShares
      - Processes
      - ScheduledTasks
      - Services
      - Software
      - Startup
      - UsbConnectedStorageDevices
      - UserProfiles
      - WinRegistry
      description: The collector to query
    - name: prejection-collector
      auto: PREDEFINED
      predefined:
      - CommandLineHistory
      - CurrentFlow
      - DNSCache
      - EnvironmentVariables
      - Files
      - HostEntries
      - HostInfo
      - InstalledCertificates
      - InstalledDrivers
      - InstalledUpdates
      - InteractiveSessions
      - LocalGroups
      - LoggedInUsers
      - NetworkFlow
      - NetworkInterfaces
      - NetworkSessions
      - NetworkShares
      - Processes
      - ScheduledTasks
      - Services
      - Software
      - Startup
      - UsbConnectedStorageDevices
      - UserProfiles
      - WinRegistry
      description: Projection collector that we want to return. By default prejection collector will be equal to the collector
    - name: outputs
      description: Comma separated fields (outputs). Run `mar-collectors-list` to
        view all collectors & fields command for all collectors outputs, shows all
        outputs if not supplied
    - name: filter-by
      description: Field name (output) to filter by (e.g. ip_address).  Run `mar-collectors-list`
        to view all collectors & fields command for all collectors outputs
    - name: filter-operator
      auto: PREDEFINED
      predefined:
      - GreaterEqualThan
      - GreaterThan
      - LessEqualThan
      - LessThan
      - Equals
      - Contains
      - StartsWith
      - EndsWith
      - Before
      - After
      description: Filtering operator
    - name: filter-value
      description: Filtering value of the `filter-by` field
    outputs:
    - contextPath: MAR
      description: MAR Results in given collector(e.g. 'MAR.HostInfo`
    - contextPath: MAR
      description: Search results in collector field (e.g. 'MAR.NetworkInterfaces')
    description: Search endpoint data
  - name: mar-collectors-list
    arguments: []
    description: Returns a list of all collectors and their outputs
  - name: mar-search-multiple
    arguments:
    - name: collectors
      required: true
      default: true
      auto: PREDEFINED
      predefined:
      - CommandLineHistory
      - CurrentFlow
      - DNSCache
      - EnvironmentVariables
      - Files
      - HostEntries
      - HostInfo
      - InstalledCertificates
      - InstalledDrivers
      - InstalledUpdates
      - InteractiveSessions
      - LocalGroups
      - LoggedInUsers
      - NetworkFlow
      - NetworkInterfaces
      - NetworkSessions
      - NetworkShares
      - Processes
      - ScheduledTasks
      - Services
      - Software
      - Startup
      - UsbConnectedStorageDevices
      - UserProfiles
      - WinRegistry
      description: The collectors to query
      isArray: true
    - name: filter_collector
      auto: PREDEFINED
      predefined:
      - CommandLineHistory
      - CurrentFlow
      - DNSCache
      - EnvironmentVariables
      - Files
      - HostEntries
      - HostInfo
      - InstalledCertificates
      - InstalledDrivers
      - InstalledUpdates
      - InteractiveSessions
      - LocalGroups
      - LoggedInUsers
      - NetworkFlow
      - NetworkInterfaces
      - NetworkSessions
      - NetworkShares
      - Processes
      - ScheduledTasks
      - Services
      - Software
      - Startup
      - UsbConnectedStorageDevices
      - UserProfiles
      - WinRegistry
      description: The collector to filter by (e.g. HostInfo)
    - name: filter-by
      description: Field name (output) of `filter_collector` to filter by (e.g. ip_address)
        . Run `mar-collectors-list` to view all collectors & fields
    - name: filter-operator
      auto: PREDEFINED
      predefined:
      - GreaterEqualThan
      - GreaterThan
      - LessEqualThan
      - LessThan
      - Equals
      - Contains
      - StartsWith
      - EndsWith
      - Before
      - After
      description: Filtering operatior
    - name: filter-value
      description: Filtering value of the `filter-by` field
    outputs:
    - contextPath: Mar.SearchMultiple
      description: The result of the search query
    description: Search endpoint data crossed by multiple collectors
  dockerimage: demisto/dxl
  runonce: false
releaseNotes: support projection collector