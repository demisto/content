commonfields:
  id: SumoLogic
  version: -1
name: SumoLogic
display: SumoLogic
category: Analytics & SIEM
image: data:image/png;base64,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
description: Cloud-based service for logs & metrics management
detaileddescription: |-
  Follow this guide to generate access keys: [https://help.sumologic.com/Manage/Security/Access_Keys](https://help.sumologic.com/Manage/Security/Access_Keys).
  For the URL argument, take a look here: [https://help.sumologic.com/APIs/01Collector_Management_API/Sumo_Logic_Endpoints](https://help.sumologic.com/APIs/01Collector_Management_API/Sumo_Logic_Endpoints)
configuration:
- display: SumoLogic URL, in the format https://api.us2.sumologic.com/api/. This is
    region specific.
  name: url
  defaultvalue: https://api.us2.sumologic.com/api/
  type: 0
  required: true
- display: API Version
  name: apiVersion
  defaultvalue: v1
  type: 0
  required: true
- display: The access ID - can be created under "Settings"
  name: accessID
  defaultvalue: ""
  type: 0
  required: true
- display: The access key - can be created under "Settings"
  name: accessKey
  defaultvalue: ""
  type: 4
  required: true
- display: Use system proxy settings
  name: useproxy
  defaultvalue: "true"
  type: 8
  required: false
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: Seconds to sleep between checking for results
  name: sleepBetweenChecks
  defaultvalue: "3"
  type: 0
  required: true
- display: Default limit for the number of records to retrieve
  name: limit
  defaultvalue: "100"
  type: 0
  required: true
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Run this query to fetch new events as incidents
  name: fetchQuery
  defaultvalue: ""
  type: 0
  required: false
- display: Default max total wait for results
  name: maxTimeout
  defaultvalue: "600"
  type: 0
  required: false
script:
  script: |
    var server = params.url.replace(/[\/]+$/, '') + '/' + params.apiVersion + '/';

    var doReq = function(method, path, parameters, cookies) {
        var result = http(
            server + path + (method === 'GET' && parameters ? encodeToURLQuery(parameters) : ''),
            {
                Headers: {'Content-Type': ['application/json'], 'Accept': ['application/json']},
                Method: method,
                Body: method == 'POST' && parameters ? JSON.stringify(parameters) : '',
                Username: params.accessID,
                Password: params.accessKey,
                Cookies: cookies
            },
            params.insecure,
            params.useproxy
        );

        if (result.StatusCode < 200 || result.StatusCode > 299) {
            var errObj;
            try {
                errObj = JSON.parse(result.Body);
            } catch (ex) {
                // Ignore this - we will just throw the status code back
            }
            if (errObj) {
                throw 'Status: ' + result.StatusCode + '\nID: ' + errObj.id + '\nCode: ' + errObj.code + '\nMessage: ' + errObj.message;
            }
            throw 'Failed to perform request ' + path + ', request status code: ' + result.StatusCode;
        }
        if (result.Body === '') {
            throw 'No content received.';
        }
        var obj;
        try {
            obj = JSON.parse(result.Body);
        } catch (ex) {
            throw 'Error parsing reply - ' + result.Body + ' - ' + ex;
        }
        return {body: result.Body, obj: obj, statusCode: result.StatusCode, cookies: result.Cookies};
    };

    var search = function(query, from, to, limit, offset, timezone, maxTimeToWaitForResults, sleep) {
        var p = {query: query};
        if (from) {
            p.from = from;
        }
        if (to) {
            p.to = to;
        }
        if (timezone) {
            p.timeZone = timezone;
        }
        // Create the job
        var res = doReq('POST', 'search/jobs', p, null);
        try {
            var done = false;
            var stat;
            // Wait for results based on parameters
            for (var i=0; i<maxTimeToWaitForResults / sleep; i++) {
                wait(sleep);
                stat = doReq('GET', 'search/jobs/' + res.obj.id, null, res.cookies);
                if (stat.obj.state === 'DONE GATHERING RESULTS' || stat.obj.messageCount > (offset + 1) * limit) {
                    done = true;
                    break;
                }
                if (stat.obj.state === 'CANCELLED') {
                    throw 'Job ' + res.obj.id + ' was cancelled';
                }
            }
            if (done) {
                var results = {};
                if (stat.obj.messageCount > 0) {
                    var msg = doReq('GET', 'search/jobs/' + res.obj.id + '/messages', {offset: offset, limit: limit}, res.cookies);
                    results.messages = msg.obj.messages.map(function(m) {return m.map;});
                }
                if (stat.obj.recordCount > 0) {
                    var rec = doReq('GET', 'search/jobs/' + res.obj.id + '/records', {offset: offset, limit: limit}, res.cookies);
                    results.records = rec.obj.records.map(function(m) {return m.map;});
                }
                return results;
            }
            throw 'Timeout while waiting for job ' + res.obj.id;
        } finally {
            try {
                doReq('DELETE', 'search/jobs/' + res.obj.id, null, res.cookies);
            } catch (ex) {
                logInfo('SumoLogic error deleting job - ' + ex);
            }
        }
    };

    var a2i = function(v, d) {
        return v ? parseInt(v) : d;
    };

    var defaultLimit = 100, defaultSleep = 3, defaultTimeout = 180, defaultSearchTimeout = 10;

    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            doReq('GET', 'collectors', {limit: '1'}, null);
            return 'ok';
        case 'fetch-incidents':
            if (!params.fetchQuery) {
                throw 'No fetch query defined, not doing SumoLogic fetch';
            }
            var now = (new Date()).getTime();
            var lastRun = getLastRun();
            if (!lastRun || !lastRun.time) {
                // First time, retrieve events from the last 10 min
                lastRun = {time: now - 10 * 60 * 1000};
            }
            var s = search(params.fetchQuery, lastRun.time, now, a2i(params.limit, defaultLimit), 0, 'UTC', a2i(params.maxTimeout, 180),
                a2i(params.sleepBetweenChecks, defaultSleep));
            var incidents = [];
            if (s.messages) {
                for (var i=0; i<s.messages.length; i++) {
                    var incident = {name: 'Incident from SumoLogic ' + s.messages[i]._messageid,
                        details: s.messages[i]._raw, labels: [], rawJSON: JSON.stringify(s.messages[i])};
                    var props = Object.getOwnPropertyNames(s.messages[i]);
                    for (var j=0; j<props.length; j++) {
                        if (props[j] !== '_raw') {
                            incident.labels.push({type: props[j], value: s.messages[i][props[j]]});
                        }
                    }
                    incidents.push(incident);
                }
            }
            setLastRun({time: now});
            return JSON.stringify(incidents);
        case 'search':
            query = args.query
            var httpIndex = query.indexOf('http')
            if (httpIndex != -1) {
                var httpSubstring = query.substring(httpIndex)
                var whitespaceIndex = httpSubstring.indexOf(' ')
                var url = httpSubstring.substring(0, whitespaceIndex)
                url = url.replace(/=/g, '\\\\=')
                var beforeHttp = query.substring(0, httpIndex)
                var afterWhitespace = query.substring(httpIndex + whitespaceIndex)
                query = beforeHttp + url + afterWhitespace
            }
            var headers = 'headers' in args ? argToList(args.headers) : undefined;
            var s = search(query, args.from, args.to, a2i(args.limit, defaultLimit), a2i(args.offset, 0), args.timezone,
                a2i(args.maxTimeToWaitForResults, defaultSearchTimeout) * 60, a2i(params.sleepBetweenChecks, defaultSleep));
            var md = '';
            var ec = {};
            if (s.messages && s.messages.length > 0) {
                md = tableToMarkdown('SumoLogic Search Messages', s.messages, headers) + '\n';
                ec.Search = {Messages: s.messages.length > defaultLimit ? s.messages.slice(0, defaultLimit) : s.messages};
            }
            if (s.records && s.records.length > 0) {
                md += tableToMarkdown('SumoLogic Search Records', s.records, headers);
                ec.Search = {Records: s.records.length > defaultLimit ? s.records.slice(0, defaultLimit) : s.records};
            }
            if (!md) {
                md = 'No results found';
            }
            return {Type: entryTypes.note, Contents: s, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
        default:
            return {Type: entryTypes.error, Contents: 'Unknown command - ' + command, ContentsFormat: formats.text};
    }
  type: javascript
  commands:
  - name: search
    arguments:
    - name: query
      required: true
      default: true
      description: The search query to execute
    - name: from
      required: true
      description: The ISO 8601 date of the time range to start the search (example
        - 2016-08-28T12:00:00). Can also be milliseconds since epoch.
    - name: to
      required: true
      description: The ISO 8601 date of the time range to end the search (example
        - 2016-08-28T12:00:00). Can also be milliseconds since epoch.
    - name: limit
      description: Max results returned from query, int - by default will be 100
      defaultValue: "100"
    - name: offset
      description: Return results starting at this offset. should be int - by default
        is 0
      defaultValue: "0"
    - name: timezone
      description: The time zone if from/to is not in milliseconds, default is UTC,  See
        this (https://en.wikipedia.org/wiki/List_of_tz_database_time_zones) article
        for a list of time zone codes.
      defaultValue: UTC
    - name: maxTimeToWaitForResults
      description: Max amount of minutes to wait for search to end, default is 10
        minutes
      defaultValue: "10"
    - name: headers
      description: Table's headers to be shown by order given as comma-separated values,
        e.g. _blockid,_collector,_format
    outputs:
    - contextPath: Search.Messages
      description: The array of raw message objects
    - contextPath: Search.Records
      description: The array of aggregate records
    description: Search SumoLogic for matching records to the given query
  isfetch: true
tests:
  - No test
