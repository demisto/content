commonfields:
  id: Lastline
  version: -1
name: Lastline
display: Lastline Analyst
category: Data Enrichment
image: data:image/png;base64,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
description: Provides threat analysts and incident response teams with the advanced malware isolation and inspection environment, needed to safely execute advanced malware samples and understand their behavior.
configuration:
- display: Server URL (e.g. https://analysis.lastline.com)
  name: url
  defaultvalue: https://analysis.lastline.com
  type: 0
  required: true
- display: API Key for accessing Lastline APIs
  name: api_key
  defaultvalue: ""
  type: 0
  required: true
- display: API Token for accessing Lastline APIs
  name: api_token
  defaultvalue: ""
  type: 4
  required: true
- display: Use system proxy settings
  name: proxy
  defaultvalue: "True"
  type: 8
  required: false
script:
  script: |+
    var lastlineDefaults = {interval:10, timeout:0, threshold:50, pushToPortal:true};

    var serverUrl = params.url;
    if (serverUrl[serverUrl.length - 1] !== '/') {
        serverUrl += '/';
    }

    // print data report as markdown
    var dataToMd = function(data,threshold) {
        var key;
        var name;
        if ('url' in data.analysis_subject) {
            key='URL';
            name = data.analysis_subject.url;
        } else {
            key='file';
            name = 'MD5:'+data.analysis_subject.md5;
        }
        var md = '';
        if (data.score>=threshold) {
            name = name+ ' :red_circle:';
        }
        md += '### Lastline analysis for ' + key + ': **' + name +'**\n';

        md += '#### Score: ' + data.score  + "\n";
        md += 'Task UUID: ' + data.task_uuid + "\n";
        md += 'Submission Time: ' + data.submission + "\n";
        if (Array.isArray(data.malicious_activity) && data.malicious_activity.length>0) {
            md += '### Suspicious Activity\n';
            md += objToMd(data.malicious_activity) + "\n";
        }
        if (key == 'file') {
            md += objToMd(data.analysis_subject);
        }
        md += "\n";
        return md;
    }

    // send http post request
    var doReq = function(method, path, parameters, body) {
        if (!parameters) {
            parameters = {};
        }
        parameters.key = params.api_key;
        parameters.api_token=params.api_token;

        var result = http(
            serverUrl + path + encodeToURLQuery(parameters),
            {
                Headers: {'Content-Type': ['application/json']},
                Method: method
            },
            false,
            params.proxy
        );
        if (result.StatusCode < 200 && result.StatusCode > 299) {
            throw 'Failed to perform request ' + path + ', request status code: ' + result.StatusCode;
        }

        var obj;
        try {
            obj = JSON.parse(result.Body);
        } catch (ex) {
            throw 'Error parsing reply - ' + result.Body + ' - ' + ex;
        }

        // analysis is not ready yet
        if (obj.error_code && obj.error_code == 106) {
            return {body: null, obj: {data:null}};
        }
        if (obj.success==0) {
            throw 'Error from Lastline: ' + obj.error;
        }
        if (obj.error_code) {
            switch (obj.error_code) {
                case 101:
                    // file hash does not exist
                    break;
                case 106:
                    // analysis report not ready
                    break;
                default:
                    throw 'Error from Lastline. Error code: ' + obj.error_code + ". Error: " + obj.error;
            }
        }

        return {body: result.Body, obj: obj};
    }

    // send http multipart request (post file)
    var doFile = function (entry_id,parameters) {
        if (!parameters) {
            parameters = {};
        }
        parameters.key = params.api_key;
        parameters.api_token=params.api_token;
        var path = 'analysis/submit/file';

        var result = httpMultipart(
            serverUrl + path + encodeToURLQuery(parameters),
            entry_id,
            {
                Method: 'POST',
                Headers: {'Content-Type': ['application/json']}
            },
            {},
            false,
            params.proxy
        );
        if (result.StatusCode < 200 && result.StatusCode > 299) {
            throw 'Failed to perform request ' + path + ', request status code: ' + result.StatusCode;
        }
        var obj;
        try {
            obj = JSON.parse(result.Body);
        } catch (ex) {
            throw 'Error parsing reply - ' + result.Body + ' - ' + ex;
        }

        if (obj.error_code) {
            switch (obj.error_code) {
                case 101:
                    // file hash does not exist
                    break;
                case 106:
                    // analysis report not ready
                    break;
                default:
                    throw 'Error code: ' + obj.error_code + ". Error: " + obj.error;
            }
        }
        return {body: result.Body, obj: obj};

    }

    // poll for analysis report
    var analysisPoll = function(uuid,threshold,timeout,interval) {
        if (!timeout) {
            timeout = lastlineDefaults.timeout;
        }
        if (!interval) {
            interval = lastlineDefaults.interval;
        }
        if (!threshold) {
            threshold = lastlineDefaults.threshold;
        }
        var result = doReq('POST', '/analysis/get', {uuid: uuid, full_report_score:threshold});

        var waited=0;
        while (!analysisReady(result.obj.data) && parseInt(timeout)>waited) {
            wait(parseInt(interval));
            waited+=interval;
            result = doReq('POST', 'analysis/get', {uuid: uuid, full_report_score:threshold});
        }
        return result;
    }

    // check if report is ready based on data content (score field is set)
    var analysisReady = function (data) {
        return (data && 'score' in data);
    }

    // submit file for analysis
    // optional - wait for analysis to copmplete and print results
    // if not waiting - add uuid to context
    var fileSubmit = function (file_id,threshold,timeout,interval,pushToPortal) {
        if (!timeout) {
            timeout = lastlineDefaults.timeout;
        }
        if (!interval) {
            interval = lastlineDefaults.interval;
        }
        if (!threshold) {
            threshold = lastlineDefaults.threshold;
        }
        if (!pushToPortal) {
            pushToPortal = lastlineDefaults.pushToPortal;
        }
        result = doFile(file_id,{full_report_score:threshold, push_to_portal:pushToPortal});

        var uuid = result.obj.data.task_uuid;

        var ec = {};
        var md = '';

        if (!analysisReady(result.obj.data) && timeout > 0) {
            result = analysisPoll(uuid,timeout,interval);
        }

        var dbotScore = {indicator: analysis.md5, type: 'hash', vendor: 'Lastline', score:0};
        if (analysisReady(result.obj.data)) {
            md=dataToMd(result.obj.data,threshold);
            if (result.obj.data.score > threshold) {
                var analysis = result.obj.data.analysis_subject;
                ec['File/Malicious']={MD5:analysis.md5,SHA1:analysis.sha1,SHA256:analysis.sha256,Score:result.obj.data.score};
                dbotScore.score=3;
            } else {
                dbotScore.score=1;
            }
        } else {
            ec.lastlineTasks=[{'file_id':file_id,'uuid':uuid}];
            md += '### Lastline analysis for file: **' + file_id +'**\n';
            md += 'File submitted for analysis.\n';
            md += 'Task UUID: ' + uuid + '\n';
        }
        ec['dbotScore']=dbotScore;
        return {Type: entryTypes.note, Contents: result.obj, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
    }

    // submit URL for analysis and get its report
    // if analysis exists - return it immediately.
    // if analysis does not exist - submit it and either wait or put task id into context
    var urlGetSubmit = function (url,threshold,timeout,interval, pushToPortal) {
        if (!timeout) {
            timeout = lastlineDefaults.timeout;
        }
        if (!interval) {
            interval = lastlineDefaults.interval;
        }
        if (!threshold) {
            threshold = lastlineDefaults.threshold;
        }
        if (!pushToPortal) {
            pushToPortal = lastlineDefaults.pushToPortal;
        }


        var result = doReq('POST', 'analysis/submit/url', {url: url, full_report_score:threshold, push_to_portal:pushToPortal});
        var uuid = result.obj.data.task_uuid;

        var ec = {};
        var md = '';

        if (!analysisReady(result.obj.data) && timeout > 0) {
            result = analysisPoll(uuid,threshold,timeout,interval);
        }

        var dbotScore = {indicator: url, type: 'url', vendor: 'Lastline', score:0};
        if (analysisReady(result.obj.data)) {
            md=dataToMd(result.obj.data,threshold);
            if (result.obj.data.score > threshold) {
                ec['URL/Malicious']=url;
                dbotScore.score=3;
            } else {
                dbotScore.score=1;
            }
        } else {
            ec.lastlineTasks=[{'url':url,'uuid':uuid}];
            md += '### Lastline analysis for url: **' + url +'**\n';
            md += 'URL submitted for analysis.\n';
            md += 'Task UUID: ' + uuid + '\n';
        }
        ec['dbotScore']=dbotScore;
        return {Type: entryTypes.note, Contents: result.obj, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};

    }

    // get file hash analysis.
    // If hash is not known - retuern error
    var hashGet = function(hash, threshold) {
        if (!threshold) {
            threshold = lastlineDefaults.threshold;
        }

        var fileParams={full_report_score:threshold};

        switch (hash.length) {
            case 32:
                fileParams.md5=hash;
                break;
            case 40:
                fileParams.sha1=hash;
                break;
            case 64:
                fileParams.sha256=hash;
                break
            default:
                throw 'Hash not recognized';
        }

        var md='';
        var ec={};

        // check if file hash exists
        var result = doReq('POST','analysis/submit/file', fileParams);

        if (result.obj.error_code == 101) {
            throw 'File hash not found in Lastline';
        }
        var data = result.obj.data;
        md += dataToMd(data,threshold);

        var dbotScore = {indicator: hash, type: 'hash', vendor: 'Lastline', score: 0};
        if (result.obj.data.score > threshold) {
            var analysis = result.obj.data.analysis_subject;
            ec['File/Malicious']={MD5:analysis.md5,SHA1:analysis.sha1,SHA256:analysis.sha256,Score:result.obj.data.score};
            dbotScore.score= 3;
        } else {
            dbotScore.score= 1;
        }
        ec['dbotScore']=dbotScore;
        return {Type: entryTypes.note, Contents: result.obj, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};

    }

    // get analysis report based on uuid
    // if report not ready - either wait or return waiting message
    var analysisGet = function(uuid,threshold,timeout,interval) {
        if (!timeout) {
            timeout = lastlineDefaults.timeout;
        }
        if (!interval) {
            interval = lastlineDefaults.interval;
        }
        if (!threshold) {
            threshold = lastlineDefaults.threshold;
        }
        if (!uuid || uuid == '') {
            throw 'No task UUID provided';
        }
        var ec = {};
        var md = '';

        result = analysisPoll(uuid,threshold,timeout,interval);

        var dbotScore = {vendor: 'Lastline', score: 0};
        if (analysisReady(result.obj.data)) {
            var analysis = result.obj.data.analysis_subject;
            if ('url' in analysis) {
                dbotScore.type = 'url';
                dbotScore.indicator = analysis.url;
                if (result.obj.data.score > threshold) {
                    ec['URL/Malicious']={url:analysis.url,score:result.obj.data.score};
                    dbotScore.score = 3;
                } else {
                    dbotScore.score = 1;
                }
            } else {
                dbotScore.type = 'hash';
                dbotScore.indicator = analysis.md5;
                if (result.obj.data.score > threshold) {
                    ec['File/Malicious']={MD5:analysis.md5,SHA1:analysis.sha1,SHA256:analysis.sha256,Score:result.obj.data.score};
                    dbotScore.score = 3;
                } else {
                    dbotScore.score = 1;
                }
            }
            md+=dataToMd(result.obj.data,threshold);
        } else {
            md += '#### Report not ready.\n';
            md += 'Task UUID: ' + uuid + '\n';
        }
        ec['dbotScore']=dbotScore;
        return {Type: entryTypes.note, Contents: result.obj, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
    };

    // The command input arg holds the command sent from the user.
    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            urlGetSubmit('google.com');
            return 'ok';
        case 'url':
            return urlGetSubmit(args.url, args.threshold, args.timeout, args.interval, args.pushToPortal);
        case 'file':
            return hashGet(args.file, args.threshold,args.threshold);
        case 'lastlineUpload':
            return fileSubmit(args.file_id, args.threshold, args.timeout, args.interval, args.pushToPortal);
        case 'lastlineGet':
            if (!args.threshold) {
                args.threshold = lastlineDefaults.threshold;
            }
            return analysisGet(args.uuid, args.threshold, args.timeout, args.interval);
        default:
            throw 'Unknown command - ' + command;
    }

  type: javascript
  commands:
  - name: lastlineGet
    arguments:
    - name: uuid
      required: true
      default: true
      description: Analysis report ID
    - name: timeout
      description: Timeout (in seconds) to wait for analysis to complete
      defaultValue: "0"
    - name: interval
      description: Interval (in seconds) to poll for the analysis status
      defaultValue: "10"
    - name: threshold
      description: Score threshold to identify file as malicious
      defaultValue: "50"
    outputs:
    - contextPath: URL/Malicious
      description: List of malicious URLs identified by Lastline analysis
      important: true
      importantDescription: List of malicious URLs identified by Lastline analysis
    - contextPath: File/Malicious.MD5
      description: Bad hash MD5
      important: true
      importantDescription: List of malicious files identified by Lastline analysis
    - contextPath: File/Malicious.SHA1
      description: Bad hash SHA1
      important: true
      importantDescription: List of malicious files identified by Lastline analysis
    - contextPath: File/Malicious.SHA256
      description: Bad hash SHA256
      important: true
      importantDescription: List of malicious files identified by Lastline analysis
    - contextPath: dbotScore.indicator
      description: The indicator we tested
    - contextPath: dbotScore.type
      description: The type of the indicator
    - contextPath: dbotScore.vendor
      description: Vendor used to calculate the score
    - contextPath: dbotScore.score
      description: The actual score
    description: Get analysis report
  - name: url
    arguments:
    - name: url
      required: true
      default: true
      description: 'URL to be analyzed '
    - name: timeout
      description: Timeout (in seconds) to wait for analysis to complete
      defaultValue: "0"
    - name: interval
      description: Interval (in seconds) to poll for the analysis status
      defaultValue: "10"
    - name: threshold
      description: Score threshold to identify file as malicious
      defaultValue: "50"
    - name: pushToPortal
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Add the request to the Lastline portal
    outputs:
    - contextPath: lastlineTasks
      description: List of the submitted Lastline analysis tasks
    - contextPath: URL/Malicious
      description: List of malicious URLs identified by Lastline analysis
      important: true
      importantDescription: List of malicious URLs identified by Lastline analysis
    - contextPath: dbotScore.indicator
      description: The indicator we tested
    - contextPath: dbotScore.type
      description: The type of the indicator
    - contextPath: dbotScore.vendor
      description: Vendor used to calculate the score
    - contextPath: dbotScore.score
      description: The actual score
    description: Submit URL for analysis
  - name: file
    arguments:
    - name: file
      required: true
      default: true
      description: File hash to be checked (supporting MD5, SHA1, SHA256)
    - name: threshold
      description: Score threshold to identify file as malicious
      defaultValue: "50"
    outputs:
    - contextPath: File/Malicious.MD5
      description: Bad hash MD5
      important: true
      importantDescription: List of malicious files identified by Lastline analysis
    - contextPath: File/Malicious.SHA1
      description: Bad hash SHA1
      important: true
      importantDescription: List of malicious files identified by Lastline analysis
    - contextPath: File/Malicious.SHA256
      description: Bad hash SHA256
      important: true
      importantDescription: List of malicious files identified by Lastline analysis
    - contextPath: dbotScore.indicator
      description: The indicator we tested
    - contextPath: dbotScore.type
      description: The type of the indicator
    - contextPath: dbotScore.vendor
      description: Vendor used to calculate the score
    - contextPath: dbotScore.score
      description: The actual score
    description: Submit a file for analysis
  - name: lastlineUpload
    arguments:
    - name: file_id
      required: true
      default: true
      description: File ID to be uploaded
    - name: threshold
      description: Score threshold to identify file as malicious
      defaultValue: "50"
    - name: timeout
      description: Timeout (in seconds) to wait for analysis to complete
      defaultValue: "0"
    - name: interval
      description: Interval (in seconds) to poll for the analysis status
      defaultValue: "10"
    - name: pushToPortal
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Add the request to the Lastline portal
    outputs:
    - contextPath: lastlineTasks.file_id
      description: File ID of submitted Lastline analysis tasks
    - contextPath: lastlineTasks.uuid
      description: Task UUID of submitted Lastline analysis
    description: Upload file for analysis
hidden: false
