commonfields:
  id: Skyformation
  version: -1
name: Skyformation
display: Skyformation
category: IT Services
description: "SkyFormation provides cloud application security for business organizations. SkyFormation Universal connector forwards security events to the organization security tools and enables them to cover their cloud activity."
image: data:image/png;base64,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
configuration:
- display: Server URL (https://35.158.26.15:8443)
  name: url
  defaultvalue: ""
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: "true"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "false"
  type: 8
  required: false
script:
  script: |+
    import requests
    requests.packages.urllib3.disable_warnings()

    if not demisto.params()['proxy']:
        del os.environ['HTTP_PROXY']
        del os.environ['HTTPS_PROXY']
        del os.environ['http_proxy']
        del os.environ['https_proxy']

    # removes the last / from the url
    def fix_url(url):
        if url.endswith("/"):
            return url[:-1]

        return url

    USERNAME = demisto.params()['credentials']['identifier']
    PASSWORD = demisto.params()['credentials']['password']
    SERVER_URL = fix_url(demisto.params()['url'])
    INSECURE = demisto.params()['insecure']

    def get_accounts_request():
        fullurl = '{}{}'.format(SERVER_URL, '/openapi/api/rest/v1/accounts')
        res = requests.get(fullurl, auth = (USERNAME, PASSWORD), verify=(not INSECURE))
        if res.status_code < 200 or res.status_code >= 300:
            raise Exception('Failed to get accounts. Status Code: {}'.format(res.status_code))

        return res.json()

    def get_accounts():
        accounts = get_accounts_request()
        context = accounts
        accountsToContext = []
        for account in accounts:
            accountsToContext.append({
                'Id': account['id'],
                'Name': account['name'],
                'Application': account['application'],
                'TenantId': demisto.dt(account, 'tenant.id'),
                'TenantName': demisto.dt(account, 'tenant.name')
            })
        hr = tableToMarkdown('Accounts', accountsToContext, ['Application', 'Name', 'Id', 'TenantName', 'TenantId'])
        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': accounts,
            'HumanReadable': hr,
            'ReadableContentsFormat': formats['markdown'],
            'EntryContext': {
                'Skyformation.Account(val.Id==obj.Id)': accountsToContext
            }
        })

    # suspend_or_unsuspend_user_request will suspend user if suspend=True, otherwise it will un-suspend user
    def suspend_or_unsuspend_user_request(suspend, account_id, user_email):
        query_params = {
            'userAttributeName': 'email',
            'userAttributeValue': user_email
        }

        fullurl = ''.join([
            SERVER_URL,
            '/openapi/api/rest/v1/remediation/',
            account_id,
            '/suspend-user' if suspend == True else '/un-suspend-user'
        ])
        demisto.info(fullurl)
        res = requests.post(fullurl, auth = (USERNAME, PASSWORD), verify=(not INSECURE), params=query_params)
        if res.status_code < 200 or res.status_code >= 300:
            raise Exception('Failed to get accounts.\nStatus Code: {}\nResponse Body: {}'.format(res.status_code, res.text))

        return res.json()

    def suspend_user():
        account_id = demisto.args().get('accountId')
        user_email = demisto.args().get('userEmail')
        res = suspend_or_unsuspend_user_request(True, account_id, user_email)
        if not res['is-success']:
            demisto.results({
                'Type': entryTypes['error'],
                'ContentsFormat': formats['text'],
                'Contents': res['status-message']
            })
            return

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': res,
            'HumanReadable': user_email + ' was suspended successfully',
            'ReadableContentsFormat': formats['markdown']
        })

    def unsuspend_user():
        account_id = demisto.args().get('accountId')
        user_email = demisto.args().get('userEmail')
        res = suspend_or_unsuspend_user_request(False, account_id, user_email)
        if not res['is-success']:
            demisto.results({
                'Type': entryTypes['error'],
                'ContentsFormat': formats['text'],
                'Contents': res['status-message']
            })
            return

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': res,
            'HumanReadable': user_email + ' was un-suspended successfully',
            'ReadableContentsFormat': formats['markdown']
        })

    # The command demisto.command() holds the command sent from the user.
    if demisto.command() == 'test-module':
        get_accounts_request()
        demisto.results('ok')
        sys.exit(0)
    if demisto.command() == 'skyformation-get-accounts':
        get_accounts()
        sys.exit(0)
    if demisto.command() == 'skyformation-suspend-user':
        suspend_user()
        sys.exit(0)
    if demisto.command() == 'skyformation-unsuspend-user':
        unsuspend_user()
        sys.exit(0)

  type: python
  commands:
  - name: skyformation-get-accounts
    arguments: []
    outputs:
    - contextPath: Skyformation.Account
      description: Account object
    - contextPath: Skyformation.Account.Name
      description: The name of the account
      type: string
    - contextPath: Skyformation.Account.Application
      description: Application name (e.g Office 365, Sales Cloud)
      type: string
    - contextPath: Skyformation.Account.Id
      description: The id of the account
      type: string
    - contextPath: Skyformation.Account.TenantId
      description: The id of the tenant
      type: string
    - contextPath: Skyformation.Account.TenantName
      description: The name of the tenant
      type: string
    description: Returns all the configured accounts in skyformation
  - name: skyformation-suspend-user
    arguments:
    - name: accountId
      required: true
      description: You can get the account id by executing skyformation-get-accounts
        command
    - name: userEmail
      required: true
      description: The email of the user that will be suspended in that account
    description: The command will suspend user in the configured application by user
      email. For example if Sales Cloud configured in Skyformation, then this command
      can suspend user in Sales Cloud.
    execution: true
  - name: skyformation-unsuspend-user
    arguments:
    - name: accountId
      required: true
      description: You can get the account id by executing skyformation-get-accounts
        command
    - name: userEmail
      required: true
      description: The email of the user that will be un-suspended in that account
    description: The command will un-suspend user in the configured application by
      user email. For example if Sales Cloud configured in Skyformation, then this
      command can un-suspend user in Sales Cloud.
    execution: true
  runonce: false
releaseNotes: "-"