commonfields:
  id: McAfeeDAM
  version: -1
name: McAfeeDAM
display: McAfee DAM
category: Database
image: data:image/png;base64,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
description: McAfee Database Activity Monitoring
detaileddescription: Make sure that the XML API interface is enabled on you McAfee
  DAM server (Settings -> Interfaces -> XML API), and that configured user has proper
  permissions to query DAM alerts (Alert XML API)
configuration:
- display: URL
  name: url
  defaultvalue: ""
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Batch size for incident fetch
  name: batchSize
  defaultvalue: "10"
  type: 0
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Validate ceritifacte
  name: secure
  defaultvalue: "false"
  type: 8
  required: false
- display: Rule Name, If fetch incident is checked, this field is mandatory and will
    be used to get DAM alerts only triggered by this rule
  name: ruleName
  defaultvalue: ""
  type: 0
  required: false
script:
  script: |-
    var mdAlertFields={
      'Execution Time':'executionTime',
      'Rule':'rules.rule.name',
      'User':'execUser',
      'Database':'database.name',
      'Sensor':'identifyingSensor.name',
      'Command Type':'cmdType'
    };

    var fixUrl = function(base) {
        res = base;
        if (base && base[base.length - 1] != '/') {
            res = res + '/';
        }
        return res;
    };

    var sendRequest = function(url, service, param) {

        // handle '/' at the end of the url
        if (url[url.length - 1] === '/') {
            url = url.substring(0, url.length - 1);
        }

        // prepare the request url (make sure to encode the query parameter value)
        var requestUrl = url + 'service=' + service;
        if  (param) {
            requestUrl += '&' +  param;
        }
        var res = http(
            requestUrl,
            {
                Method: 'GET', // Can be POST, PUT, DELETE, HEAD, OPTIONS or CONNECT
                Headers: {
                    Accept: ['application/json']
                },
                Username:  params.credentials.identifier,
                Password:  params.credentials.password,

            },
            !params.insecure
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }

        return JSON.parse(x2j(res.Body));
    };

    var finalUrl = fixUrl(params.url) + 'xmlapi.svc?';

    var calculateNewLastRun = function(alerts) {
        var res = '';
        var lastAlert = null;
        if (alerts && alerts.length && alerts.length > 0) {
            // transalte yyyy-MM-dd HH:mm:ss.S +Z => yyyy-MM-ddTHH:mm:ss.S+Z => time in millis
            lastAlert = alerts[alerts.length -1];
        } else if (alerts){
            //This is a single element
            lastAlert = alerts;
        }
        if (lastAlert) {
            var createDate = lastAlert.createDate;
            var dateTime = createDate.split(' ');
            var goTime = dateTime[0]+'T'+dateTime[1]+dateTime[2];
            //hack needed, becuase platform problems
            res = new Date(Date.parse(goTime)).getTime() + 1;
        }
        return res;
    };

    var alertToIncident = function(alert) {
        labels = [];
        var keys = Object.keys(alert);
        for (j = 0 ; j < keys.length; j++) {
            if (keys[j] === 'accessedObjects') {
                if (alert.accessedObjects.object && alert.accessedObjects.object.length > 0) {
                    for (k = 0; k < alert.accessedObjects.object.length; k++) {
                        labels.push({type: 'accessedObject', value: alert.accessedObjects.object[k].owner + '.' + alert.accessedObjects.object[k].name + '('+ alert.accessedObjects.object[k].type +')'});
                    }
                }
            } else if (keys[j] === 'database') {
                labels.push({type: 'database-host', value: alert.database.host});
                labels.push({type: 'database-ip', value: alert.database.ip});
                labels.push({type: 'database-id', value: alert.database.id});
                labels.push({type: 'database-name', value: alert.database.name});
            } else if (keys[j] === 'identifyingSensor') {
                labels.push({type: 'sensor-host', value: alert.identifyingSensor.host});
                labels.push({type: 'sensor-ip', value: alert.identifyingSensor.ip});
                labels.push({type: 'sensor-id', value: alert.identifyingSensor.id});
                labels.push({type: 'sensor-name', value: alert.identifyingSensor.name});
                labels.push({type: 'sensor-version', value: alert.identifyingSensor.version});
            } else if (keys[j] === 'rules') {
                if (alert.rules.length > 0) {
                    for (k = 0; k < alert.rules.length; k++) {
                        labels.push({type: 'rule', value: alert.rules[i].name + '('+ alert.rules[i].sysid +')'});
                    }
                } else if (alert.rules) {
                    labels.push({type: 'rule', value: alert.rules.name + '('+ alert.rules.sysid +')'});
                }
            } else {
                labels.push({type: keys[j], value: alert[keys[j]]});
            }
        }
        return {
          name: 'DAM Event - ' + alert.id,
          labels: labels,
          details: alert.operation,
          rawJSON: JSON.stringify(alert)
        };
    };
    var alertsToIncident = function(alerts) {
        var incidents = [];
        for (i = 0; i < alerts.length; i++){
            incidents.push(alertToIncident(alerts[i]));
        }
        return incidents;
    };
    function alertsToMd(alerts) {
        var md="";
        if (Array.isArray(alerts)) {
            for (var i in alerts) {
                md += alertToMd(alerts[i]) + "\n --- \n";
            }
        } else {
            md += alertToMd(alerts);
        }
        return md;
    }
    function mdTableHead() {
        var head='|';
        var line='|';
        for (var key in mdAlertFields) {
            head+=key + '|';
            line+= '- |';
        }
        return head+'\n'+line+'\n';
    }
    function mdTableData(alert) {
        var data='|';
        for (var key in mdAlertFields) {
            data+=resolve(alert,mdAlertFields[key]) + '|';
        }
        return data + '\n';
    }
    function alertToMd(alert) {
        var md ='';
        md +="### DAM Alert ID " + alert.id + "\n";
        md += mdTableHead();
        md += mdTableData(alert);
        if (alert.operation) {
            md += '#### Statement\n';
            md += '```\n' + alert.operation + '\n```';
        }
        if (alert.accessedObjects && alert.accessedObjects.object) {
            var objects = Array.isArray(alert.accessedObjects.object) ? alert.accessedObjects.object : new Array(alert.accessedObjects.object);
            md += '\n#### Accessed Objects \n';
            md += 'Type|Owner|Name\n-|-|-\n';
            for (var i in objects) {
                md += objects[i].type + '|' + objects[i].owner + '|' + objects[i].name + "\n";
            }
        }

        return md;
    }

    function resolve(obj,path) {
        if (Array.isArray(obj)) {
            var ret = [];
            for (var i in obj) {
                ret.push(resolve(obj[i],path));
            }
            return ret;
        } else {
            var dot=path.indexOf(".");
            if (dot == -1) {
                return obj[path] ? obj[path] : 'N/A';
            } else {
                var curr = path.substring(0,dot);
                var rest = path.substring(dot+1);
                return obj[curr] ? resolve(obj[curr],rest) : 'N/A';
            }
        }
    }

    var fetchIncidents = function() {
        var count = params.batchSize || 100;
        //Default time back for first fetch is 10 minutes
        var timeBack = 1000 * 60 * 10;
        var urlParams = 'HH$TimeBackPeriod=' + encodeURIComponent(timeBack +'');
        var lastRun = getLastRun();
        if (lastRun && Object.keys(lastRun).length > 0) {
            urlParams = 'HH$CreateDateFrom=' + encodeURIComponent(lastRun.createDate);
        }
        if (params.ruleName) {
            urlParams +='&HH$RuleName=' + encodeURIComponent(params.ruleName);
        }
        urlParams += '&HH$pageSize='+encodeURIComponent(count);
        var res = sendRequest(finalUrl, 'alert',  urlParams).HedgehogXmlApi;
        var incidents = null;
        var newLastRun = null;
        if (res && res.alert && res.alert.length > 0) {
            //Create incidents
            incidents = alertsToIncident(res.alert);
            //Set last run
            newLastRun = calculateNewLastRun(res.alert);
        } else if (res && res.alert) {
            //This is a sinlge alert
            //Create incidents
            incidents = [alertToIncident(res.alert)];
            //Set last run
            newLastRun = calculateNewLastRun(res.alert);
        }
        if (newLastRun) {
            setLastRun({createDate: newLastRun});
        }
        return incidents;
    };

    // The command input arg holds the command sent from the user.
    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            sendRequest(finalUrl, 'sensor');
            return 'ok';
        case 'fetch-incidents':
            return JSON.stringify(fetchIncidents());
        case 'dam-get-alert-by-id':
            var jsonRes=sendRequest(finalUrl, 'alert', 'HH$Id=' + encodeURIComponent(args.id)).HedgehogXmlApi.alert;
            if (jsonRes) {
                var entryContext = {
                };
                md = alertToMd(jsonRes);
                return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
            } else {
                md = '### no alerts found\n';
                return {Type: entryTypes.note, Contents: null, ContentsFormat: formats.json, HumanReadable: md};
            }
        case 'dam-get-latest-by-rule':
            var count = args.count || 10;
            var timeBack = 1000 * 60 * (args.timeBack || 10);
            var res = sendRequest(finalUrl, 'alert', 'HH$RuleName=' + encodeURIComponent(args.ruleName) +
                '&HH$TimeBackPeriod='+encodeURIComponent(timeBack +'') + '&HH$pageSize='+encodeURIComponent(count)).HedgehogXmlApi;

            if (res && res.alert) {
                jsonRes = res.alert;
                var entryContext = {};
                md = alertsToMd(jsonRes);
                return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
            } else {
                md = '### no alerts found\n';
                return {Type: entryTypes.note, Contents: null, ContentsFormat: formats.json, HumanReadable: md};
            }
    }
  type: javascript
  commands:
  - name: dam-get-alert-by-id
    arguments:
    - name: id
      required: true
      default: true
      description: The alert ID
    outputs:
    - contentPath: id
      contextPath: AlertId
      description: DAM Alert ID
    - contentPath: accessedObjects.object.name
      contextPath: alertAccessedObjects
      description: DAM Accessed Objects
    - contentPath: execUser
      contextPath: dbUser
      description: DAM Database User
    - contentPath: osUser
      contextPath: Account.Username
      description: DAM OS User
    - contentPath: database
      contextPath: database
      description: DAM Database
    - contentPath: identifyingSensor
      contextPath: sensor
      description: DAM Sensor
    - contentPath: rules
      contextPath: rules
      description: DAM Rules
    description: Get a DAM alert from McAfee Database Activity Monitoring by alert
      ID
  - name: dam-get-latest-by-rule
    arguments:
    - name: ruleName
      required: true
      default: true
      description: Name of the rule that triggered the alert
    - name: count
      description: Number of alerts to retrieve, defaults to 10
    - name: timeBack
      description: Filter DAM alerts and import alerts that where created only in
        the last given minutes, defaults to last 10 minutes
    outputs:
    - contentPath: id
      contextPath: AlertId
      description: DAM Alert ID
    - contentPath: accessedObjects.object.name
      contextPath: alertAccessedObjects
      description: DAM Accessed Objects
    - contentPath: execUser
      contextPath: dbUser
      description: DAM Database User
    - contentPath: osUser
      contextPath: Account.Username
      description: DAM OS User
    - contentPath: database
      contextPath: database
      description: DAM Database
    - contentPath: identifyingSensor
      contextPath: sensor
      description: DAM Sensor
    - contentPath: rules
      contextPath: rules
      description: DAM Rules
    description: Get latest DAM alerts by rule name
  isfetch: true
  runonce: false
