commonfields:
  id: McAfeeDAM
  version: -1
name: McAfeeDAM
display: McAfeeDAM
category: Endpoint
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAAhCAYAAAAS5W/tAAAWt0lEQVR42u1bB1RUx7uniBTpZQu99yJIV1EBUUBAkWKjiAVFAUHQIKKIYEWlWkAwiGINEkkssIXdBZbeq3Sk2FBMjIXifXMHXDAUMc+8/3vvMOfMWfbufDNz5/f1b2AqdHa413YhfmNbQgIv0z9spKgzzOmBe/R+dlt/5ZzpQo+pxpXb2jGXr14T8PzW3RX/ZJ3m/cErWiMi9vdcSWVl+oHteXqGYLmt7YM8FdXGPFW1hpKVK+5/fNqFmSn9i4xMsSdBQUHFi00eFS1cVFxovDCv2GRJyou76XpM/+mWpSTbT1BVQvKtVpY0Hj26qzf9F4GZ0maGHGAlnDlpGr/K4naQuPCfvjxzkHAt5T3T0eSqKF+lykoMtZ867dUWdpJ5Jut0XbzM0hkT75kjjf9UucHp+r9xDnVbPeMIgpwIESOAEAW4kd7U6+tmxBy30xfSF8xvQWmIIvwICaUX4kFIOL5PfY+yrf/jABO11J4TNVSQbCV5JFtFAcmzMGuu2bcvuCH8qNRUNFWZGVyJDnb2MSuWZgVi+YZ9eVkRfwEOZB+ODwnTVNw93Xp07QVJRCFehIwTRMqsrH/uTbkuNN34p3GXhCvXOvxMwgogWdxsSI2Hx5V/4xye301fmCOJ/ZyDxyEEQR6k3Mb20bdoXj3MwhQuNKom8HIiOaJ4JAeHQUhYISSbjwOpsHd4yPS/oRE11Z6DjgCgYc9WlkeyFGUR2tLFXRVeO6MaI46pMFRx7DnezEMHPKItTOiBGB4IbIDwPAT8jQSKcCOBOF7kqMb0ABfo6CShB0EGHeX0khXLy7sTkg0nldxLlw2KliwqQcfl4LBAsngAwJv/FYCbgoIPEkX4IFBknAiSI4H/0Pcoy2A6mpaQI14kIUCDx0IaqpzM2yJD49w8ZeWe7uRk2/9pLOs8vZjfUKl8/fn5PK8eZbP2JKfOgRLMAFgT7erwk6CiAMHO0VvwV4Xn9sTbW9wCwzSV6v342RAfbhYkQAQFlhcJxPJ8DbCm0jcA1oYAg4OEncjPjeSqKbwFKnJnfz6deVSaWOrct+zMVZDrJwryjo4V/SbArWHH5YuNTS2epd60r17vtqpytZMWsINzv3UwfY+JuAJjvXqSIAQYdByCSuWTwP2x09FVb3ZLIvBzQ+Yji4p87rqY6AG1Tky8YB+BwD7BhwgK5qzb7KmRKye/nColadEUEKTefiZqzkwB7IyMwZUut1oIzmJF8TLzRV3nL2EmaFen9R4Nu333dyUme7aFn9zNkOAvIGejwKoqgr/VR7qaMto/H5cWHfAGEgsBxfJCyfUFQO8V5ITfGQB/U0XrjAKMYwBHwgiCAxJG6rZvT3j520O5Wg+Pizliwp/JGCE4ZrRPCXDbidPGxYuX/JK/QLOXKiM5TBYRgvPTlOVfl1pYEJ/GnZ/Wqes4G7WNCCSRjMcy1iIJCyD52pptAHzpqehqtrjfIPDPQ8gYDJKrotDXGXdeebJxvWk3ORu8fb0KFiwoyFVTekURFx3OERMdztNSfVW0aBGx0X/fmmm1i/9+9VJziyS6nk4rTV76Hbo/qpz0+wIj3ab6nbsin/gGio0B7GTQcuSIbUtIaGSjz97IvwM8ULzemURZZPQyS0EGQZ0vkqYqkqOjNXhSQeoPP2EuCOwe3jkAUJ6heGvzgvD5yu3+ghyoFEOAwzRmArDIGHBfDhULVLYw/2earMx74KgMjzCBKARqDGDuCQC3Rhz3ospJfSQK8yEkACwZixn9FEE7pCGLCw90noveN9l+PrS2zy1etowO/AJ0PUAjzFiTwDcP6YiK3jXB9mYRBZr8g3Uq7GwfAxUN16Qpyv3xxG+/Q8N2H63e1DTxcbYdX2pp+ZiERfcnAPeGvj8Zh4V/k4T5kRwxDFK3Y0fM8xt32Scwx7XrG2mKMv2o+SAJAXoMSo9F3w3SEgTmoYzY0vPz1cVQTe/w5OqIjuHtjIsX7r6cLDQeYACo4kdgd/Wf/f67AlDL0ZTFRi9QVU1UUxo6Liv+zouTCflJXHDo7FJjQqLjatu8xEv8F+1XPfThZoaSDSV4xgDDQ/ycI47/TALgjH4HUvQFfBx4IX7wCRwfsTGAq91cGQD3Xk11zhEVGiSJCEJwwHgAJnaIqiL7J0VWfGCEHg/tPeohd0bF+k30gu/akPGAHo+DQOVraPZQxESHUDoU9BIz84KB129YvnL8LiR6UOQlP4C9D4xpGNxnGohIqAqSA417A8+i4z62t7NXOjg8yOZhh2MgmJL4QZqc7Gsgge/IOMiQI/6IIBfSGBBwavw6gFEsc6Sx7yEdNAMYhKog/Y4mK/cmRwI3AO2/GB7QciN5Wmpdz+/cU53cyRq1vyQt9YFsZTnjL7+1JyZIVXp6HqXbWLWeUZF7HW9neffxsTCz9H17YRyaEbiXPd7KnAgBhhIMbfCMJZgINl7lvP5K9aZN98AmIVeOSJEI5MzKdU73KteuSyFjocodkWA3Nwhwf0ERX4G+XiO00WJi8CVLlptRmvcfXPcs7a5G80+HzMutV2Wgv4+MwQ4+2Rt4fKLNcs4AdhQeMkVCdLD91FnXQiPDSqBF4KHmSGAHey6nWH6l0iOjdxJ4OOA+x5kQKF3Z8+Yiddt2XITndyrSmyjANeKEASYsWrq4utHbz6ZijT22xn2bYr23TzhVTvITqq2gxsFjhl5nk0ygZmnrFCoyMS4j8HGCfeAQipToYJmFZUzr4aOqFfaOuNbQiJWlFuZ0CL6oKPTcK52d0ycNk8YDnGOgxwCYAXRcnHimj5dWblIC2/jnv4ceYo+1NIMAz1xFjzlZqI0tNNSHqrN+t/dxiqToAIGHE0Glr8HX7yS0c+5b9qGqLQc/qqLd3SHAraHhbiTs6HPAyWVWliQQcgmOX+sNhcpe4775DrDDebUuW43+vpdn124aUOUl/yBhhKF9L11pkfdXdT1bS9iRYwReDoaart2yLXU8HdAEu4kivMgI44nCcVADiAKTIMKDNPj4xn9obmcrNltKR5mLDObP01DtbzkQbl5t78JSscKet9LKkavBw2du/Y5dUYCZ4DwEwXlIzUbXn2EEcTnZCdBCxkYlvdR05Z0qOxeO6jWbOAA9T62zx5yepGvqBXp6T8E5Qv+BIiU2COJ33cnCJAbAFGMDAPAMGgQ4ZATgeeMleOYAQ9WLxYR9+e1JYJBTyXLTkubgQ45fnlWudQpFY0sIJD8PUrt1SzLMilnbXgbcCyWPjBEcfnn/9xWT29g23le/PeCY7LfGvQGx2byccG6UWVoOHfFGn/ekXF+Qq6b4GthIyIQ0Bdm+fmqeCkOt3/xFtWLlmj1FJiblgPmgPQVj3lc7ukSUGJv7dsUn6PcXFCpRxCUGgFRC8KnS0h/p83We0DW1Ogq0dDroWtoddA2tlnwNrY5R8wRtbJHJorq2iJNzS8yXx5JEoHRCDZCnotZToK3bBMZ30udrd+SpaXQULNBtoMnJvUV/hyZKVAipdd3qP6UEEyHA+jMH+HAIQ4L/qZNFk5U9MiYZ8cw9F5M5O06cYRnn9ocCx2cMYK8dl9HnIO7MAC8FAchTV+lq2n9Qkek7Wn9enlSussIrElYYxrAgw/a26acDNpVOTmpN+3/SLjEzKwKeNNwj6ik3HwwJnsSLvj7iRQN6deVXHZFRjD00+gdYUMacSPhJwgrCTh75hExFwgmNqXgRYSRfV7OrOeCQVJm55W0ihpehIdDxQGuAzjeu88LECmAi0EVAF0bomvNjJkjwPwX4AQA4bgzgGcbBXwMMOPDINMMhwNBzxKPqkhup99l9aSTlqXI7B0qvMBqivGmPiNT9HoABmIeIQtwMh44iJjZMlZL6CCRtiCop+YkiLjYAnsMDRp3AQiOjhvctbVxf6HsSrjJXuWy4A710LBomKb7uOBOlPsas0YsBwIzQCzhugySc8EfADMMUUeDEgQ7ohoAaHgSSOgg00RD4DWXWnrrNOxRLlpqlkrD8DICpEuIfIR0ehFhYHIgy8MMUMfFhqrgE4xlKn6+qljCtiqZ+h4r+7WAwlODv96IxjIMFEvxNgMlQReNgUgSEAYkQoMCgUKLgPPicBFKLbcdOTjoPSCY4N+7Z6/Li3q+MAsWfdY0Yuv6CmlEvm9EBGIw+LjyDzhYJJ4B0XUxa/2WO7gtXAMAbAcA8qIMEAW4/fZYB8Is7GRK5yoovoIRhgWTp6LZX2jvrAk9bEUifFlGYR5MqK6XeER8jA2y8DFVaXPUhO9N8MIcaTKJs2BRMHE28oCHgE799Z/tzC6T66UU675tadf6srNV5mflQDZgT2X56sfK76jqddzX1uj0p1ySmkGBVhDRf/RNZV9twxmnOM6fZY1eaEhgSPHOAZy7BzhvGAQwcnu3bIMB9jx7rUCTxfwEpgCoWHNaH9lNndnSci2JjxMihYWtpCjJ9JAw/yA2vzWg7EqEPpS/1uhuQPKg2IYNgBFAVN6EDzQHmhvYNOluVTo73P/U+g+ajKz4ZAjxegtsjz6l/pcI3u6WBjBhcAziQSMWqNSdBfMrM8Dn2/8QMsl7utVt3bGk+fITlKwfwxk0DQPMRMAhMuoCcd0vP5Sv6XyV4wo/J1e/yDn52+67qtMUGRhysrjxYuWvnkpkCXJByhevcsoVUkNH6DoC/X0WTGU4WNwNg6Hnv9LqUzcMGAQCqGoAiNFhoaFhWYrI8rXjRkhyqvNR78Byu84iNCan32p2C0pWYm1GJwqP2TRyHFBkaPSpYoBddaGh0vtDA4HyRgeH5Qj39mEJ9w7SReBU7kp8Ww314TaHqQQmOS2Ku/gpghdcdfwP4ZeYDI5qC9FsQpwN6HExogDXKyiysTpRZ2YQXGRjRcvAogwojBQb6xSD1uHY8fYPP7svZvOxwn+gcVHnptxXWdmmlFisPlJgsuwgSHE/R9WmKsm+LjBeef3kvQ3xiLfcrgFUQuo11Vfm2rbtfksgiUwJ7NZk5JzbK9OJqq1v7cPyfQF76O1OVUCpmCPCGUSdLdMTJ2r6dAfD79k6h8jWryQR+DqgGARDwIEg40EUE0IOHHY0li5eblb4hUzAv7qQvJ+Mhw0AHLX++xvO+bCJ+qvVBJYuArgulmJ8TAZ43TGL0JqWyVDo7/TKmopWgDZ6Qfz4YuhNokCHoEeMwY9oCh2oIQUgLY3Vwfs2hIQfG075+TMCUmJvS0P1DBsaIoP4AZAjopIkIwWdZ81hAjG3cBIojahNeIFtJrn8sVamOFhgg0PmWFq31IQdDm8+ckWFIe1Qkz3VPD4co88WEfXi+T75fig5YXijBe0Eq86CcmP+09WAlhSvZYMMEAS7Q56EvfWK68RU2q09k8bBBT/YROxNS7eGaPP73dzW1QhWr1ySAdN57mDaEMS03VGtEIX40pv5QtW5DKqis4CBgjvaPHoN5ADBwvvrduy9Mm+CPifPI5pkD58wG5UqqsuyrN7Q8KCllqywzsziZIQNRZMXetB0/rTWpH7AvyKnAQLcFeLloKAQBJQjCPUKwC/R161rDjjlOmic/cRZXvcklhSIn8R4thhABDQG+nyDM3NEUpT5UOTql9j3OFptcGu1s6GjOOUtJDiGqKwNHC0iypioEGs1HU4wMXoD68IlMP5/t58wXFfoLsMNc9F4hLlhNCgCc58c3F0Fj4UMKEv2pW11XT3dg9Tt37Klc50AChfvfqjY4kWvcXF2nHg3tjFuFsz0RHV++1obYER3lO6FsFxzKDDJYurXuWw8VGhrfqnCwe1BsuuRetatbOEi6GzMO6/g52Wr3TelgHkK5o93jCsc1xBf3M/WmrTQRSYI17m53KxxsssD4xxXr7YkthyMs4LrhYaGlNiuoZbbW5CqXdRnPbt6WmbKgcfIstm7Lzi3l1jbJYPzDCofVj0A9/Eqtq4cryHd/85JFx5loo7ptnuEly83vVa5bSyhauuR+1bqNJwBjGD+Nu8gyNWFSMl99SPAm+mpbGgB2MEseFBk0VKA0j+SnldBq0vBxIAleXEwAVG7QRyTWj38u4ifIgd7i6Erd4nriQXiowrc2+vKXX1mfJd1ge5Z8E/bn1+9Me6vjNTGH5VlyGhzbm3CNrZ+azzptCW/dRubu2MQ5Dbt8mSdWdW6zdl/6maMnLmlud+zlub3J12ZUqgNFAJbumMS53fHJc3suJLH3Xr/NBosOD7LmdJ6OZX96KoajOz6R/W1x8bTvMo7R2MAe2f7RtaWAIBZwDuwNnj6s30XYlZbG3p6YaFm+1eM+6k0D1Q1qwooICQ2fdDSHTipI/uknPG+kTMjDCqX2mI5aXdI6hwD6lcviTLPt/0Zrv5TAUu3vb1zm7nqNutjoTbaiLKq2h04oSPyxC0jwPizv4NllxgUZQYGb7wX6CzDNtv/DYCckaKLXdqjGhs9PKUh9PL3M+PEdP2/7qvv3OJhm2/+f9uT0afnKWzeMiFFn2f67c1XaO/gV6BtGfC9d14UEjTIb66t1nrs0p8wvUwtYWg4elmwLOzalZildYcVaZm0TU2S8yIVptv34lqeqeossiyn6XrqWkLDlNHWZt2UWqyynGgPuYvFUua0nVDtv2Dvl3Wwrm7lUKYlmEobvFNNs+/EtX0M9FdxNqnziuze8aPGi7Nbw8PX9tHwJUBeNfUPP1x65EpOlXr/d68JftfXSjLTj4XBTioJ439OLiSZv8vPUWg6HhXRdTnIoNl2aWbVx46VXv/2Oq9u23Qlkr/6kysuUgbtLjtXrN7HW7/TeVLp0OQEU/9NACQ9KP0j815LxIP6ebT++0edrXQFVG6R4ydJbIB5My5HBD3cnJnnQTYxLql3cb8BQx21zHE1duetdVQ1mDOAIU6qCRN/T+ESjrqQkBwI3OwLqqo1Fy0wuUWQlPlVv2nga5KFdKDKi70sszKvaI884NR886Jmnrfaidst2nzJbqxulq8xrQG5bnCIpXj4L8L+lolWU08qt7SphEiPsOFuR6cKcOk/P690JSZ40Zdmut/l0Cbr2/Nam4OCjf7sSOwrwJaPulGtrSSBF1xkdbTKidlfdAhfrHvX9Bi6iLzOsAjlqmPIrWmJSkqum0lxsZBJeYmJ6A00P5qvPt85TVcsH961mAf43Wq6y0o3KNU65X74Xmy35FQBOeN/UzEfX126udtiQnm+o2dCbekPn7wBTFCQBwAlG3VdSnKiSMu9ajoXDKzo0GZmrFHH8752nYkQLlho0VLu4HRrNe9eXWCyjt0Wccm8+eMitKyHJscLGThzcAKkuX217hGm2/egGc9FXQZkPafD29msMCPQmS4kMNYcc8oM52wMhkWieuGajy72JSfsj5mQp4f7OqPOLgYp2AkWEwXofX9yITcXfJOL4s59nZHKB1GFunqZKR8fZ6KVAC4Tmqiv0N+zx2dAUEmzVeSEuuHHXHhxFWpRWareyoP3EKUmm2fZjW6Wjc1Ct++b0cktrYp6ici8o4EcOvHgJ4+rOc7EaaJWkJyVlQuK9OzF5QZmd9YMXt9M1Xv2auazMchWhIzZWcKQgYXu41MwsCjpojwn6dENtCri7lfSh/Slv3U7PsDxl1U66qmZX+drV8W+o+fNArdW20NigHPw3xUqm2fZjW5P/T6wwtt4TyAY8Z3gFZvjjR44nAfsXVDg6xBQYGra8q28QmJDDzshkbtjtx/qaSGbuJ1NZGnf4szLidO8AlnqXHSyMfPQmdxZwcY+N8X29C2fNRjeur4rxm7bMaQ2LYGGabf9++6uhSRKU0+pAQbv36fkL1kyz7Ye1/wIB3iVjsyJTfQAAAABJRU5ErkJggg==
description: McAfee Database Activity Monitoring
releaseNotes: "-"
detaileddescription: Make sure that the XML API interface is enabled on you McAfee
  DAM server (Settings -> Interfaces -> XML API), and that configured user has proper
  permissions to query DAM alerts (Alert XML API)
configuration:
- display: URL
  name: url
  defaultvalue: ""
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Batch size for incident fetch
  name: batchSize
  defaultvalue: "10"
  type: 0
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Validate ceritifacte
  name: secure
  defaultvalue: "false"
  type: 8
  required: false
- display: Rule Name, If fetch incident is checked, this field is mandatory and will
    be used to get DAM alerts only triggered by this rule
  name: ruleName
  defaultvalue: ""
  type: 0
  required: false
script:
  script: |-
    var mdAlertFields={
      'Execution Time':'executionTime',
      'Rule':'rules.rule.name',
      'User':'execUser',
      'Database':'database.name',
      'Sensor':'identifyingSensor.name',
      'Command Type':'cmdType'
    };

    var fixUrl = function(base) {
        res = base;
        if (base && base[base.length - 1] != '/') {
            res = res + '/';
        }
        return res;
    };

    var sendRequest = function(url, service, param) {

        // handle '/' at the end of the url
        if (url[url.length - 1] === '/') {
            url = url.substring(0, url.length - 1);
        }

        // prepare the request url (make sure to encode the query parameter value)
        var requestUrl = url + 'service=' + service;
        if  (param) {
            requestUrl += '&' +  param;
        }
        var res = http(
            requestUrl,
            {
                Method: 'GET', // Can be POST, PUT, DELETE, HEAD, OPTIONS or CONNECT
                Headers: {
                    Accept: ['application/json']
                },
                Username:  params.credentials.identifier,
                Password:  params.credentials.password,

            },
            !params.insecure
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }

        return JSON.parse(x2j(res.Body));
    };

    var finalUrl = fixUrl(params.url) + 'xmlapi.svc?';

    var calculateNewLastRun = function(alerts) {
        var res = '';
        var lastAlert = null;
        if (alerts && alerts.length && alerts.length > 0) {
            // transalte yyyy-MM-dd HH:mm:ss.S +Z => yyyy-MM-ddTHH:mm:ss.S+Z => time in millis
            lastAlert = alerts[alerts.length -1];
        } else if (alerts){
            //This is a single element
            lastAlert = alerts;
        }
        if (lastAlert) {
            var createDate = lastAlert.createDate;
            var dateTime = createDate.split(' ');
            var goTime = dateTime[0]+'T'+dateTime[1]+dateTime[2];
            //hack needed, becuase platform problems
            res = new Date(Date.parse(goTime)).getTime() + 1;
        }
        return res;
    };

    var alertToIncident = function(alert) {
        labels = [];
        var keys = Object.keys(alert);
        for (j = 0 ; j < keys.length; j++) {
            if (keys[j] === 'accessedObjects') {
                if (alert.accessedObjects.object && alert.accessedObjects.object.length > 0) {
                    for (k = 0; k < alert.accessedObjects.object.length; k++) {
                        labels.push({type: 'accessedObject', value: alert.accessedObjects.object[k].owner + '.' + alert.accessedObjects.object[k].name + '('+ alert.accessedObjects.object[k].type +')'});
                    }
                }
            } else if (keys[j] === 'database') {
                labels.push({type: 'database-host', value: alert.database.host});
                labels.push({type: 'database-ip', value: alert.database.ip});
                labels.push({type: 'database-id', value: alert.database.id});
                labels.push({type: 'database-name', value: alert.database.name});
            } else if (keys[j] === 'identifyingSensor') {
                labels.push({type: 'sensor-host', value: alert.identifyingSensor.host});
                labels.push({type: 'sensor-ip', value: alert.identifyingSensor.ip});
                labels.push({type: 'sensor-id', value: alert.identifyingSensor.id});
                labels.push({type: 'sensor-name', value: alert.identifyingSensor.name});
                labels.push({type: 'sensor-version', value: alert.identifyingSensor.version});
            } else if (keys[j] === 'rules') {
                if (alert.rules.length > 0) {
                    for (k = 0; k < alert.rules.length; k++) {
                        labels.push({type: 'rule', value: alert.rules[i].name + '('+ alert.rules[i].sysid +')'});
                    }
                } else if (alert.rules) {
                    labels.push({type: 'rule', value: alert.rules.name + '('+ alert.rules.sysid +')'});
                }
            } else {
                labels.push({type: keys[j], value: alert[keys[j]]});
            }
        }
        return {
          name: 'DAM Event - ' + alert.id,
          labels: labels,
          details: alert.operation,
          rawJSON: JSON.stringify(alert)
        };
    };
    var alertsToIncident = function(alerts) {
        var incidents = [];
        for (i = 0; i < alerts.length; i++){
            incidents.push(alertToIncident(alerts[i]));
        }
        return incidents;
    };
    function alertsToMd(alerts) {
        var md="";
        if (Array.isArray(alerts)) {
            for (var i in alerts) {
                md += alertToMd(alerts[i]) + "\n --- \n";
            }
        } else {
            md += alertToMd(alerts);
        }
        return md;
    }
    function mdTableHead() {
        var head='|';
        var line='|';
        for (var key in mdAlertFields) {
            head+=key + '|';
            line+= '- |';
        }
        return head+'\n'+line+'\n';
    }
    function mdTableData(alert) {
        var data='|';
        for (var key in mdAlertFields) {
            data+=resolve(alert,mdAlertFields[key]) + '|';
        }
        return data + '\n';
    }
    function alertToMd(alert) {
        var md ='';
        md +="### DAM Alert ID " + alert.id + "\n";
        md += mdTableHead();
        md += mdTableData(alert);
        if (alert.operation) {
            md += '#### Statement\n';
            md += '```\n' + alert.operation + '\n```';
        }
        if (alert.accessedObjects && alert.accessedObjects.object) {
            var objects = Array.isArray(alert.accessedObjects.object) ? alert.accessedObjects.object : new Array(alert.accessedObjects.object);
            md += '\n#### Accessed Objects \n';
            md += 'Type|Owner|Name\n-|-|-\n';
            for (var i in objects) {
                md += objects[i].type + '|' + objects[i].owner + '|' + objects[i].name + "\n";
            }
        }

        return md;
    }

    function resolve(obj,path) {
        if (Array.isArray(obj)) {
            var ret = [];
            for (var i in obj) {
                ret.push(resolve(obj[i],path));
            }
            return ret;
        } else {
            var dot=path.indexOf(".");
            if (dot == -1) {
                return obj[path] ? obj[path] : 'N/A';
            } else {
                var curr = path.substring(0,dot);
                var rest = path.substring(dot+1);
                return obj[curr] ? resolve(obj[curr],rest) : 'N/A';
            }
        }
    }

    var fetchIncidents = function() {
        var count = params.batchSize || 100;
        //Default time back for first fetch is 10 minutes
        var timeBack = 1000 * 60 * 10;
        var urlParams = 'HH$TimeBackPeriod=' + encodeURIComponent(timeBack +'');
        var lastRun = getLastRun();
        if (lastRun && Object.keys(lastRun).length > 0) {
            urlParams = 'HH$CreateDateFrom=' + encodeURIComponent(lastRun.createDate);
        }
        if (params.ruleName) {
            urlParams +='&HH$RuleName=' + encodeURIComponent(params.ruleName);
        }
        urlParams += '&HH$pageSize='+encodeURIComponent(count);
        var res = sendRequest(finalUrl, 'alert',  urlParams).HedgehogXmlApi;
        var incidents = null;
        var newLastRun = null;
        if (res && res.alert && res.alert.length > 0) {
            //Create incidents
            incidents = alertsToIncident(res.alert);
            //Set last run
            newLastRun = calculateNewLastRun(res.alert);
        } else if (res && res.alert) {
            //This is a sinlge alert
            //Create incidents
            incidents = [alertToIncident(res.alert)];
            //Set last run
            newLastRun = calculateNewLastRun(res.alert);
        }
        if (newLastRun) {
            setLastRun({createDate: newLastRun});
        }
        return incidents;
    };

    // The command input arg holds the command sent from the user.
    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            sendRequest(finalUrl, 'sensor');
            return 'ok';
        case 'fetch-incidents':
            return JSON.stringify(fetchIncidents());
        case 'dam-get-alert-by-id':
            var jsonRes=sendRequest(finalUrl, 'alert', 'HH$Id=' + encodeURIComponent(args.id)).HedgehogXmlApi.alert;
            if (jsonRes) {
                var entryContext = {
                };
                md = alertToMd(jsonRes);
                return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
            } else {
                md = '### no alerts found\n';
                return {Type: entryTypes.note, Contents: null, ContentsFormat: formats.json, HumanReadable: md};
            }
        case 'dam-get-latest-by-rule':
            var count = args.count || 10;
            var timeBack = 1000 * 60 * (args.timeBack || 10);
            var res = sendRequest(finalUrl, 'alert', 'HH$RuleName=' + encodeURIComponent(args.ruleName) +
                '&HH$TimeBackPeriod='+encodeURIComponent(timeBack +'') + '&HH$pageSize='+encodeURIComponent(count)).HedgehogXmlApi;

            if (res && res.alert) {
                jsonRes = res.alert;
                var entryContext = {};
                md = alertsToMd(jsonRes);
                return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md};
            } else {
                md = '### no alerts found\n';
                return {Type: entryTypes.note, Contents: null, ContentsFormat: formats.json, HumanReadable: md};
            }
    }
  type: javascript
  commands:
  - name: dam-get-alert-by-id
    arguments:
    - name: id
      required: true
      default: true
      description: The alert ID
    outputs:
    - contentPath: id
      contextPath: AlertId
      description: DAM Alert ID
    - contentPath: accessedObjects.object.name
      contextPath: alertAccessedObjects
      description: DAM Accessed Objects
    - contentPath: execUser
      contextPath: dbUser
      description: DAM Database User
    - contentPath: osUser
      contextPath: Account.Username
      description: DAM OS User
    - contentPath: database
      contextPath: database
      description: DAM Database
    - contentPath: identifyingSensor
      contextPath: sensor
      description: DAM Sensor
    - contentPath: rules
      contextPath: rules
      description: DAM Rules
    description: Get a DAM alert from McAfee Database Activity Monitoring by alert
      ID
  - name: dam-get-latest-by-rule
    arguments:
    - name: ruleName
      required: true
      default: true
      description: Name of the rule that triggered the alert
    - name: count
      description: Number of alerts to retrieve, defaults to 10
    - name: timeBack
      description: Filter DAM alerts and import alerts that where created only in
        the last given minutes, defaults to last 10 minutes
    outputs:
    - contentPath: id
      contextPath: AlertId
      description: DAM Alert ID
    - contentPath: accessedObjects.object.name
      contextPath: alertAccessedObjects
      description: DAM Accessed Objects
    - contentPath: execUser
      contextPath: dbUser
      description: DAM Database User
    - contentPath: osUser
      contextPath: Account.Username
      description: DAM OS User
    - contentPath: database
      contextPath: database
      description: DAM Database
    - contentPath: identifyingSensor
      contextPath: sensor
      description: DAM Sensor
    - contentPath: rules
      contextPath: rules
      description: DAM Rules
    description: Get latest DAM alerts by rule name
  isfetch: true
