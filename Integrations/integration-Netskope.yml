commonfields:
  id: Netskope
  version: -1
name: Netskope
display: Netskope
category: Network Security
image: data:image/png;base64,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
description: Cloud access security broker that enables to find, understand, and secure
  cloud apps.
detaileddescription: 'You can grab the API token from your Netskope tenant by navigating
  to: Settings-->Manage-->REST API'
configuration:
- display: URL of Netskope Tenant (e.g. https://tenant.goskope.com)
  name: url
  defaultvalue: ""
  type: 0
  required: true
- display: Tenant API Token
  name: token
  defaultvalue: ""
  type: 4
  required: true
- display: Trust any certificate (not secure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Timeframe for initial fetch
  name: firstFetch
  defaultvalue: Last60Minutes
  type: 15
  required: false
  options:
  - Last60Minutes
  - Last24Hours
  - Last7Days
  - Last30Days
  - Last60Days
  - Last90Days
- display: Maximum number of events to fetch per fetch
  name: maxFetch
  defaultvalue: "50"
  type: 0
  required: false
script:
  script: |-
    var SERVER_URL = params.url.replace(/[\/]+$/, '');
    var BASE_URL = SERVER_URL + '/api/v1/';
    var TOKEN = params.token;

    function sendRequest(method, api) {
        var requestUrl = BASE_URL + api;
        var result = http(
            requestUrl,
            {
                Method: method,
                Headers: {
                    'Content-Type': ['application/json'],
                    'Accept': ['application/json']
                }
            },
            params.insecure,
            params.proxy
            );
        if (result.StatusCode < 200 && result.StatusCode > 299) {
            throw 'Failed to perform request ' + path + ', request status code: ' + result.StatusCode + ', body: ' + result.Body;
        }
        if (result.Body === '') {
            throw 'No content received.' + requestUrl + result;
        }
        var body;
        try {
            body = JSON.parse(result.Body);
        } catch (ex) {
            throw 'Error parsing reply - ' + result.Body + ' - ' + ex;
        }
        return body;
    }

    function normalizeTimestamp(timestamp) {
        return Date(timestamp);
    }

    function translateTimeperiod(timeperiod){
        var timeperiodTranslator = {
            'Last60Minutes': '3600',
            'Last24Hours': '86400',
            'Last7Days': '604800',
            'Last30Days': '2592000',
            'Last60Days': '5184000',
            'Last90Days': '7776000'
        };
        return timeperiodTranslator[timeperiod];
    }

    function translateMonthName(monthName) {
        var monthTranslator = {
            'january': 1,
            'february': 2,
            'march': 3,
            'april': 4,
            'may': 5,
            'june': 6,
            'july': 7,
            'august': 8,
            'september': 9,
            'october': 10,
            'november': 11,
            'december': 12
        };
        return monthTranslator[monthName];
    }

    /**
    * convert string formatted time to timestamp.
    * Note: Accept 2 string formats: "dd-mm-yyyyTHH:MM:SSZ" or "Month Day, Year HH:MM:SS".
    * @param {string} strDate - string formatted array
    * @return {string} timestamp
    */
    function toTimestamp(strDate){
        // accept: 31-12-1999T14:35:20Z
        var dateTuple = strDate.match('^(\\d{2})-(\\d{2})-(\\d{4})T(\\d{2}):(\\d{2}):(\\d{2})Z$');
        var timestamp;
        if (dateTuple !== null) {
            // first element is the entire match, then the individual matches.
            // months in Date JS are an integer between 0 and 11.
            timestamp = new Date(dateTuple[3], dateTuple[2] - 1, dateTuple[1], dateTuple[4], dateTuple[5], dateTuple[6]);
            return timestamp.getTime()/1000;
        }

        // accept: December 31, 1999 14:35:20
        dateTuple = strDate.toLowerCase().match('^(january|february|march|april|may|june|july|august|september|october|november|december) (\\d{1,2}), (\\d{4}) (\\d{2}):(\\d{2}):(\\d{2})$');
        if (dateTuple !== null) {
            timestamp = new Date(dateTuple[3], translateMonthName(dateTuple[1]) - 1, dateTuple[2], dateTuple[4], dateTuple[5], dateTuple[6]);
            return timestamp.getTime()/1000;
        }
        return strDate;
    }

    function getAlerts() {
        var queryArgs = {
            token: TOKEN,
            type: encodeURIComponent(args.type)
        };
        if (args.starttime && args.endtime) {
            queryArgs.starttime = toTimestamp(args.starttime);
            queryArgs.endtime = toTimestamp(args.endtime);
            if (args.timeperiod) {
                queryArgs.timeperiod = translateTimeperiod(args.timeperiod);
            }
            if (args.query) {
                queryArgs.query = encodeURIComponent(args.query);
            }
        } else if (args.timeperiod) {
            queryArgs.timeperiod = translateTimeperiod(args.timeperiod);
            if (args.query) {
                queryArgs.query = encodeURIComponent(args.query);
            }
        } else {
            throw 'Not given enough arguments to filter events by.';
        }

        var cmdUrl = 'alerts' + encodeToURLQuery(queryArgs);
        logInfo('Getting/Fetching Netskope Alerts (to be incidents) with ' + String(cmdUrl));
        var result = sendRequest('GET', cmdUrl);
        return result;
    }

    function getAlertsCommand() {
        result = getAlerts()
        var retArray = [];
        result.data.forEach(function(arrayItem) {
            var id = arrayItem._id;
            var app =  arrayItem.app;
            var timestamp =  normalizeTimestamp(arrayItem.timestamp);
            var dlp_profile =  arrayItem.dlp_profile;
            var dlp_file =  arrayItem.dlp_file;
            var hostname =  arrayItem.hostname;
            var policy =  arrayItem.policy;
            retArray.push({'ID': id, 'App' : app, 'Timestamp' : timestamp, 'DLPProfile' : dlp_profile, 'DLPFile' : dlp_file, 'Hostname' : hostname, 'Policy' : policy});
        });
        var ec = {
            "Netskope.Alerts(val.ID && val.ID === obj.ID)" : retArray
        };
        headers = ['ID', 'Timestamp', 'DLPProfile', 'DLPFile', 'Hostname', 'Policy'];
        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: result.data,
            ReadableContensFormat: formats.markdown,
            HumanReadable: tableToMarkdown('Netskope Alerts', retArray, headers),
            EntryContext: ec
        };
    }

    function getEvents() {
        var queryArgs = {
            token: TOKEN,
            type: encodeURIComponent(args.type)
        };
        if (args.starttime && args.endtime) {
            queryArgs.starttime = toTimestamp(args.starttime);
            queryArgs.endtime = toTimestamp(args.endtime);
            if (args.timeperiod) {
                queryArgs.timeperiod = translateTimeperiod(args.timeperiod);
            }
            if (args.query) {
                queryArgs.query = encodeURIComponent(args.query);
            }
        } else if (args.timeperiod) {
            queryArgs.timeperiod = translateTimeperiod(args.timeperiod);
            if (args.query) {
                queryArgs.query = encodeURIComponent(args.query);
            }
        } else {
            throw 'Not given enough arguments to filter events by.';
        }

        var cmdUrl = 'events' + encodeToURLQuery(queryArgs);
        var result = sendRequest('GET', cmdUrl);
        var retArray = [];
        result.data.forEach(function(arrayItem) {
            var id = arrayItem._id;
            var app =  arrayItem.app;
            var timestamp = normalizeTimestamp(arrayItem.timestamp);
            var activity =  arrayItem.activity;
            var object =  arrayItem.object;
            var hostname =  arrayItem.hostname;
            var category =  arrayItem.category;
            var device_classification =  arrayItem.device_classification;
            var user =  arrayItem.user;
            var from_user =  arrayItem.from_user;
            var to_user =  arrayItem.to_user;
            var srcip =  arrayItem.srcip;
            var access_method =  arrayItem.access_method;
            var url =  arrayItem.url;
            retArray.push({'ID': id, 'App' : app, 'Timestamp' : timestamp, 'Activity' : activity, 'Object' : object, 'Hostname' : hostname, 'AppCategory' : category, 'DeviceClassification' : device_classification, 'User' : user, 'FromUser' : from_user, 'ToUser' : to_user, 'SourceIP' : srcip, 'AccessMethod' : access_method, 'URL' : url});
        });
        var ec = {
            "Netskope.Events(val.ID && val.ID === obj.ID)" : retArray
        };
        headers = ['ID', 'App', 'Timestamp', 'Activity', 'Object', 'Hostname', 'AppCategory', 'DeviceClassification', 'User',
                   'FromUser', 'ToUser', 'SourceIP', 'AccessMethod', 'URL'];
        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: result.data,
            ReadableContensFormat: formats.markdown,
            HumanReadable: tableToMarkdown('Netskope Events', retArray, headers),
            EntryContext: ec
        };
    }

    function now() {
        return parseInt(new Date().getTime()/1000);
    }

    function fetchAlerts() {
        lastRun = getLastRun();
        last_run = parseInt(lastRun.lastTime);
        if (isNaN(last_run)) {
            last_run = now() - parseInt(translateTimeperiod(params.firstFetch));
        }

        args = {};
        args.type = "";
        args.starttime = last_run.toString();
        args.endtime = now().toString();
        alerts = getAlerts().data;
        var incidents = [];
        if (typeof alerts !== 'undefined') {
            alerts.reverse();  // alerts are fetched in descending order, reversing to process older first
            for (var i = 0; i < alerts.length; i++) {
                item = alerts[i];
                incident = {};
                d = new Date(item.timestamp);
                incident.occurred = d.toISOString();
                incident.name = item.alert_type + " - " + item.alert_name;
                incident.rawJSON = JSON.stringify(item);
                incidents.push(incident);
                last_run = item.timestamp;
                if (incidents >= Math.min(50, params.maxFetch)) {
                    break;
                }
            }
        }
        lastRun = {'lastTime': args.endtime};
        setLastRun(lastRun);
        logInfo('Netskope lastRun is: ' + String(args.endtime));
        return JSON.stringify(incidents);
    }

    switch (command) {
        case 'test-module':
            var queryArgs = {
                token: TOKEN,
                type: 'application',
                timeperiod: '3600',
                limit: '1'
            };
            var cmdUrl = 'events' + encodeToURLQuery(queryArgs);
            result = sendRequest('GET', cmdUrl);
            if (result.status != "error") {
                return 'ok';
            }
            return result;
        case 'fetch-incidents':
            return fetchAlerts();
        case 'netskope-events':
            return getEvents();
        case 'netskope-alerts':
            return getAlertsCommand();
    }
  type: javascript
  commands:
  - name: netskope-events
    arguments:
    - name: query
      description: filter query (e.g. user eq user1@domain.com)
    - name: timeperiod
      auto: PREDEFINED
      predefined:
      - Last60Minutes
      - Last24Hours
      - Last7Days
      - Last30Days
      - Last60Days
      - Last90Days
      description: TimePeriod
    - name: starttime
      description: 'Query start time: timestamp or dd-mm-yyyyTHH:MM:SSZ (e.g. 31-12-1999T11:59:59Z)'
    - name: endtime
      description: 'Query end time: timestamp or dd-mm-yyyyTHH:MM:SSZ (e.g. 31-12-1999T11:59:59Z)'
    - name: type
      required: true
      auto: PREDEFINED
      predefined:
      - application
      - page
      - audit
      description: Type of Event (e.g Application, Page, Audit)
    - name: limit
      description: Limit the number of events returned (useful for pagination in combination
        with skip). Positive integer less than 5000.
    - name: skip
      description: Skip over some of the events (useful for pagination in combination
        with limit)
    outputs:
    - contextPath: Netskope.Events.App
      description: Name of Application
      type: string
    - contextPath: Netskope.Events.Timestamp
      description: Timestamp of event
      type: string
    - contextPath: Netskope.Events.Activity
      description: Activity of event
      type: string
    - contextPath: Netskope.Events.Object
      description: Document/object from event
      type: string
    - contextPath: Netskope.Events.hostname
      description: Hostname of device
      type: string
    - contextPath: Netskope.Events.AppCategory
      description: Netskope application category (e.g. Cloud Storage, Webmail, etc)
      type: string
    - contextPath: Netskope.Events.device_classification
      description: Device classification (e.g. managed vs unmanaged)
      type: string
    - contextPath: Netskope.Events.User
      description: User
      type: string
    - contextPath: Netskope.Events.from_user
      description: Login IDs for cloud apps
      type: string
    - contextPath: Netskope.Events.to_user
      description: Destination user IDs
      type: string
    - contextPath: Netskope.Events.SourceIP
      description: Source IP
      type: string
    - contextPath: Netskope.Events.AccessMethod
      description: Access method (e.g. client, reverse proxy, Secure Forwarder, etc)
      type: string
    - contextPath: Netskope.Events.url
      description: URL
      type: string
    - contextPath: Netskope.Events.ID
      description: Event ID
      type: string
    description: Gets a list of events
  - name: netskope-alerts
    arguments:
    - name: type
      required: true
      auto: PREDEFINED
      predefined:
      - anomaly
      - Compromised Credential
      - DLP
      - Legal Hold
      - malsite
      - Malware
      - policy
      - quarantine
      - Remediation
      - watchlist
      description: Type of alert
    - name: timeperiod
      auto: PREDEFINED
      predefined:
      - Last60Minutes
      - Last24Hours
      - Last7Days
      - Last30Days
      - Last60Days
      - Last90Days
      description: Time period (e.g. Last 60 minutes, Last 24 hours, etc.)
    - name: starttime
      description: 'Query start time: timestamp or dd-mm-yyyyTHH:MM:SSZ (e.g., 31-12-1999T11:59:59Z)'
    - name: endtime
      description: 'Query end time: timestamp or dd-mm-yyyyTHH:MM:SSZ (e.g. 31-12-1999T11:59:59Z)'
    - name: query
      description: Valid event query described in the query language document
    outputs:
    - contextPath: Netskope.Alerts.App
      description: Name of Application
      type: string
    - contextPath: Netskope.Alerts.Timestamp
      description: Timestamp of event
      type: string
    - contextPath: Netskope.Alerts.Policy
      description: Name of Policy Triggered
      type: string
    - contextPath: Netskope.Alerts.DLPFile
      description: Name of DLP File that triggered
      type: string
    - contextPath: Netskope.Alerts.Hostname
      description: Hostname
      type: string
    - contextPath: Netskope.Alerts.ID
      description: Alert ID
      type: string
    description: Gets a list of alerts
  isfetch: true
  runonce: false
tests:
  - Netskope Test
