commonfields:
  id: PerceptionPointIncidentsHandler
  version: -1
name: PerceptionPointIncidentsHandler
display: PerceptionPointIncidentsHandler
category: Email Gateway
description: Load incidents from Perception Point system and release falsely quarantined
  emails
detaileddescription: |-
  Use your API token to:
                   1. View and manage your incidents list. The list will be updated automatically in Incidents dashboard.
                   2. Release email from quarantine and resend them to their recipients. Use the scan id as an argument.
  If you don't have a token yet, contact us at support@perception-point.io
  You can set the number of results returning by using the parameter "No. of API loops". Each loop returns 20 items top.
configuration:
- display: Token to use Perception Point's API
  name: pp_token
  defaultvalue: ""
  type: 0
  required: true
- display: Fetch blocked incidents
  name: fetch_blocked
  defaultvalue: ""
  type: 8
  required: false
- display: Fetch spam incidents
  name: fetch_spam
  defaultvalue: ""
  type: 8
  required: false
- display: Fetch malicious incidents
  name: fetch_malicious
  defaultvalue: ""
  type: 8
  required: false
- display: No. of API loops
  name: api_loops
  defaultvalue: "1"
  type: 0
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
script:
  script: |-
    ''' IMPORTS'''
    import requests
    import json
    import sys
    import urlparse
    from collections import defaultdict

    ''' INTEGRATION PARAMS '''
    URL = 'http://api.perception-point.io/api/v1/{endpoint}'
    INCIDENTS_ENDPOINT = 'scans/incidents/'
    RELEASE_ENDPOINT = 'quarantine/release/{id_}'

    USER_PARAMS = demisto.params()
    PP_TOKEN = demisto.params().pop('pp_token', None)
    try:
        API_MAX_LOOPS = int(USER_PARAMS.pop('api_loops', 1))
    except:
        API_MAX_LOOPS = 1
    HEADER = {'Authorization': 'Token {}'.format(PP_TOKEN)}


    ''' CONSTANTS '''
    RELEASE = 'release'
    LIST = 'list'
    API_ACTIONS_DICT = {RELEASE: RELEASE_ENDPOINT,
                        LIST: INCIDENTS_ENDPOINT}
    SPAM = 'SPM'
    BLOCKED = 'BLK'
    MALICIOUS = 'MAL'

    API_CURSOR_ARG = '_cursor'

    FETCH_INCIDENTS_TYPE = [{'demisto_param': 'fetch_malicious',
                       'req_pname': 'verbose_verdict',
                       'req_pval': MALICIOUS},
                      {'demisto_param': 'fetch_blocked',
                       'req_pname': 'verbose_verdict',
                       'req_pval': BLOCKED},
                      {'demisto_param': 'fetch_spam',
                       'req_pname': 'verbose_verdict',
                       'req_pval': SPAM}]


    ''' HELPER FUNCTIONS '''
    def build_fetch_incident_types(fetch_select):
        fetch_type_dict = defaultdict(list)
        for darg in FETCH_INCIDENTS_TYPE:
            darg_input = fetch_select.get(darg['demisto_param'])
            if darg_input:
                fetch_type_dict[darg['req_pname']].append(darg.get('req_pval', darg_input))
        for reqname, reqval in fetch_type_dict.iteritems():
            fetch_type_dict[reqname] = ','.join(reqval)
        return dict(fetch_type_dict)


    def create_incident(record):
        record.pop('Attachment', None)
        record['RawJSON'] = json.dumps(record)
        return record


    def collect_incidents(**kwargs):
        list_url = build_request_url(LIST)
        api_res = get_pp_api_result(url=list_url, **kwargs)
        num_of_results = api_res.get('count')
        incidents = []
        api_loops = 0
        while num_of_results and api_loops < API_MAX_LOOPS:
            incidents += map(create_incident, api_res.get('results'))
            if api_res.get('next'):
                api_res = get_pp_api_result(url=api_res.get('next'))
                num_of_results = api_res.get('count')
            api_loops += 1
        return incidents


    def report_incidents(incidents_list):
        demisto.incidents(incidents_list)


    def get_pp_api_result(url, **kwargs):
        try:
            res = requests.get(url=url,
                               params=kwargs,
                               headers=HEADER)
            res.raise_for_status()
            try:
                res_content = res.json()
            except:
                res_content = {}
            return res_content
        except Exception as e:
            return_error(e.message)


    def build_request_url(api_action):
        return URL.format(endpoint=API_ACTIONS_DICT.get(api_action))


    def command_fetch_incidents():
        try:
            args_dict = demisto.args()
            args_dict.update(USER_PARAMS)
            req_args = build_fetch_incident_types(args_dict)
            last_run_id = int(demisto.getLastRun().get('scan_id', 0))
            req_args[API_CURSOR_ARG] = last_run_id
            incidents_list = collect_incidents(**req_args)
            report_incidents(incidents_list)
            if incidents_list:
                last_run_id = max(last_run_id, int(incidents_list[-1].get('Scan Id')))
                demisto.setLastRun({'scan_id': int(last_run_id)})
        except:
            return_error(
                'An error occurred while trying to fetch new incidents. Please contact us at support@perception-point.io')


    def release_email_and_get_message(scan_id_to_release):
        try:
            release_url = build_request_url(RELEASE).format(id_=scan_id_to_release)
            _ = get_pp_api_result(url=release_url)
            return 'Email with id {} was released Successfully!'.format(scan_id_to_release)
        except:
            return 'An error occurred while trying to release email. Please contact us at support@perception-point.io'


    def command_release_email():
        scan_id_to_release = demisto.args().get('scan_id')
        entry = {
            'Type': entryTypes['note'],
            'ReadableContentsFormat': formats['markdown']
        }
        email_release_response = release_email_and_get_message(scan_id_to_release)
        entry.update({'Contents': email_release_response,
                      'ContentsFormat': formats['text']})
        demisto.results(entry)


    ''' COMMAND CLASSIFIER'''
    if demisto.command() == 'test-module':
        list_url = build_request_url(LIST)
        if get_pp_api_result(url=list_url):
            demisto.results('ok')
        sys.exit(0)
    if demisto.command() == 'fetch-incidents':
        command_fetch_incidents()
    if demisto.command() == 'release-email':
        command_release_email()
  type: python
  commands:
  - name: release-email
    arguments:
    - name: scan_id
      required: true
      description: The PP scan id of the email
    description: Resends an email that was falsely quarantined using the scan id
  dockerimage: demisto/python:1.3-alpine
  isfetch: true
  runonce: false