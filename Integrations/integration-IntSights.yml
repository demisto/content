versionedfields: {}
commonfields:
  id: IntSights
  version: -1
name: IntSights
display: IntSights
category: Forensics & Malware Analysis
image: data:image/png;base64,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
description: Use IntSights to manage and fetch alerts
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: IOCs type to fetch as incidents
  name: type
  defaultvalue: ""
  type: 0
  required: false
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
script:
  script: |
    var server = params.server.replace(/[\/]+$/, '') + '/';

    var FILE_TYPE = 9;
    var iocTypes = ['Domains', 'Urls', 'IpAddresses', 'Hashes'];

    var urlDictionary = {
        'login' : 'login',
        'logout': 'logout',
        'intsights-get-alerts': 'alerts',
        'intsights-get-alert-image': 'alerts/image/%AlertID%/%ImageID%',
        'intsights-get-alert-activities': 'alerts/get-activities/%AlertID%',
        'intsights-check-new-notifications': 'alerts/check-new',
        'intsights-get-notifications': 'alerts/get-notifications',
        'intsights-ask-the-analyst': 'alerts/ask-the-analyst/%AlertID%',
        'intsights-send-mail': 'alerts/mail-to-others/%AlertID%',
        'intsights-remediate': 'alerts/resolve-request/%AlertID%',
        'intsights-whitelist': 'alerts/report-white-list/%AlertID%',
        'intsights-assign': 'alerts/assign/%AlertID%',
        'intsights-unassign': 'alerts/unassign/%AlertID%',
        'intsights-tag': 'alerts/add-tag/%AlertID%',
        'intsights-untag': 'alerts/remove-tag/%AlertID%',
        'intsights-comment': 'alerts/comment/%AlertID%',
        'intsights-archive': 'alerts/archive/%AlertID%',
        'intsights-change-severity': 'alerts/change-severity/%AlertID%',

        'intsights-get-alert-by-id': 'alerts/get-alert',
        'intsights-get-alert-preview': 'alerts/preview/%AlertID%',
        'intsights-get-alert-db-file': 'alerts/db-file/%AlertID%',
        'intsights-get-alert-whois-file': 'alerts/whois-file/%AlertID%',

        'intsights-mark-alert-as-read': 'alerts/read/%AlertID%',
        'intsights-mark-notifications-as-read': 'alerts/mark-notifications-as-read',

        'intsights-get-iocs': 'iocs/iocs-by-type',
        'intsights-search-iocs': 'iocs/search',
        'intsights-ioc-download-csv': 'iocs/download-csv'
    };

    var methodDictionary = {
        'login': 'POST',
        'logout': 'GET',
        'intsights-get-accounts': 'GET',
        'intsights-get-alerts': 'GET',
        'intsights-get-alert-image': 'GET',
        'intsights-get-alert-activities': 'GET',
        'intsights-check-new-notifications': 'GET',
        'intsights-get-notifications': 'GET',
        'intsights-ask-the-analyst': 'POST',
        'intsights-send-mail': 'POST',
        'intsights-remediate': 'PATCH',
        'intsights-whitelist': 'PATCH',
        'intsights-assign': 'PATCH',
        'intsights-unassign': 'PATCH',
        'intsights-tag': 'PATCH',
        'intsights-untag': 'PATCH',
        'intsights-comment': 'PATCH',
        'intsights-archive': 'PATCH',
        'intsights-change-severity': 'PATCH',

        'intsights-get-alert-by-id': 'GET',
        'intsights-get-alert-preview': 'GET',
        'intsights-get-alert-db-file': 'GET',
        'intsights-get-alert-whois-file': 'GET',

        'intsights-mark-alert-as-read': 'PATCH',
        'intsights-mark-notifications-as-read': 'POST',

        'intsights-get-iocs': 'GET',
        'intsights-search-iocs': 'GET',
        'intsights-ioc-download-csv': 'GET'
    };

    var outputsDictionary = {
        'intsights-get-alerts': [
            {from: '_id', to: 'ID'},
            {from: 'FoundDate', to: 'Found Date'},
            {from: 'Details.Title', to: 'Title'},
            {from: 'Details.Type', to: 'Type'},
            {from: 'Details.Severity', to: 'Severity'},
            {from: 'Details.Source', to: 'Source', parser: function(src) {
                return 'Type: {0}\nNetwork Type: {1}\nURL: {2}\nDate: {3}'.format(src.Type, src.NetworkType, src.URL, src.Date)
            }},
            {from: 'Details.Description', to: 'Description'},
            {from: 'Details.Recommendations', to: 'Recommendations'},
        ],

        'intsights-get-alert-activities': [
            {from: 'Type', to: 'Type'},
            {from: 'Initiator', to: 'Initiator', parser: function(initiator) {
                return 'First Name: {0}\nLast Name: {1}'.format(initiator.FirstName, initiator.LastName)
            }},
            {from: 'CreatedDate', to: 'Created Date'},
            {from: 'UpdateDate', to: 'Update Date'},
            {from: '_id', to: 'ID'},
            {from: 'ReadBy', to: 'Read By', parser: function(readBy) {
                return readBy.join('\n');
            }},
            {from: 'IsRead', to: 'Is Read'}
        ],

        'intsights-check-new-notifications': [
            {from: 'HasNew', to: 'Has New', parser: function(hasNew) {return '{0}'.format(hasNew)}},
            {from: 'Date', to: 'Date'},
        ],

        'intsights-get-notifications': [
            {from: '_id', to: 'ID'},
            {from: 'Date', to: 'Date'},
            {from: 'NotificationType', to: 'Notification Type'},
            {from: 'Type', to: 'Type'},
            {from: 'Severity', to: 'Severity'},
        ],

        'intsights-get-iocs': [
            {from: 'AccountID', to: 'Account ID'},
            {from: 'FirstSeen', to: 'First Seen'},
            {from: 'LastSeen', to: 'Last Seen'},
            {from: 'SourceID', to: 'Source ID'},
            {from: 'Type', to: 'Type'},
            {from: 'Value', to: 'Value'},
            {from: '_id', to: 'ID'}
        ],

        'intsights-search-iocs': [
            {from: 'ResultType', to: 'Result Type'},
            {from: '_id', to: 'ID'},
            {from: 'document.Compaign.AssociatedThreatActors', to: 'Campaign Threat Actors', parser: joinLines},
            {from: 'document.Compaign.CampaignType', to: 'Campaign Type'},
            {from: 'document.Compaign.SocialMediaProfilesOrGroups', to: 'Social Media', parser: joinLines},
            {from: 'document.Compaign.TTPs', to: 'TTPs', parser: joinLines},
            {from: 'document.Hashtags', to: 'Hashtags', parser: joinLines},
            {from: 'document.Image', to: 'Image'},
            {from: 'document.Malware', to: 'Malware'},
            {from: 'document.Name', to: 'Name'},
            {from: 'document.Nationalities', to: 'Nationalities', parser: joinLines},
            {from: 'document.OtherNames', to: 'Other Names'},
            {from: 'document.TargetedSectors', to: 'Targeted Sectors', parser: joinLines},
            {from: 'document.TargetedStates', to: 'Targeted States', parser: joinLines},
            {from: 'document.ThreatActor', to: 'Threat Actor'},
            {from: 'document.Type', to: 'Document Type'},
            {from: 'document.Thumb', to: 'Thumb'},
            {from: 'document._id', to: 'Document ID'},
        ]
    };

    var headersDictionary = {
        'intsights-get-alerts': ['Found Date', 'Title', 'Type', 'Severity', 'Source', 'Description', 'Recommendations', 'ID'],
        'intsights-get-alert-activities': ['ID', 'Type', 'Initiator', 'Created Date', 'Update Date', 'Read By', 'Is Read'],
        'intsights-check-new-notifications': ['Date', 'Has New'],
        'intsights-get-notifications': ['ID', 'Date', 'Notification Type', 'Type', 'Severity'],
        'intsights-get-iocs': ['ID', 'Type', 'Value', 'Source ID', 'First Seen', 'Last Seen', 'Account ID'],
        'intsights-search-iocs': ['ID', 'Result Type', 'Document Type', 'Document ID', 'Name', 'Nationalities', 'Severity', 'Targeted Sectors', 'Targeted States', 'Malware', 'Campaign Type', 'Campaign Threat Actors', 'Social Media', 'TTPs', 'Hashtags', 'Imgae', 'Hashtags', 'Image', 'OtherNames', 'Thumb', 'Threat Actor'],
    }

    var contextsDictionary = {
        'intsights-get-alerts': 'Alerts',
        'intsights-get-alert-activities': 'AlertActivities',
        'intsights-get-notifications': 'Notifications',
        'intsights-get-iocs': 'IOCs',
        'intsights-search-iocs': 'SearchedIOCs'
    }

    var rawOutputCommands = [
        'intsights-ask-the-analyst',
        'intsights-send-mail',
        'intsights-remediate',
        'intsights-whitelist',
        'intsights-assign',
        'intsights-unassign',
        'intsights-tag',
        'intsights-untag',
        'intsights-comment',
        'intsights-archive',
        'intsights-change-severity',
        'intsights-mark-alert-as-read',
        'intsights-mark-notifications-as-read',
    ]

    var mapObjFunction = function(mapFields, isOutput) {
        return function(obj) {
            var res = {};
            mapFields.forEach(function(f) {
                if (f.parser && isOutput && isOutput === true) {
                    res[f.to] = f.parser(dq(obj, f.from)) || null;
                } else {
                    res[f.to] = dq(obj, f.from);
                }
            });

            return res;
        }
    }

    var joinLines = function(lines) {
        return lines.join('\n');
    }

    var buildEmptyEntryContext = function() {
        return {Type: entryTypes.note, Contents: null, ContentsFormat: formats.json, EntryContext: {}};
    }

    var getUrl = function(command, args) {
        var url = urlDictionary[command];
        if (args) {
            url = replaceInTemplatesAndRemove(url, args);
        }

        return url + (methodDictionary[command] === 'GET' && args ? encodeToURLQuery(args) : '');
    }

    var createBody = function(command, args) {
        return args ? JSON.stringify(args) : undefined;
    }

    var sendRequest = function(method, url, body, authCookies, logout) {
        var httpParams = {
            Method: method,
            Headers: {
                'Content-Type': ['application/json']
            }
        };

        if (authCookies) {
            httpParams.Cookies = authCookies;
        }

        if (method !== 'GET' && body) {
            httpParams.Body = body;
        }

        var completeUrl = server + url;
        var res = http(completeUrl, httpParams, params.insecure, params.proxy);

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            if (!logout) {
                sendRequest(
                    methodDictionary['logout'],
                    getUrl('logout'),
                    undefined,
                    authCookies,
                    true
                );
            }
            // throw 'Request to IntSights Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res.Body) + '.';
            throw 'Request to IntSights Failed';
        }

        return res;
    }

    var createFileName = function(command, args) {
        var currentTime = new Date();
        var fileName = command;
        var keys = Object.keys(args);
        for (var i = 0; i < keys.length; i++) {
            fileName += '_' + keys[i] + '-' + args[keys[i]];
        }

        return fileName + '_at_' + currentTime.getTime();
    }

    var createIncidentFromIOC = function(ioc) {
        var keys = Object.keys(ioc);
        var labels = [];
        for (var i = 0; i<keys.length; i++) {
            labels.push({'type': keys[i], 'value': String(ioc[keys[i]])});
        }

        return {
            'name': ioc.Type + ' ' + ioc.Value,
            'labels': labels,
            'rawJSON': JSON.stringify(ioc),
        };
    }

    var login = function() {
        return sendRequest(
            methodDictionary['login'],
            getUrl('login'),
            createBody(
                'login',
                {Email: params.credentials.identifier, Password: params.credentials.password, Type: 'pass'}
            )
        ).Cookies;
    }

    var getIocsTotal = function() {
        var entries = [];
        for (var i = 0; i < iocTypes.length; i++) {
            args.Type = iocTypes[i];
            var res = sendRequest(methodDictionary[command], getUrl(command, args), createBody(command, args), loginCookies).Body;
            try {
              result = JSON.parse(res);
            } catch (err) {
              throw 'JSON parsing failed, body: ' + res;
            }
            entries.push(parseResponse('intsights-get-iocs', result))
        }

        return entries;
    }

    var parseResponse = function(command, response) {
        var entry = buildEmptyEntryContext();
        var outputs = [];

        if (rawOutputCommands.indexOf(command) != -1) {
            outputs = response;
        } else {
            if (command == 'intsights-get-alert-by-id') {
                if (response.Success !== true) {
                    throw response.Data;
                }
                command = 'intsights-get-alerts';
            }

            var data = dq(response, 'Data');
            if (command == 'intsights-get-notifications') {
                data = dq(data, 'Results');
            } else if (command == 'intsights-get-iocs') {
                // go in one more level
                data = dq(data, 'Data');
            }

            if (data.constructor !== Array) {
                data = [data];
            }

            for (var i = 0; i < data.length; i++) {
                var output = mapObjFunction(outputsDictionary[command], true)(data[i]);
                outputs.push(output);
            }

            entry.Contents = data;
            entry.ContentsFormat = formats.json;
        }

        entry.HumanReadable = tblToMd('IntSights: ' + command, outputs, headersDictionary[command]);

        if (Object.keys(contextsDictionary).indexOf(command) != -1) {
            var contextKey = contextsDictionary[command];
            var contexts = dq(response, 'Data');

            if (command == 'intsights-get-iocs') {
                // go in one more level
                contexts = dq(contexts, 'Data');
            }

            entry.EntryContext = {};
            entry.EntryContext['IntSights.' + contextKey] = contexts;
        }

        return entry;
    }

    var getAlerts = function(startTime) {
        command = 'intsights-get-alerts';
        args.DateFrom = startTime;
        var res = sendRequest(methodDictionary[command], getUrl(command, args), createBody(command, args), loginCookies).Body;
        try {
          result = JSON.parse(res);
        } catch (err) {
          throw 'JSON parsing failed, body: ' + res;
        }
        return result;
    }

    var createIncidentFromAlert = function(alert) {
        return {
            name: 'IntSights alert ' + alert._id,
            rawJSON: JSON.stringify(alert)
        }
    }

    var fetchIncidents = function(loginCookies) {
        var lastRun = getLastRun();
        var startTime = lastRun && lastRun.startTime ? lastRun.startTime : 0;
        var res = getAlerts(startTime);
        var incidents = [];
        for (var i = 0; i < res.Data.length; i++) {
            var alert = res.Data[i];
            startTime = Math.max(startTime, Date.parse(alert.FoundDate));
            incidents.push(createIncidentFromAlert(alert));
        }
        setLastRun({startTime: startTime});

        return JSON.stringify(incidents);
    }

    var loginCookies = login();

    var result;
    var shouldParseResponse = false;
    switch (command) {
        case 'test-module':
            result = loginCookies ? 'ok' : 'login failed';
            break;

        case 'fetch-incidents':
            result = fetchIncidents(loginCookies);
            break;

        case 'intsights-get-alert-image':
        case 'intsights-get-alert-db-file':
        case 'intsights-get-alert-whois-file':
        case 'intsights-ioc-download-csv':
            var fileName = createFileName(command, args);
            result = {
                Type: FILE_TYPE,
                FileID: saveFile(
                    sendRequest(
                        methodDictionary[command],
                        getUrl(command, args),
                        createBody(command, args),
                        loginCookies
                    ).Body
                ),
                File: fileName,
                Contents: fileName
            };
            break;

        case 'intsights-send-mail':
            // convert comma-separated to array
            args.Emails = args.Emails.split(',');
            break;

        case 'intsights-get-iocs-total':
            command = 'intsights-get-iocs';
            result = getIocsTotal();
            break;

        case 'intsights-whitelist':
            args.IsHidden = JSON.parse(args.IsHidden);

        case 'intsights-archive':
            args.IsArchived = JSON.parse(args.IsArchived);

        default:
            res = sendRequest(
                         methodDictionary[command],
                         getUrl(command, args),
                         createBody(command, args),
                         loginCookies
                     ).Body;
            try {
              result = JSON.parse(res);
            } catch (err) {
              throw 'JSON parsing failed, body: ' + res;
            }

            shouldParseResponse = true;
    }

    // logout
    sendRequest(methodDictionary['logout'], getUrl('logout'), undefined, loginCookies, true);

    return shouldParseResponse ? parseResponse(command, result) : result;
  type: javascript
  commands:
  - name: intsights-get-alerts
    arguments:
    - name: NumOfResultForPage
      description: Number of results per page
    - name: PageNumber
      description: Page number
    - name: DateFrom
      description: Start date to fetch from (GMT+0 time), format "YYYY-MM-DDTHH-mm-ss"
    - name: DateTo
      description: End date to fetch from (GMT+0 time), format "YYYY-MM-DDTHH-mm-ss"
    - name: Accounts
      description: Alert's customer by customer ID.  Can be multiple seperated by
        commas
    - name: ShowArchived
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Show/Hide archived alerts
    - name: Type
      auto: PREDEFINED
      predefined:
      - AttackIndication
      - DataLeakage
      - Phishing
      - BrandSecurity
      - ExploitableData
      - vip
      description: Alert's type.  Can be multiple seperated by commas
    - name: ResolveStatus
      auto: PREDEFINED
      predefined:
      - NotSent
      - Sent
      - Response
      - Resolved
      description: Alert's resolve status.  Can be multiple seperated by commas
    - name: NetworkType
      auto: PREDEFINED
      predefined:
      - ClearWeb
      - DarkWeb
      description: Alert's network type.  Can be multiple seperated by commas
    - name: Source
      auto: PREDEFINED
      predefined:
      - ApplicationStores
      - BlackMarkets
      - HackingForums
      - SocialMedia
      - PasteSites
      - Others
      description: Alert's source type.  Can be multiple seperated by commas
    - name: Assigned
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Show only assigned alerts
    - name: IsRead
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Show only read/unread alerts
    - name: FreeText
      description: searches in Title, Description and source URL and alert ID
    outputs:
    - contextPath: IntSights.Alerts
      description: Alerts details
    description: Fetch alerts
  - name: intsights-get-alert-image
    arguments:
    - name: AlertID
      required: true
      default: true
      description: Alert's unique ID
    - name: ImageID
      required: true
      description: Image's unique ID
    description: Get's alert's image by ID
  - name: intsights-get-alert-activities
    arguments:
    - name: AlertID
      required: true
      default: true
      description: Alert's unique ID
    outputs:
    - contextPath: IntSights.AlertActivities
      description: Alert activities details
    description: Get all alert's activities
  - name: intsights-check-new-notifications
    arguments:
    - name: Date
      required: true
      default: true
      description: Checks for new notifications after this date, format "YYYY-MM-DDTHH-mm-ss"
    description: Checks if there are new notifications after the given date
  - name: intsights-get-notifications
    arguments:
    - name: NumOfResultForPage
      description: Number of notifications per page
    - name: PageNumber
      description: Page number
    outputs:
    - contextPath: IntSights.Notifications
      description: Notifications details
    description: Returns list of the user's unread alerts and activities
  - name: intsights-ask-the-analyst
    arguments:
    - name: AlertID
      required: true
      default: true
      description: Alert's unique ID
    - name: Question
      required: true
      description: Question added to the alert details
    description: Send a question to Intsgights analyst about the requested alert
  - name: intsights-send-mail
    arguments:
    - name: AlertID
      required: true
      default: true
      description: Alert's unique ID
    - name: Emails
      required: true
      description: Destination email addresses array (comma-separated)
    - name: Question
      required: true
      description: Question added to the alert details
    description: Send mail with the alert details and a question
  - name: intsights-remediate
    arguments:
    - name: AlertID
      required: true
      default: true
      description: Alert's unique ID
    description: Send resolve request on the selected alert
  - name: intsights-whitelist
    arguments:
    - name: AlertID
      required: true
      default: true
      description: Alert's unique ID
    - name: WhiteListReason
      required: true
      description: White list reason (text)
    - name: IsHidden
      required: true
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Whether to hide the alert as well or not
    description: Report the alert as white list
  - name: intsights-assign
    arguments:
    - name: AlertID
      required: true
      default: true
      description: Alert's unique ID
    - name: AssigneeID
      required: true
      description: Assigned user ID
    description: Assign an alert
  - name: intsights-unassign
    arguments:
    - name: AlertID
      required: true
      default: true
      description: Alert's unique ID
    description: Unassign an alert
  - name: intsights-tag
    arguments:
    - name: AlertID
      required: true
      default: true
      description: Alert's unique ID
    - name: TagName
      required: true
      description: The new tag string
    description: Adds a tag to the alert
  - name: intsights-untag
    arguments:
    - name: AlertID
      required: true
      default: true
      description: Alert's unique ID
    - name: TagID
      required: true
      description: Tags's unique ID to remove
    description: Removes a tag from the alert
  - name: intsights-comment
    arguments:
    - name: AlertID
      required: true
      default: true
      description: Alert's unique ID
    - name: Comment
      required: true
      description: Desired comment
    description: Add a comment to the alert
  - name: intsights-archive
    arguments:
    - name: AlertID
      required: true
      default: true
      description: Alert's unique ID
    - name: IsArchived
      required: true
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Desired archive status of the alert
    description: Archive or Un-archive an alert
  - name: intsights-get-alert-db-file
    arguments:
    - name: AlertID
      required: true
      default: true
      description: Alert's unique ID
    description: Get's alert's DB file by ID
  - name: intsights-mark-alert-as-read
    arguments:
    - name: AlertID
      required: true
      description: Alert's unique ID
    description: Marks the alert as read by the current user
  - name: intsights-get-alert-whois-file
    arguments:
    - name: AlertID
      required: true
      default: true
      description: Alert's unique ID
    description: Get's alert's WHOIS file by ID
  - name: intsights-get-iocs
    arguments:
    - name: Type
      required: true
      auto: PREDEFINED
      predefined:
      - Urls
      - Hashes
      - IpAddresses
      - Domains
      description: IOC's type
    - name: NumOfResultForPage
      description: Number of results per page
    - name: PageNumber
      description: Zero based page number
    - name: FreeText
      description: Search for IOC value
    outputs:
    - contextPath: IntSights.IOCs
      description: IOCs details
    description: Get count totals of the available IOCs
  - name: intsights-search-iocs
    arguments:
    - name: Value
      required: true
      default: true
      description: Desired IOC value
    outputs:
    - contextPath: IntSights.SearchedIOCs
      description: Searched IOCs details
    description: Search for exact IOC value
  - name: intsights-ioc-download-csv
    arguments:
    - name: Type
      required: true
      default: true
      auto: PREDEFINED
      predefined:
      - Urls
      - Hashes
      - IpAddresses
      - Domains
      description: IOC's type
    - name: SubType
      description: CnC,Tor,Phishing
    description: Get CSV of the requested IOC type
  - name: intsights-change-severity
    arguments:
    - name: AlertID
      required: true
      description: Alert's unique ID
    - name: Severity
      required: true
      auto: PREDEFINED
      predefined:
      - High
      - Medium
      - Low
      description: The desired severity
    description: Change the alert's severity
  - name: intsights-get-alert-by-id
    arguments:
    - name: AlertId
      required: true
      description: Alert's unique ID
    outputs:
    - contextPath: IntSights.Alerts
      description: Alerts details
    description: Returns alert object by alert ID
  - name: intsights-mark-notifications-as-read
    arguments: []
    description: Marks all notifications as read by the current user
  - name: intsights-get-iocs-total
    arguments:
    - name: NumOfResultForPage
      description: Number of results per page
    - name: PageNumber
      description: Zero based page number
    - name: FreeText
      description: Search for IOC value
    outputs:
    - contextPath: IntSights.IOCs
      description: IOCs details
    description: Get all the IOCs
  isfetch: true
hidden: false
