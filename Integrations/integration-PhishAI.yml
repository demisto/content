commonfields:
  id: Phish.AI
  version: -1
name: Phish.AI
display: Phish.AI
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: Next-Generation Anti-Phishing Platform Powered by AI & Computer VIsion
releaseNotes: "remove runonce field"
configuration:
- display: Private API Key (Optional)
  name: apiKey
  defaultvalue: ""
  type: 0
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "false"
  type: 8
  required: false
script:
  script: |2

    var TIMEOUT = 20 * 1000;
    var DONT_CHECK_CERTIFICATE = false;

    function phishAiScan(url, apiKey) {
        var ec = {
            PhishAI: {Url: url},
            DBotScore: {
                Indicator: url,
                Score: 0,
                Type: 'url',
                Vendor: 'Phish.AI'
            }
        };

        var md = '## Phish.AI Analysis for ' + url + '\n';

        var initialRes = http(
            'https://app.phish.ai/api/url/scan',
            {
                Method: 'POST',
                Headers: {
                    'Content-Type': ['application/json'],
                    'Accept': ['application/json'],
                    'Authorization': [apiKey]
                },
                Body: JSON.stringify({'url': url})
            },
            DONT_CHECK_CERTIFICATE,
            params.proxy
        );
        if (initialRes.StatusCode !== 200 && initialRes.StatusCode !== 201) {
            throw 'Failed to send url ' + url + ' for scan. Response error: ' + initialRes.Body;
        }

        var scanId = JSON.parse(initialRes.Body).scan_id;

        var startTime = new Date();
        startTime = startTime.getMilliseconds();

        var endTime = new Date();
        endTime = endTime.getMilliseconds();
        var res;
        while ((endTime - startTime) < TIMEOUT) {
            res = http(
                'https://app.phish.ai/api/url/report?scan_id=' + scanId,
                {
                    Method: 'GET',
                    Headers: {
                        'Accept': ['application/json'],
                        'Authorization': [apiKey]
                    }
                },
                DONT_CHECK_CERTIFICATE,
                params.proxy
            );
            if (res.StatusCode !== 200) {
                throw 'Failed to get scan results for ' + url + '. scan_id: ' + scanId + '. Response error: ' + res.Body;
            }
            var report = JSON.parse(res.Body);
            if (report.status !== 'in progress') {
                delete report.user_email;
                if (report.verdict == 'malicious') {
                    ec.DBotScore.Score = 3;
                    addMalicious(ec, url, {
                        Data: url,
                        Malicious: {
                            Vendor: 'Phish.AI',
                            Description: 'URL classified as phishing by Phish.AI'
                        }
                    });
                }
                ec.PhishAI.IpAddress = report.ip_address;
                ec.PhishAI.Hostname = report.domain;
                ec.PhishAI.Country = report.iso_code;
                // if we sending both domain and url to the war-room in the human readable we would run the test again for the domain since it doesn't have the http:// part
                if (url === report.url){
                    delete report.domain;
                } else if (url === report.domain){
                    delete report.url;
                }
                md = tableToMarkdown('Phish.AI Scan report ' + url, report);
                return {
                    Type: entryTypes.note,
                    Contents: report,
                    ContentsFormat: formats.json,
                    HumanReadable: md,
                    EntryContext: {
                        'Url(obj.Data.Url && obj.Data.Url===val.Data.Url)' : {
                            'Data': ec.PhishAI.Url
                        },
                        'IP(obj.Hostname && obj.Hostname===val.Hostname)' : {
                            'Address': ec.PhishAI.IpAddress,
                            'Hostname': ec.PhishAI.Hostname,
                            'Geo':{
                                'Country':ec.PhishAI.Country
                            }
                        },
                        'DBotScore' : ec.DBotScore
                    }
                };
            }
            logInfo('scan in progress');
        }
        return {
            Type: entryType.error,
            Contents: JSON.parse(res.Body),
            HumanReadable: "Scan timed out"
        };
    }

    switch (command) {
        case 'test-module':
            var res = phishAiScan('https://www.demisto.com/', params.apiKey);
            if (res && res.Type){
                return 'ok';
            } else {
                return 'error';
            }
            break;
        case 'url':
            return phishAiScan(args.url, params.apiKey);
        default:
            break;
    }
  type: javascript
  commands:
  - name: url
    arguments:
    - name: url
      required: true
      description: url to check
    outputs:
    - contextPath: URL.Data
      description: URL address
      type: string
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
      type: string
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
      type: string
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    - contextPath: DBotScore.Score
      description: The actual score
    - contextPath: IP.Address
      description: IP address of the url
      type: string
    - contextPath: IP.Geo.Country
      description: Geo location of the url
      type: string
    description: Check if url is phishing and get details about the brand that is
      being phished
