commonfields:
  id: QRadar
  version: -1
name: QRadar
display: IBM QRadar
category: Analytics & SIEM
image: data:image/png;base64,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
description: Get incidents and search QRadar
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Username
  name: credentials
  defaultvalue: ""
  type: 9
  required: false
- display: Authentication token
  name: token
  defaultvalue: ""
  type: 4
  required: false
- display: Query to fetch offenses
  name: query
  defaultvalue: ""
  type: 0
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: "Number of offenses to pull per API call (max: 50)"
  name: offensesPerCall
  defaultvalue: "50"
  type: 0
  required: false
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: "true"
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "true"
  type: 8
  required: false
script:
  script: |-
    // The command input arg holds the command sent from the user.
    var username = params.credentials ? params.credentials.identifier : '';
    var password = params.credentials ? params.credentials.password : '';
    var token = params.token;
    if (!token && !password) {
        throw 'Either credentials or auth token should be provided.'
    }
    var server = params.server+'/';
    var insecure = params.insecure;
    var query = params.query;
    var offensesPerCall = parseInt(params.offensesPerCall || 50);
    offensesPerCall = offensesPerCall > 50 ? 50 : offensesPerCall;
    var createIncidentFromOffense = function(incident) {
        var keys = Object.keys(incident);
        var labels = [];
        var occured = (new Date(incident.start_time)).toISOString();
        for (var i = 0; i<keys.length; i++) {
            labels.push({'type': keys[i], 'value': String(incident[keys[i]])});
        }

        return {
            "name": incident.id + ' ' + incident.description,
            "labels": labels,
            "rawJSON": JSON.stringify(incident),
            "occurred": occured
        }
    }

    var sendRequest = function(method, url, headers, queryName, body) {
        var httpParams = {
                    Headers: headers,
                    Method: method,
                    Body: body,
                };
        if (token) {
            if (!httpParams.Headers) {
                httpParams.Headers = {};
            }
            httpParams.Headers['SEC'] = [token];
        } else {
            httpParams.Username = username;
            httpParams.Password = password;
        }
        var res = http(
                url,
                httpParams,
                insecure,
                params.proxy
            );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Failed to ' + queryName + ', request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }
        try {
          return JSON.parse(res.Body);
        } catch (err) {
            logInfo('QRadar error: Could stringify respons for ' + url + '. Error is ' + err + '. Returned body is ' + res.Body);
            throw 'QRadar error\n Could stringify respons for ' + url + '\n Error is ' + err + '\n Returned body is ' + res.Body;
        }
    }

    var getOffenses = function(filter, fields, range) {
        var urlArgs = {};
        if (filter) {
            urlArgs.filter = filter;
        }
        if (fields) {
            urlArgs.fields = fields;
        }
        var headers = {'Content-Type': ['application/json']};
        if (range) {
            headers.Range = ['items=' + range];
        }
        return sendRequest('GET', server + 'api/siem/offenses' + encodeToURLQuery(urlArgs), headers, 'siem offenses');
    }

    var search = function(query_expression, fields) {
        var urlArgs = {query_expression: query_expression};
        if (fields) {
            urlArgs.fields = fields;
        }
        return sendRequest('POST', server + 'api/ariel/searches' + encodeToURLQuery(urlArgs), {'Content-Type': ['application/json']}, 'searches');
    }

    var getClosingReasons = function(filter, fields, include_deleted, include_reserved, range) {
        var urlArgs = {};
        if (filter) {
            urlArgs.filter = filter;
        }
        if (fields) {
            urlArgs.fields = fields;
        }
        if (include_deleted) {
            urlArgs.include_deleted = include_deleted;
        }
        if (include_reserved) {
            urlArgs.include_reserved = include_reserved;
        }
        var headers = {'Content-Type': ['application/json']};
        if (range) {
            headers.Range = ['items=' + range];
        }
        return sendRequest('GET', server + 'api/siem/offense_closing_reasons' + encodeToURLQuery(urlArgs), headers);
    }

    var getSearch = function(search_id, fields) {
        var urlArgs = {};
        if (fields) {
            urlArgs.fields = fields;
        }
        return sendRequest('GET', server + 'api/ariel/searches/' + search_id + encodeToURLQuery(urlArgs), {'Content-Type': ['application/json']}, 'get search');
    }

    var getSearchResults = function(search_id, range) {
        var headers = {'Content-Type': ['application/json']};
        if (range) {
            headers.Range = ['items=' + range];
        }
        return sendRequest('GET', server + 'api/ariel/searches/' + search_id + '/results', headers, 'get search results');
    }

    var getAssets = function(query_expression, fields, range) {
        var headers = {'Content-Type': ['application/json']};
        if (range) {
            headers.Range = ['items=' + range];
        }
        var urlArgs = {};
        if (fields) {
            urlArgs.fields = fields;
        }
        if (query_expression) {
            urlArgs.query_expression = query_expression;
        }
        return sendRequest('GET', server + 'api/asset_model/assets' + encodeToURLQuery(urlArgs), headers, 'get-assets');
    }

    var addHumanRedable = function(object, title, headers, path) {
      var obj = path ? dq(object, path) : object;
      return {
        Type: entryTypes.note,
        Contents: object,
        ContentsFormat: formats.json,
        HumanReadable: obj && ((obj instanceof Array && obj.length >0) || (obj instanceof Object && Object.keys(obj).length > 0)) ? tblToMd(title, obj, headers) : 'no results'
      };
    }

    var updateOffense = function(offense_id, args) {
        if (!args['closing_reason_id'] && args['status'] === 'CLOSED') {
            throw 'Invalid input - must provide closing reason id (may use "qradar-get-closing-reasons" command to get them) to close offense';
        }
        var booleanFields = ['protected', 'follow_up'];
        var keys = Object.keys(args);
        for (var i = 0; i < keys.length; i++) {
            if (keys[i] === 'closing_reason_id') {
                args[keys[i]] = parseInt(args[keys[i]]);
            }
            if (booleanFields.indexOf(keys[i]) !== -1) {
                args[keys[i]] = args[keys[i]] === 'true';
            }
        }
        return sendRequest(
            'POST', server + 'api/siem/offenses/' + offense_id + encodeToURLQuery(args),
            undefined,
            'update offense'
            );
    }
    var headers = args.headers;
    if (headers) {
        headers = headers.split(',');
    }
    delete(args.headers);
    var findLastPagePos = function (fetchQuery) {
        // make sure it's not a fluke and we simply have exactly offensePerCall results
        if (getOffenses(fetchQuery, undefined, offensesPerCall + '-' + offensesPerCall).length == 0) {
            return offensesPerCall-1;
        }
        // search up until we don't have any more results
        pos = offensesPerCall*2;
        while (getOffenses(fetchQuery, undefined, pos + '-' + pos).length == 1) {
            pos *= 2;
        }
        // binary search the gap from the last step
        var high = pos; // doesn't have results
        var low = pos / 2; // last place we saw results
        while (high > low+1) { // if
            pos = parseInt((high + low) / 2); // split the gap and round down
            if (getOffenses(fetchQuery, undefined, pos + '-' + pos).length == 1) {
                // we still have results, raise the bar
                low = pos;
            } else {
                // we're too high, lower the bar
                high = pos;
            }
        }
        // low holds the last pos of the list
        return low;
    }
    switch (command) {
        case 'test-module':
            if (getOffenses(undefined, undefined, '0-0')) { // return only one offense
                return 'ok';
            }
            return 'not ok';
        case 'fetch-incidents':
            var lastRun = getLastRun();
            // Using startTime is deprecated, and is being supported here for backward compability
            // it should be removed once everyone use this code at least once
            var offenseId = lastRun && lastRun.id ? lastRun.id : 0;
            var startTime = lastRun && lastRun.startTime ? lastRun.startTime : 0;
            var fetchQuery = (startTime ? 'start_time>' + startTime : 'id>' + offenseId) + (query ? (' AND (' + query +')') : '');
            /*
                qradar returns offenses sorted desc on id and there's no way to change sorting.
                if we get `offernsesPerCall` offenses it means we (probably) have more than that so we
                start looking for the end of the list by doubling the page position until we're empty.
                then start binary search back until you find the end of the list and finally return
                `offensesPerCall` from the end.
            */
            var res = getOffenses(fetchQuery, undefined, '0-' + (offensesPerCall-1));
            if (res.length >= offensesPerCall) {
                var lastOffensePos = findLastPagePos(fetchQuery);
                res = getOffenses(fetchQuery, undefined, lastOffensePos-offensesPerCall+1 + '-' + lastOffensePos);
            }

            var incidents = [];
            for (var i = 0; i < res.length; i++) {
                var offense = res[i];
                startTime = Math.max(startTime, offense.start_time);
                offenseId = Math.max(offenseId, offense.id);
                incidents.push(createIncidentFromOffense(res[i]));
            }
            setLastRun({id: offenseId});
            return JSON.stringify(incidents);
        case 'qr-offenses':
        case 'qradar-offenses':
            return addHumanRedable(getOffenses(args.filter, args.fields, args.range), 'QRadar offenses', headers);
        case 'qr-get-assets':
        case 'qradar-get-assets':
            return addHumanRedable(getAssets(args.filter, args.fields, args.range), 'QRadar get assets', headers);
        case 'qr-update-offense':
        case 'qradar-update-offense':
            return addHumanRedable(updateOffense(args.offense_id, args), 'QRadar update offense', headers);
        case 'qr-searches':
        case 'qradar-searches':
            return addHumanRedable(search(args.query_expression, args.fields), 'QRadar searches', headers);
        case 'qr-get-search':
        case 'qradar-get-search':
            return addHumanRedable(getSearch(args.search_id, args.fields), 'QRadar get search', headers);
        case 'qr-get-search-results':
        case 'qradar-get-search-results':
            return addHumanRedable(getSearchResults(args.search_id, args.range), 'QRadar get search results', headers, 'events');
        case 'qradar-get-closing-reasons':
            return addHumanRedable(getClosingReasons(args.filter, args.fields, args.include_deleted, args.include_reserved, args.range), 'QRadar get closing reasons', headers);
        case 'qradar-create-note':
            return addHumanRedable(
                sendRequest(
                    'POST',
                    server + replaceInTemplatesAndRemove('api/siem/offenses/%offense_id%/notes', args) + encodeToURLQuery(args),
                    null,
                    'create note'),
                'QRadar create note',
                headers);
        case 'qradar-get-note':
            return addHumanRedable(
                sendRequest(
                    'GET',
                    server + replaceInTemplatesAndRemove('api/siem/offenses/%offense_id%/notes/%note_id%', args) + encodeToURLQuery(args),
                    null,
                    'get note'),
                'QRadar get note',
                headers);
    }
  type: javascript
  commands:
  - name: qradar-offenses
    arguments:
    - name: filter
      description: Query to filter offenses
    - name: fields
      description: 'Fields to filter in '
    - name: range
      description: Number of results in return
    - name: headers
      description: Table headers
    description: Gets offenses from qradar
  - name: qradar-searches
    arguments:
    - name: query_expression
      required: true
      default: true
      description: The query expressions in AQL
    - name: headers
      description: Table headers
    description: Searches in QRadar
  - name: qradar-get-search
    arguments:
    - name: search_id
      required: true
      default: true
      description: The search id
    - name: headers
      description: Table headers
    description: Gets a specific search id
  - name: qradar-get-search-results
    arguments:
    - name: search_id
      required: true
      default: true
      description: The search id
    - name: range
      description: Number of results in return
    - name: headers
      description: Table headers
    description: Gets search results
  - name: qradar-update-offense
    arguments:
    - name: offense_id
      required: true
      default: true
      description: The ID of the offense to update
    - name: protected
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Set to true to protect the offense
    - name: follow_up
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Set to true to set the follow up flag on the offense
    - name: status
      auto: PREDEFINED
      predefined:
      - OPEN
      - HIDDEN
      - CLOSED
      description: The new status for the offense
    - name: closing_reason_id
      description: The ID of a closing reason. You must provide a valid closing_reason_id
        when you close an offense
    - name: assigned_to
      description: A user to assign the offense to
    - name: headers
      description: Table headers
    - name: fields
      description: Use this parameter to specify which fields you would like to get
        back in the response. Fields that are not named are excluded. Specify subfields
        in brackets and multiple fields in the same object are separated by commas
    description: Update an offense
  - name: qradar-get-assets
    arguments:
    - name: range
      description: Number of results in return
    - name: fields
      description: Fields to filter in
    - name: filter
      description: Query to filter offenses
    - name: headers
      description: Table headers
    description: List all assets found in the model
  - name: qr-offenses
    deprecated: true
    arguments:
    - name: filter
      description: Query to filter offenses
    - name: fields
      description: 'Fields to filter in '
    - name: range
      description: Number of results in return
    - name: headers
      description: Table headers
    description: Gets offenses from qradar
  - name: qr-searches
    deprecated: true
    arguments:
    - name: query_expression
      required: true
      default: true
      description: The query expressions in AQL
    - name: headers
      description: Table headers
    description: Searches in QRadar
  - name: qr-get-search
    deprecated: true
    arguments:
    - name: search_id
      required: true
      default: true
      description: The search id
    - name: headers
      description: Table headers
    description: Gets a specific search id
  - name: qr-get-search-results
    deprecated: true
    arguments:
    - name: search_id
      required: true
      default: true
      description: The search id
    - name: range
      description: Number of results in return
    - name: headers
      description: Table headers
    description: Gets search results
  - name: qr-update-offense
    deprecated: true
    arguments:
    - name: offense_id
      required: true
      default: true
      description: The ID of the offense to update
    - name: protected
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Set to true to protect the offense
    - name: follow_up
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Set to true to set the follow up flag on the offense
    - name: status
      auto: PREDEFINED
      predefined:
      - OPEN
      - HIDDEN
      - CLOSED
      description: he new status for the offense
    - name: closing_reason_id
      description: The ID of a closing reason. You must provide a valid closing_reason_id
        when you close an offense
    - name: assigned_to
      description: A user to assign the offense to
    - name: headers
      description: Table headers
    - name: fields
      description: Use this parameter to specify which fields you would like to get
        back in the response. Fields that are not named are excluded. Specify subfields
        in brackets and multiple fields in the same object are separated by commas
    description: Update an offense
  - name: qr-get-assets
    deprecated: true
    arguments:
    - name: range
      description: Number of results in return
    - name: fields
      description: Fields to filter in
    - name: filter
      description: Query to filter offenses
    - name: headers
      description: Table headers
    description: List all assets found in the model
  - name: qradar-get-closing-reasons
    arguments:
    - name: include_reserved
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: If true, reserved closing reasons are included in the response
      defaultValue: "true"
    - name: include_deleted
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: If true, deleted closing reasons are included in the response
      defaultValue: "true"
    - name: fields
      description: Use this parameter to specify which fields you would like to get
        back in the response
    - name: filter
      description: This parameter is used to restrict the elements in a list base
        on the contents of various fields
    - name: range
      description: Number of results in return
    description: Get closing reasons
  - name: qradar-create-note
    arguments:
    - name: offense_id
      required: true
      default: true
      description: The offense ID to add the note to
    - name: note_text
      required: true
      description: The note text
    - name: fields
      description: Use this parameter to specify which fields you would like to get
        back in the response. Fields that are not named are excluded. Specify subfields
        in brackets and multiple fields in the same object are separated by commas
    - name: headers
      description: Table headers
    description: Create a note on an offense
  - name: qradar-get-note
    arguments:
    - name: offense_id
      required: true
      default: true
      description: The offense ID to retrieve the note from
    - name: note_id
      required: true
      description: The note ID
    - name: fields
      description: Use this parameter to specify which fields you would like to get
        back in the response. Fields that are not named are excluded. Specify subfields
        in brackets and multiple fields in the same object are separated by commas
    - name: headers
      description: Table headers
    description: Retrieve a note for an offense
  isfetch: true
  runonce: false
releaseNotes: "-"
