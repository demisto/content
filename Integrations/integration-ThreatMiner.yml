commonfields:
  id: ThreatMiner
  version: -1
name: ThreatMiner
display: ThreatMiner
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: Data Mining for Threat Intelligence
configuration:
- display: "Maximum results per query"
  name: limitResults
  defaultvalue: "30"
  type: 0
  required: false
- display: "Trust any certificate (unsecure)"
  name: insecure
  defaultvalue: "False"
  type: 0
  required: false
- display: "Use system proxy settings"
  name: proxy
  defaultvalue: "False"
  type: 0
  required: false
- display: ""
  name: threatminerUrl
  defaultvalue: https://api.threatminer.org/v2/
  type: 0
  required: true
script:
  script: |2
  ''' IMPORTS '''
  import datetime
  import time
  import requests
  import json

  # disable insecure warnings
  requests.packages.urllib3.disable_warnings()

  THREAT_MINER_URL = demisto.params().get('threatminer_url')
  VERIFY_CERTIFICATES = False if demisto.params().get('unsecure') else True
  DEFAULT_HEADERS = {
"Content-Type": "application/json"
}
  MAX_RETURNED_ARRAY_SIZE = 30

  ''' HELPER FUNCTIONS '''


def http_request(method, url, headers):
  try:
    res = requests.request(method,
    url,
    verify=VERIFY_CERTIFICATES,
    headers=headers)

    if res.status_code == 200:
      return res.json()
    # 204 HTTP status code is returned when api rate limit has been exceeded
    elif res.status_code == 204:
      return_error("You've reached your API call quota.")
    elif res.status_code == 404:
      return {}

    res.raise_for_status()

  except Exception, e:
    raise (e)


def get_domain_report_from_threat_miner(domain_name):
  domain_whois = get_domain_whois_rawdata(domain_name)
  passiveDNS = get_domain_passive_dns_rawdata(domain_name)
  sub_domains = get_domain_subdomains_rawdata(domain_name)
  domain_uris = get_domain_URI_rawdata(domain_name)
  domainMD5 = get_domain_MD5_rawdata(domain_name)
  return {
  'raw_whois': domain_whois,
  'raw_passive_dns': passiveDNS,
  'raw_sub_domains': sub_domains,
  'raw_domain_uris': domain_uris,
  'raw_domain_md5': domainMD5
}


def get_domain_whois_rawdata(domain_name):
  threat_miner_domain_url_postfix = 'domain.php?q={}&rt={}'.format(domain_name, 1)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_domain_url_postfix, DEFAULT_HEADERS)
  domain_whois = response.get('results', [])
  if len(domain_whois) == 0:
    return {}

  return domain_whois[0]


def get_domain_whois(whois):
  return {
  'Server': whois['raw_whois']['whois']['whois_server'],
  'Create_date': whois['raw_whois']['whois']['creation_date'],
  'Update_date': whois['raw_whois']['whois']['updated_date'],
  'Expiration': whois['raw_whois']['whois']['expiration_date'],
  'Name_servers': whois['raw_whois']['whois']['nameservers']
}


def get_domain_passive_dns_rawdata(domain_name):
  threat_miner_domain_url_postfix = 'domain.php?q={}&rt={}'.format(domain_name, 2)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_domain_url_postfix, DEFAULT_HEADERS)
  threatminer_results_as_array = response.get('results', [])
  if len(threatminer_results_as_array) == 0:
    return []

  return threatminer_results_as_array


def get_domain_passive_dns(passive_dns, max_returned_array_size):
  if max_returned_array_size == -1:
    return passive_dns['raw_passive_dns']
  return passive_dns['raw_passive_dns'][:max_returned_array_size]


def get_domain_subdomains_rawdata(domain_name):
  threat_miner_domain_url_postfix = 'domain.php?q={}&rt={}'.format(domain_name, 5)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_domain_url_postfix, DEFAULT_HEADERS)
  sub_domains_array = response.get('results', [])
  return sub_domains_array


def get_domain_subdomains(sub_domains_array, max_returned_array_size):
  sub_domains = []
  if len(sub_domains_array) > 0:
    if max_returned_array_size == -1:
      return sub_domains_array['raw_sub_domains']
    sub_domains = sub_domains_array['raw_sub_domains'][:max_returned_array_size]

  return sub_domains;


def get_domain_URI_rawdata(domain_name):
  threat_miner_domain_url_postfix = 'domain.php?q={}&rt={}'.format(domain_name, 3)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_domain_url_postfix, DEFAULT_HEADERS)
  uris_full_result = response.get('results', [])
  return uris_full_result


def get_domain_URI(uris_raw_data, max_returned_array_size):
  uri_counter = 0
  uris = []
  for uri_info in uris_raw_data['raw_domain_uris']:
    if max_returned_array_size == -1 or uri_counter < max_returned_array_size:
      uris.append({
      'Address': uri_info['uri'],
      'Last Seen': uri_info['last_seen']
    })
      uri_counter += 1
    else:
      break

  return uris


def get_domain_MD5_rawdata(domain_name):
  threat_miner_domain_url_postfix = 'domain.php?q={}&rt={}'.format(domain_name, 4)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_domain_url_postfix, DEFAULT_HEADERS)
  md5s = response.get('results', [])
  return md5s


def get_domain_MD5(md5s, max_returned_array_size):
  if len(md5s) == 0:
    return []

  if max_returned_array_size == -1:
    return md5s['raw_domain_md5']

  return md5s['raw_domain_md5'][:max_returned_array_size]


def create_domain_command_markdown(domain, context):
  md = '## Threat_miner Domain report for: {}\n'.format(domain)
  threat_miner_found_results = False

  if len(context['ThreatMiner']['Domain'].get('Whois', '')) != 0:
    md += tableToMarkdown("Whois for {} domain".format(domain), context['ThreatMiner']['Domain']['Whois'],
    ['Domain Name', 'Server', 'Create Date', 'Update Date', 'Expiration', 'Name Servers'])
    threat_miner_found_results = True
  if len(context['ThreatMiner']['Domain'].get('PassiveDNS', '')) != 0:
    md += tableToMarkdown("PassiveDNS for {} domain".format(domain),
    context['ThreatMiner']['Domain']['PassiveDNS'], ['ip', 'first_seen', 'last_seen'])
    threat_miner_found_results = True
  if len(context['ThreatMiner']['Domain'].get('Subdomains', '')) != 0:
    md += tableToMarkdown("{} Subdomains".format(domain), context['ThreatMiner']['Domain']['Subdomains'],
    ['Subdomains'])
    threat_miner_found_results = True
  if len(context['ThreatMiner']['Domain'].get('URI', '')) != 0:
    md += tableToMarkdown("{} URIs".format(domain), context['ThreatMiner']['Domain']['URI'],
    ['Address', 'Last Seen'])
    threat_miner_found_results = True
  if len(context['ThreatMiner']['Domain'].get('MD5', '')) != 0:
    md += tableToMarkdown("{} Related Samples(hash only)".format(domain),
    context['ThreatMiner']['Domain']['MD5'], ['hashes'])
    threat_miner_found_results = True

  if threat_miner_found_results == False:
    md += 'No results found'

  return md


def get_domain_context_format(threat_miner_raw_results, max_returned_array_size, domain_name):
  threat_miner_context = {
  'ThreatMiner.Domain.Name': domain_name,
  'ThreatMiner.Domain.Whois': get_domain_whois(threat_miner_raw_results),
  'ThreatMiner.Domain.PassiveDNS': get_domain_passive_dns(threat_miner_raw_results, max_returned_array_size),
  'ThreatMiner.Domain.Subdomains': get_domain_subdomains(threat_miner_raw_results, max_returned_array_size),
  'ThreatMiner.Domain.URI': get_domain_URI(threat_miner_raw_results, max_returned_array_size),
  'ThreatMiner.Domain.MD5': get_domain_MD5(threat_miner_raw_results, max_returned_array_size)
}

  return createContext(threat_miner_context, removeNull=True)


def domain_command(max_returned_array_size):
  domain_name = demisto.args().get('domain')
  threat_miner_raw_results = get_domain_report_from_threat_miner(domain_name)
  threat_miner_context = get_domain_context_format(threat_miner_raw_results, max_returned_array_size, domain_name)
  markdown = create_domain_command_markdown(domain_name, threat_miner_context)

  domain_context = {
  "Domain.Name": threat_miner_context['ThreatMiner']['Domain']['Name']
}

  context = {
  'ThreatMiner.Domain(val.Name && val.Name == obj.Name)': createContext(
    threat_miner_context['ThreatMiner']['Domain'], removeNull=True),
  'Domain(val.Name && val.Name == obj.Name)': createContext(domain_context, removeNull=True)
}

  demisto.results({
  'Type': entryTypes['note'],
  'Contents': threat_miner_raw_results,
  'HumanReadable': markdown,
  'EntryContext': context,
  'ContentsFormat': formats['json']
})


def get_ip_whois_rawdata(ip_address):
  threat_miner_ip_url_postfix = 'host.php?q={}&rt={}'.format(ip_address, 1)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_ip_url_postfix, DEFAULT_HEADERS)
  whois_rawdata = response.get('results', [])
  if len(whois_rawdata) > 0:
    return whois_rawdata[0]
  return []


def get_ip_whois(whois_rawdata, ip_address):
  ip_whois_results = {}
  ip_whois_results['Address'] = ip_address
  ip_whois_results['Reverse'] = whois_rawdata['raw_whois']['reverse_name']
  ip_whois_results['Bgp'] = whois_rawdata['raw_whois']['bgp_prefix']
  ip_whois_results['Country'] = whois_rawdata['raw_whois']['cc']
  ip_whois_results['ASN'] = whois_rawdata['raw_whois']['asn']
  ip_whois_results['Org'] = whois_rawdata['raw_whois']['org_name']

  return ip_whois_results


def get_ip_passiveDNS_rawdata(ip_address):
  threat_miner_ip_url_postfix = 'host.php?q={}&rt={}'.format(ip_address, 2)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_ip_url_postfix, DEFAULT_HEADERS)
  passiveDNSArray = response.get('results', [])

  return passiveDNSArray


def get_ip_passiveDNS(passiveDNSArray, max_returned_array_size):
  if len(passiveDNSArray) == 0:
    return []

  if max_returned_array_size == -1:
    return passiveDNSArray['raw_passive_dns']

  return passiveDNSArray['raw_passive_dns'][:max_returned_array_size]


def get_ip_URI_rawdata(ip_address):
  threat_miner_ip_url_postfix = 'host.php?q={}&rt={}'.format(ip_address, 3)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_ip_url_postfix, DEFAULT_HEADERS)
  uris_rawdata = response.get('results', [])
  return uris_rawdata


def get_ip_URI(threatminer_results_as_array, max_returned_array_size):
  uri_counter = 0
  URIs = []

  for uri in threatminer_results_as_array['raw_ip_uris']:
    if max_returned_array_size == -1 or uri_counter < max_returned_array_size:
      URIs.append({
      'Uri_address': threatminer_results_as_array['raw_ip_uris'][uri_counter]['uri'],
      'Last_seen': threatminer_results_as_array['raw_ip_uris'][uri_counter]['last_seen']
    })
      uri_counter += 1
    else:
      break

  return URIs


def get_ip_MD5_rawdata(ip_address):
  threat_miner_domain_url_postfix = 'host.php?q={}&rt={}'.format(ip_address, 4)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_domain_url_postfix, DEFAULT_HEADERS)

  md5s = response.get('results', [])

  if len(md5s) == 0:
    return []
  return md5s


def get_ip_MD5(md5s_raw_data, max_returned_array_size):
  if max_returned_array_size == -1:
    return md5s_raw_data['raw_ip_md5']
  return md5s_raw_data['raw_ip_md5'][:max_returned_array_size]


def get_ip_SSL_rawdata(ip_address):
  threat_miner_domain_url_postfix = 'host.php?q={}&rt={}'.format(ip_address, 5)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_domain_url_postfix, DEFAULT_HEADERS)

  ssls_raw_data = response.get('results', [])
  return ssls_raw_data


def get_ip_SSL(ssls, max_returned_array_size):
  if len(ssls['raw_ip_ssl']) == 0:
    return ssls['raw_ip_ssl']

  if max_returned_array_size == -1:
    return ssls['raw_ip_ssl'];

  return ssls['raw_ip_ssl'][:max_returned_array_size]


def create_ip_command_markdown(ip_address, context):
  md = '## Threat_miner IP report for: {}\n'.format(ip_address)
  threat_miner_found_results = False

  if len(context['ThreatMiner']['IP']['Whois']) != 0:
    md += tableToMarkdown("Whois for {}".format(ip_address), context['ThreatMiner']['IP']['Whois'],
    ['Address', 'Country', 'Org', 'Bgp', 'Reverse', 'ASN'])
    threat_miner_found_results = True
  if len(context['ThreatMiner']['IP']['PassiveDNS']) != 0:
    md += tableToMarkdown("PassiveDNS for {}".format(ip_address), context['ThreatMiner']['IP']['PassiveDNS'],
    ['domain', 'first_seen', 'last_seen'])
    threat_miner_found_results = True
  if len(context['ThreatMiner']['IP']['URI']) != 0:
    md += tableToMarkdown("{} URIs".format(ip_address), context['ThreatMiner']['IP']['URI'],
    ['Uri_address', 'Last_seen'])
    threat_miner_found_results = True
  if len(context['ThreatMiner']['IP']['MD5']) != 0:
    md += tableToMarkdown("{} MD5s".format(ip_address), context['ThreatMiner']['IP']['MD5'], ['MD5'])
    threat_miner_found_results = True
  if len(context['ThreatMiner']['IP']['SSL']) != 0:
    md += tableToMarkdown("{} SSLs".format(ip_address), context['ThreatMiner']['IP']['SSL'], ['SSL'])
    threat_miner_found_results = True

  if threat_miner_found_results == False:
    md += 'No results found'

  return md


def get_ip_report_from_threat_miner(ip_address):
  whois_raw_data = get_ip_whois_rawdata(ip_address)
  passiveDNSRaw_data = get_ip_passiveDNS_rawdata(ip_address)
  md5Raw_data = get_ip_MD5_rawdata(ip_address)
  uri_raw_data = get_ip_URI_rawdata(ip_address)
  ssl_raw_data = get_ip_SSL_rawdata(ip_address)
  return {
  'raw_whois': whois_raw_data,
  'raw_passive_dns': passiveDNSRaw_data,
  'raw_ip_md5': md5Raw_data,
  'raw_ip_uris': uri_raw_data,
  'raw_ip_ssl': ssl_raw_data
}


def get_ip_context_format(threat_miner_raw_results, max_returned_array_size, ip_address):
  ip_context = {
  'ThreatMiner.IP.Address': ip_address,
  'ThreatMiner.IP.Whois': get_ip_whois(threat_miner_raw_results, ip_address),
  'ThreatMiner.IP.PassiveDNS': get_ip_passiveDNS(threat_miner_raw_results, max_returned_array_size),
  'ThreatMiner.IP.MD5': get_ip_MD5(threat_miner_raw_results, max_returned_array_size),
  'ThreatMiner.IP.URI': get_ip_URI(threat_miner_raw_results, max_returned_array_size),
  'ThreatMiner.IP.SSL': get_ip_SSL(threat_miner_raw_results, max_returned_array_size)
}

  return createContext(ip_context, removeNull=True)


def ip_command(max_returned_array_size):
  ip_address = demisto.args().get('ip')
  if not is_ip_valid(ip_address):
    return_error('An invalid IP was specified')
  threat_miner_raw_results = get_ip_report_from_threat_miner(ip_address)
  threat_miner_context = get_ip_context_format(threat_miner_raw_results, max_returned_array_size, ip_address)
  markdown = create_ip_command_markdown(ip_address, threat_miner_context)
  ipcontext = {
  "IP.Address": threat_miner_context['ThreatMiner']['IP']['Address'],
  "IP.Geo.Country": threat_miner_context['ThreatMiner']['IP']['Whois']['Country'],
  "IP.ASN": threat_miner_context['ThreatMiner']['IP']['Whois']['ASN'],
}
  context = {
  'ThreatMiner.IP(val.Address && val.Address == obj.Address)': createContext(
    threat_miner_context['ThreatMiner']['IP'], removeNull=True),
  'IP(val.Address && val.Address == obj.Address)': createContext(ipcontext, removeNull=True)
}

  demisto.results(
  {'Type': entryTypes['note'],
   'Contents': threat_miner_raw_results,
   'HumanReadable': markdown,
   'EntryContext': context,
   'ContentsFormat': formats['json']})


def get_file_whois_rawdata(hashed_file):
  threat_miner_ip_url_postfix = 'sample.php?q={}&rt={}'.format(hashed_file, 1)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_ip_url_postfix, DEFAULT_HEADERS)
  threatminer_results_as_array = response.get('results', [])

  if len(threatminer_results_as_array) == 0:
    return threatminer_results_as_array

  return threatminer_results_as_array[0]


def get_file_whois_and_update_theart_miner_file_context(rawdata_file, context):
  if len(rawdata_file['raw_whois']) == 0:
    return rawdata_file['raw_whois']

  context['ThreatMiner']['File']['MD5'] = rawdata_file['raw_whois']['md5']
  context['ThreatMiner']['File']['Architecture'] = rawdata_file['raw_whois']['architecture']
  context['ThreatMiner']['File']['Sha1'] = rawdata_file['raw_whois']['sha1']
  context['ThreatMiner']['File']['Sha256'] = rawdata_file['raw_whois']['sha256']
  context['ThreatMiner']['File']['Type'] = rawdata_file['raw_whois']['file_type']
  context['ThreatMiner']['File']['File_name'] = rawdata_file['raw_whois']['file_name']
  context['ThreatMiner']['File']['Size'] = rawdata_file['raw_whois']['file_size']
  context['ThreatMiner']['File']['Analyzed'] = rawdata_file['raw_whois']['date_analysed']


def get_file_http_rawdata(hashed_file):
  threat_miner_domain_url_postfix = 'sample.php?q={}&rt={}'.format(hashed_file, 2)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_domain_url_postfix, DEFAULT_HEADERS)
  file_http_raw_data = response.get('results', [])
  return file_http_raw_data


def get_file_http(file_http_raw_data, max_returned_array_size):
  if len(file_http_raw_data['raw_file_https']) == 0:
    return []

  file_http = file_http_raw_data['raw_file_https'][0]
  http_traffics = file_http['http_traffic']

  http_traffic_counter = 0
  http_traffics_info = []

  for http_traffic in http_traffics:
    if max_returned_array_size == -1 or http_traffic_counter < max_returned_array_size:
      http_traffics_info.append({
      'Domain': http_traffics[http_traffic_counter]['domain'],
      'URL': http_traffics[http_traffic_counter]['url'],
      'User_agent': http_traffics[http_traffic_counter]['user_agent']
    })
      http_traffic_counter += 1
    else:
      break

  return http_traffics_info


def get_file_domains_and_ip_rawdata(hashed_file):
  threat_miner_domain_url_postfix = 'sample.php?q={}&rt={}'.format(hashed_file, 3)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_domain_url_postfix, DEFAULT_HEADERS)
  domain_and_ip_raw_data = response.get('results', [])
  return domain_and_ip_raw_data


def get_file_domains_and_ip(domain_and_ip_raw_data, max_returned_array_size):
  if len(domain_and_ip_raw_data['raw_file_domains']) == 0:
    return []

  threatminer_result = domain_and_ip_raw_data['raw_file_domains'][0]
  file_domains = threatminer_result['domains']
  if max_returned_array_size == -1:
    return file_domains
  return file_domains[:max_returned_array_size]


def get_file_mutants_rawdata(hashed_file):
  threat_miner_domain_url_postfix = 'sample.php?q={}&rt={}'.format(hashed_file, 4)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_domain_url_postfix, DEFAULT_HEADERS)
  mutants_rawdata = response.get('results', [])
  return mutants_rawdata


def get_file_mutants(mutants_rawdata, max_returned_array_size):
  if len(mutants_rawdata['raw_file_mutants']) == 0:
    return []

  file_mutants = mutants_rawdata['raw_file_mutants'][0]
  if max_returned_array_size == -1:
    return file_mutants['mutants']
  return file_mutants['mutants'][:max_returned_array_size]


def get_file_registry_keys_rawdata(hashed_file):
  threat_miner_domain_url_postfix = 'sample.php?q={}&rt={}'.format(hashed_file, 5)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_domain_url_postfix, DEFAULT_HEADERS)

  threatminer_results_as_array = response.get('results', [])
  if len(threatminer_results_as_array) == 0:
    return []
  return threatminer_results_as_array[0]


def get_file_registry_keys(file_registry_keys, max_returned_array_size):
  if len(file_registry_keys['raw_file_registry']) == 0:
    return []

  if max_returned_array_size == -1:
    return file_registry_keys['raw_file_registry']['registry_keys']
  return file_registry_keys['raw_file_registry']['registry_keys'][:max_returned_array_size]


def get_file_AV_detection_rawdata(hashed_file):
  threat_miner_domain_url_postfix = 'sample.php?q={}&rt={}'.format(hashed_file, 6)
  response = http_request('GET', THREAT_MINER_URL + threat_miner_domain_url_postfix, DEFAULT_HEADERS)

  raw_file_av_dectection = response.get('results', [])
  return raw_file_av_dectection


def get_file_AV_detection(raw_file_av_dectection):
  if len(raw_file_av_dectection['raw_file_av']) == 0:
    return []

  fileAVDetection = raw_file_av_dectection['raw_file_av'][0]

  return fileAVDetection['av_detections']


def get_file_report_from_threat_miner(hashed_file):
  whois_raw_data = get_file_whois_rawdata(hashed_file)
  file_https_raw_data = get_file_http_rawdata(hashed_file)
  file_domains_raw_data = get_file_domains_and_ip_rawdata(hashed_file)
  file_mutants_raw_data = get_file_mutants_rawdata(hashed_file)
  file_registry_keys_raw_data = get_file_registry_keys_rawdata(hashed_file)
  fileile_av_dectection_raw_data = get_file_AV_detection_rawdata(hashed_file)
  return {
  'raw_whois': whois_raw_data,
  'raw_file_https': file_https_raw_data,
  'raw_file_domains': file_domains_raw_data,
  'raw_file_mutants': file_mutants_raw_data,
  'raw_file_registry': file_registry_keys_raw_data,
  'raw_file_av': fileile_av_dectection_raw_data
}


def get_file_context_format(threat_miner_raw_results, max_returned_array_size, hashed_file):
  context = {
  'ThreatMiner.File.MD5': threat_miner_raw_results['raw_whois'].get('md5', ''),
  'ThreatMiner.File.Architecture': threat_miner_raw_results['raw_whois'].get('architecture', ''),
  'ThreatMiner.File.Sha1': threat_miner_raw_results['raw_whois'].get('sha1', ''),
  'ThreatMiner.File.Sha256': threat_miner_raw_results['raw_whois'].get('sha256', ''),
  'ThreatMiner.File.Type': threat_miner_raw_results['raw_whois'].get('file_type', ''),
  'ThreatMiner.File.File_name': threat_miner_raw_results['raw_whois'].get('file_name', ''),
  'ThreatMiner.File.Size': threat_miner_raw_results['raw_whois'].get('file_size', ''),
  'ThreatMiner.File.Analyzed': threat_miner_raw_results['raw_whois'].get('date_analysed', ''),
  'ThreatMiner.File.HTTP': get_file_http(threat_miner_raw_results, max_returned_array_size),
  'ThreatMiner.File.Domains': get_file_domains_and_ip(threat_miner_raw_results, max_returned_array_size),
  'ThreatMiner.File.Mutants': get_file_mutants(threat_miner_raw_results, max_returned_array_size),
  'ThreatMiner.File.Registry': get_file_registry_keys(threat_miner_raw_results, max_returned_array_size),
  'ThreatMiner.File.AV': get_file_AV_detection(threat_miner_raw_results)
}

  return createContext(context, removeNull=True)


def get_dbot_scores_context(file_context, hashed_file):
  amount_of_detections = len(file_context.get('AV', ''))
  dbot_scores = get_dbot_score_report(amount_of_detections, hashed_file, file_context)
  return dbot_scores


def file_command(max_returned_array_size):
  hashed_file = demisto.args().get('file')
  threat_miner_raw_results = get_file_report_from_threat_miner(hashed_file)
  threat_miner_context = get_file_context_format(threat_miner_raw_results, max_returned_array_size, hashed_file)
  markdown = create_file_command_markdown(hashed_file, threat_miner_context)

  file_context = threat_miner_context['ThreatMiner']['File']
  dbot_scores = get_dbot_scores_context(file_context, hashed_file)

  context = {
  'ThreatMiner.File(val.MD5 && val.MD5 == obj.MD5)': createContext(threat_miner_context['ThreatMiner']['File'],
    removeNull=True),
  'File(val.MD5 && val.MD5 == obj.MD5)': createContext(file_context, removeNull=True),
  'DBot_score(val.Vendor && val.Indicator && val.Vendor == obj.Vendor && val.Indicator == obj.Indicator)': createContext(
    dbot_scores, removeNull=True)
}

  return demisto.results({'Type': entryTypes['note'],
    'Contents': threat_miner_raw_results,
    'HumanReadable': markdown,
    'EntryContext': context,
    'ContentsFormat': formats['json']})


def get_dbot_score_report(amount_of_detections, hashed_file, file_context):
  dbot = {}
  dbot_score = get_dbot_score(amount_of_detections)
  dbot['Score'] = dbot_score
  dbot['Indicator'] = hashed_file
  dbot['Type'] = 'File'
  dbot['Vendor'] = 'ThreatMiner'

  if dbot_score == 3:
    file_context['ThreatMiner.File.Malicious.Vendor'] = 'ThreatMiner'
    file_context['ThreatMiner.File.Malicious.Detections'] = amount_of_detections
  return dbot


def get_dbot_score(amount_of_detections):
  malicious_threshold = int(demisto.args().get('threshold'))
  if amount_of_detections == 0:
    return 0
  if amount_of_detections > 0 and amount_of_detections < malicious_threshold:
    return 2
  if amount_of_detections >= malicious_threshold:
    return 3


def create_file_command_markdown(hashed_file, File_context):
  md = '## Threat_miner file report for hashed file: {}\n'.format(hashed_file)
  threat_miner_found_results = False

  md += '\n'
  md += '**File MD5:** {}'.format(hashed_file)
  md += '\n'
  md += '**File Architecture:** {}'.format(File_context['ThreatMiner']['File'].get('Architecture', 'Unkown'))
  md += '\n'
  md += '**File SHA1:** {}'.format(File_context['ThreatMiner']['File'].get('Sha1', 'Unknown'))
  md += '\n'
  md += '**File SHA256:** {}'.format(File_context['ThreatMiner']['File'].get('Sha256', 'Unkown'))
  md += '\n'
  md += '**File Type:** {}'.format(File_context['ThreatMiner']['File'].get('Type', 'Unkown'))
  md += '\n'
  md += '**File Name:** {}'.format(File_context['ThreatMiner']['File'].get('File_name', 'Unkown'))
  md += '\n'
  md += '**File Size:** {}'.format(File_context['ThreatMiner']['File'].get('Size', 'Unkown'))
  md += '\n'
  md += '**File Analyzed:** {}'.format(File_context['ThreatMiner']['File'].get('Analyzed', 'Unkown'))

  if len(File_context['ThreatMiner']['File'].get('HTTP', '')) != 0:
    md += tableToMarkdown("HTTP for hashed file {}".format(hashed_file),
    File_context['ThreatMiner']['File']['HTTP'], ['Domain', 'URL', 'User_agent'])
    threat_miner_found_results = True
  if len(File_context['ThreatMiner']['File'].get('Domains', '')) != 0:
    md += tableToMarkdown("Hashed file: {} Domains".format(hashed_file),
                                          File_context['ThreatMiner']['File']['Domains'], ['domain', 'ip'])
    threat_miner_found_results = True
  if len(File_context['ThreatMiner']['File'].get('Mutants', '')) != 0:
    md += tableToMarkdown("Hashed file: {} Mutants".format(hashed_file),
                                          File_context['ThreatMiner']['File']['Mutants'], ['Mutants'])
    threat_miner_found_results = True
  if len(File_context['ThreatMiner']['File'].get('Registry', '')) != 0:
    md += tableToMarkdown("Hashed file: {} Registry keys".format(hashed_file),
                                          File_context['ThreatMiner']['File']['Registry'], ['Registry'])
    threat_miner_found_results = True
  if len(File_context['ThreatMiner']['File'].get('AV', '')) != 0:
    md += tableToMarkdown("Hashed file: {} Anti Virus detections".format(hashed_file),
                                          File_context['ThreatMiner']['File']['AV'], ['av', 'detection'])
    threat_miner_found_results = True

  if threat_miner_found_results == False:
    md += 'No results found'

  return md


def delete_proxy_if_asked():
  if not demisto.params()['proxy']:
    del os.environ['HTTP_PROXY']
    del os.environ['HTTPS_PROXY']
    del os.environ['http_proxy']
    del os.environ['https_proxy']

  ''' EXECUTION CODE '''


try:
  demisto_command = demisto.command()
  if demisto_command == 'test-module':
    report = get_ip_whois_rawdata('8.8.8.8')

    if 'asn' in report:
      demisto.results('ok')
    else:
      demisto.results('test failed')
    pass

  if demisto.params().get('limit_results').lower() == 'all':
    max_array_size = -1
  else:
    max_array_size = int(demisto.params().get('limit_results', MAX_RETURNED_ARRAY_SIZE))

  delete_proxy_if_asked()

  if demisto_command == 'domain':
    domain_command(max_array_size)

  if demisto_command == 'ip':
    ip_command(max_array_size)

  if demisto_command == 'file':
    file_command(max_array_size)

except Exception, e:
  raise

  type: python
  commands:
  - name: domain
    arguments:
    - name: domain
      required: true
      description: Domain name
    outputs:
    - contextPath: ThreatMiner.Domain
      description: Searched domain name
      type: string
    - contextPath: ThreatMiner.Domain.Whois.Server
      description: Whois server address
      type: string
    - contextPath: ThreatMiner.Domain.Whois.CreateDate
      description: Creation date
      type: date
    - contextPath: ThreatMiner.Domain.Whois.UpdateDate
      description: Last update date
      type: date
    - contextPath: ThreatMiner.Domain.Whois.Expiration
      description: Expiration date
      type: date
    - contextPath: ThreatMiner.Domain.Whois.NameServers
      description: Whois name servers
      type: string
    - contextPath: ThreatMiner.Domain.PassiveDNS.IP
      description: Passive DNS IP address
      type: string
    - contextPath: ThreatMiner.Domain.PassiveDNS.FirstSeen
      description: Passive DNS first seen date
      type: date
    - contextPath: ThreatMiner.Domain.PassiveDNS.LastSeen
      description: Passive DNS last seen date
      type: date
    - contextPath: ThreatMiner.Domain.Subdomains
      description: Subdomains
      type: string
    - contextPath: ThreatMiner.Domain.URI
      description: Related URIs
      type: string
    - contextPath: ThreatMiner.Domain.URI.LastSeen
      description: URI last seen date
      type: string
    - contextPath: ThreatMiner.Domain.MD5
      description: Related samples' MD5
      type: string
    description: Retrieves data from ThreatMiner about a specified domain.
  - name: ip
    arguments:
    - name: ip
      required: true
      description: IP address
    outputs:
    - contextPath: ThreatMiner.IP.Address
      description: Searched IP address
      type: string
    - contextPath: ThreatMiner.IP.Whois.Reverse
      description: Whois reverse name
      type: string
    - contextPath: ThreatMiner.IP.Whois.Bgp
      description: BGP prefix
      type: string
    - contextPath: ThreatMiner.IP.Whois.Country
      description: Related country
      type: string
    - contextPath: ThreatMiner.IP.Whois.ASN
      description: Related ASN
      type: string
    - contextPath: ThreatMiner.IP.Whois.Org
      description: Organization name
      type: string
    - contextPath: ThreatMiner.IP.PassiveDNS.IP
      description: PassiveDNS IP address
      type: string
    - contextPath: ThreatMiner.IP.PassiveDNS.FirstSeen
      description: Passive DNS first seen date
      type: date
    - contextPath: ThreatMiner.IP.PassiveDNS.LastSeen
      description: Passive DNS last seen date
      type: date
    - contextPath: ThreatMiner.IP.URI
      description: Related URIs
      type: string
    - contextPath: ThreatMiner.IP.URI.LastSeen
      description: URI last seen date
      type: date
    - contextPath: ThreatMiner.IP.MD5
      description: Related samples' MD5
      type: string
    - contextPath: ThreatMiner.IP.SSL
      description: SSL certificates
      type: string
    description: Retrieves data from ThreatMiner about a specified IP address.
  - name: file
    arguments:
    - name: file
      required: true
      description: File hash (MD5, SHA-1, SHA-256)
    - name: threshold
      description: The file is considered malicious if the ThreatScore is greater than or equal to the threshold.
      defaultValue: "10"
    outputs:
    - contextPath: ThreatMiner.File.MD5
      description: File MD5
      type: string
    - contextPath: ThreatMiner.File.Sha1
      description: File SHA-1
      type: string
    - contextPath: ThreatMiner.File.Sha256
      description: File SHA-256
      type: string
    - contextPath: ThreatMiner.File.Type
      description: File type
      type: string
    - contextPath: ThreatMiner.File.Name
      description: File name
      type: string
    - contextPath: ThreatMiner.File.Architecture
      description: File architecture
      type: string
    - contextPath: ThreatMiner.File.Size
      description: File size
      type: string
    - contextPath: ThreatMiner.File.Analyzed
      description: File analyzed date
      type: date
    - contextPath: ThreatMiner.File.HTTP.Domain
      description: HTTP traffic to domain
      type: string
    - contextPath: ThreatMiner.File.HTTP.URL
      description: HTTP traffic to URL
      type: string
    - contextPath: ThreatMiner.File.HTTP.Useragent
      description: HTTP user agent
      type: string
    - contextPath: ThreatMiner.File.IP
      description: Related IP addresses
      type: string
    - contextPath: ThreatMiner.File.Domains
      description: Related domains
      type: string
    - contextPath: ThreatMiner.File.Mutants
      description: Used mutexes
      type: string
    - contextPath: ThreatMiner.File.Registry
      description: Used registry keys
      type: string
    - contextPath: ThreatMiner.File.AV
      description: Detected AV name
      type: string
    - contextPath: ThreatMiner.File.AV.Detection
      description: AV detection
      type: string
    - contextPath: File.MD5
      description: File MD5
      type: string
    - contextPath: File.Sha1
      description: File SHA-1
      type: string
    - contextPath: File.Sha256
      description: File SHA-256
      type: string
    - contextPath: File.Malicious.Detections
      description: For malicious files, the total number of detections
      type: number
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision
      type: string
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested
      type: string
    - contextPath: DBotScore.Score
      description: The actual score
      type: number
    - contextPath: DBotScore.Type
      description: Indicator type
      type: string
    - contextPath: DBotScore.Vendor
      description: Vendor that calculated the score
      type: string
    description: Retrieves data from ThreatMiner about a specified file.
  runonce: false
tests:
  - ThreatMiner-Test