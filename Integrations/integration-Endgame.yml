commonfields:
  id: Endgame
  version: -1
name: Endgame
display: Endgame
category: Endpoint
description: Endpoint protection built to stop advanced attacks before damage and loss occurs
image: data:image/png;base64,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
configuration:
- display: 'Server URL (Example: https://me.endgame.com:2443)'
  name: url
  defaultvalue: https://localhost:2443
  type: 0
  required: true
- display: Username
  name: username
  defaultvalue: ""
  type: 9
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "false"
  type: 8
  required: false
script:
  script: |-
    var host = params.url;
    var insecure = params.insecure;
    var proxy = params.proxy;
    var username = params.username.identifier;
    var password = params.username.password;
    var loginArgs = { username : username, password : password };
    var headers = { 'Content-Type': ['application/json'] };
    var token = params.token;

    var makeArray = function(obj){
        if(obj && !Array.isArray(obj))
         return [obj];
        else return obj;
    };

    var headerTransform = function(dict){
        return function(obj){
            return dict[obj];
        };
    };

    //returns single object withing entity (i.e. File[0])
    var jsonToEntityObject = function(origObj, keyTransform){
        var ret = {};
        for(var key in origObj){
            if(keyTransform(key)){
                ret[keyTransform(key)] = dq(origObj, key);
            }
        }
        return ret;
    };

    //returns entire entity array (i.e. File)
    var jsonToEntity = function(origObj, keyTransform){
        var j;
        if(!Array.isArray(origObj)){
            return jsonToEntityObject(origObj, keyTransform);
        }
        else if(origObj.length > 0){ //makes sure no empty arrays are pushed
            var ret = [];
            for(j=0; j<origObj.length; j++){
                ret.push(jsonToEntityObject(origObj[j], keyTransform));
            }
            return ret;
        }
    };

    var commandToResult = {
        'endgame-deploy' : [{
            contextPath : 'EndGame.Deployment(val.Key==obj.Key)',
            title: 'Deployment Status',
            MDdata:{
                'deployment_profile': 'Sensor ID',
                'domain': 'Domain',
                'id': 'Deploy ID'
            }
        }],
        'endgame-get-deployment-profiles' : [{
            contextPath : 'EndGame.SensorProfiles(val.Id==obj.Id)',
            title: 'Deployment Profiles',
            MDdata:{
                'api_key': 'API Key',
                'created_at':'Created At',
                'id':'ID',
                'name':'Name',
                'receiver':'Receiver',
                'sensor_directory':'Sensor Directory',
                'sensor_version':'Sensor Version',
                'updated_at':'Updated At'
            }
        }],
        'endgame-get-unmanaged-endpoints' : [{
            contextPath : 'EndGame.Endpoints(val.Id==obj.Id)',
            title: 'Unmanagaed Endpoints',
            MDdata:{
                'core_os': 'Core OS',
                'created_at': 'Created At',
                'id': 'ID',
                'name': 'Name',
                'display_operating_system': 'Display Operating System',
                'domain': 'Domain',
                'machine_id': 'Machine ID',
                'status': 'Status',
                'mac_address' : 'MAC Address',
                'operating_system' : 'Operating System',
                'ip_address' : 'IP Address'
            }
        }],
        'endgame-get-endpoint-status' : [{
            contextPath : 'EndGame.Endpoints(val.MachineId==obj.MachineId)',
            title: 'Endpoint Status',
            MDdata:{
                'status': 'Status',
                'machine_id':'Machine ID',
                'ip_address' : 'Machine IP',
                'hostname' : 'Name'
            }
        }],
        'endgame-create-sensor-profile' : [{
            contextPath : 'EndGame.SensorProfiles(val.Id==obj.Id)',
            title: 'Sensor Profile',
            MDdata:{
                'id':'ID',
                'name':'Name'
            }
        }],
        'endgame-get-sensor' : [{
            contextPath : 'EndGame.SensorProfiles(val.Id==obj.Id)',
            title: 'Deployment Profile',
            MDdata:{
                'api_key': 'API Key',
                'created_at':'Created At',
                'id':'ID',
                'name':'Name',
                'receiver':'Receiver',
                'sensor_directory':'Sensor Directory',
                'sensor_version':'Sensor Version',
                'updated_at':'Updated At'
            }
        }],
        'endgame-create-investigation' : [{
            contextPath : 'EndGame.Investigations(val.Id==obj.Id)',
            title: 'Investigation',
            MDdata:{
                'id' : 'ID'
            }
        }],
        'endgame-get-investigations' : [{
            contextPath : 'EndGame.Investigations(val.Id==obj.Id)',
            title: 'Investigations',
            MDdata:{
                'id':'ID',
                'core_os' : 'Core OS',
                'created_by_user_display_name' : 'Created By',
                'hunt_count' : 'Hunt Count',
                'name' : 'Name',
                'updated_at' : 'Updated At',
                'user_display_name' : 'User'
            }
        }]
    };

    var sendRequest = function(url, method, queryParams, data, isLogout) {
        if (url[url.length - 1] === '/') {
            url = url.substring(0, url.length - 1);
        }

        var requestUrl = host + url;
        if (queryParams) {
            requestUrl += encodeToURLQuery(queryParams);
        }

        var res = http(
            requestUrl,
            {
                Method: method,
                Headers: headers,
                Body: data? JSON.stringify(data) : undefined
            },
            insecure,
            proxy
        );

        if (res.StatusCode >= 300 || res.StatusCode < 200) {
            if(token && !isLogout){
                  logout();
            }
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nResponse Body: ' + res.Body;
        }
        try {
            return JSON.parse(res.Body);
        } catch (err) {
            return res.Body;
        }

    };

    var get = function(url, queryParams, isLogout){
        return sendRequest(url, 'GET', queryParams, undefined, isLogout);
    };

    var post = function(url, queryParams, data){
        return sendRequest(url, 'POST', queryParams, data);
    };

    var login = function(){
        if (!token) {
            try {
                resp = post('/api/v1/auth/login', undefined, loginArgs);
                token = resp.metadata.token;
                headers = { 'Content-Type': ['application/json'], 'Authorization': ['JWT ' + token] };
            } catch (err) {
                throw 'ERROR: failure while authenticating to platform: ' + err;
            }
        }
    };

    var logout = function(){
        return get('/api/v1/auth/logout/', undefined, true);
    };

    /**** Get Commands ****/
    var getDeploymentProfiles = function(){
        return get('/api/v1/deployment-profiles/').data;
    };

    var getUnmanagedEndpoints = function(){
        return get('/api/v1/endpoints/', {'core_os' : 'windows', 'status':'not-installed'});
    };

    var getUsers = function(){
        return get('/api/v1/users');
    };

    var getInvestigations = function(){
        return get('/api/v1/investigations?archived=false').data;
    };

    var getSensor = function(sensor_id){
        return get('/api/v1/deployment-profiles/'+sensor_id).data;
    };

    var getUserID = function(name){
        res = getUsers().data;
            for(var i=0; i<res.length; i++){
                if(res[i].username === name){
                    return res[i].id;
                }
            }
        return -1;
    };

    var getSensorIDs = function(endpoints){
        var ret= [];
            var res = get('/api/v1/sensors').results;
            if(!Array.isArray(endpoints)){
                endpoints = [endpoints];
            }
            for(var i=0; i<endpoints.length; i++){
                for(var j=0; j<res.length; j++){
                    if(endpoints[i] === res[j].endpoint.name){
                        ret.push(res[j].id);
                    }
                }
            }
        return ret;
    };

    var getEndpointStatus = function(args){
        if(!args.ip_address && !args.name && !args.machine_id)
            throw 'Missing arguments. Must have one of the following: ip, name, uuid';
        var res = get('/api/v1/endpoints', args);
        return res.data[0];
    };

    var getInvestigationStatus = function(inv_id){
        var task_completion = get('/api/v1/investigations/'+inv_id+'/').data.task_completion;
        var completed = task_completion.completed_tasks;
        var total = task_completion.total_tasks;
        var context = {};
        var md = '';
        if(total === completed){
            md = 'Investigation Completed';
            context['EndGame.Investigations(val.Id=='+inv_id+')'] = {'Status' : 'completed', 'Id':inv_id};
        }
        else{
            md = 'Investigation not completed';
            context['EndGame.Investigations(val.Id==obj.Id)'] = {'Status' : completed+'/'+total, 'Id' : inv_id};
        }
        return {
            Type: entryTypes.note,
            Contents: task_completion,
            ContentsFormat: formats.json,
            ReadableContentsFormat : formats.notes,
            EntryContext : context,
            HumanReadable: md
        };
    };

    var getInvestigationResults = function(inv_id){
        var task_types = {'user_sessions':'Usernames', 'file_list':'Files', 'processes':'Processes', 'connections':'Networks', 'values':'Registries'};
        var task_type_keys = Object.keys(task_types);
        var contents = [];
        var tasks = makeArray(get('/api/v1/investigations/'+inv_id+'/').data.tasks);
        var context = {};
        var md = '';
        for(var i=0; i<tasks.length; i++){
            var collection_id = get('/api/v1/tasks/'+tasks[i]).data.tasks[0].metadata.collection_id;
            for(var j=0; j<task_type_keys.length;j++){
                var results = get('/api/v1/collections/'+collection_id+'/?scope='+task_type_keys[j]).data.data.results;
                if(results && Array.isArray(results) && results.length > 0){
                    context[task_types[task_type_keys[j]]] = results;
                    md += tableToMarkdown('Investigation '+task_types[task_type_keys[j]]+' Results', results);
                    contents.push(results);
                }
            }
        }
        return {
            Type: entryTypes.note,
            Contents: contents,
            ContentsFormat: formats.json,
            ReadableContentsFormat : formats.markdown,
            EntryContext : {'EndGame.InvestigationResults' : context},
            HumanReadable: md
        };
    }

    /**** Create / Set Commands ****/
    var createSensorProfile = function(name, receiver, sensor_version, sensor_directory, api_key){
        reqBody = {
            'name' : name,
            'receiver' : receiver,
            'sensor_version' : sensor_version,
            'sensor_directory' : sensor_directory,
            'api_key' : api_key,
            'config':{
                'Mitigation':{
                    'dbi_dll_name':'esensordbi.dll',
                    'popup_exe_name':'useralert.exe'
                },
                'Kernel':{
                    'sys_name':'esensor.sys',
                    'service_name':'esensordrv',
                    'service_display_name':'esensordrv'
                },
                'Installation':{
                    'dll_path':'%SYSTEMROOT%\\System32\\esensor.exe',
                    'service_name':'esensor',
                    'service_display_name':'EndpointSensor'
                }
            }
        };
        res =  post('/api/v1/deployment-profiles/', undefined, reqBody).data;
        res.id = res.success? res.success : 'Sensor profile creation failed';
        res.success = undefined;
        res.name = name;
        return res;
    }

    var createInvestigation = function(name, assignee, sensors, endpoints, args){
            var taskDescriptions = get('/api/v1/task-descriptions/').data;
            var iocTaskId = '35b6f686-dece-545f-8314-56936abec6ba';
            for(var i=0; i<taskDescriptions.length; i++){
                if(taskDescriptions[i]['name'] === 'iocSearchRequest' && taskDescriptions[i]['sensor_type'] === 'windows'){
                    log('found it!');
                    iocTaskId = taskDescriptions[i]['id'];
                    break;
                }
            }
            url = '/api/v1/investigations';
            reqBody = {
                'name' : name,
                'assign_to' : assignee,
                'sensor_ids' : sensors ? (makeArray(sensors)) : getSensorIDs(endpoints),
                'tasks': {},
                'assign_to': getUserID(assignee? assignee : params.username),
                'core_os' : 'windows'
            };
            reqBody.tasks[iocTaskId] = {'task_list' : createTask(args)}
            return post(url, undefined, reqBody).data;
    };

    var deploy = function(domain, username, password, api_key, endpoint_transaction, deployment_order, endpoint_ips, endpoint_ids){
        url = '/api/v1/deploy';
        requestBody = {
            'username' : username,
            'password' : password,
            'domain' : domain,
            'api_key' : api_key,
            'deployment_order' : deployment_order
        };

        if(endpoint_transaction){
          requestBody['endpoint_transaction'] = endpoint_transaction;
        }

        else if(endpoint_ips && endpoint_ids){
            if(endpoint_ips.length !== endpoint_ids.length){
                throw 'IP addresses don\'t match Endpoint IDs'
            }
            var targets = [];
            for(var i=0; i<endpoint_ips.length; i++){
                targets.push({'ip_address' : endpoint_ips[i], 'endpoint_uuid' : endpoint_ids[i]});
            }
            requestBody['targets'] = targets;
        }
        res = post(url, undefined, requestBody);
        return res.data;
    };

    var createTask = function(args){
        task = [];
        if(args.network_local_ip || args.network_remote_ips || args.network_port){
            task.push({
               'network_search':{
                  'with_state':'ANY',
                  'find_local_ip_address': args.network_local_ip,
                  'protocol': args.network_protocol,
                  'find_remote_ip_address':makeArray(args.network_remote_ips),
                  'port':{
                        'port':args.network_port,
                        'key': args.network_remote === 'false' ? 'local' : 'remote'
                    }
                }
            });
        }
        if(args.process_md5s || args.process_sha256s || args.process_sha1s || args.process){
            task.push({
               "process_search":{
                  "with_md5_hash":makeArray(args.process_md5s),
                  "with_sha256_hash":makeArray(args.process_sha256s),
                  "with_sha1_hash":makeArray(args.process_sha1s),
                  "find_process":args.process
               }
            });
        }
        if(args.file_md5s || args.file_sha256s || args.file_sha1s){
            task.push({
               'file_search':{
                    'with_md5_hash':makeArray(args.file_md5s),
                    'with_sha1_hash':makeArray(args.file_sha1s),
                    'with_sha256_hash':makeArray(args.file_sha256s),
                    'regexes':makeArray(args.file_regexes),
                    'directory': args.file_dir
                }
            });
        }
        if(args.registry_key){
            task.push({
                'registry_search':{
                    'hive':'ALL',
                    'min_size':args.registry_min_size,
                    'max_size':args.registry_max_size,
                    'key': makeAray(args.registry_key)
                }
            });
        }
        if(args.user_search || args.user_search_domain){
            task.push({
               'username_search':{
                    'find_username': makeArray(args.user_search),
                    'domain': args.user_search_domain
                }
            });
        }
        return task;
    };

    var resToEntry = function(results){
        currentCommand = commandToResult[command];
        var entries = [];
        for (var j in currentCommand) {
            var current = currentCommand[j];
            var entry = {
                Type: entryTypes.note,
                Contents: results,
                ContentsFormat: formats.json,
                ReadableContentsFormat : formats.markdown,
                EntryContext : {}
            };
            entry.HumanReadable = tableToMarkdown(current.title, results, Object.keys(current.MDdata), undefined, headerTransform(current.MDdata));
            entry.EntryContext[current.contextPath] = jsonToEntity(results, underscoreToCamelCase);
            entries.push(entry);
        }
        return entries;
    }

    var results;
    login();
    switch (command) {
        case 'test-module':
            return 'ok';
        case 'endgame-investigation-results':
            results = getInvestigationResults(args.investigation_id);
            logout();
            return results;
        case 'endgame-investigation-status':
            return getInvestigationStatus(args.investigation_id)
        case 'endgame-get-unmanaged-endpoints':
            results = getUnmanagedEndpoints();
            res = resToEntry(results.data);
            res[0].EntryContext['EndGame(true)'] = {'TransactionID' : results.metadata.transaction_id};
            logout();
            return res;
        case 'endgame-get-deployment-profiles':
            results = getDeploymentProfiles();
            break;
        case 'endgame-get-endpoint-status':
            results = getEndpointStatus(args);
            break;
        case 'endgame-create-sensor-profile':
            results = createSensorProfile(args.name, args.transceiver, args.sensor_version, args.sensor_directory, args.api_key);
            break;
        case 'endgame-create-investigation':
            results = createInvestigation(args.investigation_name, args.assign_to ? args.assign_to : params.username.identifier, args.sensors, args.endpoints, args);
            break;
        case 'endgame-get-investigations':
            results = getInvestigations();
            break;
        case 'endgame-get-sensor':
            results = getSensor(args.sensor_id);
            break;
        case 'endgame-deploy':
            results = deploy(args.domain, args.username, args.password, args.api_key, args.endpoints_transaction_id, args.deployment_profile, makeArray(args.endpoint_ips), makeArray(args.endpoint_ids));
            if(results.submitted){
                results.deployment_profile = args.deployment_profile;
                results.id = results.submitted;
                results.domain = args.domain;
                results.submitted = undefined;
            }
            break;
    }
    logout();
    return resToEntry(results);
  type: javascript
  commands:
  - name: endgame-deploy
    arguments:
    - name: domain
      required: true
      description: Deployment domain
    - name: username
      required: true
      description: Machine username
    - name: password
      required: true
      description: Machine password
    - name: api_key
      required: true
      description: API key
    - name: deployment_profile
      required: true
      description: The ID of the sensor profile to be deployed. To get the ID, run the `!endgame-get-deployment-profiles` command.
    - name: endpoints_transaction_id
      description: The ID of the last transaction. To get the ID, run the `!endgame-get-unmanaged-endpoints` command or the `endgame-get-endpoint-status` command. The value is available from the ${EndGame.TransactionID} context key.
    - name: endpoint_ids
      description: The IDs of endpoints to be deployed. Must also provide IPs. To get the IDs, run the `!endgame-get-unmanaged-endpoints` command, and copy the ID (not to be confused with the machine ID).
    - name: endpoint_ips
      description: The IP addresses of endpoints to be deployed. Must also provide IDs.
    outputs:
    - contextPath: EndGame.Deployment.DeploymentProfile
      description: The deployed sensor profile
    - contextPath: EndGame.Deployment.Domain
      description: The deployed domain
    - contextPath: EndGame.Deployment.Submitted.Id
      description: Deploy ID
    description: 'Deploy sensor profile to unmanaged endpoints. '
  - name: endgame-get-deployment-profiles
    arguments: []
    outputs:
    - contextPath: EndGame.SensorProfiles.ApiKey
      description: API Key of sensor profile
    - contextPath: EndGame.SensorProfiles.Id
      description: ID of sensor profile
    - contextPath: EndGame.SensorProfiles.SensorDirectory
      description: DIrectory of the sensor profile
    - contextPath: EndGame.SensorProfiles.Name
      description: Name of sensor profile
    - contextPath: EndGame.SensorProfiles.UpdatedAt
      description: Last time sensor was updated
    - contextPath: EndGame.SensorProfiles.Receiver
      description: Receiver IP address
    - contextPath: EndGame.SensorProfiles.CreatedAt
      description: Date and time sensor was created
    - contextPath: EndGame.SensorProfiles.SensorVersion
      description: Version of sensor
    - contextPath: EndGame.SensorProfiles.Config
      description: Sensor profile configuration
    description: Get all deployment (sensor) profiles
  - name: endgame-get-unmanaged-endpoints
    arguments: []
    outputs:
    - contextPath: EndGame.TransactionID
      description: ID of transaction to use when deploying
    - contextPath: EndGame.Endpoints.MachineId
      description: Endgame ID of the machine
    - contextPath: EndGame.Endpoints.CoreOs
      description: Core OS of the machine
    - contextPath: EndGame.Endpoints.Name
      description: Name of the machine
    - contextPath: EndGame.Endpoints.Status
      description: Status of hte machine
    - contextPath: EndGame.Endpoints.IpAddress
      description: IP address of the machine
    - contextPath: EndGame.Endpoints.UpdatedAt
      description: Last updates time
    - contextPath: EndGame.Endpoints.ID
      description: Endpoint ID
    description: Get all unmanaged endpoint details
  - name: endgame-get-endpoint-status
    arguments:
    - name: ip_address
      description: IP address of machine
    - name: name
      description: Name of machine
    - name: machine_id
      description: EndGame machine ID
    outputs:
    - contextPath: EndGame.TransactionID
      description: id of transaction to use when deploying
    - contextPath: EndGame.Endpoints.MachineId
      description: Endgame id of the machine
    - contextPath: EndGame.Endpoints.CoreOs
      description: Core OS of the machine
    - contextPath: EndGame.Endpoints.Name
      description: Name of the machine
    - contextPath: EndGame.Endpoints.Status
      description: Status of hte machine
    - contextPath: EndGame.Endpoints.IpAddress
      description: IP address of the machine
    - contextPath: EndGame.Endpoints.UpdatedAt
      description: Last updates time
    description: Get specified endpoint status. Must provide at least one argument
  - name: endgame-create-sensor-profile
    arguments:
    - name: name
      required: true
      description: Name of sensor profile
    - name: transceiver
      required: true
      description: Transceiver address of sensor profile
    - name: sensor_version
      required: true
      description: Version of sensor profile
    - name: api_key
      required: true
      description: API key of sensor profile
    - name: sensor_directory
      required: true
      description: Sensor profile directory
    outputs:
    - contextPath: EndGame.SensorProfiles.Id
      description: EndGame ID of created sensor profile
    - contextPath: EndGame.SensorProfiles.Name
      description: Name of created sensor profile
    description: Create deployment (sensor) profile
  - name: endgame-get-investigations
    arguments: []
    outputs:
    - contextPath: EndGame.Investigations.TaskCompletion
      description: Task completion status
    - contextPath: EndGame.Investigations.Name
      description: Name of investigation
    - contextPath: EndGame.Investigations.EndpointCount
      description: Number of endpoints for investigation
    - contextPath: EndGame.Investigations.CreatedAt
      description: Time created
    - contextPath: EndGame.Investigations.UpdatedAt
      description: Time last updated
    - contextPath: EndGame.Investigations.UserDisplayName
      description: Display name of user that created th investigation
    - contextPath: EndGame.Investigations.CoreOs
      description: Core OS of investigation
    description: Get all endgame investigations
  - name: endgame-create-investigation
    arguments:
    - name: investigation_name
      required: true
      description: Name of investigation
    - name: sensors
      description: Sensor ID's of machines to investigate. Overrides endpoints argument
    - name: endpoints
      description: Names of machines to investigate. Overridden by sensors argument
    - name: assign_to
      description: Default is the username given in the instance credentials
    - name: network_local_ip
      description: local ip address for network search
    - name: network_protocol
      description: protocol for netwprk search
    - name: network_remote_ips
      description: remote ips (comma separated) for network search
    - name: network_port
      description: port for network search
    - name: network_remote
      description: true for remote, false otherwise. Used for network search
    - name: process
      description: name of process to search
    - name: process_sha1s
      description: sha1s of process (comma separated)
    - name: process_md5s
      description: md5s of process (comma separated)
    - name: process_sha256s
      description: sha256s of process (comma separated)
    - name: file_dir
      description: Directory of file to search
      defaultValue: 'C:'
    - name: file_regexes
      description: regexes of file to search
    - name: file_sha256s
      description: sha256s of files to search (comma separated)
    - name: file_sha1s
      description: sha1s of files to search (comma separated)
    - name: file_md5s
      description: md5s of files to search (comma separated)
    - name: registry_key
      description: Registry Key or Value Name Containing
    - name: registry_max_size
      description: max size of registry to search
    - name: registry_min_size
      description: min size of registry to search
    - name: user_search_domain
      description: Domain to search
    - name: user_search
      description: username to search
    outputs:
    - contextPath: EndGame.Investigations.Id
      description: Id of created investigation
    description: 'Create endgame IOC investigation. '
  - name: endgame-get-sensor
    arguments:
    - name: sensor_id
      required: true
      description: ID of sensor profile
    outputs:
    - contextPath: EndGame.SensorProfiles.Config
      description: Sensor profile configuration details
    - contextPath: EndGame.SensorProfiles.ApiKey
      description: API key of sesnor profile
    - contextPath: EndGame.SensorProfiles.AccountId
      description: Account ID
    - contextPath: EndGame.SensorProfiles.Name
      description: Name of sensor profile
    - contextPath: EndGame.SensorProfiles.UpdatedAt
      description: Date and time sensor was last changed
    - contextPath: EndGame.SensorProfiles.Receiver
      description: Receiver of sensor profile
    - contextPath: EndGame.SensorProfiles.SensorDirectory
      description: Directory of sensor profile
    - contextPath: EndGame.SensorProfiles.Deleted
      description: Is sensor profile deleted
    - contextPath: EndGame.SensorProfiles.CreatedAt
      description: Date and time sensor profile was created
    - contextPath: EndGame.SensorProfiles.Id
      description: Id of sensor
    - contextPath: EndGame.SensorProfiles.SensorVersion
      description: Version of given sensor
    description: Get sensor data by id
  - name: endgame-investigation-results
    description: Get investigation results by id
    arguments:
    - name: investigation_id
      description: Id of investigation
    outputs:
    - contextPath: EndGame.InvestigationResults.Files
      description: File investigation results
    - contextPath: EndGame.InvestigationResults.Usernames
      description: Username investigation results
    - contextPath: EndGame.InvestigationResults.Processes
      description: Processes investigation results
    - contextPath: EndGame.InvestigationResults.Registries
      description: Registries investigation results
    - contextPath: EndGame.InvestigationResults.Networks
      description: Networks investigation results
  - name: endgame-investigation-status
    arguments:
    - name: investigation_id
      required: true
      description: Id of investigation
    outputs:
    - contextPath: EndGame.Investigations.Id
      description: Endgame ID of investigation
    - contextPath: EndGame.Investigations.Status
      description: Endgame investigation status
    description: Returns the current investigation status
tests:
  - No test - no instance