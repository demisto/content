commonfields:
  id: Symantec Endpoint Protection
  version: -1
name: Symantec Endpoint Protection
display: Symantec Endpoint Protection
category: Endpoint
image: data:image/png;base64,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
description: Query the Symantec Endpoint Protection Manager using the official REST
  API.
detaileddescription: Integration with Symantec Endpoint Protection Manager using the
  sepm REST API.
configuration:
- display: Server (e.g. https://1.2.3.4:8446)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Authentication
  name: authentication
  defaultvalue: ""
  type: 9
  required: true
- display: SEPM domain for the user
  name: domain
  defaultvalue: ""
  type: 0
  required: false
- display: Trust certificate
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: Use proxy system settings
  name: proxy
  defaultvalue: "true"
  type: 8
  required: false
script:
  script: |-
    // Default timeout and interval parameters for polling the response
    CLIENT_COMMAND_PARAMETERS = {
        'sep-update-content'    : {'timeout': 120, 'interval': 10},
        'sep-quarantine'        : {'timeout': 120, 'interval': 10},
        // Don't poll for scan response because it takes too long. The automation will do that
        'sep-scan'              : {'timeout': 1, 'interval': 1}
    }

    ENDPOINTS_INFO_DEFAULT_COLUMNS = [
        'computerName',
        'ipAddresses',
        'operatingSystem',
        'osBitness',
        'cidsDefsetVersion',
        'lastScanTime',
        'description',
        'quarantineDesc',
        'domainOrWorkgroup',
        'macAddresses',
        'group',
        'dhcpServer',
        'biosVersion',
        'virtualizationPlatform',
        'computerTimeStamp',
        'creationTime',
        'agentTimestamp'
    ]

    GROUPS_INFO_DEFAULT_COLUMNS = [
        'fullPathName',
        'numberOfPhysicalComputers',
        'numberOfRegisteredUsers',
        'policySerialNumber',
        'policyDate',
        'description',
        'created'
    ]

    var fixUrl = function(base) {
        return ((base[base.length - 1] != '/') ? (base + '/') : base);
    }

    var buildArgs = function(args) {
        sArgs = Object.keys(args).map(function(key) {
            return [key, args[key]].map(encodeURIComponent).join("=");
        }).join("&");
        if (sArgs) {
            return '?' + sArgs;
        } else {
            return '';
        }
    }

    var buildClientXml = function(data) {
        return '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:cli="http://client.webservice.sepm.symantec.com/"> \
                <soapenv:Header/><soapenv:Body>{0}</soapenv:Body></soapenv:Envelope>'.format(data);
    }

    var buildCommandXml = function(data) {
        return '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:com="http://command.client.webservice.sepm.symantec.com/"> \
                <soapenv:Header/><soapenv:Body>{0}</soapenv:Body></soapenv:Envelope>'.format(data);
    }

    var parseResponse = function(resp) {
        if (resp.StatusCode === 200) {
            try {
                return JSON.parse(resp.Body);
            } catch (e) {
                return resp.Body;
            }
        } else {
            err = resp.Status;
            if (resp.Body) {
                err += '\n' + resp.Body;
            }
            throw err;
        }
    }

    var doAuth = function() {
        url = fixUrl(params.server) + 'sepm/api/v1/identity/authenticate';
        body = {
            username: (params.authentication ? params.authentication.identifier : ''),
            password: (params.authentication ? params.authentication.password : ''),
            domain: (params.domain ? params.domain : '')
        };
        res = http(
            url,
            {
                Method: 'POST',
                Headers: {"Content-Type": ["application/json"]},
                Body: JSON.stringify(body),

            },
            params.insecure,
            params.proxy
        );

        return res;
    };

    var doGet = function(token, raw, suffix) {
        url = fixUrl(params.server) + suffix + buildArgs(args);
        res = http(
            url,
            {
                Method: 'GET',
                Headers: {'Authorization': ['Bearer ' + token]}
            },
            params.insecure,
            params.proxy
        );

        if (raw) {
            return res;
        } else {
            return parseResponse(res);
        }
    }

    var doPost = function(token, is_xml, suffix, body) {
        url = fixUrl(params.server) + suffix;
        res = http(
            url,
            {
                Method: 'POST',
                Headers: {'Authorization': ['Bearer ' + token]},
                Body: body

            },
            params.insecure
        );

        res = parseResponse(res);
        if (is_xml) {
            res = JSON.parse(x2j(res));
        }

        return res;
    }

    var systemInfo = function(token) {
        versionJson = doGet(token, false, 'sepm/api/v1/version');
        avdefJson = doGet(token, false, 'sepm/api/v1/content/avdef/latest');

        var systemInfoJson = {
            'version': versionJson,
            'avdef': avdefJson
        };

        var md = '## System Information\n';
        md += '### Version\n';
        md += objToMd(versionJson);
        md += '### AV Definitions\n';
        md += objToMd(avdefJson);

        return {
            Type: entryTypes.note, Contents: systemInfoJson, ContentsFormat: formats.json, HumanReadable: md,
            EntryContext: {'SEPM.ServerAVDefVersion': systemInfoJson.avdef.publishedBySymantec}
        };
    }

    var clientContent = function(token) {
        clientContentJson = doGet(token, false, 'sepm/api/v1/stats/client/content');

        var lastUpdatedDate = (new Date(parseInt(clientContentJson.lastUpdated))).toString();
        var md = '## Client Content, last updated on {0}\n'.format(lastUpdatedDate);
        md += tblToMd('Client Content Versions', clientContentJson.clientDefStatusList);

        return {
            Type: entryTypes.note, Contents: clientContentJson, ContentsFormat: formats.json, HumanReadable: md,
            EntryContext: {'SEPM.ClientContentVersions': clientContentJson.clientDefStatusList, 'SEPM.LastUpdated': lastUpdatedDate}
        };
    }

    var endpointsInfo = function(token) {
        jsonRes = doGet(token, false, 'sepm/api/v1/computers');

        md = '## Endpoints Information';
        if (args.hostname) {
            // Set the war room result
            md += ', filtered for hostname: ' + args.hostname + '\n';
            var filteredJsonRes = {}
            jsonRes.content.forEach(function(h) {
                if (h.computerName == args.hostname) {
                    filteredJsonRes = h;
                }
            });

            // Set the entry context
            entryContext = {
                'SEPM.Endpoint.Hostname': filteredJsonRes.computerName,
                'SEPM.Endpoint.Domain': filteredJsonRes.domainOrWorkgroup,
                'SEPM.Endpoint.IPAddresses': filteredJsonRes.ipAddresses,
                'SEPM.Endpoint.OS': filteredJsonRes.operatingSystem + ' | ' + filteredJsonRes.osBitness,
                'SEPM.Endpoint.Description': filteredJsonRes.description,
                'SEPM.Endpoint.MACAddress': filteredJsonRes.macAddress,
                'SEPM.Endpoint.BIOSVersion': filteredJsonRes.biosVersion,
                'SEPM.Endpoint.DHCPServer': filteredJsonRes.dhcpServer
            };
        } else {
            md += '\n';
            filteredJsonRes = jsonRes.content;
            entryContext = {};
        }

        // Set the war room result
        if (args.columns) {
            if (args.columns == 'all' || args.columns == '*') {
                columnsList = [];
            } else {
                columnsList = argToList(args.columns);
            }
        } else {
            columnsList = ENDPOINTS_INFO_DEFAULT_COLUMNS;
            columnsList.sort();
        }

        md += tblToMd('Endpoints', filteredJsonRes, columnsList);
        return {Type: entryTypes.note, Contents: filteredJsonRes, ContentsFormat: formats.json, HumanReadable: md, EntryContext: entryContext};
    }

    var groupsInfo = function(token) {
        jsonRes = doGet(token, false, 'sepm/api/v1/groups');

        // Set the entry context
        entryContext = {}
        entryContext['SEPM.Groups'] = [];
        jsonRes.content.forEach(function(entry) {
            var group = {}
            GROUPS_INFO_DEFAULT_COLUMNS.forEach(function(h) {
                group[h] = entry[h];
            });
            entryContext['SEPM.Groups'].push(group);
        });

        // Set the war room result
        if (args.columns) {
            if (args.columns == 'all' || args.columns == '*') {
                columnsList = [];
            } else {
                columnsList = argToList(args.columns);
            }
        } else {
            columnsList = GROUPS_INFO_DEFAULT_COLUMNS;
            columnsList.sort();
        }

        md = tblToMd('Groups Information', jsonRes.content, columnsList);
        return {Type: entryTypes.note, Contents: jsonRes, ContentsFormat: formats.json, HumanReadable: md, EntryContext: entryContext};
    }

    var getComputerIdByIp = function(token, ip) {
        xml = buildClientXml('<cli:getComputersByIP><ipAddresses>{0}</ipAddresses></cli:getComputersByIP>'.format(ip));
        resJson = doPost(token, true, 'sepm/ws/v1/ClientService', xml);

        return resJson.Envelope.Body.getComputersByIPResponse.ComputerResult.computers.computerId;
    }

    var getComputerIdByHostname = function(token, hostname) {
        xml = buildClientXml('<cli:getComputersByHostName><computerHostNames>{0}</computerHostNames></cli:getComputersByHostName>'.format(hostname));
        resJson = doPost(token, true, 'sepm/ws/v1/ClientService', xml);

        return resJson.Envelope.Body.getComputersByHostNameResponse.ComputerResult.computers.computerId;
    }

    var getComputerId = function(token) {
        if (args.ip) {
            try {
                computerId = getComputerIdByIp(token, args.ip);
            } catch (err) {
                throw 'Failed to locate the endpoint by its IP address.';
            }
        } else if (args.hostname) {
            try {
                computerId = getComputerIdByHostname(token, args.hostname);
            } catch (err) {
                throw 'Failed to locat the endpoint by its hostname.';
            }
        } else {
            throw 'Please provide the IP address or the hostname of endpoint.';
        }

        return computerId;
    }

    var getCommandStatusDetails = function(token, commandId) {
        xml = buildCommandXml('<com:getCommandStatusDetails><commandID>{0}</commandID></com:getCommandStatusDetails>'.format(commandId));
        resJson = doPost(token, true, 'sepm/ws/v1/CommandService', xml);

        return resJson;
    }

    var pollResponse = function(token, commandId, timeout, interval) {
        retries = timeout / interval;
        isDone = false;
        for (var i = 0; i < retries; i++) {
            commandStatusJson = getCommandStatusDetails(token, commandId);
            cmdStatusDetail = commandStatusJson.Envelope.Body.getCommandStatusDetailsResponse.CommandStatusDetailResult.cmdStatusDetail;
            stateId = cmdStatusDetail.stateId;
            if (stateId == '2' || stateId == '3') {
                isDone = true;
                break;
            }

            wait(interval);
        }

        return {
            'cmdStatusDetail': cmdStatusDetail,
            'isDone': isDone
        }
    }

    var buildCommandResponseOutput = function(title, commandId, message) {
        cmdStatusDetail = response.cmdStatusDetail;
        delete cmdStatusDetail.hardwareKey;

        md = '### ' + title + '\n';
        md += objToMd(cmdStatusDetail) + '\n';
        md += '### Command ID: {0}\n'.format(commandId);
        md += '### ' + message;

        return {Type: entryTypes.note, Contents: {'cmdStatusDetail': cmdStatusDetail, 'commandId': commandId}, ContentsFormat: formats.json, HumanReadable: md,
                EntryContext: {'SEPM.LastCommand': {'CommandDetails': cmdStatusDetail, 'CommandId': commandId}}};
    }

    var runClientCommand = function(token, command) {
        try {
            computerId = getComputerId(token);
        }
        catch (err) {
            return {Type: entryTypes.error, Contents: err, ContentsFormat: formats.json, HumanReadable: err, EntryContext: {}};
        }

        timeout = args.timeout ? parseInt(args.timeout) : CLIENT_COMMAND_PARAMETERS[command]['timeout'];
        interval = args.interval ? parseInt(args.interval) : CLIENT_COMMAND_PARAMETERS[command]['interval'];

        switch (command) {
            case 'sep-update-content':
                commandId = updateContent(token, computerId);
                break;
            case 'sep-scan':
                commandId = scan(token, computerId);
                break;
            case 'sep-quarantine':
                commandId = quarantine(token, computerId);
                break;
            default:
                throw 'Invalid command.';
        }

        response = pollResponse(token, commandId, timeout, interval);
        endpoint = args.hostname ? args.hostname : args.ip;
        title = 'Launched {0} command for endpoint {1}, here is the output.\n'.format(command, endpoint);

        if (response.isDone) {
            message = 'Command is done.';
        } else if (command == 'sep-scan') {
            message = 'Command is in progress.';
        } else {
            message = 'Command timed out after {0} second(s). Run !sep-command-status to check again.'.format(timeout);
        }

        return buildCommandResponseOutput(title, commandId, message);
    }

    var commandStatus = function(token) {
        // Poll once for a response (timeout=1, interval=1)
        response = pollResponse(token, args.commandId, 1, 1);
        message = response.isDone ? 'Command is done.' : 'Command is in progress. Run !sep-command-status to check again.';

        return buildCommandResponseOutput('Command status:', args.commandId, message);
    }

    var updateContent = function(token, computerId) {
        xml = buildCommandXml('<com:runClientCommandUpdateContent><computerGUIDList>{0}</computerGUIDList></com:runClientCommandUpdateContent>'.format(computerId));
        resJson = doPost(token, true, 'sepm/ws/v1/CommandService', xml);
        commandId = resJson.Envelope.Body.runClientCommandUpdateContentResponse.CommandClientResult.commandId;

        return commandId;
    }

    var scan = function(token, computerId) {
        xml = buildCommandXml('<com:runClientCommandScan><computerGUIDList>{0}</computerGUIDList><scanType>{1}</scanType></com:runClientCommandScan>'.format(computerId, args.scanType));
        resJson = doPost(token, true, 'sepm/ws/v1/CommandService', xml);
        commandId = resJson.Envelope.Body.runClientCommandScanResponse.CommandClientResult.commandId;

        return commandId;
    }

    var quarantine = function(token, computerId) {
        xml = buildCommandXml('<com:runClientCommandQuarantine><command><commandType>{0}</commandType><targetObjectIds>{1}</targetObjectIds><targetObjectType>COMPUTER</targetObjectType></command></com:runClientCommandQuarantine>'.format(args.actionType, computerId));
        resJson = doPost(token, true, 'sepm/ws/v1/CommandService', xml);
        commandId = resJson.Envelope.Body.runClientCommandQuarantineResponse.CommandClientResult.commandId;

        return commandId;
    }

    var resp = doAuth(params);
    var token;
    if (resp.StatusCode === 200) {
        token = JSON.parse(resp.Body).token;
    } else {
        return resp;
    }

    switch (command) {
        case 'test-module':
            if (resp.StatusCode === 200) {
                return 'ok';
            } else if (resp.Status) {
                return resp.Status;
            } else {
                return resp;
            }
            break;
        case 'sep-system-info':
            return systemInfo(token);
        case 'sep-client-content':
            return clientContent(token);
        case 'sep-endpoints-info':
            return endpointsInfo(token);
        case 'sep-groups-info':
            return groupsInfo(token);
        case 'sep-command-status':
            return commandStatus(token);
        case 'sep-update-content':
        case 'sep-scan':
        case 'sep-quarantine':
            return runClientCommand(token, command);
        default:
    }
  type: javascript
  commands:
  - name: sep-endpoints-info
    arguments:
    - name: columns
      description: The columns to show.
    - name: hostname
      description: If given, show information only about the specific hostname.
    outputs:
    - contextPath: SEPM.Endpoint.Hostname
      description: The endpoint's hostname.
    - contextPath: SEPM.Endpoint.Domain
      description: The endpoint's domain.
    - contextPath: SEPM.Endpoint.IPAddresses
      description: The endpoint's IP addresses.
    - contextPath: SEPM.Endpoint.OS
      description: The endpoint's OS information.
    - contextPath: SEPM.Endpoint.Description
      description: The endpoint's description.
    - contextPath: SEPM.Endpoint.MACAddress
      description: The endpoint's MAC address.
    - contextPath: SEPM.Endpoint.BIOSVersion
      description: The endpoint's BIOS version.
    - contextPath: SEPM.Endpoint.DHCPServer
      description: The endpoint's DHCP server address.
    description: Get information about endpoints.
  - name: sep-update-content
    arguments:
    - name: ip
      description: The IP of the endpoint.
    - name: hostname
      description: The hostname of the endpoint.
    - name: timeout
      description: The timeout of the command.
    - name: interval
      description: The polling interval of the command.
    outputs:
    - contextPath: SEPM.LastCommand.CommandDetails
      description: The details of the command.
    - contextPath: SEPM.LastCommand.CommandId
      description: The ID of the command.
    description: Updates the content of the given client.
  - name: sep-scan
    arguments:
    - name: ip
      description: The IP of the endpoint.
    - name: scanType
      required: true
      auto: PREDEFINED
      predefined:
      - ScanNow_Quick
      - ScanNow_Full
      - ScanNow_Custom
      description: Type of scan.
    - name: hostname
      description: The hostname of the endpoint.
    - name: timeout
      description: The timeout of the command.
    - name: interval
      description: The polling interval of the command.
    outputs:
    - contextPath: SEPM.LastCommand.CommandDetails
      description: The details of the command.
    - contextPath: SEPM.LastCommand.CommandId
      description: The ID of the command.
    description: Scans an endpoint.
  - name: sep-groups-info
    arguments:
    - name: columns
      description: The columns to show.
    outputs:
    - contextPath: SEPM.Groups
      description: The list of groups.
    description: Get information about groups.
  - name: sep-system-info
    arguments: []
    outputs:
    - contextPath: SEPM.ServerAVDefVersion
      description: The serverAV definition version.
    description: Get the system information (version, AV definition).
  - name: sep-command-status
    arguments:
    - name: commandId
      required: true
      description: The command ID.
    outputs:
    - contextPath: SEPM.LastCommand.CommandDetails
      description: The details of the command.
    - contextPath: SEPM.LastCommand.CommandId
      description: The ID of the command.
    description: Retrieves the status of a command.
  - name: sep-quarantine
    arguments:
    - name: ip
      description: The IP address of the endpoint.
    - name: hostname
      description: The hostname of the endpoint.
    - name: timeout
      description: The timeout of the command.
    - name: interval
      description: The polling interval of the command.
    - name: actionType
      required: true
      auto: PREDEFINED
      predefined:
      - Quarantine
      - Undo
      description: The action type.
    outputs:
    - contextPath: SEPM.LastCommand.CommandDetails
      description: The details of the command.
    - contextPath: SEPM.LastCommand.CommandId
      description: The ID of the command.
    description: Quarantines the endpoint according to its policy.
  - name: sep-client-content
    arguments: []
    outputs:
    - contextPath: SEPM.ClientContentVersions
      description: The versions of the clients.
    - contextPath: SEPM.LastUpdated
      description: The last-updated date.
    description: Retrieves the client content.
hidden: false
