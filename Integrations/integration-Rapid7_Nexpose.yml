commonfields:
  id: Rapid7 Nexpose_python
  version: -1
name: Rapid7 Nexpose_python
display: Rapid7 Nexpose_python
category: Vulnerability Management
image: data:image/png;base64,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
description: Rapid7's on-premise vulnerability management solution, Nexpose, helps
  you reduce your threat exposure by enabling you to assess and respond to changes
  in your environment real time and prioritizing risk across vulnerabilities, configurations,
  and controls.
configuration:
- display: Server URL (e.g. https://192.168.0.1:8080)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Username
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "false"
  type: 8
  required: false
- display: 2FA token
  name: token
  defaultvalue: ""
  type: 0
  required: false
script:
  script: |-
    from pprint import pprint
    import time
    import re
    import requests
    import json

    RANGE_OPERATORS = ['in-range', 'is-between', 'not-in-range']

    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    SITE_COOKIE = "time-zone-offset=-180; _pendo_accountId.77c79869-0135-481b-7c93-53f43e8ae3d8=21c87447-3796-4bea-848b-660358b7e1da; _pendo_visitorId.77c79869-0135-481b-7c93-53f43e8ae3d8=21c87447-3796-4bea-848b-660358b7e1da-1; i18next=en-US; hide-dashboard-tour=shown; _pendo_meta.77c79869-0135-481b-7c93-53f43e8ae3d8=2114032251; nexposeCCSessionID=5D476D9DA8DA829E607FBF8E3B4BC7ED20A29DA4; TIMEOUT=session-alive'"
    SESSION = "5D476D9DA8DA829E607FBF8E3B4BC7ED20A29DA4"
    USERNAME = demisto.params()['credentials']['identifier']
    PASSWORD = demisto.params()['credentials']['password']
    VERIFY_SSL = not demisto.params().get('insecure', False)
    TOKEN = demisto.params().get('token', None)



    def get_server_url():
        url = demisto.params()['server']
        url = re.sub('/[\/]+$/', '', url)
        url = re.sub('\/$', '', url)
        return url


    def load_proxy():
        proxy = {}
        if "proxy" in demisto.params():
            proxy["http"] = os.environ["http_proxy"]
            proxy["https"] = os.environ["https_proxy"]
        return proxy

    BASE_URL = get_server_url()
    SERVER_URL = BASE_URL + '/api/3'
    PROXY = load_proxy()


    def get_headers():
        headers = {
           'Content-Type': 'application/json'
        }

        if TOKEN is not None:
            headers['Token'] = TOKEN
        return headers


    def get_site_headers():
        headers = get_headers()

        headers['Cookie'] = SITE_COOKIE
        headers['nexposeCCSessionID'] = SESSION

        return headers


    def send_request(path, method = 'get', body = {}, params = {}, headers = None, is_file=False):
        url = '%s/%s' % (SERVER_URL, path)
        headers = headers if headers is not None else get_headers()
        res = requests.request(method, url, headers=headers, data=json.dumps(body), params=params, auth=(USERNAME, PASSWORD),
        verify=VERIFY_SSL, proxies = PROXY)
        if res.status_code < 200 or res.status_code >= 300:
            raise Exception('Body: ' + json.dumps(body) + ' Got status code ' + str(res.status_code) + ' with url ' + url + ' with body ' + res.content + ' with headers ' + str(res.headers))
        return res.json() if is_file is False else res.content

    def dq(obj, path):
      '''
      return a value in an object path. in case of multiple objects in path, searches them all.
      @param obj - dictionary tree to search in
      @param path (list) - a path of the desired value in the object. for example: ['root', 'key', 'subkey']
      '''
      if len(path) == 0:
          return obj

      if isinstance(obj, dict):
          if path[0] in obj:
              return dq(obj[path[0]], path[1:])
      elif isinstance(obj, list):
          # in case current obj has multiple objects, search them all.
          l = [dq(o, path) for o in obj]
          return [k for k in l if k is not None]

      # in case of error in the path
      return None


    def translate_single_object(obj, map_fields, filter_func=None):
      if filter_func is None:
          filter_func = lambda mf: True

      d = {}
      for f in map_fields:
          if filter_func(f):
              d[f['to']] = dq(obj, f['from'].split('.'))

      return d


    def translate_object(content, map_fields, filter_func=None):
      '''
      Converts object fields according to mapping dictionary
      @param content - original content to copy
      @param mapFields - an object assosiating source and destination object fields
      @filter_func - function to filter out fields
      @returns the mapped object
      '''
      if isinstance(content, (list, tuple)):
          return [translate_single_object(item, map_fields, filter_func) for item in content]
      else:
          return translate_single_object(content, map_fields, filter_func)


    def get_site(asset_id):
        url = BASE_URL + '/data/assets/' + str(asset_id) + '/scans'
        headers = get_site_headers()
        res = requests.post(url, headers=headers, auth=(USERNAME, PASSWORD), verify=VERIFY_SSL)
        if res.status_code < 200 or res.status_code >= 300:
            raise Exception('Got status code ' + str(res.status_code) + ' with body ' + res.content + ' with headers ' + str(res.headers))
        response = res.json()
        if response is None or response['records'] is None or len(response['records']) == 0:
            return ''

        return {
            'id': response['records'][0]['siteID'],
            'name': response['records'][0]['siteName'],
            'ip': response['records'][0]['ipAddress']
        }

    def get_list_response(path, method='get', limit=None, body={}, params={}):
        final_result = []
        page_diff = 0
        page_number = 0

        while True:
            page = page_number
            page_number += 1
            params['page'] = page
            if limit is not None:
                params['size'] = limit
            response = send_request(path,method=method,body=body, params=params)
            if not response:
                break
            if response['resources'] is not None:
                final_result = final_result + response['resources']
            if response['page'] is not None:
                page_diff = response['page']['totalPages'] - response['page']['number']
            if page_diff < 1 or limit is not None:
                break

        return final_result


    def get_last_scan(asset):
        if asset['history'] is None:
            return "-"
        sorted_dates = sorted(asset['history'], key=lambda h: time.strptime(h['date'], "%Y-%m-%dT%H:%M:%S.%fZ"), reverse=True)

        if sorted_dates[0] is not None:
            return {
                    'date': sorted_dates[0]['date'] if 'date' in sorted_dates[0] else '-',
                    'id': sorted_dates[0]['scanId'] if 'scanId' in sorted_dates[0] else '-'
                }
        else:
            return {
                    'date': '-',
                    'id': '-'
                }

    def get_asset_command():
        asset = get_asset(demisto.args()['id'])

        if asset is None:
            return "Asset not found"
        last_scan = get_last_scan(asset)
        asset['LastScanDate'] = last_scan['date']
        asset['LastScanId'] = last_scan['id']
        asset['Site'] = get_site(asset['id'])['name']

        assetHeaders = [
        'AssetId',
        'Addresses',
        'Hardware',
        'Aliases',
        'HostType',
        'Site',
        'OperatingSystem',
        'CPE',
        'LastScanDate',
        'LastScanId',
        'RiskScore'
        ]

        assetOutput = translate_object(asset, [
            {'from': 'id', 'to': 'AssetId'},
            {'from': 'addresses.ip', 'to': 'Addresses'},
            {'from': 'addresses.mac', 'to': 'Hardware'},
            {'from': 'hostNames.name', 'to': 'Aliases'},
            {'from': 'type', 'to': 'HostType'},
            {'from': 'Site', 'to': 'Site'},
            {'from': 'os', 'to': 'OperatingSystem'},
            {'from': 'vulnerabilities.total', 'to': 'Vulnerabilities'},
            {'from': 'cpe.v2.3', 'to': 'CPE'},
            {'from': 'LastScanDate', 'to': 'LastScanDate'},
            {'from': 'LastScanId', 'to': 'LastScanId'},
            {'from': 'riskScore', 'to': 'RiskScore'}
        ])

        softwareOutput = None
        servicesOutput = None
        usersOutput = None

        if 'software' in asset and len(asset['software']) > 0:
            softwareHeaders = [
                'Software',
                'Version'
                ]

            softwareOutput = translate_object(asset['software'], [
                {'from': 'description', 'to': 'Software'},
                {'from': 'version', 'to': 'Version'}
            ])

        if 'services' in asset and len(asset['services']) > 0:
            serviceHeaders = [
                'Name',
                'Port',
                'Product',
                'Protocol'
                ]

            servicesOutput = translate_object(asset['services'], [
                {'from': 'name', 'to': 'Name'},
                {'from': 'port', 'to': 'Port'},
                {'from': 'product', 'to': 'Product'},
                {'from': 'protocol', 'to': 'Protocol'}
            ])

        if 'users' in asset and len(asset['users']) > 0:
            userHeaders = [
                'FullName',
                'Name',
                'UserId'
                ]

            usersOutput = translate_object(asset['users'], [
                {'from': 'name', 'to': 'Name'},
                {'from': 'fullName', 'to': 'FullName'},
                {'from': 'id', 'to': 'UserId'},
            ])

        vulnerabilityHeaders = [
            'Id',
            'Title',
            'Malware',
            'Exploit',
            'CVSS',
            'Risk',
            'PublishedOn',
            'ModifiedOn',
            'Severity',
            'Instances',
            ]

        vulnerabilities = get_vulnerabilities(asset['id'])
        vulnerabilitiesOutput = []
        for v in vulnerabilities:
            detailedVuln = get_vulnerability(v['id'])
            cvss = dq(detailedVuln['cvss'], ['v3', 'score'])
            if cvss is None:
                cvss = dq(detailedVuln['cvss'], ['v2','score'])
            outputVuln = {
                'Id': v['id'],
                'Title': detailedVuln['title'],
                'Malware': detailedVuln['malwareKits'],
                'Exploit': detailedVuln['exploits'],
                'CVSS': cvss,
                'Risk': detailedVuln['riskScore'],
                'PublishedOn': detailedVuln['published'],
                'ModifiedOn': detailedVuln['modified'],
                'Severity': detailedVuln['severity'],
                'Instances': v['instances'],
            }

            vulnerabilitiesOutput.append(outputVuln)

        assetMd = tableToMarkdown('Nexpose asset ' + str(asset['id']), assetOutput, assetHeaders, removeNull=True)
        vulnerabilitiesMd = tableToMarkdown('Vulnerabilities', vulnerabilitiesOutput, vulnerabilityHeaders, removeNull=True) if len(vulnerabilitiesOutput) > 0 else ''
        softwareMd = tableToMarkdown('Software', softwareOutput, softwareHeaders, removeNull=True) if softwareOutput is not None else ''
        servicesMd = tableToMarkdown('Services', servicesOutput, serviceHeaders, removeNull=True) if servicesOutput is not None else ''
        usersMd = tableToMarkdown('Users', usersOutput, userHeaders, removeNull=True) if usersOutput is not None else ''

        md = assetMd + vulnerabilitiesMd + softwareMd + servicesMd + usersMd

        assetOutput['Vulnerability'] = vulnerabilitiesOutput
        assetOutput['Software'] = softwareOutput
        assetOutput['Service'] = servicesOutput
        assetOutput['User'] = usersOutput

        endpoint =  {
            'IP': assetOutput['Addresses'],
            'MAC': assetOutput['Hardware'],
            'HostName': assetOutput['Aliases'],
            'OS': assetOutput['OperatingSystem']
        }

        entry = {
            'Type': entryTypes['note'],
            'Contents': asset,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': md,
            'EntryContext': {
                  'Nexpose.Asset(val.AssetId==obj.AssetId)': assetOutput,
                  'Endpoint(val.IP==obj.IP)': endpoint
            }
        }

        return entry

    def get_asset(asset_id):
        path = 'assets/' + str(asset_id)
        return send_request(path)

    def get_asset_vulnerability_command():
        v = get_asset_vulnerability(demisto.args()['id'] ,demisto.args()['vulnerabilityId'])

        if v is None:
            return 'Vulnerability not found'

        vulnHeaders = [
            'Id',
            'Title',
            'Severity',
            'RiskScore',
            'CVSS',
            'CVSSV3',
            'Published',
            'Added',
            'Modified',
            'CVSSScore',
            'CVSSV3Score',
            'Categories',
            'CVES'
        ]

        detailedVuln = get_vulnerability(v['id'])
        vulnOutputs = translate_object(detailedVuln, [
            {'from': 'id', 'to': 'Id'},
            {'from': 'title', 'to': 'Title'},
            {'from': 'severity', 'to': 'Severity'},
            {'from': 'riskScore', 'to': 'RiskScore'},
            {'from': 'cvss.v2.vector', 'to': 'CVSS'},
            {'from': 'cvss.v3.vector', 'to': 'CVSSV3'},
            {'from': 'published', 'to': 'Published'},
            {'from': 'added', 'to': 'Added'},
            {'from': 'modified', 'to': 'Modified'},
            {'from': 'cvss.v2.score', 'to': 'CVSSScore'},
            {'from': 'cvss.v3.score', 'to': 'CVSSV3Score'},
            {'from': 'categories', 'to': 'Categories'},
            {'from': 'cves', 'to': 'CVES'}
        ])

        resultsHeaders = [
            "Port",
            "Protocol",
            "Since",
            "Proof",
            "Status"
        ]

        resultsOutput = []
        if 'results' in v and len(v['results']) > 0:
            resultsOutput = translate_object(v['results'], [
            {'from': 'port', 'to': 'Port'},
            {'from': 'protocol', 'to':'Protocol'},
            {'from': 'since', 'to': 'Since'},
            {'from': 'proof', 'to': 'Proof'},
            {'from': 'status', 'to':'Status'}
        ])

        # Remove HTML tags
        for r in resultsOutput:
            r['Proof'] = re.sub('<.*?>', '', r['Proof'])

        solutionsHeaders = [
            'Type',
            'Summary',
            'Steps',
            'Estimate',
            'AdditionalInformation'
        ]

        solutionsOutput = None
        solutions = get_vulnerability_solutions(demisto.args()['id'] ,demisto.args()['vulnerabilityId'])
        if solutions is not None and len(solutions) > 0:
            solutionsOutput = translate_object(solutions['resources'], [
                {'from': 'type', 'to': 'Type'},
                {'from': 'summary.text', 'to': 'Summary'},
                {'from': 'steps.text', 'to': 'Steps'},
                {'from': 'estimate', 'to': 'Estimate'},
                {'from': 'additionalInformation', 'to': 'AdditionalInformation'}
            ])

        vulnerabilitiesMd = tableToMarkdown('Vulnerability ' + demisto.args()['vulnerabilityId'], vulnOutputs, vulnHeaders, removeNull=True)
        resultsMd = tableToMarkdown('Checks', resultsOutput, resultsHeaders, removeNull=True) if len(resultsOutput) > 0 else ''
        solutionsMd = tableToMarkdown('Solutions', solutionsOutput, solutionsHeaders, removeNull=True) if solutionsOutput is not None else ''
        md = vulnerabilitiesMd + resultsMd + solutionsMd

        vulnOutputs['Checks'] = resultsOutput
        vulnOutputs['Solutions'] = solutionsOutput
        asset = {
            'AssetId': demisto.args()['id'],
            'Vulnerability': [vulnOutputs]
        }

        entry = {
            'Type': entryTypes['note'],
            'Contents': v,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': md,
            'EntryContext': {
                  'Nexpose.Asset(val.AssetId==obj.AssetId)': asset
            }
        }

        return entry


    def get_vulnerabilities(asset_id):
        path = 'assets/' + str(asset_id) + '/vulnerabilities'
        return get_list_response(path)

    def get_asset_vulnerability(asset_id, vulnerability_id):
        path = 'assets/' + str(asset_id) + '/vulnerabilities/' + str(vulnerability_id)
        return send_request(path)

    def get_vulnerability(vulnerability_id):
        path = 'vulnerabilities/' + str(vulnerability_id)
        return send_request(path)

    def get_vulnerability_solutions(asset_id, vulnerability_id):
        path = 'assets/' + str(asset_id) + '/vulnerabilities/' + str(vulnerability_id) + '/solution'

        return send_request(path)

    def search_assets_command():
        textFilters = None
        queries = demisto.args().get('query', None)
        if queries is not None:
            textFilters = queries.split(';')
        ip_address = demisto.args().get('ipAddressIs', None)
        if ip_address is not None:
            textFilters = ['ip-address is ' + ip_address]
        host_name = demisto.args().get('hostNameIs', None)
        if host_name is not None:
            textFilters = ['host-name is ' + host_name]
        risk_score = demisto.args().get('riskScoreHigherThan', None)
        if risk_score is not None:
            textFilters = ['risk-score is-greater-than ' + risk_score]
        vulnerability_title = demisto.args().get('vulnerabilityTitleContains', None)
        if vulnerability_title is not None:
            textFilters = ['vulnerability-title contains ' + vulnerability_title]
        siteIds = demisto.args().get('siteIdIn', None)
        if siteIds is not None:
            textFilters = ['site-id in ' + siteIds]

        if(textFilters is None):
            return 'No query provided for search'

        filters = get_search_filters(textFilters)
        assets = search_assets(filters, demisto.args()['match'], demisto.args().get('limit', None), demisto.args().get('sort', None))

        if(assets is None or len(assets) == 0):
            return 'No assets found'

        for asset in assets:
            last_scan = get_last_scan(asset)
            asset['LastScanDate'] = last_scan['date']
            asset['LastScanId'] = last_scan['id']
            site = get_site(asset['id'])
            asset['Site'] = site['name'] if site != '' else ''

        headers = [
        'AssetId',
        'Address',
        'Name',
        'Site',
        'Exploits',
        'Malware',
        'OperatingSystem',
        'RiskScore',
        'Assessed',
        'LastScanDate',
        'LastScanId'
        ]

        outputs = translate_object(assets, [
            {'from': 'id', 'to': 'AssetId'},
            {'from': 'ip', 'to': 'Address'},
            {'from': 'hostName', 'to': 'Name'},
            {'from': 'Site', 'to': 'Site'},
            {'from': 'vulnerabilities.exploits', 'to': 'Exploits'},
            {'from': 'vulnerabilities.malwareKits', 'to': 'Malware'},
            {'from': 'os', 'to': 'OperatingSystem'},
            {'from': 'vulnerabilities.total', 'to': 'Vulnerabilities'},
            {'from': 'riskScore', 'to': 'RiskScore'},
            {'from': 'assessedForVulnerabilities', 'to': 'Assessed'},
            {'from': 'LastScanDate', 'to': 'LastScanDate'},
            {'from': 'LastScanId', 'to': 'LastScanId'}
        ])

        endpoint = map(lambda o: {
            'IP': o['Address'],
            'HostName': o['Name'],
            'OS': o['OperatingSystem']
        }, outputs)

        entry = {
            'Type': entryTypes['note'],
            'Contents': assets,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Nexpose assets', outputs, headers,removeNull=True),
            'EntryContext': {
                  'Nexpose.Asset(val.AssetId==obj.AssetId)': outputs,
                  'Endpoint(val.IP==obj.IP)': endpoint
            }
        }

        return entry

    def get_search_filters(textFilters):
        filters = []
        for text in textFilters:
            components = text.split(' ')
            field = components[0]
            operator = components[1]
            value = components[2].split(',')
            # Convert numbers to floats if necessary
            for i, v in enumerate(value):
                currVal = None
                try:
                    currVal = float(v)
                except:
                    currVal = v
                value[i] = currVal

            flt = {
                'field': field,
                'operator': operator,
            }
            if len(value) > 1:
                if operator in RANGE_OPERATORS:
                    flt['lower'] = value[0]
                    flt['upper'] = value[1]
                else:
                    flt['values'] = value
            else:
                flt['value'] = value[0]
            filters.append(flt)
        return filters

    def search_assets(filters, match, limit=None, sort=None):
        search_body = {
            'filters': filters,
            'match': match
        }

        path = 'assets/search'
        params = {}
        if sort is not None:
            params['sort'] = sort

        return get_list_response(path, method='post', limit=limit, body=search_body, params=params)

    def get_assets_command():
        limit = demisto.args().get('limit', None)
        sort = demisto.args().get('sort', None)
        assets = get_assets(limit=limit, sort=sort)

        if(assets is None or len(assets) == 0):
            return 'No assets found'

        for asset in assets:
            last_scan = get_last_scan(asset)
            asset['LastScanDate'] = last_scan['date']
            asset['LastScanId'] = last_scan['id']
            site = get_site(asset['id'])
            asset['Site'] = site['name'] if site != '' else ''

        headers = [
        'AssetId',
        'Address',
        'Name',
        'Site',
        'Exploits',
        'Malware',
        'OperatingSystem',
        'Vulnerabilities',
        'RiskScore',
        'Assessed',
        'LastScanDate',
        'LastScanId'
        ]

        outputs = translate_object(assets, [
            {'from': 'id', 'to': 'AssetId'},
            {'from': 'ip', 'to': 'Address'},
            {'from': 'hostName', 'to': 'Name'},
            {'from': 'Site', 'to': 'Site'},
            {'from': 'vulnerabilities.exploits', 'to': 'Exploits'},
            {'from': 'vulnerabilities.malwareKits', 'to': 'Malware'},
            {'from': 'os', 'to': 'OperatingSystem'},
            {'from': 'vulnerabilities.total', 'to': 'Vulnerabilities'},
            {'from': 'riskScore', 'to': 'RiskScore'},
            {'from': 'assessedForVulnerabilities', 'to': 'Assessed'},
            {'from': 'LastScanDate', 'to': 'LastScanDate'},
            {'from': 'LastScanId', 'to': 'LastScanId'}
        ])

        endpoint = map(lambda o: {
            'IP': o['Address'],
            'HostName': o['Name'],
            'OS': o['OperatingSystem']
        }, outputs)

        entry = {
            'Type': entryTypes['note'],
            'Contents': assets,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Nexpose assets', outputs, headers,removeNull=True),
            'EntryContext': {
                  'Nexpose.Asset(val.AssetId==obj.AssetId)': outputs,
                  'Endpoint(val.IP==obj.IP)': endpoint
            }
        }

        return entry

    def get_assets(limit=None, sort=None):
        params = {}
        if sort is not None:
            params['sort'] = sort
        return get_list_response('assets', limit=limit, params=params)

    def get_scan_command():
        scan = get_scan(demisto.args()['id'])

        if(scan is None):
            return 'Scan not found'

        scanHeaders = [
            'Id',
            'ScanType',
            'ScanName',
            'StartedBy',
            'Assets',
            'TotalTime',
            'Completed',
            'Status',
            'Message'
        ]

        scanOutput = translate_object(scan, [
            {'from': 'id', 'to': 'Id'},
            {'from': 'scanType', 'to': 'ScanType'},
            {'from': 'scanName', 'to': 'ScanName'},
            {'from': 'startedBy', 'to': 'StartedBy'},
            {'from': 'assets', 'to': 'Assets'},
            {'from': 'duration', 'to': 'TotalTime'},
            {'from': 'endTime', 'to': 'Completed'},
            {'from': 'status', 'to': 'Status'},
            {'from': 'message', 'to': 'Message'}
        ])

        vulnHeaders = [
            'Critical',
            'Severe',
            'Moderate',
            'Total'
        ]

        vulnOutput = translate_object(scan['vulnerabilities'], [
            {'from': 'critical', 'to': 'Critical'},
            {'from': 'severe', 'to': 'Severe'},
            {'from': 'moderate', 'to': 'Moderate'},
            {'from': 'total', 'to': 'Total'}
        ])

        scanMd = tableToMarkdown('Nexpose scan ' + str(demisto.args()['id']), scanOutput, scanHeaders,removeNull=True)
        vulnMd = tableToMarkdown('Vulnerabilities', vulnOutput, vulnHeaders, removeNull=True)
        md = scanMd + vulnMd

        scanOutput['Vulnerabilities'] = vulnOutput

        entry = {
            'Type': entryTypes['note'],
            'Contents': scan,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': md,
            'EntryContext': {
                  'Nexpose.Scan(val.Id==obj.Id)': scanOutput,
            }
        }

        return entry

    def get_scan(scan_id):
        path = 'scans/' + str(scan_id)
        return send_request(path)

    def get_sites_command():
        sites = get_sites(limit=demisto.args().get('limit', None),sort=demisto.args().get('sort', None))

        if(sites is None or len(sites) == 0):
            return 'No sites found'

        headers = [
            'Id',
            'Name',
            'Assets',
            'Vulnerabilities',
            'Risk',
            'Type',
            'LastScan'
        ]

        outputs = translate_object(sites, [
            {'from': 'id', 'to': 'Id'},
            {'from': 'name', 'to': 'Name'},
            {'from': 'assets', 'to': 'Assets'},
            {'from': 'vulnerabilities.total', 'to': 'Vulnerabilities'},
            {'from': 'riskScore', 'to': 'Risk'},
            {'from': 'type', 'to': 'Type'},
            {'from': 'lastScanTime', 'to': 'LastScan'}
        ])

        entry = {
            'Type': entryTypes['note'],
            'Contents': sites,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Nexpose sites', outputs, headers,removeNull=True),
            'EntryContext': {
                  'Nexpose.Site(val.Id==obj.Id)': outputs,
            }
        }

        return entry

    def get_sites(limit=None, sort=None):
        path = 'sites'
        params = {}
        if sort is not None:
            params['sort'] = sort
        return get_list_response(path, limit=limit, params=params)

    def get_report_templates_command():
        templates = get_report_templates()

        if(templates is None or len(templates) == 0 or 'resources' not in templates):
            return 'No templates found'

        headers = [
            'Id',
            'Name',
            'Description',
            'Type'
        ]

        outputs = translate_object(templates['resources'], [
            {'from': 'id', 'to': 'Id'},
            {'from': 'name', 'to': 'Name'},
            {'from': 'description', 'to': 'Description'},
            {'from': 'type', 'to': 'Type'},
        ])

        entry = {
            'Type': entryTypes['note'],
            'Contents': templates,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Nexpose templates', outputs, headers,removeNull=True),
            'EntryContext': {
                  'Nexpose.Template(val.Id==obj.Id)': outputs,
            }
        }

        return entry

    def get_report_templates():
        path = 'report_templates'

        return send_request(path)

    def create_assets_report_command():
        assets = demisto.args()['assets'].split(',')
        template = demisto.args().get('template', None)
        name = demisto.args().get('name','report ' + str(datetime.now()))

        scope = {
            'assets': assets
        }

        report_id = create_report(scope, name, template)

        return download_report(report_id, name)

    def create_sites_report_command():
        sites = demisto.args()['sites'].split(',')
        template = demisto.args().get('template', None)
        name = demisto.args().get('name','report ' + str(datetime.now()))

        scope = {
            'sites': sites
        }

        report_id = create_report(scope, name, template)


        return download_report(report_id, name)

    def create_scan_report_command():
        scan = demisto.args()['scan']
        template = demisto.args().get('template', None)
        name = demisto.args().get('name','report ' + str(datetime.now()))

        scope = {
            'scan': scan
        }

        report_id = create_report(scope, name, template)


        return download_report(report_id, name)

    def create_report(scope, name, template=None):
        if template is None:
            templates = get_report_templates()
            if(templates is None or len(templates) == 0 or 'resources' not in templates):
                return 'No templates found'
            template = templates['resources'][0]['id']
        for i, (k,v) in enumerate(scope.items()):
            if not isinstance(v, list):
               scope[k] = int(v)
            else:
                for i, v in enumerate(scope[k]):
                    scope[k][i] = int(v)
        path = 'reports'
        body = {
            'scope': scope,
            'template': template,
            'name': name,
            'format': "pdf"
        }

        result = send_request(path, 'post', body=body)
        if result is None:
            return 'Failed to create report'

        return result['id']

    def download_report(report_id, name):
        # Generate the report
        path = 'reports/' + str(report_id) +' /generate'
        instance = send_request(path, 'post')
        if(instance is None):
            return 'Failed to generate report'

        headers = {
            'Accept': 'application/json',
            'Accept-Encoding': 'gzip, deflate, br'
        }

        # Wait for the report to be completed
        time.sleep(10)

        # Download
        path = 'reports/' + str(report_id) + '/history/' + str(instance['id']) + '/output'
        report = send_request(path, headers=headers, is_file=True)

        return fileResult(name + '.pdf', report)

    def start_assets_scan_command():
        ips = demisto.args().get('IPs', '').split(',')
        hostNames = demisto.args().get('hostNames', '').split(',')
        name = demisto.args().get('name', 'scan ' + str(datetime.now()))

        textFilters = None
        if len(ips) > 0:
            textFilters = ['ip-address is ' + ips[0]]
        elif len(hostNames) > 0:
            textFilters = ['host-name is ' + hostNames[0]]

        if textFilters is None:
            return 'No IPs or hosts provided'

        filters = get_search_filters(textFilters)
        asset = search_assets(filters, match='all')

        if asset is None or len(asset) == 0:
            return 'Could not find assets'

        site = get_site(asset[0]['id'])
        if site is None or 'id' not in site:
            return 'Could not find site'

        hosts = ips + hostNames
        scan = start_scan(site['id'], hosts, name)

        return scan['id']

    def start_site_scan_command():
        site = demisto.args()['site']
        name = demisto.args().get('name', 'scan ' + str(datetime.now()))
        hosts = demisto.args().get('hosts', '')

        scan = start_scan(site, hosts.split(','), name)

        if(scan is None):
            return 'Failed to start scan'

        return scan['id']

    def start_scan(site, hosts, name):
        path = 'sites/' + str(site) + '/scans'
        body = {
            #'engineId' = 1,
            #'tempalteId' = 1,
            'name': name,
            'hosts': hosts
        }

        return send_request(path, 'post', body=body)

    try:
        if demisto.command() == 'test-module':
            get_assets(limit=1)
            demisto.results('ok')
        if demisto.command() == 'nexpose-get-assets':
            demisto.results(get_assets_command())
        if demisto.command() == 'nexpose-get-asset':
            demisto.results(get_asset_command())
        if demisto.command() == 'nexpose-get-asset-vulnerability':
            demisto.results(get_asset_vulnerability_command())
        if demisto.command() == 'nexpose-search-assets':
            demisto.results(search_assets_command())
        if demisto.command() == 'nexpose-get-scan':
            demisto.results(get_scan_command())
        if demisto.command() == 'nexpose-get-sites':
            demisto.results(get_sites_command())
        if demisto.command() == 'nexpose-get-report-templates':
            demisto.results(get_report_templates_command())
        if demisto.command() == 'nexpose-create-assets-report':
            demisto.results(create_assets_report_command())
        if demisto.command() == 'nexpose-create-sites-report':
            demisto.results(create_sites_report_command())
        if demisto.command() == 'nexpose-create-scan-report':
            demisto.results(create_scan_report_command())
        if demisto.command() == 'nexpose-start-site-scan':
            demisto.results(start_site_scan_command())
        if demisto.command() == 'nexpose-start-assets-scan':
            demisto.results(start_assets_scan_command())
    except Exception as e:
        LOG(e.message)
        LOG.print_log()
        raise
  type: python
  commands:
  - name: nexpose-get-assets
    arguments:
    - name: sort
      description: 'The criteria to sort the records by, in the format: property[,ASC|DESC].
        The default sort order is ascending. Multiple sort criteria can be specified
        using multiple sort query parameters.'
      isArray: true
    - name: limit
      description: integer <int32> The number of records per page to retrieve.
    description: Returns all assets for which you have access.
  - name: nexpose-get-asset
    arguments:
    - name: id
      required: true
      description: integer <int64> The identifier of the asset.
    description: Returns the specified asset.
  - name: nexpose-search-assets
    arguments:
    - name: query
      description: Filter to match assets, multiple filters can be provided using
        ';' separator.
    - name: limit
      description: integer <int32> The number of records per page to retrieve.
    - name: sort
      description: 'The criteria to sort the records by, in the format: property[,ASC|DESC].
        The default sort order is ascending. Multiple sort criteria can be specified
        using multiple sort query parameters.'
    - name: ipAddressIs
      description: Search by a specific IP address
    - name: hostNameIs
      description: Search by a specific host name
    - name: riskScoreHigherThan
      description: Get all assets whose risk score is higher
    - name: vulnerabilityTitleContains
      description: Search by vulnerability title
    - name: siteIdIn
      description: Search by site ids
    - name: match
      auto: PREDEFINED
      predefined:
      - all
      - any
      description: Operator to determine how to match filters. all requires that all
        filters match for an asset to be included. any requires only one filter to
        match for an asset to be included.
      defaultValue: all
    description: Returns all assets for which you have access that match the given
      search criteria.
  - name: nexpose-get-scan
    arguments:
    - name: id
      required: true
      description: integer <int64> The identifier of the scan.
    description: Returns the specified scan.
  - name: nexpose-get-asset-vulnerability
    arguments:
    - name: id
      required: true
      description: integer <int64> The identifier of the asset.
    - name: vulnerabilityId
      required: true
      description: <string> The identifier of the vulnerability.
    description: Returns the details for solutions that can remediate a given vulnerability.
  - name: nexpose-get-sites
    arguments:
    - name: limit
      description: integer <int32> The number of records per page to retrieve.
    - name: sort
      description: 'The criteria to sort the records by, in the format: property[,ASC|DESC].
        The default sort order is ascending. Multiple sort criteria can be specified
        using multiple sort query parameters.'
    description: Retrieves accessible sites.
  - name: nexpose-get-report-templates
    arguments: []
    description: Returns all available report templates.
  - name: nexpose-create-assets-report
    arguments:
    - name: assets
      required: true
      description: Asset ids to create the report on
    - name: template
      description: Report template id to create the report with
    - name: name
      description: The report name
    description: Generates a new report on given assets according to a template and
      arguments.
  - name: nexpose-create-sites-report
    arguments:
    - name: sites
      required: true
      description: Site ids to create the report on
    - name: template
      description: Report template id to create the report with
    - name: name
      description: The report name
    description: Generates a new report on given sites according to a template and
      arguments.
  - name: nexpose-create-scan-report
    arguments:
    - name: scan
      required: true
      description: Id of the scan
    - name: template
      description: Report template id to create the report with
    - name: name
      description: The report name
    description: Generates a new report for a specified scan
  - name: nexpose-start-site-scan
    arguments:
    - name: site
      required: true
      description: integer <int32> The identifier of the site.
    - name: hosts
      description: The hosts that should be included as a part of the scan. This should
        be a mixture of IP Addresses and Hostnames as a comma separated string array.
    - name: name
      description: The user-driven scan name for the scan.
    description: Starts a scan for the specified site.
  - name: nexpose-start-assets-scan
    arguments:
    - name: IPs
      description: IP addresses of assets
    - name: hostNames
      description: Host names of assets
    - name: name
      description: The user-driven scan name for the scan.
    description: Starts a scan for specified asset IP addresses and host names.
  runonce: false
releaseNotes: "-"
fromversion: 3.6.0