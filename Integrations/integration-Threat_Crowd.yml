commonfields:
  id: Threat Crowd
  version: -1
name: Threat Crowd
display: Threat Crowd
category: Data Enrichment
image: data:image/png;base64,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
description: Query threat crowd for reports
defaultEnabled: true
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: https://www.threatcrowd.org
  type: 0
  required: true
- display: Version
  name: version
  defaultvalue: v2
  type: 0
  required: true
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "false"
  type: 8
  required: false
script:
  script: |-
    var server = params.server.replace(/[\/]+$/, '') + '/searchApi/' + params.version + '/';

    var commands = {
        'threat-crowd-email': {
            url: 'email',
            title: 'Threat crowd report for email %email%',
            defaultFields: {
              'type': 'Email',
            },
            translator: [
                {to: 'ThreatCrowd-Domains', from: 'domains'},
                {to: 'Address', from: 'email'},
                {to: 'Type', from: 'type'},
            ],
            contextKey: 'Account.Email(val.Address==obj.Address)',
        },
        'threat-crowd-domain': {
            url: 'domain',
            title: 'Threat crowd report for domain %domain%',
            translator: [
                {to: 'Name', from: 'domain'},
                {to: 'ThreatCrowd-Emails', from: 'emails'},
                {to: 'ThreatCrowd-SubDomains', from: 'subdomains'},
                {to: 'ThreatCrowd-References', from: 'references'},
            ],
            contextKey: 'Domain(val.Name==obj.Name)',
        },
        'threat-crowd-ip': {
            url: 'ip',
            title: 'Threat crowd report for ip %ip%',
            translator: [
                {to: 'Address', from: 'ip'},
                {to: 'ThreatCrowd-Hashes', from: 'hashes'},
                {to: 'ThreatCrowd-References', from: 'references'},
                {to: 'ThreatCrowd-Resolutions', from: 'resolutions'},
                {to: 'ThreatCrowd-Votes', from: 'votes'},
            ],
            contextKey: 'IP(val.Address==obj.Address)',
        },
        'threat-crowd-antivirus': {
            url: 'antivirus',
            title: 'Threat crowd report for antivirus %antivirus%',
            translator: [
                {to: 'Name', from: 'antivirus'},
                {to: 'Hashes', from: 'hashes'},
                {to: 'References', from: 'references'},
            ],
            contextKey: 'ThreatCrowd.AntiVirus(val.Name==obj.Name)',
        },
        'threat-crowd-file': {
            url: 'file',
            title: 'Threat crowd report for file with hash %resource%',
            translator: [
                {to: 'MD5', from: 'md5'},
                {to: 'ThreatCrowd-IPs', from: 'ips'},
                {to: 'ThreatCrowd-Domains', from: 'ips'},
                {to: 'ThreatCrowd-Resource', from: 'resource'},
                {to: 'ThreatCrowd-SHA1', from: 'sha1'},
                {to: 'ThreatCrowd-References', from: 'references'},
                {to: 'ThreatCrowd-Scans', from: 'scans'},
            ],
            contextKey: 'File(val.MD5==obj.MD5)',
        },
        'test-module': {
            url: 'email',
            defaultArgs: {
                email: 'william19770319@yahoo.com',
            },
        },
    };

    function createContext(data) {
        var createContextSingle = function(obj) {
            var res = {};
            var keys = Object.keys(obj);
            keys.forEach(function(k) {
                var values = k.split('-');
                var current = res;
                for (var j = 0; j<values.length - 1; j++) {
                    if (!current[values[j]]) {
                        current[values[j]] = {};
                    }
                    current = current[values[j]];
                }
                current[values[j]] = obj[k];
            });
            return res;
        };
        if (data instanceof Array) {
            var res = [];
            for (var j=0; j < data.length; j++) {
                res.push(createContextSingle(data[j]));
            }
            return res;
        }
        return createContextSingle(data);
    }

    function mapObjFunction(mapFields) {
        var transformSingleObj= function(obj) {
            var res = {};
            mapFields.forEach(function(f) {
               res[f.to] = dq(obj, f.from);
            });
            return res;
        };
        return function(obj) {
            if (obj instanceof Array) {
                var res = [];
                for (var j=0; j < obj.length; j++) {
                    res.push(transformSingleObj(obj[j]));
                }
                return res;
            }
            return transformSingleObj(obj);
        };
    }

    function merge(obj1, obj2) {
        if (!obj2) {
            return obj1;
        }
        keys = Object.keys(obj2);
        for (var k in keys) {
            if (obj1[keys[k]] === undefined) {
                obj1[keys[k]] = obj2[keys[k]]
            }
        }
        return obj1;
    }

    if (args.file) {
        args.resource = args.file;
        delete(args.file);
    }

    function sendRequestAndParse(commandData) {
        res = http(
            server + commandData.url + '/report/' + encodeToURLQuery(args && Object.keys(args).length ? args : commandData.defaultArgs),
            {},
            params.insecure,
            params.proxy
        );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Failed to ' + commandData.url + ' , request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }
        entry = {
            Type: entryTypes.note,
            Contents: JSON.parse(res.Body),
            ContentsFormat: formats.json,
        };
        if (commandData.translator) {
            data = mapObjFunction(commandData.translator)(merge(merge(entry.Contents, args), commandData.defaultFields));
            entry.ReadableContentsFormat = formats.markdown;
            entry.HumanReadable = tableToMarkdown(replaceInTemplates(commandData.title, args), data);
            entry.EntryContext = {};
            entry.EntryContext[commandData.contextKey] = createContext(data);
        }
        return entry;
    }

    res = sendRequestAndParse(commands[command]);
    if (command === 'test-module') {
        return 'ok';
    }
    return res;
  type: javascript
  commands:
  - name: threat-crowd-email
    arguments:
    - name: email
      required: true
      default: true
      description: Email to get report of
    outputs:
    - contextPath: Account.Email.Address
      description: The email in threat crowd
    - contextPath: Account.Type
      description: Email type
    - contextPath: Account.ThreatCrowd.Domains
      description: Threat crowd domains linked to this account
    description: Get email report
  - name: threat-crowd-domain
    arguments:
    - name: domain
      required: true
      description: Domain to get report of
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.ThreatCrowd.Emails
      description: Threat crowd emails
    - contextPath: Domain.ThreatCrowd.SubDomains
      description: Threat crowd subdomains
    - contextPath: Domain.ThreatCrowd.References
      description: Threat crowd references
    description: Get domain report
  - name: threat-crowd-ip
    arguments:
    - name: ip
      required: true
      description: IP to get report of
    outputs:
    - contextPath: IP.Address
      description: IP address
    - contextPath: IP.ThreatCrowd.Hashes
      description: Hashes from threat crowd
    - contextPath: IP.ThreatCrowd.References
      description: References from threat crowd
    - contextPath: IP.ThreatCrowd.Resolutions
      description: Resolutions from threat crowd
    - contextPath: IP.ThreatCrowd.Votes
      description: Votes from threat crowd
    description: Get ip report
  - name: threat-crowd-antivirus
    arguments:
    - name: antivirus
      required: true
      description: Antivirus to get report of
    outputs:
    - contextPath: ThreatCrowd.AntiVirus.Name
      description: AntiVirus name
    - contextPath: ThreatCrowd.AntiVirus.Hashes
      description: Hashes of the anti virus
    - contextPath: ThreatCrowd.AntiVirus.References
      description: References of the anti virus
    description: Get antivirus report
  - name: threat-crowd-file
    arguments:
    - name: file
      required: true
      description: hash to get report of
    outputs:
    - contextPath: File.MD5
      description: File MD5
    - contextPath: File.ThreatCrowd.IPs
      description: IPs from threat crowd
    - contextPath: File.ThreatCrowd.Domains
      description: Domains from threat crowd
    - contextPath: File.ThreatCrowd.Resource
      description: Resource from threat crowd
    - contextPath: File.ThreatCrowd.SHA1
      description: SHA1 from threat crowd
    - contextPath: File.ThreatCrowd.References
      description: References from threat crowd
    - contextPath: File.ThreatCrowd.Scans
      description: Scans from threat crowd
    description: Get file report
hidden: false
