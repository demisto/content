commonfields:
  id: vmray
  version: -1
name: vmray
display: VMRay
category: Forensics & Malware Analysis
image: data:image/png;base64,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
description: Ransomware analysis sandboxing
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: API-Key
  name: api_key
  defaultvalue: ""
  type: 4
  required: false
script:
  script: |
    import base64
    import datetime
    import os.path
    import requests
    import urlparse
    import time

    import sys
    sys.path.insert(0, '/python-packages')
    from vmray.rest_api import VMRayRESTAPI, VMRayRESTAPIError


    # Get mandantory params
    # You can use demisto.params()[paramName] or params.paramName to get a specific params.
    # Params are of the type given in the integration page creation.
    api_key = demisto.params()['api_key']
    server = demisto.params()['server']

    api = VMRayRESTAPI(server, api_key)

    url_dict = {
        "get_results": "/rest/analysis/sample/%s",
        "get_job_sample": "/rest/job/sample/%s"
    }

    def submit_sample(api, file):
        # Submit sample
        params = {'sample_file': file}
        data = api.call("POST", "/rest/sample/submit", params)
        demisto.results(json.dumps(data, indent=2))

    def test_module(api):
        try:
            api.call("GET", "/rest/analysis?_limit=1")
            demisto.results('ok')
        except VMRayRESTAPIError as exc:
            if exc.status_code == 401:
                demisto.results({ 'Type' : entryTypes['error'], 'ContentsFormat' : 'text', 'Contents' : "Authentication failed!" })
            else:
                demisto.results({ 'Type' : entryTypes['error'], 'ContentsFormat' : 'text', 'Contents' : exc })

    def get_request(api, url, method='GET'):
        data = api.call(method, url)
        demisto.results(data)

    # The command demisto.command() holds the command sent from the user.
    if demisto.command() == 'test-module':
        # This is the call made when pressing the integration test button.
        # demisto.results('ok')
        test_module(api)
    if demisto.command() == 'upload_sample':
        # To upload a file the filename is needed. Demisto renames the files
        # and stores it internaly. To get the filename you need an automation.
        # You can use demisto.args()[argName] to get a specific arg. args are strings.
        file = demisto.args()['file_id']
        path = demisto.getFilePath(file)
        demisto.results(submit_sample(api, open(path['path'], "rb")))
    if demisto.command() == 'get_results':
        job_id = demisto.args()['sample_id']
        get_request(api, url_dict[demisto.command()] % job_id)
    if demisto.command() == 'get_job_sample':
        sample_id = demisto.args()['sample_id']
        get_request(api, url_dict[demisto.command()] % sample_id)

    sys.exit(0)
  type: python
  commands:
  - name: upload_sample
    arguments:
    - name: file_id
      required: true
      description: The file id to submit
    description: Submit sample to VMRay
  - name: get_results
    arguments:
    - name: sample_id
      required: true
      description: Analysis sample ID
    description: Get all analysis details about a specific sample.
  - name: get_job_sample
    arguments:
    - name: sample_id
      required: true
      description: Job sample id
    description: Get all jobs details about a specific sample.
  dockerimage: demisto/vmray
releaseNotes: 'Fix VMRay fetching file issue - with using upload_sample command with war room file'
