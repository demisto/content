commonfields:
  id: CyberArkAIM
  version: -1
name: CyberArkAIM
display: CyberArk AIM
category: Authentication
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEoAAAAyCAYAAAD7oU3dAAAK50lEQVR42u2aC3QTVRrHv1qealsoaZOmecxMkrZAoUWEKiYtLY/i8lQsbZpJ0pby0BUs4AtKG12BZWVxD8dn6RuxJUnTNmnTBxYURRc5e46gAj6OnhUEVkXERaU89O6XyVSmJRq6x3N2G/I/539m5t4798z9zffdydwJ/L8odX176vjVLXuAtf4VljYOhqB6azn7dGTGWldVmqXj53GPthJgGwiYGw4AuysTgvJq0orKnKlrXR/qStrJ1NIOMu4RHpQRzdoRWKsVDE1j4EZVaknHnaml7btTLbuJFgH5AMXb7tmeB3Pb/ZBrHw43iiZse2G8ztJiRzBX0IS3b1BCsxywj0FvWweGhlshUKVb3y5K+5N7i6648wcBHP+gfPsIGB2pEGhKK+3MQhDHERYH5HcAhW0cl8FofRHMdTIY6NIWu0enWbrqdSUdPAz/oBIfcQtA+Te2/QoW1a2BwleHwECTYkU9g3Bqp1ra/60raeNB+HeqpYskP4qgcht4WP1wvuswFDakwYCSoSE7vLCRS6Oplg6SVvrbgLSl+OSzvEpmrt5Olq8pJQUbdpKbzTh4veM6o8pxEbKbN0LWjigYUGId88Fg56IienkzSVnXRtIRWOo1kDrIXZY9JH1dE7lveTEx6PVk5YMryM7aarLp2Rpyx+p6gtAxwnwAM9m9Zm0toG+YCANRCGrOLwNCYEPyHCR+dQvB300cMF0pB4gDN2fVc8SQt4yYDAaizzWSB1cUkfLKGlJVWUVqqyrJmi07iPoBqze6DD2Q0DnOD2CefSHwGuCgeLMe20kYpqOqqIVoi1vJ3KJtJGdxEQfIyJoIa8zrBaqsvArNweK2BU/tJIplNgJZr3wMhvoiWOAOB1RggRICMzSTpPy/kUI2BwEZOUBo36B4b6/wAKsg1bV135U0HpQDr0AFxdtJkkxPkwIjy8HxC4r3i2UVZMfLr5wh5KfwGweUect/BapmxyvfdHd3RwZBBUH5B2U05RO9wXgJQZWXV9Xu7zeoPHcaTH/iSdwLCVBQ+cRkLiAL71vUvuDehZMBVbfLPrSyqnbzS9srv+8L6srlS71BmerCwGgrgfzWizDjif0BF1GLTUY+ikxfm/MKVoMPlZVVjiuvqG4QgDqLk/lI6JHRlQNG+zFPvwiKIKi2AHvq/YWYF91zitVnl03PSFOCH+2sqZxbU1FxqMVuPbP3/RNhQwp3jsP3wRZhvzyo9sAAxdrRTSTxj5WfTl9SLIZ+av6mmjVRy6xdoLdf5voLOFCs91UmbHEjScQXZZ1l9yXdk3vbtMV774Tr0X22wZDj2AC59q+xH67PQAPFARpkdhB1kcu75mTptTZ1BT9RvaR9vFUOvyI8PxMj8R0BlAADhYBC8eVVtKyJTHzc7Xv1gLe2uO3ktD/vMczetm/E1T7sKWBy7OoFwz+oDhhIuol1zJU84CST17YJ1qP8GmG2f377qoaHIMdeLoDQH1BdMJAUUdA0Mr3Y/UxaacePAhB+PRWBJj7q7ufqpsO7Nbv2Q0bpJBiI0q53J2vXtTZ7U67jukDhl2L/oISLdwbrN6C3FsPC2qEw0HVbyVsGXYn7xO8GCgFhm27IbqmGmU8xEEhKfvDZyJQ19ayupPMovwzcf1Cs3VuX7bLBwvpECGTpihrD7lrbasFPWVdSLZ39AIWQ8l0HgXXdDTeSJix7/q4pjzn3cpFV6geUqfECzkWrYPmbg+FG1ZSV+9i09e5PdNyHh7Y+oBwEDPVOmLM1GYICmLmiOVL3cMdjusd2f570uNsLKddeA/kvT4OgrtXEwrdFyWubNsH87SwEFVRQQQUVVFD/A42m5TpKrmChR2M1cYyKotl4RrVSQzOsRBStBBSWUWqKNlOiKAUINCpylAjPMMrEUhWg1EpqukpJGdB5nCk6S0XTCSAQlqejc7E/tsd4bBwzenQMoFImTxYzCqUey0y8jXE0Mx1+TXn1mcA6ctEpPlZHE4Ft0KNzfrHelgnznRHAC49vxfJFwNqxvtG7cLiiNR30djzPySpnF9+SQMv/gNf0MFenoaj7NRR9BQsuMArqfRzkj7h/mYpVzI9XKKLxYs8qYmX/gJCQUOCFx26E83NkREQcB4qiDqvwGH0Cy096+sL9KxqGMQhA/R3LCd6hi0Ir5PIMQCUnJWV66hkldQ59Fv2dWkkTuVT64vBhw24CodiGsVdfdZpOQ+rW8D71G32+M5pbPoK5myZ42zRr+B+4BIqcDGzeNwPMjQSydxHY8Gp56NGPB0nj4wZFRYyIgMmTJs2g5QoilUiqYqLFEkAlxMWJEdY6lVyeBChRZGQmRg+RRo56CFA6rTaXlsnJlJSUfAGEIyoFVcvIFUNouXyIXCyO0sTK9mL5G8BLQzEHpGLxgZCQkEihxWLxYB6U5+6doRVKCToMb0a4TCqdhZFH1DSd0RuE9QXB+yCBzI1L+oCy8PWXENDLwNqqMXLOQF4zgZmb67xtmlRcvaHhIqxq1oPJdhqMNgL3trwLSw6FglAJGs0eWqH4EPwIL7oSB3EJtzq88HOSqCgXCIQRdRQjsAwESoqJqVDKFW8JQB2MEYtfh19R0vjxHlBfYlSH9EpZivoK+18DPTI5Y3CA57ill1xrGwckz/UeZJWHXgvKcfbqeU0WyLcSmLF3H6AQCoNtutGXMarOYlvsp+4MyCxJ0Fc46G5JtHgD+NGIiPAROHcdw/bf4fZziVgSAwJhur1DyeRfSsWSt2PRapo5oqZVRCaNLRBE3esI4Tz28Rr28RqCex3txhsl4iPqbgR1VqVU3o4eraHp+ARNXJYnhaNGjki/OuDGJ7iX58XOI1DQGoYD/YCLKu2qBcALB90D6gcwNprA3HQv5De/zaXWzCqXF2ajB9QFQWRehuzqWYDyAYo5Hy0SPQPXIQ2twgFQFzFKpl7bD3VIGSvrunn48HnDhg6bh7AKVDhvjYlPsGJ6h/Cg3sQ56TimejEC8Xg9+hGGpsJ4UNPwmGC78+hu7NOzfwrnKBP06KGaQWC2fsqBWtLcDkudRjDZ9/Nr54chu4lLYzy2+PwzW771HVhkT+L/mKsSgkKYP8GC55/znVIyWTOjVP4rNkZ6K/iRWqGW4IV/iRGghj7C8qM4Rz3fGyytQzCXQkNDRwIK57mD4qiort9IPS6iGIq6Da/pDgahIvy3QCiDIx0H/DMXGXktvFsRAh6bMHUWVM7tE1HfYoqu49KLxfql9RuhR3oOVDdn1nbAu4pqxRuwfyP0VUJ8/ETu6UQzBzAlMjCFJBqVehpO5h3Ro0S5fUApsO05BDXGB6hjCGo3Pj2nYF9TsK9MTKvdmI7HR4SHD+XT/KBCGvsR2jNBz8JzOKslDJd6E5KT5yCobzHKuagQR4vHj4mLvyCNGlUqSLt2nGsIZNV8BjMsbdyHz9ml7VBYfQ5hecC8wc9RT/Kgvoc8RyjkCyJs6bvzvaCsam+k2QgUvnYbFHS2cvs5uxBW3XToK0yFWZRcfggv+mv0J2jPk+c9HMycXhGiUEux7jCC0vgA5USfQp/kt6cR+kdikShH0GaX2lNOUd+olFfNSLxPtLFjx2QgqMNqJX0L8NIwqmmUTHYiMUGTHnbPVgWm1z8hz3kcpqzWglCmspVgav4CB34Csm1KBHU/7p/E7TEwNkVCge0mMNhdYLSegkVdbZD97hDItcmxzWc4qX8BhZ0MmDojcFLfh5F1Ggoch6D+PQZ4/Qeb6Gn+G1ZzEgAAAABJRU5ErkJggg==
description: Query CyberArk Application Identity Manager for accounts and credentials
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Port
  name: port
  defaultvalue: ""
  type: 0
  required: false
- display: AppID as configured in AIM
  name: appid
  defaultvalue: ""
  type: 0
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
- display: Folder to search in safe
  name: folder
  defaultvalue: ""
  type: 0
  required: true
- display: Safe to search in
  name: safe
  defaultvalue: isFetchCredentials
  type: 0
  required: true
- display: ""
  name: isFetchCredentials
  defaultvalue: "true"
  type: 8
  required: false
- display: API Username
  name: username
  defaultvalue: ""
  type: 0
  required: false
- display: API Password
  name: password
  defaultvalue: ""
  type: 4
  required: false
- display: Credential names - comma-seperated list of credentials names in vault
  name: credentialNames
  defaultvalue: ""
  type: 12
  required: false
script:
  script: |-
    var port = params.port;
    var base = params.server.replace(/[\/]+$/, '') + (port ? (':' + port) : '');
    var accountsUrl = base + '/AIMWebService/api/Accounts';
    var authUrl = base + '/PasswordVault/WebServices/auth/Cyberark/CyberArkAuthenticationService.svc/';
    var credentialsUrl = base + '/PasswordVault/WebServices/PIMServices.svc/Accounts';
    var insecure = params.insecure;
    var proxy = params.proxy;
    var appid = params.appid;
    var username = params.username;
    var password = params.password;
    var token;

    var sendRequest = function(method, url, args) {
        var res = http(
            url + (method === 'GET' ? encodeToURLQuery(args) : ''),
            {
                Method: method,
                Body: method !== 'GET' ? JSON.stringify(args) : ''
            },
            insecure,
            proxy,
            false,
            false,
            30000
        );
        if (res.StatusCode !== 400 && (res.StatusCode < 200 || res.StatusCode >= 300)) {
            if (res.StatusCode === 404) {
                return undefined;
            }
            // if timeout, throw.
            if (res.StatusCode === -1) {
                throw 'Request credentials from CyberArk returned Timeout. Error: ' + res.Status;
            }
            throw 'Failed to reach ' + url + ' , request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }
        return JSON.parse(res.Body);
    }

    var sendRequestWithToken = function(method, url, args, returnPlainResponse) {
        var headers = {};
        headers["Content-Type"] = ["application/json"];
        if (!token) {
            var data = {
              username: username,
              password: password,
              useRadiusAuthentication: false,
              connectionNumber: 1
            };
            var tokenRes = http(
                authUrl + 'Logon',
                {
                    Method: 'POST',
                    Headers: headers,
                    Body: JSON.stringify(data)
                },
                insecure,
                proxy
            );
            if (tokenRes.StatusCode !== 200) {
                throw 'Could not authenticate user ' + tokenRes.Body;
            }

            var tokenResObject = JSON.parse(tokenRes.Body);
            token = tokenResObject.CyberArkLogonResult;
        }

        headers["Authorization"] = [token];
        if (args.ImmediateChangeByCPM) {
            headers["ImmediateChangeByCPM"] = [args.ImmediateChangeByCPM];
            delete args.ImmediateChangeByCPM;
        }

        var res = http(
                url + (method === 'GET' ? encodeToURLQuery(args) : ''),
                {
                    Method: method,
                    Headers: headers,
                    Body: method !== 'GET' ? JSON.stringify(args) : ''
                },
                insecure,
                proxy,
                false,
                false,
                30000
        );
        if (res.StatusCode !== 200) {
            throw 'Failed to receieve valid answer: ' + res.Status;
        }

        return returnPlainResponse ? res : JSON.parse(res.Body);
    };

    var parseAccountsFromErrorMessage = function(message) {
        var credentials = [];
        // format: Too many password objects matching query [Folder=...;Safe=...] were found: (Safe=...;Folder=...;Object=... and Safe=...;Folder=...;Object=...) (Diagnostic Info: 41)
        var accounts = message.split("were found: (")[1];
        // format: Safe=...;Folder=...;Object=... and Safe=...;Folder=...;Object=...) (Diagnostic Info: 41)
        accounts = accounts.split(")")[0];
        // format: Safe=...;Folder=...;Object=... and Safe=...;Folder=...;Object=...
        accounts = accounts.split(" and ");
        accounts.forEach(function(accountString) {
            var crednetialDetails = {};
            crednetialDetails.name = accountString.split(";Object=")[1];
            credentials.push(crednetialDetails);
        });
        return credentials;
    }

    var resetCredentials = function(args) {
        sendRequestWithToken('PUT', credentialsUrl + '/' + args.accountId + '/ChangeCredentials', args, true);

        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: "Operation succeeded.",
            ReadableContentsFormat: formats.markdown
        };
    };

    var getAccountDetails = function(args) {
        var result = sendRequestWithToken('GET', credentialsUrl, args);
        if (!result) {
            return 'No results found';
        }

        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: result,
            EntryContext: {'CyberArk.AIM(val.Name==obj.Name).Accounts': result.accounts},
            ReadableContentsFormat: formats.markdown,
            HumanReadable: tableToMarkdown('Found ' + result.Count + ' accounts matching "' + args.Keywords + '". Displaying only the first:', result.accounts)
        };
    };

    var getCredentials = function(asList) {
        args.AppID = appid;
        args.Folder = params.folder;
        args.Safe = params.safe;

        var credsToFetch  = [];
        if (args.identifier) {
            credsToFetch.push(args.identifier);
            delete args.identifier;
        } else if (params.credentialNames) {
            credsToFetch = params.credentialNames.split(',');
        }

        var credentials = [];
        for (var i = 0; i < credsToFetch.length; i++) {
            args.Object = credsToFetch[i].trim();

            var result = sendRequest('GET', accountsUrl, args);
            if (result) {
                var itemToAdd = asList ? result : {
                        'user': result.UserName,
                        'password': result.Content,
                        'name': result.Name
                    };
                credentials.push(itemToAdd);
            }
        }

        if (credentials.length === 0) {
            // no creds were fetched - log to server
            logInfo('No credentials were fetched for [' + credsToFetch.join(', ') + ']');
        }

        return asList ? credentials : JSON.stringify(credentials);
    }

    var queryCredentials = function() {
        args.AppID = appid;
        if (!args.folder) {
            args.Folder = params.folder;
        } else {
            args.Folder = args.folder;
        }
        if (!args.safe) {
            args.Safe = params.safe;
        } else {
            args.Safe = args.safe;
        }
        var argsKeys = Object.keys(args);
        cleanArgs = {};
        argsKeys.forEach(function(key) {
            var upperKey = key.charAt(0).toUpperCase() + key.substr(1);
            cleanArgs[upperKey] = args[key];
            delete args[key];
        });
        var result = sendRequest('GET', accountsUrl, cleanArgs);
        var res = result;
        var humanReadable = null;
        // If we recieved too many (limited by CyberArk) then return a warning.
        if (result && result.ErrorMsg && result.ErrorMsg.indexOf("Too many") > -1) {
            var accounts = parseAccountsFromErrorMessage(result.ErrorMsg);
            res = "Found " + accounts.length + " results or more, while can only get one. Please try to narrow down the search by adding more filters.";
            humanReadable = res;
        } else if (result && result.ErrorMsg) {
            res = "Error: " + result.ErrorMsg;
            humanReadable = res;
        } else {
           humanReadable = tableToMarkdown('Credentials Results', result);
        }
        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: res,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: humanReadable
        };
    }

    var listCredentials = function() {
        var creds = getCredentials(true);

        for (var i = 0; i < creds.length; i++) {
            // delete password
            delete creds[i].Content;
        }

        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: creds,
            EntryContext: {'CyberArk.AIM(val.Name==obj.name)': creds},
            ReadableContentsFormat: formats.markdown,
            HumanReadable: tableToMarkdown('Credentials fetched from CyberArk AIM valut:', creds)
        };
    }

    function testModuleAndCredentials() {
        args.AppID = appid;
        args.Folder = params.folder;
        args.Safe = params.safe;

        var paramCredsString = params.credentialNames;
        if (!paramCredsString) {
            sendRequest('GET', accountsUrl, args);
        } else {
            var names = paramCredsString.split(',');
            for (var i = 0; i < names.length; i++) {
                var name = names[i].trim()
                args.Object = name
                // exception would be thrown if identifier (Object) does not exists
                var result = sendRequest('GET', accountsUrl, args);
                if (!result) {
                    throw 'Could not find object for: "' + name + '"'
                }
            }
        }

        return 'ok';
    }

    switch (command) {
        case 'test-module':
            return testModuleAndCredentials();
        case 'fetch-credentials':
            return getCredentials();
        case 'cyber-ark-aim-query':
            return queryCredentials();
        case 'reset-credentials':
            return resetCredentials(args);
        case 'account-details':
            args.Safe = args.safe || params.safe;
            delete args.safe;
            args.Keywords = args.keywords;
            delete args.keywords;
            return getAccountDetails(args);
        case 'list-credentials':
            return listCredentials();
        default:
            throw 'Command "' + command + '" is not supported.';
    }
  type: javascript
  commands:
  - name: cyber-ark-aim-query
    arguments:
    - name: username
      description: Username to query
    - name: address
      description: Address to query
    - name: safe
      description: Safe to query
    - name: folder
      description: Folder to query
    - name: object
      description: Object to query
    - name: query
      description: Defines a free query using account properties, including Safe,
        folder, and object. When this method is specified, all other search criteria
        are ignored
    - name: queryFormat
      auto: PREDEFINED
      predefined:
      - Exact
      - Regexp
      description: Defines the query format, which can optionally use regular expressions
    - name: reason
      description: The reason for retrieving the password. This reason will be audited
        in the Credential Provider audit log.
    - name: database
      description: Defines search criteria according to the Database account property
    outputs:
    - contextPath: CyberArk.AIM.Folder
      description: Account folder
    - contextPath: CyberArk.AIM.PasswordChangeInProcess
      description: Is password change in process
    - contextPath: CyberArk.AIM.Content
      description: Account content
    - contextPath: CyberArk.AIM.CreationMethod
      description: Account creation method
    - contextPath: CyberArk.AIM.Name
      description: Account name
    - contextPath: CyberArk.AIM.PolicyID
      description: Account policy ID
    - contextPath: CyberArk.AIM.CPMDisabled
      description: Account CPM disabled
    - contextPath: CyberArk.AIM.Address
      description: Account address
    - contextPath: CyberArk.AIM.Safe
      description: Account safe
    - contextPath: CyberArk.AIM.UserName
      description: Account username
    - contextPath: CyberArk.AIM.DeviceType
      description: Account device type
    description: Search credentials in cyberark using arguments to narrow the search.
      Cannot return more than one result.
  - name: list-credentials
    arguments:
    - name: identifier
      default: true
      description: When used, command will return a specific credential
    description: Lists all credentials available
  - name: reset-credentials
    arguments:
    - name: immediateChangeByCPM
      description: Signle the CPM that the change is effective immediately
      auto: PREDEFINED
      predefined:
      - "Yes"
      - "No"
      defaultValue: "Yes"
    - name: accountId
      required: true
      default: true
      description: Account Id to reset password
    description: 'This method marks the account for an immediate password change by
      the CPM to a new random password. '
  - name: account-details
    arguments:
    - name: keywords
      required: true
      default: true
      description: Keywords matching the account
    - name: safe
      description: Specify a safe rather then using instance specific.
    description: This method returns information about an account. If more than one
      account meets the search criteria, only the first account will be returned.
  runonce: false
