commonfields:
  id: CIRCL
  version: -1
name: CIRCL
display: CIRCL
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: |-
  CIRCL Passive DNS is a database storing historical DNS records from various resources.
  CIRCL Passive SSL is a database storing historical X.509 certificates seen per IP address. The Passive SSL historical data is indexed per IP address.
configuration:
- display: Server URL
  name: url
  defaultvalue: https://www.circl.lu
  type: 0
  required: true
- display: Username
  name: credentials
  defaultvalue: ""
  type: 9
  required: false
- display: Use system proxy settings
  name: isUsingProxy
  defaultvalue: ""
  type: 8
  required: false
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |
    import requests
    import json
    import time
    import datetime
    import os

    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    # Params
    BASE_URL = demisto.getParam('url')
    USERNAME = demisto.getParam('credentials')['identifier']
    PASSWORD = demisto.getParam('credentials')['password']
    AUTH = (USERNAME, PASSWORD)
    USE_SSL = True if demisto.params().get('insecure') else False
    IS_USING_PROXY = demisto.params()['isUsingProxy']

    if not IS_USING_PROXY:
        del os.environ['HTTP_PROXY']
        del os.environ['HTTPS_PROXY']
        del os.environ['http_proxy']
        del os.environ['https_proxy']

    lastTimeKey = 'time_last'

    def dnsGet(url):
        queryUrl = BASE_URL + '/pdns/query/' + url

        responce = requests.get(queryUrl, auth=AUTH)
        responce.raise_for_status()

        results = list(map(lambda line: json.loads(line), responce.text.splitlines()))
        results = mergeByRdata(results)

        records = []

        for result in results:
            records.append(createDnsRecordContext(result))

        return {
            'Type': entryTypes['note'],
            'ContentsFormat': formats['text'],
            'Contents': responce.text,
            'HumanReadable': tableToMarkdown("CIRCL Dns - " + url, records),
            'EntryContext': {
                'CIRCLdns.Query(val.Value===obj.Value)': {
                    'Value': url,
                    'Record': records,
                }
            }
        }

    def mergeByRdata(results):
        resultsMap = dict()

        for e in results:
            key = e['rdata']
            other = resultsMap.get(key)

            if other != None and other[lastTimeKey] > e[lastTimeKey]:
                e = other

            resultsMap[key] = e

        return list(resultsMap.values())


    def createDnsRecordContext(record):
        return {
            'Data': record['rdata'],
            'LastTime': record[lastTimeKey],
        }

    def listCertificates(queryValue):
        queryUrl = BASE_URL + '/v2pssl/query/' + queryValue

        responce = requests.get(queryUrl, auth=AUTH)
        responce.raise_for_status()

        data = responce.json()
        records = []

        for ip, ipData in data.items():
            records.append(createIpContext(ip, ipData))

        return {
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': data,
            'HumanReadable': '```json\n' + json.dumps(records, indent=4) + '\n```',
            'EntryContext': {
                'CIRCLssl.IP(val.Value===obj.Value)': records
            }
        }

    def createIpContext(ip, ipData):
        certificates = []

        for sha1 in ipData['certificates']:
            subjects = ipData['subjects'][sha1]['values']
            certificates.append(createCertificateContext(sha1, subjects))

        return {
            'Value': ip,
            'Certificate': certificates
        }

    def createCertificateContext(sha1, subjects):
        return {
            'Sha1': sha1,
            'Subjects': subjects
        }

    def listCertificateSeenIps(sha1, limit):
        queryUrl = BASE_URL + '/v2pssl/cquery/' + sha1

        responce = requests.get(queryUrl, auth=AUTH)
        responce.raise_for_status()

        data = responce.json()
        certificate = createCertificateSeenIpsContext(sha1, data, limit)

        return {
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': data,
            'HumanReadable': 'Hits: ' + str(certificate['Hits']),
            'EntryContext': {
                'CIRCLssl.Certificate(val.Sha1===obj.Sha1)': certificate,
            }
        }

    def createCertificateSeenIpsContext(sha1, data, limit):
        return {
            'Sha1': sha1,
            'Hits': data['hits'],
            'IP': data['seen'][:limit],
        }

    def getCertificateDetails(sha1):
        queryUrl = BASE_URL + '/v2pssl/cfetch/' + sha1

        responce = requests.get(queryUrl, auth=AUTH)
        responce.raise_for_status()

        data = responce.json()
        certificate = createCertificateDetails(sha1, data)

        return {
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': data,
            'HumanReadable': certificate,
            'EntryContext': {
                'CIRCLssl.Certificate(val.Sha1===obj.Sha1)': certificate,
            }
        }

    def createCertificateDetails(sha1, data):
        info = data['info']
        extension = info['extension']

        return {
            'Sha1': sha1,
            'Usage': extension['extendedKeyUsage'],
            'Distribution': extension['crlDistributionPoints'],
            'Issuer': info['issuer'],
            'Time': info['not_before'],
            'Subject': info['subject'],
            'Key': info['key'],
            'Pem': data['pem'],
            'Seen': data.get('icsi', {}).get('times_seen'),
        }

    try:
        args = demisto.args()

        if demisto.command() == 'test-module':
            responce = dnsGet('test.com')
            demisto.results('ok')

        if demisto.command() == 'circl-dns-get':
            demisto.results(dnsGet(args.get('queryValue')))

        if demisto.command() == 'circl-ssl-list-certificates':
            demisto.results(listCertificates(args.get('queryValue')))

        if demisto.command() == 'circl-ssl-query-certificate':
            limit = int(args.get('limitResults', 100))
            sha1 = args.get('certificate')

            demisto.results(listCertificateSeenIps(sha1, limit))

        if demisto.command() == 'circl-ssl-get-certificate':
            demisto.results(getCertificateDetails(args.get('certificate')))

    except Exception, e:
        LOG(e.message)
        LOG.print_log()
        raise
  type: python
  commands:
  - name: circl-dns-get
    arguments:
    - name: queryValue
      required: true
      description: IP address, hostname, or domain name
    outputs:
    - contextPath: CIRCLdns.Query.Value
      description: Query Value
      type: string
    - contextPath: CIRCLdns.Query.Record.Data
      description: DNS Record or IP Address
      type: string
    - contextPath: CIRCLdns.Query.Record.LastTime
      description: DNS record last recorded time
      type: date
    description: Get DNS records for your query value from CIRCL's Passive DNS.
  - name: circl-ssl-list-certificates
    arguments:
    - name: queryValue
      required: true
      description: IP address or CIDR block
    outputs:
    - contextPath: CIRCLssl.IP.Value
      description: IP address
      type: string
    - contextPath: CIRCLssl.IP.Certificate.Sha1
      description: ' The SHA1 fingerprint of the certificate'
      type: string
    - contextPath: CIRCLssl.IP.Certificate.Subjects
      description: Certificate subjects
      type: string
    description: Query IP address or CIDR blocks (/32 up to /23) for SSL certificates
      history.
  - name: circl-ssl-query-certificate
    arguments:
    - name: certificate
      required: true
      description: SHA1 fingerprint of a certificate
    - name: limitResults
      description: Limit the results number (Increasing number can cause browser slowdowns).
      defaultValue: "100"
    outputs:
    - contextPath: CIRCLssl.Certificate.Sha1
      description: ' The SHA1 fingerprint of the certificate'
      type: string
    - contextPath: CIRCLssl.Certificate.Hits
      description: Number of hits for the certificate (number of associated addresses)
      type: number
    - contextPath: CIRCLssl.Certificate.IP
      description: IP address associated to the certificate
      type: string
    description: Query a certificate value to get all associated addresses
  - name: circl-ssl-get-certificate
    arguments:
    - name: certificate
      required: true
      description: SHA1 fingerprint of a certificate
    outputs:
    - contextPath: CIRCLssl.Certificate.Sha1
      description: ' The SHA1 fingerprint of the certificate'
      type: string
    - contextPath: CIRCLssl.Certificate.Usage
      description: Extended key usage
      type: string
    - contextPath: CIRCLssl.Certificate.Distribution
      description: CRL distribution points
      type: string
    - contextPath: CIRCLssl.Certificate.Issuer
      description: Certificate issuer
      type: string
    - contextPath: CIRCLssl.Certificate.Time
      description: Certificate issued time (***not_before)
      type: date
    - contextPath: CIRCLssl.Certificate.Subject
      description: Certificate subject
      type: string
    - contextPath: CIRCLssl.Certificate.Key
      description: Certificate public key
      type: string
    - contextPath: CIRCLssl.Certificate.Pem
      description: Certificate in PEM format
      type: string
    - contextPath: CIRCLssl.Certificate.Seen
      description: Number of times the certificate was seen
      type: number
    description: Get the raw certificate and related information.
  runonce: false
