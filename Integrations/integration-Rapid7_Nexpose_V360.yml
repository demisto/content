commonfields:
  id: Rapid7 Nexpose
  version: -1
name: Rapid7 Nexpose
display: Rapid7 Nexpose
category: Vulnerability Management
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAAyCAYAAACXpx/YAAAAAXNSR0IArs4c6QAAD81JREFUeAHtmwmYFdWZhv+693b3baBpBBsIIzSbuCBBiESEsKrEuEBc4kSdjE90NGPcE2NmlFFAx21myCqJyyRGxUxGJ5JAlEUbFFGRRYWoLALNyBKwgW7p7W5V8351bzXdl24VGRyYp/6Ht+rUqVOnTv3bOVW3MQsl1ECogVADoQZCDYQaCDUQaiDUQKiBUAOhBkINhBoINRBqINRAqIFQA6EGQg0cWg1ED233Ye+fowbaca9RMARKYBuYo80ny5SYnbqrnUW7xC1aHbWqKrNUIm174/W2o1+D2RT3k/sIWxxCDbSn78vhfaiBHhCDp/c38Kk3drPi4hOsIDI44jonudFouROLdDXX6WjRSDtLNEStbqfjeJaig1rPdfdEHO+DjOutt0x6tWUyb9nb1dzo+QTnQ/l8NDCe20SgN9RBLZTB3KyBh9/U2wqjk5xI7GsWiwxxogVdvViROZGoeRE1ASeLk6znciJYtZ7HluDln+e55mTS5qYSCQz9vmPuIjeVmm3v1C8KjS1tHVI5n97XwtlQBAtBBl6nMLZIQXSaxTt8y0/YMmQ0ak4Uh4hEMLL2TNVOBGNT9jLmxAp0mW9Uk2GxsOO6vjNECgqKuH6g53kDcYDvegM7DLV37C3/gnBzqDSwgY6/BMvgz6C5+BhY6BvYCqIFpkgF18OImZxRlcY55RThFBhdRraoY16K+ZzoddyMuWmiNpPkmPMYW/so/ThummLMtWSai1rIaI40mMWwHPrCZXAK0IFf9xT7TdCadKfyGzACSmErvAh/ANYDvvRjOwk+gicgf7rQc+ueXWA+SClfgWGwBN6A00H36QlbQPeYA6SwVkXzntqfBh1BixxdMwuCcVH0RTpRtJ0FfQAF2kqYDW0Fw7Gcuwiku2LYCM/BXFgF5SCj6tmkIz3HR1gVu54x+SmLF1/iup6NHFhug/p0twzGdKIx27yn0eatq7JIIdcRyU6i1mzPX7jKtUwqbceUFNrw8qMsjUGjGLiuIWEVb22wTDJFsCfTbsI91VY9qcEHMoPCNTAZ3oeHQIaScQNnkNH0MK9DczmHA13fK1eZZq8HkrwCl4MevAxeAxn6ZvgxNJdLOZgJu2EobAa1uRF+AtLLDSDJQNQvmS1lfyW8kzsOdudS0LjkDJL8cV1B3Xr/TNb4/05Zzydp3r/WNQ/DbSDnDOQqCg9Ap1xF82ueoU7nq0GGPQq2wF7IKQdDerFCboWOidifXj2eoM7q+qPGtI2bvthW7qi1IozsObQpihPpLvbO2K0TB9mEgV8gUF2Lc/7BP620uSs2EvDoxJPu5ZwtJKhQBA0AzRc/h9UgQ98K34TpMA6C6BtG+bdA+rB74T9BD9UH/gEmwBNwJnwIMtYfQY6kyNgAEilgigqI7iXjSqRciQzI4P02v2ePR1t/+B4o4qTQsbADJMNB4+oAeo5fwx7QuNT/V+FpGA9yqB+AjPse6LycJQ5jQIa9FuTAaiNdfQMUBDL492EuKCOcBHeD2jWCnFuRJ5rEt6JbqDk3ZpHiuC3ZsNumPPtWU4OO8Zjdd8EgK+nQztoXF1tH2hTHCy2DI1w0pJeNGdDVahulG8+Wrt9hD1W8x5yOs9Cfn9YLCpr6yiv05ljRJQX8ARR5b8L1IAPJoP1AQmd2H+j97haQIjTISpCDXAjLYQRcDJI/gRTfBe4BByRS0rHwEsgh8kVGkJNMhdWwCRbAJJDDHA8/BInGdS/IuHeBxr4SdE0FnA8vwGC4ATSGr4PkJpgDaitj/xJOh9fgeVCUyhnvz5X/lv10eBd0zWzQmLbBpaBn30+yYRopcDwWTl5BHBV2sPsXbfINHbQ+8/ij7brTelmnopiVtS+0jkTqSV1L7KqRvfxI1rqsntfi6fPXWKMbNZNRcQCLxIxtW/JzTvwM3LwG1RwrOqQ8PaBkCIyFQBEUW0gtR+pLEhhY5dthJygKvgb9QYpWVpCTJCFfnqRiSX4lx2qr/hrgb6ATyHCjYSMoheaL2t4JMpau+QLIGTwIMgDFJllPSZH+C9A1GnMfkIPJufKlkorHQHaUM+0nOQOjS62MFXmFRWTqqN36x7VWl9Q9svL9ceU2sncn69GxyMo6FNrVI46xbiVFzL0eb1gRm7lsi725da9F4rxeKeX7q2/ZqE3Z08YZebkUIFFZIiVqrM+D0lFrspjKFJwI7XMNNrOfCupHGUCKUxZ4DF6F1iS4d2vnFD1vQxl8EU4DjUsGkJO1Jsos66Av9IEPQOORQ2is+dL8+cbnTj6b36jZ8Yu58snN6pqKWQv4c3DOwL6hi+zVyhr78cJKu/2r/Vgwe9aFyL1+dLnNWFBrXyrpbCP6dLIkc7aMu2p7rT26bDtzc5GvYi+axv9YRTsZS7WdoqWYTytKi5Jy+A6QJlqIjKJoVzZQhMjAdSB5FC6CcTAItsDd8FlE/b8Hw2EAHAcSpfK2RJEvA58Ax4DuPQsmwFKYD3PgZdgAgcgJdA/JUPh7yNeZxtMfJB1B51XXJDG/pPfcCAb2503tOab7aQs32dgBnW1kn6N8Iw/rWWKTBne39nW8IuW6qE1kcIRN1pDUoovueHXy+1Gfeq363xEZT3JhDv+gjY2iuPmNpeB/AxlYMhO2+KXPtqnJXdaFfTAuLYA+TjTtSLrB7+A8uBNGwQU5lAFeBk01c0EqlrNKZNxPkjgNArM0tfUNHMGgbiy70PK0elYz7JOsT9n6nXW+gYMrqrd/oGmaHEoqdjzbyyp7E69Svko1GfupmT70SsXxx+W7oM9PsQ+6+SVtF8F+D5LrQ/WaXwOF5qr9RUhQ1sLkX6EqqDjAfeA8GlMwrrbGk9910F5pdRGcCmfmGMb+bNC8ey/cAUH7KZTXQFv3Uf1uaBG9HPsLGWo5r2iTgYQHqYxN/GI3u+yUHmrnG2v1xm12zYzn7NvDe9q1Xx9J1KasR6e4XTuyp02dt4EPG3zgkFH1Dh305V990JtduR6UHhUBByLn0vgS2ARanX8ZboPvwWcRRa5kJwTj6uTXtL0JrpERAiHV+euAV9lPg0FwHVwJGt+boHtIXod5fukAN1lv9KNWhsGwMjYLp6NZQD0w8fim9+F0OmO3/WqBNcY721OvrrV3K7dZIVGv999Jg7ra6cd2MY+yrve7aXI2Uv7By+pcF2MPsKsS2t8HerApcAXUwzWgBVJrEkRNa+eU8YKFkRZccjjJydldq9tiao8HKWdtqy2ykbqKc1fDjFwbRbPuIRmf3R34NmtgfMn/4UA/HmgYLJ6mndXPjuvarqnHx+cvszlrdlmkrIfVRErswdlLLZ2RE5KNseiNY3pZF1bX+hrm/wbRlF00JR60vEAPDaB0Jk9vS77CiW9Bh1wDRelAWAz/Ae/ATyEO/wKsCvcTGaQtkSFPgkr4Myj69IAToDO0JhpTP1gPctSuIIO3JUtyJ0rZay6WfBO0cm9LzueEpp7C/Aa+gSO8cunXIN8ypN1zTuxqfzdcC76sbN2526b9jmc5uod5hXGLlHa2lzZU25zX3vW/XqUwat8u7ew6UrUWWU7QV9bSQTcHs5fnKzXLcJqHpaR8keGfhMfhBOgPMrAWWUp52ksegHUwEr4D+fJtKi7Or+RYK/N7QClJY6gHOYxS51/BVMgXLcLuBmUQXSMjvQTzYRi0JhNzlZvZVwCK979s/Yx9a84np/9Njm7sW0gugjGuVr/8cFDaPkZqPq4pNav1XTMX2uYkTt+u1J9f/R8gSsvsoflv29YPq/mF0bFG0rPm7PH9u5iLkzQZucXtDupgMlcrJY6ARXAVDAUZ6k5YCOWgyFwG94NeHR6DVyCQPRRuA9KV/RP0heaia+RMcpYJMAQuARlFypSBHgSJ8t0/woeg+VNZQtco0hV1uubL8DI8BMpC/w1Egm88jXU8DIYz4Nege1XDrwCjNH3Z+2vKC0B79a/rfgSzQVPRD+EDaCExHbku7zrplN/dfWcPsBO7t29qtGDFenuEjxjWtVf29SfNKS2i2pXYtt319si8N+2OS8f4r1Ex5vKbzzjWVm3cbrs4h9No/UbHLcS/JzXRFrUtDwpyh5Fm1VspnwdKsZqfHobmoteMqXAXSAkXwHaYBvnyLBWzQKltOlwIMrgkMMQtlC/za/Zt/ovitaB7BaJUrX5kdN1XNBfd67vQkENtfwDXgO4hmssaDm4E9StZCXrun8DIHOyaZAelOyBfH34DX9kRz7a4jQkbdWKZnTOou22vaWChFLG6xqTdPmu1uaU9yO6ajx3/ImnC4dUqctTRNmtdjQ1fvcWG9C5j4e1aCd+uLz6lp814roooztQS2rv8i/ZtHqGoKAgeYN+ZbEleewOUwrvZqqbtBkrngua10aBISMA6WJDbs/M9WYpWezlGvrhUyFBPgcqB01H0V8Z3sp8JcqRy2AYVsBhakyVUjoKzQBGrscu5FuUInIdDP7XLEeVIY0HR2Bl2w3J4ARTBzWUpB2NhHIyAbrAXpMN5oPG1KlmLnffAuRYvml3asYMVty8xl8+VDqQynu3mG7P/bVnGxejWwOfI3fRHUeKx0Crw0lZSwLt0KmlOKmFOstGq6xrNTdS/5L1SdTo/pmSyrQ/rrdKloumfYfJhPdIDGFzWc7fVVzCNr6ypiw2t4cOFH61x5lz9hKhPl4H/Zd0hG8h+HV+0WEjpVWlXQ6NvXEtpn1Le57Up9YsjxLgHoLIjq2k2DldMqbdk6hYn2dDopBWFTBfJ5pAFqaeN/42ZX/o5hiT1RGsEo0YUuemERVio+ZKs+629XvPMEaQOPNmX5un6CBp+60Pdt9BZX1Fp/cdW8ZnibKKSv90hq+p1R3uiUT8e+OXGOnPqq0nNrJRlZBme1Myf0frH/qWNtRXe9qrLrfr3eMkRI1WM9DV4Ef5yxIz6EwYaJN19zSbefZ1Fin4UiRXEPP3o4P8AoZ//KPOdOZJgdfwRz+9/FMH4zMH6a0pPjsA87WDczJ7Exbbm8fzF1b57hKXPTQP7Iji45dqKN6zvmErP3DN5GSp0/EhNY0SlZ6KWCLb6mmxZxzKuvmgxJ/P3WnMyW7dfYhue0YowlMNAA/sbWINaX7EqVj5quetlxhO2HWVcL5eimacxMgbmj+wczbekb4cvWZaofdRNf3ilrZmj5Xsoh4kG9k/RzQc2evIJ1i72G9L1MH/+1a8IWiXXMV1h0+xCOpPmj92n2PIn7uFSv6p5F2H5/1YDrUdwMKbNL1dZ9+HPOI7bg6rBmm99A+tPZ5lvvXRiu5dKXGErZj4cXBLuDy8NfHwE7xurY2NuuZ7/yjKVP2jvZEQwKXuuV5+8ydY+vXZfs7B0uGng0xo4O+4RN51smcTNVrvzDYtXPmwrVrDyCiXUQKiBUAOhBkINhBoINRBqINRAqIFQA/+fNPA/+BoAV7DXvIkAAAAASUVORK5CYII=
description: Rapid7's on-premise vulnerability management solution, Nexpose, helps
  you reduce your threat exposure by enabling you to assess and respond to changes
  in your environment real time and prioritizing risk across vulnerabilities, configurations,
  and controls.
configuration:
- display: Server URL (e.g. https://192.168.0.1:8080)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Username
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Trust any certificate (unsecure)
  name: unsecure
  defaultvalue: "false"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "false"
  type: 8
  required: false
- display: 2FA token
  name: token
  defaultvalue: ""
  type: 0
  required: false
script:
  script: |-
    import time
    import re
    import requests
    import json

    RANGE_OPERATORS = ['in-range', 'is-between', 'not-in-range']
    YEAR_IN_MINUTES = 525600
    MONTH_IN_MINUTES = 43800
    WEEK_IN_MINUTES = 10080
    DAY_IN_MINUTES = 1440
    HOUR_IN_MINUTES = 60


    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()


    USERNAME = demisto.params()['credentials']['identifier']
    PASSWORD = demisto.params()['credentials']['password']
    VERIFY_SSL = not demisto.params().get('unsecure', False)
    TOKEN = demisto.params().get('token', None)

    def get_server_url():
        url = demisto.params()['server']
        url = re.sub('/[\/]+$/', '', url)
        url = re.sub('\/$', '', url)
        return url


    def load_proxy():
        proxy = {}
        if "proxy" in demisto.params():
            proxy["http"] = os.environ["http_proxy"]
            proxy["https"] = os.environ["https_proxy"]
        return proxy

    BASE_URL = get_server_url()
    SERVER_URL = BASE_URL + '/api/3'
    PROXY = load_proxy()

    def get_login_headers():
        headers = {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json'
        }

        if TOKEN is not None:
            headers['Token'] = TOKEN

        return headers

    def login():
        url = BASE_URL + '/data/user/login'
        headers = get_login_headers()
        body = {
            'nexposeccusername': USERNAME,
            'nexposeccpassword': PASSWORD
        }
        res = requests.post(url, headers=headers, data=body, verify=VERIFY_SSL, proxies=PROXY)
        if res.status_code < 200 or res.status_code >= 300:
            return ''
        body = res.json()
        if 'sessionID' not in body:
            return ''

        return body['sessionID']

    SESSION = login()

    def get_headers():
        headers = {
           'Content-Type': 'application/json'
        }

        if TOKEN is not None:
            headers['Token'] = TOKEN
        return headers

    def get_site_headers():
        headers = get_headers()

        headers['Cookie'] = 'nexposeCCSessionID=' + SESSION
        headers['nexposeCCSessionID'] = SESSION

        return headers

    def get_site(asset_id):
        url = BASE_URL + '/data/assets/' + str(asset_id) + '/scans'
        headers = get_site_headers()
        res = requests.post(url, headers=headers, auth=(USERNAME, PASSWORD), verify=VERIFY_SSL, proxies=PROXY)
        if res.status_code < 200 or res.status_code >= 300:
           return ''
        response = res.json()
        if response is None or response['records'] is None or len(response['records']) == 0:
            return ''

        return {
            'id': response['records'][0]['siteID'],
            'name': response['records'][0]['siteName'],
            'ip': response['records'][0]['ipAddress']
        }

    def send_request(path, method = 'get', body = {}, params = {}, headers=None, is_file=False):
        url = '%s/%s' % (SERVER_URL, path)
        headers = headers if headers is not None else get_headers()
        res = requests.request(method, url, headers=headers, data=json.dumps(body), params=params, auth=(USERNAME, PASSWORD),
        verify=VERIFY_SSL, proxies=PROXY)
        if res.status_code < 200 or res.status_code >= 300:
            raise Exception('Got status code ' + str(res.status_code) + ' with url ' + url + ' with body ' + res.content + ' with headers ' + str(res.headers))
        return res.json() if is_file is False else res.content

    def iso8601_duration_as_minutes(d):
        if d is None:
            return 0
        if d[0] != 'P':
            raise ValueError('Not an ISO 8601 Duration string')
        minutes = 0
        # split by the 'T'
        for i, item in enumerate(d.split('T')):
            for number, period in re.findall( '(?P<number>\d+)(?P<period>S|M|H|D|W|Y)', item):
                # print '%s -> %s %s' % (d, number, unit )
                number = float(number)
                this = 0
                if period == 'Y':
                    this = number *  YEAR_IN_MINUTES # 365.25
                elif period == 'W':
                    this = number * WEEK_IN_MINUTES
                elif period == 'D':
                    this = number * DAY_IN_MINUTES
                elif period == 'H':
                    this = number * HOUR_IN_MINUTES
                elif period == 'M':
                    # ambiguity betweeen months and minutes
                    if i == 0:
                        this = number * MONTH_IN_MINUTES # assume 30 days
                    else:
                        this = number
                elif period == 'S':
                    this = number / 60
                minutes = minutes + this
        return minutes

    def dq(obj, path):
      '''
      return a value in an object path. in case of multiple objects in path, searches them all.
      @param obj - dictionary tree to search in
      @param path (list) - a path of the desired value in the object. for example: ['root', 'key', 'subkey']
      '''
      if len(path) == 0:
          return obj

      if isinstance(obj, dict):
          if path[0] in obj:
              return dq(obj[path[0]], path[1:])
      elif isinstance(obj, list):
          # in case current obj has multiple objects, search them all.
          l = [dq(o, path) for o in obj]
          return [k for k in l if k is not None]

      # in case of error in the path
      return None


    def translate_single_object(obj, map_fields, filter_func=None):
      if filter_func is None:
          filter_func = lambda mf: True

      d = {}
      for f in map_fields:
          if filter_func(f):
              d[f['to']] = dq(obj, f['from'].split('.'))

      return d


    def translate_object(content, map_fields, filter_func=None):
      '''
      Converts object fields according to mapping dictionary
      @param content - original content to copy
      @param mapFields - an object assosiating source and destination object fields
      @filter_func - function to filter out fields
      @returns the mapped object
      '''
      if isinstance(content, (list, tuple)):
          return [translate_single_object(item, map_fields, filter_func) for item in content]
      else:
          return translate_single_object(content, map_fields, filter_func)


    def get_list_response(path, method='get', limit=None, body={}, params={}):
        final_result = []
        page_diff = 0
        page_number = 0

        while True:
            page = page_number
            page_number += 1
            params['page'] = page
            if limit is not None:
                params['size'] = limit
            response = send_request(path, method=method, body=body, params=params)
            if not response:
                break
            if response['resources'] is not None:
                final_result = final_result + response['resources']
            if response['page'] is not None:
                page_diff = response['page']['totalPages'] - response['page']['number']
            if page_diff < 1 or limit is not None:
                break

        return final_result


    def get_last_scan(asset):
        if asset['history'] is None:
            return "-"
        sorted_dates = sorted(asset['history'], key=lambda h: time.strptime(h['date'], "%Y-%m-%dT%H:%M:%S.%fZ"), reverse=True)

        if sorted_dates[0] is not None:
            return {
                    'date': sorted_dates[0]['date'] if 'date' in sorted_dates[0] else '-',
                    'id': sorted_dates[0]['scanId'] if 'scanId' in sorted_dates[0] else '-'
                }
        else:
            return {
                    'date': '-',
                    'id': '-'
                }

    def get_asset_command():
        asset = get_asset(demisto.args()['id'])

        if asset is None:
            return "Asset not found"
        last_scan = get_last_scan(asset)
        asset['LastScanDate'] = last_scan['date']
        asset['LastScanId'] = last_scan['id']
        asset['Site'] = get_site(asset['id'])['name']

        assetHeaders = [
        'AssetId',
        'Addresses',
        'Hardware',
        'Aliases',
        'HostType',
        'Site',
        'OperatingSystem',
        'CPE',
        'LastScanDate',
        'LastScanId',
        'RiskScore'
        ]

        assetOutput = translate_object(asset, [
            {'from': 'id', 'to': 'AssetId'},
            {'from': 'addresses.ip', 'to': 'Addresses'},
            {'from': 'addresses.mac', 'to': 'Hardware'},
            {'from': 'hostNames.name', 'to': 'Aliases'},
            {'from': 'type', 'to': 'HostType'},
            {'from': 'Site', 'to': 'Site'},
            {'from': 'os', 'to': 'OperatingSystem'},
            {'from': 'vulnerabilities.total', 'to': 'Vulnerabilities'},
            {'from': 'cpe.v2.3', 'to': 'CPE'},
            {'from': 'LastScanDate', 'to': 'LastScanDate'},
            {'from': 'LastScanId', 'to': 'LastScanId'},
            {'from': 'riskScore', 'to': 'RiskScore'}
        ])

        softwareOutput = None
        servicesOutput = None
        usersOutput = None

        if 'software' in asset and len(asset['software']) > 0:
            softwareHeaders = [
                'Software',
                'Version'
                ]

            softwareOutput = translate_object(asset['software'], [
                {'from': 'description', 'to': 'Software'},
                {'from': 'version', 'to': 'Version'}
            ])

        if 'services' in asset and len(asset['services']) > 0:
            serviceHeaders = [
                'Name',
                'Port',
                'Product',
                'Protocol'
                ]

            servicesOutput = translate_object(asset['services'], [
                {'from': 'name', 'to': 'Name'},
                {'from': 'port', 'to': 'Port'},
                {'from': 'product', 'to': 'Product'},
                {'from': 'protocol', 'to': 'Protocol'}
            ])

        if 'users' in asset and len(asset['users']) > 0:
            userHeaders = [
                'FullName',
                'Name',
                'UserId'
                ]

            usersOutput = translate_object(asset['users'], [
                {'from': 'name', 'to': 'Name'},
                {'from': 'fullName', 'to': 'FullName'},
                {'from': 'id', 'to': 'UserId'},
            ])

        vulnerabilityHeaders = [
            'Id',
            'Title',
            'Malware',
            'Exploit',
            'CVSS',
            'Risk',
            'PublishedOn',
            'ModifiedOn',
            'Severity',
            'Instances',
            ]

        vulnerabilities = get_vulnerabilities(asset['id'])
        asset['vulnerabilities'] = vulnerabilities
        vulnerabilitiesOutput = []
        cvesOutput = []
        for i,v in enumerate(asset['vulnerabilities']):
            detailedVuln = get_vulnerability(v['id'])
            # Add to raw output
            asset['vulnerabilities'][i] = dict(asset['vulnerabilities'][i].items() + detailedVuln.items())
            cvss = dq(detailedVuln['cvss'], ['v2','score'])

            if('cves' in detailedVuln):
                cvesOutput = cvesOutput + map(lambda cve: {
                'ID': cve
                }, detailedVuln['cves'])

            outputVuln = {
                'Id': v['id'],
                'Title': detailedVuln['title'],
                'Malware': detailedVuln['malwareKits'],
                'Exploit': detailedVuln['exploits'],
                'CVSS': cvss,
                'Risk': detailedVuln['riskScore'],
                'PublishedOn': detailedVuln['published'],
                'ModifiedOn': detailedVuln['modified'],
                'Severity': detailedVuln['severity'],
                'Instances': v['instances'],
            }

            vulnerabilitiesOutput.append(outputVuln)

        assetMd = tableToMarkdown('Nexpose asset ' + str(asset['id']), assetOutput, assetHeaders, removeNull=True)
        vulnerabilitiesMd = tableToMarkdown('Vulnerabilities', vulnerabilitiesOutput, vulnerabilityHeaders, removeNull=True) if len(vulnerabilitiesOutput) > 0 else ''
        softwareMd = tableToMarkdown('Software', softwareOutput, softwareHeaders, removeNull=True) if softwareOutput is not None else ''
        servicesMd = tableToMarkdown('Services', servicesOutput, serviceHeaders, removeNull=True) if servicesOutput is not None else ''
        usersMd = tableToMarkdown('Users', usersOutput, userHeaders, removeNull=True) if usersOutput is not None else ''

        md = assetMd + vulnerabilitiesMd + softwareMd + servicesMd + usersMd

        assetOutput['Vulnerability'] = vulnerabilitiesOutput
        assetOutput['Software'] = softwareOutput
        assetOutput['Service'] = servicesOutput
        assetOutput['User'] = usersOutput

        endpoint =  {
            'IP': assetOutput['Addresses'],
            'MAC': assetOutput['Hardware'],
            'HostName': assetOutput['Aliases'],
            'OS': assetOutput['OperatingSystem']
        }

        context = {
            'Nexpose.Asset(val.AssetId==obj.AssetId)': assetOutput,
            'Endpoint(val.IP==obj.IP)': endpoint
        }

        if len(cvesOutput) > 0:
            context['CVE(val.ID==obj.ID)'] = cvesOutput

        entry = {
            'Type': entryTypes['note'],
            'Contents': asset,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': md,
            'EntryContext': context
        }

        return entry

    def get_asset(asset_id):
        path = 'assets/' + str(asset_id)
        return send_request(path)

    def get_asset_vulnerability_command():
        v = get_asset_vulnerability(demisto.args()['id'] ,demisto.args()['vulnerabilityId'])

        if v is None:
            return 'Vulnerability not found'

        vulnHeaders = [
            'Id',
            'Title',
            'Severity',
            'RiskScore',
            'CVSS',
            'CVSSV3',
            'Published',
            'Added',
            'Modified',
            'CVSSScore',
            'CVSSV3Score',
            'Categories',
            'CVES'
        ]

        detailedVuln = get_vulnerability(v['id'])
        # Add to raw output
        v = dict(v.items() + detailedVuln.items())
        vulnOutputs = translate_object(detailedVuln, [
            {'from': 'id', 'to': 'Id'},
            {'from': 'title', 'to': 'Title'},
            {'from': 'severity', 'to': 'Severity'},
            {'from': 'riskScore', 'to': 'RiskScore'},
            {'from': 'cvss.v2.vector', 'to': 'CVSS'},
            {'from': 'cvss.v3.vector', 'to': 'CVSSV3'},
            {'from': 'published', 'to': 'Published'},
            {'from': 'added', 'to': 'Added'},
            {'from': 'modified', 'to': 'Modified'},
            {'from': 'cvss.v2.score', 'to': 'CVSSScore'},
            {'from': 'cvss.v3.score', 'to': 'CVSSV3Score'},
            {'from': 'categories', 'to': 'Categories'},
            {'from': 'cves', 'to': 'CVES'}
        ])

        resultsHeaders = [
            "Port",
            "Protocol",
            "Since",
            "Proof",
            "Status"
        ]

        resultsOutput = []
        if 'results' in v and len(v['results']) > 0:
            resultsOutput = translate_object(v['results'], [
            {'from': 'port', 'to': 'Port'},
            {'from': 'protocol', 'to':'Protocol'},
            {'from': 'since', 'to': 'Since'},
            {'from': 'proof', 'to': 'Proof'},
            {'from': 'status', 'to':'Status'}
        ])

        # Remove HTML tags
        for r in resultsOutput:
            r['Proof'] = re.sub('<.*?>', '', r['Proof'])

        solutionsHeaders = [
            'Type',
            'Summary',
            'Steps',
            'Estimate',
            'AdditionalInformation'
        ]

        solutionsOutput = None
        solutions = get_vulnerability_solutions(demisto.args()['id'], demisto.args()['vulnerabilityId'])
        # Add to raw output
        v['solutions'] = solutions
        if solutions is not None and len(solutions) > 0:
            solutionsOutput = translate_object(solutions['resources'], [
                {'from': 'type', 'to': 'Type'},
                {'from': 'summary.text', 'to': 'Summary'},
                {'from': 'steps.text', 'to': 'Steps'},
                {'from': 'estimate', 'to': 'Estimate'},
                {'from': 'additionalInformation.text', 'to': 'AdditionalInformation'}
            ])
            for i, val in enumerate(solutionsOutput):
                solutionsOutput[i]['Estimate'] = str(iso8601_duration_as_minutes(solutionsOutput[i]['Estimate'])) + ' minutes'

        vulnerabilitiesMd = tableToMarkdown('Vulnerability ' + demisto.args()['vulnerabilityId'], vulnOutputs, vulnHeaders, removeNull=True)
        resultsMd = tableToMarkdown('Checks', resultsOutput, resultsHeaders, removeNull=True) if len(resultsOutput) > 0 else ''
        solutionsMd = tableToMarkdown('Solutions', solutionsOutput, solutionsHeaders, removeNull=True) if solutionsOutput is not None else ''
        md = vulnerabilitiesMd + resultsMd + solutionsMd
        cves = []
        if(vulnOutputs['CVES'] is not None and len(vulnOutputs['CVES']) > 0):
            cves = map(lambda cve: {
            'ID': cve
            }, vulnOutputs['CVES'])

        vulnOutputs['Check'] = resultsOutput
        vulnOutputs['Solution'] = solutionsOutput
        asset = {
            'AssetId': demisto.args()['id'],
            'Vulnerability': [vulnOutputs]
        }

        context = {
            'Nexpose.Asset(val.AssetId==obj.AssetId)': asset,
        }

        if len(cves) > 0:
            context['CVE(val.ID==obj.ID)'] = cves

        entry = {
            'Type': entryTypes['note'],
            'Contents': v,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': md,
            'EntryContext': context
        }

        return entry


    def get_vulnerabilities(asset_id):
        path = 'assets/' + str(asset_id) + '/vulnerabilities'
        return get_list_response(path)

    def get_asset_vulnerability(asset_id, vulnerability_id):
        path = 'assets/' + str(asset_id) + '/vulnerabilities/' + str(vulnerability_id)
        return send_request(path)

    def get_vulnerability(vulnerability_id):
        path = 'vulnerabilities/' + str(vulnerability_id)
        return send_request(path)

    def get_vulnerability_solutions(asset_id, vulnerability_id):
        path = 'assets/' + str(asset_id) + '/vulnerabilities/' + str(vulnerability_id) + '/solution'

        return send_request(path)

    def search_by_filter(textFilters):
        if(textFilters is None):
            return []

        filters = get_search_filters(textFilters)
        assets = search_assets(filters, demisto.args()['match'], demisto.args().get('limit'), demisto.args().get('sort'))

        return assets

    def search_assets_command():
        textFilters = None
        queries = demisto.args().get('query')
        ip_addresses = demisto.args().get('ipAddressIs')
        host_names = demisto.args().get('hostNameIs')
        risk_score = demisto.args().get('riskScoreHigherThan')
        vulnerability_title = demisto.args().get('vulnerabilityTitleContains')
        siteIds = demisto.args().get('siteIdIn')

        assets = None
        if queries is not None:
            assets = search_by_filter(queries.split(';'))
        elif risk_score is not None:
            assets = search_by_filter(['risk-score is-greater-than ' + risk_score])
        elif vulnerability_title is not None:
            assets = search_by_filter(['vulnerability-title contains ' + vulnerability_title])
        elif siteIds is not None:
            assets = search_by_filter(['site-id in ' + siteIds])
        elif ip_addresses is not None:
            ips = ip_addresses.split(',')
            assets = []
            for i, ip in enumerate(ips):
                assets = assets + search_by_filter(['ip-address is ' + str(ip)])
        elif host_names is not None:
            host_names = host_names.split(',')
            assets = []
            for i, host_name in enumerate(host_names):
                assets = assets + search_by_filter(['host-name is ' + str(host_name)])

        if(assets is None or len(assets) == 0):
            return 'No assets found'

        for asset in assets:
            last_scan = get_last_scan(asset)
            asset['LastScanDate'] = last_scan['date']
            asset['LastScanId'] = last_scan['id']
            site = get_site(asset['id'])
            asset['Site'] = site['name'] if site != '' else ''

        headers = [
        'AssetId',
        'Address',
        'Name',
        'Site',
        'Exploits',
        'Malware',
        'OperatingSystem',
        'RiskScore',
        'Assessed',
        'LastScanDate',
        'LastScanId'
        ]

        outputs = translate_object(assets, [
            {'from': 'id', 'to': 'AssetId'},
            {'from': 'ip', 'to': 'Address'},
            {'from': 'hostName', 'to': 'Name'},
            {'from': 'Site', 'to': 'Site'},
            {'from': 'vulnerabilities.exploits', 'to': 'Exploits'},
            {'from': 'vulnerabilities.malwareKits', 'to': 'Malware'},
            {'from': 'os', 'to': 'OperatingSystem'},
            {'from': 'vulnerabilities.total', 'to': 'Vulnerabilities'},
            {'from': 'riskScore', 'to': 'RiskScore'},
            {'from': 'assessedForVulnerabilities', 'to': 'Assessed'},
            {'from': 'LastScanDate', 'to': 'LastScanDate'},
            {'from': 'LastScanId', 'to': 'LastScanId'}
        ])

        endpoint = map(lambda o: {
            'IP': o['Address'],
            'HostName': o['Name'],
            'OS': o['OperatingSystem']
        }, outputs)

        entry = {
            'Type': entryTypes['note'],
            'Contents': assets,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Nexpose assets', outputs, headers,removeNull=True),
            'EntryContext': {
                  'Nexpose.Asset(val.AssetId==obj.AssetId)': outputs,
                  'Endpoint(val.IP==obj.IP)': endpoint
            }
        }

        return entry

    def get_search_filters(textFilters):
        filters = []
        for text in textFilters:
            components = text.split(' ')
            field = components[0]
            operator = components[1]
            value = components[2].split(',')
            # Convert numbers to floats if values are numbers
            for i, v in enumerate(value):
                currVal = None
                try:
                    currVal = float(v)
                except:
                    currVal = v
                value[i] = currVal

            flt = {
                'field': field,
                'operator': operator,
            }
            if len(value) > 1:
                if operator in RANGE_OPERATORS:
                    flt['lower'] = value[0]
                    flt['upper'] = value[1]
                else:
                    flt['values'] = value
            else:
                flt['value'] = value[0]
            filters.append(flt)
        return filters

    def search_assets(filters, match, limit=None, sort=None):
        search_body = {
            'filters': filters,
            'match': match
        }

        path = 'assets/search'
        params = {}
        if sort is not None:
            params['sort'] = sort.split(';')

        return get_list_response(path, method='post', limit=limit, body=search_body, params=params)

    def get_assets_command():
        limit = demisto.args().get('limit')
        sort = demisto.args().get('sort')
        assets = get_assets(limit=limit, sort=sort)

        if(assets is None or len(assets) == 0):
            return 'No assets found'

        for asset in assets:
            last_scan = get_last_scan(asset)
            asset['LastScanDate'] = last_scan['date']
            asset['LastScanId'] = last_scan['id']
            site = get_site(asset['id'])
            asset['Site'] = site['name'] if site != '' else ''

        headers = [
        'AssetId',
        'Address',
        'Name',
        'Site',
        'Exploits',
        'Malware',
        'OperatingSystem',
        'Vulnerabilities',
        'RiskScore',
        'Assessed',
        'LastScanDate',
        'LastScanId'
        ]

        outputs = translate_object(assets, [
            {'from': 'id', 'to': 'AssetId'},
            {'from': 'ip', 'to': 'Address'},
            {'from': 'hostName', 'to': 'Name'},
            {'from': 'Site', 'to': 'Site'},
            {'from': 'vulnerabilities.exploits', 'to': 'Exploits'},
            {'from': 'vulnerabilities.malwareKits', 'to': 'Malware'},
            {'from': 'os', 'to': 'OperatingSystem'},
            {'from': 'vulnerabilities.total', 'to': 'Vulnerabilities'},
            {'from': 'riskScore', 'to': 'RiskScore'},
            {'from': 'assessedForVulnerabilities', 'to': 'Assessed'},
            {'from': 'LastScanDate', 'to': 'LastScanDate'},
            {'from': 'LastScanId', 'to': 'LastScanId'}
        ])

        endpoint = map(lambda o: {
            'IP': o['Address'],
            'HostName': o['Name'],
            'OS': o['OperatingSystem']
        }, outputs)

        entry = {
            'Type': entryTypes['note'],
            'Contents': assets,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Nexpose assets', outputs, headers,removeNull=True),
            'EntryContext': {
                  'Nexpose.Asset(val.AssetId==obj.AssetId)': outputs,
                  'Endpoint(val.IP==obj.IP)': endpoint
            }
        }

        return entry

    def get_assets(limit=None, sort=None):
        params = {}
        if sort is not None:
            params['sort'] = sort.split(';')
        return get_list_response('assets', limit=limit, params=params)

    def get_scan_command():
        scan = get_scan(demisto.args()['id'])

        if(scan is None):
            return 'Scan not found'

        return get_scan_entry(scan)

    def get_scan_entry(scan):
        scanHeaders = [
            'Id',
            'ScanType',
            'ScanName',
            'StartedBy',
            'Assets',
            'TotalTime',
            'Completed',
            'Status',
            'Message'
        ]

        scanOutput = translate_object(scan, [
            {'from': 'id', 'to': 'Id'},
            {'from': 'scanType', 'to': 'ScanType'},
            {'from': 'scanName', 'to': 'ScanName'},
            {'from': 'startedBy', 'to': 'StartedBy'},
            {'from': 'assets', 'to': 'Assets'},
            {'from': 'duration', 'to': 'TotalTime'},
            {'from': 'endTime', 'to': 'Completed'},
            {'from': 'status', 'to': 'Status'},
            {'from': 'message', 'to': 'Message'}
        ])

        scanOutput['TotalTime'] = str(iso8601_duration_as_minutes(scanOutput['TotalTime'])) + ' minutes'

        vulnHeaders = [
            'Critical',
            'Severe',
            'Moderate',
            'Total'
        ]

        vulnOutput = translate_object(scan['vulnerabilities'], [
            {'from': 'critical', 'to': 'Critical'},
            {'from': 'severe', 'to': 'Severe'},
            {'from': 'moderate', 'to': 'Moderate'},
            {'from': 'total', 'to': 'Total'}
        ])

        scanMd = tableToMarkdown('Nexpose scan ' + str(scan['id']), scanOutput, scanHeaders,removeNull=True)
        vulnMd = tableToMarkdown('Vulnerabilities', vulnOutput, vulnHeaders, removeNull=True)
        md = scanMd + vulnMd

        scanOutput['Vulnerabilities'] = vulnOutput

        entry = {
            'Type': entryTypes['note'],
            'Contents': scan,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': md,
            'EntryContext': {
                  'Nexpose.Scan(val.Id==obj.Id)': scanOutput,
            }
        }

        return entry

    def get_scan(scan_id):
        path = 'scans/' + str(scan_id)
        return send_request(path)

    def get_sites_command():
        sites = get_sites(limit=demisto.args().get('limit'),sort=demisto.args().get('sort'))

        if(sites is None or len(sites) == 0):
            return 'No sites found'

        headers = [
            'Id',
            'Name',
            'Assets',
            'Vulnerabilities',
            'Risk',
            'Type',
            'LastScan'
        ]

        outputs = translate_object(sites, [
            {'from': 'id', 'to': 'Id'},
            {'from': 'name', 'to': 'Name'},
            {'from': 'assets', 'to': 'Assets'},
            {'from': 'vulnerabilities.total', 'to': 'Vulnerabilities'},
            {'from': 'riskScore', 'to': 'Risk'},
            {'from': 'type', 'to': 'Type'},
            {'from': 'lastScanTime', 'to': 'LastScan'}
        ])

        entry = {
            'Type': entryTypes['note'],
            'Contents': sites,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Nexpose sites', outputs, headers,removeNull=True),
            'EntryContext': {
                  'Nexpose.Site(val.Id==obj.Id)': outputs,
            }
        }

        return entry

    def get_sites(limit=None, sort=None):
        path = 'sites'
        params = {}
        if sort is not None:
            params['sort'] = sort.split(';')
        return get_list_response(path, limit=limit, params=params)

    def get_report_templates_command():
        templates = get_report_templates()

        if(templates is None or len(templates) == 0 or 'resources' not in templates):
            return 'No templates found'

        headers = [
            'Id',
            'Name',
            'Description',
            'Type'
        ]

        outputs = translate_object(templates['resources'], [
            {'from': 'id', 'to': 'Id'},
            {'from': 'name', 'to': 'Name'},
            {'from': 'description', 'to': 'Description'},
            {'from': 'type', 'to': 'Type'},
        ])

        entry = {
            'Type': entryTypes['note'],
            'Contents': templates,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Nexpose templates', outputs, headers,removeNull=True),
            'EntryContext': {
                  'Nexpose.Template(val.Id==obj.Id)': outputs,
            }
        }

        return entry

    def get_report_templates():
        path = 'report_templates'

        return send_request(path)

    def create_assets_report_command():
        assets = str(demisto.args()['assets']).split(',')
        template = demisto.args().get('template')
        name = demisto.args().get('name','report ' + str(datetime.now()))
        reportFormat = demisto.args().get('format', 'pdf')

        scope = {
            'assets': assets
        }

        report_id = create_report(scope, name, template, reportFormat)

        if report_id is None:
            return 'Could not retrieve report'

        return download_report(report_id, name, reportFormat)

    def create_sites_report_command():
        sites = str(demisto.args()['sites']).split(',')
        template = demisto.args().get('template')
        name = demisto.args().get('name','report ' + str(datetime.now()))
        reportFormat = demisto.args().get('format', 'pdf')

        scope = {
            'sites': sites
        }

        report_id = create_report(scope, name, template, reportFormat)

        if report_id is None:
            return 'Could not retrieve report'

        return download_report(report_id, name, reportFormat)

    def create_scan_report_command():
        scan = demisto.args()['scan']
        template = demisto.args().get('template')
        name = demisto.args().get('name','report ' + str(datetime.now()))
        reportFormat = demisto.args().get('format', 'pdf')
        scope = {
            'scan': scan
        }

        report_id = create_report(scope, name, template, reportFormat)

        if report_id is None:
            return 'Could not retrieve report'

        return download_report(report_id, name, reportFormat)

    def create_report(scope, name, template, reportFormat):
        if template is None:
            templates = get_report_templates()
            if(templates is None or len(templates) == 0 or 'resources' not in templates):
                return 'No templates found'
            template = templates['resources'][0]['id']
        for i, (k,v) in enumerate(scope.items()):
            if not isinstance(v, list):
               scope[k] = int(v)
            else:
                for i, v in enumerate(scope[k]):
                    scope[k][i] = int(v)
        path = 'reports'
        body = {
            'scope': scope,
            'template': template,
            'name': name,
            'format': reportFormat
        }

        result = send_request(path, 'post', body=body)
        return result['id'] if 'id' in result else None

    def download_report(report_id, name, reportFormat):
        # Generate the report
        path = 'reports/' + str(report_id) +' /generate'
        instance = send_request(path, 'post')
        if(instance is None):
            return 'Failed to generate report'

        headers = {
            'Accept': 'application/json',
            'Accept-Encoding': 'gzip, deflate, br'
        }

        # Wait for the report to be completed
        time.sleep(10)

        # Download
        path = 'reports/' + str(report_id) + '/history/' + str(instance['id']) + '/output'
        report = send_request(path, headers=headers, is_file=True)

        return fileResult(name + '.' + reportFormat, report)

    def start_assets_scan_command():
        ips = demisto.args().get('IPs')
        hostNames = demisto.args().get('hostNames')
        name = demisto.args().get('name', 'scan ' + str(datetime.now()))

        textFilters = None
        if ips:
            ips = ips.split(',')
            textFilters = ['ip-address is ' + ips[0]]
        elif hostNames:
            hostNames = hostNames.split(',')
            textFilters = ['host-name is ' + hostNames[0]]

        if textFilters is None:
            return 'No IPs or hosts were provided'

        filters = get_search_filters(textFilters)
        asset = search_assets(filters, match='all')

        if asset is None or len(asset) == 0:
            return 'Could not find assets'

        site = get_site(asset[0]['id'])
        if site is None or 'id' not in site:
            return 'Could not find site'

        hosts = []
        if ips:
            hosts += ips
        if hostNames:
            hosts += hostNames

        scan_response = start_scan(site['id'], hosts, name)

        if(scan_response is None or 'id' not in scan_response):
            return 'Could not start scan'

        scan = get_scan(scan_response['id'])

        return get_scan_entry(scan)

    def start_site_scan_command():
        site = demisto.args()['site']
        name = demisto.args().get('name', 'scan ' + str(datetime.now()))
        hosts = demisto.args().get('hosts', '')

        scan_response = start_scan(site, hosts.split(','), name)

        if(scan_response is None or 'id' not in scan_response):
            return 'Could not start scan'

        scan = get_scan(scan_response['id'])

        return get_scan_entry(scan)

    def start_scan(site, hosts, name):
        path = 'sites/' + str(site) + '/scans'
        body = {
            'name': name,
            'hosts': hosts
        }

        return send_request(path, 'post', body=body)

    try:
        if demisto.command() == 'test-module':
            get_assets(limit=1)
            demisto.results('ok')
        if demisto.command() == 'nexpose-get-assets':
            demisto.results(get_assets_command())
        if demisto.command() == 'nexpose-get-asset':
            demisto.results(get_asset_command())
        if demisto.command() == 'nexpose-get-asset-vulnerability':
            demisto.results(get_asset_vulnerability_command())
        if demisto.command() == 'nexpose-search-assets':
            demisto.results(search_assets_command())
        if demisto.command() == 'nexpose-get-scan':
            demisto.results(get_scan_command())
        if demisto.command() == 'nexpose-get-sites':
            demisto.results(get_sites_command())
        if demisto.command() == 'nexpose-get-report-templates':
            demisto.results(get_report_templates_command())
        if demisto.command() == 'nexpose-create-assets-report':
            demisto.results(create_assets_report_command())
        if demisto.command() == 'nexpose-create-sites-report':
            demisto.results(create_sites_report_command())
        if demisto.command() == 'nexpose-create-scan-report':
            demisto.results(create_scan_report_command())
        if demisto.command() == 'nexpose-start-site-scan':
            demisto.results(start_site_scan_command())
        if demisto.command() == 'nexpose-start-assets-scan':
            demisto.results(start_assets_scan_command())
    except Exception as e:
        LOG(e.message)
        LOG.print_log()
        raise
  type: python
  commands:
  - name: nexpose-get-asset
    arguments:
    - name: id
      required: true
      description: integer <int64> The identifier of the asset.
    outputs:
    - contextPath: Nexpose.Asset.Addresses
      description: All addresses discovered on the asset.
    - contextPath: Nexpose.Asset.AssetId
      description: Id of the asset.
    - contextPath: Nexpose.Asset.Hardware
      description: The primary Media Access Control (MAC) address of the asset. The
        format is six groups of two hexadecimal digits separated by colons.
    - contextPath: Nexpose.Asset.Aliases
      description: All host names or aliases discovered on the asset.
    - contextPath: Nexpose.Asset.HostType
      description: The type of asset, Valid values are unknown, guest, hypervisor,
        physical, mobile
    - contextPath: Nexpose.Asset.Site
      description: Asset site name.
    - contextPath: Nexpose.Asset.OperatingSystem
      description: Operating system of the asset.
    - contextPath: Nexpose.Asset.Vulnerabilities
      description: The total number of vulnerabilities on the asset.
    - contextPath: Nexpose.Asset.CPE
      description: The Common Platform Enumeration (CPE) of the operating system.
    - contextPath: Nexpose.Asset.LastScanDate
      description: Last scan date of the asset.
    - contextPath: Nexpose.Asset.LastScanId
      description: Id of the asset's last scan.
    - contextPath: Nexpose.Asset.RiskScore
      description: The risk score (with criticality adjustments) of the asset.
    - contextPath: Nexpose.Asset.Software.Software
      description: The description of the software.
    - contextPath: Nexpose.Asset.Software.Version
      description: The version of the software.
    - contextPath: Nexpose.Asset.Services.Name
      description: The name of the service.
    - contextPath: Nexpose.Asset.Services.Port
      description: The port of the service.
    - contextPath: Nexpose.Asset.Services.Product
      description: The product running the service.
    - contextPath: Nexpose.Asset.Services.protocol
      description: The protocol of the service, valid values are ip, icmp, igmp, ggp,
        tcp, pup, udp, idp, esp, nd, raw
    - contextPath: Nexpose.Asset.Users.FullName
      description: The full name of the user account.
    - contextPath: Nexpose.Asset.Users.Name
      description: The name of the user account.
    - contextPath: Nexpose.Asset.Users.UserId
      description: The identifier of the user account.
    - contextPath: Nexpose.Asset.Vulnerability.Id
      description: The identifier of the vulnerability.
    - contextPath: Nexpose.Asset.Vulnerability.Instances
      description: The number of vulnerable occurrences of the vulnerability. This
        does not include invulnerable instances.
    - contextPath: Nexpose.Asset.Vulnerability.Title
      description: The title (summary) of the vulnerability.
    - contextPath: Nexpose.Asset.Vulnerability.Malware
      description: The malware kits that are known to be used to exploit the vulnerability.
    - contextPath: Nexpose.Asset.Vulnerability.Exploit
      description: The exploits that can be used to exploit a vulnerability.
    - contextPath: Nexpose.Asset.Vulnerability.CVSS
      description: The CVSS exploit score.
    - contextPath: Nexpose.Asset.Vulnerability.Risk
      description: The risk score of the vulnerability, rounded to a maximum of to
        digits of precision. If using the default Rapid7 Real Riskâ„¢ model, this value
        ranges from 0-1000.
    - contextPath: Nexpose.Asset.Vulnerability.PublishedOn
      description: The date the vulnerability was first published or announced. The
        format is an ISO 8601 date, YYYY-MM-DD.
    - contextPath: Nexpose.Asset.Vulnerability.ModifiedOn
      description: The last date the vulnerability was modified. The format is an
        ISO 8601 date, YYYY-MM-DD.
    - contextPath: Nexpose.Asset.Vulnerability.Severity
      description: 'The severity of the vulnerability, one of: "Moderate", "Severe",
        "Critical".'
    - contextPath: Endpoint.IP
      description: Endpoint IP address.
    - contextPath: Endpoint.HostName
      description: Endpoint host name.
    - contextPath: Endpoint.OS
      description: Endpoint operating system.
    - contextPath: CVE.ID
      description: Common Vulnerabilities and Exposures ids
    description: Returns the specified asset.
  - name: nexpose-get-assets
    arguments:
    - name: sort
      description: 'Multiple criteria of <string> The criteria to sort the records
        by, in the format: property[,ASC|DESC]. The default sort order is ascending.
        Multiple sort criteria can be specified using multiple sort query parameters
        separated by a '';''. For example: ''riskScore,DESC;hostName,ASC'''
    - name: limit
      description: integer <int32> The number of records retrieve.
    outputs:
    - contextPath: Nexpose.Asset.AssetId
      description: The identifier of the asset.
    - contextPath: Nexpose.Asset.Address
      description: The primary IPv4 or IPv6 address of the asset.
    - contextPath: Nexpose.Asset.Name
      description: The primary host name (local or FQDN) of the asset.
    - contextPath: Nexpose.Asset.Site
      description: Asset site name.
    - contextPath: Nexpose.Asset.Exploits
      description: The number of distinct exploits that can exploit any of the vulnerabilities
        on the asset.
    - contextPath: Nexpose.Asset.Malware
      description: The number of distinct malware kits that vulnerabilities on the
        asset are susceptible to.
    - contextPath: Nexpose.Asset.OperatingSystem
      description: Operating system of the asset.
    - contextPath: Nexpose.Asset.Vulnerabilities
      description: The total number of vulnerabilities.
    - contextPath: Nexpose.Asset.RiskScore
      description: The risk score (with criticality adjustments) of the asset.
    - contextPath: Nexpose.Asset.Assessed
      description: Whether the asset has been assessed for vulnerabilities at least
        once.
    - contextPath: Nexpose.Asset.LastScanDate
      description: Last scan date of the asset.
    - contextPath: Nexpose.Asset.LastScanId
      description: Id of the asset's last scan.
    - contextPath: Endpoint.IP
      description: Endpoint IP address.
    - contextPath: Endpoint.HostName
      description: Endpoint host name.
    - contextPath: Endpoint.OS
      description: Endpoint operating system.
    description: Returns all assets for which you have access.
  - name: nexpose-search-assets
    arguments:
    - name: query
      description: 'Multiple criteria of <string> Filter to match assets, according
        to the Search Criteria API standard. multiple filters can be provided using
        '';'' separator. For example: ''ip-address in range 1.2.3.4,1.2.3.8;host-name
        is myhost''. For more information regarding Search Criteria, refer to https://help.rapid7.com/insightvm/en-us/api/index.html#section/Overview/Responses'
    - name: limit
      description: integer <int32> The number of records retrieve.
    - name: sort
      description: 'Multiple criteria of <string> The criteria to sort the records
        by, in the format: property[,ASC|DESC]. The default sort order is ascending.
        Multiple sort criteria can be specified using multiple sort query parameters
        separated by a '';''. For example: ''riskScore,DESC;hostName,ASC'''
    - name: ipAddressIs
      description: <string> Search by a specific IP address
    - name: hostNameIs
      description: <string> Search by a specific host name
    - name: riskScoreHigherThan
      description: <float> Get all assets whose risk score is higher
    - name: vulnerabilityTitleContains
      description: <string> Search by vulnerability title
    - name: siteIdIn
      description: Multiple criteria of integer<int32> Search by site ids
    - name: match
      auto: PREDEFINED
      predefined:
      - all
      - any
      description: <string> Operator to determine how to match filters. all requires
        that all filters match for an asset to be included. any requires only one
        filter to match for an asset to be included.
      defaultValue: all
    outputs:
    - contextPath: Nexpose.Asset.AssetId
      description: The identifier of the asset.
    - contextPath: Nexpose.Asset.Address
      description: The primary IPv4 or IPv6 address of the asset.
    - contextPath: Nexpose.Asset.Name
      description: The primary host name (local or FQDN) of the asset.
    - contextPath: Nexpose.Asset.Site
      description: Asset site name.
    - contextPath: Nexpose.Asset.Exploits
      description: The number of distinct exploits that can exploit any of the vulnerabilities
        on the asset.
    - contextPath: Nexpose.Asset.Malware
      description: The number of distinct malware kits that vulnerabilities on the
        asset are susceptible to.
    - contextPath: Nexpose.Asset.OperatingSystem
      description: Operating system of the asset.
    - contextPath: Nexpose.Asset.Vulnerabilities
      description: The total number of vulnerabilities.
    - contextPath: Nexpose.Asset.RiskScore
      description: The risk score (with criticality adjustments) of the asset.
    - contextPath: Nexpose.Asset.Assessed
      description: Whether the asset has been assessed for vulnerabilities at least
        once.
    - contextPath: Nexpose.Asset.LastScanDate
      description: Last scan date of the asset.
    - contextPath: Nexpose.Asset.LastScanId
      description: Id of the asset's last scan.
    - contextPath: Endpoint.IP
      description: Endpoint IP address.
    - contextPath: Endpoint.HostName
      description: Endpoint host name.
    - contextPath: Endpoint.OS
      description: Endpoint operating system.
    description: Returns all assets for which you have access that match the given
      search criteria.
  - name: nexpose-get-scan
    arguments:
    - name: id
      required: true
      description: integer <int64> The identifier of the scan.
    outputs:
    - contextPath: Nexpose.Scan.Id
      description: The identifier of the scan.
    - contextPath: Nexpose.Scan.ScanType
      description: The scan type (automated, manual, scheduled).
    - contextPath: Nexpose.Scan.StartedBy
      description: The name of the user that started the scan.
    - contextPath: Nexpose.Scan.Assets
      description: The number of assets found in the scan
    - contextPath: Nexpose.Scan.TotalTime
      description: The duration of the scan in minutes.
    - contextPath: Nexpose.Scan.Completed
      description: The end time of the scan in ISO8601 format.
    - contextPath: Nexpose.Scan.Status
      description: The scan status. Valid values are aborted, unknown, running, finished,
        stopped, error, paused, dispatched, integrating
    - contextPath: Nexpose.Scan.Completed
      description: The end time of the scan in ISO8601 format.
    - contextPath: Nexpose.Scan.Vulnerabilities.Critical
      description: The number of critical vulnerabilities.
    - contextPath: Nexpose.Scan.Vulnerabilities.Moderate
      description: The number of moderate vulnerabilities.
    - contextPath: Nexpose.Scan.Vulnerabilities.Severe
      description: The number of severe vulnerabilities.
    - contextPath: Nexpose.Scan.Vulnerabilities.Total
      description: The total number of vulnerabilities.
    description: Returns the specified scan.
  - name: nexpose-get-asset-vulnerability
    arguments:
    - name: id
      required: true
      description: integer <int64> The identifier of the asset.
    - name: vulnerabilityId
      required: true
      description: <string> The identifier of the vulnerability.
    outputs:
    - contextPath: Nexpose.Asset.AssetId
      description: Identifier of the asset.
    - contextPath: Nexpose.Asset.Vulnerability.Id
      description: The identifier of the vulnerability.
    - contextPath: Nexpose.Asset.Vulnerability.Title
      description: The title (summary) of the vulnerability.
    - contextPath: Nexpose.Asset.Vulnerability.Severity
      description: 'The severity of the vulnerability, one of: "Moderate", "Severe",
        "Critical".'
    - contextPath: Nexpose.Asset.Vulnerability.RiskScore
      description: The risk score of the vulnerability, rounded to a maximum of to
        digits of precision. If using the default Rapid7 Real Riskâ„¢ model, this value
        ranges from 0-1000.
    - contextPath: Nexpose.Asset.Vulnerability.CVSS
      description: The CVSS vector(s) for the vulnerability.
    - contextPath: Nexpose.Asset.Vulnerability.CVSSV3
      description: The CVSS v3 vector.
    - contextPath: Nexpose.Asset.Vulnerability.Published
      description: The date the vulnerability was first published or announced. The
        format is an ISO 8601 date, YYYY-MM-DD.
    - contextPath: Nexpose.Asset.Vulnerability.Added
      description: The date the vulnerability coverage was added. The format is an
        ISO 8601 date, YYYY-MM-DD.
    - contextPath: Nexpose.Asset.Vulnerability.Modified
      description: The last date the vulnerability was modified. The format is an
        ISO 8601 date, YYYY-MM-DD.
    - contextPath: Nexpose.Asset.Vulnerability.CVSSScore
      description: The CVSS score, which ranges from 0-10.
    - contextPath: Nexpose.Asset.Vulnerability.CVSSV3Score
      description: The CVSS3 score, which ranges from 0-10.
    - contextPath: Nexpose.Asset.Vulnerability.Categories
      description: All vulnerability categories assigned to this vulnerability.
    - contextPath: Nexpose.Asset.Vulnerability.CVES
      description: All CVEs assigned to this vulnerability.
    - contextPath: Nexpose.Asset.Vulnerability.Check.Port
      description: The port of the service the result was discovered on.
    - contextPath: Nexpose.Asset.Vulnerability.Check.Protocol
      description: The protocol of the service the result was discovered on, valid
        values ip, icmp, igmp, ggp, tcp, pup, udp, idp, esp, nd, raw
    - contextPath: Nexpose.Asset.Vulnerability.Check.Since
      description: The date and time the result was first recorded, in the ISO8601
        format. If the result changes status this value is the date and time of the
        status change.
    - contextPath: Nexpose.Asset.Vulnerability.Check.Proof
      description: The proof explaining why the result was found vulnerable.
    - contextPath: Nexpose.Asset.Vulnerability.Check.Status
      description: The status of the vulnerability check result. Valid values are,
        unknown, not-vulnerable, vulnerable, vulnerable-version, vulnerable-potential,
        vulnerable-with-exception-applied, vulnerable-version-with-exception-applied,
        vulnerable-potential-with-exception-applied
    - contextPath: Nexpose.Asset.Vulnerability.Solution.Type
      description: 'The type of the solution. One of: "Configuration", "Rollup patch",
        "Patch".'
    - contextPath: Nexpose.Asset.Vulnerability.Solution.Summary
      description: The summary of the solution.
    - contextPath: Nexpose.Asset.Vulnerability.Solution.Steps
      description: The steps required to remediate the vulnerability.
    - contextPath: Nexpose.Asset.Vulnerability.Solution.Estimate
      description: The estimated duration to apply the solution, in minutes.
    - contextPath: Nexpose.Asset.Vulnerability.Solution.AdditionalInformation
      description: Additional information or resources that can assist in applying
        the remediation
    - contextPath: CVE.ID
      description: Common Vulnerabilities and Exposures ids
    description: Returns the details and possible remediations for an asset's given
      vulnerability.
  - name: nexpose-get-sites
    arguments:
    - name: limit
      description: integer <int32> The number of records retrieve.
    - name: sort
      description: 'Multiple criteria of <string> The criteria to sort the records
        by, in the format: property[,ASC|DESC]. The default sort order is ascending.
        Multiple sort criteria can be specified using multiple sort query parameters
        separated by a '';''. For example: ''riskScore,DESC;hostName,ASC'''
    outputs:
    - contextPath: Nexpose.Site.Id
      description: The identifier of the site.
    - contextPath: Nexpose.Site.Name
      description: The site name.
    - contextPath: Nexpose.Site.Assets
      description: The number of assets that belong to the site.
    - contextPath: Nexpose.Site.Type
      description: The type of the site. Valid values are agent, dynamic, static
    - contextPath: Nexpose.Site.Vulnerabilities
      description: The total number of vulnerabilities.
    - contextPath: Nexpose.Site.Risk
      description: The risk score (with criticality adjustments) of the site.
    - contextPath: Nexpose.Site.LastScan
      description: The date and time of the site's last scan.
    description: Retrieves accessible sites.
  - name: nexpose-get-report-templates
    arguments: []
    outputs:
    - contextPath: Nexpose.Template.Id
      description: The identifier of the report template;
    - contextPath: Nexpose.Template.Name
      description: The name of the report template.
    - contextPath: Nexpose.Template.Description
      description: The description of the report template.
    - contextPath: Nexpose.Template.Type
      description: The type of the report template. document is a templatized, typically
        printable, report that has various sections of content. export is data-oriented
        output, typically CSV. file is a printable report template using a report
        template file.
    description: Returns all available report templates.
  - name: nexpose-create-assets-report
    arguments:
    - name: assets
      required: true
      description: Multiple criteria of integer<int64> Asset ids to create the report
        on, comma separated.
    - name: template
      description: <string> Report template id to create the report with. If none
        is provided, the first template available will be used.
    - name: name
      description: <string> The report name
    - name: format
      auto: PREDEFINED
      predefined:
      - pdf
      - rtf
      - xml
      - html
      - text
      description: <string> The report format, default is PDF
    description: Generates a new report on given assets according to a template and
      arguments.
  - name: nexpose-create-sites-report
    arguments:
    - name: sites
      required: true
      description: Multiple criteria of integer<int32> Site ids to create the report
        on, comma separated.
    - name: template
      description: <string> Report template id to create the report with. If none
        is provided, the first template available will be used.
    - name: name
      description: <string> The report name
    - name: format
      auto: PREDEFINED
      predefined:
      - pdf
      - rtf
      - xml
      - html
      - text
      description: <string> The report format, default is PDF
    description: Generates a new report on given sites according to a template and
      arguments.
  - name: nexpose-create-scan-report
    arguments:
    - name: scan
      required: true
      description: integer <int64> The identifier of the scan.
    - name: template
      description: <string> Report template id to create the report with. If none
        is provided, the first template available will be used.
    - name: name
      description: <string> The report name
    - name: format
      auto: PREDEFINED
      predefined:
      - pdf
      - rtf
      - xml
      - html
      - text
      description: <string> The report format, default is PDF
    description: Generates a new report for a specified scan.
  - name: nexpose-start-site-scan
    arguments:
    - name: site
      required: true
      description: integer <int32> The identifier of the site.
    - name: hosts
      description: Multiple criteria of <string> The hosts that should be included
        as a part of the scan. This should be a mixture of IP Addresses and Hostnames
        as a comma separated string array.
    - name: name
      description: <string> The user-driven scan name for the scan.
    outputs:
    - contextPath: Nexpose.Scan.Id
      description: The identifier of the scan.
    - contextPath: Nexpose.Scan.ScanType
      description: The scan type (automated, manual, scheduled).
    - contextPath: Nexpose.Scan.StartedBy
      description: The name of the user that started the scan.
    - contextPath: Nexpose.Scan.Assets
      description: The number of assets found in the scan
    - contextPath: Nexpose.Scan.TotalTime
      description: The duration of the scan in minutes.
    - contextPath: Nexpose.Scan.Completed
      description: The end time of the scan in ISO8601 format.
    - contextPath: Nexpose.Scan.Status
      description: The scan status. Valid values are aborted, unknown, running, finished,
        stopped, error, paused, dispatched, integrating
    - contextPath: Nexpose.Scan.Completed
      description: The end time of the scan in ISO8601 format.
    - contextPath: Nexpose.Scan.Vulnerabilities.Critical
      description: The number of critical vulnerabilities.
    - contextPath: Nexpose.Scan.Vulnerabilities.Moderate
      description: The number of moderate vulnerabilities.
    - contextPath: Nexpose.Scan.Vulnerabilities.Severe
      description: The number of severe vulnerabilities.
    - contextPath: Nexpose.Scan.Vulnerabilities.Total
      description: The total number of vulnerabilities.
    description: Starts a scan for the specified site.
  - name: nexpose-start-assets-scan
    arguments:
    - name: IPs
      description: Multiple criteria of <string> IP addresses of assets, comma separated.
    - name: hostNames
      description: Multiple criteria of <string> Host names of assets, comma separated.
    - name: name
      description: <string> The user-driven scan name for the scan.
    outputs:
    - contextPath: Nexpose.Scan.Id
      description: The identifier of the scan.
    - contextPath: Nexpose.Scan.ScanType
      description: The scan type (automated, manual, scheduled).
    - contextPath: Nexpose.Scan.StartedBy
      description: The name of the user that started the scan.
    - contextPath: Nexpose.Scan.Assets
      description: The number of assets found in the scan
    - contextPath: Nexpose.Scan.TotalTime
      description: The duration of the scan in minutes.
    - contextPath: Nexpose.Scan.Completed
      description: The end time of the scan in ISO8601 format.
    - contextPath: Nexpose.Scan.Status
      description: The scan status. Valid values are aborted, unknown, running, finished,
        stopped, error, paused, dispatched, integrating
    - contextPath: Nexpose.Scan.Completed
      description: The end time of the scan in ISO8601 format.
    - contextPath: Nexpose.Scan.Vulnerabilities.Critical
      description: The number of critical vulnerabilities.
    - contextPath: Nexpose.Scan.Vulnerabilities.Moderate
      description: The number of moderate vulnerabilities.
    - contextPath: Nexpose.Scan.Vulnerabilities.Severe
      description: The number of severe vulnerabilities.
    - contextPath: Nexpose.Scan.Vulnerabilities.Total
      description: The total number of vulnerabilities.
    description: Starts a scan for specified asset IP addresses and host names.
  runonce: false
fromversion: 3.6.0
toversion: 3.6.0
