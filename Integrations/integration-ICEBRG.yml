commonfields:
  id: icebrg
  version: -1
name: icebrg
display: Icebrg
category: Network Security
image: data:image/png;base64,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
description: Reduces risk by accelerating threat detection, triage, and response to
  rapidly-evolving breaches across global networks.
configuration:
- display: Server URL for the search API (e.g. https://192.168.0.1)
  name: url_search
  defaultvalue: https://events.icebrg.io/v2/query
  type: 0
  required: false
- display: Server URL for the reports API (e.g. https://192.168.0.1)
  name: url_reports
  defaultvalue: https://report.icebrg.io/v1/reports
  type: 0
  required: false
- display: ICEBRG token
  name: token
  defaultvalue: ""
  type: 0
  required: true
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
script:
  script: |
    var auth = 'IBToken ' + params.token;
    var sendRequest = function(method, api, endpoint, body) {
        if (api == 'Search') {
            var url = params.url_search;
        } else {
            var url = params.url_reports;
        }
        endpoint = endpoint ? endpoint : '';
        var requestUrl = url.replace(/[\/]+$/, '') + '/' + endpoint;
        if (api === 'Reports' && !endpoint) {
            requestUrl = requestUrl + body;
            var res = http(
                requestUrl,
                {
                    Method: method,
                    Headers: {
                        'Authorization': [auth],
                        'Content-Type': ['application/json']
                    }
                },
                params.insecure,
                params.proxy
            );
        } else {
            var res = http(
                requestUrl,
                {
                    Method: method,
                    Headers: {
                        'Authorization': [auth],
                        'Content-Type': ['application/json']
                    },
                    Body: body ? JSON.stringify(body) : undefined
                },
                params.insecure,
                params.proxy
            );
        }

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }
        return JSON.parse(res.Body);
    };

    var responseToEntry = function (response, path, title) {
        var data=[];
        if (Array.isArray(response)) {
            resKeys = Object.keys(response[0]);
        } else {
            resKeys = Object.keys(response);
        }
        for (i = 0; i < resKeys.length; i++) {
            data.push({
                to : underscoreToCamelCase(resKeys[i]),
                from: resKeys[i]
            });
        }
        var translator = {
            contextPath: 'Icebrg.' + path,
            title: title,
            data: data
        };
        return createEntry(response, translator);
    };

    var uppercaseKeys = function(obj) {
        return {
            UserUuid: obj.user_uuid,
            Published: obj.published
        };
    };

    var fetchCommandIncidents = function(urlArgs) {

        incidents = [];
        var res = sendRequest('GET', 'Reports', undefined, urlArgs);
        if (res.reports) {
            res.reports.forEach(function(inc){
                if (inc.asset_count > 0) {
                    inc['origin'] = 'Reports';
                    var ind = reportIndicators(inc.uuid);
                    var asset = reportAssets(inc.uuid);
                    if (asset.EntryContext) {
                        inc['Assets'] = asset.EntryContext['Icebrg.ReportAssets'];
                    }
                    if (ind.EntryContext) {
                        inc['Indicators'] = ind.EntryContext['Icebrg.ReportIndicators'];
                    }
                    incidents.push({name: 'Reports', rawJSON: JSON.stringify(inc).replace(/\\"/g, '"')});
                }
            });
        }
        return incidents;
    };

    var fetchIncidents = function() {

        var lastRun = getLastRun();
        nowDate = new Date();
        var now = nowDate.toISOString();
        if (!lastRun || !lastRun.value) {
            lastRun = {value: (new Date(nowDate.getTime() - 1*60*1000)).toISOString()};
        }

        var urlArgs = encodeToURLQuery({published_start : now});
        var incidents = fetchCommandIncidents(urlArgs);

        setLastRun({value: now});
        return JSON.stringify(incidents);
    };

    var reportAssets = function(uuid) {
        var endpt = uuid + '/assets';
        var response = sendRequest('GET', 'Assets', endpt);
        if (!response.assets || response.assets.length === 0) {
            return 'No assets'
        }
        return responseToEntry(response.assets, 'ReportAssets', 'Report Assets');
    };

    var reportIndicators = function(uuid) {
        var endpt = uuid + '/indicators';
        var response = sendRequest('GET', 'Reports', endpt);
        if (!response.indicators || response.indicators.length === 0) {
            return 'No indicators'
        }
        return responseToEntry(response.indicators, 'ReportIndicators', 'Report Indicators');
    };

    switch (command) {
        case 'test-module':
            sendRequest('GET', 'Reports', '', '');
            return 'ok';
        case 'fetch-incidents':
            return fetchIncidents();
        case 'icebrg-search-events':
            var response = sendRequest('POST', 'Search', undefined, args);
            delete response.aggregations;
            if (!args.query) {
                return 'No query given'
            }
            return responseToEntry(response, 'Events', 'Events');
        case 'icebrg-get-history':
            var response = sendRequest('GET', 'Search', 'history');
            for(i=0; i<response.history.length; i++) {
                response.history[i].UserId=response.user_id;
            }
            return responseToEntry(response.history, 'UserQueryHistory', 'History');
        case 'icebrg-saved-searches':
            var response = sendRequest('GET', 'Search', 'saved');
            if (response.saved_queries) {
                return 'No saved searches'
            }
            return responseToEntry(response, 'SavedSearches', 'Saved Searches');
        case 'icebrg-get-reports':
            var queryArgs = {};
            var argKeys = Object.keys(args);
            for(i=0; i<argKeys.length; i++) {
                queryArgs[argKeys[i]] = args[argKeys[i]];
            }
            var response = sendRequest('GET', 'Reports', undefined, encodeToURLQuery(queryArgs));
            for(i=0; i<response.reports.length; i++) {
                response.reports[i].publishes = easyDQ(response.reports[i], 'publishes', undefined, uppercaseKeys);
            }
            return responseToEntry(response.reports, 'Reports', 'Reports');
        case 'icebrg-get-report-indicators':
            return reportIndicators(args.report_uuid);
        case 'icebrg-get-report-assets':
            return reportAssets(args.report_uuid);
        default:
    }
  type: javascript
  commands:
  - name: icebrg-search-events
    arguments:
    - name: query
      required: true
      description: The query string or entity for which to search.
    - name: start_date
      description: The beginning of the temporal extent by which to restrict filter
        results, inclusive.
    - name: end_date
      description: The end of the temporal extent by which to restrict filter results,
        exclusive.
    - name: limit
      description: A limit on the number of events returned in filter results. Default
        is 100. Max is 10000
    - name: order_by
      description: The event property by which to order results. Default is timestamp.
    - name: order
      description: The order of results, either asc or desc. Default is desc.
    - name: customer_id
      description: The customer ID by which to restrict filter results. Default is
        user account.
    - name: history
      description: When true, save this query in user Query History and include up
        to the last 50 queries from users Query History. Default is false.
    - name: service_traffic
      description: When true, the service will include the service_traffic aggregation.
        Default is false.
    outputs:
    - contextPath: Icebrg.Events.QueryType
      description: Query type
    - contextPath: Icebrg.Events.Total
      description: Total events
    - contextPath: Icebrg.Events.OrderBy
      description: Key to order events by
    - contextPath: Icebrg.Events.Order
      description: Order of the events
    - contextPath: Icebrg.Events.Offset
      description: Events offset
    - contextPath: Icebrg.Events.History
      description: History of events
    - contextPath: Icebrg.Events.Limit
      description: Limit number of events to show
    description: Perform an ICEBRG datastore event search
  - name: icebrg-get-history
    arguments: []
    outputs:
    - contextPath: Icebrg.UserQueryHistory.Total
      description: Total user queries
    - contextPath: Icebrg.UserQueryHistory.Timestamp
      description: Timestamp of user query
    - contextPath: Icebrg.UserQueryHistory.Query
      description: Called query
    - contextPath: Icebrg.UserQueryHistory.QueryId
      description: ID of query
    - contextPath: Icebrg.UserQueryHistory.UserId
      description: User ID
    description: Gets history of the events
  - name: icebrg-saved-searches
    arguments: []
    outputs:
    - contextPath: Icebrg.SavedSearches.Tags
      description: Query tags
    - contextPath: Icebrg.SavedSearches.Description
      description: Query description
    - contextPath: Icebrg.SavedSearches.Title
      description: Query title
    - contextPath: Icebrg.SavedSearches.Timestamp
      description: Query timestamp
    - contextPath: Icebrg.SavedSearches.Query
      description: Called query
    - contextPath: Icebrg.SavedSearches.Id
      description: Query ID
    description: Gets user saved searches
  - name: icebrg-get-reports
    arguments:
    - name: limit
      description: The maximum number of records to return. The default is no limit.
    - name: offset
      description: The number of records to skip past. The default is none.
    - name: sort_by
      description: The field to sort by created, updated, or published. The default
        is unsorted.
    - name: sort_order
      description: The sort order asc or desc. The default is asc if sort_by is provided.
    - name: account_uuid
      description: UUID of account to filter by.
    - name: archived
      description: Archived status to filter by.
    - name: confidence
      description: Confidence to filter by (low, moderate, high).
    - name: risk
      description: Risk to filter by (low, moderate, high).
    - name: search
      description: Text string to search on title and summary.
    - name: status
      description: Status to filter by.
    - name: published_start
      description: Published start date to filter by (inclusive), RFC3339 format.
    - name: published_end
      description: Published end date to filter by (exclusive), RFC3339 format.
    outputs:
    - contextPath: Icebrg.Reports.Publishes.UserUuid
      description: User UUID that published the report
    - contextPath: Icebrg.Reports.Publishes.Published
      description: Timestamp of published report
    - contextPath: Icebrg.Reports.AssetCount
      description: Asset count of report
    - contextPath: Icebrg.Reports.IndicatorCount
      description: Indicator count of report
    - contextPath: Icebrg.Reports.Archived
      description: True if archived, else false
    - contextPath: Icebrg.Reports.Details
      description: Report details
    - contextPath: Icebrg.Reports.Summary
      description: Report summary
    - contextPath: Icebrg.Reports.Category
      description: Category of the report
    - contextPath: Icebrg.Reports.Confidence
      description: Confidence of report
    - contextPath: Icebrg.Reports.Risk
      description: Risk of report
    - contextPath: Icebrg.Reports.Title
      description: Report title
    - contextPath: Icebrg.Reports.Status
      description: Status of report
    - contextPath: Icebrg.Reports.AccountUuid
      description: Account UUID of report
    - contextPath: Icebrg.Reports.UpdatedUserUuid
      description: User UUID that updated the report
    - contextPath: Icebrg.Reports.CreatedUserUuid
      description: User UUID that created the report
    - contextPath: Icebrg.Reports.Updated
      description: Timestamp of report update
    - contextPath: Icebrg.Reports.Created
      description: Timestamp of report creation
    - contextPath: Icebrg.Reports.Uuid
      description: Report UUID
    description: Gets a list of reports
  - name: icebrg-get-report-indicators
    arguments:
    - name: report_uuid
      required: true
      description: Report UUID to get indicator of
    outputs:
    - contextPath: Icebrg.ReportIndicators.Type
      description: Type of indicator
    - contextPath: Icebrg.ReportIndicators.Indicators.Observable
      description: Observable of Indicator
    description: Gets indicators for a reports
  - name: icebrg-get-report-assets
    arguments:
    - name: report_uuid
      required: true
      description: Report UUID to get asset of
    outputs:
    - contextPath: Icebrg.ReportAssets.Asset
      description: Assets of Report UUID
    description: Gets impacted assets for a report
  isfetch: true
