category: Data Enrichment & Threat Intelligence
commonfields:
  id: iDefense
  version: -1
configuration:
- defaultvalue: https://api.intelgraph.idefense.com/
  display: URL
  name: url
  required: true
  type: 0
- defaultvalue: ""
  display: API Token
  name: api_token
  required: true
  type: 0
- defaultvalue: ""
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ""
  display: Use system proxy settings
  name: useproxy
  required: false
  type: 8
description: Accenture Security
display: iDefense
image: data:image/png;base64,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
name: iDefense
script:
  commands:
  - arguments:
    - default: true
      description: IP to check
      name: ip
      required: true
    description: Check IP reputation
    name: ip
    outputs:
    - contextPath: IP.Address
      description: Bad IP Address found
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
    - contextPath: DBotScore.Type
      description: The indicator type.
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
    - contextPath: DBotScore.Score
      description: The actual score.
  - arguments:
    - default: true
      description: Domain to check
      name: domain
      required: true
    description: Check domain reputation
    name: domain
    outputs:
    - contextPath: Domain.Name
      description: Bad domain found
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
    - contextPath: DBotScore.Type
      description: The indicator type.
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
    - contextPath: DBotScore.Score
      description: The actual score.
  - arguments:
    - default: true
      description: The URL to check (must start with "http://").
      name: url
      required: true
    description: Check URL reputation
    name: url
    outputs:
    - contextPath: URL.Data
      description: Bad URLs found
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
    - contextPath: DBotScore.Type
      description: The indicator type.
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
    - contextPath: DBotScore.Score
      description: The actual score.
  - arguments:
    - default: true
      defaultValue: "300"
      description: Maximum amount of results
      name: max_result
    description: Get threats from iDefense database. Returns all records of ip/url/domain
    name: idefense-general
    outputs:
    - contextPath: IP.Address
      description: Bad IP Address found
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the reason for the vendor to make the decision
    - contextPath: Domain.Name
      description: Bad domain found
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    - contextPath: URL.Data
      description: Bad URLs found
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
    - contextPath: DBotScore.Type
      description: The indicator type.
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
    - contextPath: DBotScore.Score
      description: The actual score.
  - arguments:
    - default: true
      description: Unique User ID
      name: uuid
      required: true
    description: Get specific indicator reputation
    name: uuid
    outputs:
    - contextPath: IP.Address
      description: Bad IP Address found
    - contextPath: IP.Malicious.Vendor
      description: For malicious IPs, the vendor that made the decision
    - contextPath: IP.Malicious.Description
      description: For malicious IPs, the reason for the vendor to make the decision
    - contextPath: Domain.Name
      description: Bad domain found
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: Domain.Malicious.Description
      description: For malicious domains, the reason for the vendor to make the decision
    - contextPath: URL.Data
      description: Bad URLs found
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
    - contextPath: DBotScore.Type
      description: The indicator type.
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
    - contextPath: DBotScore.Score
      description: The actual score.
  runonce: false
  script: |-
    // handle '/' at the end of the url
    var base_url = params.url.slice(0, params.url.length - params.url.match('/*$')[0].length) + '/rest/';

    function sendRequest(method, url_suffix, headers, body) {
        headers = headers || {};
        body = body || {};

        // add default headers
        if (!("Accept" in headers)) {
            headers["Accept"] = ['application/json'];
        }
        if (!("Content-Type" in headers)) {
            headers['Content-Type'] = ['application/json'];
        }
        headers['Auth-Token'] = [params.api_token];

        var res = http(
            base_url + url_suffix,
            {
                Method: method,
                Headers: headers,
                Body: JSON.stringify(body),
            },
            params.insecure,
            params.useproxy
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }

        return res.Body.length !== 0 ? JSON.parse(res.Body) : {};
    }

    function calculate_dbot_score(severity) {
        // Calculate score based on severity
        // Dbot Score   | severity
        //  0           | 0
        //  1           | 1,2
        //  2           | 3,4
        //  3           | 5,6,7
        var dbot_score = 0;
        if (severity > 4) {
            dbot_score = 3;
        } else if (severity > 2) {
            dbot_score = 2;
        } else if (severity > 0) {
            dbot_score = 1;
        } else {
            dbot_score = 0;
        }

        return dbot_score;
    }

    function get_full_data(cmd_url, query, result_threshold) {
        result_threshold = result_threshold || 300;
        query = query || {};

        var results = [];
        var res;

        query.page = 1;
        do {
            res = sendRequest('GET', cmd_url + encodeToURLQuery(query));
            if (res.total_size === 0) {
                break;
            }
            results = results.concat(res.results);
            ++query.page;
        } while ((res.more) && (results.length < result_threshold));

        return results;
    }

    function check_threats(type, value, uniq_field, results) {
        if (!results) {
            var cmd_url = 'threatindicator/v0/' + type.toLowerCase();
            var query = {'key.values' : value};
            results = get_full_data(cmd_url, query);

            if (results.length === 0) {
                return {results:[], md : [], context: {}};
            }
        }

        var dbot_context = [];
        var result_context = [];
        var md = [];
        for (var i in results) {
            var r = results[i];
            dbot_score = calculate_dbot_score(r.severity);

            md.push({
                Name : r.key,
                'Dbot Reputation' : scoreToReputation(dbot_score),
                confidence : r.confidence,
                'Threat Types' : r.threat_types
            });

            dbot_context.push({
                Indicator : r.key,
                Type : type.toLowerCase(),
                Vendor : 'iDefense',
                Score : dbot_score
            });

            if (dbot_score >= 2) {
                var r_context = {
                    Malicious : {
                        Vendor : 'iDefense',
                        Description : 'last seen as ' + r.last_seen_as
                    }
                };
                r_context[uniq_field] = r.key;
                result_context.push(r_context);
            }
        }

        var context_type = type + '(val.' + uniq_field + ' && val.' + uniq_field + ' == obj.' + uniq_field + ')';
        var context = {};
        if (result_context.length > 0) {
            context[context_type] = result_context;
        }

        return {
            results : results,
            md : md,
            context : context,
            scores : dbot_context

        };
    }
    function sort_threats(results) {
        var domains = [], urls = [], ips = [], others = [];

        for (var i in results) {
            switch (results[i].type) {
            case 'domain':
                domains.push(results[i]);
                break;
            case 'ip':
                ips.push(results[i]);
                break;
            case 'url':
                urls.push(results[i]);
                break;
            default:
                others.push(results[i]);
            }
        }

        var domain_threats = check_threats('Domain', undefined, 'Name', domains),
            ip_threats = check_threats('IP', undefined, 'Address', ips),
            url_threats = check_threats('URL', undefined, 'Data', urls);

        var merged_md = domain_threats.md.concat(ip_threats.md).concat(url_threats.md);
        var merged_scores = domain_threats.scores.concat(ip_threats.scores).concat(url_threats.scores);

        return {
            Type : entryTypes.note,
            Contents : results,
            ContentsFormat : formats.json,
            HumanReadable : tableToMarkdown('iDefense Reputations', merged_md),
            EntryContext : mergeForeignObjects([domain_threats.context, ip_threats.context, url_threats.context, {DBotScore : merged_scores}])
        };

    }

    function get_threats(max_results) {
        var cmd_url = 'threatindicator/v0/';
        var results = get_full_data(cmd_url, {}, max_results);

        return sort_threats(results);
    }

    function get_domain(domain) {
        var threats_info = check_threats('Domain', domain, 'Name');
        if (threats_info.results.length === 0) {
            return 'No result was found.';
        }

        return {
            Type : entryTypes.note,
            Contents : threats_info.results,
            ContentsFormat : formats.json,
            HumanReadable : tableToMarkdown('iDefense Domain Reputation', threats_info.md),
            EntryContext : mergeForeignObjects([threats_info.context, {DBotScore : threats_info.scores}])
        };
    }

    function get_ip(ip) {
        if (!isValidIP(ip)) {
            return {Type: entryTypes.error, Contents: 'IP - ' + ip + ' is not valid IP', ContentsFormat: formats.text};
        }

        var threats_info = check_threats('IP', ip, 'Address');
        if (threats_info.results.length === 0) {
            return 'No result was found.';
        }

        return {
            Type : entryTypes.note,
            Contents : threats_info.results,
            ContentsFormat : formats.json,
            HumanReadable : tableToMarkdown('iDefense IP Reputation', threats_info.md),
            EntryContext : mergeForeignObjects([threats_info.context, {DBotScore : threats_info.scores}])

        };
    }

    function get_url(url) {
        var threats_info = check_threats('URL', url, 'Data');
        if (threats_info.results.length === 0) {
            return 'No result was found.';
        }

        return {
            Type : entryTypes.note,
            Contents : threats_info.results,
            ContentsFormat : formats.json,
            HumanReadable : tableToMarkdown('iDefense URL Reputation', threats_info.md),
            EntryContext : mergeForeignObjects([threats_info.context, {DBotScore : threats_info.scores}])

        };
    }

    function get_uuid(uuid) {
        var cmd_url = 'threatindicator/v0/' + uuid;
        var res = sendRequest('GET', cmd_url);

        return sort_threats([res]);
    }

    // The command input arg holds the command sent from the user.
    logDebug('entering with command: ' + command);
    switch (command) {
        case 'idefense-general':
            // still having issues with this command.
            return get_threats(args.max_result);
        case 'domain':
            return get_domain(args.domain);
        case 'ip':
            return get_ip(args.ip);
        case 'url':
            return get_url(args.url);
        case 'uuid':
            // still having issues with this command.
            return get_uuid(args.uuid);
        // This is the call made when pressing the integration test button.
        case 'test-module':
            //check api_token is valid
            get_threats(1);
            return 'ok';
        default:
            break;
    }
  type: javascript
system: true
