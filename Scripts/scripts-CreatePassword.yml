commonfields:
  id: 1ca18a3e-439b-4763-84be-aae9ab162c4c
  version: 110
name: GeneratePassword
script: |+
  dArgs = {
      'default_sane': args.default_sane = (args.default_sane == 'true'),
      'debug': args.debug = (args.debug == 'true'),
      'max_lcase': parseInt(args.max_lcase),
      'min_lcase': parseInt(args.min_lcase),
      'max_ucase': parseInt(args.max_ucase),
      'min_ucase': parseInt(args.min_lcase),
      'max_digits': parseInt(args.max_digits),
      'min_digits': parseInt(args.min_digits),
      'max_symbols': parseInt(args.max_symbols),
      'min_symbols': parseInt(args.min_symbols)
  };

  // randomize our selected charaters
  function randomsort(a, b) {
      return Math.random() > 0.5 ? -1 : 1;
  }

  function printCharValues(pw) {
      var s = [];
      for (i = 0; i < pw.length; i++) {
          s.push(pw.charCodeAt(i));
      }
      log("Ascii for password = " + s.toString());
  }

  if(args.debug) {
     log(JSON.stringify(dArgs));
  }

  // Define the characters of our classes
  var lcase   = "abcdefghijklmnopqrstuvwxyz";
  var ucase   = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  var n       = "0123456789";
  var s       = "!@#$%^&*()[]+:\"?_><=';/-.,\\|";

  // if the user didn't explicitly set default_sane to false,
  // then assume defaults.
  if(args.default_sane) {
      if(args.debug) { log("Defaulting to sane values of min: 5, max: 10 with all classes enabled. Generating password."); }
      dArgs.mix_lcase = dArgs.min_ucase = dArgs.min_digits = dArgs.min_symbols = 5;
      dArgs.max_lcase = dArgs.max_ucase = dArgs.max_digits = dArgs.max_symbols = 10;
  }

  // randomize the amount of characters we get as per parameters
  var numu = dArgs.max_ucase   - dArgs.min_ucase   >= 0 ? Math.floor(Math.random() * (dArgs.max_ucase   - dArgs.min_ucase   + 1)) + dArgs.min_ucase   : 0;
  var numl = dArgs.max_lcase   - dArgs.min_lcase   >= 0 ? Math.floor(Math.random() * (dArgs.max_lcase   - dArgs.min_lcase   + 1)) + dArgs.min_lcase   : 0;
  var numn = dArgs.max_digits  - dArgs.min_digits  >= 0 ? Math.floor(Math.random() * (dArgs.max_digits  - dArgs.min_digits  + 1)) + dArgs.min_digits  : 0;
  var nums = dArgs.max_symbols - dArgs.min_symbols >= 0 ? Math.floor(Math.random() * (dArgs.max_symbols - dArgs.min_symbols + 1)) + dArgs.min_symbols : 0;

  if(numu + numl + numn + nums === 0) {
     return  { ContentsFormat: formats.text, Type:entryTypes.error, Contents: 'error: insane password. No character length.'};
  }

  // start with a blank password.
  var pw = "";

  // iterate through each character class and add
  for (var i = 0; i < numu; i++) {
     pw += ucase[Math.floor(Math.random() * ucase.length)];
  }
  for (var i = 0; i < numl; i++) {
     pw += lcase[Math.floor(Math.random() * lcase.length)];
  }
  for (var i = 0; i < numn; i++) {
     pw += n[Math.floor(Math.random() * n.length)];
  }
  for (var i = 0; i < nums; i++) {
     pw += s[Math.floor(Math.random() * s.length)];
  }

  // randomize our new password string
  var rpw = (pw.split('').sort(randomsort)).join('');

  if(args.debug) {
      printCharValues(rpw);
  }
  return {
          Type: entryTypes.note,
          Contents: {"NEW_PASSWORD": rpw},          // used by raw_contents = true
          ContentsFormat: formats.json,             // defines the source format
          HumanReadable: tableToMarkdown('Newly Generated Password', {"password": rpw}),
          EntryContext: {"NEW_PASSWORD": rpw}       // same as setcontext
  };

type: javascript
tags:
- Utility
comment: "This function generates a password and allows various parameters to customize
  the properties of the password depending on the use case (e.g. password complexity
  requirements).  The default behavior is to generate a password of  *random length*
  including all four character classes (upper, lower, digits, symbols) with at least
  five and at most ten characters per class. \n\nYou may override the default configuration
  by specifying the \"default_sane\" to false and then customizing the other parameters.
  Note that if you do not specify \"default_sane\" as false, then all other parameters
  will be ignored.\n\nThe min_* values all default to 0. This means that if the command
  is executed in this way:\n!GeneratePassword default_sane=false max_lcase=10\nIt
  is possible that a password of length zero could be generated. It is therefore recommended
  to always include a min_* parameter that matches. \n\nThe debug parameter will print
  certain properties of the command into the WarRoom for easy diagnostics."
enabled: true
args:
- name: min_lcase
  required: true
  description: Minimum number of lower case characters to include in password.
  defaultValue: "0"
- name: max_lcase
  required: true
  description: Maximum number of lower case characters to include in password.
  defaultValue: "10"
- name: min_ucase
  required: true
  description: Minimum number of upper case characters to include in password.
  defaultValue: "0"
- name: max_ucase
  required: true
  description: Maximum number of upper case characters to include in password.
  defaultValue: "10"
- name: min_digits
  required: true
  description: Minimum number of digits to include in password.
  defaultValue: "0"
- name: max_digits
  required: true
  description: Maximum number of digits to include in password.
  defaultValue: "10"
- name: min_symbols
  required: true
  description: Minimum number of symbols to include in password.
  defaultValue: "0"
- name: max_symbols
  required: true
  description: Maximum number of symbols to include in password.
  defaultValue: "10"
- name: default_sane
  auto: PREDEFINED
  predefined:
  - "true"
  - "false"
  description: If this is not set to 'false', then all other parameters are ignored
    and min:5 and max:10 are set for all character classes.
  defaultValue: "true"
- name: debug
  default: true
  auto: PREDEFINED
  predefined:
  - "true"
  - "false"
  description: Enable to see various values as they pass through the function.
  defaultValue: "false"
outputs:
- contextPath: NEW_PASSWORD
  description: The new password generated for the user.
scripttarget: 0
