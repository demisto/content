commonfields:
  id: IsEmailAddressInternal
  version: -1
name: IsEmailAddressInternal
script: |-
  import re
  from distutils.util import strtobool

  emails = [x.lower() for x in argToList(demisto.get(demisto.args(),'email'))]
  domains = [x.lower() for x in argToList(demisto.get(demisto.args(),'domain'))]
  include_subdomains = strtobool(demisto.getArg('include_subdomains') or 'no')

  results = []

  for email in emails:
      parts = email.split('@',1)
      network_type = "Unknown"
      if len(parts) > 1:
          if parts[1] in domains or include_subdomains and re.match("^(.*\\.)?({})".format('|'.join([re.escape(d) for d in domains])), parts[1]):
              network_type = "Internal"
          else:
              network_type = "External"

          email_dict = {
              "Address" : email,
              "Domain" : parts[1],
              "Username": parts[0],
              "NetworkType" : network_type
          }

          results.append(email_dict)

      else:
          return_error('Email address ' + email + ' is not valid')

  ec = {
      'Account.Email(val.Address==obj.Address)': results
  }

  human_readable = tableToMarkdown("results:",results,["Address","NetworkType"])
  return_outputs(readable_output = human_readable, outputs = ec, raw_response = results)
type: python
tags:
- email
comment: Checks if the email address is part of the internal domains
enabled: true
args:
- name: email
  required: true
  default: true
  description: The email address to check.
  isArray: true
- name: domain
  description: A CSV list of internal domains to check.
  isArray: true
- name: include_subdomains
  auto: PREDEFINED
  predefined:
  - "yes"
  - "no"
  description: Whether to include subdomains of the domain list. Default is "no".
  defaultValue: "no"
outputs:
- contextPath: Account.Email.Address
  description: The full email address for the account.
  type: string
- contextPath: Account.Email.Username
  description: The username associated with the email address.
  type: string
- contextPath: Account.Email.Domain
  description: The email account domain.
  type: string
- contextPath: Account.Email.NetworkType
  description: The email account NetworkType ("Internal" or "External").
  type: string
scripttarget: 0
runonce: false
releaseNotes: "Added the ability to check a list of email addresses."
