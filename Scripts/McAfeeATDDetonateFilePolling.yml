commonfields:
  id: McAfeeATDDetonateFilePolling
  version: -1
name: McAfeeATDDetonateFilePolling
script: |-
  Ids = demisto.args().get('Ids')

  failedTasks = 0
  successTasks = 0
  totalTasks = Ids.len
  TasksOutput = []
  result = []

  for i in range(0, totalScans):
      taskId = Ids[i];
      #check from context if that scan is already done or not
      taskStatus = dq(invContext, 'ATD.Task(val.Id === ' + taskId + ').status');
      if (taskStatus == 'completed'):
          successTasks += 1
          continue
      elif (taskStatus == 'cancelled' or taskStatus == 'invalid'):
          failedTasks += 1
          continue
      else:
          # Calling a command - returns a list of one or more entries
          res = demisto.executeCommand("atd-check-status", { 'taskId': taskId })
          taskStatus = dq(invContext, 'ATD.Task(val.Id === ' + taskId + ').status')
          scansOutput.append(res.EntryContext['ATD.Task(val.Id === obj.Id)'])
          result.append( { "Type" : entryTypes["note"],
              "ContentsFormat" : formats["table"], "Contents" : scansOutput } )

  gloablStatus = 'Pending'
  if (successTasks == totalTasks):
      gloablStatus = 'Success'
  elif (successTasks + failedTasks == totalTasks):
      gloablStatus = 'Fail'


  demisto.results(globalstatus)
  #demisto.results(res)
type: python
tags: []
enabled: true
args:
- name: Ids
  required: true
  description: Ids of the detonation tasks
  isArray: true
outputs:
- contextPath: McAfeeATDDetonateFilePolling
  description: Success,Fail,Pending
scripttarget: 0
runonce: false