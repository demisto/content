description: |-
  This server received a Remote Desktop Protocol (RDP) connection request that is consistent with a known vulnerability, also known as BlueKeep, in older versions of Microsoft Windows. This vulnerability allows an unauthenticated attacker to remotely run arbitrary code on an RDP server. The attacker can then tamper with data or install malware that could propagate to other Windows devices across the network. Investigate to determine if this server is hosting a version affected by CVE-2019-0708: Windows 7, Windows XP, Windows Vista, Windows Server 2003, and Windows Server 2008.

  MITIGATION OPTIONS
  - Disable Remote Desktop Services if they are not required
  - Implement Network Level Authentication (NLA) on systems running supported versions of Windows 7, Windows Server 2008, and Windows Server 2008 R2
  - Configure firewalls to block traffic on TCP port 3389
id: ExtraHop - CVE-2019-0708 (BlueKeep)
inputs:
- description: |-
    Enable the "Block IP" capability automatically (can be either "True" or "False").
    The "Block IP" sub-playbook will block the offender IP address in the relevant integrations.
  key: AutoBlockIp
  required: false
  value:
    simple: "False"
name: ExtraHop - CVE-2019-0708 (BlueKeep)
outputs:
- contextPath: CVE
  description: Details on the CVE.
  type: unknown
- contextPath: ExtraHop.Device
  description: 'Details on the host and any peer devices found. '
  type: unknown
- contextPath: ExtraHop.ActivityMap
  description: The link to a visual activity map in ExtraHop.
  type: string
- contextPath: ExtraHop.Record.Source
  description: Associated transaction records from ExtraHop.
  type: unknown
starttaskid: "0"
system: true
tasks:
  "0":
    id: "0"
    ignoreworker: false
    nexttasks:
      '#none#':
      - "15"
    note: false
    separatecontext: false
    task:
      brand: ""
      id: 44709a0e-a454-49dc-86dc-07bc12acf25d
      iscommand: false
      name: ""
      version: -1
    taskid: 44709a0e-a454-49dc-86dc-07bc12acf25d
    timertriggers: []
    type: start
    view: |-
      {
        "position": {
          "x": -10,
          "y": -460
        }
      }
  "2":
    id: "2"
    ignoreworker: false
    note: false
    separatecontext: false
    task:
      brand: ""
      id: afa75cf0-4935-4b71-8816-585d782d18a8
      iscommand: false
      name: Done
      type: title
      version: -1
    taskid: afa75cf0-4935-4b71-8816-585d782d18a8
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": -10,
          "y": 790
        }
      }
  "15":
    id: "15"
    ignoreworker: false
    nexttasks:
      '#default#':
      - "2"
      "yes":
      - "16"
    note: false
    scriptarguments:
      value:
        complex:
          filters:
          - - left:
                iscontext: true
                value:
                  simple: brand
              operator: isEqualString
              right:
                value:
                  simple: ExtraHop v2
          - - left:
                iscontext: true
                value:
                  simple: state
              operator: isEqualString
              right:
                value:
                  simple: active
          root: modules
    separatecontext: false
    task:
      brand: ""
      description: Checks if there is an active instance of the ExtraHop Reveal(x)
        integration enabled.
      id: 2700d930-33f2-439b-8782-cdeb704eceed
      iscommand: false
      name: Is ExtraHop Reveal(x) enabled?
      scriptName: Exists
      type: condition
      version: -1
    taskid: 2700d930-33f2-439b-8782-cdeb704eceed
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": -10,
          "y": -320
        }
      }
  "16":
    continueonerror: true
    id: "16"
    ignoreworker: false
    nexttasks:
      '#none#':
      - "17"
      - "24"
    note: false
    scriptarguments:
      cveId:
        simple: CVE-2019-0708
    separatecontext: false
    task:
      brand: CVE Search
      description: Search CVE by ID.
      id: 1b3cd97e-fed5-406e-8574-61224e3df17b
      iscommand: true
      name: Run CVE search for BlueKeep vulnerability
      script: CVE Search|||cve-search
      type: regular
      version: -1
    taskid: 1b3cd97e-fed5-406e-8574-61224e3df17b
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 210,
          "y": -120
        }
      }
  "17":
    id: "17"
    ignoreworker: false
    loop:
      exitCondition: ""
      iscommand: false
      wait: 1
    nexttasks:
      '#none#':
      - "21"
    note: false
    scriptarguments:
      from_time:
        complex:
          accessor: occurred
          root: incident
          transformers:
          - operator: toUnix
          - args:
              by:
                value:
                  simple: "1800"
            operator: subtraction
      ip:
        complex:
          accessor: participants
          root: incident
          transformers:
          - args:
              equalTo:
                value:
                  simple: victim
              field:
                value:
                  simple: role
              getField:
                value:
                  simple: ipaddress
            operator: WhereFieldEquals
      mac:
        complex:
          accessor: participants
          root: incident
          transformers:
          - args:
              equalTo:
                value:
                  simple: victim
              field:
                value:
                  simple: role
              getField:
                value:
                  simple: macaddress
            operator: WhereFieldEquals
      name:
        complex:
          accessor: participants
          root: incident
          transformers:
          - args:
              equalTo:
                value:
                  simple: victim
              field:
                value:
                  simple: role
              getField:
                value:
                  simple: dnsname
            operator: WhereFieldEquals
      until_time:
        complex:
          accessor: occurred
          root: incident
          transformers:
          - operator: toUnix
          - args:
              by:
                value:
                  simple: "1800"
            operator: addition
    separatecontext: true
    task:
      brand: ""
      description: Given a host, the playbook will retrieve the peer network devices
        that communicated with that host in a given time range.  In addition to a
        list of peers and protocols (sorted by bytes) the playbook returns a link
        to the ExtraHop Live Activity Map to visualize the peer relationships.
      id: 237c1ad2-3e95-4c44-8442-6c5d70ba2e7c
      iscommand: false
      name: ExtraHop - Get Peers by Host
      playbookName: ExtraHop - Get Peers by Host
      type: playbook
      version: -1
    taskid: 237c1ad2-3e95-4c44-8442-6c5d70ba2e7c
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": 210,
          "y": 50
        }
      }
  "19":
    id: "19"
    ignoreworker: false
    message:
      bcc: null
      body:
        complex:
          accessor: participants
          root: incident
          transformers:
          - args:
              equalTo:
                value:
                  simple: offender
              field:
                value:
                  simple: role
              getField:
                value:
                  simple: ipaddress
            operator: WhereFieldEquals
      cc: null
      format: ""
      methods:
      - email
      replyOptions:
      - "Yes"
      - "No"
      subject:
        simple: CVE-2019-0708 RDP Exploit Attempt - Block Offender IP?
      timings:
        completeafterreplies: 1
        retriescount: 2
        retriesinterval: 360
      to:
        simple: ExtraHop
    nexttasks:
      '#default#':
      - "20"
      "Yes":
      - "23"
    note: false
    separatecontext: false
    task:
      brand: ""
      description: Ask ExtraHop analysts whether or not to automatically block the
        offender IP address.
      id: 0fa6c81c-87a3-476f-80d7-dc4171df2ac3
      iscommand: false
      name: Email team to block offender IP address
      type: condition
      version: -1
    taskid: 0fa6c81c-87a3-476f-80d7-dc4171df2ac3
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 620,
          "y": 410
        }
      }
  "20":
    id: "20"
    ignoreworker: false
    nexttasks:
      '#none#':
      - "2"
    note: false
    separatecontext: false
    task:
      brand: ""
      description: |-
        Investigate to determine if the victim server is hosting a version affected by CVE-2019-0708: Windows 7, Windows XP, Windows Vista, Windows Server 2003, and Windows Server 2008.

        Mitigation Options
        - Disable Remote Desktop Services if they are not required
        - Implement Network Level Authentication (NLA) on systems running supported versions of Windows 7, Windows Server 2008, and Windows Server 2008 R2
        - Configure firewalls to block traffic on TCP port 3389
      id: 0539b3a2-867d-4d0f-8074-028dfb73c781
      iscommand: false
      name: Guided investigation steps and mitigation options
      type: regular
      version: -1
    taskid: 0539b3a2-867d-4d0f-8074-028dfb73c781
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 210,
          "y": 590
        }
      }
  "21":
    continueonerror: true
    id: "21"
    ignoreworker: false
    nexttasks:
      '#none#':
      - "22"
    note: false
    scriptarguments:
      field1:
        simple: clientAddr
      field2:
        simple: serverAddr
      limit: {}
      match_type: {}
      offset: {}
      operator1:
        simple: =
      operator2:
        simple: =
      query_from:
        complex:
          accessor: occurred
          root: incident
          transformers:
          - operator: toUnix
          - args:
              by:
                value:
                  simple: "1000"
            operator: multiply
      query_until:
        complex:
          accessor: occurred
          root: incident
          transformers:
          - operator: toUnix
          - args:
              by:
                value:
                  simple: "2"
            operator: addition
          - args:
              by:
                value:
                  simple: "1000"
            operator: multiply
      types:
        simple: rdp_close,rdp_tick
      value1:
        complex:
          accessor: participants
          root: incident
          transformers:
          - args:
              equalTo:
                value:
                  simple: offender
              field:
                value:
                  simple: role
              getField:
                value:
                  simple: ipaddress
            operator: WhereFieldEquals
      value2:
        complex:
          accessor: participants
          root: incident
          transformers:
          - args:
              equalTo:
                value:
                  simple: victim
              field:
                value:
                  simple: role
              getField:
                value:
                  simple: ipaddress
            operator: WhereFieldEquals
    separatecontext: false
    task:
      brand: ""
      description: Query records associated with this detection from ExtraHop.
      id: f123a474-b51e-4bc5-830f-b6308fc70937
      iscommand: true
      name: Get associated transaction records from ExtraHop Reveal(x)
      script: '|||extrahop-query-records'
      type: regular
      version: -1
    taskid: f123a474-b51e-4bc5-830f-b6308fc70937
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 210,
          "y": 230
        }
      }
  "22":
    continueonerror: true
    id: "22"
    ignoreworker: false
    nexttasks:
      '#none#':
      - "20"
    note: false
    scriptarguments:
      bpf: {}
      ip1:
        complex:
          accessor: participants
          root: incident
          transformers:
          - args:
              equalTo:
                value:
                  simple: offender
              field:
                value:
                  simple: role
              getField:
                value:
                  simple: ipaddress
            operator: WhereFieldEquals
      ip2:
        complex:
          accessor: participants
          root: incident
          transformers:
          - args:
              equalTo:
                value:
                  simple: victim
              field:
                value:
                  simple: role
              getField:
                value:
                  simple: ipaddress
            operator: WhereFieldEquals
      limit_bytes: {}
      limit_search_duration: {}
      output: {}
      port1: {}
      port2:
        simple: "3389"
      query_from:
        complex:
          accessor: occurred
          root: incident
          transformers:
          - operator: toUnix
          - args:
              by:
                value:
                  simple: "1000"
            operator: multiply
      query_until:
        complex:
          accessor: occurred
          root: incident
          transformers:
          - operator: toUnix
          - args:
              by:
                value:
                  simple: "2"
            operator: addition
          - args:
              by:
                value:
                  simple: "1000"
            operator: multiply
    separatecontext: false
    task:
      brand: ""
      description: Search for the specific packets associated with this detection
        in ExtraHop and return the pcap file.
      id: 6b73a498-5e96-4479-86ec-7a09799e5892
      iscommand: true
      name: Get associated PCAP file from ExtraHop Reveal(x)
      script: '|||extrahop-search-packets'
      type: regular
      version: -1
    taskid: 6b73a498-5e96-4479-86ec-7a09799e5892
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 210,
          "y": 410
        }
      }
  "23":
    id: "23"
    ignoreworker: false
    loop:
      exitCondition: ""
      iscommand: false
      wait: 1
    nexttasks:
      '#none#':
      - "2"
    note: false
    scriptarguments:
      IP:
        complex:
          accessor: participants
          root: incident
          transformers:
          - args:
              equalTo:
                value:
                  simple: offender
              field:
                value:
                  simple: role
              getField:
                value:
                  simple: ipaddress
            operator: WhereFieldEquals
      IPBlacklistMiner: {}
    separatecontext: true
    task:
      brand: ""
      description: |-
        This playbook blocks malicious IPs using all integrations that you have enabled.

        Supported integrations for this playbook:
        * Check Point Firewall
        * Palo Alto Networks Minemeld
        * Palo Alto Networks PAN-OS
        * Zscaler
      id: 5892b97f-fcb0-48ef-843a-dfbbf0a5beb8
      iscommand: false
      name: Block IP - Generic v2
      playbookName: Block IP - Generic v2
      type: playbook
      version: -1
    taskid: 5892b97f-fcb0-48ef-843a-dfbbf0a5beb8
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": 840,
          "y": 590
        }
      }
  "24":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: inputs.AutoBlockIp
          operator: isEqualString
          right:
            value:
              simple: "True"
      label: "yes"
    id: "24"
    ignoreworker: false
    nexttasks:
      '#default#':
      - "19"
      "yes":
      - "23"
    note: false
    separatecontext: false
    task:
      brand: ""
      description: Check the playbook inputs to see if automatically blocking the
        offender IP address is desired.
      id: b400891d-eb98-40b6-898d-89e7d4a32e38
      iscommand: false
      name: Automatically block the offender IP address?
      type: condition
      version: -1
    taskid: b400891d-eb98-40b6-898d-89e7d4a32e38
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 620,
          "y": 50
        }
      }
version: -1
view: |-
  {
    "linkLabelsPosition": {
      "15_2_#default#": 0.12,
      "19_20_#default#": 0.33,
      "19_23_Yes": 0.57,
      "24_19_#default#": 0.55
    },
    "paper": {
      "dimensions": {
        "height": 1315,
        "width": 1230,
        "x": -10,
        "y": -460
      }
    }
  }
