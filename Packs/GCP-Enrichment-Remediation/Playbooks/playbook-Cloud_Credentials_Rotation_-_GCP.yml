id: Cloud Credentials Rotation - GCP
version: -1
name: Cloud Credentials Rotation - GCP
description: |-
  ## **GCP Credentials Rotation Playbook**

  ### **IAM Remediation**
  For compromised service accounts:
  - **Access Key Disabling**: Immediately disable the compromised service account access key.

  - **New Key Generation**: After ensuring the old key is disabled, generate a new access key.

  ### **GSuite Admin Remediation**
  Admin accounts are crucial:
  - **Reset Password**: Resets the user password to halt any unauthorized access.

  - **Revoke Access Token**: Revoke any suspicious or unauthorized access tokens.

  - **Combo Action**: Both resetting the password and revoking access tokens ensure complete safety.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 0a716f5d-7775-4a3c-8439-27648ac26a42
    type: start
    task:
      id: 0a716f5d-7775-4a3c-8439-27648ac26a42
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "28"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1440,
          "y": -40
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 8863dcc3-e56f-45cc-8bcc-feb76e84f073
    type: regular
    task:
      id: 8863dcc3-e56f-45cc-8bcc-feb76e84f073
      version: -1
      name: List zone related instances
      description: Retrieves the list of instances contained within the specified zone.
      script: '|||gcp-compute-list-instances'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    scriptarguments:
      zone:
        complex:
          root: inputs.zone
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 890,
          "y": 420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 415cb3b1-b9d7-4ed9-8ede-1a2ba3431ca7
    type: regular
    task:
      id: 415cb3b1-b9d7-4ed9-8ede-1a2ba3431ca7
      version: -1
      name: Set possible compromised instances
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      key:
        simple: possibleCompromisedInstances
      value:
        complex:
          root: GoogleCloudCompute.Instances
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: GoogleCloudCompute.Instances.serviceAccounts.email
                iscontext: true
              right:
                value:
                  simple: inputs.serviceAccountEmail
                iscontext: true
              ignorecase: true
          accessor: name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 890,
          "y": 590
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: 91c0e614-73fc-4d93-8481-8a4ccdd59a5f
    type: regular
    task:
      id: 91c0e614-73fc-4d93-8481-8a4ccdd59a5f
      version: -1
      name: Disable the SA access key
      description: Disables a service account key.
      script: '|||gcp-iam-service-account-key-disable'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "24"
    scriptarguments:
      key_name:
        complex:
          root: GCPIAM.ServiceAccountKey
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: GCPIAM.ServiceAccountKey.keyType
                iscontext: true
              right:
                value:
                  simple: USER_MANAGED
              ignorecase: true
          accessor: name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 890,
          "y": 1220
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: d638e4a7-a05f-4fdd-8025-9717b7dcfc43
    type: title
    task:
      id: d638e4a7-a05f-4fdd-8025-9717b7dcfc43
      version: -1
      name: GCP IAM
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "27"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 890,
          "y": 760
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: e8d420c2-7c2c-4a4e-8f4e-3d052722cd22
    type: title
    task:
      id: e8d420c2-7c2c-4a4e-8f4e-3d052722cd22
      version: -1
      name: GSuite Admin
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "14"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2050,
          "y": 285
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: e3c38ced-f437-4e95-8e1a-ac32309df9f6
    type: regular
    task:
      id: e3c38ced-f437-4e95-8e1a-ac32309df9f6
      version: -1
      name: Revoke access token
      description: Delete all access tokens issued by a user for an application.
      script: GSuiteAdmin|||gsuite-token-revoke
      type: regular
      iscommand: true
      brand: GSuiteAdmin
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      client_id:
        complex:
          root: inputs.clientID
      user_key:
        complex:
          root: inputs.userID
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2480,
          "y": 730
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: c9c9bd12-671e-420e-8281-3440f5f6d731
    type: regular
    task:
      id: c9c9bd12-671e-420e-8281-3440f5f6d731
      version: -1
      name: Reset password
      description: Updates a user.
      script: '|||gsuite-user-update'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      password:
        complex:
          root: NEW_PASSWORD
      user_key:
        complex:
          root: inputs.userID
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2050,
          "y": 890
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 9fe550ee-a468-4bc7-833a-17e3c15a8186
    type: condition
    task:
      id: 9fe550ee-a468-4bc7-833a-17e3c15a8186
      version: -1
      name: Check remediation type
      description: Checks the remediation type provided by the user.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      ALL:
      - "15"
      Reset Password:
      - "26"
      Revoke Access Key:
      - "11"
    separatecontext: false
    conditions:
    - label: Revoke Access Key
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.GSuiteRemediationType
            iscontext: true
          right:
            value:
              simple: Revoke
          ignorecase: true
    - label: Reset Password
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.GSuiteRemediationType
            iscontext: true
          right:
            value:
              simple: Reset
          ignorecase: true
    - label: ALL
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.GSuiteRemediationType
            iscontext: true
          right:
            value:
              simple: ALL
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2050,
          "y": 420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: d3a79ada-f3dd-48bb-8613-238c9aa07e7c
    type: title
    task:
      id: d3a79ada-f3dd-48bb-8613-238c9aa07e7c
      version: -1
      name: ALL
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "11"
      - "26"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1710,
          "y": 590
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 561f7019-e72d-431c-899d-2ed0f3fa3fc9
    type: title
    task:
      id: 561f7019-e72d-431c-899d-2ed0f3fa3fc9
      version: -1
      name: IAM
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "5"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 890,
          "y": 285
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 1b848c20-b3f9-4e77-8b4a-a7af74bf2151
    type: title
    task:
      id: 1b848c20-b3f9-4e77-8b4a-a7af74bf2151
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1440,
          "y": 1550
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: a8b7c734-99ba-433e-846d-a0e11eecb13d
    type: regular
    task:
      id: a8b7c734-99ba-433e-846d-a0e11eecb13d
      version: -1
      name: Rotate the SA access key
      description: Creates a service account key. A service account can have up to 10 keys. Service account keys that you create don't have an expiry date and stay valid until you delete them.
      script: '|||gcp-iam-service-account-key-create'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      key_algorithm:
        simple: KEY_ALG_RSA_2048
      service_account_name:
        complex:
          root: GCPIAM.ServiceAccount
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: GCPIAM.ServiceAccount.email
                iscontext: true
              right:
                value:
                  simple: inputs.serviceAccountEmail
                iscontext: true
              ignorecase: true
          accessor: name
          transformers:
          - operator: FirstArrayElement
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 890,
          "y": 1380
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: cbe1c618-94c3-47a1-8cca-ab98fbbf5c67
    type: regular
    task:
      id: cbe1c618-94c3-47a1-8cca-ab98fbbf5c67
      version: -1
      name: Get the service account keys
      description: 'Lists service account keys, or retrieves a specific service account key information. One of the arguments: ''service_account_name'' or ''key_name''  must be provided.'
      script: '|||gcp-iam-service-account-keys-get'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "7"
    scriptarguments:
      service_account_name:
        complex:
          root: GCPIAM.ServiceAccount
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: GCPIAM.ServiceAccount.email
                iscontext: true
              right:
                value:
                  simple: inputs.serviceAccountEmail
                iscontext: true
          accessor: name
          transformers:
          - operator: FirstArrayElement
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 890,
          "y": 1060
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: f1fec12d-af5e-4f93-8a4b-5285fad4314a
    type: regular
    task:
      id: f1fec12d-af5e-4f93-8a4b-5285fad4314a
      version: -1
      name: Generate Password
      description: "This function generates a password and allows various parameters to customize the properties of the password depending on the use case (e.g. password complexity requirements).  The default behavior is to generate a password of  *random length* including all four character classes (upper, lower, digits, symbols) with at least five and at most ten characters per class. \n\nThe min_* values all default to 0. This means that if the command is executed in this way:\n!GeneratePassword max_lcase=10\nIt is possible that a password of length zero could be generated. It is therefore recommended to always include a min_* parameter that matches. \n\nThe debug parameter will print certain properties of the command into the WarRoom for easy diagnostics."
      scriptName: GeneratePassword
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      min_digits:
        simple: "5"
      min_lcase:
        simple: "5"
      min_symbols:
        simple: "1"
      min_ucase:
        simple: "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2050,
          "y": 730
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: 1d2baeae-53ce-4e72-86d1-b743af53f7f2
    type: regular
    task:
      id: 1d2baeae-53ce-4e72-86d1-b743af53f7f2
      version: -1
      name: List service accounts
      description: 'Lists service accounts in project, or retrieves a specific service accounts information. One of the arguments: ''service_account_name'' or ''project_name''  must be provided.'
      script: '|||gcp-iam-service-accounts-get'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "25"
    scriptarguments:
      project_name:
        complex:
          root: alert
          accessor: cloudproject
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 890,
          "y": 890
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: 85c2e914-f2ad-4060-853a-d21e4262dcbf
    type: condition
    task:
      id: 85c2e914-f2ad-4060-853a-d21e4262dcbf
      version: -1
      name: Check identity type
      description: Checks the identity type that was part of the alert.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "22"
      SA:
      - "18"
      USER:
      - "10"
    separatecontext: false
    conditions:
    - label: SA
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.identityType
            iscontext: true
          right:
            value:
              simple: SERVICE_ACCOUNT
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.zone
            iscontext: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.serviceAccountEmail
            iscontext: true
    - label: USER
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.identityType
            iscontext: true
          right:
            value:
              simple: User
          ignorecase: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.userID
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1440,
          "y": 110
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "14_11_Revoke Access Key": 0.77,
      "14_26_Reset Password": 0.5,
      "28_10_USER": 0.73,
      "28_18_SA": 0.68
    },
    "paper": {
      "dimensions": {
        "height": 1655,
        "width": 1970,
        "x": 890,
        "y": -40
      }
    }
  }
inputs:
- key: GSuiteRemediationType
  value: {}
  required: false
  description: |-
    The response playbook provides the following remediation actions using GSuite Admin:

    Reset: By entering "Reset" in the input, the playbook will execute password reset.

    Revoke: By entering "Revoke" in the input, the playbook will execute access key suspension. (Both the user and client IDs must be provided)

    ALL: By entering "ALL" in the input, the playbook will execute the password reset and revoke access key tasks.
  playbookInputQuery:
- key: userID
  value: {}
  required: false
  description: Identifies the user in the API request. The value can be the user's primary email address, alias email address, or unique user ID.
  playbookInputQuery:
- key: clientID
  value: {}
  required: false
  description: The client ID.
  playbookInputQuery:
- key: zone
  value: {}
  required: false
  description: The name of the zone.
  playbookInputQuery:
- key: serviceAccountEmail
  value: {}
  required: false
  description: The service account email.
  playbookInputQuery:
- key: identityType
  value: {}
  required: false
  description: |-
    The type of identity involved. Usually mapped to incident field named 'cloudidentitytype'.
    e.g.
    USER, SERVICE_ACCOUNT,APPLICATION
  playbookInputQuery:
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.9.0
