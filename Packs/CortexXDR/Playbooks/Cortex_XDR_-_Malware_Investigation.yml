id: Cortex XDR - Malware Investigation
version: -1
name: Cortex XDR - Malware Investigation
description: |
  Investigates a Cortex XDR incident containing internal malware alerts. The playbook:
  - Enriches the infected endpoint details.
  - Lets the analyst manually retrieve the malicious file.
  - Performs file detonation.

  The playbook is used as a sub- playbook in ‘Cortex XDR Incident Handling - v2’
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 7013d486-d71b-4117-8551-801797af55ca
    type: start
    task:
      id: 7013d486-d71b-4117-8551-801797af55ca
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "27"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 880,
          "y": 30
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "5":
    id: "5"
    taskid: 6496fddc-17e5-49d0-8dcc-2372d4b75188
    type: title
    task:
      id: 6496fddc-17e5-49d0-8dcc-2372d4b75188
      version: -1
      name: File Detonation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "118"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 880,
          "y": 495
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "27":
    id: "27"
    taskid: ff288863-5690-432a-86ca-3a86d8350faa
    type: title
    task:
      id: ff288863-5690-432a-86ca-3a86d8350faa
      version: -1
      name: Endpoint Enrichment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "91"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 880,
          "y": 175
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "45":
    id: "45"
    taskid: 497f868b-82fa-42ab-870f-0af527f51cc1
    type: title
    task:
      id: 497f868b-82fa-42ab-870f-0af527f51cc1
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 880,
          "y": 2910
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "91":
    id: "91"
    taskid: 638288f3-a778-44ea-80fe-8bc2f2eda778
    type: regular
    task:
      id: 638288f3-a778-44ea-80fe-8bc2f2eda778
      version: -1
      name: Cortex XDR - get endpoints
      description: Gets a list of endpoints, according to the passed filters. Filtering
        by multiple fields should be concatenated using the AND condition (OR is not supported).
        Maximum result set size is 100. Offset is the zero-based number of endpoint
        from the start of the result set (start by counting from 0).
      script: Cortex XDR - IR|||xdr-get-endpoints
      type: regular
      iscommand: true
      brand: Cortex XDR - IR
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      ip_list:
        complex:
          root: inputs.host_ip
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 880,
          "y": 320
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "98":
    id: "98"
    taskid: 2e3adef2-12c8-49fc-8963-78b8f0cf4295
    type: condition
    task:
      id: 2e3adef2-12c8-49fc-8963-78b8f0cf4295
      version: -1
      name: Manual - Retrieve file from XDR?
      description: |-
        Manual - Retrieve file from XDR to perform file detonation.
        Alert ID: ${inputs.xdr_alert_id}
        File Name: ${inputs.file_name}
        File Path: ${inputs.file_path}
        File Hash: ${inputs.file_sha256}
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "113"
      Yes:
      - "117"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1450,
          "y": 1580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "111":
    id: "111"
    taskid: 511dc88b-b3ce-4b77-838f-dfbe2d911e27
    type: playbook
    task:
      id: 511dc88b-b3ce-4b77-838f-dfbe2d911e27
      version: -1
      name: Detonate File - Generic
      description: Detonate file through active integrations that support file detonation
      playbookName: Detonate File - Generic
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "45"
    scriptarguments:
      EntryID:
        complex:
          root: File
          accessor: EntryID
      File:
        complex:
          root: File
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 1450,
          "y": 2190
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "112":
    id: "112"
    taskid: 04e226f0-5092-40e7-8312-1d54b7da5d42
    type: condition
    task:
      id: 04e226f0-5092-40e7-8312-1d54b7da5d42
      version: -1
      name: Is the file already present?
      description: Is the file already present?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "116"
      yes:
      - "45"
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: File
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: File.SHA256
                      iscontext: true
                    right:
                      value:
                        simple: inputs.file_sha256
                accessor: EntryID
            iscontext: true
    view: |-
      {
        "position": {
          "x": 1220,
          "y": 830
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "113":
    id: "113"
    taskid: 334523d5-a1b5-449f-83ac-fa191aae5fa5
    type: regular
    task:
      id: 334523d5-a1b5-449f-83ac-fa191aae5fa5
      version: -1
      name: Set the user"s answer
      description: Set multiple keys/values to the context to remmember the user"s answer
      scriptName: SetMultipleValues
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "45"
    scriptarguments:
      keys:
        simple: filesha256,userAnswer
      parent:
        simple: shouldRetrieveFile
      values:
        simple: ${inputs.file_sha256}, false
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1190,
          "y": 1790
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "115":
    id: "115"
    taskid: d1c3dd2f-ebe5-47e0-802a-4969c6277020
    type: condition
    task:
      id: d1c3dd2f-ebe5-47e0-802a-4969c6277020
      version: -1
      name: Check previous answer for the file sha256
      description: Checks if the user already answered if should retrieve the file or not.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "98"
      yes:
      - "45"
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.file_sha256
            iscontext: true
          right:
            value:
              complex:
                root: shouldRetrieveFile
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: shouldRetrieveFile.userAnswer
                      iscontext: true
                    right:
                      value:
                        simple: "false"
                    ignorecase: true
                accessor: filesha256
            iscontext: true
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 1220,
          "y": 1170
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "116":
    id: "116"
    taskid: 7f87ece8-9360-45a5-81a7-83d9d23e17a8
    type: condition
    task:
      id: 7f87ece8-9360-45a5-81a7-83d9d23e17a8
      version: -1
      name: Check if shouldRetrieveFile is defined
      description: Check if its the first iteration and the shouldRetrieveFile already set
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "98"
      yes:
      - "115"
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: shouldRetrieveFile
            iscontext: true
          right:
            value: {}
    view: |-
      {
        "position": {
          "x": 1450,
          "y": 1000
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "117":
    id: "117"
    taskid: 4d74b54b-7691-40a9-8ef7-1e185646bda0
    type: playbook
    task:
      id: 4d74b54b-7691-40a9-8ef7-1e185646bda0
      version: -1
      name: Cortex XDR - Retrieve File Playbook
      description: |-
        Retrieves files from selected endpoints. You can retrieve up to 20 files, from no more than 10 endpoints.
        Inputs for this playbook are:
        - A comma-separated list of endpoint IDs.
        - A comma-separated list of file paths for your operating system, either Windows, Linux, or Mac. At least one file path is required.
      playbookName: Cortex XDR - Retrieve File Playbook
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "111"
    scriptarguments:
      endpoint_ids:
        simple: ${inputs.endpoint_id}
      file_path:
        simple: ${inputs.file_path}
    separatecontext: false
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 1450,
          "y": 1970
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "118":
    id: "118"
    taskid: c2137aeb-42fe-4a7a-8a03-ee79ca5e60ae
    type: condition
    task:
      id: c2137aeb-42fe-4a7a-8a03-ee79ca5e60ae
      version: -1
      name: Check if alert has a file
      description: Checks whether a file is present in the alert
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "45"
      yes:
      - "112"
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: inputs.file_name
            iscontext: true
    view: |-
      {
        "position": {
          "x": 892.5,
          "y": 660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "112_45_yes": 0.21,
      "115_45_yes": 0.25,
      "115_98_#default#": 0.56,
      "118_112_yes": 0.49,
      "118_45_#default#": 0.16,
      "98_113_#default#": 0.66
    },
    "paper": {
      "dimensions": {
        "height": 2945,
        "width": 950,
        "x": 880,
        "y": 30
      }
    }
  }
inputs:
- key: xdr_alert_id
  value: {}
  required: false
  description: Unique ID for the XDR alert.
  playbookInputQuery:
- key: host_ip
  value: {}
  required: false
  description: Host IP involved in the alert.
  playbookInputQuery:
- key: file_name
  value: {}
  required: false
  description: The name of the malicious file.
  playbookInputQuery:
- key: file_sha256
  value: {}
  required: false
  description: SHA-256 hash of the file.
  playbookInputQuery:
- key: file_path
  value: {}
  required: false
  description: Full Path of the file.
  playbookInputQuery:
- key: endpoint_id
  value: {}
  required: false
  description: the endpoint_id
  playbookInputQuery:
outputs:
- contextPath: Joe.Analysis
  description: The Analysis object
  type: unknown
- contextPath: File
  description: The File's object.
  type: unknown
- contextPath: File.Malicious
  description: The malicious file's description.
  type: unknown
- contextPath: DBotScore
  description: The indicator's object.
  type: unknown
- contextPath: IP
  description: IP objects.
  type: unknown
- contextPath: DBotScore.Malicious
  description: Dbot Score malicious information.
  type: unknown
- contextPath: Sample
  description: Sample data object.
  type: unknown
- contextPath: InfoFile
  description: The report file's object.
  type: unknown
- contextPath: WildFire
  description: Wildfire analysis object.
  type: unknown
- contextPath: WildFire.Report
  description: The submission object.
  type: unknown
- contextPath: Joe
  description: Joe Sandbox analysis object.
  type: unknown
- contextPath: Cuckoo.Task
  description: Cuckoo task object.
  type: unknown
- contextPath: SNDBOX.Analysis
  description: SNDBOX analysis.
  type: unknown
- contextPath: HybridAnalysis.Submit
  description: The HybridAnalysis object
  type: unknown
- contextPath: ANYRUN.Task
  description: ANYRUN task object.
  type: unknown
- contextPath: ANYRUN.Task.Behavior
  description: ANYRUN task behavior.
  type: unknown
- contextPath: ANYRUN.Task.Connection
  description: ANYRUN task connection.
  type: unknown
- contextPath: ANYRUN.Task.DnsRequest
  description: ANYRUN task DNS request.
  type: unknown
- contextPath: ANYRUN.Task.Threat
  description: ANYRUN task threat.
  type: unknown
- contextPath: ANYRUN.Task.HttpRequest
  description: ANYRUN task HTTP request.
  type: unknown
- contextPath: ANYRUN.Task.Process
  description: ANYRUN task process information.
  type: unknown
- contextPath: ANYRUN.Task.Process.Version
  description: ANYRUN task process version.
  type: unknown
- contextPath: PaloAltoNetworksXDR.Incident.shouldRetrieveFile
  description: Files hashes which are not present and were marked as "not retrieve" by the user
  type: unknown
tests:
- No test.
fromversion: 5.0.0
