id: Cortex XDR Remote PsExec with LOLBIN command execution alert
version: -1
name: Cortex XDR Remote PsExec with LOLBIN command execution alert
description: "V The \"Remote PsExec-like LOLBIN Command Execution\" playbook is designed to address and respond to alerts indicating suspicious activities related to remote PsExec-like LOLBIN command execution from an unsigned non-standard source. \nThe playbook aims to efficiently:\n\n- Get the alert data and check if the execution is blocked. If not will terminate the process (manually by default).\n- Enrich any entities and indicators from the alert and find any related campaigns.\n- Perform command analysis to provide insights and a verdict for the executed command.\n- Perform further endpoint investigation using Cortex XDR.\n- Checks for any malicious verdicts found to raise the severity of the alert.\n- Perform automatic/manual remediation response by blocking any malicious indicators found.\n\nThe playbook is designed to run as a sub-playbook in ‘Cortex XDR Incident Handling - v3 & Cortex XDR Alerts Handling’.\nIt depends on the data from the parent playbooks and cannot be used as a standalone version."
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: a835ff13-df47-46d5-865e-ddf2b89ba1ba
    type: start
    task:
      id: a835ff13-df47-46d5-865e-ddf2b89ba1ba
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "10"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -480
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 1b3a4e8c-47fb-4735-8261-0bd30c965e37
    type: title
    task:
      id: 1b3a4e8c-47fb-4735-8261-0bd30c965e37
      version: -1
      name: Enrichment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 981c4a23-31ba-4e2a-8464-d7b6c918a987
    type: playbook
    task:
      id: 981c4a23-31ba-4e2a-8464-d7b6c918a987
      version: -1
      name: Entity Enrichment - Generic v4
      description: Enrich entities using one or more integrations.
      playbookName: Entity Enrichment - Generic v4
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "23"
    scriptarguments:
      CVE:
        complex:
          root: CVE
          accessor: ID
      Domain:
        complex:
          root: Domain
          accessor: Name
          transformers:
          - operator: uniq
      Email:
        complex:
          root: Account
          accessor: Email.Address
          transformers:
          - operator: uniq
      Hostname:
        complex:
          root: Endpoint
          accessor: Hostname
          transformers:
          - operator: uniq
      IP:
        complex:
          root: IP
          accessor: Address
          transformers:
          - operator: uniq
      MD5:
        complex:
          root: File
          accessor: MD5
          transformers:
          - operator: uniq
      RasterizeURL:
        simple: "True"
      ResolveIP:
        simple: "False"
      SHA1:
        complex:
          root: File
          accessor: SHA1
          transformers:
          - operator: uniq
      SHA256:
        complex:
          root: File
          accessor: SHA256
          transformers:
          - operator: uniq
      URL:
        complex:
          root: URL
          accessor: Data
          transformers:
          - operator: uniq
      UseReputationCommand:
        simple: "False"
      Username:
        complex:
          root: Account
          accessor: Username
          transformers:
          - operator: uniq
      VerifyURL:
        simple: "False"
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 450,
          "y": 370
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: d1e50280-0e8f-4b11-8da1-f9fb823df893
    type: condition
    task:
      id: d1e50280-0e8f-4b11-8da1-f9fb823df893
      version: -1
      name: Is the command execution was blocked?
      description: Check if the command execution was blocked.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "11"
      "Yes":
      - "1"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: containsGeneral
          left:
            value:
              complex:
                root: incident.xdralerts
                filters:
                - - operator: in
                    left:
                      value:
                        simple: incident.xdralerts.alert_id
                      iscontext: true
                    right:
                      value:
                        simple: inputs.alerts_ids
                      iscontext: true
                accessor: action
                transformers:
                - operator: uniq
            iscontext: true
          right:
            value:
              simple: Prevented
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -310
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: de09fcf9-c059-461e-84bd-6e8083f21cfb
    type: condition
    task:
      id: de09fcf9-c059-461e-84bd-6e8083f21cfb
      version: -1
      name: Should automatically terminate the process?
      description: Check if auto remediation is set to True.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "1"
      "yes":
      - "35"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.AutoRemediation
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 770,
          "y": -140
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 3cce95be-3ae7-4500-8b1d-7ebf6d9186cc
    type: playbook
    task:
      id: 3cce95be-3ae7-4500-8b1d-7ebf6d9186cc
      version: -1
      name: Command-Line Analysis
      description: "This playbook takes a command line from the alert and performs the following actions:\n- Checks for a base64 string and decodes it if it exists\n- Extracts and enriches indicators from the command line\n- Checks specific arguments for malicious usage \n\nAt the end of the playbook, it sets a possible verdict for the command line, based on the finding:\n1. Indicators found in the command line\n2. Found AMSI techniques\n3. Found suspicious parameters\n4. Usage of malicious tools\n5. Indication of network activity\n6. Indication of suspicious LOLBIN execution\n\nNote: In case you want to run this playbook with a list of command lines, set this playbook to run in a loop. To do so, navigate to 'Loop' and check \"For Each Input\"."
      playbookName: Command-Line Analysis
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      Commandline:
        complex:
          root: incident.xdralerts
          accessor: action_process_image_command_line
          transformers:
          - operator: uniq
      StringSimilarityThreshold:
        simple: "0.5"
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 50,
          "y": 700
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: f7346273-c3b3-4f3f-89ce-8e0e53b09d06
    type: regular
    task:
      id: f7346273-c3b3-4f3f-89ce-8e0e53b09d06
      version: -1
      name: Raise incident severity
      description: Optionally increases the incident severity to the new value if it is greater than the existing severity.
      scriptName: IncreaseIncidentSeverity
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "16"
    scriptarguments:
      severity:
        simple: High
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 900,
          "y": 1220
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: ddbc6cb4-e3c4-4e24-8da2-8472be47627e
    type: title
    task:
      id: ddbc6cb4-e3c4-4e24-8da2-8472be47627e
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "28"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 900,
          "y": 1380
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 0c78e42d-dd9d-4df2-872b-d3530038f8f0
    type: title
    task:
      id: 0c78e42d-dd9d-4df2-872b-d3530038f8f0
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1690
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: 5bc3a7b0-66e6-44e0-85ed-6777c252f6cc
    type: title
    task:
      id: 5bc3a7b0-66e6-44e0-85ed-6777c252f6cc
      version: -1
      name: Investigation & Analysis
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "34"
      - "33"
      - "13"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 550
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: f48383b3-576d-4e9b-8163-87ded56fb747
    type: playbook
    task:
      id: f48383b3-576d-4e9b-8163-87ded56fb747
      version: -1
      name: Block Indicators - Generic v3
      description: |+
        This playbook blocks malicious indicators using all integrations that are enabled, using the following sub-playbooks:

        - Block URL - Generic v2
        - Block Account - Generic v2
        - Block IP - Generic v3
        - Block File - Generic v2
        - Block Email - Generic v2
        - Block Domain - Generic v2

      playbookName: Block Indicators - Generic v3
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      AutoBlockIndicators:
        complex:
          root: inputs.AutoRemediation
      AutoCommit:
        simple: "No"
      CustomBlockRule:
        simple: "True"
      CustomURLCategory:
        simple: XSOAR Remediation - Malicious URLs
      IP:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: ip
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: uniq
      InputEnrichment:
        simple: "False"
      RuleDirection:
        simple: outbound
      RuleName:
        simple: XSOAR - Block Indicators playbook - ${incident.id}
      URL:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: url
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: uniq
      UserVerification:
        complex:
          root: inputs.AutoRemediation
      Username:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: username
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 900,
          "y": 1520
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 5a5a558a-56bb-41e5-8696-cf7198e7d1d3
    type: condition
    task:
      id: 5a5a558a-56bb-41e5-8696-cf7198e7d1d3
      version: -1
      name: Found additional alerts or suspicious command line?
      description: Check if a malicious verdict was found.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "22"
      Malicious:
      - "15"
    separatecontext: false
    conditions:
    - label: Malicious
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: CommandlineVerdict
            iscontext: true
          right:
            value: {}
        - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident
                accessor: critical_severity_alert_count
            iscontext: true
          right:
            value:
              complex:
                root: inputs.CriticalAlertsThreshold
            iscontext: true
        - operator: greaterThanOrEqual
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.high_severity_alert_count
            iscontext: true
          right:
            value:
              complex:
                root: inputs.HighAlertsThreshold
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1040
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 9559f289-28e2-4e14-857e-2bc9e44bc594
    type: playbook
    task:
      id: 9559f289-28e2-4e14-857e-2bc9e44bc594
      version: -1
      name: Threat Hunting - Generic
      description: "This playbook enables threat hunting for IOCs in your enterprise. It currently supports the following integrations: \n- Splunk\n- Qradar\n- Pan-os \n- Cortex data lake \n- Autofocus\n- Microsoft 365 Defender"
      playbookName: Threat Hunting - Generic
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      IPAddress:
        complex:
          root: inputs.SrcIPAddress
          transformers:
          - operator: uniq
      MD5:
        complex:
          root: incident.xdralerts
          filters:
          - - operator: in
              left:
                value:
                  simple: incident.xdralerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alerts_ids
                iscontext: true
              ignorecase: true
          accessor: causalityactorprocessimagemd5
          transformers:
          - operator: uniq
      QRadarTimeFrame:
        simple: LAST 7 DAYS
      SHA1:
        complex:
          root: incident.xdralerts
          filters:
          - - operator: in
              left:
                value:
                  simple: incident.xdralerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alerts_ids
                iscontext: true
              ignorecase: true
          accessor: causalityactorprocessimagesha1
          transformers:
          - operator: uniq
      SHA256:
        complex:
          root: incident.xdralerts
          filters:
          - - operator: in
              left:
                value:
                  simple: incident.xdralerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alerts_ids
                iscontext: true
              ignorecase: true
          accessor: causalityactorprocessimagesha256
          transformers:
          - operator: uniq
      SplunkEarliestTime:
        simple: -7d@d
      SplunkLatestTime:
        simple: now
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 860,
          "y": 700
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 3b0a4fe2-e158-4d20-87f3-eee26cf3b175
    type: playbook
    task:
      id: 3b0a4fe2-e158-4d20-87f3-eee26cf3b175
      version: -1
      name: Cortex XDR - Endpoint Investigation
      description: "This playbook is part of the 'Malware Investigation And Response' pack. For more information, refer to https://xsoar.pan.dev/docs/reference/packs/malware-investigation-and-response. This playbook handles all the endpoint investigation actions available with Cortex XSOAR, including the following tasks:\n * Pre-defined MITRE Tactics\n * Host fields (Host ID)\n * Attacker fields (Attacker IP, External host)\n * MITRE techniques\n * File hash (currently, the playbook supports only SHA256)  \n\n Note: The playbook inputs enable manipulating the execution flow; read the input descriptions for details."
      playbookName: Cortex XDR - Endpoint Investigation
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      FileSHA256:
        complex:
          root: File
          accessor: SHA256
      HuntCnCTechniques:
        simple: "False"
      HuntCollectionTechniques:
        simple: "True"
      HuntDefenseEvasionTechniques:
        simple: "False"
      HuntDiscoveryTechniques:
        simple: "True"
      HuntExecutionTechniques:
        simple: "False"
      HuntImpactTechniques:
        simple: "False"
      HuntInitialAccessTechniques:
        simple: "False"
      HuntLateralMovementTechniques:
        simple: "True"
      HuntPersistenceTechniques:
        simple: "False"
      HuntPrivilegeEscalationTechniques:
        simple: "False"
      HuntReconnaissanceTechniques:
        simple: "False"
      RunAll:
        simple: "True"
      agentID:
        complex:
          root: inputs.EndpointIDs
      timeRange:
        simple: 2 hours ago
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 450,
          "y": 700
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: 5920bb35-c21a-424a-8d31-0666ec2a82d4
    type: regular
    task:
      id: 5920bb35-c21a-424a-8d31-0666ec2a82d4
      version: -1
      name: Terminate suspicious process
      description: Initiates a new endpoint script execution of shell commands.
      script: '|||xdr-script-commands-execute'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "1"
    scriptarguments:
      commands:
        complex:
          root: incident.xdralerts
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: incident.xdralerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alerts_ids
                iscontext: true
              ignorecase: true
          accessor: os_actor_process_os_pid
          transformers:
          - operator: ConcatFormat
            args:
              ctx_data: {}
              ctx_inc: {}
              ctx_inputs: {}
              keep_symbol_to_null: {}
              prefix:
                value:
                  simple: 'taskkill /F /PID '
              suffix: {}
              variable_markers: {}
      endpoint_ids:
        complex:
          root: incident.xdralerts
          filters:
          - - operator: in
              left:
                value:
                  simple: incident.xdralerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alerts_ids
                iscontext: true
              ignorecase: true
          accessor: endpoint_id
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 770,
          "y": 60
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: 50099466-0fe2-4a6b-8ca8-02bdcc2a48c7
    type: regular
    task:
      id: 50099466-0fe2-4a6b-8ca8-02bdcc2a48c7
      version: -1
      name: Set Command-Line Verdict to Layout
      description: commands.local.cmd.set.incident
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      commandline:
        complex:
          root: commandline
          accessor: original
      commandlineverdict:
        complex:
          root: CommandlineVerdict
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": 870
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "10_1_Yes": 0.29,
      "29_15_Malicious": 0.54,
      "29_22_#default#": 0.18
    },
    "paper": {
      "dimensions": {
        "height": 2235,
        "width": 1230,
        "x": 50,
        "y": -480
      }
    }
  }
inputs:
- key: SrcIPAddress
  value:
    complex:
      root: incident.xdralerts
      accessor: actionremoteip
      transformers:
      - operator: uniq
  required: false
  description: The remote IP address that executed the process.
  playbookInputQuery:
- key: alerts_ids
  value:
    complex:
      root: incident.xdralerts
      filters:
      - - operator: isEqualString
          left:
            value:
              simple: incident.xdralerts.matchingserviceruleid
            iscontext: true
          right:
            value:
              simple: f2282012-53aa-44f0-bda2-e45cd6b8b61a
          ignorecase: true
      accessor: alert_id
  required: false
  description: The IDs of the relevant alerts.
  playbookInputQuery:
- key: AutoRemediation
  value:
    simple: "false"
  required: false
  description: Whether remediation will be run automatically or manually. If set to "True" - remediation will be automatic.
  playbookInputQuery:
- key: LOLBASFeedLimit
  value:
    simple: "100"
  required: false
  description: LOLBAS Feed results limit.
  playbookInputQuery:
- key: EndpointIDs
  value:
    complex:
      root: incident.xdralerts
      filters:
      - - operator: containsGeneral
          left:
            value:
              simple: incident.xdralerts.name
            iscontext: true
          right:
            value:
              simple: Remote PsExec-like LOLBIN command execution
          ignorecase: true
      accessor: endpoint_id
  required: false
  description: The IDs of the victim endpoint.
  playbookInputQuery:
- key: HighAlertsThreshold
  value:
    simple: "1"
  required: false
  description: The threshold number of additional high severity alerts.
  playbookInputQuery:
- key: CriticalAlertsThreshold
  value:
    simple: "1"
  required: false
  description: The threshold number of additional critical severity alerts.
  playbookInputQuery:
outputs: []
tests:
- Test Playbook - Cortex XDR - Endpoint Investigation
- Test XDR Playbook execute script commands
- Test XDR Playbook
fromversion: 6.9.0
