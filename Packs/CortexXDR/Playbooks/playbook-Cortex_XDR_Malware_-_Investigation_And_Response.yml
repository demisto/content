id: Cortex XDR Malware - Investigation And Response
version: -1
name: Cortex XDR Malware - Investigation And Response
description: "This playbook investigates Cortex XDR malware incidents. It uses:\n\n
- Cortex XDR insights \n
- Command Line Analysis \n
- Dedup \n
- Sandbox hash search and detonation \n
- Cortex XDR enrichment \n
- Incident Handling ( True/False Positive)"
starttaskid: '0'
tasks:
  '0':
    id: '0'
    taskid: 03514848-ce96-452b-8710-94790985cc56
    type: start
    task:
      id: 03514848-ce96-452b-8710-94790985cc56
      version: -1
      name: ''
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '96'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 460,
          "y": -110
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '6':
    id: '6'
    taskid: 7239a8f0-2e91-48f4-8208-fea226a79f93
    type: condition
    task:
      id: 7239a8f0-2e91-48f4-8208-fea226a79f93
      version: -1
      name: Use deduplication?
      description: Use deduplication?
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '8'
      yes:
      - '98'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.EnableDeduplication
            iscontext: true
          right:
            value:
              simple: Yes
    view: |-
      {
        "position": {
          "x": 460,
          "y": 315
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '8':
    id: '8'
    taskid: b073d242-fa24-45de-8edb-05b67dd3fb5a
    type: title
    task:
      id: b073d242-fa24-45de-8edb-05b67dd3fb5a
      version: -1
      name: Deduplication Done
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '86'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 460,
          "y": 670
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '26':
    id: '26'
    taskid: c508ecbb-78b0-472e-8e32-21518a810241
    type: title
    task:
      id: c508ecbb-78b0-472e-8e32-21518a810241
      version: -1
      name: Sandbox
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '103'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1540,
          "y": 980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '27':
    id: '27'
    taskid: 87748412-4dff-4775-8083-e26099539c68
    type: title
    task:
      id: 87748412-4dff-4775-8083-e26099539c68
      version: -1
      name: Any prevention actions?
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '31'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 860,
          "y": 980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '31':
    id: '31'
    taskid: eb525f1c-42eb-4ad0-8ca7-a8f275fe3083
    type: condition
    task:
      id: eb525f1c-42eb-4ad0-8ca7-a8f275fe3083
      version: -1
      name: Check if there were any prevention Actions?
      description: Check if there were any prevention actions?
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '33'
      Prevention:
      - '32'
    separatecontext: false
    conditions:
    - label: Prevention
      condition:
      - - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.action_pretty
            iscontext: true
          right:
            value:
              simple: block
          ignorecase: true
        - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.action_pretty
            iscontext: true
          right:
            value:
              simple: prevent
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 860,
          "y": 1100
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '32':
    id: '32'
    taskid: 398ce057-0d68-4587-84a3-302f49f6a2c1
    type: condition
    task:
      id: 398ce057-0d68-4587-84a3-302f49f6a2c1
      version: -1
      name: Was the malicious hash Blocked?
      description: Was the malicious hash Blocked?
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '80'
      yes:
      - '33'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: containsString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident
                filters:
                - - operator: in
                    left:
                      value:
                        simple: PaloAltoNetworksXDR.Incident.file_artifacts.file_sha256
                      iscontext: true
                    right:
                      value:
                        simple: File(val.Malicious).SHA256
                      iscontext: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXDR.Incident.file_artifacts.file_wildfire_verdict
                      iscontext: true
                    right:
                      value:
                        simple: Malicious
                    ignorecase: true
                accessor: alerts.action_pretty
            iscontext: true
          right:
            value:
              simple: Block
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident
                filters:
                - - operator: in
                    left:
                      value:
                        simple: PaloAltoNetworksXDR.Incident.file_artifacts.file_sha256
                      iscontext: true
                    right:
                      value:
                        simple: File(val.Malicious).SHA256
                      iscontext: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXDR.Incident.file_artifacts.file_wildfire_verdict
                      iscontext: true
                    right:
                      value:
                        simple: Malicious
                accessor: alerts.action_pretty
            iscontext: true
          right:
            value:
              simple: Prevent
    view: |-
      {
        "position": {
          "x": 860,
          "y": 1480
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '33':
    id: '33'
    taskid: a28038ed-d65a-4946-8f05-61e0a1841747
    type: title
    task:
      id: a28038ed-d65a-4946-8f05-61e0a1841747
      version: -1
      name: Manual Review if needed to proceed with the investigation
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '54'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 460,
          "y": 1825
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '36':
    id: '36'
    taskid: 93e5b41b-313b-455d-8b02-16684ed88e90
    type: regular
    task:
      id: 93e5b41b-313b-455d-8b02-16684ed88e90
      version: -1
      name: Parse Finding from the sandboxes
      description: Retrieves information from previously run reputation commands and aggregates their results.
      scriptName: InvestigationSummaryParse
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '116'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1810,
          "y": 2550
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: Malware Investigation Summary
      output:
        simple: ${InvestigationSummary}
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '37':
    id: '37'
    taskid: bf6dc038-04e1-434d-86b1-2d97cc43ccb0
    type: condition
    task:
      id: bf6dc038-04e1-434d-86b1-2d97cc43ccb0
      version: -1
      name: Is file retrieval allowed?
      description: Is file retrieval allowed?
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '40'
      yes:
      - '111'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.RetrieveFile
            iscontext: true
          right:
            value:
              simple: 'true'
    view: |-
      {
        "position": {
          "x": 1300,
          "y": 1550
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '38':
    id: '38'
    taskid: 8908f561-46fe-45ff-8d96-97c90e0d0d1e
    type: condition
    task:
      id: 8908f561-46fe-45ff-8d96-97c90e0d0d1e
      version: -1
      name: Were there any hashes without a verdict?
      description: Were there any hashes without a verdict?
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '41'
      yes:
      - '42'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: NonFoundHashes
            iscontext: true
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 1540,
          "y": 1250
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '40':
    id: '40'
    taskid: 0bd588e1-5e70-4cc3-8496-c8d8275edc8a
    type: title
    task:
      id: 0bd588e1-5e70-4cc3-8496-c8d8275edc8a
      version: -1
      name: Parse Findings
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '36'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1810,
          "y": 2420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '41':
    id: '41'
    taskid: 5cbb7d7c-fcf2-4b27-82da-4fe79662f3b0
    type: title
    task:
      id: 5cbb7d7c-fcf2-4b27-82da-4fe79662f3b0
      version: -1
      name: Known File
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '40'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1810,
          "y": 1430
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '42':
    id: '42'
    taskid: daa56ac7-0f8d-4f65-8729-ceba63de08db
    type: title
    task:
      id: daa56ac7-0f8d-4f65-8729-ceba63de08db
      version: -1
      name: Unknown File
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '37'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1300,
          "y": 1430
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '45':
    id: '45'
    taskid: 5d48cfc0-5bb3-4183-8999-5bd9b40d024e
    type: playbook
    task:
      id: 5d48cfc0-5bb3-4183-8999-5bd9b40d024e
      version: -1
      name: Detonate and Analyze File - Generic
      playbookId: Detonate and Analyze File - Generic
      type: playbook
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '40'
    scriptarguments:
      File:
        complex:
          root: File
          filters:
          - - operator: notContainsString
              left:
                value:
                  simple: File.Name
                iscontext: true
              right:
                value:
                  simple: wildfire_report
    separatecontext: true
    loop:
      iscommand: false
      scriptArguments:
        File:
          complex:
            root: File
            filters:
            - - operator: notContainsString
                left:
                  value:
                    simple: File.Extension
                  iscontext: true
                right:
                  value:
                    simple: gz
                ignorecase: true
            - - operator: notContainsString
                left:
                  value:
                    simple: File.Name
                  iscontext: true
                right:
                  value:
                    simple: Investigation_package_incident
                ignorecase: true
      exitCondition: ''
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 1300,
          "y": 2250
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '47':
    id: '47'
    taskid: c458d32d-8508-4b1e-8909-2d6b84390705
    type: condition
    task:
      id: c458d32d-8508-4b1e-8909-2d6b84390705
      version: -1
      name: Is Detonate Allowed?
      description: Is Detonate Allowed?
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '40'
      yes:
      - '45'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.DetonateFile
            iscontext: true
          right:
            value:
              simple: 'true'
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 1300,
          "y": 2060
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '54':
    id: '54'
    taskid: eb6188f8-8fb9-49e8-8e92-0a6ddb9fc8e2
    type: title
    task:
      id: eb6188f8-8fb9-49e8-8e92-0a6ddb9fc8e2
      version: -1
      name: Conclusion
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '97'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 460,
          "y": 2880
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '60':
    id: '60'
    taskid: c46885a3-faae-423d-822b-57c47a3726d6
    type: title
    task:
      id: c46885a3-faae-423d-822b-57c47a3726d6
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ''
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 460,
          "y": 3740
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '62':
    id: '62'
    taskid: 6e2e9ef3-b669-426c-8f35-21fc3962bb29
    type: collection
    task:
      id: 6e2e9ef3-b669-426c-8f35-21fc3962bb29
      version: -1
      name: False / True Positive
      description: False / True Positive
      type: collection
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '104'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -190,
          "y": 3210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
        simple: Administrator,Analyst
      subject:
        simple: Is this incident FP
      body:
      methods: []
      format: ''
      bcc:
      cc:
        simple: Administrator,Analyst
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
      replyOptions:
      - True Positive
      - False Positive
    form:
      questions:
      - id: '0'
        label: ''
        labelarg:
          simple: 'Incident Classification '
        required: true
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - simple: Manual
        - simple: True Positive
        - simple: False Positive
        fieldassociated: ''
        placeholder: ''
        tooltip: ''
        readonly: false
      - id: '1'
        label: ''
        labelarg:
          simple: Comment
        required: true
        gridcolumns: []
        defaultrows: []
        type: shortText
        options: []
        optionsarg: []
        fieldassociated: ''
        placeholder: ''
        tooltip: Please enter information
        readonly: false
      title: Incident Classification
      description: ''
      sender: ''
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '78':
    id: '78'
    taskid: 3c336394-a01a-4c91-8c64-1c28ce985e87
    type: title
    task:
      id: 3c336394-a01a-4c91-8c64-1c28ce985e87
      version: -1
      name: Dedup
      description: Set multiple keys/values to the context.
      type: title
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '6'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 460,
          "y": 190
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '80':
    id: '80'
    taskid: 6cb07444-2862-4fdf-81bc-6ae109c51f1f
    type: regular
    task:
      id: 6cb07444-2862-4fdf-81bc-6ae109c51f1f
      version: -1
      name: Raise the incident severity
      description: commands.local.cmd.set.incident
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - '54'
    scriptarguments:
      appendTags:
        simple: 'true'
      severity:
        simple: High
      tags:
        simple: Containment Occured
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 860,
          "y": 1810
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '86':
    id: '86'
    taskid: b71252a9-3204-4ae8-87a2-d64bfcf23578
    type: condition
    task:
      id: b71252a9-3204-4ae8-87a2-d64bfcf23578
      version: -1
      name: Check if the device is not isolated?
      description: Check if the device is not isolated?
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '33'
      yes:
      - '26'
      - '27'
      - '91'
      - '112'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isNotEqualString
          left:
            value:
              simple: Endpoint.Status
            iscontext: true
          right:
            value:
              simple: Isolated
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 460,
          "y": 810
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '91':
    id: '91'
    taskid: 547db906-038c-49bc-8734-d02ecbf9c824
    type: title
    task:
      id: 547db906-038c-49bc-8734-d02ecbf9c824
      version: -1
      name: Command Line Analysis
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '95'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -20,
          "y": 980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '92':
    id: '92'
    taskid: a0be4fa5-8fc1-4c2c-89ef-94f29bfbeac9
    type: playbook
    task:
      id: a0be4fa5-8fc1-4c2c-89ef-94f29bfbeac9
      version: -1
      name: Command-Line Analysis
      description: "This playbook takes the command line from the alert and performs the following actions:\n
      - Checks for base64 string and decodes if exists\n
      - Extracts and enriches indicators from the command line\n
      - Checks specific arguments for malicious usage \n\n
      At the end of the playbook, it sets a possible verdict for the command line, based on the finding:\n
      1. Indicators found in the command line\n
      2. Found AMSI techniques\n
      3. Found suspicious parameters\n
      4. Usage of malicious tools\n
      5. Indication of network activity"
      playbookName: Command-Line Analysis
      type: playbook
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '93'
    scriptarguments:
      Commandline:
        complex:
          root: incident
          accessor: cmdline
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: incident.parentcmdline
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: incident.processcmd
                iscontext: true
          - operator: uniq
    separatecontext: true
    loop:
      iscommand: false
      scriptArguments:
        Commandline:
          complex:
            root: incident
            accessor: cmdline
            transformers:
            - operator: uniq
      exitCondition: ''
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -20,
          "y": 1290
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '93':
    id: '93'
    taskid: d0155e96-ea9d-49c1-8272-a0483b798874
    type: condition
    task:
      id: d0155e96-ea9d-49c1-8272-a0483b798874
      version: -1
      name: Found any suspicious components?
      description: Found any suspicious components?
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '33'
      yes:
      - '94'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: CommandlineVerdict
            iscontext: true
    view: |-
      {
        "position": {
          "x": -20,
          "y": 1445
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '94':
    id: '94'
    taskid: 79fde98b-309b-4a8d-8c0a-ab88a9053433
    type: regular
    task:
      id: 79fde98b-309b-4a8d-8c0a-ab88a9053433
      version: -1
      name: Set Tag `Suspicious Command-line`
      description: commands.local.cmd.set.incident
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - '33'
    scriptarguments:
      appendTags:
        simple: 'true'
      tags:
        complex:
          root: CommandlineVerdict
          transformers:
          - operator: Stringify
          - operator: RegexExtractAll
            args:
              error_if_no_match: {}
              ignore_case: {}
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: '"(\w*)":'
              unpack_matches: {}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -20,
          "y": 1635
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '95':
    id: '95'
    taskid: c40da1cf-71b4-4c76-8381-4ef60d6f7ca2
    type: condition
    task:
      id: c40da1cf-71b4-4c76-8381-4ef60d6f7ca2
      version: -1
      name: Is there a CMD line parameter?
      description: Is there a CMD line parameter?
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '33'
      yes:
      - '92'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: cmdline
                transformers:
                - operator: append
                  args:
                    item:
                      value:
                        simple: incident.parentcmdline
                      iscontext: true
                - operator: append
                  args:
                    item:
                      value:
                        simple: incident.processcmd
                      iscontext: true
            iscontext: true
          right:
            value: {}
    view: |-
      {
        "position": {
          "x": -20,
          "y": 1130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '96':
    id: '96'
    taskid: 4e51599e-c92d-40af-8c8a-12a33b0c8599
    type: playbook
    task:
      id: 4e51599e-c92d-40af-8c8a-12a33b0c8599
      version: -1
      name: Cortex XDR Malware - Incident Enrichment
      playbookId: Cortex XDR Malware - Incident Enrichment
      type: playbook
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '78'
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 460,
          "y": 20
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '97':
    id: '97'
    taskid: b34fbba7-3ea3-499e-8218-8e3024ad0a6a
    type: condition
    task:
      id: b34fbba7-3ea3-499e-8218-8e3024ad0a6a
      version: -1
      name: Proceed To Closure Steps?
      description: Proceed To Closure Steps?
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '60'
      yes:
      - '62'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.EnableClosureSteps
            iscontext: true
          right:
            value:
              simple: 'True'
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 460,
          "y": 3040
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '98':
    id: '98'
    taskid: c485ca03-2c5a-4760-88e8-c706a8a6a125
    type: playbook
    task:
      id: c485ca03-2c5a-4760-88e8-c706a8a6a125
      version: -1
      name: Dedup - Generic v4
      description: "This playbook identifies duplicate incidents using the Cortex XSOAR machine\
       \ learning method (script).\nIn this playbook, you can choose fields and/or indicators\
       \ to be compared against other incidents in the Cortex XSOAR database.\
       \ \n\nNote: To identify similar incidents you must *must* properly define the playbook inputs. "
      playbookName: Dedup - Generic v4
      type: playbook
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '8'
    scriptarguments:
      CloseSimilar:
        simple: ${inputs.DedupCloseSimilar}
      closeReason:
        simple: Closed by Dedup Playbook within inc ${incident.id}
      fromDate:
        simple: 1 months ago
      handleSimilar:
        simple: ${inputs.DedupHandleSimilar}
      limit:
        simple: ${inputs.DedupLimit}
      method:
        simple: Fields and Indicators
      minimunIncidentSimilarity:
        simple: ${inputs.DedupMinimunIncidentSimilarity}
      query:
        simple: -status:closed -category:job
      showIncidentSimilarityForAllFields:
        simple: 'True'
      similarTextField:
        simple: ${inputs.DedupSimilarTextField}
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 740,
          "y": 490
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '103':
    id: '103'
    taskid: 750fec0d-f3f9-4d2c-837c-85d7895672b3
    type: playbook
    task:
      id: 750fec0d-f3f9-4d2c-837c-85d7895672b3
      version: -1
      name: Search For Hash In Sandbox - Generic
      playbookId: Search For Hash In Sandbox - Generic
      type: playbook
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '38'
    scriptarguments:
      FileSha256:
        simple: ${incident.filesha256}
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 1540,
          "y": 1090
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '104':
    id: '104'
    taskid: bd432431-6cb0-449d-8b76-e14e84bb6938
    type: condition
    task:
      id: bd432431-6cb0-449d-8b76-e14e84bb6938
      version: -1
      name: Check Classification
      description: Check Classification
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '105'
      False Positive:
      - '107'
      True Positive:
      - '106'
    separatecontext: false
    conditions:
    - label: False Positive
      condition:
      - - operator: containsString
          left:
            value:
              simple: Incident Classification.Questions.0
            iscontext: true
          right:
            value:
              simple: 'False'
          ignorecase: true
    - label: True Positive
      condition:
      - - operator: containsString
          left:
            value:
              simple: Incident Classification.Questions.0
            iscontext: true
          right:
            value:
              simple: ture
          ignorecase: true
    view: |-
      {
        "position": {
          "x": -190,
          "y": 3370
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '105':
    id: '105'
    taskid: 09c3626d-9e58-4d23-89d2-84b7534abba0
    type: regular
    task:
      id: 09c3626d-9e58-4d23-89d2-84b7534abba0
      version: -1
      name: Manual Handling
      description: Manual handling of this incident per your procedures.
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '60'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -190,
          "y": 3560
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '106':
    id: '106'
    taskid: 5764287b-0385-48a7-8881-53afe82d8e19
    type: playbook
    task:
      id: 5764287b-0385-48a7-8881-53afe82d8e19
      version: -1
      name: Cortex XDR - True Positive Incident Handling
      playbookId: Cortex XDR - True Positive Incident Handling
      type: playbook
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '60'
    scriptarguments:
      AutoIsolation:
        simple: ${inputs.AutoIsolation}
      BlockTag:
        simple: ${inputs.MaliciousTagName}
      Classification:
        simple: ${Incident Classification.Answers.0}
      Comment:
        simple: ${Incident Classification.Answers.1}
      TicketProjectName:
        simple: ${inputs.TicketProjectName}
      TicketingSystemToUse:
        simple: ${inputs.TicketingSystemToUse}
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -590,
          "y": 3560
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '107':
    id: '107'
    taskid: 2fb8d295-ed06-45b3-8621-75606bdf7ba3
    type: playbook
    task:
      id: 2fb8d295-ed06-45b3-8621-75606bdf7ba3
      version: -1
      name: Cortex XDR - False Positive Incident Handling
      playbookId: Cortex XDR - False Positive Incident Handling
      type: playbook
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '60'
    scriptarguments:
      AllowTag:
        simple: ${inputs.BenignTagName}
      AutoUnisolation:
        simple: ${inputs.AutoUnisolation}
      Comment:
        simple: 'XSOAR Incident #${incident.id}'
      FileSha256:
        simple: ${incident.filesha256}
      HostID:
        simple: ${incident.deviceid}
      Reason:
        simple: ${Incident Classification.Answers.0}
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 220,
          "y": 3560
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '110':
    id: '110'
    taskid: 68244973-d090-4ac5-8e35-9bdc05b1a1eb
    type: regular
    task:
      id: 68244973-d090-4ac5-8e35-9bdc05b1a1eb
      version: -1
      name: Cortex XDR - Retrieve File From Script Execution.
      description: Views the file retrieved by the xdr-retrieve-files command according to the action ID. Before running this command, you can use the xdr-action-status-get command to check if this action completed successfully.
      script: '|||xdr-retrieve-file-details'
      type: regular
      iscommand: true
      brand: ''
    nexttasks:
      '#none#':
      - '47'
    scriptarguments:
      action_id:
        simple: ${PaloAltoNetworksXDR.RetrievedFiles.action_id}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1300,
          "y": 1890
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '111':
    id: '111'
    taskid: 2ea0d834-ce1e-4f55-8bd0-2c0bb23b794b
    type: regular
    task:
      id: 2ea0d834-ce1e-4f55-8bd0-2c0bb23b794b
      version: -1
      name: Cortex XDR - Retrieve File
      description: Retrieves files from selected endpoints. You can retrieve up to 20 files, from no more than 10 endpoints. At least one endpoint ID and one file path are necessary in order to run the command. After running this command, you can use the xdr-action-status-get command with returned action_id, to check the action status.
      script: '|||xdr-file-retrieve'
      type: regular
      iscommand: true
      brand: ''
    nexttasks:
      '#none#':
      - '110'
    scriptarguments:
      endpoint_ids:
        simple: ${Endpoint.ID}
      generic_file_path:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: notIn
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.actor_process_image_sha256
                iscontext: true
              right:
                value:
                  simple: NonFoundHashes
                iscontext: true
          accessor: actor_process_image_path
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1300,
          "y": 1730
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '112':
    id: '112'
    taskid: 8b19c108-3207-47a8-8ed3-45820386df70
    type: title
    task:
      id: 8b19c108-3207-47a8-8ed3-45820386df70
      version: -1
      name: Advanced Hunting
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '115'
      - '117'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -680,
          "y": 980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '113':
    id: '113'
    taskid: 21d73985-7158-4380-837e-dfda0839f413
    type: playbook
    task:
      id: 21d73985-7158-4380-837e-dfda0839f413
      version: -1
      name: Cortex XDR - Endpoint Investigation
      description: "This playbook handles all the endpoint investigation actions available with Cortex XSIAM, including the following tasks:\n
      * Pre-defined MITRE Tactics\n
      * Host fields (host ID)\n
      * Attacker fields (attacker IP, external host)\n
      * MITRE techniques\n
      * File hash (currently, the playbook supports only SHA256)  \n\n
      Note: The playbook inputs enable manipulating the execution flow; read the input descriptions for details."
      playbookId: Cortex XDR - Endpoint Investigation
      type: playbook
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '33'
    scriptarguments:
      FileSHA256:
        complex:
          root: incident
          accessor: filesha256
          transformers:
          - operator: uniq
      HuntCnCTechniques:
        simple: 'True'
      HuntCollectionTechniques:
        simple: 'True'
      HuntDefenseEvasionTechniques:
        simple: 'True'
      HuntDiscoveryTechniques:
        simple: 'True'
      HuntExecutionTechniques:
        simple: 'True'
      HuntImpactTechniques:
        simple: 'True'
      HuntInitialAccessTechniques:
        simple: 'True'
      HuntLateralMovementTechniques:
        simple: 'True'
      HuntPersistenceTechniques:
        simple: 'True'
      HuntPrivilegeEscalationTechniques:
        simple: 'True'
      HuntReconnaissanceTechniques:
        simple: 'True'
      RunAll:
        simple: ${inputs.RunAllHuntMitreTactics}
      agentID:
        complex:
          root: incident
          accessor: agentsid
          transformers:
          - operator: uniq
      timeRange:
        simple: 2 hours ago
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -1140,
          "y": 1310
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '115':
    id: '115'
    taskid: 9b357391-5142-479d-86dc-f4a9efc3a3b9
    type: condition
    task:
      id: 9b357391-5142-479d-86dc-f4a9efc3a3b9
      version: -1
      name: Should run Advanced Hunting?
      description: Should run Advanced Hunting?
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '33'
      yes:
      - '113'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.AdvancedHunting
            iscontext: true
          right:
            value:
              simple: 'true'
          ignorecase: true
    view: |-
      {
        "position": {
          "x": -890,
          "y": 1130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '116':
    id: '116'
    taskid: c3b3a38b-5691-435a-8e02-7577ec75cf88
    type: regular
    task:
      id: c3b3a38b-5691-435a-8e02-7577ec75cf88
      version: -1
      name: Parse Findings From the Sandbox
      description: Parses attacks from context, and shows them according to the MITRE technique they use.
      scriptName: InvestigationDetailedSummaryParse
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '54'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1810,
          "y": 2710
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: Malware Detailed Investigation Summary
      output:
        simple: ${InvestigationDetailedSummary}
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '117':
    id: '117'
    taskid: 62c8c712-706c-465c-8bc7-ef039323df5f
    type: playbook
    task:
      id: 62c8c712-706c-465c-8bc7-ef039323df5f
      version: -1
      name: Cortex XDR - Run script
      description: Initiates a new endpoint script execution action using a provided script unique ID from the Cortex XDR script library.
      playbookName: Cortex XDR - Run script
      type: playbook
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '33'
    scriptarguments:
      endpoint_ids:
        simple: ${incident.deviceid}
      polling_timeout:
        simple: '10'
      script_uid:
        simple: 956e8989f67ebcb2c71c4635311e47e4
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": -460,
          "y": 1130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "31_33_#default#": 0.1,
      "32_33_yes": 0.68,
      "6_8_#default#": 0.5,
      "86_33_#default#": 0.11
    },
    "paper": {
      "dimensions": {
        "height": 3915,
        "width": 3330,
        "x": -1140,
        "y": -110
      }
    }
  }
inputs:
- key: EnableDeduplication
  value:
    simple: 'False'
  required: false
  description: |-
    Whether the deduplication playbook will be used.
  playbookInputQuery:
- key: AutoIsolation
  value:
    simple: 'False'
  required: false
  description: |-
    Whether endpoint isolation is allowed.
  playbookInputQuery:
- key: RetrieveFile
  value:
    simple: 'True'
  required: false
  description: |-
    Whether file retrieval from the endpoint is allowed.
  playbookInputQuery:
- key: TicketingSystemToUse
  value: {}
  required: false
  description: The name of the ticketing system to use, for example, Jira or ServiceNow.
  playbookInputQuery:
- key: TicketProjectName
  value: {}
  required: false
  description: The ticket project name. (required for Jira).
  playbookInputQuery:
- key: MaliciousTagName
  value:
    simple: MaliciousTagName
  required: false
  description: The tag to assign for indicators to block.
  playbookInputQuery:
- key: EnableClosureSteps
  value:
    simple: 'True'
  required: false
  description: |-
    Whether the incident will be closed with closure steps or automatically.
  playbookInputQuery:
- key: DedupSimilarTextField
  value:
    simple: agnetsid,users,agentsid,CMDline,Hostnames,filenames,filepaths
  required: false
  description: A comma-separated list of incident text fields to take into account when computing similarity. For example commandline, URL.
  playbookInputQuery:
- key: AutoUnisolation
  value:
    simple: 'False'
  required: false
  description: |-
    Whether automatic un-isolation is allowed.
  playbookInputQuery:
- key: DedupLimit
  value:
    simple: '200'
  required: false
  description: |-
    The maximum number of incidents to query and set to context data.
  playbookInputQuery:
- key: DedupHandleSimilar
  value:
    simple: Link
  required: false
  description: "Defines how to handle Similar incidents. \n
  Choose between: \"Link\", \"Close\", \"Link and Close\".\n
  Note: Closing incidents requires you to define the \"CloseSimilar\" input as well.\n
  Also, the incidents found by similar indicators or fields will be closed if their similarity score is above the CloseSimilar value. "
  playbookInputQuery:
- key: DedupCloseSimilar
  value:
    simple: '0.9'
  required: false
  description: |-
    Defines the threshold of similarity to close a similar incident. All similar incidents with similarity above this value will be closed.
    For example, if CloseSimilar is set to .8 and an incident has a similarity score of .9, the incident will be closed.
    The value should be between 0 and 1 [0=low similarity , 1=identical].
  playbookInputQuery:
- key: DedupMinimunIncidentSimilarity
  value:
    simple: '0.2'
  required: false
  description: |-
    Retain incidents with a similarity score greater than the MinimunIncidentSimilarity.    
    Value should be between 0 to 1 [0=low similarity, 1=identical]
  playbookInputQuery:
- key: BenignTagName
  value:
    simple: BenignTagName
  required: false
  description: The name of the tag to apply for allowed indicators.
  playbookInputQuery:
- key: AdvancedHunting
  value:
    simple: 'True'
  required: false
  description: |-
    'Whether to run Advance Hunting queries through your Cortex XDR instance using the information on Alert Insights. Note: It may take some time.'
  playbookInputQuery:
- key: RunAllHuntMitreTactics
  value:
    simple: 'True'
  required: false
  description: Whether to run the Advanced Hunting section for all Mitre Tactics.
  playbookInputQuery:
outputs:
- contextPath: PaloAltoNetworksXDR.ScriptResult.results
  description: Palo ALto Networks Script reuslts information.
  type: unknown
tests:
- No tests (auto formatted)
fromversion: 6.5.0
