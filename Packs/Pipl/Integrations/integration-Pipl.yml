commonfields:
  id: Pipl
  version: -1
name: Pipl
fromversion: 5.0.0
display: Pipl
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: Get contact, social, and professional information about people
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: url
  defaultvalue: https://api.pipl.com/search/
  type: 0
  required: false
- display: API Key
  name: key
  defaultvalue: ""
  type: 4
  required: true
- display: Trust any certificate (not secure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: >-
    var url = params.url;

    var columns;

    if (params.columns) {
        columns = params.columns.split(',');
    }


    var sendRequest = function(args) {

        var requestUrl = url.replace(/[\/]+$/, '');

        var queryArgs = {};
        var argKeys = Object.keys(args);
        for (var i = 0; i < argKeys.length; i++) {
            queryArgs[argKeys[i].replace('-','_')] = args[argKeys[i]];
        }
        requestUrl += encodeToURLQuery(queryArgs);
        var res = http(
            requestUrl,
            {
                Method: 'POST',
                Headers: {
                    'Content-Type': ['application/x-www-form-urlencoded']
                },
                Body: 'key=' + params.key
            },
            params.insecure,
            params.proxy
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }
        return JSON.parse(res.Body);
    };


    var createEntry = function(response) {
        var data = [];
        ec = {};
        ec.Account =[];
        //Only one person
        if (response.person) {
            data[0] = addPerson(response.person);
            ec.Account[0] = buildEC(data, 0);
            data[0]['Emails'] = '';
            for (var j = 0; j < data[0].Email.length; j++) {
                data[0]['Emails'] += data[0].Email[j].Address + '\n';
            }
            delete data[0].Email;
        } else {
        //More than one person
            for (var i = 0; i < response.possible_persons.length; i++) {
                data[i] = addPerson(response.possible_persons[i]);
                ec.Account[i] = buildEC(data, i);
                data[i]['Emails'] = '';
                for (var j = 0; j < data[i].Email.length; j++) {
                    data[i]['Emails'] += data[i].Email[j].Address + '\n';
                }
                delete data[i].Email;
            }
        }
        return {
            Type: entryTypes.note,
            ContentsFormat: formats.table,
            Contents: data,
            ReadableContentsFormat: formats.table,
            HumanReadable: data,
            EntryContext: ec
        };
    };


    var buildEC = function(data, i) {
        return {
            Addresses: data[i].Addresses,
            Email: data[i].Email,
            IDs: data[i].UserIDs,
            Names: data[i].Names,
            Phones: data[i].Phones,
            Usernames: data[i].Usernames
        };
    };


    var addPerson = function(person) {
        var response = {
            Names: '',
            Phones: '',
            Gender: '',
            DoB: '',
            Image: '',
            Usernames: '',
            Email: '',
            Educations: '',
            UserIDs: '',
            URLs: '',
            Jobs: '',
            Addresses: ''
        };
        if (person.names) {
            for (var i = 0; i < person.names.length; i++) {
                response.Names += person.names[i].middle ? person.names[i].first + ' ' + person.names[i].middle + ' ' + person.names[i].last + '\n' : person.names[i].first + ' ' + person.names[i].last + '\n';
            }
        }
        if (person.phones) {
            for (var i = 0; i < person.phones.length; i++) {
                response.Phones += person.phones[i].display + ' ' + person.phones[i].display_international + '\n';
            }
        }
        if (person.gender){
            response.Gender = person.gender.content;
        }
        if (person.dob) {
            response.DoB = person.dob.display;
        }
        if (person.images) {
            var url='https://thumb.pipl.com/image?height=100&width=100&favicon=false&zoom_face=false&token='+person.images[0].thumbnail_token;
            response.Image ='__img__:src,'+ url +';alt,'+''+';height,100;width,100';

        }
        if (person.usernames) {
            for (var i = 0; i < person.usernames.length; i++) {
                response.Usernames += person.usernames[i].content + '\n';
            }
        }
        if (person.emails) {
            response.Email = [];
            for (var i = 0; i < person.emails.length; i++) {
                response.Email[i] = {Address:person.emails[i].address};
            }
        }
        if (person.educations) {
            for (var i = 0; i < person.educations.length; i++) {
                response.Educations += person.educations[i].display + '\n';
            }
        }
        if (person.user_ids) {
            for (var i = 0; i < person.user_ids.length; i++) {
                response.UserIDs += person.user_ids[i].content + '\n';
            }
        }
        if (person.urls) {
            for (var i = 0; i < person.urls.length; i++) {
                response.URLs += person.urls[i].url + '\n';
            }
        }
        if (person.jobs) {
            for (var i = 0; i < person.jobs.length; i++) {
                response.Jobs += person.jobs[i].display + '\n';
            }
        }
        if (person.addresses) {
            for (var i = 0; i < person.addresses.length; i++) {
                response.Addresses += person.addresses[i].display + '\n';
            }
        }
        response.provider = 'pipl';
        return response;
    };


    switch (command) {
        case 'test-module':
            var response = sendRequest({'first-name': 'clark', 'last-name': 'kent'});
            return 'ok';
        case 'pipl-search':
            if (Object.keys(args).length === 0) {
                return 'No arguments given.'
            }
            var response = sendRequest(args);
            return createEntry(response);
        case 'email':
            var response = sendRequest(args);
            return createEntry(response);
        default:

    }
  type: javascript
  commands:
  - name: pipl-search
    arguments:
    - name: email
      description: Email address to search
    - name: phone
      description: Home/work/mobile phone number to search
    - name: username
      description: Username/screen-name to search. Minimum 4 characters
    - name: first-name
      description: First name to search. Minimum 2 characters
    - name: last-name
      description: Last name to search. Minimum 2 characters
    - name: middle-name
      description: Middle name or middle initial to search
    - name: raw-name
      description: Full name to search. Use this parameter if the accurate name parts (first/middle/last) are not available, this parameter will only be used in absence of first-name and last-name
    - name: country
      description: A two-letter country code to searchs
    - name: state
      description: A United States, Canada, Great Britain or Australia state code. If a US state is provided and no country specified, we’ll assume the country to be US.
    - name: city
      description: City to search
    - name: zipcode
      description: ZIP code to search
    - name: raw-address
      description: Full address to search
    - name: age
      description: Age to search in String, an exact (YY) or approximate (YY-YY) age
    - name: columns
      description: Order of columns to be displayed in results (comma seperated list of values)
    outputs:
    - contextPath: Account.Email.Address
      description: Email addresses
    - contextPath: Account.IDs
      description: User IDs
    - contextPath: Account.Addresses
      description: Addresses (geographic)
    - contextPath: Account.Names
      description: Full names
    - contextPath: Account.Phones
      description: Phone numbers
    - contextPath: Account.Usernames
      description: Online platforms usernames
    description: Search for required query
  - name: email
    arguments:
    - name: email
      required: true
      description: Email address to search for
    outputs:
    - contextPath: Account.Email.Address
      description: Email addresses
    - contextPath: Account.IDs
      description: User IDs
    - contextPath: Account.Addresses
      description: Addresses (geographic)
    - contextPath: Account.Names
      description: Full names
    - contextPath: Account.Phones
      description: Phone numbers
    - contextPath: Account.Usernames
      description: Online platforms usernames
    description: Searches for information regarding given email address
  runonce: false
