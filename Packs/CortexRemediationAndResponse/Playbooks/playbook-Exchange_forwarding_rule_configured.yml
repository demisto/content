id: Exchange forwarding rule configured
version: -1
name: Exchange forwarding rule configured
description: "This playbook addresses the following alerts:\n\n- External Exchange
  inbox forwarding rule configured.\n- Suspicious Exchange inbox forwarding rule configured.\n-
  Suspicious Exchange email-hiding inbox rule.\n\nPlaybook Stages:\n \nTriage: \n\n-
  The playbook retrieves the caller's IP, the forwarding email address, and the domain.\n\nEarly
  Containment:\n\n- The playbook checks if the IP or domain of the forwarding email
  address is malicious. If so, it suggests blocking the IP using PAN-OS while continuing
  the investigation in parallel.\n\nInvestigation:\n\n- The playbook checks for suspicious
  behaviors, including whether an Exchange admin created the rule outside of working
  hours, from unusual geolocation, or if the user who created the rule has a high-risk
  score. It then aggregates all evidence collected during the investigation.\n\nContainment:\n\n-
  If at least two suspicious pieces of evidence are found, the playbook executes soft
  response actions, including signing the user out and deleting the forwarding email
  address from the user account mailbox. The user will be notified of these actions
  via email.\n- If more than two pieces of suspicious evidence are found, the playbook
  will initiate hard response actions. These include disabling the user and removing
  the forwarding email address from their mailbox. The user will be notified of these
  actions via email.\n\nRequirements: \n\nFor any response action, you need the following
  integrations:\n- EWS Extension Online Powershell v3 integration.\n- Azure Active
  Directory Users."
tags:
- TA0009 - Collection
- TA0010 - Exfiltration
- T1114 - Email Collection
- T1020 - Automated Exfiltration
- TA0005 - Defense Evasion
- T1564.008 - Hide Artifacts
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: d8b9f650-e109-4dd6-886d-da90aef71bff
    type: start
    task:
      id: d8b9f650-e109-4dd6-886d-da90aef71bff
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -310
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 3fa5a92e-3b86-4a05-8b86-53cd466bb1cb
    type: regular
    task:
      id: 3fa5a92e-3b86-4a05-8b86-53cd466bb1cb
      version: -1
      name: Get caller IP and forwarding mail address
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "2"
      - "28"
      - "6"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -180
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: be117be2-af06-4d9e-8b01-19cc4b115d02
    type: regular
    task:
      id: be117be2-af06-4d9e-8b01-19cc4b115d02
      version: -1
      name: 'Check caller IP reputation '
      description: Checks the reputation of an IP address.
      script: '|||ip'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      ip:
        complex:
          root: Core.OriginalAlert.event
          accessor: caller_ip
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -160,
          "y": -10
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: b504ebe2-56d0-400e-8222-a7d57b546615
    type: regular
    task:
      id: b504ebe2-56d0-400e-8222-a7d57b546615
      version: -1
      name: Check forwarding email Domain reputation
      description: Checks the reputation of a domain.
      script: '|||domain'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      domain:
        complex:
          root: Core.OriginalAlert.raw_abioc.event
          accessor: forwarding_domain_with_tld
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 240,
          "y": 180
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: 0b23837d-9e34-4468-8c26-2d54a9705b83
    type: condition
    task:
      id: 0b23837d-9e34-4468-8c26-2d54a9705b83
      version: -1
      name: Evaluate domain and IP address risk level
      type: condition
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#default#':
      - "6"
      "yes":
      - "5"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                    ignorecase: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: domain
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                accessor: Indicator
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -160,
          "y": 350
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 4592715d-e397-4035-8f6a-aa8adebe4d8b
    type: title
    task:
      id: 4592715d-e397-4035-8f6a-aa8adebe4d8b
      version: -1
      name: Early Containment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "7"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -450,
          "y": 520
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 3147a19e-41fd-493f-823d-87582c61e37b
    type: title
    task:
      id: 3147a19e-41fd-493f-823d-87582c61e37b
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "10"
      - "9"
      - "8"
      - "40"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 520
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: aa988d9d-9321-4428-8426-cdd5d7c15e5d
    type: playbook
    task:
      id: aa988d9d-9321-4428-8426-cdd5d7c15e5d
      version: -1
      name: PAN-OS - Block IP
      description: |-
        This playbook blocks IP addresses with 2 optional actions:

        - Block IP addresses using Static Address Groups in Palo Alto Networks Panorama or Firewall. The playbook receives malicious IP addresses and an address group name as inputs, verifies that the addresses are not already a part of the address group, adds them and commits the configuration.


        - Utilize the Dynamic Address Group (DAG) capability of PAN-OS. DAG enables analysts to create a rule one time, where the group is the source/destination, and adds IP addresses dynamically without the need to commit the configuration every time.
        The playbook checks if the given tag already exists. If the tag exists, then the IP address is added to the tag.
        If the tag does not exist, a new address group is created with the given tag and a matching rule, and the configuration is committed.
      playbookName: PAN-OS - Block IP
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "35"
    scriptarguments:
      MaliciousIPs:
        simple: ${Core.OriginalAlert.event.caller_ip}
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -450,
          "y": 660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 150bae48-03a8-495a-87b5-11b63bd85444
    type: regular
    task:
      id: 150bae48-03a8-495a-87b5-11b63bd85444
      version: -1
      name: Get user risk score
      description: Retrieve the risk score of a specific user or list of users with the highest risk score in the environment along with the reason affecting each score.
      script: '|||core-list-risky-users'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      user_id:
        simple: ${Core.OriginalAlert.raw_abioc.event.identity_normalized.identity}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 840,
          "y": 660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: 146faa60-9405-4cf2-8f7c-7ce02160a0c4
    type: regular
    task:
      id: 146faa60-9405-4cf2-8f7c-7ce02160a0c4
      version: -1
      name: Check if rule creation occurred outside business hours
      description: Checks whether the given value is within the specified time (hour) range.
      scriptName: BetweenHours
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "23"
    scriptarguments:
      begin_time:
        simple: "22:00:00"
      end_time:
        simple: "06:00:00"
      extend-context:
        simple: IsOutOfWorkingHours=
      value:
        complex:
          root: Core.OriginalAlert.event
          accessor: event_timestamp
          transformers:
          - operator: TimeStampToDate
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 60,
          "y": 660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: cdba5566-f4de-4815-85ba-46d04083adf2
    type: regular
    task:
      id: cdba5566-f4de-4815-85ba-46d04083adf2
      version: -1
      name: Analyze geolocation anomalies
      description: |-
        Returns all elements from the left side that have a substring that is equal to an element from the right side. Note: This filter is case-insensitive.
      scriptName: AnyMatch
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      extend-context:
        simple: IsAbnormalGeolocation=
      left:
        simple: ${Core.OriginalAlert.event.saas_caller_ip_geolocation_days_seen_count},${Core.OriginalAlert.event.service_caller_ip_asn_days_seen_count}
      right:
        simple: "0"
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 2a5b29fd-1460-4830-819f-be57d5c524df
    type: regular
    task:
      id: 2a5b29fd-1460-4830-819f-be57d5c524df
      version: -1
      name: Close Alert
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      closeReason:
        simple: Resolved - Handled by the playbook "Exchange forwarding rule configured"
      id:
        complex:
          root: alert
          accessor: id
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2470
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 2c156ff3-3b1c-4301-8454-1f3a7c4c3fb4
    type: collection
    task:
      id: 2c156ff3-3b1c-4301-8454-1f3a7c4c3fb4
      version: -1
      name: Decide whether to delete the forwarding rule
      type: collection
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#none#':
      - "42"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: Should the forwarding rule be deleted?
        required: false
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - simple: "Yes"
        - simple: "No"
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Decide whether to delete the forwarding rule
      description: 'During the remediation phase, when the forwarding rule is deleted from the mailbox, it triggers the correlated alert: "Forwarding rule was removed from your mailbox." This alert is part of the EWS O365 integration.'
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 08bbda77-f3ca-482f-83bb-6590a059f649
    type: regular
    task:
      id: 08bbda77-f3ca-482f-83bb-6590a059f649
      version: -1
      name: Remove the Exchange forwarding rule
      description: Remove an Inbox rule.
      script: '|||ews-remove-rule'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "38"
    scriptarguments:
      identity:
        simple: ${Core.OriginalAlert.raw_abioc.event.exchange_rule_name}
      mailbox:
        simple: ${Core.OriginalAlert.raw_abioc.event.identity_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1960
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 58ed5fd7-71b7-4865-8de2-a4b02de08967
    type: title
    task:
      id: 58ed5fd7-71b7-4865-8de2-a4b02de08967
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: 34930460-5127-496b-8e0c-3edcd48e29af
    type: playbook
    task:
      id: 34930460-5127-496b-8e0c-3edcd48e29af
      version: -1
      name: Containment Plan - Clear User Sessions
      description: |-
        ## Containment Plan - Clear User Sessions

        This playbook is a sub-playbook within the containment plan playbook.
        The playbook uses the 'Okta v2' and 'MSGraph User' integrations to clear user sessions.
      playbookName: Containment Plan - Clear User Sessions
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      ClearUserSessions:
        simple: "True"
      Username:
        simple: ${Core.OriginalAlert.event.identity_name}
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 1110,
          "y": 2300
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: 88f80ddf-8d28-480d-8c67-9bb233890c41
    type: regular
    task:
      id: 88f80ddf-8d28-480d-8c67-9bb233890c41
      version: -1
      name: Set risky user to aggregated evidences
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This script runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about script permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidences
      value:
        complex:
          root: ${
          accessor: '}'
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs==rhs
              conditionB: {}
              conditionInBetween: {}
              else: {}
              equals: {}
              lhs:
                value:
                  simple: Core.RiskyUser.risk_level
                iscontext: true
              lhsB: {}
              options: {}
              optionsB: {}
              rhs:
                value:
                  simple: HIGH
              rhsB: {}
              then:
                value:
                  simple: The user risk level is high.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 840,
          "y": 820
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 44ae1921-e62d-4ace-8ad6-604f750b32e0
    type: regular
    task:
      id: 44ae1921-e62d-4ace-8ad6-604f750b32e0
      version: -1
      name: Set abnormal geolocation to aggregated evidences
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This script runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about script permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidences
      value:
        complex:
          root: ${
          accessor: '}'
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs==rhs
              conditionB: {}
              conditionInBetween: {}
              else: {}
              equals: {}
              lhs:
                value:
                  simple: IsAbnormalGeolocation.[0]
                iscontext: true
              lhsB: {}
              options: {}
              optionsB: {}
              rhs:
                value:
                  simple: "True"
              rhsB: {}
              then:
                value:
                  simple: The user connected from an unusual geolocation.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 820
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: 347eeeb4-facc-4e53-8832-013274dac80f
    type: regular
    task:
      id: 347eeeb4-facc-4e53-8832-013274dac80f
      version: -1
      name: Set abnormal working hours to aggregated evidences
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This script runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about script permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidences
      value:
        complex:
          root: ${
          accessor: '}'
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs==rhs
              conditionB: {}
              conditionInBetween: {}
              else: {}
              equals: {}
              lhs:
                value:
                  simple: IsOutOfWorkingHours
                iscontext: true
              lhsB: {}
              options: {}
              optionsB: {}
              rhs:
                value:
                  simple: "true"
              rhsB: {}
              then:
                value:
                  simple: User created forwarding rule outside of business hours.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 60,
          "y": 820
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 627d5819-cb1e-4b21-8e88-8b6d82ae21ac
    type: condition
    task:
      id: 627d5819-cb1e-4b21-8e88-8b6d82ae21ac
      version: -1
      name: Checking soft remediation conditions
      type: condition
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#default#':
      - "14"
      "Yes":
      - "43"
      - "20"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidences
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "2"
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: domain
                    ignorecase: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                accessor: Indicator
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1285
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: b09a9327-e34b-4f81-8782-e54ae932ca27
    type: condition
    task:
      id: b09a9327-e34b-4f81-8782-e54ae932ca27
      version: -1
      name: Check if a forwarding address domain exist
      type: condition
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#default#':
      - "6"
      "yes":
      - "3"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: Core.OriginalAlert.raw_abioc.event.forwarding_domain_with_tld
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 240,
          "y": -10
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 73936401-a8d4-4374-8d30-4c9bc55f590e
    type: title
    task:
      id: 73936401-a8d4-4374-8d30-4c9bc55f590e
      version: -1
      name: Evaluate investigation results
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "14"
      - "37"
      - "36"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 990
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: 7a967a10-abda-42b5-8535-2b3502c52c05
    type: condition
    task:
      id: 7a967a10-abda-42b5-8535-2b3502c52c05
      version: -1
      name: Checking medium severity conditions
      type: condition
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#default#':
      - "14"
      "yes":
      - "32"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.severity
            iscontext: true
          right:
            value:
              simple: SEV_030_MEDIUM
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidences
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "2"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 240,
          "y": 1285
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: 6cc4ec9a-a36d-48e5-852b-a5c1bc1b782f
    type: collection
    task:
      id: 6cc4ec9a-a36d-48e5-852b-a5c1bc1b782f
      version: -1
      name: Decide whether to disable the user account
      type: collection
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#none#':
      - "34"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": 1470
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: "The following evidence was found: \n\n${Evidences}\n\nWould you like to disable the account ${Core.OriginalAlert.raw_abioc.event.identity_name}?"
        required: false
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - simple: "Yes"
        - simple: "No"
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Select user account containment steps
      description: The investigation revealed several suspicious indicators suggesting the user who created the forwarding rule may be compromised. The associated forwarding email and filters have been automatically removed. Please decide whether to take any additional recommended actions.
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 008f1f26-4377-498c-8921-ddb3736ef0fa
    type: regular
    task:
      id: 008f1f26-4377-498c-8921-ddb3736ef0fa
      version: -1
      name: Disable user account via MS-Graph
      description: |-
        Disables a user from all Office 365 applications, and prevents sign in. Note: This command disables a user,
        but does not terminate an existing session. Supported only in a self-deployed app flow with the
        Permission: Directory.AccessAsUser.All(Delegated).
      script: '|||msgraph-user-account-disable'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      user:
        simple: ${Core.OriginalAlert.event.identity_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": 1810
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 65ab206a-9e3f-4b64-8efe-0ec2ba0d3e54
    type: condition
    task:
      id: 65ab206a-9e3f-4b64-8efe-0ec2ba0d3e54
      version: -1
      name: Check analyst decision
      type: condition
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#default#':
      - "14"
      "yes":
      - "33"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Select user account containment steps.Answers.0
            iscontext: true
          right:
            value:
              simple: "Yes"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": 1630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: ed34eb8f-329b-49f1-8f12-d0e979055d77
    type: title
    task:
      id: ed34eb8f-329b-49f1-8f12-d0e979055d77
      version: -1
      name: Early Containment Complete
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "14"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -450,
          "y": 2330
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: ec931801-d2f1-4042-84b4-0a7adf76ed05
    type: title
    task:
      id: ec931801-d2f1-4042-84b4-0a7adf76ed05
      version: -1
      name: Hard Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "30"
      - "41"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 190,
          "y": 1140
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: f6057cef-9260-4970-8b1d-88edb25b4059
    type: title
    task:
      id: f6057cef-9260-4970-8b1d-88edb25b4059
      version: -1
      name: Soft Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "25"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1140
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: 3b4840c0-990a-42d1-835b-a3bc6e18f5ad
    type: condition
    task:
      id: 3b4840c0-990a-42d1-835b-a3bc6e18f5ad
      version: -1
      name: Check user notification requirement
      type: condition
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#default#':
      - "14"
      "yes":
      - "39"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.SendNotification
            iscontext: true
          right:
            value:
              simple: "true"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 2120
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 49505509-b341-41dd-83e9-c80018d07814
    type: regular
    task:
      id: 49505509-b341-41dd-83e9-c80018d07814
      version: -1
      name: Send the user a notification via email
      description: Sends an email.
      script: EWSO365|||send-mail
      type: regular
      iscommand: true
      brand: EWSO365
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      body:
        simple: |-
          Hello,
          As part of our ongoing security measures, we detected unusual activity associated with your mailbox. A forwarding address and associated rule were automatically removed from your account to protect your data and ensure the security of our systems.

           If you did not set up these rules, we recommend reviewing your recent activity and updating your account password immediately. If you require assistance or further information, please contact our security team.

          Thank you for your understanding and cooperation.
      subject:
        simple: Forwarding rule was removed from your mailbox
      to:
        simple: ${Core.OriginalAlert.raw_abioc.event.identity_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 2300
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: 0ad3c032-8b63-40e8-8c30-edab2a540918
    type: regular
    task:
      id: 0ad3c032-8b63-40e8-8c30-edab2a540918
      version: -1
      name: Verify if user is an Exchange admin
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This script runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about script permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidences
      value:
        complex:
          root: ${
          accessor: '}'
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs==rhs
              conditionB: {}
              conditionInBetween: {}
              else: {}
              equals: {}
              lhs:
                value:
                  simple: Core.OriginalAlert.event.service_sub_type
                iscontext: true
              lhsB: {}
              options: {}
              optionsB: {}
              rhs:
                value:
                  simple: ExchangeAdmin
              rhsB: {}
              then:
                value:
                  simple: The user has admin privileges.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1250,
          "y": 660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: d4c540d3-adaf-4f1b-869f-32ddd550508f
    type: condition
    task:
      id: d4c540d3-adaf-4f1b-869f-32ddd550508f
      version: -1
      name: Checking hard remediation conditions
      type: condition
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#default#':
      - "14"
      "yes":
      - "32"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidences
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "3"
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                    ignorecase: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: domain
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                accessor: Indicator
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -180,
          "y": 1285
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "42":
    id: "42"
    taskid: 8be5c3a5-d1a7-474f-8f07-a80dee77676f
    type: condition
    task:
      id: 8be5c3a5-d1a7-474f-8f07-a80dee77676f
      version: -1
      name: Check analyst decision
      type: condition
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#default#':
      - "14"
      "yes":
      - "17"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Decide whether to delete the forwarding rule.Answers.0
            iscontext: true
          right:
            value:
              simple: "Yes"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1790
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 96c197e7-77d5-44fe-8cf8-59d67868acb7
    type: condition
    task:
      id: 96c197e7-77d5-44fe-8cf8-59d67868acb7
      version: -1
      name: Check EWS Extension Online Powershell availability
      type: condition
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#default#':
      - "14"
      "yes":
      - "15"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: EWS Extension Online Powershell v3
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
                    ignorecase: true
            iscontext: true
          right:
            value: {}
      - - operator: isNotEmpty
          left:
            value:
              simple: ${Core.OriginalAlert.raw_abioc.event.exchange_rule_name}
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1470
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "25_14_#default#": 0.1,
      "25_20_Yes": 0.81,
      "25_43_Yes": 0.45,
      "28_3_yes": 0.43,
      "28_6_#default#": 0.25,
      "30_14_#default#": 0.15,
      "30_32_yes": 0.43,
      "34_14_#default#": 0.31,
      "34_33_yes": 0.55,
      "38_14_#default#": 0.35,
      "41_14_#default#": 0.16,
      "41_32_yes": 0.4,
      "42_14_#default#": 0.16,
      "42_17_yes": 0.39,
      "43_14_#default#": 0.11,
      "43_15_yes": 0.47,
      "4_5_yes": 0.38,
      "4_6_#default#": 0.19
    },
    "paper": {
      "dimensions": {
        "height": 3005,
        "width": 2080,
        "x": -450,
        "y": -310
      }
    }
  }
inputs:
- key: SendNotification
  value:
    simple: "true"
  required: false
  description: If set to "true," the playbook will send an email notification to the user informing them that the forwarding address was deleted. If "false," no notification will be sent.
  playbookInputQuery:
inputSections:
- inputs:
  - SendNotification
  name: General (Inputs group)
  description: Generic group for inputs.
outputSections:
- outputs: []
  name: General (Outputs group)
  description: Generic group for outputs.
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.10.0
marketplaces:
- marketplacev2
