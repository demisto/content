id: Cortex ASM - Remediation
version: -1
name: Cortex ASM - Remediation
description: This playbook contains all the cloud provider sub playbooks for remediation
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: d1735507-de4e-495b-8480-d5706b9c0bbd
    type: start
    task:
      id: d1735507-de4e-495b-8480-d5706b9c0bbd
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 50
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 1e668467-bde2-483b-8523-b8409d9eaff8
    type: condition
    task:
      id: 1e668467-bde2-483b-8523-b8409d9eaff8
      version: -1
      name: What provider is this service?
      description: Determines which cloud provider the service is in order to direct to the correct enrichment.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "4"
      AWS:
      - "5"
      GCP:
      - "8"
      Azure:
      - "6"
      Unclaimed S3 Bucket:
      - "7"
    separatecontext: false
    conditions:
    - label: AWS
      condition:
      - - operator: containsGeneral
          left:
            value:
              complex:
                root: alert.asmcloud
                accessor: Provider
            iscontext: true
          right:
            value:
              simple: AWS
    - label: GCP
      condition:
      - - operator: containsGeneral
          left:
            value:
              complex:
                root: alert.asmcloud
                accessor: Provider
            iscontext: true
          right:
            value:
              simple: GCP
    - label: Azure
      condition:
      - - operator: containsGeneral
          left:
            value:
              complex:
                root: alert.asmcloud
                accessor: Provider
            iscontext: true
          right:
            value:
              simple: Azure
    - label: Unclaimed S3 Bucket
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: alert
                accessor: asmattacksurfaceruleid
                transformers:
                - operator: StripChars
                  args:
                    chars:
                      value:
                        simple: '[\"]'
            iscontext: true
          right:
            value:
              simple: UnclaimedS3Bucket
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 235
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: ed351bc8-42f2-4168-8623-e0573f6911e5
    type: title
    task:
      id: ed351bc8-42f2-4168-8623-e0573f6911e5
      version: -1
      name: Completed
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 790
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: e51e672f-f1b7-4e55-8700-56d93f683135
    type: playbook
    task:
      id: e51e672f-f1b7-4e55-8700-56d93f683135
      version: -1
      name: AWS - Security Group Remediation
      description: Replace current security groups with limited access security groups.
      playbookName: AWS - Security Group Remediation
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      NicID:
        complex:
          root: alert.asmsystemids
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: alert.asmsystemids.Type
                iscontext: true
              right:
                value:
                  simple: AWS-NIC
          accessor: ID
      RemediationRule:
        complex:
          root: inputs.RemediationRule
      VpcID:
        complex:
          root: alert.asmsystemids
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: alert.asmsystemids.Type
                iscontext: true
              right:
                value:
                  simple: AWS-VPC
          accessor: ID
    separatecontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 220,
          "y": 480
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: f0cba2e4-b4de-450d-806a-3145e1ce4999
    type: playbook
    task:
      id: f0cba2e4-b4de-450d-806a-3145e1ce4999
      version: -1
      name: Azure - Network Security Group Remediation
      description: |-
        This playbook adds new Azure Network Security Groups (NSG) rules to NSGs attached to a NIC. The new rules will give access only to a private IP address range and block traffic that's exposed to the public internet ([using the private IP of the VM as stated in Azure documentation](https://learn.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview)). For example, if RDP is exposed to the public internet, this playbook adds new firewall rules that only allows traffic from private IP address and blocks the rest of the RDP traffic.

        Conditions and limitations:
        - Limited to one resource group.
        - 200 Azure rules viewed at once to find the offending rule.
        - 2 priorities lower than the offending rule priority must be available.
        - Adds rules to NSGs associated to NICs.
      playbookName: Azure - Network Security Group Remediation
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      AzureSecurityGroup:
        complex:
          root: alert.asmsystemids
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: alert.asmsystemids.Type
                iscontext: true
              right:
                value:
                  simple: Azure-NSG
          accessor: ID
      AzureVMPrivateIP:
        complex:
          root: alert.asmprivateip
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: alert.asmprivateip.Source
                iscontext: true
              right:
                value:
                  simple: Azure
          transformers:
          - operator: getField
            args:
              field:
                value:
                  simple: IP
      RemotePort:
        complex:
          root: alert
          accessor: remoteport
      RemoteProtocol:
        complex:
          root: alert
          accessor: protocol
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 1100,
          "y": 450
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: 67959d21-de62-43ad-814b-a2bf61b5a280
    type: playbook
    task:
      id: 67959d21-de62-43ad-814b-a2bf61b5a280
      version: -1
      name: AWS - Unclaimed S3 Bucket Remediation
      description: The playbook will create the unclaimed S3 bucket.
      playbookName: AWS - Unclaimed S3 Bucket Remediation
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      S3BucketName:
        complex:
          root: alert.asmsystemids
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: alert.asmsystemids.Type
                iscontext: true
              right:
                value:
                  simple: S3-BucketName
          accessor: ID
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -200,
          "y": 460
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 14b3802a-fb0d-41b1-830c-03163c2697e7
    type: playbook
    task:
      id: 14b3802a-fb0d-41b1-830c-03163c2697e7
      version: -1
      name: GCP - Firewall Remediation
      description: This playbook adds new firewall rules with access only from  private ip address range and blocks traffic that's exposed to public internet. For example, if RDP is exposed to the entire world, this playbook adds new firewall rules that only allows traffic from private ip address and blocks rest of the RDP traffic.
      playbookName: GCP - Firewall Remediation
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      GcpInstance:
        complex:
          root: alert.asmsystemids
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: alert.asmsystemids.Type
                iscontext: true
              right:
                value:
                  simple: GCP-VMNAME
          accessor: ID
      GcpNetwork:
        complex:
          root: alert.asmsystemids
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: alert.asmsystemids.Type
                iscontext: true
              right:
                value:
                  simple: GCP-VPC
          accessor: ID
      GcpProject:
        complex:
          root: alert.asmcloud
          accessor: Project
          transformers:
          - operator: FirstArrayElement
      GcpZone:
        complex:
          root: alert.asmsystemids
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: alert.asmsystemids.Type
                iscontext: true
              right:
                value:
                  simple: GCP-ZONE
          accessor: ID
      RemotePort:
        complex:
          root: alert
          accessor: remoteport
      RemoteProtocol:
        complex:
          root: alert
          accessor: protocol
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 690,
          "y": 480
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {},
    "paper": {
      "dimensions": {
        "height": 805,
        "width": 1680,
        "x": -200,
        "y": 50
      }
    }
  }
inputs:
- key: RemediationRule
  value:
    simple: Remediation-Security-Group
  required: true
  description: 'The security group that will be used for remediating internet exposures.'
  playbookInputQuery:
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.5.0
contentitemexportablefields:
  contentitemfields: {}
