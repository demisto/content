id: Cortex ASM - Service Ownership
version: -1
contentitemexportablefields:
  contentitemfields: {}
name: Cortex ASM - Service Ownership
description: Identifies and recommends the most likely owners of the service, additionally citing an explanation and ranking score for each.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 57784b86-a171-4ca0-8dbc-35f4041c70d4
    type: start
    task:
      id: 57784b86-a171-4ca0-8dbc-35f4041c70d4
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "9"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 280,
          "y": -170
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: a374f22a-49ab-4417-86de-1bb33e146025
    type: condition
    task:
      id: a374f22a-49ab-4417-86de-1bb33e146025
      version: -1
      name: Is service account defined?
      description: Determine whether a service account was included among the potential service owners.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "6"
      "yes":
      - "4"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: alert.asmserviceowner
                filters:
                - - operator: startWith
                    left:
                      value:
                        simple: alert.asmserviceowner.Source
                      iscontext: true
                    right:
                      value:
                        simple: Service account on instance
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 400,
          "y": 630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: 2012bbb6-f57f-40a9-8eff-9c07a604d70a
    type: regular
    task:
      id: 2012bbb6-f57f-40a9-8eff-9c07a604d70a
      version: -1
      name: Lookup project owner
      description: Retrieves the IAM access control policy for the specified project.
      script: GCP-IAM|||gcp-iam-project-iam-policy-get
      type: regular
      iscommand: true
      brand: GCP-IAM
    nexttasks:
      '#none#':
      - "8"
    scriptarguments:
      project_name:
        complex:
          root: alert.asmserviceowner
          filters:
          - - operator: startWith
              left:
                value:
                  simple: alert.asmserviceowner.Source
                iscontext: true
              right:
                value:
                  simple: Service account on instance
          transformers:
          - operator: getField
            args:
              field:
                value:
                  simple: Email
          - operator: RegexExtractAll
            args:
              error_if_no_match: {}
              ignore_case: {}
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: (?<=@)[^\.]+(?=\.iam\.gserviceaccount\.com)
              unpack_matches: {}
          - operator: concat
            args:
              prefix:
                value:
                  simple: projects/
              suffix: {}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": 870
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 922b8cd3-2e61-4bdc-88a2-35d141bc99bf
    type: regular
    task:
      id: 922b8cd3-2e61-4bdc-88a2-35d141bc99bf
      version: -1
      name: Add project owner to service owner grid field
      description: |-
        Automation used to more easily populate a grid field.  This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well.  Example of command:
        `!GridFieldSetup keys=ip,src val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2="AWS" gridfiled="gridfield"`
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    scriptarguments:
      gridfield:
        simple: asmserviceowner
      keys:
        simple: Name,Email,Source,Timestamp
      val1:
        simple: n/a
      val2:
        complex:
          root: GCPIAM.Policy.bindings
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: GCPIAM.Policy.bindings.role
                iscontext: true
              right:
                value:
                  simple: roles/owner
          accessor: members
          transformers:
          - operator: replace
            args:
              limit: {}
              replaceWith: {}
              toReplace:
                value:
                  simple: 'user:'
      val3:
        simple: Owner of GCP project where service account is defined
      val4:
        complex:
          root: TimeNowUnix
          transformers:
          - operator: TimeStampToDate
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": 1210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: b599f435-c52e-4011-87e8-53c33eb46998
    type: regular
    task:
      id: b599f435-c52e-4011-87e8-53c33eb46998
      version: -1
      name: Normalize and rank likely service owners
      description: Recommend most likely service owners from those surfaced by Cortex ASM Enrichment.
      scriptName: RankServiceOwners
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      owners:
        simple: ${alert.asmserviceowner}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 740,
          "y": 1380
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: d54d5bb2-8548-4919-887e-06e80951d23e
    type: regular
    task:
      id: d54d5bb2-8548-4919-887e-06e80951d23e
      version: -1
      name: Back up service owners gridfield
      description: |-
        Automation used to more easily populate a grid field.  This is necessary when you want to assign certain values as static or if you have context paths that you will assign to different values as well.  Example of command:
        `!GridFieldSetup keys=ip,src val1=${AWS.EC2.Instances.NetworkInterfaces.PrivateIpAddress} val2="AWS" gridfiled="gridfield"`
      scriptName: GridFieldSetup
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "12"
    scriptarguments:
      gridfield:
        simple: asmserviceownerunrankedraw
      keys:
        simple: name,email,source,timestamp
      val1:
        complex:
          root: alert
          accessor: asmserviceowner
          transformers:
          - operator: getField
            args:
              field:
                value:
                  simple: Name
      val2:
        complex:
          root: alert
          accessor: asmserviceowner
          transformers:
          - operator: getField
            args:
              field:
                value:
                  simple: Email
      val3:
        complex:
          root: alert
          accessor: asmserviceowner
          transformers:
          - operator: getField
            args:
              field:
                value:
                  simple: Source
      val4:
        complex:
          root: alert
          accessor: asmserviceowner
          transformers:
          - operator: getField
            args:
              field:
                value:
                  simple: Timestamp
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 460,
          "y": 210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: cac1ca6c-b210-436c-8bd0-7e5424ece378
    type: regular
    task:
      id: cac1ca6c-b210-436c-8bd0-7e5424ece378
      version: -1
      name: Get current time
      description: |
        Retrieves the current date and time.
      scriptName: GetTime
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": 1040
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: ac078da7-4471-46bd-8a34-05287cb76a50
    type: condition
    task:
      id: ac078da7-4471-46bd-8a34-05287cb76a50
      version: -1
      name: Is asmserviceowner populated?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "10"
      "yes":
      - "7"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: alert
                accessor: asmserviceowner
            iscontext: true
          right:
            value: {}
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: alert.asmserviceowner
                accessor: Email
            iscontext: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: alert.asmserviceowner
                accessor: Name
            iscontext: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: alert.asmserviceowner
                accessor: Source
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 280,
          "y": 0
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: 7bed726c-405d-4725-8bdf-568e6e478b9c
    type: title
    task:
      id: 7bed726c-405d-4725-8bdf-568e6e478b9c
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 180,
          "y": 1600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 7d42f01f-4398-417d-8fff-a2c0ba57b0ca
    type: condition
    task:
      id: 7d42f01f-4398-417d-8fff-a2c0ba57b0ca
      version: -1
      name: Is GCP - IAM enabled?
      description: Determines if the GCP-IAM integration instance is configured.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "6"
      "yes":
      - "2"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: GCP-IAM
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 460,
          "y": 380
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "12_6_#default#": 0.23,
      "2_6_#default#": 0.28,
      "9_10_#default#": 0.34
    },
    "paper": {
      "dimensions": {
        "height": 1835,
        "width": 940,
        "x": 180,
        "y": -170
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.8.0
