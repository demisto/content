id: silent-Execution of an uncommon process at an early startup stage by Windows system binary
version: -1
contentitemexportablefields:
  contentitemfields: {}
name: silent-Execution of an uncommon process at an early startup stage by Windows system binary
issilent: true
description: |-
  This playbook is designed to handle the following alerts:
  - Execution of an uncommon process with a local/domain user SID at an early startup stage with a suspicious characteristics by Windows system binary.
  - Execution of an uncommon process at an early startup stage by Windows system binary with suspicious characteristics.

  Playbook Stages:

  Analysis:

  - Checks the process's reputation.
  - Searches for related alerts.

  Investigation:
  The investigation follows different flows depending on the persistence techniques and involved processes:
  - winlogon
  - LogonUI
  - WMI
  - Scheduled tasks
  - Registry keys
  - spoolsv
  - RunOnce
  - Startup Folder
  - Malicious IIS extensions or modules via w3wp.exe


  Verdict:

  Based on the investigation findings, the playbook will either perform remediation actions or close the alert as a false positive.


  Remediation:

  The playbook performs actions to stop the attack and remove persistence mechanisms by:
  - Terminating the malicious process.
  - Quarantining the malicious process. (Requires analyst approval)
  - Adding the malicious process hash to the block list. (Requires analyst approval)
  - Searching for and deleting malicious scheduled tasks to remove persistence. (Requires analyst approval)
  - Recommending the deleting of specific registry keys to remove persistence.
  - Automatically closing the alert.
tags:
- TA0003 - Persistence
- T1547 - Boot or Logon Autostart Execution
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: e0e013d6-8efb-4bd8-83cc-92aefa45fee7
    type: start
    task:
      id: e0e013d6-8efb-4bd8-83cc-92aefa45fee7
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "124"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 431,
          "y": -932
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 9edb3a2a-3a43-4311-8919-34cd2e3f7495
    type: title
    task:
      id: 9edb3a2a-3a43-4311-8919-34cd2e3f7495
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "45"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 431,
          "y": -64
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 033a3572-80ae-4975-9d59-b474407fce47
    type: condition
    task:
      id: 033a3572-80ae-4975-9d59-b474407fce47
      version: -1
      name: Checks if the processes have a bad reputation
      description: |
        Determines the appropriate verdict based on the process reputation.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "229"
      "yes":
      - "230"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: alert.targetprocesssha256
                      iscontext: true
                    ignorecase: true
                  - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: alert.initiatorsha256
                      iscontext: true
                    ignorecase: true
                accessor: Score
            iscontext: true
          right:
            value: {}
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: alert.initiatorsha256
                      iscontext: true
                    ignorecase: true
                  - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: alert.targetprocesssha256
                      iscontext: true
                    ignorecase: true
                accessor: Score
            iscontext: true
          right:
            value:
              simple: "2"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": -412
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 89c2159c-db2f-4479-bdb3-8c83f0d01ba8
    type: title
    task:
      id: 89c2159c-db2f-4479-bdb3-8c83f0d01ba8
      version: -1
      name: Verdict
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "189"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 4511
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 82681c85-7fbd-4ec0-bd21-04aebe5790c1
    type: regular
    task:
      id: 82681c85-7fbd-4ec0-bd21-04aebe5790c1
      version: -1
      name: Get case issues
      description: |
        This task searches for Cortex XSIAM related alerts to the current Incident.
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      query:
        complex:
          root: alert
          accessor: parentXDRIncident
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '-'
              fields:
                value:
                  simple: "2"
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'caseid:'
              suffix: {}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 641,
          "y": -555
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 9f2974d1-da98-492b-a8f8-e6d4bf437d02
    type: regular
    task:
      id: 9f2974d1-da98-492b-a8f8-e6d4bf437d02
      version: -1
      name: Close Alert - True Positive
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "19"
    scriptarguments:
      closeNotes:
        simple: Resolved as True Positive - Handled by the playbook "Execution of an uncommon process at an early startup stage by Windows system binary"
      closeReason:
        simple: Resolved - True Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 7835
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: a84a0ad4-6959-4bf0-82cc-4862e8bebe59
    type: title
    task:
      id: a84a0ad4-6959-4bf0-82cc-4862e8bebe59
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 7964
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: 009aca81-4fa9-43cf-8e81-79247734b7ae
    type: regular
    task:
      id: 009aca81-4fa9-43cf-8e81-79247734b7ae
      version: -1
      name: Run script to locate and disable the malicious scheduled task.
      description: |
        The script locates and disables the malicious scheduled task.
      script: '|||core-run-script-execute-commands'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "37"
      '#none#':
      - "40"
    scriptarguments:
      commands:
        simple: powershell -Command "$ActionPath = '${Core.OriginalAlert.event.action_process_image_path}'; $tasks = Get-ScheduledTask | Where-Object { $_.Actions | Where-Object { $_.Execute -eq $ActionPath } }; if ($tasks -or $tasks.Count -gt 0) { $tasks | ForEach-Object { Disable-ScheduledTask -TaskPath $_.TaskPath -TaskName $_.TaskName; Write-Host 'The task ' + $_.TaskName + ' has been disabled successfully.' } } else { Write-Host 'No tasks found running the action at ' + $ActionPath }"
      endpoint_ids:
        simple: ${alert.agentid}
      timeout:
        simple: "120"
      timeout_in_seconds:
        simple: "120"
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -25,
          "y": 7223
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 18fbe77a-29e8-4289-9f71-331a65fd5d9f
    type: regular
    task:
      id: 18fbe77a-29e8-4289-9f71-331a65fd5d9f
      version: -1
      name: Terminate Causality - Action Process
      description: Terminate a process tree by its causality ID.
      script: '|||core-terminate-causality'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "252"
    scriptarguments:
      agent_id:
        simple: ${alert.agentid}
      causality_id:
        simple: ${alert.actionprocessinstanceid}
      timeout_in_seconds:
        simple: "180"
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 5410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: b5a363d6-70db-46e1-a6d3-a13e1c3a9eae
    type: regular
    task:
      id: b5a363d6-70db-46e1-a6d3-a13e1c3a9eae
      version: -1
      name: Disable the malicious scheduled task manually
      description: |-
        Dear Analyst,

        The playbook did not successfully disable the scheduled task responsible for executing the suspicious process.

        Please manually identify and disable the scheduled task with the following execution path: ${Core.OriginalAlert.event.action_process_image_path}
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -295,
          "y": 7692
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 68f18eca-3645-4163-945d-9655060c8373
    type: regular
    task:
      id: 68f18eca-3645-4163-945d-9655060c8373
      version: -1
      name: Check the processes reputation
      description: Checks the file reputation of the specified hash.
      script: '|||file'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      file:
        complex:
          root: alert
          accessor: targetprocesssha256
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: alert.initiatorsha256
                iscontext: true
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 213,
          "y": -555
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: e02bff45-08c8-499c-875c-dc93cd3bff00
    type: regular
    task:
      id: e02bff45-08c8-499c-875c-dc93cd3bff00
      version: -1
      name: Get script execution results
      description: Retrieve the results of a script execution action.
      script: '|||core-get-script-execution-results'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "41"
    scriptarguments:
      action_id:
        simple: ${Core.ScriptRun.action_id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -25,
          "y": 7362
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: e4b01d5d-6c1c-4921-8f36-1f6233df5cc7
    type: condition
    task:
      id: e4b01d5d-6c1c-4921-8f36-1f6233df5cc7
      version: -1
      name: Has the script disabled the task successfully?
      description: Verify if the script successfully disabled the task.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "37"
      "yes":
      - "13"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: AnyMatch
          left:
            value:
              simple: Core.ScriptResult.results.standard_output
            iscontext: true
          right:
            value:
              simple: '--------'
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -25,
          "y": 7522
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 73b00c20-bcb5-422c-86ac-f99a37839186
    type: title
    task:
      id: 73b00c20-bcb5-422c-86ac-f99a37839186
      version: -1
      name: Analysis
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "39"
      - "6"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 431,
          "y": -676
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: 9bb6615e-3773-444f-9e64-71c65f666ccd
    type: condition
    task:
      id: 9bb6615e-3773-444f-9e64-71c65f666ccd
      version: -1
      name: Is the process related to persistence technique?
      description: Determines the investigation flow based on the causality process and the identified persistence technique.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "69"
      LogonUI.exe:
      - "51"
      WmiPrvSE.exe:
      - "48"
      explorer.exe:
      - "65"
      runonce.exe:
      - "126"
      spoolsv.exe:
      - "140"
      svchost.exe - Schedule Task:
      - "56"
      taskeng.exe - Schedule Task:
      - "55"
      w3wp.exe:
      - "58"
      winlogon.exe:
      - "53"
    separatecontext: false
    conditions:
    - label: WmiPrvSE.exe
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: WmiPrvSE.exe
          ignorecase: true
    - label: svchost.exe - Schedule Task
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: svchost.exe
          ignorecase: true
      - - operator: endWith
          left:
            value:
              simple: alert.osparentcmd
            iscontext: true
          right:
            value:
              simple: -p -s Schedule
          ignorecase: true
    - label: taskeng.exe - Schedule Task
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: taskeng.exe
          ignorecase: true
    - label: LogonUI.exe
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: LogonUI.exe
          ignorecase: true
    - label: runonce.exe
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: runonce.exe
          ignorecase: true
    - label: w3wp.exe
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: w3wp.exe
          ignorecase: true
    - label: winlogon.exe
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: winlogon.exe
          ignorecase: true
    - label: explorer.exe
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: explorer.exe
          ignorecase: true
    - label: spoolsv.exe
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.cgoname
            iscontext: true
          right:
            value:
              simple: spoolsv.exe
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 67
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: 86d98bb7-9853-437e-841c-0417b58df264
    type: title
    task:
      id: 86d98bb7-9853-437e-841c-0417b58df264
      version: -1
      name: WmiPrvSE.exe
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "49"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2372,
          "y": 271
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "49":
    id: "49"
    taskid: e6bc73d7-c17f-4752-8473-edd3e0258c47
    type: regular
    task:
      id: e6bc73d7-c17f-4752-8473-edd3e0258c47
      version: -1
      name: Search for related alerts
      description: This task searches for related alerts indicating unusual MOF compiler usage, which—when combined with the WMI causality process and this alert—may indicate that an attacker is leveraging WMI for stealthy execution and persistence. MOF files can be used to create malicious WMI event subscriptions that trigger execution automatically.
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "50"
    scriptarguments:
      fromdate:
        simple: 5 hours ago
      includeinformational:
        simple: "true"
      query:
        simple: name:"Uncommon Managed Object Format (MOF) compiler usage" and agentid:${alert.agentid}
      todate:
        simple: now
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2372,
          "y": 383
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "50":
    id: "50"
    taskid: 1559e04d-dc56-47cd-85ab-b84750e2633f
    type: condition
    task:
      id: 1559e04d-dc56-47cd-85ab-b84750e2633f
      version: -1
      name: found any indication it is a true positive?
      description: |-
        This task checks the following to determine whether it is a malicious activity and if remediation action is needed:
        - Checks if the action process run by WMI is unsigned, which is an uncommon behavior and may indicate persistence mechanisms used by attackers.
        - Checks for the Cortex XSIAM-related alert "Uncommon Managed Object Format (MOF) compiler usage," which indicates an attacker is leveraging WMI for stealthy execution and persistence. MOF files can be used to create malicious WMI event subscriptions that trigger execution automatically.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "160"
      "yes":
      - "161"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Uncommon Managed Object Format (MOF) compiler usage
          ignorecase: true
        - operator: isNotEqualString
          left:
            value:
              simple: alert.processexecutionsignature
            iscontext: true
          right:
            value:
              simple: SIGNATURE_SIGNED
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2372,
          "y": 524
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "51":
    id: "51"
    taskid: 7b4010d3-8536-4ebc-81ed-53d13319d00a
    type: title
    task:
      id: 7b4010d3-8536-4ebc-81ed-53d13319d00a
      version: -1
      name: LogonUI.exe
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "52"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2910,
          "y": 271
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: 66c74649-5d73-461c-8d77-0100e1c60243
    type: condition
    task:
      id: 66c74649-5d73-461c-8d77-0100e1c60243
      version: -1
      name: found any indication it is a true positive?
      description: This task checks whether the action process run by logonui.exe is unsigned, which is an uncommon behavior and may indicate persistence mechanisms used by attackers.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "159"
      "yes":
      - "156"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEqualString
          left:
            value:
              simple: alert.processexecutionsignature
            iscontext: true
          right:
            value:
              simple: SIGNATURE_SIGNED
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2910,
          "y": 383
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "53":
    id: "53"
    taskid: 3e4fa592-cf5a-478b-8ca4-602c1c79d4a9
    type: title
    task:
      id: 3e4fa592-cf5a-478b-8ca4-602c1c79d4a9
      version: -1
      name: winlogon.exe
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "54"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 3372,
          "y": 271
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "54":
    id: "54"
    taskid: 39c523a6-c4be-4074-a100-e6072e982d95
    type: condition
    task:
      id: 39c523a6-c4be-4074-a100-e6072e982d95
      version: -1
      name: found any indication it is a true positive?
      description: This task checks whether the action process run by winlogon.exe is unsigned and located in a suspicious location, potentially indicating persistence mechanisms used by attackers.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "158"
      "yes":
      - "155"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEqualString
          left:
            value:
              simple: alert.processexecutionsignature
            iscontext: true
          right:
            value:
              simple: SIGNATURE_SIGNED
          ignorecase: true
      - - operator: containsGeneral
          left:
            value:
              simple: Core.OriginalAlert.event.action_process_image_path
            iscontext: true
          right:
            value:
              simple: \Temp\
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: Core.OriginalAlert.event.action_process_image_path
            iscontext: true
          right:
            value:
              simple: \Downloads\
      - - operator: endWith
          left:
            value:
              simple: alert.targetprocessname
            iscontext: true
          right:
            value:
              simple: .scr
          ignorecase: true
        - operator: endWith
          left:
            value:
              simple: alert.targetprocessname
            iscontext: true
          right:
            value:
              simple: .bin
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 3372,
          "y": 387
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "55":
    id: "55"
    taskid: aaa2890f-f538-4d5e-8442-316cf6cc8cce
    type: title
    task:
      id: aaa2890f-f538-4d5e-8442-316cf6cc8cce
      version: -1
      name: taskeng.exe - Schedule Task
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "170"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1880,
          "y": 271
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "56":
    id: "56"
    taskid: 3421877e-dc1f-4eca-89cb-ac0d79248808
    type: title
    task:
      id: 3421877e-dc1f-4eca-89cb-ac0d79248808
      version: -1
      name: svchost.exe - Schedule Task
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "170"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1420,
          "y": 271
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "58":
    id: "58"
    taskid: 8d215f4f-8a62-45bc-8a2b-0cd0534a4bbd
    type: title
    task:
      id: 8d215f4f-8a62-45bc-8a2b-0cd0534a4bbd
      version: -1
      name: w3wp.exe
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "64"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5067,
          "y": 271
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "64":
    id: "64"
    taskid: 8f280e8c-8d34-4f56-ba78-3de249ce6027
    type: regular
    task:
      id: 8f280e8c-8d34-4f56-ba78-3de249ce6027
      version: -1
      name: Search for related alerts
      description: |-
        This task searches for the following specific related alerts on the endpoint:
        - Anti Webshell Protection
        - Possible web shell command execution
        - Executable or Script file written by a web server process

        The findings may indicate whether this alert is part of an attack pattern.
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "81"
    scriptarguments:
      fromdate:
        simple: 5 hours ago
      includeinformational:
        simple: "true"
      query:
        simple: (name:"*Anti Webshell Protection*" or name:"Possible web shell command execution" or name:"Executable or Script file written by a web server process") and agentid:${alert.agentid}
      todate:
        simple: now
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5067,
          "y": 410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "65":
    id: "65"
    taskid: 36873ed1-9fc5-44b8-bfcd-f0fc4b1e3937
    type: title
    task:
      id: 36873ed1-9fc5-44b8-bfcd-f0fc4b1e3937
      version: -1
      name: explorer.exe - startup folder
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "267"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -3391,
          "y": 269
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "68":
    id: "68"
    taskid: 40a3cbc5-67c1-4b94-8773-b4b048a863a2
    type: regular
    task:
      id: 40a3cbc5-67c1-4b94-8773-b4b048a863a2
      version: -1
      name: Add dll hash to Block list
      description: Block lists requested files which have not already been block listed or added to allow lists.
      script: '|||core-blocklist-files'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      comment:
        simple: The hash was added to the block list by the playbook "Execution of an uncommon process at an early startup stage by Windows system binary"
      hash_list:
        complex:
          root: MaliciousIISExtension
          transformers:
          - operator: uniq
      incident_id:
        complex:
          root: alert
          accessor: parentXDRIncident
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '-'
              fields:
                value:
                  simple: "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 7339
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "69":
    id: "69"
    taskid: b6cd4a3d-0588-4b87-9113-ce6c9aa60de3
    type: title
    task:
      id: b6cd4a3d-0588-4b87-9113-ce6c9aa60de3
      version: -1
      name: Registry - Persistence mechanism
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "256"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 271
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "71":
    id: "71"
    taskid: 6cb80b86-133c-49f4-af0d-084b6ac69a4d
    type: regular
    task:
      id: 6cb80b86-133c-49f4-af0d-084b6ac69a4d
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "220"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: Remediation - Registry
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 671,
          "y": 1491
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "72":
    id: "72"
    taskid: c5ac83e9-aae7-4951-a7f4-cc99cf405b9f
    type: regular
    task:
      id: c5ac83e9-aae7-4951-a7f4-cc99cf405b9f
      version: -1
      name: XQL Query - Search file creation event related to the suspicious action process
      description: Execute an XQL query to retrieve information about the process that created the action process file in the startup folder paths.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "266"
      '#none#':
      - "74"
    scriptarguments:
      query:
        simple: dataset  = xdr_data | filter agent_id  = "${alert.agentid}" and event_type = ENUM.FILE and event_sub_type = ENUM.FILE_WRITE and action_file_sha256 = "${alert.targetprocesssha256.[0]}" and (action_file_path contains "AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup" or action_file_path contains "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup")| fields causality_actor_process_image_name , causality_actor_process_image_sha256 ,actor_process_image_name , actor_process_image_sha256 , causality_actor_process_signature_status , actor_process_signature_status
      query_name:
        simple: Search_Startup_Folder_Persistence
      time_frame:
        simple: between ${ExplorerQueryStartTime} and ${ExplorerQueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -3390,
          "y": 912
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "74":
    id: "74"
    taskid: e3e3be2d-f18f-409c-b29b-a5469bbeec4b
    type: condition
    task:
      id: e3e3be2d-f18f-409c-b29b-a5469bbeec4b
      version: -1
      name: Found process that wrote action process to startup folder?
      description: Checks if the process that wrote the action process to the startup folder was found.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "169"
      "yes":
      - "78"
      - "80"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: PaloAltoNetworksXQL.GenericQuery.results.actor_process_image_sha256
            iscontext: true
          right:
            value: {}
      - - operator: isNotEmpty
          left:
            value:
              simple: PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_sha256
            iscontext: true
      - - operator: isEqualString
          left:
            value:
              simple: "PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_signature_status \n"
            iscontext: true
          right:
            value:
              simple: UNSIGNED
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: "PaloAltoNetworksXQL.GenericQuery.results.actor_process_signature_status \n"
            iscontext: true
          right:
            value:
              simple: UNSIGNED
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -3390,
          "y": 1051
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "75":
    id: "75"
    taskid: ccb4aa8c-8e90-463d-96a3-74fb0465482c
    type: regular
    task:
      id: ccb4aa8c-8e90-463d-96a3-74fb0465482c
      version: -1
      name: Set query start time
      description: Set the XQL query start time.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "76"
    scriptarguments:
      key:
        simple: ExplorerQueryStartTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 7 days ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -3391,
          "y": 657
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "76":
    id: "76"
    taskid: f00df10f-8acf-4aeb-a8e2-3755fb373513
    type: regular
    task:
      id: f00df10f-8acf-4aeb-a8e2-3755fb373513
      version: -1
      name: Set query end time
      description: Set the XQL query end time.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "72"
    scriptarguments:
      key:
        simple: ExplorerQueryEndTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: now
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -3390,
          "y": 781
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "77":
    id: "77"
    taskid: ee792772-ebde-49f9-8bf5-4e766680e43d
    type: regular
    task:
      id: ee792772-ebde-49f9-8bf5-4e766680e43d
      version: -1
      name: XQL Query - Search dll loading events
      description: Execute an XQL query to retrieve results of suspicious unsigned DLLs loaded by the specific w3wp.exe process involved in this alert.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "271"
      '#none#':
      - "89"
    scriptarguments:
      query:
        simple: dataset  = xdr_data | filter agent_id ="${alert.agentid}" and event_type = ENUM.LOAD_IMAGE  and event_sub_type = ENUM.LOAD_IMAGE_MODULE and causality_actor_process_image_name = "w3wp.exe" and causality_actor_process_instance_id = "${alert.cid.[0]}" and action_module_signature_status != ENUM.SIGNED | alter action_module_dllname = regextract(action_module_path, "^\\\/]+(?:\.\w+)?$") |fields action_module_dllname ,action_module_sha256, action_module_file_info, action_module_signature_status, action_module_path, agent_id | dedup action_module_sha256
      query_name:
        simple: Search_DLL_Loading_By_w3wp
      time_frame:
        simple: between ${w3wpQueryStartTime} and ${w3wpQueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -5838,
          "y": 1313
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "78":
    id: "78"
    taskid: 5b9e4926-abc8-450e-89f3-b22dd5638eaa
    type: regular
    task:
      id: 5b9e4926-abc8-450e-89f3-b22dd5638eaa
      version: -1
      name: Get reputation on the process who create the suspicious process
      description: Checks the file reputation of the specified hash.
      script: '|||file'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "79"
    scriptarguments:
      file:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery.results
          accessor: causality_actor_process_image_sha256
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.results.actor_process_image_sha256
                iscontext: true
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -4049,
          "y": 1208
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "79":
    id: "79"
    taskid: 066d596c-c8f7-4893-875a-18debe9dbf84
    type: condition
    task:
      id: 066d596c-c8f7-4893-875a-18debe9dbf84
      version: -1
      name: Check if the process has a malicious reputation
      description: |
        Determines the appropriate verdict based on the process reputation.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "169"
      "yes":
      - "168"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_sha256
                      iscontext: true
                    ignorecase: true
                  - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.actor_process_image_sha256
                      iscontext: true
                accessor: Score
            iscontext: true
          right:
            value: {}
        - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_sha256
                      iscontext: true
                  - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.actor_process_image_sha256
                      iscontext: true
                accessor: Score
            iscontext: true
          right:
            value:
              simple: "2"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -4049,
          "y": 1336
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "80":
    id: "80"
    taskid: 2d3bb1a1-2624-41da-a2bb-15100e26e285
    type: regular
    task:
      id: 2d3bb1a1-2624-41da-a2bb-15100e26e285
      version: -1
      name: Search related alerts for process that created file in startup folder
      description: Searches for alerts related to the process that wrote the action process to the startup folder.
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "173"
    scriptarguments:
      fromdate:
        simple: 7 days ago
      query:
        simple: agentid:${alert.agentid} and (causality_actor_process_sha256:${PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_sha256} or os_actor_process_image_sha256:${PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_sha256} or  actor_process_image_sha256:${PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_sha256} or action_process_image_sha256:${PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_sha256})
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -3617,
          "y": 1208
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "81":
    id: "81"
    taskid: 8d834e53-ab75-4c35-8c9e-f3882612093f
    type: condition
    task:
      id: 8d834e53-ab75-4c35-8c9e-f3882612093f
      version: -1
      name: found any indication it is a true positive?
      description: |-
        Determines the appropriate verdict based on the following conditions:

        - If related alerts indicating malicious activity (such as a web shell) was found, or if w3wp.exe spawned cmd.exe or wscript.exe, the playbook continues to remediation.
        - If w3wp.exe spawned powershell.exe, the playbook continues to analyze the PowerShell command line.
        - Otherwise, the playbook continues investigation to search for persistence via malicious IIS extensions or modules.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "269"
      powershell:
      - "119"
      "yes":
      - "174"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Anti Webshell Protection
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Possible web shell command execution
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Executable or Script file written by a web server process
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.osparentname
            iscontext: true
          right:
            value:
              simple: cmd.exe
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.osparentname
            iscontext: true
          right:
            value:
              simple: wscript.exe
          ignorecase: true
    - label: powershell
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.osparentname
            iscontext: true
          right:
            value:
              simple: powershell.exe
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.osparentname
            iscontext: true
          right:
            value:
              simple: pwsh.exe
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5067,
          "y": 524
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "82":
    id: "82"
    taskid: 09963d91-4df2-4ca7-b077-04bdbc23b6f7
    type: regular
    task:
      id: 09963d91-4df2-4ca7-b077-04bdbc23b6f7
      version: -1
      name: Retrive IIS applicationHost config file
      description: Retrive IIS applicationHost config file.
      script: '|||core-retrieve-files'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "83"
    scriptarguments:
      endpoint_ids:
        simple: ${alert.agentid}
      windows_file_paths:
        simple: C:\Windows\System32\inetsrv\config\applicationHost.config
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 1862
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "83":
    id: "83"
    taskid: 303a2cc1-6fb5-4786-8c02-5a18ddc3c075
    type: regular
    task:
      id: 303a2cc1-6fb5-4786-8c02-5a18ddc3c075
      version: -1
      name: Retrieve file details
      description: View the file retrieved by the core-retrieve-files command according to the action ID.
      script: '|||core-retrieve-file-details'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "84"
    scriptarguments:
      action_id:
        simple: ${Core.RetrievedFiles.action_id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 1975
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "84":
    id: "84"
    taskid: d417fefc-3a24-418e-8ea0-0bcddb50be88
    type: regular
    task:
      id: d417fefc-3a24-418e-8ea0-0bcddb50be88
      version: -1
      name: Unzip IIS application host config file
      description: Unzip a file using fileName or entryID to specify a file. Unzipped files will be loaded to the War Room and names will be put into the context.
      scriptName: UnzipFile
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "176"
    scriptarguments:
      entryID:
        complex:
          root: File
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: File.Info
                iscontext: true
              right:
                value:
                  simple: zip
              ignorecase: true
          accessor: EntryID
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 2097
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "85":
    id: "85"
    taskid: e3658559-375c-48e6-a758-22c59fb2d44f
    type: regular
    task:
      id: e3658559-375c-48e6-a758-22c59fb2d44f
      version: -1
      name: Load Application Host config file to context
      description: Converts XML file entry to JSON format
      scriptName: ConvertXmlFileToJson
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "198"
    scriptarguments:
      contextKey:
        simple: ApplicationHostConfig
      entryID:
        complex:
          root: File
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: File.Name
                iscontext: true
              right:
                value:
                  simple: applicationHost.config
              ignorecase: true
          accessor: EntryID
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 2387
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "89":
    id: "89"
    taskid: 2705d19d-7855-4bea-9c4b-827d8b09c7f3
    type: condition
    task:
      id: 2705d19d-7855-4bea-9c4b-827d8b09c7f3
      version: -1
      name: Found events of dll loading by w3wp.exe?
      description: checks if found events of dll loading by w3wp.exe.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "175"
      "yes":
      - "90"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: PaloAltoNetworksXQL.GenericQuery.results.action_module_sha256
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5838,
          "y": 1451
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "90":
    id: "90"
    taskid: 9cf9a74a-7d93-4f87-9467-f53179ecc2bd
    type: regular
    task:
      id: 9cf9a74a-7d93-4f87-9467-f53179ecc2bd
      version: -1
      name: Get reputation on the process who create the suspicious process
      description: Checks the file reputation of the specified hash.
      script: '|||file'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "92"
    scriptarguments:
      file:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery.results
          accessor: action_module_sha256
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5838,
          "y": 1601
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "92":
    id: "92"
    taskid: 59f21c10-1093-4e18-be4e-ddae0f48999e
    type: condition
    task:
      id: 59f21c10-1093-4e18-be4e-ddae0f48999e
      version: -1
      name: Check if the dll has a bad reputation?
      description: |
        Determines the appropriate verdict based on the process reputation.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "82"
      "yes":
      - "182"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.action_module_sha256
                      iscontext: true
                    ignorecase: true
                accessor: Score
            iscontext: true
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.action_module_sha256
                      iscontext: true
                accessor: Score
            iscontext: true
          right:
            value:
              simple: "2"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5838,
          "y": 1726
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "99":
    id: "99"
    taskid: d170502f-f057-4019-a860-6b2f141458a8
    type: condition
    task:
      id: d170502f-f057-4019-a860-6b2f141458a8
      version: -1
      name: Found related alerts indicating a malicious activity?
      description: Checks whether any related alerts were found that indicate the suspicious creation of a scheduled task on this endpoint.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "172"
      "yes":
      - "171"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Scheduled Task hidden by registry modification
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Uncommon shell command execution setting a scheduled task
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Uncommon local scheduled task creation via schtasks.exe
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Uncommon remote scheduled task created
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Uncommon local scheduled task created
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Uncommon PowerShell commands used to create or alter scheduled task parameters
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1649,
          "y": 542
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "100":
    id: "100"
    taskid: c7b06610-7e4a-4ad1-805c-d3db8ea5bad7
    type: title
    task:
      id: c7b06610-7e4a-4ad1-805c-d3db8ea5bad7
      version: -1
      name: Terminate process
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "29"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 5299
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "102":
    id: "102"
    taskid: 37de18e9-a159-460a-9eec-ea487688f3f0
    type: title
    task:
      id: 37de18e9-a159-460a-9eec-ea487688f3f0
      version: -1
      name: Additional response action
      description: Groups all tasks for a specific incident according to the task headers (titles).
      type: title
      iscommand: false
      brand: Builtin
    nexttasks:
      '#none#':
      - "110"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 6773
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "103":
    id: "103"
    taskid: e94d03fc-451d-44f7-8e4b-10bb2f61f2ef
    type: title
    task:
      id: e94d03fc-451d-44f7-8e4b-10bb2f61f2ef
      version: -1
      name: Quarantine Files
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "104"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -25,
          "y": 6495
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "104":
    id: "104"
    taskid: 97b348b8-de08-4e99-b926-c5ac8c9d2f0d
    type: playbook
    task:
      id: 97b348b8-de08-4e99-b926-c5ac8c9d2f0d
      version: -1
      name: Quarantine File
      description: |-
        ## Containment Plan - Quarantine File

        This playbook is a sub-playbook within the containment plan playbook.
        The playbook quarantines files using core commands.
      playbookName: Containment Plan - Quarantine File
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "102"
    scriptarguments:
      AutoContainment:
        simple: "True"
      EndpointID:
        simple: ${alert.agentid}
      FileContainment:
        simple: "True"
      FileHash:
        complex:
          root: MaliciousActionProcess
          accessor: actionSha256
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: MaliciousActorProcess.actorSha256
                iscontext: true
          - operator: RemoveEmpty
            args:
              empty_values: {}
              remove_keys: {}
          - operator: uniq
      FilePath:
        complex:
          root: MaliciousActionProcess
          accessor: actionPath
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: MaliciousActorProcess.actorPath
                iscontext: true
          - operator: RemoveEmpty
            args:
              empty_values: {}
              remove_keys: {}
          - operator: uniq
      FileRemediation:
        simple: Quarantine
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
      forEach: true
    view: |-
      {
        "position": {
          "x": -25,
          "y": 6631
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "105":
    id: "105"
    taskid: 1667102c-cef6-427b-8573-1b02ec880442
    type: collection
    task:
      id: 1667102c-cef6-427b-8573-1b02ec880442
      version: -1
      name: Manual Task - Analyst Decision for Next Actions
      description: |-
        Analyst approval is required for the following remediation actions:
        - Quarantine malicious files
        - Quarantine malicious files and add them to the block list
        - Add malicious files to the block list
        - No action
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "106"
    scriptarguments:
      key:
        simple: Message
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 6208
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: "**Select the response actions:**\nThe execution found as malicious, please select the response actions:\n\n--- \nMalicious Processes details:\n ---\n\n### **Action process details:**\n- **Action Process Path**:\n${MaliciousActionProcess.actionPath}\n - **Action Process Hash**:\n${MaliciousActionProcess.actionSha256}\n\n---\n\n### **Actor process details:**\n- ${.=val.MaliciousActorProcess ? \"**Actor process Path:** \" + val.MaliciousActorProcess.actorPath : \"N/A\"}  \n- ${.=val.MaliciousActorProcess ? \"**Actor process Hash:** \" + val.MaliciousActorProcess.actorSha256 : \"N/A\"}\n\n\nNote: The following hashes have already been automatically added to the block list due to their malicious reputation:\n\n- ${DBotScore(val.Type === 'file' && val.Score === 3).Indicator=>val.filter((v,i,a)=>a.indexOf(v)==i).join(\"\\n - \")}\n\nIf the hashes related to the malicious action process or the actor process were already added, selecting them again will not impact the playbook’s flow—the playbook will proceed as normal.\n\n"
        required: true
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - {}
        - simple: Quarantine
        - simple: Add to Block List
        - simple: Quarantine and Add to Block List
        - simple: No Action
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Remediation Approval
      description: ""
      sender: Your SOC team
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "106":
    id: "106"
    taskid: 0813e10b-915f-4f41-8924-da9e33396514
    type: condition
    task:
      id: 0813e10b-915f-4f41-8924-da9e33396514
      version: -1
      name: Check Analyst Decision for Next Response Actions
      description: Evaluate the analyst's decision for the following response actions.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      Add to Block List:
      - "107"
      No Action:
      - "102"
      Quarantine:
      - "103"
      Quarantine & Add to Block List:
      - "109"
    separatecontext: false
    conditions:
    - label: Quarantine
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Remediation Approval.Answers.0
            iscontext: true
          right:
            value:
              simple: Quarantine
          ignorecase: true
    - label: Add to Block List
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Remediation Approval.Answers.0
            iscontext: true
          right:
            value:
              simple: Add to Block List
          ignorecase: true
    - label: Quarantine & Add to Block List
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Remediation Approval.Answers.0
            iscontext: true
          right:
            value:
              simple: Quarantine and Add to Block List
          ignorecase: true
    - label: No Action
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Remediation Approval.Answers.0
            iscontext: true
          right:
            value:
              simple: No Action
          ignorecase: true
        - operator: isEmpty
          left:
            value:
              simple: Remediation Approval.Answers.0
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 6336
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "107":
    id: "107"
    taskid: 63cd8c09-7202-4075-8ccc-09887ec2d339
    type: title
    task:
      id: 63cd8c09-7202-4075-8ccc-09887ec2d339
      version: -1
      name: Add to Block List
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "108"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 899,
          "y": 6489
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "108":
    id: "108"
    taskid: 77c587bb-ec8b-4a45-8ae3-7adc7d228d52
    type: regular
    task:
      id: 77c587bb-ec8b-4a45-8ae3-7adc7d228d52
      version: -1
      name: Add hash to Block list
      description: Block list requested files that have not already been block listed, or added to allow lists.
      script: '|||core-blocklist-files'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "102"
    scriptarguments:
      comment:
        simple: The hash was added to the block list by the playbook "Execution of an uncommon process at an early startup stage by Windows system binary"
      hash_list:
        complex:
          root: MaliciousActionProcess
          accessor: actionSha256
          transformers:
          - operator: AppendIfNotEmpty
            args:
              item:
                value:
                  simple: MaliciousActorProcess.actorSha256
                iscontext: true
              raw: {}
          - operator: uniq
      incident_id:
        complex:
          root: alert
          accessor: parentXDRIncident
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '-'
              fields:
                value:
                  simple: "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 899,
          "y": 6631
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "109":
    id: "109"
    taskid: ba9b8ac1-4f80-4193-827e-d9bf578c2e88
    type: title
    task:
      id: ba9b8ac1-4f80-4193-827e-d9bf578c2e88
      version: -1
      name: Quarantine and Add to Block List
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "104"
      - "108"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 6495
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "110":
    id: "110"
    taskid: bd08c649-731d-49bb-aeb3-58287e0a31eb
    type: condition
    task:
      id: bd08c649-731d-49bb-aeb3-58287e0a31eb
      version: -1
      name: Need any additional response action?
      description: |-
        Check if any additional response actions are needed based on the investigation findings:

        If a persistence mechanism via IIS extension is found, the playbook will block the hash of the malicious IIS DLL module or extension.

        If persistence via a scheduled task is found, the playbook will execute a script to find and disable the scheduled task.

        If persistence via the registry is found, the playbook will recommend deleting the related registry keys.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "13"
      Scheduled task:
      - "249"
      registry persistence:
      - "245"
      w3wp malicious dll:
      - "247"
    separatecontext: false
    conditions:
    - label: Scheduled task
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: RequiredResponseAction
            iscontext: true
          right:
            value:
              simple: Remediation -  Schedule Task
          ignorecase: true
    - label: registry persistence
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: RequiredResponseAction
            iscontext: true
          right:
            value:
              simple: Remediation - Registry
        - operator: containsGeneral
          left:
            value:
              simple: RequiredResponseAction
            iscontext: true
          right:
            value:
              simple: AnalystDecision - Registry
          ignorecase: true
    - label: w3wp malicious dll
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: RequiredResponseAction
            iscontext: true
          right:
            value:
              simple: Remediation - w3wp
          ignorecase: true
      - - operator: isNotEmpty
          left:
            value:
              simple: MaliciousIISExtension
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 6891
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "119":
    id: "119"
    taskid: 3440dbc9-3faa-4022-bcd9-abbf67001e71
    type: regular
    task:
      id: 3440dbc9-3faa-4022-bcd9-abbf67001e71
      version: -1
      name: Command line analysis
      description: |-
        This script evaluates command-line threats by analyzing both original and decoded inputs. It assigns weighted scores to detected patterns, such as AMSI bypass or credential dumping, and applies risk combination bonuses for multiple detections. The total score is normalized to a 0-100 scale, with risk levels categorized as follows:

        * 0-25: Low Risk
        * 26-50: Medium Risk
        * 51-90: High Risk
        * 91-100: Critical Risk

        The scoring mechanism provides a comprehensive risk assessment, considering both the severity and frequency of malicious behaviors.
      scriptName: CommandLineAnalysis
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "120"
    scriptarguments:
      command_line:
        simple: ${alert.osparentcmd.[0]}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5067,
          "y": 699
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "120":
    id: "120"
    taskid: defbd444-0665-4928-8d99-abbdac0e950e
    type: condition
    task:
      id: defbd444-0665-4928-8d99-abbdac0e950e
      version: -1
      name: Check if found high risk command line
      description: |
        This task evaluates the command-line analysis results and checks if the risk score is greater than or equal to 30. If it is, mark the result as Malicious.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "175"
      "yes":
      - "174"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              simple: CommandLineAnalysis.score
            iscontext: true
          right:
            value:
              simple: "30"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5067,
          "y": 815
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "124":
    id: "124"
    taskid: 9926d0dc-590c-4a8a-b574-5aa4d85d5232
    type: regular
    task:
      id: 9926d0dc-590c-4a8a-b574-5aa4d85d5232
      version: -1
      name: Get action process extra data
      description: Returns additional information about the action process.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 431,
          "y": -807
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "125":
    id: "125"
    taskid: 5572205d-8289-4138-a544-1bbfad707d8f
    type: title
    task:
      id: 5572205d-8289-4138-a544-1bbfad707d8f
      version: -1
      name: Found Related Alerts
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "157"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 3911,
          "y": 271
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "126":
    id: "126"
    taskid: c7b5cc25-3905-46fc-9257-173e3c31b5e5
    type: title
    task:
      id: c7b5cc25-3905-46fc-9257-173e3c31b5e5
      version: -1
      name: RunOnce.exe
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "263"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1958,
          "y": 271
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "127":
    id: "127"
    taskid: 2ebc07fd-ab26-4c5e-90ed-20572dad3951
    type: regular
    task:
      id: 2ebc07fd-ab26-4c5e-90ed-20572dad3951
      version: -1
      name: Set query start time
      description: Set the XQL query start time.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "128"
    scriptarguments:
      key:
        simple: RunOnceQueryStartTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 1 day ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1956,
          "y": 658
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "128":
    id: "128"
    taskid: 9f485b68-e0fb-49fb-8c83-0981fd167c4f
    type: regular
    task:
      id: 9f485b68-e0fb-49fb-8c83-0981fd167c4f
      version: -1
      name: Set query end time
      description: Set the XQL query end time.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "129"
    scriptarguments:
      key:
        simple: RunOnceQueryEndTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: now
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1956,
          "y": 782
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "129":
    id: "129"
    taskid: 0e9b63be-a829-4a5e-8fac-8f5b3309f5f8
    type: regular
    task:
      id: 0e9b63be-a829-4a5e-8fac-8f5b3309f5f8
      version: -1
      name: XQL Query - Search creation of RunOnce registry key
      description: Execute an XQL query to retrieve information about the process that created the RunOnce registry key associated with the action process.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "265"
      '#none#':
      - "130"
    scriptarguments:
      query:
        simple: dataset  = xdr_data | filter agent_id  = "${alert.agentid}" and event_type = ENUM.REGISTRY and event_sub_type = ENUM.REGISTRY_SET_VALUE and action_registry_key_name contains "SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce"  and action_registry_data contains "${alert.targetprocessname.[0]}" | fields causality_actor_process_image_sha256 ,actor_process_image_sha256 ,actor_process_command_line , causality_actor_process_command_line
      query_name:
        simple: Search_RunOnce_RegistryKey_Added
      time_frame:
        simple: between ${RunOnceQueryStartTime} and ${RunOnceQueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -1956,
          "y": 914
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "130":
    id: "130"
    taskid: 750f514b-32f1-4556-969a-5ae5839933d5
    type: condition
    task:
      id: 750f514b-32f1-4556-969a-5ae5839933d5
      version: -1
      name: Found process that created the RunOnce registry key?
      description: Checks if the process that created the RunOnce registry key associated with the action process was found.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "165"
      "Yes":
      - "137"
      - "131"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_sha256
            iscontext: true
          right:
            value: {}
        - operator: isNotEmpty
          left:
            value:
              simple: PaloAltoNetworksXQL.GenericQuery.results.actor_process_image_sha256
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_command_line
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: PaloAltoNetworksXQL.GenericQuery.results.actor_process_command_line
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1956,
          "y": 1053
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "131":
    id: "131"
    taskid: bb4d7be5-c723-4f19-8d2b-ff28e99859c3
    type: regular
    task:
      id: bb4d7be5-c723-4f19-8d2b-ff28e99859c3
      version: -1
      name: Get reputation on the process who create the suspicious process
      description: Checks the file reputation of the specified hash.
      script: '|||file'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "132"
    scriptarguments:
      file:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery.results
          accessor: causality_actor_process_image_sha256
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.results.actor_process_image_sha256
                iscontext: true
          - operator: RemoveEmpty
            args:
              empty_values: {}
              remove_keys:
                value:
                  simple: "true"
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2607,
          "y": 1210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "132":
    id: "132"
    taskid: 5b1a1762-e561-4974-b245-cf750c16c18c
    type: condition
    task:
      id: 5b1a1762-e561-4974-b245-cf750c16c18c
      version: -1
      name: Check if the process has a bad reputation
      description: |
        Determines the appropriate verdict based on the process reputation.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "165"
      "yes":
      - "166"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_sha256
                      iscontext: true
                    ignorecase: true
                  - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.actor_process_image_sha256
                      iscontext: true
                accessor: Score
            iscontext: true
          right:
            value: {}
        - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_sha256
                      iscontext: true
                  - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.actor_process_image_sha256
                      iscontext: true
                accessor: Score
            iscontext: true
          right:
            value:
              simple: "2"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2607,
          "y": 1338
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "137":
    id: "137"
    taskid: 0a173127-1975-444a-ae58-06c5bc5c1db4
    type: regular
    task:
      id: 0a173127-1975-444a-ae58-06c5bc5c1db4
      version: -1
      name: Command line analysis
      description: |-
        This script evaluates command-line threats by analyzing both original and decoded inputs. It assigns weighted scores to detected patterns, such as AMSI bypass or credential dumping, and applies risk combination bonuses for multiple detections. The total score is normalized to a 0-100 scale, with risk levels categorized as follows:

        * 0-25: Low Risk
        * 26-50: Medium Risk
        * 51-90: High Risk
        * 91-100: Critical Risk

        The scoring mechanism provides a comprehensive risk assessment, considering both the severity and frequency of malicious behaviors.
      scriptName: CommandLineAnalysis
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "167"
    scriptarguments:
      command_line:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery.results
          accessor: causality_actor_process_command_line
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.results.actor_process_command_line
                iscontext: true
          - operator: RemoveEmpty
            args:
              empty_values: {}
              remove_keys:
                value:
                  simple: "true"
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2183,
          "y": 1211
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "140":
    id: "140"
    taskid: 29a7d6d3-8631-4ee7-9228-22df11adda73
    type: title
    task:
      id: 29a7d6d3-8631-4ee7-9228-22df11adda73
      version: -1
      name: spoolsv.exe
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "141"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -417,
          "y": 271
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "141":
    id: "141"
    taskid: 5e2d7a4f-a128-43af-b4d3-c8e30828aeb1
    type: regular
    task:
      id: 5e2d7a4f-a128-43af-b4d3-c8e30828aeb1
      version: -1
      name: Search for related alerts
      description: |-
        This task searches for the following specific related alerts on the endpoint:
        - Print spooler set to load new DLL on boot
        - Suspicious print processor registered
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "142"
    scriptarguments:
      fromdate:
        simple: 5 hours ago
      includeinformational:
        simple: "true"
      query:
        simple: 'agentid:${alert.agentid} and (name:"Print spooler set to load new DLL on boot"  or name:"Suspicious print processor registered") '
      todate:
        simple: now
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -417,
          "y": 390
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "142":
    id: "142"
    taskid: 2431d69c-ab94-4047-aff2-1871cfec5aff
    type: condition
    task:
      id: 2431d69c-ab94-4047-aff2-1871cfec5aff
      version: -1
      name: found any indication it is a true positive?
      description: |-
        Determines whether one of the following related alerts was found:
        - Suspicious print processor registered
        - Print spooler set to load new DLL on boot

        If the alert 'Suspicious print processor registered' is found, the playbook proceeds to remediation.
        If the alert 'Print Spooler set to load new DLL on boot' is found, the playbook proceeds to DLL investigation.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "164"
      Check dll loaded:
      - "261"
      "yes":
      - "163"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Suspicious print processor registered
          ignorecase: true
    - label: Check dll loaded
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Print spooler set to load new DLL on boot
          ignorecase: true
      - - operator: isNotEmpty
          left:
            value:
              simple: foundIncidents.CustomFields.registrydata.[0]
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -417,
          "y": 515
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "143":
    id: "143"
    taskid: 8aa9ac14-606c-4d4a-8d35-722f2a3bb298
    type: regular
    task:
      id: 8aa9ac14-606c-4d4a-8d35-722f2a3bb298
      version: -1
      name: Set query start time
      description: Set the XQL query start time.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "144"
    scriptarguments:
      key:
        simple: SpoolsvQueryStartTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 1 days ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -869,
          "y": 939
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "144":
    id: "144"
    taskid: 6714da98-9b1d-4a82-b678-8a5939ea145b
    type: regular
    task:
      id: 6714da98-9b1d-4a82-b678-8a5939ea145b
      version: -1
      name: Set query end time
      description: Set the XQL query end time.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "145"
    scriptarguments:
      key:
        simple: SpoolsvQueryEndTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: now
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -869,
          "y": 1079
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "145":
    id: "145"
    taskid: 3a67ca15-609b-456d-8f43-cb08c8090619
    type: regular
    task:
      id: 3a67ca15-609b-456d-8f43-cb08c8090619
      version: -1
      name: XQL Query - Search the dll configured to load on boot
      description: Execute an XQL query to retrieve information about the new DLL that the Print Spooler is set to load on boot.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "260"
      '#none#':
      - "149"
    scriptarguments:
      query:
        simple: 'dataset = xdr_data | filter event_type = ENUM.LOAD_IMAGE and event_sub_type = ENUM.LOAD_IMAGE_MODULE and action_module_sha256 != "" and action_module_path contains "${foundIncidents.CustomFields.registrydata.[0]}" | fields action_module_sha256 , action_module_signature_status | dedup action_module_sha256 '
      query_name:
        simple: Search_PrintSpool_Load_Image
      time_frame:
        simple: between ${SpoolsvQueryStartTime} and ${SpoolsvQueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -869,
          "y": 1215
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "149":
    id: "149"
    taskid: 92e739b4-11f3-4ee5-9c67-2e06f63883f1
    type: condition
    task:
      id: 92e739b4-11f3-4ee5-9c67-2e06f63883f1
      version: -1
      name: found any indication it is a true positive?
      description: |+
        Determine the next action based on these conditions:
        - If "Print Spooler set to load new DLL on boot" alert is found and the DLL is not signed, the playbook continues to remediation.
        - If the DLL is signed and found via the XQL query, the playbook continues to investigate the DLL.
        - Otherwise, the playbook ends the investigation.

      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "164"
      Check dll reputation:
      - "150"
      "Yes":
      - "163"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: 'PaloAltoNetworksXQL.GenericQuery.results.action_module_signature_status '
            iscontext: true
          right:
            value:
              simple: UNSIGNED
          ignorecase: true
    - label: Check dll reputation
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: PaloAltoNetworksXQL.GenericQuery.results.action_module_sha256
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -869,
          "y": 1351
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "150":
    id: "150"
    taskid: 78f47098-cf14-4e10-bcd8-555c5eb34d2a
    type: regular
    task:
      id: 78f47098-cf14-4e10-bcd8-555c5eb34d2a
      version: -1
      name: Get reputation on the process who create the suspicious process
      description: Checks the file reputation of the specified hash.
      script: '|||file'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "153"
    scriptarguments:
      file:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery.results
          accessor: action_module_sha256
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1131,
          "y": 1503
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "153":
    id: "153"
    taskid: fb68fe32-951b-4587-8ae5-eacb95f2e6c6
    type: condition
    task:
      id: fb68fe32-951b-4587-8ae5-eacb95f2e6c6
      version: -1
      name: Check if the process has a bad reputation
      description: |
        Determines the appropriate verdict based on the process reputation.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "164"
      "yes":
      - "163"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.action_module_sha256
                      iscontext: true
                    ignorecase: true
                accessor: Score
            iscontext: true
          right:
            value: {}
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.action_module_sha256
                      iscontext: true
                accessor: Score
            iscontext: true
          right:
            value:
              simple: "2"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1131,
          "y": 1640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "155":
    id: "155"
    taskid: e2a9c55e-1cd7-4601-925f-5a8aac29c53a
    type: regular
    task:
      id: e2a9c55e-1cd7-4601-925f-5a8aac29c53a
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "158"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: Remediation
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 3372,
          "y": 541
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "156":
    id: "156"
    taskid: 13d4fbbe-999c-4ddb-9bf4-e6c295edb29e
    type: regular
    task:
      id: 13d4fbbe-999c-4ddb-9bf4-e6c295edb29e
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "159"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: Remediation
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2910,
          "y": 537
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "157":
    id: "157"
    taskid: c5ec60bd-9801-484e-be1f-c9ed200472ae
    type: regular
    task:
      id: c5ec60bd-9801-484e-be1f-c9ed200472ae
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "162"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: Remediation
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 3911,
          "y": 383
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "158":
    id: "158"
    taskid: 02b9578d-2805-4124-b692-6146ccab63ba
    type: title
    task:
      id: 02b9578d-2805-4124-b692-6146ccab63ba
      version: -1
      name: winlogon.exe - Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 3372,
          "y": 755
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "159":
    id: "159"
    taskid: b88528cd-de6a-4cc6-9bf4-a2e150e9973c
    type: title
    task:
      id: b88528cd-de6a-4cc6-9bf4-a2e150e9973c
      version: -1
      name: LogonUI.exe - Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2910,
          "y": 744
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "160":
    id: "160"
    taskid: 83a130c2-9afd-4c07-9d66-8c3598d69998
    type: title
    task:
      id: 83a130c2-9afd-4c07-9d66-8c3598d69998
      version: -1
      name: WmiPrvSE.exe - Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2372,
          "y": 850
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "161":
    id: "161"
    taskid: 8db26632-1387-445d-a25a-9be985c4b71e
    type: regular
    task:
      id: 8db26632-1387-445d-a25a-9be985c4b71e
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "160"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: Remediation
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2372,
          "y": 685
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "162":
    id: "162"
    taskid: adf8f06b-9464-48bf-881c-e86fe8edbbbc
    type: title
    task:
      id: adf8f06b-9464-48bf-881c-e86fe8edbbbc
      version: -1
      name: Found Related Alerts - Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 3911,
          "y": 534
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "163":
    id: "163"
    taskid: 29a5da5b-044d-4ff4-a6ab-483714d5e0d1
    type: regular
    task:
      id: 29a5da5b-044d-4ff4-a6ab-483714d5e0d1
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "164"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: Remediation
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -620,
          "y": 1776
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "164":
    id: "164"
    taskid: 1ed646f0-5b58-4d2c-8de5-f72f403d9ee6
    type: title
    task:
      id: 1ed646f0-5b58-4d2c-8de5-f72f403d9ee6
      version: -1
      name: spoolsv.exe - Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -417,
          "y": 1932
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "165":
    id: "165"
    taskid: cccd3520-6196-4a95-b55f-aa21c762bd2c
    type: title
    task:
      id: cccd3520-6196-4a95-b55f-aa21c762bd2c
      version: -1
      name: RunOnce.exe - Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1956,
          "y": 1660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "166":
    id: "166"
    taskid: 0dd03d2b-2177-494c-aedb-f6e38be4a917
    type: regular
    task:
      id: 0dd03d2b-2177-494c-aedb-f6e38be4a917
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "165"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: Remediation
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2393,
          "y": 1498
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "167":
    id: "167"
    taskid: c90b9392-460a-4a6e-806f-ea0bad056509
    type: condition
    task:
      id: c90b9392-460a-4a6e-806f-ea0bad056509
      version: -1
      name: 'Check if the process has high risk command line '
      description: |
        This task evaluates the command-line analysis results and checks if the risk score is greater than or equal to 40. If it is, mark the result as Malicious.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "165"
      "yes":
      - "166"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              simple: CommandLineAnalysis.score
            iscontext: true
          right:
            value:
              simple: "40"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2183,
          "y": 1337
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "168":
    id: "168"
    taskid: b2cd6177-1278-402c-952e-d8f23d9a8a21
    type: regular
    task:
      id: b2cd6177-1278-402c-952e-d8f23d9a8a21
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "169"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: Remediation
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -3831,
          "y": 1496
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "169":
    id: "169"
    taskid: b0554de8-6665-4deb-ab5a-0cf99d3c8123
    type: title
    task:
      id: b0554de8-6665-4deb-ab5a-0cf99d3c8123
      version: -1
      name: startup folder - Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -3390,
          "y": 1658
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "170":
    id: "170"
    taskid: 82a51490-782b-4518-99a7-8e756f34e7f7
    type: regular
    task:
      id: 82a51490-782b-4518-99a7-8e756f34e7f7
      version: -1
      name: Get Alert related alerts for the process who create the suspicious scheduled task
      description: This task searches for related alerts indicating the suspicious creation of a scheduled task on this endpoint.
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "99"
    scriptarguments:
      fromdate:
        simple: 1 day ago
      query:
        simple: "agentid:${alert.agentid} and (name:\"Scheduled Task hidden by registry modification\" or name:\"Uncommon shell command execution setting a scheduled task\" or name:\"Uncommon local scheduled task creation via schtasks.exe\"  or name:\"Uncommon remote scheduled task created\"  or name:\"Uncommon local scheduled task created\"\nor name:\"Uncommon PowerShell commands used to create or alter scheduled task parameters\") "
      todate:
        simple: now
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1649,
          "y": 399
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "171":
    id: "171"
    taskid: 3b11e1e5-346f-4fd2-8021-d4005feb096a
    type: regular
    task:
      id: 3b11e1e5-346f-4fd2-8021-d4005feb096a
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "172"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: Remediation -  Schedule Task
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1649,
          "y": 699
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "172":
    id: "172"
    taskid: 017f371a-311a-424c-8e2a-32ef02c0c5f5
    type: title
    task:
      id: 017f371a-311a-424c-8e2a-32ef02c0c5f5
      version: -1
      name: Schedule Task - Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1649,
          "y": 885
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "173":
    id: "173"
    taskid: 9c1a6e7b-a13a-4c72-ab45-b0367078f6ab
    type: condition
    task:
      id: 9c1a6e7b-a13a-4c72-ab45-b0367078f6ab
      version: -1
      name: Check if related alerts indicating malicious activity were found
      description: Checks if alerts indicating malicious activity related to the process that created the suspicious action process in the startup folder were found.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "169"
      "yes":
      - "168"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.sourceBrand
            iscontext: true
          right:
            value:
              simple: TRAPS
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Malware
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -3617,
          "y": 1336
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "174":
    id: "174"
    taskid: d5f68344-2d31-44f9-8735-d17b3bc044c9
    type: regular
    task:
      id: d5f68344-2d31-44f9-8735-d17b3bc044c9
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "175"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: Remediation
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -4849,
          "y": 1149
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "175":
    id: "175"
    taskid: 818b607b-835d-40fb-bc2b-a2e9eb1b1397
    type: title
    task:
      id: 818b607b-835d-40fb-bc2b-a2e9eb1b1397
      version: -1
      name: w3wp.exe - Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5067,
          "y": 4392
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "176":
    id: "176"
    taskid: 385e5670-599a-43ff-ab1d-8cd959d9a5f9
    type: condition
    task:
      id: 385e5670-599a-43ff-ab1d-8cd959d9a5f9
      version: -1
      name: Application Host config file Successfully Retrieved?
      description: Checks whether the script was retrieved successfully.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "175"
      "yes":
      - "85"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: ExtractedFiles
            iscontext: true
          right:
            value: {}
      - - operator: containsGeneral
          left:
            value:
              simple: File.Info
            iscontext: true
          right:
            value:
              simple: config
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 2228
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "177":
    id: "177"
    taskid: 405b091f-f5ab-435a-94c2-64b344140ec8
    type: regular
    task:
      id: 405b091f-f5ab-435a-94c2-64b344140ec8
      version: -1
      name: Set query start time
      description: Set the XQL query start time.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "178"
    scriptarguments:
      key:
        simple: PersistenceQueryStartTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 7 days ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 678
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "178":
    id: "178"
    taskid: 546a9b4b-db4f-4b34-9aeb-fbf587a9e85f
    type: regular
    task:
      id: 546a9b4b-db4f-4b34-9aeb-fbf587a9e85f
      version: -1
      name: Set query end time
      description: Set the XQL query end time.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "179"
    scriptarguments:
      key:
        simple: PersistenceQueryEndTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: now
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 819
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "179":
    id: "179"
    taskid: 58c7afc3-6cfc-42ba-96bd-88ada0689c66
    type: regular
    task:
      id: 58c7afc3-6cfc-42ba-96bd-88ada0689c66
      version: -1
      name: XQL Query – Search for creation of registry keys related to persistence
      description: Execute an XQL query to retrieve information about the process that created a registry key value under a persistence-related registry key containing the action process.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "258"
      '#none#':
      - "217"
    scriptarguments:
      ignore-outputs:
        simple: "false"
      query:
        simple: dataset  = xdr_data | filter agent_id  = "${alert.agentid}" and event_type = ENUM.REGISTRY and event_sub_type = ENUM.REGISTRY_SET_VALUE  and (action_registry_key_name contains "SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit" or action_registry_key_name contains "SOFTWARE\Microsoft\Windows\CurrentVersion\Run" or action_registry_key_name contains "SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell" or action_registry_key_name contains "SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify") and action_registry_key_name not contains "RunNotification" and action_registry_data contains "${alert.targetprocessname.[0]}" | fields causality_actor_process_image_sha256 ,actor_process_image_sha256 ,actor_process_image_name , causality_actor_process_image_name  , action_registry_key_name ,action_registry_data ,action_registry_value_name
      query_name:
        simple: Search_Registry_Persistence
      time_frame:
        simple: between ${PersistenceQueryStartTime} and ${PersistenceQueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": 432,
          "y": 950
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "180":
    id: "180"
    taskid: 7ec23146-8553-4e8a-a11c-42b5a6d27334
    type: regular
    task:
      id: 7ec23146-8553-4e8a-a11c-42b5a6d27334
      version: -1
      name: Set query start time
      description: Set the XQL query start time.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "181"
    scriptarguments:
      key:
        simple: w3wpQueryStartTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 1 days ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5838,
          "y": 1049
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "181":
    id: "181"
    taskid: 92bd3cbb-1375-4191-92c8-0dc15329ed0e
    type: regular
    task:
      id: 92bd3cbb-1375-4191-92c8-0dc15329ed0e
      version: -1
      name: Set query end time
      description: Set the XQL query end time.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "77"
    scriptarguments:
      key:
        simple: w3wpQueryEndTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: now
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5838,
          "y": 1182
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "182":
    id: "182"
    taskid: ac35820b-a8e0-49af-94cb-8262d1576dbc
    type: regular
    task:
      id: ac35820b-a8e0-49af-94cb-8262d1576dbc
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "175"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: Remediation
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5608,
          "y": 1862
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "189":
    id: "189"
    taskid: 626eff13-2765-4aa4-b4c9-597acdbba5eb
    type: condition
    task:
      id: 626eff13-2765-4aa4-b4c9-597acdbba5eb
      version: -1
      name: Action based on investigation
      description: Determine the next action based on the investigation findings.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "224"
      Analyst Decision - Registry:
      - "222"
      Remediation:
      - "100"
      XQL Failure - Analyst Decision:
      - "272"
    separatecontext: false
    conditions:
    - label: Remediation
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: RequiredResponseAction
            iscontext: true
          right:
            value:
              simple: Remediation
          ignorecase: true
    - label: Analyst Decision - Registry
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: RequiredResponseAction
            iscontext: true
          right:
            value:
              simple: AnalystDecision - Registry
          ignorecase: true
    - label: XQL Failure - Analyst Decision
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: RequiredResponseAction
            iscontext: true
          right:
            value:
              simple: AnalystDecision - XQL
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 4624
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "198":
    id: "198"
    taskid: f4799348-93a6-4fe0-8adc-13eb5b16758d
    type: regular
    task:
      id: f4799348-93a6-4fe0-8adc-13eb5b16758d
      version: -1
      name: Get DLL from Application Host Config
      description: Sets all DLLs from the ApplicationHost.config file into the context under the key 'dllFromApplicationHostConfig'.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "199"
    scriptarguments:
      key:
        simple: dllFromApplicationHostConfig
      value:
        complex:
          root: ApplicationHostConfig.configuration.system\.webServer.globalModules.add
          accessor: '@image'
          transformers:
          - operator: AppendIfNotEmpty
            args:
              item:
                value:
                  simple: ApplicationHostConfig.configuration.location.system\.webServer.handlers.add.@scriptProcessor
                iscontext: true
              raw: {}
          - operator: AppendIfNotEmpty
            args:
              item:
                value:
                  simple: ApplicationHostConfig.configuration.system\.webServer.security.isapiCgiRestriction.add.@path
                iscontext: true
              raw: {}
          - operator: AppendIfNotEmpty
            args:
              item:
                value:
                  simple: ApplicationHostConfig.configuration.location.system\.webServer.handlers.add.@scriptProcessor
                iscontext: true
              raw: {}
          - operator: RegexExtractAll
            args:
              error_if_no_match: {}
              ignore_case: {}
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: '[^\\\/]+(?:\.\w+)?$'
              unpack_matches: {}
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 2515
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "199":
    id: "199"
    taskid: 42c624a9-0ab0-4558-ab8b-a106f464e06c
    type: regular
    task:
      id: 42c624a9-0ab0-4558-ab8b-a106f464e06c
      version: -1
      name: Set DLL to retrieve
      description: Sets all unsigned DLLs loaded by the w3wp.exe process and found via the XQL query into the context under the key 'DllToRetrieve'.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "201"
    scriptarguments:
      key:
        simple: DllToRetrieve
      value:
        complex:
          root: dllFromApplicationHostConfig
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: dllFromApplicationHostConfig
                iscontext: true
              right:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.results.action_module_dllname.[0]
                iscontext: true
              ignorecase: true
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 2652
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "200":
    id: "200"
    taskid: f58e48c7-5f53-49af-b36a-3971df4d7276
    type: regular
    task:
      id: f58e48c7-5f53-49af-b36a-3971df4d7276
      version: -1
      name: Retrieve the suspicious dll
      description: Retrieves suspicious DLL files loaded by w3wp.exe that are suspected to be part of a malicious IIS extension or module.
      script: '|||core-retrieve-files'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "202"
    scriptarguments:
      endpoint_ids:
        simple: ${alert.agentid}
      extend-context:
        simple: retrieveDll=
      ignore-outputs:
        simple: "true"
      windows_file_paths:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery.results.action_module_path
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.results.action_module_path
                iscontext: true
              right:
                value:
                  simple: DllToRetrieve
                iscontext: true
              ignorecase: true
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 2939
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "201":
    id: "201"
    taskid: 3328fceb-efc2-4486-b9e9-194dae5edbb4
    type: condition
    task:
      id: 3328fceb-efc2-4486-b9e9-194dae5edbb4
      version: -1
      name: Found suspicious dll to retrieve?
      description: Checks whether unsigned DLLs loaded by the w3wp.exe process exist in the context.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "175"
      "yes":
      - "200"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.GenericQuery.results.action_module_path
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.action_module_path
                      iscontext: true
                    right:
                      value:
                        simple: DllToRetrieve
                      iscontext: true
                    ignorecase: true
                transformers:
                - operator: uniq
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 2775
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "202":
    id: "202"
    taskid: 73f17ce6-649d-4d81-a812-b43d559ec079
    type: regular
    task:
      id: 73f17ce6-649d-4d81-a812-b43d559ec079
      version: -1
      name: Retrieve the details of the suspicious dll
      description: View the file retrieved by the core-retrieve-files command according to the action ID.
      script: '|||core-retrieve-file-details'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "203"
    scriptarguments:
      action_id:
        complex:
          root: retrieveDll
          accessor: action_id
          transformers:
          - operator: uniq
      ignore-outputs:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 3083
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "203":
    id: "203"
    taskid: bb7228e5-31f9-4eee-9855-a4a7ee40f859
    type: regular
    task:
      id: bb7228e5-31f9-4eee-9855-a4a7ee40f859
      version: -1
      name: Unzip dll
      description: Unzip a file using fileName or entryID to specify a file. Unzipped files will be loaded to the War Room and names will be put into the context.
      scriptName: UnzipFile
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "210"
    scriptarguments:
      entryID:
        complex:
          root: File
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: File.Info
                iscontext: true
              right:
                value:
                  simple: zip
              ignorecase: true
          accessor: EntryID
          transformers:
          - operator: LastArrayElement
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 3223
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "205":
    id: "205"
    taskid: c7639a5b-0621-45c0-9d52-cc679fe44729
    type: playbook
    task:
      id: c7639a5b-0621-45c0-9d52-cc679fe44729
      version: -1
      name: Wildfire Sandbox - Detonate and Analyze File
      description: |
        This playbook uploads, detonates, and analyzes files for the Wildfire sandbox.
      playbookName: Wildfire Detonate and Analyze File
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "212"
    scriptarguments:
      File:
        complex:
          root: File
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: File.Info
                iscontext: true
              right:
                value:
                  simple: dll
              ignorecase: true
    separatecontext: false
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -5850,
          "y": 3792
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "207":
    id: "207"
    taskid: 3ca4b177-0378-4c5d-858d-deb2170c47ab
    type: condition
    task:
      id: 3ca4b177-0378-4c5d-858d-deb2170c47ab
      version: -1
      name: Is the WildFire verdict malicious for the dll?
      description: Checks if the WildFire verdict is malicious for the dll.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "175"
      Malicious:
      - "213"
      - "235"
    separatecontext: false
    conditions:
    - label: Malicious
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: WildFire.Verdicts.VerdictDescription
            iscontext: true
          right:
            value:
              simple: malware
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: WildFire.Verdicts.VerdictDescription
            iscontext: true
          right:
            value:
              simple: C2
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: WildFire.Verdicts.VerdictDescription
            iscontext: true
          right:
            value:
              simple: phishing
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 4064
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "208":
    id: "208"
    taskid: 175c0e9c-2213-4f65-b6f0-cf67dd4094a0
    type: regular
    task:
      id: 175c0e9c-2213-4f65-b6f0-cf67dd4094a0
      version: -1
      name: Wildfire get verdict
      description: Returns a verdict for a hash.
      script: '|||wildfire-get-verdict'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "211"
    scriptarguments:
      hash:
        complex:
          root: File
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: File.Info
                iscontext: true
              right:
                value:
                  simple: dll
              ignorecase: true
          accessor: SHA256
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 3502
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "210":
    id: "210"
    taskid: 8bbed274-174b-43a6-b182-19b99f5c1dc2
    type: condition
    task:
      id: 8bbed274-174b-43a6-b182-19b99f5c1dc2
      version: -1
      name: DLL Successfully Retrieved?
      description: Checks whether the DLL successfully retrieved.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "175"
      "yes":
      - "208"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: ExtractedFiles
            iscontext: true
          right:
            value: {}
      - - operator: containsGeneral
          left:
            value:
              simple: File.Info
            iscontext: true
          right:
            value:
              simple: dll
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 3360
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "211":
    id: "211"
    taskid: 9d0123fa-4f0f-447e-a665-4edcaf8bc98e
    type: condition
    task:
      id: 9d0123fa-4f0f-447e-a665-4edcaf8bc98e
      version: -1
      name: Is the hash known by WildFire Sandbox?
      description: Checks if the hash is known by WildFire Sandbox.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "205"
      "yes":
      - "207"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: notContainsString
          left:
            value:
              simple: WildFire.Verdicts.VerdictDescription
            iscontext: true
          right:
            value:
              simple: unknown
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 3631
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "212":
    id: "212"
    taskid: 99b05148-9774-4a23-8255-8a3fcb805f5d
    type: regular
    task:
      id: 99b05148-9774-4a23-8255-8a3fcb805f5d
      version: -1
      name: Wildfire get verdict
      description: Returns a verdict for a hash.
      script: '|||wildfire-get-verdict'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "207"
    scriptarguments:
      hash:
        complex:
          root: File
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: File.Info
                iscontext: true
              right:
                value:
                  simple: dll
              ignorecase: true
          accessor: SHA256
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5850,
          "y": 3925
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "213":
    id: "213"
    taskid: 484cc868-febd-410d-b365-09e86869afb7
    type: regular
    task:
      id: 484cc868-febd-410d-b365-09e86869afb7
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "175"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: Remediation - w3wp
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6091,
          "y": 4221
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "217":
    id: "217"
    taskid: ba4001fe-30cb-42a4-a11b-90f4e24fed8a
    type: condition
    task:
      id: ba4001fe-30cb-42a4-a11b-90f4e24fed8a
      version: -1
      name: Found processes that created registry keys related to persistence?
      description: Check whether the XQL query results contain the relevant details.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "220"
      "yes":
      - "218"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_sha256
            iscontext: true
          right:
            value: {}
        - operator: isNotEmpty
          left:
            value:
              simple: PaloAltoNetworksXQL.GenericQuery.results.actor_process_image_sha256
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 1089
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "218":
    id: "218"
    taskid: 2094a70d-9166-4596-8e01-acde503d6ecc
    type: regular
    task:
      id: 2094a70d-9166-4596-8e01-acde503d6ecc
      version: -1
      name: Get reputation on the process who create the suspicious process
      description: Checks the file reputation of the specified hash.
      script: '|||file'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "219"
    scriptarguments:
      file:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery.results
          accessor: causality_actor_process_image_sha256
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.results.actor_process_image_sha256
                iscontext: true
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 872,
          "y": 1226
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "219":
    id: "219"
    taskid: c364dc0e-f7f4-4fea-8eda-7e3587264ff7
    type: condition
    task:
      id: c364dc0e-f7f4-4fea-8eda-7e3587264ff7
      version: -1
      name: Check if the process has a bad reputation
      description: |
        Determines the appropriate verdict based on the process reputation.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "221"
      "yes":
      - "71"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_sha256
                      iscontext: true
                    ignorecase: true
                  - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.actor_process_image_sha256
                      iscontext: true
                accessor: Score
            iscontext: true
          right:
            value: {}
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_sha256
                      iscontext: true
                    ignorecase: true
                  - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.actor_process_image_sha256
                      iscontext: true
                    ignorecase: true
                accessor: Score
            iscontext: true
          right:
            value:
              simple: "2"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 872,
          "y": 1359
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "220":
    id: "220"
    taskid: 1fbe9eee-37e5-4d4c-a7a8-637e692d14a4
    type: title
    task:
      id: 1fbe9eee-37e5-4d4c-a7a8-637e692d14a4
      version: -1
      name: Registry Persistence mechanism - Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 431,
          "y": 1636
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "221":
    id: "221"
    taskid: 8462c1a8-4a93-4a4f-9c5d-7c26578ee3af
    type: regular
    task:
      id: 8462c1a8-4a93-4a4f-9c5d-7c26578ee3af
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "220"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: AnalystDecision - Registry
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1066,
          "y": 1491
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "222":
    id: "222"
    taskid: 1145cf87-d42d-4189-b7c0-df492587d85b
    type: collection
    task:
      id: 1145cf87-d42d-4189-b7c0-df492587d85b
      version: -1
      name: Manual Task - Analyst Decision
      description: Analyst review is required to determine whether to take remediation actions, or to close the alert as a false positive.
      tags:
      - analyst_decision
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "223"
    scriptarguments:
      key:
        simple: Message
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 738,
          "y": 4779
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: |
            #### Processes execution tree:
            - CGO Process Name: ${alert.cgoname.[0]}
            - Actor Process Name: ${alert.initiatedby.[0]}
            - Action Process Name: ${alert.targetprocessname.[0]}

            ---

            The playbook discovered that the action process was registered in a persistence-related registry key:
            ${XQLPersistenceQueryResults.results.action_registry_key_name}

            ---

            ### Decision Required:
            Please choose the action you want to perform:

            - **False Positive** - Close the alert as a false positive.
            - **True Positive** - Handle the alert as a true positive by terminating, blocking, and quarantining the malicious processes.  *(Note: During the remediation stage, you will need to approve actions that affect malicious processes.)*
        required: true
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - simple: False Positive
        - simple: True Positive
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Analyst Decision
      description: ""
      sender: Your SOC team
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "223":
    id: "223"
    taskid: 973caf74-f014-4b8b-8531-33c894ef9c88
    type: condition
    task:
      id: 973caf74-f014-4b8b-8531-33c894ef9c88
      version: -1
      name: Check Analyst Decision
      description: Evaluate the analyst's decision on whether to proceed with remediation actions or close the alert as a false positive.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      False Positive:
      - "226"
      True Positive:
      - "100"
    separatecontext: false
    conditions:
    - label: False Positive
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Decision.Answers.0
            iscontext: true
          right:
            value:
              simple: False Positive
          ignorecase: true
    - label: True Positive
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Decision.Answers.0
            iscontext: true
          right:
            value:
              simple: True Positive
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 949,
          "y": 4916
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "224":
    id: "224"
    taskid: 87af0c03-1c8c-4060-8626-5b064de317c1
    type: title
    task:
      id: 87af0c03-1c8c-4060-8626-5b064de317c1
      version: -1
      name: Close Alert as False Positive
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "234"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 105,
          "y": 4789
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "226":
    id: "226"
    taskid: a594c143-c013-4b11-8f2c-24719a636d09
    type: title
    task:
      id: a594c143-c013-4b11-8f2c-24719a636d09
      version: -1
      name: Close Alert as False Positive
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "227"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1290,
          "y": 5052
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "227":
    id: "227"
    taskid: 608aa89f-6d77-48f8-9768-8df5d0c97601
    type: regular
    task:
      id: 608aa89f-6d77-48f8-9768-8df5d0c97601
      version: -1
      name: Close Alert - False Positive
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "236"
    scriptarguments:
      closeNotes:
        simple: Resolved as False Positive - Handled by the playbook "Execution of an uncommon process at an early startup stage by Windows system binary". The resolution was made following a manual decision by the analyst.
      closeReason:
        simple: Resolved - False Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1290,
          "y": 5169
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "228":
    id: "228"
    taskid: 99ae2da1-42bf-4acc-8e36-82bb26560ddc
    type: regular
    task:
      id: 99ae2da1-42bf-4acc-8e36-82bb26560ddc
      version: -1
      name: Set malicious Action process
      description: Set multiple keys/values related to the malicious Action process to the context.
      scriptName: SetMultipleValues
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "105"
    scriptarguments:
      keys:
        simple: actionPath,actionSha256
      parent:
        simple: MaliciousActionProcess
      values:
        simple: ${Core.OriginalAlert.event.action_process_image_path},${Core.OriginalAlert.event.action_process_image_sha256}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 6081
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "229":
    id: "229"
    taskid: a0da660f-fb09-40ff-98cf-a3ff97c4f097
    type: condition
    task:
      id: a0da660f-fb09-40ff-98cf-a3ff97c4f097
      version: -1
      name: Checks if found related alerts indicating a malicious activity
      description: Determines the appropriate verdict based on the related alert within the current incident.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "1"
      "yes":
      - "125"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: foundIncidents.sourceBrand
            iscontext: true
          right:
            value: {}
      - - operator: isEqualString
          left:
            value:
              simple: foundIncidents.sourceBrand
            iscontext: true
          right:
            value:
              simple: TRAPS
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": -232
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "230":
    id: "230"
    taskid: 89dfe3bd-0a94-495f-8e9f-e649a19d0e85
    type: title
    task:
      id: 89dfe3bd-0a94-495f-8e9f-e649a19d0e85
      version: -1
      name: Bad Reputation Process
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "250"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 4377,
          "y": 271
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "231":
    id: "231"
    taskid: 35e44ae5-5865-4fd2-9e9d-e27908fb8814
    type: regular
    task:
      id: 35e44ae5-5865-4fd2-9e9d-e27908fb8814
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "232"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: Remediation
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 4377,
          "y": 658
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "232":
    id: "232"
    taskid: 46586eea-9f18-43ad-b12b-6559dc3c0f1a
    type: title
    task:
      id: 46586eea-9f18-43ad-b12b-6559dc3c0f1a
      version: -1
      name: Bad Reputation Process - Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 4377,
          "y": 794
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "233":
    id: "233"
    taskid: 30feb748-0d8d-4c21-bc74-cd24f69eb01d
    type: regular
    task:
      id: 30feb748-0d8d-4c21-bc74-cd24f69eb01d
      version: -1
      name: Set malicious Actor process
      description: Set multiple keys/values related to the malicious Actor process to the context.
      tags:
      - malicious_actor_process
      scriptName: SetMultipleValues
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "231"
    scriptarguments:
      keys:
        simple: actorPath,actorSha256
      parent:
        simple: MaliciousActorProcess
      values:
        simple: ${alert.initiatorpath.[0]},${alert.initiatorsha256.[0]}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 4377,
          "y": 542
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "234":
    id: "234"
    taskid: 7c4e7b34-0353-4e62-862f-f0674c5675e5
    type: regular
    task:
      id: 7c4e7b34-0353-4e62-862f-f0674c5675e5
      version: -1
      name: Close Alert - False Positive
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "237"
    scriptarguments:
      closeNotes:
        simple: Resolved as False Positive - Handled by the playbook "Execution of an uncommon process at an early startup stage by Windows system binary"
      closeReason:
        simple: Resolved - False Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 105,
          "y": 4916
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "235":
    id: "235"
    taskid: c361de8c-b5c6-4376-a804-929a26359a4d
    type: regular
    task:
      id: c361de8c-b5c6-4376-a804-929a26359a4d
      version: -1
      name: Set Malicious IIS Extension
      description: Set a value in the context under the key 'MaliciousIISExtension' for the malicious IIS module's DLL hash.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "175"
    scriptarguments:
      key:
        simple: MaliciousIISExtension
      value:
        complex:
          root: WildFire.Verdicts
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: WildFire.Verdicts.VerdictDescription
                iscontext: true
              right:
                value:
                  simple: malware
              ignorecase: true
            - operator: containsGeneral
              left:
                value:
                  simple: WildFire.Verdicts.VerdictDescription
                iscontext: true
              right:
                value:
                  simple: C2
              ignorecase: true
            - operator: containsGeneral
              left:
                value:
                  simple: WildFire.Verdicts.VerdictDescription
                iscontext: true
              right:
                value:
                  simple: phishing
              ignorecase: true
          accessor: SHA256
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -6513,
          "y": 4221
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "236":
    id: "236"
    taskid: 0022f17f-4553-4a5b-a396-87e94d1d25b6
    type: title
    task:
      id: 0022f17f-4553-4a5b-a396-87e94d1d25b6
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1290,
          "y": 5299
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "237":
    id: "237"
    taskid: fbc82e89-f247-4e0a-b0ee-92c7aff5a0a7
    type: title
    task:
      id: fbc82e89-f247-4e0a-b0ee-92c7aff5a0a7
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 105,
          "y": 5052
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "245":
    id: "245"
    taskid: 641da336-0277-4846-b0a5-44f0370e5982
    type: regular
    task:
      id: 641da336-0277-4846-b0a5-44f0370e5982
      version: -1
      name: Manual Registry Key Deletion
      description: "### Action Required:\n**Dear Analyst,** \n\nPlease manually delete the following registry key entry:\n\nRegistry Key:\n- ${XQLPersistenceQueryResults.results.action_registry_key_name}\n\nRegistry Key Value Name:\n- ${XQLPersistenceQueryResults.results.action_registry_value_name}\n\n"
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 899,
          "y": 7026
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "247":
    id: "247"
    taskid: 27572c31-c2f8-4310-b8a2-63171b2206ff
    type: condition
    task:
      id: 27572c31-c2f8-4310-b8a2-63171b2206ff
      version: -1
      name: Analyst Approval to block dll of malicious IIS module
      description: Analyst Approval to block dll of malicious IIS module.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "13"
      "Yes":
      - "68"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 7026
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
        simple: |-
          The playbook detected a malicious IIS module loaded by w3wp.exe using the following DLLs:

          ${MaliciousIISExtension}

          Should the hashes of these DLLs be added to the block list?
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
      replyOptions:
      - "Yes"
      - "No"
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "249":
    id: "249"
    taskid: d9c9a1c0-de3c-4c1c-8379-01de48ef6f9e
    type: condition
    task:
      id: d9c9a1c0-de3c-4c1c-8379-01de48ef6f9e
      version: -1
      name: Analyst Approval to disable the scheduled task
      description: Analyst Approval to disable the scheduled task.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "13"
      "Yes":
      - "21"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -25,
          "y": 7026
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
        simple: The playbook detected malicious activity and recommends disabling the scheduled task that triggers the process execution. Should the scheduled task be disabled?
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
      replyOptions:
      - "Yes"
      - "No"
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "250":
    id: "250"
    taskid: 644c3418-bf4c-4d55-a3d8-ee7409cedaf2
    type: condition
    task:
      id: 644c3418-bf4c-4d55-a3d8-ee7409cedaf2
      version: -1
      name: Checks if the actor process has a bad reputation
      description: |
        Determines the appropriate verdict based on the process reputation.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "231"
      "yes":
      - "233"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: alert.initiatorsha256
                      iscontext: true
                    ignorecase: true
                accessor: Score
            iscontext: true
          right:
            value: {}
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: alert.initiatorsha256
                      iscontext: true
                    ignorecase: true
                accessor: Score
            iscontext: true
          right:
            value:
              simple: "2"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 4377,
          "y": 383
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "251":
    id: "251"
    taskid: 0a10fa97-efdf-44af-a372-7e8ffda4141e
    type: regular
    task:
      id: 0a10fa97-efdf-44af-a372-7e8ffda4141e
      version: -1
      name: Set hash of malicious processes
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "254"
    scriptarguments:
      key:
        simple: MaliciousProcesses
      value:
        complex:
          root: DBotScore
          filters:
          - - operator: stringHasLength
              left:
                value:
                  simple: DBotScore.Indicator
                iscontext: true
              right:
                value:
                  simple: "64"
          - - operator: isEqualNumber
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 5638
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "252":
    id: "252"
    taskid: 52eeaecf-2bdc-4114-bc6b-5468f56fc38c
    type: title
    task:
      id: 52eeaecf-2bdc-4114-bc6b-5468f56fc38c
      version: -1
      name: Block malicious processes
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "251"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 5528
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "253":
    id: "253"
    taskid: dc95c523-2f61-4f6b-9900-e8df581e0120
    type: regular
    task:
      id: dc95c523-2f61-4f6b-9900-e8df581e0120
      version: -1
      name: Add hash to Block list
      description: Block lists requested files which have not already been block listed or added to allow lists.
      script: '|||core-blocklist-files'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "228"
    scriptarguments:
      comment:
        simple: The hash was added to the block list by the playbook "Execution of an uncommon process at an early startup stage by Windows system binary"
      hash_list:
        simple: ${MaliciousProcesses}
      incident_id:
        complex:
          root: alert
          accessor: parentXDRIncident
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '-'
              fields:
                value:
                  simple: "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 5928
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "254":
    id: "254"
    taskid: caeb8faf-808f-4fb6-b0f1-9486ed244db4
    type: condition
    task:
      id: caeb8faf-808f-4fb6-b0f1-9486ed244db4
      version: -1
      name: Found any malicious process?
      description: Checks whether any malicious processes were found.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "228"
      "Yes":
      - "253"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: MaliciousProcesses
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 5775
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "256":
    id: "256"
    taskid: 519f3a58-b9b3-4104-afe4-6fed921a4763
    type: regular
    task:
      id: 519f3a58-b9b3-4104-afe4-6fed921a4763
      version: -1
      name: Check XQL Quota
      description: Retrieve the amount of query quota available and used.
      script: '|||xdr-xql-get-quota'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "258"
      '#none#':
      - "259"
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": 432,
          "y": 383
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "258":
    id: "258"
    taskid: f2a65933-b88c-4b71-9d1a-11c4d98ee278
    type: regular
    task:
      id: f2a65933-b88c-4b71-9d1a-11c4d98ee278
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "220"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: AnalystDecision - XQL
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 105,
          "y": 1491
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "259":
    id: "259"
    taskid: b98be4b8-ff25-458c-86f6-2ce01e3ff67b
    type: condition
    task:
      id: b98be4b8-ff25-458c-86f6-2ce01e3ff67b
      version: -1
      name: Is there enough quota?
      description: Checks if there is enough query quota available.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "258"
      "yes":
      - "177"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.Quota
                accessor: license_quota
                transformers:
                - operator: subtraction
                  args:
                    by:
                      value:
                        simple: PaloAltoNetworksXQL.Quota.used_quota
                      iscontext: true
            iscontext: true
          right:
            value:
              simple: "1"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432,
          "y": 524
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "260":
    id: "260"
    taskid: b0738ecc-ab41-4c18-8029-d67a88ac15ee
    type: regular
    task:
      id: b0738ecc-ab41-4c18-8029-d67a88ac15ee
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "164"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: AnalystDecision - XQL
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1464,
          "y": 1776
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "261":
    id: "261"
    taskid: 8ffa4615-ff09-47b3-8a6a-8b55530da0e2
    type: regular
    task:
      id: 8ffa4615-ff09-47b3-8a6a-8b55530da0e2
      version: -1
      name: Check XQL Quota
      description: Retrieve the amount of query quota available and used.
      script: '|||xdr-xql-get-quota'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "260"
      '#none#':
      - "262"
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -870,
          "y": 644
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "262":
    id: "262"
    taskid: d17c2958-770f-4fe0-87ae-d978d42405fb
    type: condition
    task:
      id: d17c2958-770f-4fe0-87ae-d978d42405fb
      version: -1
      name: Is there enough quota?
      description: Checks if there is enough query quota available.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "260"
      "yes":
      - "143"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.Quota
                accessor: license_quota
                transformers:
                - operator: subtraction
                  args:
                    by:
                      value:
                        simple: PaloAltoNetworksXQL.Quota.used_quota
                      iscontext: true
            iscontext: true
          right:
            value:
              simple: "1"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -870,
          "y": 785
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "263":
    id: "263"
    taskid: c70498a7-d43c-48ae-8ca1-1be6abd109cb
    type: regular
    task:
      id: c70498a7-d43c-48ae-8ca1-1be6abd109cb
      version: -1
      name: Check XQL Quota
      description: Retrieve the amount of query quota available and used.
      script: '|||xdr-xql-get-quota'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "265"
      '#none#':
      - "264"
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -1958,
          "y": 383
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "264":
    id: "264"
    taskid: 2bc5b4d2-2105-401d-83f3-f517c4925358
    type: condition
    task:
      id: 2bc5b4d2-2105-401d-83f3-f517c4925358
      version: -1
      name: Is there enough quota?
      description: Checks if there is enough query quota available.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "265"
      "yes":
      - "127"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.Quota
                accessor: license_quota
                transformers:
                - operator: subtraction
                  args:
                    by:
                      value:
                        simple: PaloAltoNetworksXQL.Quota.used_quota
                      iscontext: true
            iscontext: true
          right:
            value:
              simple: "1"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1958,
          "y": 515
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "265":
    id: "265"
    taskid: b3c9f674-ac17-4cdc-8d56-54f5e5a763b2
    type: regular
    task:
      id: b3c9f674-ac17-4cdc-8d56-54f5e5a763b2
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "165"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: AnalystDecision - XQL
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2909,
          "y": 1503
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "266":
    id: "266"
    taskid: a73a7ea7-2e46-4e26-8b9d-4cc42e423c10
    type: regular
    task:
      id: a73a7ea7-2e46-4e26-8b9d-4cc42e423c10
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "169"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: AnalystDecision - XQL
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -4371,
          "y": 1491
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "267":
    id: "267"
    taskid: 9c81fd7f-c684-470e-9d61-4d2547e0b3d8
    type: regular
    task:
      id: 9c81fd7f-c684-470e-9d61-4d2547e0b3d8
      version: -1
      name: Check XQL Quota
      description: Retrieve the amount of query quota available and used.
      script: '|||xdr-xql-get-quota'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "266"
      '#none#':
      - "268"
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -3391,
          "y": 383
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "268":
    id: "268"
    taskid: 38c96959-d120-4be5-a723-9b248e40c144
    type: condition
    task:
      id: 38c96959-d120-4be5-a723-9b248e40c144
      version: -1
      name: Is there enough quota?
      description: Checks if there is enough query quota available.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "266"
      "yes":
      - "75"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.Quota
                accessor: license_quota
                transformers:
                - operator: subtraction
                  args:
                    by:
                      value:
                        simple: PaloAltoNetworksXQL.Quota.used_quota
                      iscontext: true
            iscontext: true
          right:
            value:
              simple: "1"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -3391,
          "y": 515
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "269":
    id: "269"
    taskid: ad8b6f6d-809e-43b6-81c9-96a91528159d
    type: regular
    task:
      id: ad8b6f6d-809e-43b6-81c9-96a91528159d
      version: -1
      name: Check XQL Quota
      description: Retrieve the amount of query quota available and used.
      script: '|||xdr-xql-get-quota'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "271"
      '#none#':
      - "270"
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -5838,
          "y": 753
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "270":
    id: "270"
    taskid: 3a2a9e3c-8b13-47c4-9f86-9a56d3b9b4ff
    type: condition
    task:
      id: 3a2a9e3c-8b13-47c4-9f86-9a56d3b9b4ff
      version: -1
      name: Is there enough quota?
      description: Checks if there is enough query quota available.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "271"
      "yes":
      - "180"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.Quota
                accessor: license_quota
                transformers:
                - operator: subtraction
                  args:
                    by:
                      value:
                        simple: PaloAltoNetworksXQL.Quota.used_quota
                      iscontext: true
            iscontext: true
          right:
            value:
              simple: "1"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5838,
          "y": 885
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "271":
    id: "271"
    taskid: 528f1ca9-7f02-43f0-8168-f332f050ce18
    type: regular
    task:
      id: 528f1ca9-7f02-43f0-8168-f332f050ce18
      version: -1
      name: Set the required response action
      description: Set a value in context under the key 'RequiredResponseAction' for verdict calculation.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "175"
    scriptarguments:
      key:
        simple: RequiredResponseAction
      value:
        simple: AnalystDecision - XQL
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -5345,
          "y": 1451
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "272":
    id: "272"
    taskid: 75e684b0-037b-46e2-9658-4d06c78c3fe1
    type: collection
    task:
      id: 75e684b0-037b-46e2-9658-4d06c78c3fe1
      version: -1
      name: XQL Failure - Analyst Decision
      description: Analyst review is required to determine whether to take remediation actions, or to close the alert as a false positive.
      tags:
      - analyst_decision
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "223"
    scriptarguments:
      key:
        simple: Message
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1159,
          "y": 4779
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: |-
            #### Processes execution tree:
            - CGO Process Name: ${alert.cgoname.[0]}
            - Actor Process Name: ${alert.initiatedby.[0]}
            - Action Process Name: ${alert.targetprocessname.[0]}

            ---

            The playbook failed to run the XQL query due to one of the following reasons:

            - The "XQL Query Engine" integration is not available.
            - XQL quota limit reached.

            Please run the relevant XQL query manually and select the appropriate action based on the results.

            ---

            ### Decision Required:
            Please choose the action you want to perform:

            - **False Positive** - Close the alert as a false positive.
            - **True Positive** - Handle the alert as a true positive by terminating, blocking, and quarantining the malicious processes.  *(Note: During the remediation stage, you will need to approve actions that affect malicious processes.)*
        required: true
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - simple: False Positive
        - simple: True Positive
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Analyst Decision
      description: ""
      sender: Your SOC team
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "106_102_No Action": 0.66,
      "110_13_#default#": 0.28,
      "120_174_yes": 0.44,
      "120_175_#default#": 0.1,
      "129_265_#error#": 0.57,
      "130_165_#default#": 0.19,
      "132_165_#default#": 0.21,
      "142_163_yes": 0.21,
      "142_164_#default#": 0.16,
      "142_261_Check dll loaded": 0.44,
      "145_260_#error#": 0.45,
      "149_150_Check dll reputation": 0.55,
      "149_163_Yes": 0.34,
      "149_164_#default#": 0.21,
      "153_163_yes": 0.33,
      "153_164_#default#": 0.17,
      "167_165_#default#": 0.41,
      "173_169_#default#": 0.36,
      "176_175_#default#": 0.12,
      "176_85_yes": 0.55,
      "179_258_#error#": 0.39,
      "189_100_Remediation": 0.22,
      "189_222_Analyst Decision - Registry": 0.51,
      "201_175_#default#": 0.19,
      "201_200_yes": 0.44,
      "207_175_#default#": 0.35,
      "210_175_#default#": 0.23,
      "21_37_#error#": 0.53,
      "223_100_True Positive": 0.2,
      "223_226_False Positive": 0.66,
      "229_125_yes": 0.9,
      "229_1_#default#": 0.48,
      "247_13_#default#": 0.16,
      "249_13_#default#": 0.2,
      "249_21_Yes": 0.41,
      "250_231_#default#": 0.32,
      "250_233_yes": 0.45,
      "256_258_#error#": 0.22,
      "259_177_yes": 0.44,
      "259_258_#default#": 0.24,
      "261_260_#error#": 0.25,
      "262_260_#default#": 0.26,
      "263_265_#error#": 0.37,
      "264_127_yes": 0.41,
      "264_265_#default#": 0.44,
      "267_266_#error#": 0.39,
      "268_266_#default#": 0.41,
      "268_75_yes": 0.51,
      "269_271_#error#": 0.36,
      "270_271_#default#": 0.45,
      "2_229_#default#": 0.46,
      "2_230_yes": 0.9,
      "41_13_yes": 0.18,
      "45_140_spoolsv.exe": 0.48,
      "45_48_WmiPrvSE.exe": 0.88,
      "45_51_LogonUI.exe": 0.88,
      "45_53_winlogon.exe": 0.9,
      "45_55_taskeng.exe - Schedule Task": 0.9,
      "45_58_w3wp.exe": 0.9,
      "45_69_#default#": 0.55,
      "50_160_#default#": 0.31,
      "52_159_#default#": 0.3,
      "54_155_yes": 0.41,
      "54_158_#default#": 0.28,
      "72_266_#error#": 0.5,
      "74_169_#default#": 0.27,
      "74_78_yes": 0.65,
      "74_80_yes": 0.45,
      "79_169_#default#": 0.19,
      "81_119_powershell": 0.61,
      "89_175_#default#": 0.1,
      "89_90_yes": 0.46,
      "99_172_#default#": 0.35
    },
    "paper": {
      "dimensions": {
        "height": 8956,
        "width": 11271,
        "x": -6513,
        "y": -932
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 8.9.0
