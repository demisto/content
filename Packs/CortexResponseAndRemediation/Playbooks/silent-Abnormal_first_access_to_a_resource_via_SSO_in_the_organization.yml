id: silent-Abnormal first access to a resource via SSO in the organization
version: -1
name: silent-Abnormal first access to a resource via SSO in the organization
issilent: true
tags:
- TA0001 - Initial Access
- TA0007 - Discovery
- T1078 - Valid Accounts
- T1580 - Cloud Service Discovery
description: |-
  **This playbook addresses the alert**: Abnormal first access to a resource via SSO in the organization.

  **Playbook Stages**:

  * **Triage**:
    * Collect initial authentication information.
    * Perform preliminary filtering; close alerts if initial anomaly score is zero or the authentication server is not Azure/Okta, or if the alert is excessively frequent (over 25 in 7 days).

  * **Investigation**:
    * **User and IP Risk Assessment**:
      * Check user details for recent creation/password changes (Azure & Okta).
      * Assess user risk score via Core and relevant Azure detections/alerts.
      * Determine IP reputation; if malicious and external, prepare for blocking.
    * **Authentication Log Analysis (Okta)**:
      * Analyze Okta logs for high failed login counts (over 5 in 24h) and suspicious authentication activities (e.g., MFA bypass, token grants).
    * **App Creation Details (If applicable)**:
      * Search for recent application creation events in Azure (XQL) or Okta.
      * Investigate the app creator's IP reputation and user agent, and their associated user risk/alerts.
      * Flag suspicious user agents (for both initial access and app creation).

  * **Containment**:
    * Automatically clear user sessions if suspicious evidence is found.
    * Present a summary of findings to an analyst for review and decision:
      * No action (close as False Positive).
      * Disable User Account (Okta/Azure AD).
      * Block App Access (Azure only via Conditional Access).
      * Apply Both Actions (Azure only).
    * Execute chosen containment action and close the incident accordingly (True Positive or False Positive).

  **Requirements**:
  For the best results, it's recommended to ensure these integrations are configured and working:
  - **Core**: For user risk evaluation and suspicious activity checks.
  - **Okta v2**: For authentication logs, session clearing, and user suspension.
  - **MicrosoftGraphIdentityandAccess**: For Azure user management (disable, block app access).
  - **MicrosoftGraphApplications**: For Azure application access management.
  - **Microsoft 365 Defender**: For Azure security alert hunting.
  - **Palo Alto Networks XQL**: For querying Azure cloud audit logs.
  - Any IP reputation integration that supports the `!ip` command.

starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 9cfac90c-a374-4b93-82af-9d4ec19e9d45
    type: start
    task:
      id: 9cfac90c-a374-4b93-82af-9d4ec19e9d45
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 48
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: ada1a3f2-d980-4b41-8702-8b6f3adc552f
    type: regular
    task:
      id: ada1a3f2-d980-4b41-8702-8b6f3adc552f
      version: -1
      name: Collect authentication information
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    reputationcalc: 2
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 175
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 827ff933-4792-4719-bbdb-7639c7c7b3a6
    type: condition
    task:
      id: 827ff933-4792-4719-bbdb-7639c7c7b3a6
      description: ""
      version: -1
      name: Preliminary Filter
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      "Yes":
      - "8"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isEqualNumber
          left:
            value:
              simple: Core.OriginalAlert.event.factory_anomaly_score
            iscontext: true
          right:
            value:
              simple: "0"
        - operator: isEmpty
          left:
            value:
              complex:
                root: Core.OriginalAlert.event.auth_server
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: Core.OriginalAlert.event.auth_server
                      iscontext: true
                    right:
                      value:
                        simple: Azure
                    ignorecase: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: Core.OriginalAlert.event.auth_server
                      iscontext: true
                    right:
                      value:
                        simple: Okta
                    ignorecase: true
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 476
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: f42fdc47-5f88-49a0-b8ae-407c6ac858a9
    type: title
    task:
      id: f42fdc47-5f88-49a0-b8ae-407c6ac858a9
      version: -1
      name: Check FP
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 331
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: a92686a8-3fa9-49c2-8c15-e28c6304528d
    type: regular
    task:
      id: a92686a8-3fa9-49c2-8c15-e28c6304528d
      version: -1
      name: Get alert frequency
      description: |-
        Searches Demisto alerts. A summarized version of this scrips is available with the summarizedversion argument.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSIAM/Cortex-XSIAM-Administrator-Guide/Permission-Management
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    scriptarguments:
      fromdate:
        simple: 7 days ago
      name:
        simple: Abnormal first access to a resource via SSO in the organization
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 678
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 3386f5ca-0e3a-4339-aba7-26df65c1e4b8
    type: condition
    task:
      id: 3386f5ca-0e3a-4339-aba7-26df65c1e4b8
      description: ""
      version: -1
      name: check if alert is frequent
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "9"
      "yes":
      - "8"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: foundIncidents
                filters:
                - - operator: isNotEmpty
                    left:
                      value:
                        simple: foundIncidents
                      iscontext: true
                accessor: id
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "25"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 845
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: a1576a21-d1f6-4909-9ab4-f52ab187a5bb
    type: regular
    task:
      id: a1576a21-d1f6-4909-9ab4-f52ab187a5bb
      version: -1
      name: Close Alert
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 875,
          "y": 986
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: 036f9cdc-8b73-4fb7-8bc9-7a791b72542b
    type: title
    task:
      id: 036f9cdc-8b73-4fb7-8bc9-7a791b72542b
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "35"
      - "123"
      - "71"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1028
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: 579b3494-3dc4-4910-8e2b-d87c35344489
    type: regular
    task:
      id: 579b3494-3dc4-4910-8e2b-d87c35344489
      version: -1
      name: Get IP reputation
      description: Checks the reputation of an IP address.
      script: '|||ip'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "52"
    scriptarguments:
      ip:
        complex:
          root: Core.OriginalAlert.event
          accessor: action_local_ip
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2283,
          "y": 1744
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: b2443870-7788-4f0a-b041-50238ebfc4e7
    type: title
    task:
      id: b2443870-7788-4f0a-b041-50238ebfc4e7
      version: -1
      name: Check If User Is Risky (Core)
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "13"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1791,
          "y": 1451
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 5896488a-e427-443b-8dd4-99e8616c8617
    type: regular
    task:
      id: 5896488a-e427-443b-8dd4-99e8616c8617
      version: -1
      name: Get core user risk score
      description: Retrieve the risk score of a specific user or list of users with the highest risk score in the environment along with the reason affecting each score.
      script: '|||core-list-risky-users'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      user_id:
        simple: ${alert.username}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1791,
          "y": 1593
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: e057e543-176a-43fd-873d-675301a499d4
    type: condition
    task:
      id: e057e543-176a-43fd-873d-675301a499d4
      version: -1
      name: Check user risk score
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex 6.x, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR on-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
        - For Cortex XSIAM, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSIAM/Cortex-XSIAM-Documentation/Create-a-script
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "117"
      HIGH:
      - "22"
    separatecontext: false
    conditions:
    - label: HIGH
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.RiskyUser.riask_level
            iscontext: true
          right:
            value:
              simple: HIGH
          ignorecase: true
      - - operator: isEqualString
          left:
            value:
              simple: Core.RiskyUser.id
            iscontext: true
          right:
            value:
              simple: alert.username
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1791,
          "y": 1749
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: e8c9ca85-93d3-4b34-8444-9f56d57339b9
    type: regular
    task:
      id: e8c9ca85-93d3-4b34-8444-9f56d57339b9
      version: -1
      name: Get Azure risky user detections
      description: Returns a comma-separated list of the Risk Detection objects and their properties.
      script: '|||azure-risky-users-risk-detections-list'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      detected_date_time_after:
        simple: ${TimeNow}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -315,
          "y": 1729
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: 65188544-a2b9-423a-ad68-ca1b5fc01939
    type: regular
    task:
      id: 65188544-a2b9-423a-ad68-ca1b5fc01939
      version: -1
      name: Get timestamp for Azure detections
      description: |
        Retrieves the current date and time.
      scriptName: GetTime
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      dateFormat:
        simple: ISO
      daysAgo:
        simple: "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -315,
          "y": 1587
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: fdbaca4c-df01-4f7e-8882-ebe4678f76cc
    type: title
    task:
      id: fdbaca4c-df01-4f7e-8882-ebe4678f76cc
      version: -1
      name: Check For Azure Alerts
      description: Returns a list of all risky users and their properties.
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -315,
          "y": 2003
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: d4a46369-484f-46d0-add2-c52e34ff6091
    type: regular
    task:
      id: d4a46369-484f-46d0-add2-c52e34ff6091
      version: -1
      name: Get Azure alerts
      description: 'Advanced hunting is a threat-hunting tool that uses specially constructed queries to examine the past 30 days of event data in Microsoft 365 Defender. Details on how to write queries: https://docs.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-query-language?view=o365-worldwide.'
      script: '|||microsoft-365-defender-advanced-hunting'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "19"
    scriptarguments:
      query:
        simple: let _start = now(-1d); AlertEvidence | where Timestamp >= _start | where AccountUpn == "${Core.OriginalAlert.raw_abioc.event.auth_identity}"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -315,
          "y": 2130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: 183c8e5f-3f8f-45e6-9c2a-c6d597ecb72d
    type: regular
    task:
      id: 183c8e5f-3f8f-45e6-9c2a-c6d597ecb72d
      version: -1
      name: Extract Azure user alerts
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex 6.x, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR on-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
        - For Cortex XSIAM, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSIAM/Cortex-XSIAM-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "105"
    scriptarguments:
      key:
        simple: AzureSecurityAlerts
      value:
        complex:
          root: Microsoft365Defender.Hunt.results
          filters:
          - - operator: isNotEqualString
              left:
                value:
                  simple: Microsoft365Defender.Hunt.results.Severity
                iscontext: true
              right:
                value:
                  simple: Informational
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: Microsoft365Defender.Hunt.results.AccountUpn
                iscontext: true
              right:
                value:
                  simple: Core.OriginalAlert.raw_abioc.event.auth_identity
                iscontext: true
          - - operator: isNotEqualString
              left:
                value:
                  simple: Microsoft365Defender.Hunt.results.Severity
                iscontext: true
              right:
                value:
                  simple: Low
              ignorecase: true
          - - operator: isNotEqualString
              left:
                value:
                  simple: Microsoft365Defender.Hunt.results.Severity
                iscontext: true
              right:
                value:
                  simple: Informational
              ignorecase: true
          accessor: Title
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -315,
          "y": 2270
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: 99b491d2-e400-4c24-b270-c4050e38cd32
    type: regular
    task:
      id: 99b491d2-e400-4c24-b270-c4050e38cd32
      version: -1
      name: Extract Azure user detections
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6.x, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
        - For Cortex XSIAM, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSIAM/Cortex-XSIAM-Documentation/Automations
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      key:
        simple: UserRiskyAzureDetections
      value:
        complex:
          root: AzureRiskyUsers.RiskDetection
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.userPrincipalName
                iscontext: true
              right:
                value:
                  simple: Core.OriginalAlert.raw_abioc.event.auth_identity
                iscontext: true
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
                iscontext: true
              right:
                value:
                  simple: atRisk
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
                iscontext: true
              right:
                value:
                  simple: confirmedCompromised
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskLevel
                iscontext: true
              right:
                value:
                  simple: medium
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskLevel
                iscontext: true
              right:
                value:
                  simple: high
              ignorecase: true
          accessor: riskEventType
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -315,
          "y": 1872
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 23bdd7ec-5105-4f5a-9d2d-ce435a443b16
    type: regular
    task:
      id: 23bdd7ec-5105-4f5a-9d2d-ce435a443b16
      version: -1
      name: Get risky user activity
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6.x, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
        - For Cortex XSIAM, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSIAM/Cortex-XSIAM-Documentation/Automationsscript
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "105"
    scriptarguments:
      key:
        simple: UserRiskyCoreReason
      value:
        complex:
          root: Core.RiskyUser
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: Core.RiskyUser.id
                iscontext: true
              right:
                value:
                  simple: alert.username
          accessor: reasons.description
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1621,
          "y": 2415
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: e5041fc4-d473-4ac0-8d16-f6504b37421c
    type: title
    task:
      id: e5041fc4-d473-4ac0-8d16-f6504b37421c
      version: -1
      name: Get IOC Reputation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "28"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2283,
          "y": 1445
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: 6ad88676-345e-4f0f-99a4-c29e4d4e18d1
    type: condition
    task:
      id: 6ad88676-345e-4f0f-99a4-c29e4d4e18d1
      description: ""
      version: -1
      name: Check external IP presence
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "117"
      "yes":
      - "10"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: Core.OriginalAlert.event.action_local_ip
            iscontext: true
          right:
            value: {}
      - - operator: IsNotInCidrRanges
          left:
            value:
              simple: Core.OriginalAlert.event.action_local_ip
            iscontext: true
          right:
            value:
              simple: 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2283,
          "y": 1579
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 82295d9e-e6e5-40dc-8f00-3161b260b35b
    type: regular
    task:
      id: 82295d9e-e6e5-40dc-8f00-3161b260b35b
      version: -1
      name: Get user details (Azure)
      description: |-
        Retrieves the properties and relationships of a user object. For more information, visit: https://learn.microsoft.com/en-us/graph/api/user-get?view=graph-rest-1.0&tabs=http.
        Permissions: - User.Read (Delegated) - User.Read.All (Application).
      script: '|||msgraph-user-get'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "31"
    scriptarguments:
      properties:
        simple: createdDateTime,lastPasswordChangeDateTime
      user:
        simple: ${Core.OriginalAlert.event.auth_identity}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -962,
          "y": 1591
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: 1d849446-fafd-45df-a084-a1d3e6da7beb
    type: title
    task:
      id: 1d849446-fafd-45df-a084-a1d3e6da7beb
      version: -1
      name: Check User Details
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "29"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -962,
          "y": 1451
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: 9161227d-7ef0-4e21-999f-23932c62176a
    type: condition
    task:
      id: 9161227d-7ef0-4e21-999f-23932c62176a
      description: ""
      version: -1
      name: Check if user created recently
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "119"
      "yes":
      - "34"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: AfterRelativeDate
          left:
            value:
              complex:
                root: MSGraphUser
                accessor: CreatedDateTime
                transformers:
                - operator: ModifyDateTime
                  args:
                    variation:
                      value:
                        simple: in 3 days
            iscontext: true
          right:
            value:
              simple: ${alert.timestamp}
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -962,
          "y": 1733
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 9978092f-3173-4537-9e31-b791583761ae
    type: regular
    task:
      id: 9978092f-3173-4537-9e31-b791583761ae
      version: -1
      name: Set suspicious user details
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "119"
    scriptarguments:
      key:
        simple: SuspiciousUserDetails
      value:
        simple: The user has been created recently.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -962,
          "y": 1881
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: 6d12bffd-a69c-40dc-a8e1-6e645c69fec5
    type: condition
    task:
      id: 6d12bffd-a69c-40dc-a8e1-6e645c69fec5
      description: ""
      version: -1
      name: Check Auth Server
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      Azure:
      - "36"
      Okta:
      - "38"
    separatecontext: false
    conditions:
    - label: Azure
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.auth_server
            iscontext: true
          right:
            value:
              simple: Azure
          ignorecase: true
    - label: Okta
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.auth_server
            iscontext: true
          right:
            value:
              simple: Okta
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1169
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: 916e94f7-d74b-4772-9d26-f68bcae3308f
    type: title
    task:
      id: 916e94f7-d74b-4772-9d26-f68bcae3308f
      version: -1
      name: Azure
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "30"
      - "37"
      - "183"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -664,
          "y": 1324
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: 26fae437-4ab1-42da-9ab0-d9e08b2a5a2f
    type: title
    task:
      id: 26fae437-4ab1-42da-9ab0-d9e08b2a5a2f
      version: -1
      name: Check user risk score (Azure)
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "16"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -315,
          "y": 1459
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: 8a890336-974e-4bc5-bdfb-20be8f3f4bdf
    type: title
    task:
      id: 8a890336-974e-4bc5-bdfb-20be8f3f4bdf
      version: -1
      name: Okta
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "43"
      - "46"
      - "48"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1324
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 71a1d6d9-a0c1-497b-9abd-a23f152f71b1
    type: title
    task:
      id: 71a1d6d9-a0c1-497b-9abd-a23f152f71b1
      version: -1
      name: Check user details
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "44"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 185,
          "y": 1458
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: 5f2e20d7-05b3-4cb1-a875-4017e030c515
    type: regular
    task:
      id: 5f2e20d7-05b3-4cb1-a875-4017e030c515
      version: -1
      name: Get user details (Okta)
      description: Fetches information for a single user. You must enter one or more parameters for the command to run.
      script: '|||okta-get-user'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "45"
    scriptarguments:
      username:
        simple: ${Core.OriginalAlert.event.auth_identity}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 185,
          "y": 1575
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: 34f4f3bc-6798-42f8-aeb2-2d001403e882
    type: condition
    task:
      id: 34f4f3bc-6798-42f8-aeb2-2d001403e882
      description: ""
      version: -1
      name: Check user creation date
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "109"
      recently:
      - "108"
    separatecontext: false
    conditions:
    - label: recently
      condition:
      - - operator: AfterRelativeDate
          left:
            value:
              complex:
                root: Account
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: Account.Type
                      iscontext: true
                    right:
                      value:
                        simple: Okta
                    ignorecase: true
                accessor: Created
                transformers:
                - operator: ModifyDateTime
                  args:
                    variation:
                      value:
                        simple: in 3 days
            iscontext: true
          right:
            value:
              simple: ${alert.timestamp}
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 185,
          "y": 1729
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: dad14a57-103e-4614-af7d-8fd9a844b243
    type: title
    task:
      id: dad14a57-103e-4614-af7d-8fd9a844b243
      version: -1
      name: Check User Agent
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "107"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 687,
          "y": 1459
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: 405ca251-e318-4d40-83c2-a9b4394db008
    type: title
    task:
      id: 405ca251-e318-4d40-83c2-a9b4394db008
      version: -1
      name: Check Okta Logs
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "50"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1189,
          "y": 1453
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "49":
    id: "49"
    taskid: 002230a4-0e10-4529-810d-0ddb4fb8ab5c
    type: regular
    task:
      id: 002230a4-0e10-4529-810d-0ddb4fb8ab5c
      version: -1
      name: Search for suspicious authentication activity
      description: Gets logs by providing optional filters.
      script: '|||okta-get-logs'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "113"
    scriptarguments:
      extend-context:
        simple: OktaLogs=.
      filter:
        simple: (outcome.result eq "SUCCESS" AND (eventType eq "app.oauth2.client_id_rate_limit_warning" OR eventType eq "user.mfa.attempt_bypass")) OR (outcome.result eq "FAILURE" AND (eventType eq "user.account.lock" OR eventType eq "user.authentication.auth_via_social" OR eventType eq "user.account.unlock" OR eventType eq "user.account.use_token" OR eventType eq "app.oauth2.token.grant" OR eventType eq "app.oauth2.as.evaluate.claim" OR eventType eq "app.oauth2.as.token.revoke")) AND actor.alternateId eq "${Core.OriginalAlert.event.auth_normalized_user.upn}"
      ignore-outputs:
        simple: "true"
      since:
        simple: ${TimeNow}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1189,
          "y": 2130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "50":
    id: "50"
    taskid: cbf5a7e3-0a2c-4ce0-8d45-6c02253d49cc
    type: regular
    task:
      id: cbf5a7e3-0a2c-4ce0-8d45-6c02253d49cc
      version: -1
      name: Get timestamp for Okta logs
      description: |
        Retrieves the current date and time.
      scriptName: GetTime
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "51"
    scriptarguments:
      dateFormat:
        simple: ISO
      daysAgo:
        simple: "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1189,
          "y": 1572
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "51":
    id: "51"
    taskid: ccfe2aff-22ab-4305-8832-9921e68f7e34
    type: regular
    task:
      id: ccfe2aff-22ab-4305-8832-9921e68f7e34
      version: -1
      name: Get Okta failed logins in last day
      description: Returns failed login events.
      script: '|||okta-get-failed-logins'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "111"
    scriptarguments:
      extend-context:
        simple: FailedLogins=.
      ignore-outputs:
        simple: "true"
      since:
        simple: ${TimeNow}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1189,
          "y": 1704
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: ebf17c12-46de-463d-a865-331cac236307
    type: condition
    task:
      id: ebf17c12-46de-463d-a865-331cac236307
      version: -1
      name: Is the IP malicious?
      description: Checks if the external Source IP is malicious (DBotScore above 2).
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "117"
      "Yes":
      - "53"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore.Indicator
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                - - operator: greaterThan
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "2"
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: alert.localip
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2283,
          "y": 1882
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "53":
    id: "53"
    taskid: 35f77152-9514-483a-83fc-433c46f9ae37
    type: condition
    task:
      id: 35f77152-9514-483a-83fc-433c46f9ae37
      description: ""
      version: -1
      name: Check Auth Server
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      Azure:
      - "54"
      Okta:
      - "66"
    separatecontext: false
    conditions:
    - label: Azure
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.auth_server
            iscontext: true
          right:
            value:
              simple: Azure
          ignorecase: true
    - label: Okta
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.auth_server
            iscontext: true
          right:
            value:
              simple: Okta
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2283,
          "y": 2023
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "54":
    id: "54"
    taskid: 5054e63f-06c7-43b0-9350-c6f8e1df7e7a
    type: title
    task:
      id: 5054e63f-06c7-43b0-9350-c6f8e1df7e7a
      version: -1
      name: Block external IP - Azure
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "102"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2050,
          "y": 2183
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "66":
    id: "66"
    taskid: 8fcc1012-5bb8-41e2-9ede-e3e270b5e98b
    type: title
    task:
      id: 8fcc1012-5bb8-41e2-9ede-e3e270b5e98b
      version: -1
      name: Add IP to BlockedIpZone - Okta
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "103"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2520,
          "y": 2183
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "71":
    id: "71"
    taskid: c6a949cc-4dca-4096-8474-0505f4fc67e5
    type: title
    task:
      id: c6a949cc-4dca-4096-8474-0505f4fc67e5
      version: -1
      name: Search App Creation Details
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "149"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2135,
          "y": 1456
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "72":
    id: "72"
    taskid: 1724729f-ea97-4f10-bcc6-c7be5829e906
    type: regular
    task:
      id: 1724729f-ea97-4f10-bcc6-c7be5829e906
      version: -1
      name: Search for app creation event - Azure
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "73"
    scriptarguments:
      query:
        simple: |-
          dataset = cloud_audit_logs
          | filter event_type = ENUM.CLOUD_AUDIT_LOGS and cloud_provider = "Azure"
          | filter referenced_resource_name = "${Core.OriginalAlert.event.auth_target}" and operation_name = "Create"
          | dedup caller_ip, identity_invoked_by_name, user_agent
          | fields caller_ip, identity_invoked_by_name, user_agent
          | limit 1
      query_name:
        simple: Azure app creation details
      time_frame:
        simple: 3 days ago
      timeout_in_seconds:
        simple: "120"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1918,
          "y": 1744
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "73":
    id: "73"
    taskid: a526bc62-de01-4ad0-87f6-718771ed5584
    type: condition
    task:
      id: a526bc62-de01-4ad0-87f6-718771ed5584
      description: ""
      version: -1
      name: Check if app created recently
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "151"
      "yes":
      - "74"
      - "85"
      - "100"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: PaloAltoNetworksXQL.GenericQuery.results.identity_invoked_by_name
            iscontext: true
          right:
            value: {}
        - operator: isNotEmpty
          left:
            value:
              simple: Okta.Logs.Events.actor.alternateId
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2135,
          "y": 1874
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "74":
    id: "74"
    taskid: 92572882-b39a-4c2c-b91d-de28b6fd5ebd
    type: regular
    task:
      id: 92572882-b39a-4c2c-b91d-de28b6fd5ebd
      version: -1
      name: Get app creator IP reputation
      description: Checks the reputation of an IP address.
      script: '|||ip'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "75"
    scriptarguments:
      ip:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery.results
          accessor: caller_ip
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: Okta.Logs.Events.request.ipChain.[0].ip
                iscontext: true
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1395,
          "y": 2062
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "75":
    id: "75"
    taskid: d14711ee-6611-42ba-90f0-4ef8b6024e8b
    type: condition
    task:
      id: d14711ee-6611-42ba-90f0-4ef8b6024e8b
      version: -1
      name: Is the IP malicious?
      description: Checks if the external Source IP is malicious (DBotScore above 2).
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "121"
      "Yes":
      - "177"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore.Indicator
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                - - operator: greaterThan
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "2"
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.caller_ip
                      iscontext: true
                    ignorecase: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: Okta.Logs.Events.request.ipChain.[0].ip
                      iscontext: true
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1395,
          "y": 2200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "76":
    id: "76"
    taskid: b81af4c6-8999-441d-8fc1-22cd6a3646ff
    type: title
    task:
      id: b81af4c6-8999-441d-8fc1-22cd6a3646ff
      version: -1
      name: Block external IP - Azure
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "104"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1585,
          "y": 2518
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "85":
    id: "85"
    taskid: 99b10815-7e27-4340-96aa-0b24fd472d4b
    type: condition
    task:
      id: 99b10815-7e27-4340-96aa-0b24fd472d4b
      version: -1
      name: Check for a suspicious user agent
      description: This task examines the user agent strings in the alert for known suspicious patterns. It checks for specific tools often used in automated attacks or scraping. Additionally, it verifies if there's at least one new user agent for this user. If both conditions are met, it triggers remediation; otherwise, it proceeds to close the alert.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "121"
      "Yes":
      - "118"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.GenericQuery.results.user_agent
                filters:
                - - operator: match
                    left:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.user_agent
                      iscontext: true
                    right:
                      value:
                        simple: \b(Mozilla|Python-urllib|libwww-perl|Scrapy|curl|Wget|sqlmap|Nikto|Xrumer|Hydra|JohnTheRipper|LOIC|HOIC|MJ12bot|Baiduspider|BlackWidow|HeadlessChrome|PhantomJS|Selenium|python-requests|node-fetch|PostmanRuntime|GuzzleHttp)\b
            iscontext: true
          right:
            value: {}
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: Okta.Logs.Events.client.userAgent.rawUserAgent
                filters:
                - - operator: match
                    left:
                      value:
                        simple: Okta.Logs.Events.client.userAgent.rawUserAgent
                      iscontext: true
                    right:
                      value:
                        simple: \b(Mozilla|Python-urllib|libwww-perl|Scrapy|curl|Wget|sqlmap|Nikto|Xrumer|Hydra|JohnTheRipper|LOIC|HOIC|MJ12bot|Baiduspider|BlackWidow|HeadlessChrome|PhantomJS|Selenium|python-requests|node-fetch|PostmanRuntime|GuzzleHttp)\b
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1810,
          "y": 2060
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "86":
    id: "86"
    taskid: 021631d0-6f0a-48db-947c-31ec2d5213a6
    type: regular
    task:
      id: 021631d0-6f0a-48db-947c-31ec2d5213a6
      version: -1
      name: Block IP with conditional access
      description: Blocks an external IP via Azure Conditional Access using named IP location and policy JSON.
      scriptName: MSGraphIdentityBlockExternalIPWithCAPolicy
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "105"
    scriptarguments:
      ip:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery.results
          accessor: caller_ip
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1585,
          "y": 2791
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "87":
    id: "87"
    taskid: 2fec4731-0a9c-4498-a8e8-acabaef193aa
    type: regular
    task:
      id: 2fec4731-0a9c-4498-a8e8-acabaef193aa
      version: -1
      name: Block IP with conditional access
      description: Blocks an external IP via Azure Conditional Access using named IP location and policy JSON.
      scriptName: MSGraphIdentityBlockExternalIPWithCAPolicy
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "105"
    scriptarguments:
      ip:
        simple: ${alert.localip}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2050,
          "y": 2448
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "88":
    id: "88"
    taskid: 5feb8706-caf5-4363-8576-01b2f16b030d
    type: regular
    task:
      id: 5feb8706-caf5-4363-8576-01b2f16b030d
      version: -1
      name: Add IP to BlockedIpZone
      description: Checks if an IP is already covered by CIDR/range in Okta BlockedIpZone. If not, it adds it.
      scriptName: OktaAddIPToBlockedIpZone
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "105"
    scriptarguments:
      ip:
        simple: ${alert.localip}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2520,
          "y": 2448
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "89":
    id: "89"
    taskid: 0e30f0cb-6a55-41c2-8e73-652e9b055565
    type: regular
    task:
      id: 0e30f0cb-6a55-41c2-8e73-652e9b055565
      version: -1
      name: Get Azure risky user detections
      description: Returns a comma-separated list of the Risk Detection objects and their properties.
      script: '|||azure-risky-users-risk-detections-list'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "94"
    scriptarguments:
      detected_date_time_after:
        simple: ${CreatingTimeNow}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2081,
          "y": 2586
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "90":
    id: "90"
    taskid: 1f052d8f-36b4-4452-b623-5b6caed9d60e
    type: regular
    task:
      id: 1f052d8f-36b4-4452-b623-5b6caed9d60e
      version: -1
      name: Get timestamp for Azure detections
      description: |
        Retrieves the current date and time.
      scriptName: GetTime
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "89"
    scriptarguments:
      contextKey:
        simple: Creating
      dateFormat:
        simple: ISO
      daysAgo:
        simple: "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2081,
          "y": 2464
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "91":
    id: "91"
    taskid: 2dff759b-72fc-44d6-8dc9-091ee067f01f
    type: title
    task:
      id: 2dff759b-72fc-44d6-8dc9-091ee067f01f
      version: -1
      name: Check For Azure Alerts
      description: Returns a list of all risky users and their properties.
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "92"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2515,
          "y": 2355
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "92":
    id: "92"
    taskid: 01ac569e-3911-4030-b81c-adfbb32e7955
    type: regular
    task:
      id: 01ac569e-3911-4030-b81c-adfbb32e7955
      version: -1
      name: Get Azure alerts
      description: 'Advanced hunting is a threat-hunting tool that uses specially constructed queries to examine the past 30 days of event data in Microsoft 365 Defender. Details on how to write queries: https://docs.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-query-language?view=o365-worldwide.'
      script: '|||microsoft-365-defender-advanced-hunting'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "93"
    scriptarguments:
      query:
        simple: let _start = now(-1d); AlertEvidence | where Timestamp >= _start | where AccountUpn == "${PaloAltoNetworksXQL.GenericQuery.results.[0].identity_invoked_by_name}"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2516,
          "y": 2485
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "93":
    id: "93"
    taskid: f2a95ab1-5ed7-488f-ad56-817b8f0318f8
    type: regular
    task:
      id: f2a95ab1-5ed7-488f-ad56-817b8f0318f8
      version: -1
      name: Extract Azure user alerts
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex 6.x, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR on-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
        - For Cortex XSIAM, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSIAM/Cortex-XSIAM-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "122"
    scriptarguments:
      key:
        simple: AzureSecurityAlertsCreatingUser
      value:
        complex:
          root: Microsoft365Defender.Hunt.results
          filters:
          - - operator: isNotEqualString
              left:
                value:
                  simple: Microsoft365Defender.Hunt.results.Severity
                iscontext: true
              right:
                value:
                  simple: Informational
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: Microsoft365Defender.Hunt.results.AccountUpn
                iscontext: true
              right:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.results.[0].identity_invoked_by_name
                iscontext: true
          - - operator: isNotEqualString
              left:
                value:
                  simple: Microsoft365Defender.Hunt.results.Severity
                iscontext: true
              right:
                value:
                  simple: Low
              ignorecase: true
          - - operator: isNotEqualString
              left:
                value:
                  simple: Microsoft365Defender.Hunt.results.Severity
                iscontext: true
              right:
                value:
                  simple: Informational
              ignorecase: true
          accessor: Title
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2516,
          "y": 2630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "94":
    id: "94"
    taskid: 92c0dce4-01ce-4828-bb70-ed5d2bb81355
    type: regular
    task:
      id: 92c0dce4-01ce-4828-bb70-ed5d2bb81355
      version: -1
      name: Extract Azure user detections
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6.x, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
        - For Cortex XSIAM, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSIAM/Cortex-XSIAM-Documentation/Automations
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "122"
    scriptarguments:
      key:
        simple: CreatingUserRiskyAzureDetections
      value:
        complex:
          root: AzureRiskyUsers.RiskDetection
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.userPrincipalName
                iscontext: true
              right:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.results.[0].identity_invoked_by_name
                iscontext: true
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
                iscontext: true
              right:
                value:
                  simple: atRisk
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
                iscontext: true
              right:
                value:
                  simple: confirmedCompromised
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskLevel
                iscontext: true
              right:
                value:
                  simple: medium
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskLevel
                iscontext: true
              right:
                value:
                  simple: high
              ignorecase: true
          accessor: riskEventType
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2081,
          "y": 2700
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "95":
    id: "95"
    taskid: f8a5c1eb-ff8a-4044-8d0e-701ab4bf269e
    type: title
    task:
      id: f8a5c1eb-ff8a-4044-8d0e-701ab4bf269e
      version: -1
      name: Check user risk score (Azure)
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "90"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2081,
          "y": 2355
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "96":
    id: "96"
    taskid: e7f70091-e86b-4ab5-bbf3-abcab0f2c5f2
    type: title
    task:
      id: e7f70091-e86b-4ab5-bbf3-abcab0f2c5f2
      version: -1
      name: Check Creating User Risky (Core)
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "101"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2947,
          "y": 2226
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "98":
    id: "98"
    taskid: 44e291f6-3763-4fac-8c3c-30f04c2c39eb
    type: condition
    task:
      id: 44e291f6-3763-4fac-8c3c-30f04c2c39eb
      version: -1
      name: Check user risk score
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex 6.x, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR on-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
        - For Cortex XSIAM, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSIAM/Cortex-XSIAM-Documentation/Create-a-script
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      HIGH:
      - "99"
    separatecontext: false
    conditions:
    - label: HIGH
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.RiskyUser.riask_level
            iscontext: true
          right:
            value:
              simple: HIGH
          ignorecase: true
      - - operator: isEqualString
          left:
            value:
              simple: Core.RiskyUser.id
            iscontext: true
          right:
            value:
              simple: ${PaloAltoNetworksXQL.GenericQuery.results.[0].identity_invoked_by_name=val.split('@')[1].split('.')[0] + '\\' + val.split('@')[0]}
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2947,
          "y": 2516
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "99":
    id: "99"
    taskid: 1da66727-a119-441d-aca6-a9a8a860a93a
    type: regular
    task:
      id: 1da66727-a119-441d-aca6-a9a8a860a93a
      version: -1
      name: Get risky user activity
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6.x, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
        - For Cortex XSIAM, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSIAM/Cortex-XSIAM-Documentation/Automationsscript
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "122"
    scriptarguments:
      key:
        simple: CreatingUserRiskyCoreReason
      value:
        complex:
          root: Core.RiskyUser
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: Core.RiskyUser.id
                iscontext: true
              right:
                value:
                  simple: ${PaloAltoNetworksXQL.GenericQuery.results.[0].identity_invoked_by_name=val.split('@')[1].split('.')[0] + '\\' + val.split('@')[0]}
                iscontext: true
          accessor: reasons.description
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2947,
          "y": 2676
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "100":
    id: "100"
    taskid: d975aed8-a110-44d8-b26b-4b690ac9a39f
    type: condition
    task:
      id: d975aed8-a110-44d8-b26b-4b690ac9a39f
      description: ""
      version: -1
      name: Check if creating user is different
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "122"
      "yes":
      - "96"
      - "150"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEqualString
          left:
            value:
              simple: PaloAltoNetworksXQL.GenericQuery.results.identity_invoked_by_name
            iscontext: true
          right:
            value:
              simple: Core.OriginalAlert.raw_abioc.event.auth_identity
            iscontext: true
      - - operator: isNotEqualString
          left:
            value:
              simple: Okta.Logs.Events.actor.alternateId
            iscontext: true
          right:
            value:
              simple: Core.OriginalAlert.raw_abioc.event.auth_identity
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2516,
          "y": 2052
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "101":
    id: "101"
    taskid: 8de8fbb4-7699-4237-a14b-25df4d22751b
    type: regular
    task:
      id: 8de8fbb4-7699-4237-a14b-25df4d22751b
      version: -1
      name: Get core user risk score
      description: Retrieve the risk score of a specific user or list of users with the highest risk score in the environment along with the reason affecting each score.
      script: '|||core-list-risky-users'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "98"
    scriptarguments:
      user_id:
        simple: ${PaloAltoNetworksXQL.GenericQuery.results.identity_invoked_by_name=val.split('@')[1].split('.')[0] + '\\' + val.split('@')[0]}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2947,
          "y": 2378
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "102":
    id: "102"
    taskid: d6062ecc-c261-4d38-a9e6-9934827a854a
    type: condition
    task:
      id: d6062ecc-c261-4d38-a9e6-9934827a854a
      version: -1
      name: Verify integration availability (Azure)
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "185"
      "yes":
      - "87"
    scriptarguments:
      brandname:
        simple: MicrosoftGraphIdentityandAccess
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2050,
          "y": 2303
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "103":
    id: "103"
    taskid: 027728a3-94ce-47c3-9265-0dd7712c996f
    type: condition
    task:
      id: 027728a3-94ce-47c3-9265-0dd7712c996f
      version: -1
      name: Verify integration availability (Okta)
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "185"
      "yes":
      - "88"
    scriptarguments:
      brandname:
        simple: Okta v2
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2520,
          "y": 2303
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "104":
    id: "104"
    taskid: d85f28c3-595f-498e-85f6-a7b0ac53552c
    type: condition
    task:
      id: d85f28c3-595f-498e-85f6-a7b0ac53552c
      version: -1
      name: Verify integration availability (Azure)
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "188"
      "yes":
      - "86"
    scriptarguments:
      brandname:
        simple: MicrosoftGraphIdentityandAccess
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1585,
          "y": 2640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "105":
    id: "105"
    taskid: b03d9194-a08b-4b78-ab1b-4f4b6474f7dc
    type: title
    task:
      id: b03d9194-a08b-4b78-ab1b-4f4b6474f7dc
      version: -1
      name: Check For Suspicious Evidence
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "124"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 489,
          "y": 3090
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "106":
    id: "106"
    taskid: 38a5e11a-2e87-4c47-9d1d-60384268415a
    type: regular
    task:
      id: 38a5e11a-2e87-4c47-9d1d-60384268415a
      version: -1
      name: Save user agent as evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "105"
    scriptarguments:
      key:
        simple: SuspiciousUA
      value:
        simple: ${Core.OriginalAlert.event.action_user_agent}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 737,
          "y": 1854
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "107":
    id: "107"
    taskid: cf910269-6d04-4c1c-b0eb-03b1deaa05e1
    type: condition
    task:
      id: cf910269-6d04-4c1c-b0eb-03b1deaa05e1
      description: ""
      version: -1
      name: Check for a suspicious user agent
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "116"
      "yes":
      - "106"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: Core.OriginalAlert.event.action_user_agent
                filters:
                - - operator: match
                    left:
                      value:
                        simple: Core.OriginalAlert.event.action_user_agent
                      iscontext: true
                    right:
                      value:
                        simple: \b(Python-urllib|libwww-perl|Scrapy|curl|Wget|sqlmap|Nikto|Xrumer|Hydra|JohnTheRipper|LOIC|HOIC|MJ12bot|Baiduspider|BlackWidow|HeadlessChrome|PhantomJS|Selenium|python-requests|node-fetch|PostmanRuntime|GuzzleHttp)\b
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 687,
          "y": 1619
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "108":
    id: "108"
    taskid: d1afcb8a-aaa5-4605-bcff-459497223fca
    type: regular
    task:
      id: d1afcb8a-aaa5-4605-bcff-459497223fca
      version: -1
      name: Set suspicious user details
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "109"
    scriptarguments:
      key:
        simple: SuspiciousUserDetails
      value:
        simple: The user has been created recently.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 185,
          "y": 1883
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "109":
    id: "109"
    taskid: 42db7d55-ad1b-441d-9e50-9c39a0314d05
    type: condition
    task:
      id: 42db7d55-ad1b-441d-9e50-9c39a0314d05
      description: ""
      version: -1
      name: Check password creation date
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "116"
      recently:
      - "110"
    separatecontext: false
    conditions:
    - label: recently
      condition:
      - - operator: AfterRelativeDate
          left:
            value:
              complex:
                root: Account
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: Account.Type
                      iscontext: true
                    right:
                      value:
                        simple: Okta
                    ignorecase: true
                accessor: PasswordChanged
                transformers:
                - operator: ModifyDateTime
                  args:
                    variation:
                      value:
                        simple: in 3 days
            iscontext: true
          right:
            value:
              simple: ${alert.timestamp}
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 185,
          "y": 2012
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "110":
    id: "110"
    taskid: 117ab261-a8f3-40e0-ae20-66dafbd4c1dc
    type: regular
    task:
      id: 117ab261-a8f3-40e0-ae20-66dafbd4c1dc
      version: -1
      name: Set suspicious user details
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "105"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: SuspiciousUserDetails
      value:
        simple: The user password has been changed recently.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 185,
          "y": 2178
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "111":
    id: "111"
    taskid: cccea50e-8b57-421c-9496-972b72e9318c
    type: condition
    task:
      id: cccea50e-8b57-421c-9496-972b72e9318c
      description: ""
      version: -1
      name: Check failed logins count
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "49"
      "yes":
      - "112"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: FailedLogins
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: FailedLogins.actor.alternateId
                      iscontext: true
                    right:
                      value:
                        simple: Core.OriginalAlert.event.auth_identity
                      iscontext: true
                    ignorecase: true
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "5"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1189,
          "y": 1837
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "112":
    id: "112"
    taskid: e8b495b6-7b59-4dca-944b-63a5fbe9f60b
    type: regular
    task:
      id: e8b495b6-7b59-4dca-944b-63a5fbe9f60b
      version: -1
      name: Set failed logins as evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "49"
    scriptarguments:
      key:
        simple: OktaFaildLogins
      value:
        complex:
          root: FailedLogins
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: FailedLogins.actor.alternateId
                iscontext: true
              right:
                value:
                  simple: Core.OriginalAlert.event.auth_identity
                iscontext: true
          transformers:
          - operator: count
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1189,
          "y": 1992
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "113":
    id: "113"
    taskid: 9c3eab65-56cd-464b-8b31-ed97b99b9fb7
    type: condition
    task:
      id: 9c3eab65-56cd-464b-8b31-ed97b99b9fb7
      description: ""
      version: -1
      name: Check suspicious auth logs
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "116"
      "yes":
      - "114"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: OktaLogs.eventType
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1189,
          "y": 2270
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "114":
    id: "114"
    taskid: 7fb69908-7eb0-48dc-9fad-11b52c8767ba
    type: regular
    task:
      id: 7fb69908-7eb0-48dc-9fad-11b52c8767ba
      version: -1
      name: Set Okta suspicious logs
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "105"
    scriptarguments:
      key:
        simple: OktaSuspiciousLogs
      value:
        simple: Suspicious Okta user authentication logs were found in the last day.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1189,
          "y": 2433
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "116":
    id: "116"
    taskid: 1f29b550-9fec-4360-8875-008c7e2bc329
    type: title
    task:
      id: 1f29b550-9fec-4360-8875-008c7e2bc329
      version: -1
      name: No suspicious eveidence
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "105"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 494,
          "y": 2404
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "117":
    id: "117"
    taskid: 11b77e79-64e2-4013-81e8-8f45dfc0aef0
    type: title
    task:
      id: 11b77e79-64e2-4013-81e8-8f45dfc0aef0
      version: -1
      name: No suspicious eveidence
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "105"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1841,
          "y": 2033
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "118":
    id: "118"
    taskid: 5bb76004-78ee-4548-9ace-644a2de8877f
    type: regular
    task:
      id: 5bb76004-78ee-4548-9ace-644a2de8877f
      version: -1
      name: Save user agent as evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "122"
    scriptarguments:
      key:
        simple: CreatingSuspiciousUA
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery.results
          accessor: user_agent
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: Okta.Logs.Events.client.userAgent.rawUserAgent
                iscontext: true
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1810,
          "y": 2253
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "119":
    id: "119"
    taskid: 684276d0-f25d-4f8b-90b8-655ecb2fdcb9
    type: condition
    task:
      id: 684276d0-f25d-4f8b-90b8-655ecb2fdcb9
      description: ""
      version: -1
      name: Check if password was set recently
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "121"
      "yes":
      - "120"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: AfterRelativeDate
          left:
            value:
              complex:
                root: MSGraphUser
                accessor: LastPasswordChangeDateTime
                transformers:
                - operator: ModifyDateTime
                  args:
                    variation:
                      value:
                        simple: in 3 days
            iscontext: true
          right:
            value:
              simple: ${alert.timestamp}
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -962,
          "y": 2023
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "120":
    id: "120"
    taskid: f1bb3fb3-9a49-4d35-bf73-852e35de2c8d
    type: regular
    task:
      id: f1bb3fb3-9a49-4d35-bf73-852e35de2c8d
      version: -1
      name: Set suspicious user details
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "105"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: SuspiciousUserDetails
      value:
        simple: The user password has been changed recently.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -744,
          "y": 2200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "121":
    id: "121"
    taskid: e1236a0f-4c26-42b9-8e99-facb9f3e0fd1
    type: title
    task:
      id: e1236a0f-4c26-42b9-8e99-facb9f3e0fd1
      version: -1
      name: No suspicious eveidence
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "105"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -935,
          "y": 2368
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "122":
    id: "122"
    taskid: be681e7d-6df1-4e21-a72e-e969a745232b
    type: title
    task:
      id: be681e7d-6df1-4e21-a72e-e969a745232b
      version: -1
      name: Evidence Check
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "105"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2516,
          "y": 2824
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "123":
    id: "123"
    taskid: 7fb74809-dad8-4615-ae49-5c16e683be68
    type: title
    task:
      id: 7fb74809-dad8-4615-ae49-5c16e683be68
      version: -1
      name: IP and Core User Risk Check
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "12"
      - "24"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2033,
          "y": 1179
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "124":
    id: "124"
    taskid: 505be558-657a-4ac2-8acf-bf5df4cb37fd
    type: condition
    task:
      id: 505be558-657a-4ac2-8acf-bf5df4cb37fd
      description: ""
      version: -1
      name: Check Evidence
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "173"
      "yes":
      - "186"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore.Indicator
                filters:
                - - operator: greaterThan
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "2"
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: alert.localip
                      iscontext: true
                    ignorecase: true
            iscontext: true
          right:
            value: {}
        - operator: isNotEmpty
          left:
            value:
              simple: UserRiskyCoreReason
            iscontext: true
        - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: FailedLogins
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: FailedLogins.actor.alternateId
                      iscontext: true
                    right:
                      value:
                        simple: Core.OriginalAlert.event.auth_identity
                      iscontext: true
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "5"
        - operator: isNotEmpty
          left:
            value:
              simple: OktaLogs.eventType
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: SuspiciousUA
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: SuspiciousUserDetails
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: UserRiskyAzureDetections
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: AzureSecurityAlerts
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore.Indicator
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.results.caller_ip
                      iscontext: true
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: CreatingSuspiciousUA
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: CreatingUserRiskyAzureDetections
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: AzureSecurityAlertsCreatingUser
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: CreatingUserRiskyCoreReason
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: AnomaliesFound
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 490,
          "y": 3248
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "148":
    id: "148"
    taskid: 369c780a-abf7-4a6a-a6f1-2f397ea1a9f9
    type: regular
    task:
      id: 369c780a-abf7-4a6a-a6f1-2f397ea1a9f9
      version: -1
      name: Search for app creation event - Okta
      description: Gets logs by providing optional filters.
      script: '|||okta-get-logs'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "73"
    scriptarguments:
      filter:
        simple: target.alternateId eq "${Core.OriginalAlert.event.auth_target}" and eventType eq "application.lifecycle.create" and outcome.result eq "SUCCESS"
      since:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 3 days ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2348,
          "y": 1741
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "149":
    id: "149"
    taskid: 03b2e048-48fb-497e-81db-954d244e08a7
    type: condition
    task:
      id: 03b2e048-48fb-497e-81db-954d244e08a7
      description: ""
      version: -1
      name: Check Auth Server
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      Azure:
      - "72"
      Okta:
      - "148"
    separatecontext: false
    conditions:
    - label: Azure
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.auth_server
            iscontext: true
          right:
            value:
              simple: Azure
          ignorecase: true
    - label: Okta
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.auth_server
            iscontext: true
          right:
            value:
              simple: Okta
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2135,
          "y": 1603
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "150":
    id: "150"
    taskid: 5e3b166d-2849-45e1-89b5-a08b15948a72
    type: condition
    task:
      id: 5e3b166d-2849-45e1-89b5-a08b15948a72
      description: ""
      version: -1
      name: Check Auth Server
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      Azure:
      - "91"
      - "95"
      Okta:
      - "122"
    separatecontext: false
    conditions:
    - label: Azure
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.auth_server
            iscontext: true
          right:
            value:
              simple: Azure
          ignorecase: true
    - label: Okta
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.auth_server
            iscontext: true
          right:
            value:
              simple: Okta
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2299,
          "y": 2221
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "151":
    id: "151"
    taskid: d91ea407-e763-4771-8588-dd54fe10215a
    type: title
    task:
      id: d91ea407-e763-4771-8588-dd54fe10215a
      version: -1
      name: App Is Not New
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -3075,
          "y": 2057
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "156":
    id: "156"
    taskid: 4eeaefbb-1d60-4639-9ec8-7691bec84da3
    type: condition
    task:
      id: 4eeaefbb-1d60-4639-9ec8-7691bec84da3
      description: ""
      version: -1
      name: Evaluate Analyst Response - Okta
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      Disable Account:
      - "161"
      No Action:
      - "172"
    separatecontext: false
    conditions:
    - label: No Action
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: No Action
          ignorecase: true
    - label: Disable Account
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: Disable Account
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 881,
          "y": 3964
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "157":
    id: "157"
    taskid: 7ad9b3fb-180f-4f5e-8fc4-beb2647ba45d
    type: collection
    task:
      id: 7ad9b3fb-180f-4f5e-8fc4-beb2647ba45d
      description: ""
      version: -1
      name: Azure User Action Decision
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "167"
    scriptarguments:
      key:
        simple: Message
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 144,
          "y": 3811
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: "#### User:\n`${Core.OriginalAlert.event.auth_normalized_user.upn}`\n\n---\n\n#### Resource Accessed:\n`${Core.OriginalAlert.event.auth_target}`\n\n---\n\n#### Authentication Server:\n`${Core.OriginalAlert.event.auth_server}`\n\n---\n\n#### **Suspicious Evidence Summary:**\n\n- **Malicious IP Found:**  \n  `${.=val.DBotScore && val.DBotScore.filter(d => d.Type === \"ip\" && d.Score > 2 && d.Indicator == val.alert.localip).length > 0 \n    ? ' ' + val.DBotScore.filter(d => d.Type === \"ip\" && d.Score > 2 && d.Indicator == val.alert.localip)[0].Indicator \n    : ' No malicious IP detected'}`\n\n- **Core User Risk:**  \n  `${.=val.UserRiskyCoreReason ? ' HIGH (Reason: ' + val.UserRiskyCoreReason + ')' : ' None'}`\n\n- **Suspicious User Account Details:**  \n  `${.=val.SuspiciousUserDetails ? ' ' + val.SuspiciousUserDetails : ' None'}`\n\n- **Suspicious User Agent (Initial Access):**  \n  `${.=val.SuspiciousUA ? ' ' + val.SuspiciousUA : ' None'}`\n\n${.=val.AnomaliesFound ? '- **Anomalies Detected:**  `' + val.AnomaliesFound + '`' : ''}\n\n\n#### Azure Specific Evidence:\n\n- **Azure Risky Detections (User):**  \n  `${.=val.UserRiskyAzureDetections && val.UserRiskyAzureDetections.length > 0 \n    ? ' ' + Array.from(new Set(val.UserRiskyAzureDetections)).join(\", \") \n    : ' None'}`\n\n- **Azure Security Alerts (User):**  \n  `${.=val.AzureSecurityAlerts && val.AzureSecurityAlerts.length > 0 \n    ? ' ' + Array.from(new Set(val.AzureSecurityAlerts)).join(\", \") \n    : ' None'}`\n\n---\n\n#### **App Creation Details (If applicable):**\n\n**App Created Recently:**  \n`${.=(val.PaloAltoNetworksXQL.GenericQuery.results[0].identity_invoked_by_name) ? \" Yes\" : \" No\"}`\n\n${.=(val.PaloAltoNetworksXQL.GenericQuery.results[0].identity_invoked_by_name) \n  ? '- **App Creator (User/Identity):** `' + val.PaloAltoNetworksXQL.GenericQuery.results[0].identity_invoked_by_name + '`' \n  : ''}\n\n${.=val.PaloAltoNetworksXQL.GenericQuery.results[0].caller_ip \n  ? '- **App Creator IP:** `' + val.PaloAltoNetworksXQL.GenericQuery.results[0].caller_ip + '`' \n  : ''}\n\n${.=val.Core.OriginalAlert.event.auth_server === 'Azure' && val.PaloAltoNetworksXQL.GenericQuery.results[0].caller_ip && val.DBotScore ? (\n  (Array.isArray(val.DBotScore) ? \n      (maxScore = Math.max(...val.DBotScore.filter(d => d.Type === \"ip\" && d.Indicator === val.PaloAltoNetworksXQL.GenericQuery.results[0].caller_ip).map(d => d.Score))) :\n      (val.DBotScore.Type === \"ip\" && val.DBotScore.Indicator === val.PaloAltoNetworksXQL.GenericQuery.results[0].caller_ip \n        ? maxScore = val.DBotScore.Score \n        : maxScore = -1),\n  label = maxScore === 3 ? \" Malicious\" : maxScore === 2 ? \" Suspicious\" : maxScore === 1 ? \" Benign\" : maxScore === 0 ? \" Unknown\" : \" No reputation found\",\n  maxScore >= 0 ? '- **App Creator IP Reputation:** `' + label + '`' : '')\n) : ''}\n\n${.=val.CreatingSuspiciousUA \n  ? '- **Creating User Suspicious User Agent:**  `' + val.CreatingSuspiciousUA + '`' \n  : '- **Creating User Suspicious User Agent:**  None'}\n\n${.=val.CreatingUserRiskyCoreReason \n  ? '- **Creating User Risk (Core):**  `HIGH` (Reason: `' + val.CreatingUserRiskyCoreReason + '`)' \n  : '- **Creating User Risk (Core):**  None'}\n\n${.=val.CreatingUserRiskyAzureDetections && val.CreatingUserRiskyAzureDetections.length > 0 \n  ? '- **Creating User Risky Azure Detections:**  `' + Array.from(new Set(val.CreatingUserRiskyAzureDetections)).join(\", \") + '`' \n  : '- **Creating User Risky Azure Detections:**  None'}\n\n${.=val.AzureSecurityAlertsCreatingUser && val.AzureSecurityAlertsCreatingUser.length > 0 \n  ? '- **Azure Security Alerts (Creating User):**  `' + Array.from(new Set(val.AzureSecurityAlertsCreatingUser)).join(\", \") + '`' \n  : '- **Azure Security Alerts (Creating User):**  None'}\n\n---\n\n#### **Analyst Action Required:**\n\nBased on the suspicious evidence above, please review the findings and choose one of the following response actions:\n\n- **Disable Account**  \n  _Temporarily disable the user's account to prevent all sign-ins._\n\n- **Block App Access**  \n  _Block the user from accessing the targeted application via Conditional Access._\n\n- **Apply Both Actions**  \n  _Disable the account and block app access for full containment._\n\n- **No Action**  \n  _Take no action at this time; proceed without containment._\n\n> **Note:** If any of these actions are performed automatically, they can later be manually reverted from the **Azure portal** by an administrator.\n"
        required: false
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - simple: No Action
        - simple: Disable Account
        - simple: Block App Access
        - simple: Apply Both Actions
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Analyst Action
      description: Analyst review
      sender: Your SOC team
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "158":
    id: "158"
    taskid: ac6abd29-62d9-4785-8c89-1368c3475be3
    type: regular
    task:
      id: ac6abd29-62d9-4785-8c89-1368c3475be3
      version: -1
      name: Clear user sessions
      description: This script clears user sessions across multiple integrations for a list of usernames.
      scriptName: clear-user-session
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "162"
    scriptarguments:
      user_name:
        simple: ${Core.OriginalAlert.event.auth_normalized_user.upn}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 489,
          "y": 3544
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "161":
    id: "161"
    taskid: d1414659-a822-4814-ba21-f02fa7e546ab
    type: regular
    task:
      id: d1414659-a822-4814-ba21-f02fa7e546ab
      version: -1
      name: Suspend user in Okta
      description: Suspends a single user. This operation can only be performed on users with an ACTIVE status. After the porcess is completed, the user's status is SUSPENDED.
      script: '|||okta-suspend-user'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "171"
    scriptarguments:
      username:
        simple: ${Core.OriginalAlert.event.auth_normalized_user.upn}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 881,
          "y": 4253
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "162":
    id: "162"
    taskid: bae8805e-bb00-49d2-8357-bf4c53648927
    type: condition
    task:
      id: bae8805e-bb00-49d2-8357-bf4c53648927
      description: ""
      version: -1
      name: Check Auth Server
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      Azure:
      - "157"
      Okta:
      - "165"
    separatecontext: false
    conditions:
    - label: Azure
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.auth_server
            iscontext: true
          right:
            value:
              simple: Azure
          ignorecase: true
    - label: Okta
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.auth_server
            iscontext: true
          right:
            value:
              simple: Okta
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 489,
          "y": 3672
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "165":
    id: "165"
    taskid: df4704c5-a735-45e2-9adb-0b5dc4f79357
    type: collection
    task:
      id: df4704c5-a735-45e2-9adb-0b5dc4f79357
      description: ""
      version: -1
      name: Okta User Action Decision
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "156"
    scriptarguments:
      key:
        simple: Message
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 881,
          "y": 3811
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: "#### User:\n`${Core.OriginalAlert.event.auth_normalized_user.upn}`\n\n---\n\n#### Resource Accessed:\n`${Core.OriginalAlert.event.auth_target}`\n\n---\n\n#### Authentication Server:\n`${Core.OriginalAlert.event.auth_server}`\n\n---\n\n#### **Suspicious Evidence Summary:**\n\n- **Malicious IP Found:**  \n  `${.=val.DBotScore && val.DBotScore.filter(d => d.Type === \"ip\" && d.Score > 2 && d.Indicator == val.alert.localip).length > 0 ? ' ' + val.DBotScore.filter(d => d.Type === \"ip\" && d.Score > 2 && d.Indicator == val.alert.localip)[0].Indicator : ' No malicious IP detected'}`\n\n- **Core User Risk:**  \n  `${.=val.UserRiskyCoreReason ? ' HIGH (Reason: ' + val.UserRiskyCoreReason + ')' : ' No core risk detected'}`\n\n- **Suspicious User Account Details:**  \n  `${.=val.SuspiciousUserDetails ? ' ' + val.SuspiciousUserDetails : ' None'}`\n\n- **Suspicious User Agent (Initial Access):**  \n  `${.=val.SuspiciousUA ? ' ' + val.SuspiciousUA : ' None'}`\n\n${.=val.AnomaliesFound ? '- **Anomalies Detected:**  `' + val.AnomaliesFound + '`' : ''}\n\n---\n\n#### **Okta Specific Evidence:**\n\n- **Okta Failed Login Attempts (Last Day):**  \n  `${.=val.OktaFaildLogins ? ' ' + val.OktaFaildLogins + \" attempt(s)\" : ' None'}`\n\n- **Suspicious Okta Authentication Logs (Last Day):**  \n  `${.=val.OktaSuspiciousLogs ? ' Found' : ' None'}`\n\n---\n\n#### **App Creation Details (If applicable):**\n\n- **App Created Recently:** `${.=(val.Okta.Logs.Events.actor.alternateId) ? ' Yes' : ' No'}`\n\n${.=val.Okta.Logs.Events.request.ipChain[0].ip ? '- **App Creator IP:** `' + val.Okta.Logs.Events.request.ipChain[0].ip + '`' : ''}\n\n${.=val.Okta.Logs.Events.request.ipChain[0].ip && val.DBotScore ? (\n    (Array.isArray(val.DBotScore) ? \n        (maxScore = Math.max(...val.DBotScore.filter(d => d.Type === \"ip\" && d.Indicator == val.Okta.Logs.Events.request.ipChain[0].ip).map(d => d.Score))) :\n        (val.DBotScore.Type === \"ip\" && val.DBotScore.Indicator == val.Okta.Logs.Events.request.ipChain[0].ip ? maxScore = val.DBotScore.Score : maxScore = -1),\n\n    label = maxScore === 3 ? ' Malicious' : maxScore === 2 ? ' Suspicious' : maxScore === 1 ? ' Benign' : maxScore === 0 ? ' Unknown' : 'N/A',\n\n    maxScore >= 0 ? '- **App Creator IP Reputation:** `' + label + '`' : '')\n) : ''}\n\n${.=val.CreatingSuspiciousUA ? '- **Creating User Suspicious User Agent:**  `' + val.CreatingSuspiciousUA + '`' : '- **Creating User Suspicious User Agent:**  None'}\n\n${.=(val.Okta.Logs.Events.actor.alternateId) ? '- **App Creator (User/Identity):** `' + val.Okta.Logs.Events.actor.alternateId + '`' : ''}\n\n---\n\n#### **Analyst Action Required:**\n\nBased on the suspicious evidence above, please review the findings and choose one of the following response actions:\n\n- **Disable Account**  \n  _Temporarily disable the user's account to prevent all sign-ins._\n\n- **No Action**  \n  _Take no action at this time; proceed without containment._\n\n> **Note:** If the account is disabled automatically, it can later be manually re-enabled from the **Okta admin console** or by running the `okta-unsuspend-user` command.\n"
        required: false
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - simple: No Action
        - simple: Disable Account
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Analyst Action
      description: Analyst review
      sender: Your SOC team
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "167":
    id: "167"
    taskid: e1f20ebb-bc5c-453f-8566-ebc78bc5996a
    type: condition
    task:
      id: e1f20ebb-bc5c-453f-8566-ebc78bc5996a
      description: ""
      version: -1
      name: Evaluate Analyst Response - Azure
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      Apply Both Actions:
      - "174"
      Block App Access:
      - "176"
      Disable Account:
      - "169"
      No Action:
      - "172"
    separatecontext: false
    conditions:
    - label: No Action
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: No Action
          ignorecase: true
    - label: Disable Account
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: Disable Account
          ignorecase: true
    - label: Block App Access
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: Block App Access
    - label: Apply Both Actions
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: Apply Both Actions
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 144,
          "y": 3964
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "169":
    id: "169"
    taskid: 359cda8b-4571-4137-b90c-8e1e48fce40f
    type: regular
    task:
      id: 359cda8b-4571-4137-b90c-8e1e48fce40f
      version: -1
      name: Disable user in Azure AD
      description: |-
        Disables a user from all Office 365 applications, and prevents sign in. Note: This command disables user,
        but does not terminate an existing session. Supported only in a self deployed app flow with the
        Permission: Directory.AccessAsUser.All(Delegated).
      script: '|||msgraph-user-account-disable'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "171"
    scriptarguments:
      user:
        simple: ${Analyst Action.Answers.0}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -59,
          "y": 4662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "171":
    id: "171"
    taskid: 5c8e3ff4-8fd0-4589-accf-747ae58ae8f3
    type: regular
    task:
      id: 5c8e3ff4-8fd0-4589-accf-747ae58ae8f3
      version: -1
      name: Close Investigation (TP)
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    scriptarguments:
      closeReason:
        simple: Resolved - True Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 881,
          "y": 4800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "172":
    id: "172"
    taskid: 5f42ecfe-e20d-4367-88df-0144ec321e02
    type: regular
    task:
      id: 5f42ecfe-e20d-4367-88df-0144ec321e02
      version: -1
      name: Close Investigation
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    scriptarguments:
      closeReason:
        simple: Resolved - False Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 572,
          "y": 4113
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "173":
    id: "173"
    taskid: a83a9a1c-f4c8-4caf-8434-ce223d3a2904
    type: regular
    task:
      id: a83a9a1c-f4c8-4caf-8434-ce223d3a2904
      version: -1
      name: Close Investigation (FP)
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    scriptarguments:
      closeReason:
        simple: Resolved - False Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -3,
          "y": 3411
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "174":
    id: "174"
    taskid: 015d53ed-8928-4851-914d-04f3f1b14357
    type: title
    task:
      id: 015d53ed-8928-4851-914d-04f3f1b14357
      version: -1
      name: Block App & Disable User
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "169"
      - "176"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 144,
          "y": 4166
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "175":
    id: "175"
    taskid: 8530d554-1a56-4335-aaed-37f4856120b3
    type: regular
    task:
      id: 8530d554-1a56-4335-aaed-37f4856120b3
      version: -1
      name: Block app access for user
      description: Checks if a CA policy exists. If yes, adds the user if needed. If no, creates a new CA policy to block access to a specific app for a user.
      scriptName: BlockUserAppAccessWithCAPolicy
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "171"
    scriptarguments:
      app_name:
        simple: ${Core.OriginalAlert.event.auth_target}
      username:
        simple: ${Core.OriginalAlert.event.auth_identity}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 348,
          "y": 4662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "176":
    id: "176"
    taskid: aa6f93fe-16f8-4400-bdad-d31a7da157c5
    type: condition
    task:
      id: aa6f93fe-16f8-4400-bdad-d31a7da157c5
      version: -1
      name: Verify integrations availability (Azure)
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "171"
      "yes":
      - "187"
    scriptarguments:
      brandname:
        simple: MicrosoftGraphIdentityandAccess
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 348,
          "y": 4368
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "177":
    id: "177"
    taskid: c13a983a-eac5-4ace-8472-ccad48a268ff
    type: condition
    task:
      id: c13a983a-eac5-4ace-8472-ccad48a268ff
      description: ""
      version: -1
      name: Check Auth Server
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      Azure:
      - "76"
      Okta:
      - "178"
    separatecontext: false
    conditions:
    - label: Azure
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.auth_server
            iscontext: true
          right:
            value:
              simple: Azure
          ignorecase: true
    - label: Okta
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.auth_server
            iscontext: true
          right:
            value:
              simple: Okta
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1395,
          "y": 2355
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "178":
    id: "178"
    taskid: 4955e44d-9a0e-4c06-8f48-3e53a5edbd7b
    type: title
    task:
      id: 4955e44d-9a0e-4c06-8f48-3e53a5edbd7b
      version: -1
      name: Add IP to BlockedIpZone - Okta
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "180"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1168,
          "y": 2518
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "179":
    id: "179"
    taskid: 14e2e01b-f48a-487b-a2f8-87d8880e27d7
    type: regular
    task:
      id: 14e2e01b-f48a-487b-a2f8-87d8880e27d7
      version: -1
      name: Add IP to BlockedIpZone
      description: Checks if an IP is already covered by CIDR/range in Okta BlockedIpZone. If not, it adds it.
      scriptName: OktaAddIPToBlockedIpZone
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "105"
    scriptarguments:
      ip:
        simple: ${Okta.Logs.Events.request.ipChain.[0].ip}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1168,
          "y": 2791
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "180":
    id: "180"
    taskid: 4fc034ea-891e-47ab-8f2f-d5da4bd7d5f6
    type: condition
    task:
      id: 4fc034ea-891e-47ab-8f2f-d5da4bd7d5f6
      version: -1
      name: Verify integration availability (Okta)
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "188"
      "yes":
      - "179"
    scriptarguments:
      brandname:
        simple: Okta v2
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1168,
          "y": 2640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "182":
    id: "182"
    taskid: 3acbfa11-c668-47be-b10d-561692ae7f59
    type: condition
    task:
      id: 3acbfa11-c668-47be-b10d-561692ae7f59
      description: ""
      version: -1
      name: Verify anomalies & device status
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "121"
      "yes":
      - "184"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              simple: Core.OriginalAlert.event.factory_anomaly_score
            iscontext: true
          right:
            value:
              simple: "2"
      - - operator: isNotEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.azure_authentication_info.is_device_managed
            iscontext: true
          right:
            value:
              simple: "true"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1515,
          "y": 1619
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "183":
    id: "183"
    taskid: 0cdfdcf2-43ac-4c73-8093-80033c7254b1
    type: title
    task:
      id: 0cdfdcf2-43ac-4c73-8093-80033c7254b1
      version: -1
      name: Anomalies - Unmanaged Devices
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "182"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1515,
          "y": 1459
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "184":
    id: "184"
    taskid: 321cbcbf-ba2f-4fa9-856d-72bf4d2751a3
    type: regular
    task:
      id: 321cbcbf-ba2f-4fa9-856d-72bf4d2751a3
      version: -1
      name: Set as evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "105"
    scriptarguments:
      key:
        simple: AnomaliesFound
      value:
        simple: Device is unmanaged and at least 2 anomalies were found.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1515,
          "y": 1872
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "185":
    id: "185"
    taskid: d292f9c3-f5c9-4676-b177-bc7b2ad07c1f
    type: title
    task:
      id: d292f9c3-f5c9-4676-b177-bc7b2ad07c1f
      version: -1
      name: Integration is not available
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "105"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2283,
          "y": 2596
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "186":
    id: "186"
    taskid: eb658b16-344f-4252-8afe-9403ebc95bb7
    type: title
    task:
      id: eb658b16-344f-4252-8afe-9403ebc95bb7
      version: -1
      name: Containment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "158"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 489,
          "y": 3416
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "187":
    id: "187"
    taskid: 7d4ec3c6-6df5-40c5-8a34-ca536608c16a
    type: condition
    task:
      id: 7d4ec3c6-6df5-40c5-8a34-ca536608c16a
      version: -1
      name: Verify integrations availability (Azure)
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "171"
      "yes":
      - "175"
    scriptarguments:
      brandname:
        simple: MicrosoftGraphApplications
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 348,
          "y": 4527
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "188":
    id: "188"
    taskid: 9f1ba193-4d28-4a43-8eae-29660cdd2f4b
    type: title
    task:
      id: 9f1ba193-4d28-4a43-8eae-29660cdd2f4b
      version: -1
      name: Integration is not available
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "105"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1374,
          "y": 2935
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "100_122_#default#": 0.17,
      "102_185_no": 0.43,
      "102_87_yes": 0.59,
      "103_185_no": 0.41,
      "103_88_yes": 0.59,
      "104_188_no": 0.39,
      "104_86_yes": 0.39,
      "107_116_#default#": 0.24,
      "109_116_#default#": 0.34,
      "111_112_yes": 0.44,
      "113_116_#default#": 0.25,
      "119_121_#default#": 0.39,
      "14_117_#default#": 0.37,
      "14_22_HIGH": 0.66,
      "150_122_Okta": 0.19,
      "150_91_Azure": 0.46,
      "150_95_Azure": 0.51,
      "156_161_Disable Account": 0.54,
      "156_172_No Action": 0.48,
      "162_157_Azure": 0.6,
      "162_165_Okta": 0.55,
      "167_169_Disable Account": 0.71,
      "167_172_No Action": 0.57,
      "167_176_Block App Access": 0.9,
      "176_171_no": 0.43,
      "176_187_yes": 0.55,
      "180_179_yes": 0.58,
      "180_188_no": 0.26,
      "182_184_yes": 0.5,
      "187_171_no": 0.57,
      "28_10_yes": 0.41,
      "28_117_#default#": 0.25,
      "2_5_#default#": 0.59,
      "2_8_Yes": 0.59,
      "31_34_yes": 0.37,
      "35_36_Azure": 0.8,
      "35_38_Okta": 0.46,
      "45_108_recently": 0.57,
      "52_117_#default#": 0.28,
      "53_54_Azure": 0.57,
      "6_9_#default#": 0.51,
      "73_74_yes": 0.54,
      "75_121_#default#": 0.52,
      "85_118_Yes": 0.53,
      "85_121_#default#": 0.2,
      "98_99_HIGH": 0.41
    },
    "paper": {
      "dimensions": {
        "height": 4822,
        "width": 5976,
        "x": -3075,
        "y": 48
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 8.9.0
