id: silent-Recurring rare domain access from an unsigned process
version: -1
name: silent-Recurring rare domain access from an unsigned process
description: "This playbook addresses the following alerts:\n\n- Recurring rare domain access from an uncommon unsigned process\n- Recurring access to a rare domain associated with known threats\n\nPlaybook Stages:\n  \nAnalysis:\n\n- Check actor process hash reputation\n- Check suspicious domain reputation\n- Check actor process hash category using WildFire\n\n  If suspicious/malicious reputation found:\n    - Execute Remediation\n\nInvestigation:\n\n- Check Actor for Risky Path\n- Get Actor CommandLine Analysis\n- Get CGO Process Prevalence\n- Get Related Alerts\n\n  If found related alerts and one other risk:\n    - Execute Remediation\n\nContainment:\n\n- Kill CGO Process\n- Add Domain IOC rule."
issilent: true
tags:
- T1071 - Application Layer Protocol
- TA0011 - Command and Control
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: ba6c9222-4bb5-43d2-8a32-43e6914ad3e4
    type: start
    task:
      id: ba6c9222-4bb5-43d2-8a32-43e6914ad3e4
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 60,
          "y": -553
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 04ab0792-3df1-4a51-8d78-6c6dde3cc73b
    type: title
    task:
      id: 04ab0792-3df1-4a51-8d78-6c6dde3cc73b
      version: -1
      name: Analysis
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
      - "3"
      - "34"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 60,
          "y": -117
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 874db49a-6448-427e-87f0-d1cdfccf096a
    type: regular
    task:
      id: 874db49a-6448-427e-87f0-d1cdfccf096a
      version: -1
      name: Get Initiator Process Hash Reputation
      description: Retrieve results for a file hash using WildFire.
      script: '|||file'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      file:
        simple: ${alert.initiatorsha256}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 60,
          "y": 9
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 2fb0a537-53d8-410e-8aee-c931a2948511
    type: regular
    task:
      id: 2fb0a537-53d8-410e-8aee-c931a2948511
      version: -1
      name: Get Domain Reputation
      description: Checks the reputation of a domain.
      script: '|||domain'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      domain:
        simple: ${Core.OriginalAlert.raw_abioc.event.domain}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 497.5,
          "y": 9
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: 32bafb15-cb9a-4f2a-8fbc-4c2a37d3a9f4
    type: condition
    task:
      id: 32bafb15-cb9a-4f2a-8fbc-4c2a37d3a9f4
      version: -1
      name: Check for Bad Reputation
      description: Check if the process hash or domain has a suspicious/malicious reputation.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "20"
      "yes":
      - "21"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: DBotScore
                accessor: Score
                transformers:
                - operator: uniq
            iscontext: true
          right:
            value:
              simple: "2"
        - operator: isNotEqualString
          left:
            value:
              simple: WildFire.Verdicts.VerdictDescription
            iscontext: true
          right:
            value:
              simple: Benign
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 60,
          "y": 133
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: a5e423ee-a93e-4b7a-8598-2509169ec044
    type: condition
    task:
      id: a5e423ee-a93e-4b7a-8598-2509169ec044
      version: -1
      name: Check Investigation Verdict
      description: "This task checks for potentially malicious verdict by evaluating multiple heuristics. A verdict of 'Malicious' is reached when at least two of the following conditions are met:\n\n1. Risky Path: The file or process is located in a risky or suspicious directory.\n2. Risky Command Line: The command line arguments used to execute the process contain suspicious patterns or known malicious commands.\n3. Low Prevalence: The file or process is rarely seen across the monitored environment, indicating it might be a new or targeted threat.\n4. Related Incidents Found: The file or process has been associated with previous security incidents or known malicious activities.\n\nIf a malicious verdict is reached, the playbook continues to take remediation actions."
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "8"
      Malicious:
      - "7"
    separatecontext: false
    conditions:
    - label: Malicious
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: .
                transformers:
                - operator: If-Elif
                  args:
                    conditions:
                      value:
                        simple: |-
                          [
                            {
                              "condition": "#{CommandLineAnalysis.risk} != 'Low Risk' and  #{Core.AnalyticsPrevalence.Process.[0].value} == false",
                              "return": "True"
                            },
                            {
                              "condition": "#{isRiskyPath} and  #{Core.AnalyticsPrevalence.Process.[0].value} == false",
                              "return": "True"
                            },
                            {
                              "condition": "(#{CommandLineAnalysis.risk} != 'Low Risk' or #{Core.AnalyticsPrevalence.Process.[0].value} == false or #{isRiskyPath}) and #{foundIncidents.[0]}",
                              "return": "True"
                            },
                            {
                              "default": "False"
                            }
                          ]
                    flags:
                      value:
                        simple: case_insensitive
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 60,
          "y": 829
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 4ce9ff41-69d8-4af0-84ef-2e0f01f21db7
    type: regular
    task:
      id: 4ce9ff41-69d8-4af0-84ef-2e0f01f21db7
      version: -1
      name: CommandLine Analysis
      description: |-
        This script evaluates command-line threats by analyzing both original and decoded inputs. It assigns weighted scores to detected patterns, such as AMSI bypass or credential dumping, and applies risk combination bonuses for multiple detections. The total score is normalized to a 0-100 scale, with risk levels categorized as follows:

        * 0-25: Low Risk
        * 26-50: Medium Risk
        * 51-90: High Risk
        * 91-100: Critical Risk

        The scoring mechanism provides a comprehensive risk assessment, considering both the severity and frequency of malicious behaviors.
      scriptName: CommandLineAnalysis
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "28"
    scriptarguments:
      command_line:
        simple: ${alert.initiatorcmd}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 58.5,
          "y": 522
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: 1ce7e0dd-b851-4ea0-8dcb-168a38a88736
    type: title
    task:
      id: 1ce7e0dd-b851-4ea0-8dcb-168a38a88736
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "9"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 62,
          "y": 999
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 3bf218c9-c023-49b6-87a4-b85e30d875e3
    type: title
    task:
      id: 3bf218c9-c023-49b6-87a4-b85e30d875e3
      version: -1
      name: Inconclusive
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 545.5,
          "y": 999
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: bcab1628-61ae-4608-908c-c857092b3c34
    type: regular
    task:
      id: bcab1628-61ae-4608-908c-c857092b3c34
      version: -1
      name: Terminate Causality - Action Process
      description: Terminate a process tree by its causality ID. Available only for Cortex XSIAM 2.4.
      script: '|||core-terminate-causality'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      agent_id:
        simple: ${alert.agentid}
      causality_id:
        simple: ${alert.actorprocessinstanceid}
      incident_id:
        complex:
          root: alert
          accessor: parentXDRIncident
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '-'
              fields:
                value:
                  simple: "2"
      timeout_in_seconds:
        simple: "180"
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 60.5,
          "y": 1161
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 44f2ded0-6451-41c7-8f1e-98865756be36
    type: regular
    task:
      id: 44f2ded0-6451-41c7-8f1e-98865756be36
      version: -1
      name: Close Alert - True Positive
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      closeNotes:
        simple: Resolved - Handled by the playbook "Recurring rare domain access from an unsigned process"
      closeReason:
        simple: Resolved - True Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 60.5,
          "y": 1865
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 5bd4ae25-a7a7-46d7-8cb0-c9e95057b8a4
    type: title
    task:
      id: 5bd4ae25-a7a7-46d7-8cb0-c9e95057b8a4
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 60.5,
          "y": 2029
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: de1d66b4-0a3b-422d-9899-a65c8d50ebaa
    type: regular
    task:
      id: de1d66b4-0a3b-422d-9899-a65c8d50ebaa
      version: -1
      name: Get Domain from Alert Extra Data
      description: Retrieves the suspicious domain name from the alert's extra data.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "1"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 60,
          "y": -350
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: 256d6734-3de0-46d6-8ccb-a2313192dd1c
    type: title
    task:
      id: 256d6734-3de0-46d6-8ccb-a2313192dd1c
      version: -1
      name: Invesitgation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "6"
      - "22"
      - "27"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 58.5,
          "y": 364
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: 5c46b35d-869f-422d-8e38-3f9b1ce5ef41
    type: title
    task:
      id: 5c46b35d-869f-422d-8e38-3f9b1ce5ef41
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "7"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -868,
          "y": 266
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: ce393763-57f0-40a2-861e-368140b44606
    type: regular
    task:
      id: ce393763-57f0-40a2-861e-368140b44606
      version: -1
      name: Check CGO Process Prevalence
      description: Get the prevalence of a process, identified by process_name.
      script: '|||core-get-process-analytics-prevalence'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "28"
    scriptarguments:
      process_name:
        simple: ${alert.cgoname}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 497.5,
          "y": 522
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: e5a66ee3-2e51-4a9c-8fab-5a101a0319ac
    type: regular
    task:
      id: e5a66ee3-2e51-4a9c-8fab-5a101a0319ac
      version: -1
      name: Check Risky Path
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "28"
    scriptarguments:
      append:
        simple: "false"
      force:
        simple: "true"
      key:
        simple: isRiskyPath
      value:
        complex:
          root: alert.initiatorpath
          filters:
          - - operator: match
              left:
                value:
                  simple: alert.initiatorpath
                iscontext: true
              right:
                value:
                  simple: c\:\\users\\.+\\AppData
              ignorecase: true
            - operator: containsString
              left:
                value:
                  simple: alert.initiatorpath
                iscontext: true
              right:
                value:
                  simple: temp
              ignorecase: true
            - operator: containsString
              left:
                value:
                  simple: alert.initiatorpath
                iscontext: true
              right:
                value:
                  simple: ProgramData
              ignorecase: true
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -384,
          "y": 522
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: 5e52b19d-b098-489c-9219-304fe23a4d02
    type: regular
    task:
      id: 5e52b19d-b098-489c-9219-304fe23a4d02
      version: -1
      name: Get Related Alerts
      description: |-
        Searches Cortex XSIAM alerts. A summarized version of this script is available with the summarizedversion argument.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:

        For Cortex XSOAR 6.13, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.13/Cortex-XSOAR-Administrator-Guide/Automations

        For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Scripts

        For Cortex XSOAR on-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Scripts

        For Cortex XSIAM, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSIAM/Cortex-XSIAM-Documentation/Automations
      scriptName: SearchIncidentsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      fromdate:
        simple: 5 hours ago
      includeinformational:
        simple: "true"
      query:
        simple: cid:${alert.cid.[0]} AND (name:"Unsigned process makes connections over DNS ports" or name:"Scripting engine injects into another process" or name:"Uncommon WPAD quires to a rare domain" or name:"Wildfire Malware" or name:"Impair Defenses - 1497766117")
      todate:
        simple: now
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 59.5,
          "y": 654
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: ad9511ad-52f8-42f6-8a45-056427e51579
    type: regular
    task:
      id: ad9511ad-52f8-42f6-8a45-056427e51579
      version: -1
      name: Add Suspicious Domain Monitoring
      description: Send HTTP POST request.
      script: '|||core-api-post'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      body:
        simple: |-
          {
            "request_data": "indicator,type,severity,expiration_date\n${Core.OriginalAlert.raw_abioc.event.domain},DOMAIN_NAME,MEDIUM,${iocExpiration}","validate":"true"
          }
      uri:
        simple: /public_api/v1/indicators/insert_csv
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 60.5,
          "y": 1697
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: 4dffaea1-1ac1-457f-814f-1d0da7ef930b
    type: regular
    task:
      id: 4dffaea1-1ac1-457f-814f-1d0da7ef930b
      version: -1
      name: Calculate Now + 2 weeks in epoch
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions."
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      append:
        simple: "false"
      key:
        simple: iocExpiration
      value:
        complex:
          root: TimeNow
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: in 2 weeks
          - operator: toUnix
          - operator: multiply
            args:
              by:
                value:
                  simple: "1000"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 61,
          "y": 1514
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 9401b6e4-6d4e-4333-84a7-f63a2433f5e1
    type: regular
    task:
      id: 9401b6e4-6d4e-4333-84a7-f63a2433f5e1
      version: -1
      name: Get Current Time
      description: |
        Retrieves the current date and time.
      scriptName: GetTime
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "32"
    scriptarguments:
      dateFormat:
        simple: ISO
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 61,
          "y": 1325
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: b982a4a5-b113-4a9d-8267-38cf61e558ff
    type: regular
    task:
      id: b982a4a5-b113-4a9d-8267-38cf61e558ff
      version: -1
      name: Get Actor Hash WF Category
      description: Returns a verdict for a hash.
      script: '|||wildfire-get-verdict'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      hash:
        simple: ${alert.initiatorsha256}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -384,
          "y": 9
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "5_7_Malicious": 0.39
    },
    "paper": {
      "dimensions": {
        "height": 2642,
        "width": 1794.5,
        "x": -868,
        "y": -553
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 8.9.0
