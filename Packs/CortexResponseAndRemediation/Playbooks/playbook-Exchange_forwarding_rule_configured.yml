id: Exchange forwarding rule configured
version: -1
name: Exchange forwarding rule configured
description: "This playbook addresses the following alerts:\n\n- External Exchange inbox forwarding rule configured.\n- Suspicious Exchange inbox forwarding rule configured.\n- Suspicious Exchange email-hiding inbox rule.\n- Possible BEC Exchange email-hiding inbox rule.\n- Exchange email-hiding transport rule based on message keywords.\n- Suspicious Exchange email-hiding transport rule.\n- Exchange transport forwarding rule configured.\n- Suspicious Exchange transport forwarding rule configured.\n\nPlaybook Stages:\n \nTriage: \n\n- The playbook retrieves the caller's IP, the forwarding email address, and the domain.\n\nEarly Containment:\n\n- The playbook checks if the IP or domain of the forwarding email address is malicious. If so, it suggests blocking the IP using PAN-OS while continuing the investigation in parallel.\n\nInvestigation:\n\n- The playbook checks for suspicious behaviors, including whether an Exchange admin created the rule outside of working hours, from unusual geolocation, or if the user who created the rule has a high-risk score. It then aggregates all evidence collected during the investigation.\n\nContainment:\n\n- Soft Response Actions: If at least two suspicious pieces of evidence are identified, the playbook will execute soft response actions. These actions include signing the user out and disabling the forwarding rule configured in the user's account mailbox.\n- Hard Response Actions: If more than two suspicious pieces of evidence are identified, the playbook escalates to hard response actions. These actions include disabling the user account upon analyst decision and removing the forwarding rule from the user's account mailbox.\n\nRequirements: \n\nFor any response action, you need the following integrations:\n- EWS Extension Online Powershell v3 integration.\n- Azure Active Directory Users."
tags:
- TA0009 - Collection
- TA0010 - Exfiltration
- T1114 - Email Collection
- T1020 - Automated Exfiltration
- TA0005 - Defense Evasion
- T1564.008 - Hide Artifacts
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: d8b9f650-e109-4dd6-886d-da90aef71bff
    type: start
    task:
      id: d8b9f650-e109-4dd6-886d-da90aef71bff
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 643,
          "y": -249
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 3fa5a92e-3b86-4a05-8b86-53cd466bb1cb
    type: regular
    task:
      id: 3fa5a92e-3b86-4a05-8b86-53cd466bb1cb
      version: -1
      name: Get caller IP and forwarding mail address
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "28"
      - "6"
      - "49"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 643,
          "y": -137
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: db47bc64-bb2b-4ff5-97a5-7fa88deef97a
    type: regular
    task:
      id: db47bc64-bb2b-4ff5-97a5-7fa88deef97a
      version: -1
      name: 'Check caller IP reputation '
      description: This script gathers IP reputation data from multiple integrations and returns an IP entity with consolidated information to the context.
      type: regular
      iscommand: false
      brand: ""
      scriptName: ip-enrichment
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      external_enrichment:
        simple: "true"
      ip_list:
        complex:
          root: Core.OriginalAlert.event
          accessor: caller_ip
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 392,
          "y": 130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 89868693-523d-4a49-ab2d-d30fc3377ae9
    type: regular
    task:
      id: 89868693-523d-4a49-ab2d-d30fc3377ae9
      version: -1
      name: Check forwarding email Domain reputation
      description: This script gathers domain reputation data from multiple integrations and returns a "DomainEnrichment" object with consolidated information to the context output.
      type: regular
      iscommand: false
      brand: ""
      scriptName: domain-enrichment
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      domain_list:
        complex:
          root: Core.OriginalAlert.raw_abioc.event
          accessor: forwarding_domain_with_tld
          transformers:
          - operator: uniq
      external_enrichment:
        simple: "true"
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 916,
          "y": 130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: df8b6ae1-ba4b-4319-8b09-a6b6084147a1
    type: condition
    task:
      id: df8b6ae1-ba4b-4319-8b09-a6b6084147a1
      version: -1
      name: Evaluate IP address & domain reputation
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "6"
      "yes":
      - "5"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: IPEnrichment
                filters:
                - - operator: greaterThanOrEqual
                    left:
                      value:
                        simple: IPEnrichment.TIMScore
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                    ignorecase: true
                accessor: Value
            iscontext: true
          right:
            value: {}
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: DomainEnrichment
                filters:
                - - operator: greaterThanOrEqual
                    left:
                      value:
                        simple: DomainEnrichment.TIMScore
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                accessor: Value
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 392,
          "y": 258
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 4592715d-e397-4035-8f6a-aa8adebe4d8b
    type: title
    task:
      id: 4592715d-e397-4035-8f6a-aa8adebe4d8b
      version: -1
      name: Early Containment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "54"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -600,
          "y": 388
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 3147a19e-41fd-493f-823d-87582c61e37b
    type: title
    task:
      id: 3147a19e-41fd-493f-823d-87582c61e37b
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "10"
      - "9"
      - "8"
      - "40"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 636,
          "y": 388
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 46aef42c-1ee7-4d61-b6df-d2869b8bcb59
    type: regular
    task:
      id: 46aef42c-1ee7-4d61-b6df-d2869b8bcb59
      version: -1
      name: Get user risk score
      description: This script gathers user data from multiple integrations and returns an Account entity with consolidated information to the context.
      type: regular
      iscommand: false
      brand: ""
      scriptName: get-user-data
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      user_name:
        simple: ${Core.OriginalAlert.raw_abioc.event.identity_normalized.identity}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 881,
          "y": 527
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: 146faa60-9405-4cf2-8f7c-7ce02160a0c4
    type: regular
    task:
      id: 146faa60-9405-4cf2-8f7c-7ce02160a0c4
      version: -1
      name: Check if rule creation occurred outside business hours
      description: Checks whether the given value is within the specified time (hour) range.
      scriptName: BetweenHours
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "23"
    scriptarguments:
      begin_time:
        simple: "22:00:00"
      end_time:
        simple: "06:00:00"
      extend-context:
        simple: IsOutOfWorkingHours=
      value:
        complex:
          root: Core.OriginalAlert.event
          accessor: event_timestamp
          transformers:
          - operator: TimeStampToDate
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 101,
          "y": 527
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: cdba5566-f4de-4815-85ba-46d04083adf2
    type: regular
    task:
      id: cdba5566-f4de-4815-85ba-46d04083adf2
      version: -1
      name: Analyze geolocation anomalies
      description: |-
        Returns all elements from the left side that have a substring that is equal to an element from the right side. Note: This filter is case-insensitive.
      scriptName: AnyMatch
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      extend-context:
        simple: IsAbnormalGeolocation=
      left:
        simple: ${Core.OriginalAlert.event.saas_caller_ip_geolocation_days_seen_count},${Core.OriginalAlert.event.service_caller_ip_asn_days_seen_count}
      right:
        simple: "0"
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 491,
          "y": 527
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: c0812731-773a-47eb-8176-b1694f6919c4
    type: regular
    task:
      id: c0812731-773a-47eb-8176-b1694f6919c4
      version: -1
      name: Close Alert
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      closeReason:
        simple: Resolved - True Positive
      id:
        complex:
          root: alert
          accessor: id
      closeNotes:
        simple: Handled by the playbook "Exchange forwarding rule configured".
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 420,
          "y": 1879
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 08bbda77-f3ca-482f-83bb-6590a059f649
    type: regular
    task:
      id: 08bbda77-f3ca-482f-83bb-6590a059f649
      version: -1
      name: Disable the Exchange forwarding inbox rule
      description: Disable an existing inbox rule in a given mailbox.
      script: '|||ews-rule-disable'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      identity:
        simple: ${Core.OriginalAlert.raw_abioc.event.exchange_rule_name}
      mailbox:
        simple: ${Core.OriginalAlert.raw_abioc.event.identity_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 874,
          "y": 1732
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 58ed5fd7-71b7-4865-8de2-a4b02de08967
    type: title
    task:
      id: 58ed5fd7-71b7-4865-8de2-a4b02de08967
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1262,
          "y": 2000
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: 3551faf2-9e47-4c2b-ae7a-61f2cd7ebc5f
    type: regular
    task:
      id: 3551faf2-9e47-4c2b-ae7a-61f2cd7ebc5f
      version: -1
      name: Set risky user to aggregated evidences
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This script runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about script permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidences
      value:
        complex:
          root: .
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs==rhs
              conditionB: {}
              conditionInBetween: {}
              else: {}
              equals: {}
              lhs:
                value:
                  simple: UserData.RiskLevel
                iscontext: true
              lhsB: {}
              options: {}
              optionsB: {}
              rhs:
                value:
                  simple: HIGH
              rhsB: {}
              then:
                value:
                  simple: The user risk level is high.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 881,
          "y": 648
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 44ae1921-e62d-4ace-8ad6-604f750b32e0
    type: regular
    task:
      id: 44ae1921-e62d-4ace-8ad6-604f750b32e0
      version: -1
      name: Set abnormal geolocation to aggregated evidences
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This script runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about script permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidences
      value:
        complex:
          root: ${
          accessor: '}'
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs==rhs
              conditionB: {}
              conditionInBetween: {}
              else: {}
              equals: {}
              lhs:
                value:
                  simple: IsAbnormalGeolocation.[0]
                iscontext: true
              lhsB: {}
              options: {}
              optionsB: {}
              rhs:
                value:
                  simple: "True"
              rhsB: {}
              then:
                value:
                  simple: The user connected from an unusual geolocation.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 491,
          "y": 648
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: 347eeeb4-facc-4e53-8832-013274dac80f
    type: regular
    task:
      id: 347eeeb4-facc-4e53-8832-013274dac80f
      version: -1
      name: Set abnormal working hours to aggregated evidences
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This script runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about script permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidences
      value:
        complex:
          root: ${
          accessor: '}'
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs==rhs
              conditionB: {}
              conditionInBetween: {}
              else: {}
              equals: {}
              lhs:
                value:
                  simple: IsOutOfWorkingHours
                iscontext: true
              lhsB: {}
              options: {}
              optionsB: {}
              rhs:
                value:
                  simple: "true"
              rhsB: {}
              then:
                value:
                  simple: User created forwarding rule outside of business hours.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 101,
          "y": 648
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 81129f5e-eca1-4467-96a7-2ffd2fb87762
    type: condition
    task:
      id: 81129f5e-eca1-4467-96a7-2ffd2fb87762
      version: -1
      name: Checking soft remediation conditions
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "48"
      "Yes":
      - "50"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidences
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "3"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1014,
          "y": 1055
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: b09a9327-e34b-4f81-8782-e54ae932ca27
    type: condition
    task:
      id: b09a9327-e34b-4f81-8782-e54ae932ca27
      version: -1
      name: Check if a forwarding address domain exists
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "6"
      "yes":
      - "3"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: Core.OriginalAlert.raw_abioc.event.forwarding_domain_with_tld
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 906,
          "y": -8
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 73936401-a8d4-4374-8d30-4c9bc55f590e
    type: title
    task:
      id: 73936401-a8d4-4374-8d30-4c9bc55f590e
      version: -1
      name: Evaluate investigation results
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "37"
      - "36"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 636,
          "y": 791
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: 5a7d6dc0-9fda-4277-80f8-16c3c8f7b180
    type: condition
    task:
      id: 5a7d6dc0-9fda-4277-80f8-16c3c8f7b180
      version: -1
      name: Checking medium severity conditions
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "48"
      "yes":
      - "32"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.severity
            iscontext: true
          right:
            value:
              simple: SEV_030_MEDIUM
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidences
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "2"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 156,
          "y": 1188
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: 6cc4ec9a-a36d-48e5-852b-a5c1bc1b782f
    type: collection
    task:
      id: 6cc4ec9a-a36d-48e5-852b-a5c1bc1b782f
      version: -1
      name: Decide whether to disable the user account
      description: ""
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -65,
          "y": 1320
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: "The following evidence was found: \n\n${Evidences}\n\nWould you like to disable the account ${Core.OriginalAlert.raw_abioc.event.identity_name}?"
        required: false
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - simple: "Yes"
        - simple: "No"
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Select user account containment steps
      description: The investigation revealed several suspicious indicators suggesting the user who created the forwarding rule may be compromised. The associated forwarding email and filters have been automatically removed. Please decide whether to take any additional recommended actions.
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 65ab206a-9e3f-4b64-8efe-0ec2ba0d3e54
    type: condition
    task:
      id: 65ab206a-9e3f-4b64-8efe-0ec2ba0d3e54
      version: -1
      name: Check analyst decision
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "48"
      "yes":
      - "53"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Select user account containment steps.Answers.0
            iscontext: true
          right:
            value:
              simple: "Yes"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -65,
          "y": 1453
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: ed34eb8f-329b-49f1-8f12-d0e979055d77
    type: title
    task:
      id: ed34eb8f-329b-49f1-8f12-d0e979055d77
      version: -1
      name: Early Containment Complete
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "14"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -600,
          "y": 805
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: ec931801-d2f1-4042-84b4-0a7adf76ed05
    type: title
    task:
      id: ec931801-d2f1-4042-84b4-0a7adf76ed05
      version: -1
      name: Hard Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "41"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 156,
          "y": 938
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: f6057cef-9260-4970-8b1d-88edb25b4059
    type: title
    task:
      id: f6057cef-9260-4970-8b1d-88edb25b4059
      version: -1
      name: Soft Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "25"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1014,
          "y": 933
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: 0ad3c032-8b63-40e8-8c30-edab2a540918
    type: regular
    task:
      id: 0ad3c032-8b63-40e8-8c30-edab2a540918
      version: -1
      name: Verify if user is an Exchange admin
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This script runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about script permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidences
      value:
        complex:
          root: ${
          accessor: '}'
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs==rhs
              conditionB: {}
              conditionInBetween: {}
              else: {}
              equals: {}
              lhs:
                value:
                  simple: Core.OriginalAlert.event.service_sub_type
                iscontext: true
              lhsB: {}
              options: {}
              optionsB: {}
              rhs:
                value:
                  simple: ExchangeAdmin
              rhsB: {}
              then:
                value:
                  simple: The user has admin privileges.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1271,
          "y": 527
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: d7dd8118-96e2-4427-ac08-7f68b437ae63
    type: condition
    task:
      id: d7dd8118-96e2-4427-ac08-7f68b437ae63
      version: -1
      name: Checking hard remediation conditions
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "48"
      - "30"
      "yes":
      - "51"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                    ignorecase: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: domain
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                accessor: Indicator
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 156,
          "y": 1048
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 70e37f74-2f2f-41bf-88fc-463eaba78af7
    type: condition
    task:
      id: 70e37f74-2f2f-41bf-88fc-463eaba78af7
      version: -1
      name: Check EWS Extension Online Powershell availability
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "48"
      "yes":
      - "44"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: EWS Extension Online Powershell v3
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
                    ignorecase: true
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1262,
          "y": 1320
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: f89e9955-3dd9-4670-8a5e-08f041d3414b
    type: condition
    task:
      id: f89e9955-3dd9-4670-8a5e-08f041d3414b
      version: -1
      name: Check Alert type
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "18"
      Inbox Rule:
      - "46"
      Transport Rule:
      - "47"
    separatecontext: false
    conditions:
    - label: Inbox Rule
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.name
            iscontext: true
          right:
            value:
              simple: External Exchange inbox forwarding rule configured
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.name
            iscontext: true
          right:
            value:
              simple: Suspicious Exchange inbox forwarding rule configured
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.name
            iscontext: true
          right:
            value:
              simple: Possible BEC Exchange email-hiding inbox rule
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.name
            iscontext: true
          right:
            value:
              simple: Suspicious Exchange email-hiding inbox rule
          ignorecase: true
    - label: Transport Rule
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: alert.name
            iscontext: true
          right:
            value:
              simple: Exchange email-hiding transport rule based on message keywords
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.name
            iscontext: true
          right:
            value:
              simple: Suspicious Exchange email-hiding transport rule
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.name
            iscontext: true
          right:
            value:
              simple: Exchange transport forwarding rule configured
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.name
            iscontext: true
          right:
            value:
              simple: Suspicious Exchange transport forwarding rule configured
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1262,
          "y": 1453
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: cce63e53-a02d-4d25-89ec-3684f0de635e
    type: regular
    task:
      id: cce63e53-a02d-4d25-89ec-3684f0de635e
      version: -1
      name: Disable the Exchange forwarding transport rule
      description: Disable a mail flow rule (transport rule) in the organization.
      script: '|||ews-mail-flow-rule-disable'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      identity:
        simple: ${Core.OriginalAlert.event.exchange_transport_rule_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1669,
          "y": 1732
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: 040c3bcd-4166-4768-847f-e4d09303d1f5
    type: condition
    task:
      id: 040c3bcd-4166-4768-847f-e4d09303d1f5
      version: -1
      name: Check if inbox rule name is not empty
      description: Checks if there is a rule name in the context.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "18"
      "yes":
      - "17"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: Core.OriginalAlert.raw_abioc.event.exchange_rule_name
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1051,
          "y": 1586
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: a5bf70e3-c221-4511-8166-f205c7ee13b6
    type: condition
    task:
      id: a5bf70e3-c221-4511-8166-f205c7ee13b6
      version: -1
      name: Check if transport rule name is not empty
      description: Checks if there is a transport rule name in the context.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "18"
      "yes":
      - "45"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: Core.OriginalAlert.raw_abioc.event.exchange_transport_rule_name
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1499,
          "y": 1586
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: 08f4e462-9c50-4514-9984-38c19c91dc42
    type: title
    task:
      id: 08f4e462-9c50-4514-9984-38c19c91dc42
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 156,
          "y": 1591
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "49":
    id: "49"
    taskid: f9abb6cd-cf63-42cb-95b7-477b61104b66
    type: condition
    task:
      id: f9abb6cd-cf63-42cb-95b7-477b61104b66
      version: -1
      name: Check if a forwarding IP address exists
      type: condition
      iscommand: false
      brand: ""
      description: "Check if a forwarding IP address exists"
    nexttasks:
      '#default#':
      - "6"
      "yes":
      - "2"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: Core.OriginalAlert.event.caller_ip
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 392,
          "y": -8
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "50":
    id: "50"
    taskid: ec668c8c-1949-43cb-a444-962413520eb5
    type: regular
    task:
      id: ec668c8c-1949-43cb-a444-962413520eb5
      version: -1
      name: Increase alert severity
      description: Optionally increases the alert severity to the new value if it is greater than the existing severity.
      scriptName: IncreaseAlertSeverity
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "43"
      - "52"
    scriptarguments:
      severity:
        simple: Medium
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1017,
          "y": 1198
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "51":
    id: "51"
    taskid: c66fcdad-363d-4233-89ea-9b28404b1d0e
    type: regular
    task:
      id: c66fcdad-363d-4233-89ea-9b28404b1d0e
      version: -1
      name: Increase alert severity
      description: Optionally increases the alert severity to the new value if it is greater than the existing severity.
      scriptName: IncreaseAlertSeverity
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "32"
    scriptarguments:
      severity:
        simple: Medium
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -267,
          "y": 1188
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: cc09ac7a-309c-4fa3-a6ab-e13a1db45980
    type: regular
    task:
      id: cc09ac7a-309c-4fa3-a6ab-e13a1db45980
      version: -1
      name: Clear user session
      description: This script clears user sessions across multiple integrations for a list of usernames.
      scriptName: clear-user-session
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      brands:
        simple: Microsoft Graph User
      user_name:
        simple: ${Core.OriginalAlert.event.identity_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 850,
          "y": 1320
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "53":
    id: "53"
    taskid: 5ad1ce61-98a8-4d89-b7b1-0da3a18f05a5
    type: regular
    task:
      id: 5ad1ce61-98a8-4d89-b7b1-0da3a18f05a5
      version: -1
      name: Disable user account via MS-Graph
      description: This script disables users for multiple services.
      scriptName: disable-user
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      brands:
        simple: Microsoft Graph User
      user_email:
        simple: ${Core.OriginalAlert.event.identity_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -267,
          "y": 1586
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "54":
    id: "54"
    taskid: 38630e4e-3c63-4d16-9857-dcf7725dfa8a
    type: regular
    task:
      id: 38630e4e-3c63-4d16-9857-dcf7725dfa8a
      version: -1
      name: Block external IP
      description: The script blocks a list of IP addresses in supported integrations.
      scriptName: block-external-ip
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "35"
    scriptarguments:
      ip_list:
        simple: ${Core.OriginalAlert.event.caller_ip}
    results:
    - push_job_id
    - commit_job_id
    - panorama_responses
    - executed_brands
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -600,
          "y": 527
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "25_48_#default#": 0.1,
      "25_50_Yes": 0.44,
      "28_3_yes": 0.62,
      "28_6_#default#": 0.44,
      "30_32_yes": 0.3,
      "30_48_#default#": 0.48,
      "34_48_#default#": 0.25,
      "41_48_#default#": 0.56,
      "41_51_yes": 0.55,
      "43_44_yes": 0.47,
      "43_48_#default#": 0.21,
      "44_18_#default#": 0.35,
      "44_46_Inbox Rule": 0.45,
      "44_47_Transport Rule": 0.45,
      "46_17_yes": 0.66,
      "46_18_#default#": 0.22,
      "47_18_#default#": 0.23,
      "47_45_yes": 0.57,
      "49_2_yes": 0.5,
      "49_6_#default#": 0.41,
      "4_5_yes": 0.38,
      "4_6_#default#": 0.33
    },
    "paper": {
      "dimensions": {
        "height": 2309,
        "width": 2650,
        "x": -600,
        "y": -249
      }
    }
  }
inputs: []
inputSections:
- inputs: []
  name: General (Inputs group)
  description: Generic group for inputs.
outputSections:
- outputs: []
  name: General (Outputs group)
  description: Generic group for outputs.
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.10.0
marketplaces:
- marketplacev2
- platform
contentitemexportablefields:
  contentitemfields: {}
