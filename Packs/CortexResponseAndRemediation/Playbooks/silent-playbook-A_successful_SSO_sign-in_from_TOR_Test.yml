id: silent-A successful SSO sign-in from TOR Test
version: -1
name: silent-A successful SSO sign-in from TOR Test
description: "This playbook is designed to handle the following alerts:\n- A successful SSO sign-in from TOR\n- A successful SSO sign-in from TOR via a mobile device\n\nThe playbook executes the following stages:\n\nEarly Containment:\n- The playbooks will perform early containment actions by clearing\\revoking user sessions and enforcing re-authentication to terminate the connection from the Tor exit node and verify the user's identity. \nDepending on the alert source, the playbook will use either\nAzure Active Directory Users or Okta v2 integrations to clear the user sessions.\n\nInvestigation:\nDuring the alert investigation, the playbook will perform the following:\n- Checks the user's risk score.\n- Search for suspicious user agent usage within the alert.\n- Search for related XDR alerts using the following MITRE techniques to identify any malicious activity:\nT1566 - Phishing \nT1621 - Multi-Factor Authentication Request Generation\n T1110 - Brute Force\n T1556 - Modify Authentication Process\n\nRemediation:\n- Remediation actions will be taken if the userâ€™s risk score is high, a suspicious user agent is detected, or a related alert is found. In such cases, the playbook will disable the account.\nBy default, account disabling requires analyst approval.\n\nRequires: \nFor any response action, you will need one of the following integrations: Azure Active Directory Users / Okta v2."
tags:
- TA0011 - Command and Control
- T1090 - Proxy
- TA0001 - Initial Access
- T1078 - Valid Accounts
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 7162cd0e-1568-4938-8bf2-3974f8874e2b
    type: start
    task:
      id: 7162cd0e-1568-4938-8bf2-3974f8874e2b
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "29"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: 96639f37-9169-4eda-8a31-1b01f1cad0f0
    type: title
    task:
      id: 96639f37-9169-4eda-8a31-1b01f1cad0f0
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "41"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 789
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: 7afa6973-3296-4ef6-8434-95655d48ddc1
    type: title
    task:
      id: 7afa6973-3296-4ef6-8434-95655d48ddc1
      version: -1
      name: Early Containment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "40"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -450
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: ccd594ea-6c1f-4dee-85d7-095f18061784
    type: regular
    task:
      id: ccd594ea-6c1f-4dee-85d7-095f18061784
      version: -1
      name: Get User Risk Level
      description: This script gathers user data from multiple integrations and returns an Account entity with consolidated information to the context.
      scriptName: get-user-data
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "39"
    scriptarguments:
      user_name:
        simple: ${alert.username}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -20
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: dd4463cb-7ede-4f07-8c27-c619914fc0b0
    type: condition
    task:
      id: dd4463cb-7ede-4f07-8c27-c619914fc0b0
      version: -1
      name: Found related alerts requiring user disabling?
      description: Checks whether the number of related alerts found during the investigation phase is greater than the 'RelatedAlertsThreshold' to determine if the activity is malicious.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "34"
      "yes":
      - "11"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 680,
          "y": 632
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 2a134879-fcfc-470e-812d-93ce1efcce06
    type: regular
    task:
      id: 2a134879-fcfc-470e-812d-93ce1efcce06
      version: -1
      name: Close Alert
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "34"
    scriptarguments:
      closeReason:
        simple: Resolved - True Positive
      closeNotes:
        simple: Handled by the playbook "A successful SSO sign-in from TOR"
      id:
        complex:
          root: alert
          accessor: id
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 451,
          "y": 1255
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 3a5f823a-9e66-4ff0-8593-cf79450c6e8b
    type: title
    task:
      id: 3a5f823a-9e66-4ff0-8593-cf79450c6e8b
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -155
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 7c7a611a-b689-48b3-80d8-48470f6cc918
    type: regular
    task:
      id: 7c7a611a-b689-48b3-80d8-48470f6cc918
      version: -1
      name: Get alert's extra data
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "16"
    scriptarguments:
      alert_ids:
        complex:
          root: alert
          accessor: id
          transformers:
          - operator: uniq
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -615
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: ac6f6ef2-f905-4254-8d4b-d1de5e78b8a2
    type: condition
    task:
      id: ac6f6ef2-f905-4254-8d4b-d1de5e78b8a2
      version: -1
      name: Is the user high-risk or is the user agent suspicious?
      description: "Determines the appropriate remediation actions based on the following:\n- User Risk Level\n- Suspicious User Agent "
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "37"
      "yes":
      - "11"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: UserData.RiskLevel
            iscontext: true
          right:
            value:
              simple: HIGH
          ignorecase: true
        - operator: isNotEmpty
          left:
            value:
              simple: SuspiciousUserAgent
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 320
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 6c97bbd8-3e36-4abf-8746-7dd2982daf33
    type: title
    task:
      id: 6c97bbd8-3e36-4abf-8746-7dd2982daf33
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 681,
          "y": 1418
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: d000a28d-16dd-4df2-8aef-f22c0e4045b0
    type: regular
    task:
      id: d000a28d-16dd-4df2-8aef-f22c0e4045b0
      version: -1
      name: Search for related alerts by name and MITRE Technique
      description: "This task searches for suspicious alerts related to incident by MITRE techniques that may indicate a compromised user.\nFocus on identifying alerts associated with the following MITRE techniques:\n- T1566 - Phishing \n- T1621 - Multi-Factor Authentication Request Generation\n- T1110 - Brute Force\n- T1556 - Modify Authentication Process\n\nAnd the following alert:\n- \"SSO with an offensive user agent\"\n\n\n\n\n\n"
      scriptName: SearchIncidentsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "20"
    scriptarguments:
      query:
        complex:
          root: alert
          accessor: parentXDRIncident
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '-'
              fields:
                value:
                  simple: "2"
          - operator: concat
            args:
              prefix:
                value:
                  simple: '(mitreattcktechnique:*T1566* or mitreattcktechnique:*T1110* or mitreattcktechnique:*T1621* or mitreattcktechnique:*T1556* or name:"SSO with an offensive user agent") and caseid:'
              suffix: {}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 680,
          "y": 490
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 1c57c5a6-dd47-4b0e-84b0-b5fa1b1198f3
    type: regular
    task:
      id: 1c57c5a6-dd47-4b0e-84b0-b5fa1b1198f3
      version: -1
      name: Extract suspicious user agent
      description: Extracts regex data from the provided text. The script supports groups and looping.
      scriptName: MatchRegexV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "31"
    scriptarguments:
      contextKey:
        simple: SuspiciousUserAgent
      data:
        simple: ${Core.OriginalAlert.event.action_user_agent}
      regex:
        simple: \b(Python-urllib|libwww-perl|Scrapy|curl|Wget|sqlmap|Nikto|Xrumer|Hydra|JohnTheRipper|LOIC|HOIC|MJ12bot|Baiduspider|BlackWidow|HeadlessChrome|PhantomJS|Selenium|REST)\b
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 150
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: 59963f6d-84ac-4f00-8263-8abb664228d9
    type: regular
    task:
      id: 59963f6d-84ac-4f00-8263-8abb664228d9
      version: -1
      name: Clear user sessions
      description: This script clears user sessions across multiple integrations for a list of usernames.
      scriptName: clear-user-session
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "24"
    scriptarguments:
      user_name:
        simple: ${Core.OriginalAlert.raw_abioc.event.auth_identity}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -308
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: 366bacfc-2b91-4162-8e0e-a5dc4ef352a4
    type: condition
    task:
      id: 366bacfc-2b91-4162-8e0e-a5dc4ef352a4
      version: -1
      name: Analyst Decision
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      "No":
      - "22"
      "Yes":
      - "43"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 487,
          "y": 939
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
        simple: |-
          ## During the investigation we have found the following:

          ### User Risk Level:
          - **Authentication Settings Changes**: `${.=val.UserData.RiskLevel || "None"}`
          ${.=val.SuspiciousAuthentication || "None"}`
          - **Suspicious User Agent**: `${.=val.SuspiciousUserAgent || "None"}`

          Please decide whether you wish to disable the user who connected from a TOR exit node
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
      replyOptions:
      - "Yes"
      - "No"
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: a4d55f9a-4259-4f3b-8cc0-e30ebe2c4cc5
    type: regular
    task:
      id: a4d55f9a-4259-4f3b-8cc0-e30ebe2c4cc5
      version: -1
      name: Disable user
      description: This script disables users for multiple services.
      scriptName: disable-user
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      user_name:
        simple: ${alert.username}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 107,
          "y": 1095
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "20_11_yes": 0.36,
      "31_11_yes": 0.3,
      "31_37_#default#": 0.62
    },
    "paper": {
      "dimensions": {
        "height": 2228,
        "width": 954,
        "x": 107,
        "y": -750
      }
    }
  }
inputs: []
inputSections:
- inputs: []
  name: General (Inputs group)
  description: Generic group for inputs
outputSections:
- outputs: []
  name: General (Outputs group)
  description: Generic group for outputs.
outputs: []
tests:
- No tests (auto formatted)
fromversion: 8.9.0
issilent: true
marketplaces:
- marketplacev2
- platform
