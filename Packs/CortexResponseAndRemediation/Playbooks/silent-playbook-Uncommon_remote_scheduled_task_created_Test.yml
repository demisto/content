contentitemexportablefields:
  contentitemfields: {}
description: |-
  This playbook handles "Uncommon remote scheduled task created" alerts.

  Playbook Stages:

  Analysis:

  - The playbook checks if the remote IP is external or has a bad reputation.
  - The playbook checks the host risk score.

  Investigation:
  During the alert investigation, the playbook will perform the following:

  - Searches for related XSIAM alerts on the endpoint that use the following MITRE techniques to identify malicious activity: T1202 - Indirect Command Execution, T1021 - Remote Services.
  - Searches for related XSIAM agent alerts on the remote endpoint, to determine if the creation of the scheduled task is part of an attack pattern.
  - Searches for suspicious command-line parameters indicating a malicious scheduled task.

  Remediation:

  - Automatically disable the malicious scheduled task.
  - Block the malicious IP (requires analyst approval).
  - Automatically Close the alert.
fromversion: 8.9.0
id: silent-Uncommon remote scheduled task created Test
inputs: []
issilent: true
marketplaces:
- marketplacev2
- platform
name: silent-Uncommon remote scheduled task created Test
outputs: []
starttaskid: '0'
tags:
- TA0002 - Execution
- T1053 - Scheduled Task/Job
tasks:
  '0':
    continueonerrortype: ''
    id: '0'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '27'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: e27de70b-ada6-422e-81fe-6950a566b050
      iscommand: false
      name: ''
      version: -1
    taskid: e27de70b-ada6-422e-81fe-6950a566b050
    timertriggers: []
    type: start
    view: |-
      {
        "position": {
          "x": 410,
          "y": -840
        }
      }
  '1':
    continueonerrortype: ''
    id: '1'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '47'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 6f7359e7-6ace-48a6-8f72-c30dc8bce825
      iscommand: false
      name: Investigation
      type: title
      version: -1
    taskid: 6f7359e7-6ace-48a6-8f72-c30dc8bce825
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 760,\n    \"y\": 520\n  }\n}"
  '13':
    continueonerrortype: ''
    id: '13'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '26'
    note: false
    quietmode: 0
    scriptarguments:
      closeNotes:
        simple: Malicious scheduled task detected - Handled by the playbook "Uncommon remote scheduled task created"
      closeReason:
        simple: Resolved - True Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Close the current alert.
      id: cbb88a25-3267-48dc-8423-605dbeb295a0
      iscommand: true
      name: Close Alert - True Positive
      script: Builtin|||closeInvestigation
      type: regular
      version: -1
    taskid: cbb88a25-3267-48dc-8423-605dbeb295a0
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 410,
          "y": 3220
        }
      }
  '14':
    continueonerror: true
    continueonerrortype: errorPath
    id: '14'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#error#':
      - '22'
      '#none#':
      - "70"
    note: false
    quietmode: 0
    scriptarguments:
      endpoint_ids:
        simple: ${alert.agentid}
      timeout:
        simple: '120'
      command:
        simple: powershell.exe schtasks /change /tn "${Core.OriginalAlert.event.scheduled_task_path}" /disable
      polling_timeout_in_seconds:
        simple: "120"
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Run a shell command on a specific endpoint and return its result.
      id: bb3ed083-823b-4e17-8494-16ec6bc49b2a
      iscommand: true
      name: Disable the malicious scheduled task
      script: '|||core-execute-command'
      type: regular
      version: -1
    taskid: bb3ed083-823b-4e17-8494-16ec6bc49b2a
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 130,
          "y": 2670
        }
      }
  '17':
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: IPEnrichment.TIMScore
          operator: isEqualNumber
          right:
            value:
              simple: '3'
      label: 'yes'
    continueonerrortype: ''
    id: '17'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '13'
      'yes':
      - '23'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Checks whether a malicious IP is detected and requires blocking.
      id: 47529ac8-a0ed-4d35-8019-a8b679181f22
      iscommand: false
      name: Is there a malicious IP to block?
      type: condition
      version: -1
    taskid: 47529ac8-a0ed-4d35-8019-a8b679181f22
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 840,
          "y": 2680
        }
      }
  '2':
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: IP.InRange
          operator: isEqualString
          right:
            value:
              simple: 'no'
        - operator: isNotEmpty
          left:
            value:
              simple: ExternalIPv6
            iscontext: true
      label: 'Yes'
    continueonerrortype: ''
    id: '2'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '1'
      'Yes':
      - '3'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: 'Determines the appropriate verdict if the task was created from an external IP address.


        Remote scheduled tasks created from an external IP address may indicate unauthorized access or malicious activity. Legitimate remote scheduled tasks should be created from trusted internal sources. If the task is created from an external IP, the playbook will proceed with remediation actions; otherwise, it will continue investigating the alert.'
      id: eae7099d-0e36-4442-8d50-a5e79d067791
      iscommand: false
      name: Check whether the remote IP is external
      type: condition
      version: -1
    taskid: eae7099d-0e36-4442-8d50-a5e79d067791
    timertriggers: []
    type: condition
    view: "{\n  \"position\": {\n    \"x\": 410,\n    \"y\": 350\n  }\n}"
  '22':
    continueonerrortype: ''
    id: '22'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "13"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: 'Dear Analyst,


        During the remediation process the playbook failed to disable the scheduled task: ${Core.OriginalAlert.event.scheduled_task_path}


        Please manually disable this scheduled task.'
      id: 25929bfd-f6cd-43f9-87cd-8d0c0caf677d
      iscommand: false
      name: Disable the malicious scheduled task manually
      type: regular
      version: -1
    taskid: 25929bfd-f6cd-43f9-87cd-8d0c0caf677d
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -355,
          "y": 3018
        }
      }
  '23':
    continueonerrortype: ''
    id: '23'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "74"
      - "75"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: c5219f31-047d-4cee-888e-f7c63909a296
      iscommand: false
      name: Block Malicious IP
      type: title
      version: -1
    taskid: c5219f31-047d-4cee-888e-f7c63909a296
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 840,
          "y": 2873
        }
      }
  '26':
    continueonerrortype: ''
    id: '26'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: ff18f72c-0256-4776-823c-90dd05fdba39
      iscommand: false
      name: Done
      type: title
      version: -1
    taskid: ff18f72c-0256-4776-823c-90dd05fdba39
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 410,
          "y": 3730
        }
      }
  '27':
    continueonerrortype: ''
    id: '27'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '29'
    note: false
    quietmode: 0
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: 'false'
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Returns information about each alert ID.
      id: 91b0123e-c227-465b-84d6-a3c53e9a8eb4
      iscommand: true
      name: Get scheduled task details
      script: '|||core-get-cloud-original-alerts'
      type: regular
      version: -1
    taskid: 91b0123e-c227-465b-84d6-a3c53e9a8eb4
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 410,
          "y": -705
        }
      }
  '29':
    continueonerrortype: ''
    id: '29'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "80"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: b6d11f6e-a28a-459a-8004-bec570e4b02a
      iscommand: false
      name: Analysis
      type: title
      version: -1
    taskid: b6d11f6e-a28a-459a-8004-bec570e4b02a
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 410,
          "y": -560
        }
      }
  '3':
    continueonerrortype: ''
    id: '3'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '14'
      - "17"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: ababf146-0f9f-4621-8323-18c3256738ee
      iscommand: false
      name: Remediation
      type: title
      version: -1
    taskid: ababf146-0f9f-4621-8323-18c3256738ee
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 410,\n    \"y\": 2510\n  }\n}"
  '30':
    continueonerrortype: ''
    id: '30'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '31'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 6d96992e-fe69-4b71-8e3c-9f64ce6a2aec
      iscommand: false
      name: Investigation on remote host
      type: title
      version: -1
    taskid: 6d96992e-fe69-4b71-8e3c-9f64ce6a2aec
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 920,\n    \"y\": 1010\n  }\n}"
  '31':
    continueonerror: true
    continueonerrortype: ''
    id: '31'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '32'
    note: false
    quietmode: 0
    scriptarguments:
      fromdate:
        simple: 1 day ago
      ignore-outputs:
        simple: 'false'
      query:
        simple: agent_ip_addresses:${Core.OriginalAlert.event.actor_remote_ip}
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: This task searches for XSIAM agent related alerts on the remote endpoint from the past 24 hours, if an agent is installed.
      id: 58967e13-7736-4385-858d-85a8966dacd3
      iscommand: false
      name: Search for related alerts on the remote host
      scriptName: SearchIncidentsV2
      type: regular
      version: -1
    taskid: 58967e13-7736-4385-858d-85a8966dacd3
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 920,\n    \"y\": 1145\n  }\n}"
  '32':
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: foundIncidents.sourceBrand
          operator: isEqualString
          right:
            value:
              simple: TRAPS
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: foundIncidents.CustomFields.categoryname
          operator: isEqualString
          right:
            value:
              simple: Malware
      label: 'yes'
    continueonerrortype: ''
    id: '32'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '56'
      'yes':
      - '3'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Determines if there are agent alerts on the remote host indicating that the alert was part of an attack pattern.
      id: 789cf6e0-eded-4b32-8108-8091409a2537
      iscommand: false
      name: Found any alerts of malicious activity on the remote host?
      type: condition
      version: -1
    taskid: 789cf6e0-eded-4b32-8108-8091409a2537
    timertriggers: []
    type: condition
    view: "{\n  \"position\": {\n    \"x\": 920,\n    \"y\": 1320\n  }\n}"
  '38':
    continueonerror: true
    continueonerrortype: ''
    id: '38'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '2'
    note: false
    quietmode: 0
    scriptarguments:
      ip:
        complex:
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: Core.OriginalAlert.event.actor_remote_ip
              operator: notContainsGeneral
              right:
                value:
                  simple: '::'
          root: Core.OriginalAlert.event.actor_remote_ip
      ipRanges:
        complex:
          accessor: PrivateIPs
          root: lists
          transformers:
          - args:
              error_if_no_match: {}
              ignore_case: {}
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: (\b(?:\d{1,3}\.){3}\d{1,3}\b/\d{1,2})
              unpack_matches: {}
            operator: RegexExtractAll
          - args:
              separator:
                value:
                  simple: ','
            operator: join
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Returns yes if the IP is in one of the ranges provided, returns no otherwise.
      id: 7272972f-d88b-484d-897b-61c0fce7def0
      iscommand: false
      name: Determine whether the remote IPv4 address is internal or external
      scriptName: IsIPInRanges
      type: regular
      version: -1
    taskid: 7272972f-d88b-484d-897b-61c0fce7def0
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 680,
          "y": 190
        }
      }
  '41':
    continueonerrortype: ''
    id: '41'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '71'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 5ba5e082-b8f3-413f-89f6-40261ef6a811
      iscommand: false
      name: Analyst Decision
      type: title
      version: -1
    taskid: 5ba5e082-b8f3-413f-89f6-40261ef6a811
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 1070,\n    \"y\": 2030\n  }\n}"
  '43':
    continueonerrortype: ''
    id: '43'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '44'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: fb2896f9-3c9e-4e1f-8d40-db749410a130
      iscommand: false
      name: False Positive
      type: title
      version: -1
    taskid: fb2896f9-3c9e-4e1f-8d40-db749410a130
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 1490,
          "y": 2510
        }
      }
  '44':
    continueonerrortype: ''
    id: '44'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '45'
    note: false
    quietmode: 0
    scriptarguments:
      closeNotes:
        simple: Resolved as False Positive -Handled as False Positive by the playbook "Uncommon remote scheduled task created"
      closeReason:
        simple: Resolved - False Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: commands.local.cmd.close.inv
      id: 86404fb8-c406-4ba8-89c3-508c91daaa5b
      iscommand: true
      name: Close Alert - False Positive
      script: Builtin|||closeInvestigation
      type: regular
      version: -1
    taskid: 86404fb8-c406-4ba8-89c3-508c91daaa5b
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1490,
          "y": 2650
        }
      }
  '45':
    continueonerrortype: ''
    id: '45'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 2329c33f-d84f-4b85-8a5a-08264d5756ae
      iscommand: false
      name: Done
      type: title
      version: -1
    taskid: 2329c33f-d84f-4b85-8a5a-08264d5756ae
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 1490,
          "y": 2803
        }
      }
  '47':
    continueonerrortype: ''
    id: '47'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '8'
    note: false
    quietmode: 0
    scriptarguments:
      fromdate:
        simple: 3 hours ago
      query:
        simple: (name:"*Remote Activity*" or name:"*Malicious Service Creation*" or name:"*Credential Gathering*" or name:"*File Drop*" or name:"*Script Engine Activity*" or name:"*Suspicious Process Creation - *" or name:"*Staged Malware Activity*" or name:"*Powershell Activity - *" or name:"*Process Injection -*" or name:"Local Analysis Malware" or name:"WildFire Malware") and agentid:${alert.agentid}
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: 'This task searches by MITRE technique for suspicious related alerts that may indicate a compromised endpoint.

        Focus on identifying alerts associated with the following MITRE techniques from the last 3 hours:

        - T1202 - Indirect Command Execution

        - T1021 - Remote Services


        And the following alert:

        - "WildFire Malware"


        '
      id: 4373ba97-486c-4617-8298-86a924dc5ca8
      iscommand: false
      name: Search for related alerts that indicate malicious activity
      scriptName: SearchIncidentsV2
      type: regular
      version: -1
    taskid: 4373ba97-486c-4617-8298-86a924dc5ca8
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 760,\n    \"y\": 650\n  }\n}"
  '56':
    continueonerrortype: ''
    id: '56'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "73"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 3dca7f38-a58c-4c1c-8a67-e28182e1216a
      iscommand: false
      name: Command-line Investigation
      type: title
      version: -1
    taskid: 3dca7f38-a58c-4c1c-8a67-e28182e1216a
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 1070,\n    \"y\": 1510\n  }\n}"
  '66':
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: CommandLineAnalysis.score
          operator: greaterThanOrEqual
          right:
            value:
              simple: "30"
      label: Malicious Cmd parameters
    - condition:
      - - left:
            iscontext: true
            value:
              simple: CommandLineAnalysis.score
          operator: InRange
          right:
            value:
              simple: 10,29
        - operator: isEqualString
          left:
            value:
              simple: Core.RiskyHost.risk_level
            iscontext: true
          right:
            value:
              simple: HIGH
          ignorecase: true
      label: Suspicious parameters
    continueonerrortype: ''
    id: '66'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "43"
      Malicious Cmd parameters:
      - '3'
      Suspicious parameters:
      - "41"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Determines the appropriate verdict based on the results of the command-line analysis and the host risk score.
      id: f5c5e77b-66e5-465a-8773-c1d20a200bfa
      iscommand: false
      name: Found any malicious or suspicious parameters?
      type: condition
      version: -1
    taskid: f5c5e77b-66e5-465a-8773-c1d20a200bfa
    timertriggers: []
    type: condition
    view: "{\n  \"position\": {\n    \"x\": 1070,\n    \"y\": 1800\n  }\n}"
  '67':
    continueonerrortype: ''
    id: '67'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "13"
    note: false
    quietmode: 0
    scriptarguments:
      value:
        simple: "Dear Analyst,\n\nDuring the remediation process the playbook executed a shell command to disable the following scheduled task: \n${Core.OriginalAlert.event.scheduled_task_path}\n\n"
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Prints text to war room (Markdown supported)
      id: e7cb4db3-f70e-4474-8ae5-1ad159731138
      iscommand: false
      name: Notify to War Room - Scheduled Task Disabled
      scriptName: Print
      type: regular
      version: -1
    taskid: e7cb4db3-f70e-4474-8ae5-1ad159731138
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 130,
          "y": 3018
        }
      }
  '68':
    continueonerrortype: ''
    id: '68'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '38'
    note: false
    quietmode: 0
    scriptarguments:
      external_enrichment:
        simple: "true"
      ip_list:
        simple: ${Core.OriginalAlert.event.actor_remote_ip}
    separatecontext: false
    skipunavailable: true
    task:
      brand: ''
      description: This script gathers ip reputation data from multiple integrations and returns an ip entity with consolidated information to the context.
      id: 661be0e9-3bb5-4a3c-8908-4586f05d54e7
      iscommand: false
      name: Check remote IPv4 reputation
      type: regular
      version: -1
      scriptName: ip-enrichment
    taskid: 661be0e9-3bb5-4a3c-8908-4586f05d54e7
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 680,
          "y": 40
        }
      }
    continueonerror: true
  '70':
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: Core.ScriptResult.results.executed_command.standard_output
          operator: containsString
          right:
            value:
              simple: SUCCESS
      label: 'yes'
    continueonerrortype: ''
    id: '70'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '22'
      'yes':
      - '67'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Verify if the script successfully disabled the task.
      id: 1666967d-c2af-4352-82f0-0d17d99b391f
      iscommand: false
      name: Has the script disabled the task successfully?
      type: condition
      version: -1
    taskid: 1666967d-c2af-4352-82f0-0d17d99b391f
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 130,
          "y": 2818
        }
      }
  '71':
    continueonerrortype: ''
    form:
      description: "Dear Analyst,\n\nSummary of the investigation of the remote scheduled task creation:\n\n- The task was created from an internal IP address.\n- No related alerts were found indicating malicious activity on the endpoint or remote endpoint.\n- No malicious command line indicators were detected.\n \nHowever, the playbook detected suspicious command-line arguments or a high host risk score.\n\nDecision Needed: "
      expired: false
      questions:
      - defaultrows: []
        fieldassociated: ''
        gridcolumns: []
        id: '0'
        label: ''
        labelarg:
          simple: 'The following command line contains suspicious parameters:


            ${Core.OriginalAlert.event.scheduled_task_image_command_line}


            Would you like to proceed with disabling the scheduled task, or should this be considered a false positive? '
        options: []
        optionsarg:
        - {}
        - simple: Disable Schedule Task
        - simple: False Positive
        placeholder: ''
        readonly: false
        required: true
        tooltip: ''
        type: singleSelect
      sender: ''
      title: Analyst Decision to Disable Scheduled Task
      totalanswers: 0
    id: '71'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    message:
      bcc:
      body:
        simple: "Dear Analyst,\n\nSummary of the investigation of the remote scheduled task creation:\n\n- The task was created from an internal IP address: ${Core.OriginalAlert.event.actor_remote_ip}.\n- No related alerts were found indicating malicious activity on the endpoint or remote endpoint.\n- No malicious command line indicators were detected.\n \nHowever, the playbook detected suspicious arguments in the command line. \nThe following command line contains suspicious parameters:\n\n${Core.OriginalAlert.event.scheduled_task_image_command_line}\n\nDecision Needed: \n\nWould you like to proceed with disabling the scheduled task, or should this be considered a false positive?"
      cc:
      format: ''
      methods: []
      replyOptions:
      - Disable Schedule Task
      - False Positive
      subject:
      timings:
        completeafterreplies: 1
        completeaftersla: false
        completeafterv2: true
        retriescount: 2
        retriesinterval: 360
      to:
    nexttasks:
      '#none#':
      - '72'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Analyst review is required to determine, based on suspicious command-line parameters, whether to take remediation actions  such as disabling the scheduled task and blocking the IP if malicious or to close the alert as a false positive.
      id: 0ae56624-11e4-4420-8245-6b62c02d8a2f
      iscommand: false
      name: Analyst decision for suspicious parameters
      type: collection
      version: -1
    taskid: 0ae56624-11e4-4420-8245-6b62c02d8a2f
    timertriggers: []
    type: collection
    view: "{\n  \"position\": {\n    \"x\": 1070,\n    \"y\": 2180\n  }\n}"
  '72':
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: Analyst Decision to Disable Scheduled Task.Answers.0
          operator: isEqualString
          right:
            value:
              simple: Disable Schedule Task
      label: Disable Schedule Task
    continueonerrortype: ''
    id: '72'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '43'
      Disable Schedule Task:
      - '3'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Checks if the scheduled task should be disabled based on the analyst's decision.
      id: f12ee6de-ec1a-4c0b-872a-7653ef15891c
      iscommand: false
      name: Should disable schedule task based on the analyst decision?
      type: condition
      version: -1
    taskid: f12ee6de-ec1a-4c0b-872a-7653ef15891c
    timertriggers: []
    type: condition
    view: "{\n  \"position\": {\n    \"x\": 1070,\n    \"y\": 2340\n  }\n}"
  '8':
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: foundIncidents.name
          operator: isNotEmpty
      label: 'yes'
    continueonerrortype: ''
    id: '8'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '30'
      'yes':
      - '3'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Determines whether the alert contains agent alerts indicating that the alert was part of an attack pattern.
      id: 287b6585-4340-4fd2-8134-6ee815f90846
      iscommand: false
      name: Found any alerts indicating this is a malicious scheduled task?
      type: condition
      version: -1
    taskid: 287b6585-4340-4fd2-8134-6ee815f90846
    timertriggers: []
    type: condition
    view: "{\n  \"position\": {\n    \"x\": 760,\n    \"y\": 830\n  }\n}"
  "73":
    id: "73"
    taskid: 1fa3388c-d4f4-4fc5-8f9c-226f2500d2f9
    type: regular
    task:
      id: 1fa3388c-d4f4-4fc5-8f9c-226f2500d2f9
      version: -1
      name: Command Line Analysis
      description: |-
        This script evaluates command-line threats by analyzing both original and decoded inputs. It assigns weighted scores to detected patterns, such as AMSI bypass or credential dumping, and applies risk combination bonuses for multiple detections. The total score is normalized to a 0-100 scale, with risk levels categorized as follows:

        * 0-25: Low Risk
        * 26-50: Medium Risk
        * 51-90: High Risk
        * 91-100: Critical Risk

        The scoring mechanism provides a comprehensive risk assessment, considering both the severity and frequency of malicious behaviors.
      scriptName: CommandLineAnalysis
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "66"
    scriptarguments:
      command_line:
        simple: ${Core.OriginalAlert.event.scheduled_task_image_command_line}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1070,
          "y": 1647
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "74":
    id: "74"
    taskid: 48b7171c-7d03-44b2-8e36-6c84e180f9ae
    type: regular
    task:
      id: 48b7171c-7d03-44b2-8e36-6c84e180f9ae
      version: -1
      name: Block malicious external IP
      description: The script blocks a list of IP addresses in supported integrations.
      scriptName: block-external-ip
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      ip_list:
        complex:
          root: IPEnrichment
          filters:
          - - operator: isEqualNumber
              left:
                value:
                  simple: IPEnrichment.TIMScore
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Value
          transformers:
          - operator: uniq
    results:
    - push_job_id
    - commit_job_id
    - panorama_responses
    - executed_brands
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1070,
          "y": 3017
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "75":
    id: "75"
    taskid: 5d58991b-9cec-4412-811f-40e12bc1532e
    type: regular
    task:
      id: 5d58991b-9cec-4412-811f-40e12bc1532e
      version: -1
      name: Add an IOC rule for malicious IP Address
      description: Upload the IOC rules to XSIAM. When the ioc_object is defined, disregard any other provided arguments, as the ioc_object takes precedence. Validate the indicator parameters when ioc_object is used. If `vendor_name`, `vendor_reputation`, and `vendor_reliability` are used, only a single vendor is supported. For multiple vendors, utilize an `ioc_object` in JSON format. Adding a rule with the same indicator, but with different parameters, will update the existing rule.
      script: '|||core-add-indicator-rule'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      comment:
        simple: 'The IOC rule was added by the playbook ''Uncommon remote scheduled task created'' as part of handling alert ID: ${alert.id}'
      expiration_date:
        simple: 4 weeks
      indicator:
        complex:
          root: IPEnrichment
          filters:
          - - operator: isEqualNumber
              left:
                value:
                  simple: IPEnrichment.TIMScore
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Value
      severity:
        simple: MEDIUM
      type:
        simple: IP
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 650,
          "y": 3017
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "76":
    id: "76"
    taskid: da98235d-811e-41b0-be33-1e7907051e39
    type: regular
    task:
      id: da98235d-811e-41b0-be33-1e7907051e39
      version: -1
      name: Check if the remote IP address matches the IPv4 format
      description: Extracts regex data from the provided text. The script support groups and looping.
      scriptName: MatchRegexV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "77"
    scriptarguments:
      contextKey:
        simple: RegexMatchIPv4
      data:
        simple: ${Core.OriginalAlert.event.actor_remote_ip}
      regex:
        simple: \b(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.|$)){4}\b
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": -280
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "77":
    id: "77"
    taskid: 157df2e7-c3c1-4dbf-bbbb-acd8bc0322f3
    type: condition
    task:
      id: 157df2e7-c3c1-4dbf-bbbb-acd8bc0322f3
      version: -1
      name: Does the remote IP address match IPv4?
      description: Validates whether the extracted IP address matches standard IPv4 format.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "79"
      "yes":
      - "68"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: RegexMatchIPv4
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": -130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "79":
    id: "79"
    taskid: 7bd96278-dfa2-499a-9270-a94a84ebb19b
    type: regular
    task:
      id: 7bd96278-dfa2-499a-9270-a94a84ebb19b
      version: -1
      name: Determine whether the remote IPv6 address is internal or external
      description: Extracts regex data from the provided text. The script support groups and looping.
      scriptName: MatchRegexV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      contextKey:
        simple: ExternalIPv6
      data:
        simple: ${Core.OriginalAlert.event.actor_remote_ip}
      regex:
        simple: ^(?:2[0-9a-fA-F]{3}|3[0-9a-fA-F]{3})(?:(?::[0-9a-fA-F]{1,4}){0,7}|(?::[0-9a-fA-F]{0,4}){0,5}::(?:[0-9a-fA-F]{1,4}){0,5})$
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 130,
          "y": 40
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "80":
    id: "80"
    taskid: 4a7ceb58-6102-4610-ae94-123536b2d2bf
    type: regular
    task:
      id: 4a7ceb58-6102-4610-ae94-123536b2d2bf
      version: -1
      name: Get host risk score
      description: Retrieve the risk score of a specific host or list of hosts with the highest risk score in the environment along with the reason affecting each score.
      script: '|||core-list-risky-hosts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "76"
    scriptarguments:
      host_id:
        simple: ${alert.hostname}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": -430
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
tests:
- No tests (auto formatted)
version: -1
view: |-
  {
    "linkLabelsPosition": {
      "14_22_#error#": 0.55,
      "17_13_#default#": 0.42,
      "17_23_yes": 0.69,
      "2_3_Yes": 0.12,
      "32_3_yes": 0.29,
      "66_3_Malicious Cmd parameters": 0.36,
      "66_41_Suspicious parameters": 0.57,
      "70_67_yes": 0.52,
      "72_3_Disable Schedule Task": 0.42,
      "72_43_#default#": 0.53,
      "8_30_#default#": 0.55,
      "8_3_yes": 0.13
    },
    "paper": {
      "dimensions": {
        "height": 4270,
        "width": 2225,
        "x": -355,
        "y": -840
      }
    }
  }
