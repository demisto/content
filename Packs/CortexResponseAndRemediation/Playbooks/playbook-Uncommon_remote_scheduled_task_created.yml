id: Uncommon remote scheduled task created
version: -1
contentitemexportablefields:
  contentitemfields: {}
name: Uncommon remote scheduled task created
description: |-
  This playbook handles "Uncommon remote scheduled task created" alerts.

  Playbook Stages:

  Analysis:

  - The playbook checks if the remote IP is external or has a bad reputation.
  - The playbook checks the host risk score.

  Investigation:
  During the alert investigation, the playbook will perform the following:

  - Searches for related XSIAM alerts on the endpoint that use the following MITRE techniques to identify malicious activity: T1202 - Indirect Command Execution, T1021 - Remote Services.
  - Searches for related XSIAM agent alerts on the remote endpoint, to determine if the creation of the scheduled task is part of an attack pattern.
  - Searches for suspicious command-line parameters indicating a malicious scheduled task.

  Remediation:

  - Automatically disable the malicious scheduled task.
  - Block the malicious IP (requires analyst approval).
  - Automatically Close the alert.
tags:
- TA0002 - Execution
- T1053 - Scheduled Task/Job
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: e27de70b-ada6-422e-81fe-6950a566b050
    type: start
    task:
      id: e27de70b-ada6-422e-81fe-6950a566b050
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "27"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": -840
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 6f7359e7-6ace-48a6-8f72-c30dc8bce825
    type: title
    task:
      id: 6f7359e7-6ace-48a6-8f72-c30dc8bce825
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "47"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 760,
          "y": 520
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: eae7099d-0e36-4442-8d50-a5e79d067791
    type: condition
    task:
      id: eae7099d-0e36-4442-8d50-a5e79d067791
      version: -1
      name: Check whether the remote IP is external
      description: |-
        Determines the appropriate verdict if the task was created from an external IP address.

        Remote scheduled tasks created from an external IP address may indicate unauthorized access or malicious activity. Legitimate remote scheduled tasks should be created from trusted internal sources. If the task is created from an external IP, the playbook will proceed with remediation actions; otherwise, it will continue investigating the alert.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "1"
      "Yes":
      - "3"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: IP.InRange
            iscontext: true
          right:
            value:
              simple: "no"
          ignorecase: true
        - operator: isNotEmpty
          left:
            value:
              simple: ExternalIPv6
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": 350
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: ababf146-0f9f-4621-8323-18c3256738ee
    type: title
    task:
      id: ababf146-0f9f-4621-8323-18c3256738ee
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "14"
      - "17"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": 2510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 287b6585-4340-4fd2-8134-6ee815f90846
    type: condition
    task:
      id: 287b6585-4340-4fd2-8134-6ee815f90846
      version: -1
      name: Found any alerts indicating this is a malicious scheduled task?
      description: Determines whether the alert contains agent alerts indicating that the alert was part of an attack pattern.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "30"
      "yes":
      - "3"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 760,
          "y": 830
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: cbb88a25-3267-48dc-8423-605dbeb295a0
    type: regular
    task:
      id: cbb88a25-3267-48dc-8423-605dbeb295a0
      version: -1
      name: Close Alert - True Positive
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "26"
    scriptarguments:
      closeNotes:
        simple: Malicious scheduled task detected - Handled by the playbook "Uncommon remote scheduled task created"
      closeReason:
        simple: Resolved - True Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": 3220
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: bb3ed083-823b-4e17-8494-16ec6bc49b2a
    type: regular
    task:
      id: bb3ed083-823b-4e17-8494-16ec6bc49b2a
      version: -1
      name: Disable the malicious scheduled task
      description: Run a shell command on a specific endpoint and return its result.
      script: '|||core-execute-command'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "22"
      '#none#':
      - "70"
    scriptarguments:
      command:
        simple: powershell.exe schtasks /change /tn "${Core.OriginalAlert.event.scheduled_task_path}" /disable
      endpoint_ids:
        simple: ${alert.agentid}
      polling_timeout_in_seconds:
        simple: "120"
      timeout:
        simple: "120"
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": 130,
          "y": 2670
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 47529ac8-a0ed-4d35-8019-a8b679181f22
    type: condition
    task:
      id: 47529ac8-a0ed-4d35-8019-a8b679181f22
      version: -1
      name: Is there a malicious IP to block?
      description: Checks whether a malicious IP is detected and requires blocking.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "13"
      "yes":
      - "23"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualNumber
          left:
            value:
              simple: IPEnrichment.TIMScore
            iscontext: true
          right:
            value:
              simple: "3"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 840,
          "y": 2680
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 25929bfd-f6cd-43f9-87cd-8d0c0caf677d
    type: regular
    task:
      id: 25929bfd-f6cd-43f9-87cd-8d0c0caf677d
      version: -1
      name: Disable the malicious scheduled task manually
      description: |-
        Dear Analyst,

        During the remediation process the playbook failed to disable the scheduled task: ${Core.OriginalAlert.event.scheduled_task_path}

        Please manually disable this scheduled task.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -355,
          "y": 3018
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: c5219f31-047d-4cee-888e-f7c63909a296
    type: title
    task:
      id: c5219f31-047d-4cee-888e-f7c63909a296
      version: -1
      name: Block Malicious IP
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "74"
      - "75"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 840,
          "y": 2873
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: ff18f72c-0256-4776-823c-90dd05fdba39
    type: title
    task:
      id: ff18f72c-0256-4776-823c-90dd05fdba39
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": 3730
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: 91b0123e-c227-465b-84d6-a3c53e9a8eb4
    type: regular
    task:
      id: 91b0123e-c227-465b-84d6-a3c53e9a8eb4
      version: -1
      name: Get scheduled task details
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": -705
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: b6d11f6e-a28a-459a-8004-bec570e4b02a
    type: title
    task:
      id: b6d11f6e-a28a-459a-8004-bec570e4b02a
      version: -1
      name: Analysis
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "80"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": -560
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: 6d96992e-fe69-4b71-8e3c-9f64ce6a2aec
    type: title
    task:
      id: 6d96992e-fe69-4b71-8e3c-9f64ce6a2aec
      version: -1
      name: Investigation on remote host
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "31"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 920,
          "y": 1010
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: 58967e13-7736-4385-858d-85a8966dacd3
    type: regular
    task:
      id: 58967e13-7736-4385-858d-85a8966dacd3
      version: -1
      name: Search for related alerts on the remote host
      description: This task searches for XSIAM agent related alerts on the remote endpoint from the past 24 hours, if an agent is installed.
      scriptName: SearchIncidentsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "32"
    scriptarguments:
      fromdate:
        simple: 1 day ago
      ignore-outputs:
        simple: "false"
      query:
        simple: agent_ip_addresses:${Core.OriginalAlert.event.actor_remote_ip}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 920,
          "y": 1145
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: 789cf6e0-eded-4b32-8108-8091409a2537
    type: condition
    task:
      id: 789cf6e0-eded-4b32-8108-8091409a2537
      version: -1
      name: Found any alerts of malicious activity on the remote host?
      description: Determines if there are agent alerts on the remote host indicating that the alert was part of an attack pattern.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "56"
      "yes":
      - "3"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: foundIncidents.sourceBrand
            iscontext: true
          right:
            value:
              simple: TRAPS
          ignorecase: true
      - - operator: isEqualString
          left:
            value:
              simple: foundIncidents.CustomFields.categoryname
            iscontext: true
          right:
            value:
              simple: Malware
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 920,
          "y": 1320
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: 7272972f-d88b-484d-897b-61c0fce7def0
    type: regular
    task:
      id: 7272972f-d88b-484d-897b-61c0fce7def0
      version: -1
      name: Determine whether the remote IPv4 address is internal or external
      description: Returns yes if the IP is in one of the ranges provided, returns no otherwise.
      scriptName: IsIPInRanges
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      ip:
        complex:
          root: Core.OriginalAlert.event.actor_remote_ip
          filters:
          - - operator: notContainsGeneral
              left:
                value:
                  simple: Core.OriginalAlert.event.actor_remote_ip
                iscontext: true
              right:
                value:
                  simple: '::'
              ignorecase: true
      ipRanges:
        complex:
          root: lists
          accessor: PrivateIPs
          transformers:
          - operator: RegexExtractAll
            args:
              error_if_no_match: {}
              ignore_case: {}
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: (\b(?:\d{1,3}\.){3}\d{1,3}\b/\d{1,2})
              unpack_matches: {}
          - operator: join
            args:
              separator:
                value:
                  simple: ','
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 680,
          "y": 190
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: 5ba5e082-b8f3-413f-89f6-40261ef6a811
    type: title
    task:
      id: 5ba5e082-b8f3-413f-89f6-40261ef6a811
      version: -1
      name: Analyst Decision
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "71"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1070,
          "y": 2030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: fb2896f9-3c9e-4e1f-8d40-db749410a130
    type: title
    task:
      id: fb2896f9-3c9e-4e1f-8d40-db749410a130
      version: -1
      name: False Positive
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "44"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1490,
          "y": 2510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: 86404fb8-c406-4ba8-89c3-508c91daaa5b
    type: regular
    task:
      id: 86404fb8-c406-4ba8-89c3-508c91daaa5b
      version: -1
      name: Close Alert - False Positive
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "45"
    scriptarguments:
      closeNotes:
        simple: Resolved as False Positive -Handled as False Positive by the playbook "Uncommon remote scheduled task created"
      closeReason:
        simple: Resolved - False Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1490,
          "y": 2650
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: 2329c33f-d84f-4b85-8a5a-08264d5756ae
    type: title
    task:
      id: 2329c33f-d84f-4b85-8a5a-08264d5756ae
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1490,
          "y": 2803
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: 4373ba97-486c-4617-8298-86a924dc5ca8
    type: regular
    task:
      id: 4373ba97-486c-4617-8298-86a924dc5ca8
      version: -1
      name: Search for related alerts that indicate malicious activity
      description: |+
        This task searches by MITRE technique for suspicious related alerts that may indicate a compromised endpoint.
        Focus on identifying alerts associated with the following MITRE techniques from the last 3 hours:
        - T1202 - Indirect Command Execution
        - T1021 - Remote Services

        And the following alert:
        - "WildFire Malware"

      scriptName: SearchIncidentsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "8"
    scriptarguments:
      fromdate:
        simple: 3 hours ago
      query:
        simple: (name:"*Remote Activity*" or name:"*Malicious Service Creation*" or name:"*Credential Gathering*" or name:"*File Drop*" or name:"*Script Engine Activity*" or name:"*Suspicious Process Creation - *" or name:"*Staged Malware Activity*" or name:"*Powershell Activity - *" or name:"*Process Injection -*" or name:"Local Analysis Malware" or name:"WildFire Malware") and agentid:${alert.agentid}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 760,
          "y": 650
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "56":
    id: "56"
    taskid: 3dca7f38-a58c-4c1c-8a67-e28182e1216a
    type: title
    task:
      id: 3dca7f38-a58c-4c1c-8a67-e28182e1216a
      version: -1
      name: Command-line Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "73"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1070,
          "y": 1510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "66":
    id: "66"
    taskid: f5c5e77b-66e5-465a-8773-c1d20a200bfa
    type: condition
    task:
      id: f5c5e77b-66e5-465a-8773-c1d20a200bfa
      version: -1
      name: Found indication of a suspicious or malicious activity?
      description: Determines the appropriate verdict based on the results of the command-line analysis and the host risk score.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "43"
      Malicious Cmd parameters:
      - "3"
      Suspicious parameters:
      - "41"
    separatecontext: false
    conditions:
    - label: Malicious Cmd parameters
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              simple: CommandLineAnalysis.score
            iscontext: true
          right:
            value:
              simple: "30"
    - label: Suspicious parameters
      condition:
      - - operator: InRange
          left:
            value:
              simple: CommandLineAnalysis.score
            iscontext: true
          right:
            value:
              simple: 10,29
        - operator: isEqualString
          left:
            value:
              simple: Core.RiskyHost.risk_level
            iscontext: true
          right:
            value:
              simple: HIGH
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1070,
          "y": 1800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "67":
    id: "67"
    taskid: e7cb4db3-f70e-4474-8ae5-1ad159731138
    type: regular
    task:
      id: e7cb4db3-f70e-4474-8ae5-1ad159731138
      version: -1
      name: Notify to War Room - Scheduled Task Disabled
      description: Prints text to war room (Markdown supported)
      scriptName: Print
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      value:
        simple: "Dear Analyst,\n\nDuring the remediation process the playbook executed a shell command to disable the following scheduled task: \n${Core.OriginalAlert.event.scheduled_task_path}\n\n"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 130,
          "y": 3018
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "68":
    id: "68"
    taskid: 661be0e9-3bb5-4a3c-8908-4586f05d54e7
    type: regular
    task:
      id: 661be0e9-3bb5-4a3c-8908-4586f05d54e7
      version: -1
      name: Check remote IPv4 reputation
      description: This script gathers ip reputation data from multiple integrations and returns an ip entity with consolidated information to the context.
      scriptName: ip-enrichment
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "38"
    scriptarguments:
      external_enrichment:
        simple: "true"
      ip_list:
        simple: ${Core.OriginalAlert.event.actor_remote_ip}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 680,
          "y": 40
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "70":
    id: "70"
    taskid: 1666967d-c2af-4352-82f0-0d17d99b391f
    type: condition
    task:
      id: 1666967d-c2af-4352-82f0-0d17d99b391f
      version: -1
      name: Has the script disabled the task successfully?
      description: Verify if the script successfully disabled the task.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "22"
      "yes":
      - "67"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: containsString
          left:
            value:
              simple: Core.ScriptResult.results.executed_command.standard_output
            iscontext: true
          right:
            value:
              simple: SUCCESS
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 130,
          "y": 2818
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "71":
    id: "71"
    taskid: 0ae56624-11e4-4420-8245-6b62c02d8a2f
    type: collection
    task:
      id: 0ae56624-11e4-4420-8245-6b62c02d8a2f
      version: -1
      name: Analyst decision for suspicious parameters
      description: Analyst review is required to determine, based on suspicious command-line parameters, whether to take remediation actions  such as disabling the scheduled task and blocking the IP if malicious or to close the alert as a false positive.
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "72"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1070,
          "y": 2180
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
        simple: "Dear Analyst,\n\nSummary of the investigation of the remote scheduled task creation:\n\n- The task was created from an internal IP address: ${Core.OriginalAlert.event.actor_remote_ip}.\n- No related alerts were found indicating malicious activity on the endpoint or remote endpoint.\n- No malicious command line indicators were detected.\n \nHowever, the playbook detected suspicious arguments in the command line. \nThe following command line contains suspicious parameters:\n\n${Core.OriginalAlert.event.scheduled_task_image_command_line}\n\nDecision Needed: \n\nWould you like to proceed with disabling the scheduled task, or should this be considered a false positive?"
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
      replyOptions:
      - Disable Schedule Task
      - False Positive
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: "The following command line contains suspicious parameters:\n\n${Core.OriginalAlert.event.scheduled_task_image_command_line}\n\nWould you like to proceed with disabling the scheduled task, or should this be considered a false positive? "
        required: true
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - {}
        - simple: Disable Schedule Task
        - simple: False Positive
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Analyst Decision to Disable Scheduled Task
      description: "Dear Analyst,\n\nSummary of the investigation of the remote scheduled task creation:\n\n- The task was created from an internal IP address.\n- No related alerts were found indicating malicious activity on the endpoint or remote endpoint.\n- No malicious command line indicators were detected.\n \nHowever, the playbook detected suspicious command-line arguments or a high host risk score.\n\nDecision Needed: "
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "72":
    id: "72"
    taskid: f12ee6de-ec1a-4c0b-872a-7653ef15891c
    type: condition
    task:
      id: f12ee6de-ec1a-4c0b-872a-7653ef15891c
      version: -1
      name: Should disable schedule task based on the analyst decision?
      description: Checks if the scheduled task should be disabled based on the analyst's decision.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "43"
      Disable Schedule Task:
      - "3"
    separatecontext: false
    conditions:
    - label: Disable Schedule Task
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Decision to Disable Scheduled Task.Answers.0
            iscontext: true
          right:
            value:
              simple: Disable Schedule Task
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1070,
          "y": 2340
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "73":
    id: "73"
    taskid: 1fa3388c-d4f4-4fc5-8f9c-226f2500d2f9
    type: regular
    task:
      id: 1fa3388c-d4f4-4fc5-8f9c-226f2500d2f9
      version: -1
      name: Command Line Analysis
      description: |-
        This script evaluates command-line threats by analyzing both original and decoded inputs. It assigns weighted scores to detected patterns, such as AMSI bypass or credential dumping, and applies risk combination bonuses for multiple detections. The total score is normalized to a 0-100 scale, with risk levels categorized as follows:

        * 0-25: Low Risk
        * 26-50: Medium Risk
        * 51-90: High Risk
        * 91-100: Critical Risk

        The scoring mechanism provides a comprehensive risk assessment, considering both the severity and frequency of malicious behaviors.
      scriptName: CommandLineAnalysis
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "66"
    scriptarguments:
      command_line:
        simple: ${Core.OriginalAlert.event.scheduled_task_image_command_line}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1070,
          "y": 1647
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "74":
    id: "74"
    taskid: 48b7171c-7d03-44b2-8e36-6c84e180f9ae
    type: regular
    task:
      id: 48b7171c-7d03-44b2-8e36-6c84e180f9ae
      version: -1
      name: Block malicious external IP
      description: The script blocks a list of IP addresses in supported integrations.
      scriptName: block-external-ip
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      ip_list:
        complex:
          root: IPEnrichment
          filters:
          - - operator: isEqualNumber
              left:
                value:
                  simple: IPEnrichment.TIMScore
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Value
          transformers:
          - operator: uniq
    results:
    - push_job_id
    - commit_job_id
    - panorama_responses
    - executed_brands
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1070,
          "y": 3017
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "75":
    id: "75"
    taskid: 5d58991b-9cec-4412-811f-40e12bc1532e
    type: regular
    task:
      id: 5d58991b-9cec-4412-811f-40e12bc1532e
      version: -1
      name: Add an IOC rule for malicious IP Address
      description: Upload the IOC rules to XSIAM. When the ioc_object is defined, disregard any other provided arguments, as the ioc_object takes precedence. Validate the indicator parameters when ioc_object is used. If `vendor_name`, `vendor_reputation`, and `vendor_reliability` are used, only a single vendor is supported. For multiple vendors, utilize an `ioc_object` in JSON format. Adding a rule with the same indicator, but with different parameters, will update the existing rule.
      script: '|||core-add-indicator-rule'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      comment:
        simple: 'The IOC rule was added by the playbook ''Uncommon remote scheduled task created'' as part of handling alert ID: ${alert.id}'
      expiration_date:
        simple: 4 weeks
      indicator:
        complex:
          root: IPEnrichment
          filters:
          - - operator: isEqualNumber
              left:
                value:
                  simple: IPEnrichment.TIMScore
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Value
      severity:
        simple: MEDIUM
      type:
        simple: IP
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 650,
          "y": 3017
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "76":
    id: "76"
    taskid: da98235d-811e-41b0-be33-1e7907051e39
    type: regular
    task:
      id: da98235d-811e-41b0-be33-1e7907051e39
      version: -1
      name: Check if the remote IP address matches the IPv4 format
      description: Extracts regex data from the provided text. The script support groups and looping.
      scriptName: MatchRegexV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "77"
    scriptarguments:
      contextKey:
        simple: RegexMatchIPv4
      data:
        simple: ${Core.OriginalAlert.event.actor_remote_ip}
      regex:
        simple: \b(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.|$)){4}\b
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": -280
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "77":
    id: "77"
    taskid: 157df2e7-c3c1-4dbf-bbbb-acd8bc0322f3
    type: condition
    task:
      id: 157df2e7-c3c1-4dbf-bbbb-acd8bc0322f3
      version: -1
      name: Does the remote IP address match IPv4?
      description: Validates whether the extracted IP address matches standard IPv4 format.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "79"
      "yes":
      - "68"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: RegexMatchIPv4
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": -130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "79":
    id: "79"
    taskid: 7bd96278-dfa2-499a-9270-a94a84ebb19b
    type: regular
    task:
      id: 7bd96278-dfa2-499a-9270-a94a84ebb19b
      version: -1
      name: Determine whether the remote IPv6 address is internal or external
      description: Extracts regex data from the provided text. The script support groups and looping.
      scriptName: MatchRegexV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      contextKey:
        simple: ExternalIPv6
      data:
        simple: ${Core.OriginalAlert.event.actor_remote_ip}
      regex:
        simple: ^(?:2[0-9a-fA-F]{3}|3[0-9a-fA-F]{3})(?:(?::[0-9a-fA-F]{1,4}){0,7}|(?::[0-9a-fA-F]{0,4}){0,5}::(?:[0-9a-fA-F]{1,4}){0,5})$
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 130,
          "y": 40
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "80":
    id: "80"
    taskid: 4a7ceb58-6102-4610-ae94-123536b2d2bf
    type: regular
    task:
      id: 4a7ceb58-6102-4610-ae94-123536b2d2bf
      version: -1
      name: Get host risk score
      description: Retrieve the risk score of a specific host or list of hosts with the highest risk score in the environment along with the reason affecting each score.
      script: '|||core-list-risky-hosts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "76"
    scriptarguments:
      host_id:
        simple: ${alert.hostname}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 410,
          "y": -430
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "14_22_#error#": 0.55,
      "17_13_#default#": 0.42,
      "17_23_yes": 0.69,
      "2_3_Yes": 0.12,
      "32_3_yes": 0.29,
      "66_3_Malicious Cmd parameters": 0.36,
      "66_41_Suspicious parameters": 0.57,
      "70_67_yes": 0.52,
      "72_3_Disable Schedule Task": 0.42,
      "72_43_#default#": 0.53,
      "8_30_#default#": 0.55,
      "8_3_yes": 0.13
    },
    "paper": {
      "dimensions": {
        "height": 4270,
        "width": 2225,
        "x": -355,
        "y": -840
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.10.0
marketplaces:
- marketplacev2
- platform
