id: silent-Suspicious Hidden User Created Test
version: -1
contentitemexportablefields:
  contentitemfields: {}
name: silent-Suspicious Hidden User Created Test
issilent: true
description: |-
  This playbook addresses the following alerts:

    - Suspicious Hidden User Created

    Playbook Stages:

    Triage:
    - Retrieve event information about the created user

    Investigation:
    - Check whether the user account is local or domain-based.
    - For domain users: Retrieve AD attributes, including password expiration.
    - For local users: Run a Powershell command to get "Password Expires" attribute of the local user.
    - Retrieve the risk level for the affected host.
    - Search for related Script Engine Activity alerts in the incident.
    - Check for suspicious command lines executed on the host.
    - Search for privileged group membership changes.
    - Check for authentication logs of the hidden user.
    - Monitor for suspicious share access or service installations.
    - Search for RDP sessions related to the hidden user.

    Containment:
    - For risky hosts with suspicious users that have non-expiring passwords, perform soft remediation by terminating causality processes.
    - For alerts showing clear malicious behavior patterns, perform hard remediation.
    - For alerts confirmed as true positives, ask the analyst to disable the user.
    - Upon receiving the analyst's approval, disable the suspicious user account (domain or local).
    - If a related alert about malicious activity exists, kill the Causality Group Owner (CGO) process that created the suspicious user.

    Requirements:
    For response actions, you need the following integrations:
    - Cortex Core - Investigation and Response
    - Active Directory Query v2 (for domain user actions)
    - XQL Query Engine (for enhanced investigation)
    - SlackV3 or Microsoft Teams (optional, for user verification).
tags:
- T1136 - Create Account
- 'T1564.002 - Hide Artifacts: Hidden Users'
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 97ee6775-5050-4d39-870d-46792228f237
    type: start
    task:
      id: 97ee6775-5050-4d39-870d-46792228f237
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 454,
          "y": 198
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 5bfcaa1d-7471-407a-96a9-0b8b4e248f0e
    type: regular
    task:
      id: 5bfcaa1d-7471-407a-96a9-0b8b4e248f0e
      version: -1
      name: Get event information
      description: Retrieves extra information about the alert, such as the information from the event itself, the created user name, and additional computed fields.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 454,
          "y": 416
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 32535b44-8fef-4ac0-890c-ac6d3fb8151b
    type: title
    task:
      id: 32535b44-8fef-4ac0-890c-ac6d3fb8151b
      version: -1
      name: Triage
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 454,
          "y": 307
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: a792ac23-6957-4cc7-8959-4eed14717496
    type: regular
    task:
      id: a792ac23-6957-4cc7-8959-4eed14717496
      version: -1
      name: Get host risk level
      description: Gets the risk level of the host on which the user was created.
      script: '|||core-list-risky-hosts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    scriptarguments:
      host_id:
        simple: ${alert.hostname}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 675,
          "y": 788
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: d9e1b1a1-58a8-4fd8-8831-3af6c09458ad
    type: regular
    task:
      id: d9e1b1a1-58a8-4fd8-8831-3af6c09458ad
      version: -1
      name: Search related Script Engine Activity alerts
      description: Searches for Script Engine Activity alerts in the current alert, which could indicate malicious script activity related to the creation of the user.
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "80"
    scriptarguments:
      query:
        complex:
          root: alert
          accessor: parentXDRIncident
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '-'
              fields:
                value:
                  simple: "2"
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'caseid:'
              suffix:
                value:
                  simple: ' and name:"Script Engine Activity*"'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1508,
          "y": 788
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 463c9bad-5655-4595-8dd7-6dd071c8db37
    type: title
    task:
      id: 463c9bad-5655-4595-8dd7-6dd071c8db37
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "9"
      - "16"
      - "18"
      - "39"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 454,
          "y": 536
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 7a43bf64-1e5e-40c5-8de8-f2056eec53da
    type: condition
    task:
      id: 7a43bf64-1e5e-40c5-8de8-f2056eec53da
      version: -1
      name: Check Active Directory availability
      description: Checks if the Active Directory Query v2 integration is enabled.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "9"
      "yes":
      - "7"
    scriptarguments:
      brandname:
        simple: Active Directory Query v2
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 675,
          "y": 919
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: 31f6be0f-ad50-4935-82a6-79e9ffe9d4a3
    type: regular
    task:
      id: 31f6be0f-ad50-4935-82a6-79e9ffe9d4a3
      version: -1
      name: Get AD user attributes
      description: Retrieves information about the domain user, and specifically the DONT_EXPIRE_PASSWORD attribute of the user, in order to understand if the user's password was set to never expire.
      script: '|||ad-get-user'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      username:
        complex:
          root: Core.OriginalAlert.event
          accessor: evtlog_target_username
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 675,
          "y": 1052
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 7ef61ea6-9724-49f0-9e4c-1f635325cc18
    type: condition
    task:
      id: 7ef61ea6-9724-49f0-9e4c-1f635325cc18
      version: -1
      name: Check target user type
      description: Checks whether the user account is a local user or a domain-based user.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "11"
      Domain:
      - "6"
    separatecontext: false
    conditions:
    - label: Domain
      condition:
      - - operator: isFalse
          left:
            value:
              simple: Core.OriginalAlert.event.account_creation_is_local
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1098,
          "y": 788
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: 656a9a1b-38f1-44ee-8574-550c2e2a8534
    type: title
    task:
      id: 656a9a1b-38f1-44ee-8574-550c2e2a8534
      version: -1
      name: Verdict
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "47"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 454,
          "y": 1651
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: da5ae045-1c5a-4a19-8958-7164d5124232
    type: regular
    task:
      id: da5ae045-1c5a-4a19-8958-7164d5124232
      version: -1
      name: Save password expiration status
      description: Saves the value of the AD attribute DONT_EXPIRE_PASSWORD for the domain user that was created.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "76"
    scriptarguments:
      key:
        simple: PasswordNeverExpires
      value:
        complex:
          root: ActiveDirectory.Users.userAccountControlFields
          accessor: DONT_EXPIRE_PASSWORD
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: "false"
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 675,
          "y": 1172
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: 924b282b-f89a-4cfd-b1dd-b6d00a7e4375
    type: regular
    task:
      id: 924b282b-f89a-4cfd-b1dd-b6d00a7e4375
      version: -1
      name: Retrieve local user password status
      description: Runs a Powershell code snipper on the endpoint where the user was created, in order to retrieve the PASSWORDEXPIRES attribute of the local user.
      script: '|||core-run-script-execute-commands'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "27"
    scriptarguments:
      commands:
        complex:
          root: Core.OriginalAlert.event
          accessor: evtlog_target_username
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'powershell -Command "NET USER '
              suffix:
                value:
                  simple: '"'
      endpoint_ids:
        complex:
          root: alert
          accessor: agentid
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1098,
          "y": 919
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: 8a1aabc6-6ecc-4dd8-81cc-d951ab58f367
    type: title
    task:
      id: 8a1aabc6-6ecc-4dd8-81cc-d951ab58f367
      version: -1
      name: User and Host Checks
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "8"
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 675,
          "y": 674
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 2ea075c6-dd59-460f-8c71-929c504a1f17
    type: title
    task:
      id: 2ea075c6-dd59-460f-8c71-929c504a1f17
      version: -1
      name: Related Alert Checks
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "4"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1508,
          "y": 674
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: dc2684fa-4949-48ac-863f-9db3781db6d6
    type: title
    task:
      id: dc2684fa-4949-48ac-863f-9db3781db6d6
      version: -1
      name: Remediation - Disable User
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "30"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 236,
          "y": 3387
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 55e74f8e-8708-486b-a9ae-70a6fb219281
    type: condition
    task:
      id: 55e74f8e-8708-486b-a9ae-70a6fb219281
      version: -1
      name: Risky host & password never expires
      description: Checks if the local/domain user's password never expires, and if the risk level of the host where the alert occurred is HIGH.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "51"
      "yes":
      - "81"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: Core.RiskyHost.risk_level
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: Core.RiskyHost.risk_level
                      iscontext: true
                    right:
                      value:
                        simple: HIGH
            iscontext: true
          right:
            value: {}
      - - operator: isEqualString
          left:
            value:
              simple: PasswordNeverExpires
            iscontext: true
          right:
            value:
              simple: "true"
          ignorecase: true
        - operator: containsString
          left:
            value:
              simple: LocalUserPasswordStatus
            iscontext: true
          right:
            value:
              simple: never
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1025,
          "y": 1879
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: b7012ac9-d143-499c-9f4d-e506aa2f7778
    type: regular
    task:
      id: b7012ac9-d143-499c-9f4d-e506aa2f7778
      version: -1
      name: Close Investigation
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    scriptarguments:
      closeReason:
        simple: Resolved - True Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -68,
          "y": 3911
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: 8f46493b-9a8e-4bea-8e1b-ed62b4d5b868
    type: condition
    task:
      id: 8f46493b-9a8e-4bea-8e1b-ed62b4d5b868
      version: -1
      name: Check user type (Domain/Local)
      description: Checks if the user is a domain user or a local user.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "32"
      Domain:
      - "31"
    separatecontext: false
    conditions:
    - label: Domain
      condition:
      - - operator: isFalse
          left:
            value:
              simple: Core.OriginalAlert.event.account_creation_is_local
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 484,
          "y": 3648
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: 2f400137-551f-421b-81d6-e6efa81133a7
    type: regular
    task:
      id: 2f400137-551f-421b-81d6-e6efa81133a7
      version: -1
      name: Get execution results
      description: Gets the execution results for the Powershell code that was run.
      script: '|||core-get-script-execution-results'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "28"
    scriptarguments:
      action_id:
        simple: ${Core.ScriptRun.action_id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1098,
          "y": 1052
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: c452d4f0-e896-4fde-8b44-be5369a36897
    type: regular
    task:
      id: c452d4f0-e896-4fde-8b44-be5369a36897
      version: -1
      name: Extract password expiration flag
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      key:
        simple: LocalUserPasswordStatus
      value:
        complex:
          root: Core.ScriptResult.results.[0].command_output
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: Core.ScriptResult.results.[0].command_output
                iscontext: true
              right:
                value:
                  simple: Password expires
            - operator: containsGeneral
              left:
                value:
                  simple: Core.ScriptResult.results.[0].command_output
                iscontext: true
              right:
                value:
                  simple: '%%1794'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1098,
          "y": 1286
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: 85e71fec-a160-4cfe-aa82-648feea810b3
    type: condition
    task:
      id: 85e71fec-a160-4cfe-aa82-648feea810b3
      version: -1
      name: Analyst review - disable suspicious user?
      description: "We found suspicious indicators in this investigation. However, the activity could not be verified with the user/s.\nPlease review the findings and decide on the next steps:\n\n### User who created the suspicious hidden user:\n`${Core.OriginalAlert.raw_abioc.event.evtlog_subject_username}`\n\n---\n\n### Involved Host:\n`${alert.hostname}`\n\n---\n\n### Hidden user was added to a privileged group:\n**Group name**: `${HiddenUserAddedToGroup}`\n\n---\n\n### The Suspicious hidden user that created:\n`${Core.OriginalAlert.raw_abioc.event.action_evtlog_data_fields.TargetUserName}`\n\n---\n\n### Related Alerts\nRelated Script Engine Activity alerts found in the incident: `${.=val.foundIncidents && val.foundIncidents.length > 0 ? \"True\" : \"False\"}`\n\n---\n\n### Suspicious Command lines executed on the \n`${.=val.SuspiciousCommandLines || \"N/A\"}`\n\n---\n\n### Login events with the hidden user:\n**Login results number**: `${.=val.HiddenUserLogin || \"N/A\"}`\n\n---\n\n### Hidden user access to share folder/service install\n`${.=val.ShareAccessorServiceInstall || \"N/A\"}`\n\n---\n\n### RDP\n`${.=val.RDPSessionsOnHost || \"N/A\"}`\n\n\n"
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "25"
      "Yes":
      - "26"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 236,
          "y": 3526
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
        complex:
          root: Core.OriginalAlert.event
          accessor: evtlog_target_username
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: |
                    Would you like to disable the following user:
              suffix: {}
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
      replyOptions:
      - "Yes"
      - "No"
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: aa96bfc0-43a9-4c28-88b9-1303cd7acea2
    type: regular
    task:
      id: aa96bfc0-43a9-4c28-88b9-1303cd7acea2
      version: -1
      name: Disable user account in AD
      description: Disables the suspicious user in Active Directory.
      script: '|||ad-disable-account'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "25"
    scriptarguments:
      username:
        simple: ${Core.OriginalAlert.event.evtlog_target_username}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 693,
          "y": 3777
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: f26aaf83-edd5-4842-9c34-6e7b43416b36
    type: regular
    task:
      id: f26aaf83-edd5-4842-9c34-6e7b43416b36
      version: -1
      name: Disable local user
      description: Runs Powershell code on the affected host to disable the local user on the machine.
      script: '|||core-run-script-execute-commands'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "25"
    scriptarguments:
      command_type:
        simple: native
      commands:
        complex:
          root: Core.OriginalAlert.event
          accessor: evtlog_target_username
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: powershell -Command Disable-LocalUser -Name "
              suffix:
                value:
                  simple: '"'
      endpoint_ids:
        complex:
          root: alert
          accessor: agentid
          transformers:
          - operator: uniq
      is_raw_command:
        simple: "true"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 291,
          "y": 3777
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 45cd418b-5a04-4801-8e10-c845f9d1d6ce
    type: regular
    task:
      id: 45cd418b-5a04-4801-8e10-c845f9d1d6ce
      version: -1
      name: Terminate causality (CGO)
      description: Kills the Causality Group Owner (CGO) of the process that created the suspicious user.
      script: '|||core-terminate-causality'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "36"
      '#none#':
      - "25"
      - "51"
    scriptarguments:
      agent_id:
        complex:
          root: foundIncidents
          filters:
          - - operator: in
              left:
                value:
                  simple: foundIncidents.CustomFields.cid
                iscontext: true
              right:
                value:
                  simple: CIDToTerminate
                iscontext: true
          accessor: agentid
      causality_id:
        complex:
          root: CIDToTerminate
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -65,
          "y": 1990
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 501f374a-2fd2-46c9-817b-d7afb8a99087
    type: regular
    task:
      id: 501f374a-2fd2-46c9-817b-d7afb8a99087
      version: -1
      name: Save causality ID
      description: Saves the ID of the Causality Group Owner (CGO) if it exists in the related alerts, in order to terminate it at the remediation stage.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      key:
        simple: CIDToTerminate
      value:
        complex:
          root: foundIncidents.CustomFields
          filters:
          - - operator: isNotEmpty
              left:
                value:
                  simple: foundIncidents.CustomFields.cid
                iscontext: true
          - - operator: isNotEqualString
              left:
                value:
                  simple: foundIncidents.severity
                iscontext: true
              right:
                value:
                  simple: LOW
              ignorecase: true
          - - operator: isNotEqualString
              left:
                value:
                  simple: foundIncidents.CustomFields.action
                iscontext: true
              right:
                value:
                  simple: BLOCKED
              ignorecase: true
          accessor: cid
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1508,
          "y": 1286
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: 2f3e74de-a38c-4d8d-89ad-5ea37d0b919d
    type: regular
    task:
      id: 2f3e74de-a38c-4d8d-89ad-5ea37d0b919d
      version: -1
      name: Terminate causality process manually
      description: Investigate the alerts related to this alert, and terminate the CGO (Causality Group Owner) process that caused the suspicious hidden user to be created.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "25"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -301,
          "y": 2136
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 90453183-1410-493f-86be-7e4098c90e8e
    type: title
    task:
      id: 90453183-1410-493f-86be-7e4098c90e8e
      version: -1
      name: Behavior Checks
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "40"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -161,
          "y": 676
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: 71e84dd9-1af8-49e2-8a44-8df997cb8ed9
    type: condition
    task:
      id: 71e84dd9-1af8-49e2-8a44-8df997cb8ed9
      version: -1
      name: Is the integration of 'XQL Query Engine' available?
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "9"
      "yes":
      - "55"
    scriptarguments:
      brandname:
        simple: XQL Query Engine
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -161,
          "y": 789
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: e12e394e-c166-4d23-8c22-fbc2cdef1286
    type: regular
    task:
      id: e12e394e-c166-4d23-8c22-fbc2cdef1286
      version: -1
      name: Search for the event of a hidden user created
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "9"
      '#none#':
      - "70"
    scriptarguments:
      query:
        simple: "dataset = xdr_data // Using the xdr dataset\n   | filter agent_hostname = \"${alert.hostname}\" \n   | filter event_type = ENUM.PROCESS \n   | filter actor_process_command_line ~= \"net1?\\s+user\\s+\\S+\\$\\s+\\S+\\s+/add\"\n   or actor_process_command_line contains \"New-LocalUser\"\n   or actor_process_command_line ~=  \"SpecialAccounts\\\\UserList\"\n   or actor_process_command_line contains \"TmV3LUxvY2FsVXNlcg==\"\n   or actor_process_command_line contains \"L2FkZA==\"\n| fields actor_process_image_name, actor_process_command_line, actor_process_signature_status, causality_actor_process_image_name,causality_actor_process_os_pid  ,causality_actor_process_signature_status "
      query_name:
        simple: Hidden User Created
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -958,
          "y": 1172
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: 16b323b1-1dbc-49e4-8ed6-510a57d8d0ef
    type: regular
    task:
      id: 16b323b1-1dbc-49e4-8ed6-510a57d8d0ef
      version: -1
      name: Check if the causality process is prevalent
      description: Get the prevalence of a process, identified by process_name.
      script: '|||core-get-process-analytics-prevalence'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      process_name:
        simple: ${PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -958,
          "y": 1513
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: b0da9172-ef2c-411e-8dbf-ea119697852b
    type: regular
    task:
      id: b0da9172-ef2c-411e-8dbf-ea119697852b
      version: -1
      name: Command line analysis
      description: |-
        This script evaluates command-line threats by analyzing both original and decoded inputs. It assigns weighted scores to detected patterns, such as AMSI bypass or credential dumping, and applies risk combination bonuses for multiple detections. The total score is normalized to a 0-100 scale, with risk levels categorized as follows:

        * 0-25: Low Risk
        * 26-50: Medium Risk
        * 51-90: High Risk
        * 91-100: Critical Risk

        The scoring mechanism provides a comprehensive risk assessment, considering both the severity and frequency of malicious behaviors.
      scriptName: CommandLineAnalysis
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "54"
    scriptarguments:
      command_line:
        simple: ${PaloAltoNetworksXQL.GenericQuery.results.command_line}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 239,
          "y": 1402
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: ffc38261-3670-469d-8305-79521159bde0
    type: condition
    task:
      id: ffc38261-3670-469d-8305-79521159bde0
      version: -1
      name: Evaluate suspicious process involvement
      type: condition
      iscommand: false
      brand: ""
      description: "Check if the process that involved in the alert is suspicious"
    nexttasks:
      '#default#':
      - "24"
      "yes":
      - "78"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: 'causality_actor_process_signature_status '
            iscontext: true
          right:
            value:
              simple: UNSIGNED
        - operator: isEqualString
          left:
            value:
              simple: Core.AnalyticsPrevalence.Process.value
            iscontext: true
          right:
            value:
              simple: "False"
      - - operator: isNotEmpty
          left:
            value:
              simple: CIDToTerminate
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 454,
          "y": 1755
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: dfb148ad-ffcd-461a-9375-b89f2533a71e
    type: regular
    task:
      id: dfb148ad-ffcd-461a-9375-b89f2533a71e
      version: -1
      name: Search for privileged group membership
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "9"
      '#none#':
      - "58"
    scriptarguments:
      query:
        simple: "dataset = xdr_data\n| filter event_type = ENUM.EVENT_LOG and action_evtlog_event_id = 4732\n| alter\n    Added_User = regextract(action_evtlog_message, \"Account Name:[\\\\t ]*(.+)\"),\n    Group_Name = regextract(action_evtlog_message, \"Group Name:[\\\\t ]*([^\\r\\n]+)\"),\n    Host_Name = regextract(action_evtlog_message, \"(?i)Subject:\\\\r\\\\n\\\\tSecurity ID:\\\\t\\\\t[^\\\\r\\\\n]+\\\\r\\\\n\\\\tAccount Name:\\\\t\\\\t[^\\\\r\\\\n]+\\\\r\\\\n\\\\tAccount Domain:\\\\t\\\\t([^\\r\\n]+)\")\n| filter Group_Name in (\n    \"\t\tAdministrators\", \n    \"\t\tDomain Admins\",\n    \"       Enterprise Admins\",\n    \"       Remote Desktop Users\", \n    \"       Backup Operators\", \n    \"       Remote Desktop Users\",\n    \"       Power Users\", \n    \"       Account Operators\", \n    \"       Server Operators\", \n    \"       Print Operators\",\n    \"\t\tDevice Owners\") \n        and Added_User contains lowercase(\"${Core.OriginalAlert.raw_abioc.event.action_evtlog_data_fields.TargetUserName}\")\n        and lowercase(agent_hostname) = lowercase(\"${alert.hostname}\")\n| fields action_evtlog_message, Added_User, Group_Name, agent_hostname "
      query_name:
        simple: 'User Added to Privileged Group '
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -161,
          "y": 1172
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "49":
    id: "49"
    taskid: 2d60ca3e-2c49-46c3-985e-bca10833e7ea
    type: regular
    task:
      id: 2d60ca3e-2c49-46c3-985e-bca10833e7ea
      version: -1
      name: 'Search for login events '
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "9"
      '#none#':
      - "60"
    scriptarguments:
      query:
        simple: |-
          preset = xdr_login_events
          | alter dst_identity = login_data_dst_normalized_user -> username,
            identity_type = login_data_dst_normalized_user -> identity_type
          | filter outcome = "SUCCESS"
          | filter lowercase(dst_identity) = lowercase("${Core.OriginalAlert.raw_abioc.event.action_evtlog_data_fields.TargetUserName}")
          | fields dst_identity, identity_type
      query_name:
        simple: Authentication logs for the hidden username
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -558,
          "y": 1174
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "50":
    id: "50"
    taskid: 92ed7869-d2e9-44ba-b96d-255c3cb08266
    type: regular
    task:
      id: 92ed7869-d2e9-44ba-b96d-255c3cb08266
      version: -1
      name: Search for share access/service install
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "9"
      '#none#':
      - "61"
    scriptarguments:
      query:
        simple: |-
          dataset = xdr_data
          | filter event_type = ENUM.EVENT_LOG
            and action_evtlog_event_id in (5140, 7045)
          | alter Host_Name = lowercase(actor_process_image_name)
          | alter Source_Host = coalesce(agent_hostname, actor_process_image_name, action_process_image_name)
          | filter Source_Host = lowercase("${alert.hostname}")
          | fields _time, Source_Host, agent_hostname, action_evtlog_event_id, action_evtlog_message
      query_name:
        simple: Share access or service install
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -161,
          "y": 1402
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "51":
    id: "51"
    taskid: 9708ab11-ddcc-40f3-878e-5c9b86e07d8d
    type: condition
    task:
      id: 9708ab11-ddcc-40f3-878e-5c9b86e07d8d
      version: -1
      name: Evaluate suspicious behavior
      type: condition
      iscommand: false
      brand: ""
      description: "Evaluate suspicious behavior"
    nexttasks:
      '#default#':
      - "89"
      "yes":
      - "79"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: SuspiciousCommandLines
            iscontext: true
          right:
            value: {}
        - operator: isNotEmpty
          left:
            value:
              simple: HiddenUserAddedToGroup
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: HiddenUserLogin
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: ShareAccessorServiceInstall
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: RDPSessionsOnHost
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 594,
          "y": 2122
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "53":
    id: "53"
    taskid: 9ffe65b7-bd9a-4761-a04b-352f57ff922b
    type: regular
    task:
      id: 9ffe65b7-bd9a-4761-a04b-352f57ff922b
      version: -1
      name: Search for suspicious command lines
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "9"
      '#none#':
      - "69"
    scriptarguments:
      query:
        simple: |-
          dataset = xdr_data
          | filter event_type = ENUM.PROCESS
             and lowercase(agent_hostname) = lowercase("${alert.hostname}")
             and lowercase(agent_hostname) = lowercase("${Core.OriginalAlert.raw_abioc.event.action_evtlog_data_fields.SubjectUserName}")
          | filter action_process_image_command_line != null
          and action_process_image_command_line != ""
          | filter action_process_image_command_line !~= "(?i)--set-" // excludes unrelated commands
          | fields
              _time,
              agent_hostname,
              actor_effective_username,
              action_process_image_name,
              action_process_image_command_line
          | comp count() as suspicious_command_count, values(action_process_image_name) as image_name, values(action_process_image_command_line) as command_line
          by actor_effective_username
      query_name:
        simple: Executed Command Lines
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": 239,
          "y": 1172
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "54":
    id: "54"
    taskid: e749931d-3465-4f08-8682-69c841448c6b
    type: regular
    task:
      id: e749931d-3465-4f08-8682-69c841448c6b
      version: -1
      name: Save suspicious command lines
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      key:
        simple: SuspiciousCommandLines
      value:
        complex:
          root: CommandLineAnalysis
          filters:
          - - operator: containsString
              left:
                value:
                  simple: CommandLineAnalysis.risk
                iscontext: true
              right:
                value:
                  simple: High
              ignorecase: true
            - operator: containsString
              left:
                value:
                  simple: CommandLineAnalysis.risk
                iscontext: true
              right:
                value:
                  simple: Critical
              ignorecase: true
          accessor: original_command
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 239,
          "y": 1513
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "55":
    id: "55"
    taskid: 8cf6c76a-4c3e-4c4e-b3f1-a96ac2a8fd9f
    type: regular
    task:
      id: 8cf6c76a-4c3e-4c4e-b3f1-a96ac2a8fd9f
      version: -1
      name: Retrieve start time
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "56"
    scriptarguments:
      key:
        simple: QueryStartTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 5 min ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -161,
          "y": 931
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "56":
    id: "56"
    taskid: 077c7d2c-e17f-4e43-b33d-ba97fc61c437
    type: regular
    task:
      id: 077c7d2c-e17f-4e43-b33d-ba97fc61c437
      version: -1
      name: Retrieve end time
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "48"
      - "53"
      - "49"
      - "43"
    scriptarguments:
      key:
        simple: QueryEndTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 5 min after
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -161,
          "y": 1051
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "58":
    id: "58"
    taskid: 204edf0e-27a2-43f8-8b42-f119cb173394
    type: regular
    task:
      id: 204edf0e-27a2-43f8-8b42-f119cb173394
      version: -1
      name: Save if user added to group
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "50"
    scriptarguments:
      key:
        simple: HiddenUserAddedToGroup
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: 'User Added to Privileged Group '
              ignorecase: true
          - - operator: greaterThan
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.number_of_results
                iscontext: true
              right:
                value:
                  simple: "0"
          accessor: results.Group_Name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -161,
          "y": 1286
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "60":
    id: "60"
    taskid: 5eb951d3-2623-4d81-8d38-a013fe3bc419
    type: regular
    task:
      id: 5eb951d3-2623-4d81-8d38-a013fe3bc419
      version: -1
      name: Save user login
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "62"
    scriptarguments:
      key:
        simple: HiddenUserLogin
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: greaterThan
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.number_of_results
                iscontext: true
              right:
                value:
                  simple: "0"
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Authentication logs for the hidden username
          accessor: number_of_results
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -558,
          "y": 1286
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "61":
    id: "61"
    taskid: aeb6afd4-128e-407f-8739-96a99858cce1
    type: regular
    task:
      id: aeb6afd4-128e-407f-8739-96a99858cce1
      version: -1
      name: Save share access or service install
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      key:
        simple: ShareAccessorServiceInstall
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Share access or service install
              ignorecase: true
          - - operator: isExists
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.results
                iscontext: true
          accessor: query_name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -161,
          "y": 1513
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "62":
    id: "62"
    taskid: 2889ed1b-0fe6-46bb-8579-6e2bcd311e28
    type: regular
    task:
      id: 2889ed1b-0fe6-46bb-8579-6e2bcd311e28
      version: -1
      name: Search for RDP sessions
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "9"
      '#none#':
      - "63"
    scriptarguments:
      query:
        simple: |-
          dataset = xdr_data
          | filter event_type = ENUM.EVENT_LOG and action_evtlog_event_id = 4624
            and Agent_Hostname = "${alert.hostname}"
          | alter User_Name = action_evtlog_data_fields -> TargetUserName
          | alter LogonType = action_evtlog_data_fields -> LogonType
          | filter LogonType = "10" or LogonType = "5"
          | alter User_Name = arrayindex(regextract(action_evtlog_message,"New Logon:\r\n.*\r\n.*?Account Name:.*?(\w.*?)\r\n"),0)
          | filter lowercase(User_Name) = lowercase("${Core.OriginalAlert.raw_abioc.event.action_evtlog_data_fields.TargetUserName}")
          | fields Agent_Hostname, User_Name, action_evtlog_message, LogonType, action_evtlog_data_fields
      query_name:
        simple: RDP sessions
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -558,
          "y": 1402
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "63":
    id: "63"
    taskid: 02236e81-785a-4f5c-8f0e-4e5a9ff6dad3
    type: regular
    task:
      id: 02236e81-785a-4f5c-8f0e-4e5a9ff6dad3
      version: -1
      name: Save RDP sessions
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      key:
        simple: RDPSessionsOnHost
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery.number_of_results
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: RDP sessions
              ignorecase: true
          - - operator: greaterThan
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.number_of_results
                iscontext: true
              right:
                value:
                  simple: "0"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -557,
          "y": 1513
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "64":
    id: "64"
    taskid: bc36f788-ff1d-4315-b604-f1e07023a52a
    type: collection
    task:
      id: bc36f788-ff1d-4315-b604-f1e07023a52a
      version: -1
      name: Confirm alert details with user
      type: collection
      iscommand: false
      brand: ""
      description: "Check with the user "
    nexttasks:
      '#none#':
      - "66"
    separatecontext: false
    sla:
      minutes: 0
      hours: 1
      days: 0
      weeks: 0
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 798,
          "y": 3129
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
        complex:
          root: Slack.User
          accessor: Email
          transformers:
          - operator: uniq
      subject:
      body:
        simple: We've detected suspicious hidden user creation activity involving your user. Your input is needed to verify the details of this alert.
      methods:
      - SlackV3
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 3
        retriesinterval: 15
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: true
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: |-
            ### Alert Details
            Occurred: ${alert.occurred}

            ---

            The user created: ${Core.OriginalAlert.event.evtlog_target_username}

            ---

            To host: ${alert.hostname}

            Did you perform this action?
        required: true
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - {}
        - simple: Yes - it was me
        - simple: No - it was not me
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Suspicious Hidden User Created
      description: |
        We received an alert indicating that your user created a suspicious hidden user.
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "66":
    id: "66"
    taskid: 824dae67-d0bb-444e-ae41-bdbc3f036cbd
    type: condition
    task:
      id: 824dae67-d0bb-444e-ae41-bdbc3f036cbd
      version: -1
      name: Check user reply
      type: condition
      iscommand: false
      brand: ""
      description: "Check user reply"
    nexttasks:
      '#default#':
      - "23"
      False positive:
      - "67"
      True positive:
      - "26"
    separatecontext: false
    conditions:
    - label: False positive
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: Suspicious Hidden User Created.Answers.0
            iscontext: true
          right:
            value:
              simple: "yes"
          ignorecase: true
    - label: True positive
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: Suspicious Hidden User Created.Answers.0
            iscontext: true
          right:
            value:
              simple: "no"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 798,
          "y": 3251
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "67":
    id: "67"
    taskid: 05fe0929-9025-47f5-b62d-865eb140dac3
    type: regular
    task:
      id: 05fe0929-9025-47f5-b62d-865eb140dac3
      version: -1
      name: Close Investigation
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    scriptarguments:
      closeReason:
        simple: Resolved - False Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1025,
          "y": 3623
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "68":
    id: "68"
    taskid: d3d16a54-3f68-438a-8da7-d8152161a093
    type: condition
    task:
      id: d3d16a54-3f68-438a-8da7-d8152161a093
      version: -1
      name: Check if Slack is enabled
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "23"
      "yes":
      - "71"
    scriptarguments:
      brandname:
        simple: SlackV3
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 798,
          "y": 2879
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "69":
    id: "69"
    taskid: 85f0911c-67e7-46f4-8e0a-1f97d9db3e1d
    type: condition
    task:
      id: 85f0911c-67e7-46f4-8e0a-1f97d9db3e1d
      version: -1
      name: Is there any results?
      type: condition
      iscommand: false
      brand: ""
      description: "Check if any results were retrivied."
    nexttasks:
      '#default#':
      - "9"
      "yes":
      - "46"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: PaloAltoNetworksXQL.GenericQuery.results.command_line
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 239,
          "y": 1284
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "70":
    id: "70"
    taskid: a66c21e3-90b6-4f3a-8856-35b91158e8e2
    type: condition
    task:
      id: a66c21e3-90b6-4f3a-8856-35b91158e8e2
      version: -1
      name: Is there any results?
      type: condition
      iscommand: false
      brand: ""
      description: "Check if any results were retrieved"
    nexttasks:
      '#default#':
      - "9"
      "yes":
      - "44"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: PaloAltoNetworksXQL.GenericQuery.results.causality_actor_process_image_name
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -958,
          "y": 1286
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "71":
    id: "71"
    taskid: 4a151ee3-c1d4-457c-81a2-f73ab5992d3b
    type: condition
    task:
      id: 4a151ee3-c1d4-457c-81a2-f73ab5992d3b
      version: -1
      name: Check if emails were retrieved
      type: condition
      iscommand: false
      brand: ""
      description: "Check if emails were retrieved"
    nexttasks:
      '#default#':
      - "23"
      "yes":
      - "64"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: ActiveDirectory.Users.mail
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 798,
          "y": 3005
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "74":
    id: "74"
    taskid: 4e9b280e-5d56-4411-ac7d-c3478c73633c
    type: condition
    task:
      id: 4e9b280e-5d56-4411-ac7d-c3478c73633c
      version: -1
      name: Check if the initiator user is a domain user
      type: condition
      iscommand: false
      brand: ""
      description: "Check if the initiator user is a domain user"
    nexttasks:
      '#default#':
      - "23"
      "yes":
      - "82"
      - "68"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: InitiatorUserType
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1025,
          "y": 2758
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "76":
    id: "76"
    taskid: a8e8b880-668e-493b-862b-f9155e641920
    type: regular
    task:
      id: a8e8b880-668e-493b-862b-f9155e641920
      version: -1
      name: Check initiator user type
      description: Checks whether the user account is a local user or a domain-based user.
      script: '|||ad-get-user'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "77"
    scriptarguments:
      username:
        simple: ${Core.OriginalAlert.raw_abioc.event.action_evtlog_data_fields.SubjectUserName}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 675,
          "y": 1286
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "77":
    id: "77"
    taskid: c54ff0b4-a0bf-4316-bb6f-4ad5d55096e5
    type: regular
    task:
      id: c54ff0b4-a0bf-4316-bb6f-4ad5d55096e5
      version: -1
      name: Save initiator user type
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      key:
        simple: InitiatorUserType
      value:
        complex:
          root: ActiveDirectory.Users.dn
          filters:
          - - operator: isNotEmpty
              left:
                value:
                  simple: ActiveDirectory.Users.dn
                iscontext: true
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 675,
          "y": 1412
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "78":
    id: "78"
    taskid: 5c006e39-3c8a-448e-90ba-a79cd5d440c1
    type: title
    task:
      id: 5c006e39-3c8a-448e-90ba-a79cd5d440c1
      version: -1
      name: Soft Remidiation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "33"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -65,
          "y": 1879
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "79":
    id: "79"
    taskid: 086f5305-39d9-406b-8276-7e7bc0b08fe6
    type: title
    task:
      id: 086f5305-39d9-406b-8276-7e7bc0b08fe6
      version: -1
      name: 'Hard Remidition '
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "23"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 236,
          "y": 2398
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "80":
    id: "80"
    taskid: 436a8747-446a-4aa5-a748-1aa43b085383
    type: regular
    task:
      id: 436a8747-446a-4aa5-a748-1aa43b085383
      version: -1
      name: Save related alerts
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    scriptarguments:
      key:
        simple: RelatedAlerts
      value:
        simple: '${.=val.foundIncidents && val.foundIncidents.id ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1508,
          "y": 919
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "81":
    id: "81"
    taskid: 630c6d71-efc2-42c7-b99f-b0464e0f5ddd
    type: title
    task:
      id: 630c6d71-efc2-42c7-b99f-b0464e0f5ddd
      version: -1
      name: User verification
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "83"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1025,
          "y": 2398
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "82":
    id: "82"
    taskid: e0d000e5-709d-451a-ac6e-61f7c0f3d891
    type: condition
    task:
      id: e0d000e5-709d-451a-ac6e-61f7c0f3d891
      version: -1
      name: Check if MS Teams is enabled
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "23"
      "yes":
      - "85"
    scriptarguments:
      brandname:
        simple: Microsoft Teams
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1242,
          "y": 2879
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "83":
    id: "83"
    taskid: ccfe437c-f414-459a-a6e2-9ca06f0ac384
    type: condition
    task:
      id: ccfe437c-f414-459a-a6e2-9ca06f0ac384
      version: -1
      name: Check Active Directory availability
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "23"
      "yes":
      - "84"
    scriptarguments:
      brandname:
        simple: Active Directory Query v2
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1025,
          "y": 2506
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "84":
    id: "84"
    taskid: e8614a29-d3f1-4158-8160-6cc44a015d1c
    type: regular
    task:
      id: e8614a29-d3f1-4158-8160-6cc44a015d1c
      version: -1
      name: Get user emails from AD
      description: Retrieves detailed information about a user account. The user can be specified by name, email address, or as an Active Directory Distinguished Name (DN). If no filter is specified, all users are returned.
      script: '|||ad-get-user'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "74"
    scriptarguments:
      username:
        simple: ${Core.OriginalAlert.raw_abioc.event.action_evtlog_data_fields.SubjectUserName}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1025,
          "y": 2639
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "85":
    id: "85"
    taskid: efdad9eb-404d-47bc-a9ea-1eeb1416f96b
    type: condition
    task:
      id: efdad9eb-404d-47bc-a9ea-1eeb1416f96b
      version: -1
      name: Check if emails were retrieved
      type: condition
      iscommand: false
      brand: ""
      description: "Check if emails were retrieved"
    nexttasks:
      '#default#':
      - "23"
      "yes":
      - "88"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: ActiveDirectory.Users.mail
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1242,
          "y": 3005
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "87":
    id: "87"
    taskid: 031aaa78-16b9-4c16-a776-4378428e6291
    type: condition
    task:
      id: 031aaa78-16b9-4c16-a776-4378428e6291
      version: -1
      name: Check user reply
      type: condition
      iscommand: false
      brand: ""
      description: "Check user reply"
    nexttasks:
      '#default#':
      - "23"
      False positive:
      - "67"
      True positive:
      - "26"
    separatecontext: false
    conditions:
    - label: False positive
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: Suspicious Hidden User Created.Answers.0
            iscontext: true
          right:
            value:
              simple: "yes"
          ignorecase: true
    - label: True positive
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: Suspicious Hidden User Created.Answers.0
            iscontext: true
          right:
            value:
              simple: "no"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1242,
          "y": 3251
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "88":
    id: "88"
    taskid: 25f78d30-90bb-4594-8b9c-9a1032b1fe8c
    type: collection
    task:
      id: 25f78d30-90bb-4594-8b9c-9a1032b1fe8c
      version: -1
      name: Confirm alert details with user
      type: collection
      iscommand: false
      brand: ""
      description: "Confirm alert details with user"
    nexttasks:
      '#none#':
      - "87"
    separatecontext: false
    sla:
      minutes: 0
      hours: 1
      days: 0
      weeks: 0
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1242,
          "y": 3129
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
        complex:
          root: Slack.User
          accessor: Email
          transformers:
          - operator: uniq
      subject:
      body:
        simple: We've detected suspicious hidden user creation activity involving your user. Your input is needed to verify the details of this alert.
      methods:
      - Microsoft Teams
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 3
        retriesinterval: 15
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: true
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: |-
            ### Alert Details
            Occurred: ${alert.occurred}

            ---

            The user created: ${Core.OriginalAlert.event.evtlog_target_username}

            ---

            To host: ${alert.hostname}

            Did you perform this action?
        required: true
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - {}
        - simple: Yes - it was me
        - simple: No - it was not me
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Suspicious Hidden User Created
      description: |
        We received an alert indicating that your user created a suspicious hidden user.
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "89":
    id: "89"
    taskid: 3e661b86-bb84-428c-8278-cc4d8479a24e
    type: regular
    task:
      id: 3e661b86-bb84-428c-8278-cc4d8479a24e
      version: -1
      name: Close Investigation
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    scriptarguments:
      closeReason:
        simple: Resolved - False Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 814,
          "y": 2251
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "24_51_#default#": 0.5,
      "24_81_yes": 0.26,
      "26_31_Domain": 0.43,
      "26_32_#default#": 0.44,
      "30_25_#default#": 0.32,
      "30_26_Yes": 0.57,
      "33_36_#error#": 0.52,
      "40_55_yes": 0.48,
      "40_9_no": 0.29,
      "43_9_#error#": 0.1,
      "47_24_#default#": 0.49,
      "48_9_#error#": 0.13,
      "49_9_#error#": 0.1,
      "50_9_#error#": 0.17,
      "51_79_yes": 0.43,
      "51_89_#default#": 0.71,
      "53_9_#error#": 0.17,
      "62_9_#error#": 0.11,
      "66_23_#default#": 0.44,
      "66_26_True positive": 0.32,
      "66_67_False positive": 0.51,
      "68_23_no": 0.31,
      "69_9_#default#": 0.33,
      "6_7_yes": 0.51,
      "6_9_#default#": 0.15,
      "70_44_yes": 0.61,
      "70_9_#default#": 0.1,
      "71_23_#default#": 0.42,
      "74_23_#default#": 0.1,
      "74_68_yes": 0.43,
      "74_82_yes": 0.5,
      "82_23_no": 0.19,
      "83_23_no": 0.16,
      "83_84_yes": 0.55,
      "85_23_#default#": 0.13,
      "87_23_#default#": 0.16,
      "87_26_True positive": 0.18,
      "87_67_False positive": 0.53,
      "8_11_#default#": 0.51,
      "8_6_Domain": 0.47
    },
    "paper": {
      "dimensions": {
        "height": 3783,
        "width": 2847,
        "x": -958,
        "y": 198
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 8.9.0
