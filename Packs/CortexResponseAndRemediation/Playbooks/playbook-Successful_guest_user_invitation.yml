id: Successful guest user invitation
version: -1
description: |-
  **This playbook addresses the following alert**:
  - Rare successful guest invitation in the organization

  **Playbook Stages**:

  **Triage**:
  - Gather initial information about the invited user and associated alerts.

  **Investigation**:
  - **Check IOCs Reputation**:
    - Analyze the reputation of IP addresses, email addresses, and domains related to the incident.
  - **Check for Azure Alerts**:
    - Retrieve user Principal Name (UPN).
    - Extract recent Azure security alerts for the inviting user.
  - **Check if User is Risky**:
    - Assess the risk score of the inviting user based on Core and Azure risk indicators.
    - Investigate reasons behind any identified risks, including recent detections.

  **Containment**:
  - Provide a manual task for an analyst to review the findings and decide the next steps.
  - Possible actions:
    - Disable the invited user.
    - Disable the inviting user.
    - Disable both users.
    - Take no action.
  - If users are disabled, revoke their active sessions to ensure immediate containment.

  **Requirements**:
  For the best results, it's recommended to ensure these integrations are configured and working:
  - `Cortex Core - Investigation and Response` for Core user risk evaluation.
  - `Azure Risky Users` for retrieving user risk scores.
  - `Microsoft 365 Defender` for advanced hunting queries and Azure security alerts.
  - `Microsoft Graph User` for disabling accounts and revoking sessions.
tags:
- TA0003 - Persistence
- T1078 - Valid Accounts
name: Successful guest user invitation
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: d395cb57-8e6e-4be4-8ea4-e35bf7698692
    type: start
    task:
      id: d395cb57-8e6e-4be4-8ea4-e35bf7698692
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "25"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -70
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: e6c32126-6a42-4792-84f8-33add6e8a05e
    type: regular
    task:
      id: e6c32126-6a42-4792-84f8-33add6e8a05e
      version: -1
      name: Collect invited user information
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "26"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    reputationcalc: 2
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 190
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: a1763bd9-5867-404f-8384-22d54fe63ed4
    type: regular
    task:
      id: a1763bd9-5867-404f-8384-22d54fe63ed4
      version: -1
      name: Check IP Reputation
      description: Checks the reputation of an IP address.
      script: '|||ip'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "28"
    scriptarguments:
      ip:
        complex:
          root: Core.OriginalAlert.event.raw_log.additionalDetails
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: Core.OriginalAlert.event.raw_log.additionalDetails.key
                iscontext: true
              right:
                value:
                  simple: ipaddr
          accessor: value
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -610,
          "y": 800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: e0039359-d2b9-4ccd-8a4f-6c2042d88fa8
    type: regular
    task:
      id: e0039359-d2b9-4ccd-8a4f-6c2042d88fa8
      version: -1
      name: Check Email Reputation
      description: Return email information and reputation.
      script: '|||email'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      email:
        complex:
          root: Core.OriginalAlert.event
          accessor: azure_ad_invited_user_email
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -190,
          "y": 800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: 10c53f6d-7f53-4bf5-8639-0f04d4045bdf
    type: regular
    task:
      id: 10c53f6d-7f53-4bf5-8639-0f04d4045bdf
      version: -1
      name: Check Domain Reputation
      description: Returns domain information and reputation.
      script: '|||domain'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "23"
    scriptarguments:
      domain:
        complex:
          root: Core.OriginalAlert.event.raw_log.additionalDetails
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: Core.OriginalAlert.event.raw_log.additionalDetails.key
                iscontext: true
              right:
                value:
                  simple: invitedUserEmailAddress
          accessor: value
          transformers:
          - operator: uniq
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '@'
              fields:
                value:
                  simple: "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 230,
          "y": 800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: c795477f-1d39-4f2d-86d7-c8f41049c282
    type: title
    task:
      id: c795477f-1d39-4f2d-86d7-c8f41049c282
      version: -1
      name: Check IOCs Reputation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
      - "3"
      - "4"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -190,
          "y": 490
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 74b4c90b-dd73-40fe-894a-41fd31a2ea26
    type: title
    task:
      id: 74b4c90b-dd73-40fe-894a-41fd31a2ea26
      version: -1
      name: Check If User Is Risky
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "7"
      - "8"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1320,
          "y": 490
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: 9afa3a6b-4c66-4a48-8b54-abd766944c71
    type: regular
    task:
      id: 9afa3a6b-4c66-4a48-8b54-abd766944c71
      version: -1
      name: Get core user risk score
      description: Retrieve the risk score of a specific user or list of users with the highest risk score in the environment along with the reason affecting each score.
      script: '|||core-list-risky-users'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      user_id:
        simple: ${alert.username}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1110,
          "y": 630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 028a7bc3-b0e3-41da-822b-87cc8aaeed88
    type: regular
    task:
      id: 028a7bc3-b0e3-41da-822b-87cc8aaeed88
      version: -1
      name: Get Azure user risk score
      description: Returns a list of all risky users and their properties.
      script: '|||azure-risky-users-list'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "19"
    scriptarguments:
      updated_after:
        simple: 1 days
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1530,
          "y": 630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: ba77d817-81eb-485c-878b-04d0c5e33572
    type: title
    task:
      id: ba77d817-81eb-485c-878b-04d0c5e33572
      version: -1
      name: Check For Azure Alerts
      description: Returns a list of all risky users and their properties.
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": 490
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: f04d72e0-226e-4913-849b-440a51cc1933
    type: regular
    task:
      id: f04d72e0-226e-4913-849b-440a51cc1933
      version: -1
      name: Get Azure alerts
      description: 'Advanced hunting is a threat-hunting tool that uses specially constructed queries to examine the past 30 days of event data in Microsoft 365 Defender. Details on how to write queries: https://docs.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-query-language?view=o365-worldwide.'
      script: '|||microsoft-365-defender-advanced-hunting'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      query:
        simple: let _start = now(-1d); AlertEvidence | where Timestamp >= _start | where AccountUpn == "${UserUPN}"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": 790
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: e6461e8b-95a4-4c50-8e7d-691dbd4ff032
    type: collection
    task:
      id: e6461e8b-95a4-4c50-8e7d-691dbd4ff032
      description: ''
      version: -1
      name: Manual Task - User Account Disablement Decision
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "31"
    scriptarguments:
      key:
        simple: Message
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 1600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: |
            #### Invited User:
            `${Core.OriginalAlert.event.azure_ad_invited_user_email}`

            #### Inviting User:
            `${Core.OriginalAlert.event.identity_invoked_by_name}`

            ---

            ### Malicious Indicators Found:
            - **Malicious IP**: `${.=val.MaliciousIP || "None"}`
            - **Malicious Domain**: `${.=val.MaliciousDomain || "None"}`
            - **Malicious Email**: `${.=val.MaliciousEmail || "None"}`

            ---

            ### Inviting User Risk Analysis:
            - **User is risky (Core)**: `${.=val.UserRiskyCoreReason ? "Yes, Reason: " + val.UserRiskyCoreReason : "N/A"}`
            - **User is risky (Azure)**: `${.=val.UserRiskyAzureDetections ? "Yes, Risk Types: " + val.UserRiskyAzureDetections : "N/A"}`

            ---

            ### Inviting User Azure Security Alerts:
            - **Alerts titles from last day**: `${.=val.AzureSecurityAlerts || "N/A"}`

            ---

            ### Action Required:
            Please choose the action you want to perform.
        required: false
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - simple: No Action
        - simple: Disable Invited User
        - simple: Disable Inviting User
        - simple: Disable Both Users
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Analyst Action
      description: Analyst review
      sender: Your SOC team
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: d05451a6-6c9e-40a4-8498-3655c8540813
    type: regular
    task:
      id: d05451a6-6c9e-40a4-8498-3655c8540813
      version: -1
      name: Get malicious Email value
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR 8 On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      key:
        simple: MaliciousEmail
      value:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: email
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -190,
          "y": 960
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: b6d9862d-d090-4d8b-8e17-55a8ba786a55
    type: condition
    task:
      id: b6d9862d-d090-4d8b-8e17-55a8ba786a55
      version: -1
      name: Get risky user value
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR 8 On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "29"
      HIGH:
      - "18"
    separatecontext: false
    conditions:
    - label: HIGH
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.RiskyUser.risk_level
            iscontext: true
          right:
            value:
              simple: HIGH
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1110,
          "y": 790
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: cfddda6b-e851-4f07-8e6f-8e7c45261acf
    type: regular
    task:
      id: cfddda6b-e851-4f07-8e6f-8e7c45261acf
      version: -1
      name: Get Azure risky user detections
      description: Returns a comma-separated list of the Risk Detection objects and their properties.
      script: '|||azure-risky-users-risk-detections-list'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "20"
    scriptarguments:
      detected_date_time_after:
        simple: ${TimeNow}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1530,
          "y": 1130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 1e118a21-f5b8-4d92-8c86-06046d48a485
    type: regular
    task:
      id: 1e118a21-f5b8-4d92-8c86-06046d48a485
      version: -1
      name: Get risky user reasons value
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR 8 On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      key:
        simple: UserRiskyCoreReason
      value:
        complex:
          root: Core.RiskyUser.reasons
          accessor: description
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1110,
          "y": 970
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: 9426357e-6d8e-42f5-844b-322c7dc76c22
    type: condition
    task:
      id: 9426357e-6d8e-42f5-844b-322c7dc76c22
      description: ''
      version: -1
      name: Check if inviting user is risky
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "29"
      "yes":
      - "24"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: AzureRiskyUsers.RiskyUser.userPrincipalName
                filters:
                - - operator: in
                    left:
                      value:
                        simple: AzureRiskyUsers.RiskyUser.userPrincipalName
                      iscontext: true
                    right:
                      value:
                        simple: Core.OriginalAlert.event.identity_orig.user.userPrincipalName
                      iscontext: true
                transformers:
                - operator: toUpperCase
                - operator: uniq
            iscontext: true
          right:
            value:
              complex:
                root: Core.OriginalAlert.event.identity_orig.user
                accessor: userPrincipalName
                transformers:
                - operator: uniq
            iscontext: true
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1530,
          "y": 790
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: 6c02e6b9-cd98-4865-8412-1c1bf2e0b401
    type: regular
    task:
      id: 6c02e6b9-cd98-4865-8412-1c1bf2e0b401
      version: -1
      name: Extract Azure user detections
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR 8 On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      key:
        simple: UserRiskyAzureDetections
      value:
        complex:
          root: AzureRiskyUsers.RiskDetection
          filters:
          - - operator: in
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.userPrincipalName
                iscontext: true
              right:
                value:
                  simple: Core.OriginalAlert.event.identity_orig.user.userPrincipalName
                iscontext: true
          - - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
                iscontext: true
              right:
                value:
                  simple: atRisk
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
                iscontext: true
              right:
                value:
                  simple: confirmedCompromised
              ignorecase: true
          accessor: riskEventType
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1530,
          "y": 1290
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: a890149a-86f7-4dd2-8c9c-9b8fbb03de03
    type: regular
    task:
      id: a890149a-86f7-4dd2-8c9c-9b8fbb03de03
      version: -1
      name: Extract Azure user alerts
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR 8 On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      key:
        simple: AzureSecurityAlerts
      value:
        complex:
          root: Microsoft365Defender.Hunt.results
          accessor: Title
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": 970
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: d2afb6c7-6bdb-450c-801f-5c051fd4b93a
    type: regular
    task:
      id: d2afb6c7-6bdb-450c-801f-5c051fd4b93a
      version: -1
      name: Get user UPN
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR 8 On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      key:
        simple: UserUPN
      value:
        complex:
          root: Core.OriginalAlert.event
          accessor: identity_invoked_by_name
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": 630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: d29624dd-7417-474c-8a40-d7e5d03463c3
    type: regular
    task:
      id: d29624dd-7417-474c-8a40-d7e5d03463c3
      version: -1
      name: Get malicious Domain value
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR 8 On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      key:
        simple: MaliciousDomain
      value:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: domain
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 230,
          "y": 960
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 0aef3402-3ee9-4560-80ad-8b50f6b202ba
    type: regular
    task:
      id: 0aef3402-3ee9-4560-80ad-8b50f6b202ba
      version: -1
      name: Get timestamp for Azure detections
      description: |
        Retrieves the current date and time.
      scriptName: GetTime
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "16"
    scriptarguments:
      dateFormat:
        simple: ISO
      daysAgo:
        simple: "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1530,
          "y": 970
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: a90a63d9-83a0-4798-8214-cba052dc69ac
    type: title
    task:
      id: a90a63d9-83a0-4798-8214-cba052dc69ac
      version: -1
      name: 'Triage '
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 60
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: 2d6254cd-07ed-4958-8e96-faf1d7fabf2c
    type: title
    task:
      id: 2d6254cd-07ed-4958-8e96-faf1d7fabf2c
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "6"
      - "9"
      - "5"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 350
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: d4e029ba-e082-48f7-8ea8-189f02abdbc9
    type: regular
    task:
      id: d4e029ba-e082-48f7-8ea8-189f02abdbc9
      version: -1
      name: Get malicious IP value
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR 8 On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      key:
        simple: MaliciousIP
      value:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: ip
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -610,
          "y": 960
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 9a373a18-fd7d-4626-8dc9-c783e832f73a
    type: title
    task:
      id: 9a373a18-fd7d-4626-8dc9-c783e832f73a
      version: -1
      name: Containment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "11"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 1460
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: c44a7dd2-2ebd-420b-8e41-1a625c1fcdc6
    type: condition
    task:
      id: c44a7dd2-2ebd-420b-8e41-1a625c1fcdc6
      description: ''
      version: -1
      name: Evaluate Analyst Response for Next Action
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      Disable Both:
      - "36"
      Disable Invited User:
      - "34"
      Disable Inviting User:
      - "35"
      No Action:
      - "32"
    separatecontext: false
    conditions:
    - label: No Action
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: No Action
          ignorecase: true
    - label: Disable Invited User
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: Disable Invited User
          ignorecase: true
    - label: Disable Inviting User
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: Disable Inviting User
          ignorecase: true
    - label: Disable Both
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: Disable Both Users
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 1760
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: 90bcff20-0d45-43cc-8d36-8893827cb927
    type: title
    task:
      id: 90bcff20-0d45-43cc-8d36-8893827cb927
      version: -1
      name: Close Alert
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "33"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 2300
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: a61f329c-9e81-4f34-8e85-4a2c381bdd81
    type: regular
    task:
      id: a61f329c-9e81-4f34-8e85-4a2c381bdd81
      version: -1
      name: Close Alert
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      closeNotes:
        complex:
          root: .
          transformers:
          - operator: If-Elif
            args:
              conditions:
                value:
                  simple: |-
                    [
                        {
                          "condition": "#{Analyst Action.Answers.0} in ['Disable Invited User','Disable Inviting User','Disable Both Users']",
                          "return": "Action was taken."
                        },
                        {
                          "condition": "#{MaliciousIP} != null or #{MaliciousEmail} != null or #{MaliciousDomain} != null or #{AzureSecurityAlerts} != null or #{UserRiskyCoreReason} != null or #{UserRiskyAzureDetections} != null",
                          "return": "Evidence found, but no action was taken."
                        },
                        {
                          "default": "No evidence found, and no action was taken."
                        }
                    ]
              flags: {}
      closeReason:
        complex:
          root: .
          transformers:
          - operator: If-Elif
            args:
              conditions:
                value:
                  simple: |-
                    [
                        {
                          "condition": "#{Analyst Action.Answers.0} in ['Disable Invited User','Disable Inviting User','Disable Both Users']",
                          "return": "Resolved - True Positive"
                        },
                        {
                          "condition": "#{MaliciousIP} != null or #{MaliciousEmail} != null or #{MaliciousDomain} != null or #{AzureSecurityAlerts} != null or #{UserRiskyCoreReason} != null or #{UserRiskyAzureDetections} != null",
                          "return": "Resolved - Other"
                        },
                        {
                          "default": "Resolved - False Positive"
                        }
                    ]
              flags: {}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 2430
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 00f31533-8e09-486f-85ae-627ec0470249
    type: regular
    task:
      id: 00f31533-8e09-486f-85ae-627ec0470249
      version: -1
      name: Disable invited user
      description: |-
        Disables a user from all Office 365 applications, and prevents sign in. Note: This command disables user,
        but does not terminate an existing session. Supported only in a self deployed app flow with the
        Permission: Directory.AccessAsUser.All(Delegated).
      script: '|||msgraph-user-account-disable'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "38"
    scriptarguments:
      user:
        complex:
          root: Core.OriginalAlert.event
          accessor: referenced_resource_name
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 860,
          "y": 1960
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: fc9cf6aa-4caf-4808-8384-24cca2e9811f
    type: regular
    task:
      id: fc9cf6aa-4caf-4808-8384-24cca2e9811f
      version: -1
      name: Disable inviting user
      description: |-
        Disables a user from all Office 365 applications, and prevents sign in. Note: This command disables user,
        but does not terminate an existing session. Supported only in a self deployed app flow with the
        Permission: Directory.AccessAsUser.All(Delegated).
      script: '|||msgraph-user-account-disable'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "38"
    scriptarguments:
      user:
        complex:
          root: Core.OriginalAlert.event
          accessor: identity_name
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 1950
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: 52dfce7a-8d58-44b6-80ef-795bd0557774
    type: regular
    task:
      id: 52dfce7a-8d58-44b6-80ef-795bd0557774
      version: -1
      name: Disable both users
      description: |-
        Disables a user from all Office 365 applications, and prevents sign in. Note: This command disables user,
        but does not terminate an existing session. Supported only in a self deployed app flow with the
        Permission: Directory.AccessAsUser.All(Delegated).
      script: '|||msgraph-user-account-disable'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "38"
    scriptarguments:
      user:
        complex:
          root: Core.OriginalAlert.event
          accessor: identity_name
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: Core.OriginalAlert.event.referenced_resource_name
                iscontext: true
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -40,
          "y": 1960
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: 3d6594cb-2ea9-40c1-8bdb-84184f3a5a24
    type: title
    task:
      id: 3d6594cb-2ea9-40c1-8bdb-84184f3a5a24
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 2590
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: f0e00113-ce6d-4349-8f04-ff8c2f7bb692
    type: regular
    task:
      id: f0e00113-ce6d-4349-8f04-ff8c2f7bb692
      version: -1
      name: Revoke user session
      description: |-
        Revoke a user session- Invalidates all the refresh tokens issued to applications for a user.
        Permission: Directory.AccessAsUser.All(Delegated).
      script: '|||msgraph-user-session-revoke'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "32"
    scriptarguments:
      user:
        complex:
          root: Core.OriginalAlert.event
          accessor: identity_name
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 2130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "15_18_HIGH": 0.43,
      "15_29_#default#": 0.16,
      "19_24_yes": 0.45,
      "19_29_#default#": 0.11,
      "31_32_No Action": 0.55
    },
    "paper": {
      "dimensions": {
        "height": 2725,
        "width": 2520,
        "x": -610,
        "y": -70
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.10.0
