id: silent-Authentication method added to an Azure account
version: -1
contentitemexportablefields:
  contentitemfields: {}
name: silent-Authentication method added to an Azure account
description: |-
  **This playbook addresses the following alert**:
  - Suspicious authentication method addition to Azure account

  **Playbook Stages**:

  **Triage**:
  - Gather initial information about the user.

  **Investigation**:
  - **Check IP Reputation**:
    - Analyze the reputation of the IP address related to the alert.
  - **Check for Azure Alerts**:
    - Extract recent Azure security alerts for the user.
  - **Check if User is Risky**:
    - Assess the risk score of the user based on Core and Azure risk indicators.
    - Investigate reasons behind any identified risks, including recent detections.

  **Containment**:
  - The playbook checks If hard remediation is needed, if yes, it will check if the integration "Microsoft Graph User" is enabled, the playbook will revoke the sessions of the user and provide a manual task for an analyst to review the findings and decide the next steps.
  - Possible actions:
    - Disable the user.
    - Take no action.

  If the integration is not enabled, the playbook will recommend performing the same action but manually.
  - The playbook will check if soft remediation is needed, If yes, continue to revoke user's active sessions to ensure immediate containment.

  **Requirements**:
  For the best results, it's recommended to ensure these integrations are configured and working:
  - `Cortex Core - Investigation and Response` for Core user risk evaluation.
  - `Azure Risky Users` for retrieving user risk scores.
  - `Microsoft 365 Defender` for advanced hunting queries and Azure security alerts.
  - `Microsoft Graph User` is used to disable user and revoke session.
tags:
- T1078 - Valid Accounts
- TA0003 - Persistence
starttaskid: "0"
issilent: true
tasks:
  "0":
    id: "0"
    taskid: 5e4b610f-ffdb-423f-8fe1-c54b8ada2e68
    type: start
    task:
      id: 5e4b610f-ffdb-423f-8fe1-c54b8ada2e68
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 860,
          "y": 680
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 3bc71303-5ccd-4f2f-8761-aeeb4671c954
    type: regular
    task:
      id: 3bc71303-5ccd-4f2f-8761-aeeb4671c954
      version: -1
      name: Get event information
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 860,
          "y": 810
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 969fb1db-b3df-4a51-8489-b1060bebf3fe
    type: regular
    task:
      id: 969fb1db-b3df-4a51-8489-b1060bebf3fe
      version: -1
      name: Check source IP reputation
      description: Checks the reputation of an IP address.
      script: '|||ip'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "38"
    scriptarguments:
      ip:
        complex:
          root: alert.hostip
          accessor: '[0]'
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -150,
          "y": 1260
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: afe3914b-c3ef-4b65-8129-6b0cb5d6e7c0
    type: regular
    task:
      id: afe3914b-c3ef-4b65-8129-6b0cb5d6e7c0
      version: -1
      name: Disable user
      description: |-
        Disables a user from all Office 365 applications, and prevents sign in. Note: This command disables a user,
        but does not terminate an existing session. Supported only in a self-deployed app flow with the
        Permission: Directory.AccessAsUser.All(Delegated).
      script: '|||msgraph-user-account-disable'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      user:
        complex:
          root: Core.OriginalAlert.raw_abioc.event.identity_orig.user
          accessor: userPrincipalName
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1790,
          "y": 2780
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: 39c3a053-64d6-4532-8afb-20cc3d15e6c5
    type: regular
    task:
      id: 39c3a053-64d6-4532-8afb-20cc3d15e6c5
      version: -1
      name: Close alert as True Positive
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      closeNotes:
        simple: ' Handled by the playbook "Authentication method added to an Azure account"'
      closeReason:
        simple: Resolved - True Positive
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1170,
          "y": 2950
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: a7b912f5-66c7-4190-8639-55d1d2860720
    type: title
    task:
      id: a7b912f5-66c7-4190-8639-55d1d2860720
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 860,
          "y": 3120
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: c870efe1-6e26-4239-8283-bd8907b6edd3
    type: title
    task:
      id: c870efe1-6e26-4239-8283-bd8907b6edd3
      version: -1
      name: Investigtion
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "19"
      - "20"
      - "42"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 860,
          "y": 970
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: d76d4f54-48ae-4801-820e-2658711f19c1
    type: regular
    task:
      id: d76d4f54-48ae-4801-820e-2658711f19c1
      version: -1
      name: Get Azure user risk score
      description: Returns a list of all risky users and their properties.
      script: '|||azure-risky-users-list'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      risk_level:
        simple: high
      updated_after:
        simple: 30 day
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1470,
          "y": 1260
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 9031985a-2a22-409b-8121-ad55fcb546c5
    type: regular
    task:
      id: 9031985a-2a22-409b-8121-ad55fcb546c5
      version: -1
      name: 'Get Azure user alerts '
      description: 'Advanced hunting is a threat-hunting tool that uses specially constructed queries to examine the past 30 days of event data in Microsoft 365 Defender. Details on how to write queries: https://docs.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-query-language?view=o365-worldwide.'
      script: '|||microsoft-365-defender-advanced-hunting'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "24"
    scriptarguments:
      query:
        simple: let _start = now(-1d); AlertEvidence | where Timestamp >= _start | where AccountUpn == "${Core.OriginalAlert.raw_abioc.event.identity_invoked_by_name}"
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1070,
          "y": 1260
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 017407a1-bd40-412d-8adb-24682ae82a9f
    type: regular
    task:
      id: 017407a1-bd40-412d-8adb-24682ae82a9f
      version: -1
      name: Get user related alerts
      description: |-
        Searches Demisto alerts. A summarized version of this script is available with the summarizedversion argument.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSIAM/Cortex-XSIAM-Administrator-Guide/Permission-Management
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "32"
    scriptarguments:
      fromdate:
        simple: 5 hours ago
      includeinformational:
        simple: "true"
      query:
        simple: (name:"Azure high-volume data transfer" or name:"An Azure AD login was performed with Device code flow" or name:"Abnormal sign-in followed by suspicious activity in Azure AD" or name:"An Azure identity performed multiple actions that were denied")  and caller_ip:${alert.hostip.[0]} and username:${Core.OriginalAlert.event.identity_normalized.username}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 650,
          "y": 1260
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: 7f0ec57c-0d61-4b37-8086-2f71a31beb9a
    type: regular
    task:
      id: 7f0ec57c-0d61-4b37-8086-2f71a31beb9a
      version: -1
      name: Get core risky user
      description: Retrieve the risk score of a specific user or list of users with the highest risk score in the environment along with the reason affecting each score.
      script: '|||core-list-risky-users'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      user_id:
        simple: ${alert.username}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1870,
          "y": 1260
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 4cc3f182-fae0-4fb5-86ae-2a8b0e5b37fa
    type: regular
    task:
      id: 4cc3f182-fae0-4fb5-86ae-2a8b0e5b37fa
      version: -1
      name: Set risky user
      description: Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      key:
        simple: UserIsRisky
      value:
        simple: "true"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1500,
          "y": 1610
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: d12fe789-b844-48ed-8097-78aa7af90a55
    type: title
    task:
      id: d12fe789-b844-48ed-8097-78aa7af90a55
      version: -1
      name: Check if user is risky
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "13"
      - "16"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1470,
          "y": 1120
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: d8ce9808-3363-48c1-86b5-7b5ca9c883fe
    type: title
    task:
      id: d8ce9808-3363-48c1-86b5-7b5ca9c883fe
      version: -1
      name: Check for related alerts
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "15"
      - "14"
      - "27"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 860,
          "y": 1120
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: 3e571631-0c12-4a50-87a0-4edb5a5988e1
    type: title
    task:
      id: 3e571631-0c12-4a50-87a0-4edb5a5988e1
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "41"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 860,
          "y": 1790
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: c66c150f-2e34-4241-859c-526a18e2912e
    type: condition
    task:
      id: c66c150f-2e34-4241-859c-526a18e2912e
      version: -1
      name: Check user risky
      type: condition
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#default#':
      - "21"
      "yes":
      - "18"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: AzureRiskyUsers
                filters:
                - - operator: in
                    left:
                      value:
                        simple: AzureRiskyUsers.RiskDetection.userPrincipalName
                      iscontext: true
                    right:
                      value:
                        simple: Core.OriginalAlert.event.identity_name
                      iscontext: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: AzureRiskyUsers.RiskDetection.riskState
                      iscontext: true
                    right:
                      value:
                        simple: atRisk
                  - operator: isEqualString
                    left:
                      value:
                        simple: AzureRiskyUsers.RiskDetection.riskState
                      iscontext: true
                    right:
                      value:
                        simple: confirmedCompromised
                accessor: RiskyUser
                transformers:
                - operator: uniq
            iscontext: true
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: Core.RiskyUser.risk_level
            iscontext: true
          right:
            value:
              simple: HIGH
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1870,
          "y": 1440
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 5a9c9cd0-ed9f-4a9b-8702-046799eea7e7
    type: regular
    task:
      id: 5a9c9cd0-ed9f-4a9b-8702-046799eea7e7
      version: -1
      name: Extract Azure user alerts
      description: Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex.x see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      key:
        simple: AzureSecurityAlerts
      value:
        complex:
          root: Microsoft365Defender.Hunt.results
          accessor: Title
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1070,
          "y": 1420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 56edf542-2170-4215-8659-844df93992e1
    type: regular
    task:
      id: 56edf542-2170-4215-8659-844df93992e1
      version: -1
      name: Get user risky detection list
      description: Returns a comma-separated list of the Risk Detection objects and their properties.
      script: '|||azure-risky-users-risk-detections-list'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "26"
    scriptarguments:
      detected_date_time_after:
        simple: ${TimeNow}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 250,
          "y": 1420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: fa26a407-b086-48c3-8eb5-7d306d91c7fe
    type: regular
    task:
      id: fa26a407-b086-48c3-8eb5-7d306d91c7fe
      version: -1
      name: Extract Azure user detections
      description: Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex.x see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      key:
        simple: UserRiskyAzureDetections
      value:
        complex:
          root: AzureRiskyUsers.RiskDetection
          filters:
          - - operator: in
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.userPrincipalName
                iscontext: true
              right:
                value:
                  simple: Core.OriginalAlert.event.identity_orig.user.userPrincipalName
                iscontext: true
          - - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
                iscontext: true
              right:
                value:
                  simple: atRisk
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
                iscontext: true
              right:
                value:
                  simple: confirmedCompromised
              ignorecase: true
          accessor: riskEventType
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 250,
          "y": 1580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: c1105dd3-87ba-458e-8d93-d1a8e60f2c6d
    type: regular
    task:
      id: c1105dd3-87ba-458e-8d93-d1a8e60f2c6d
      version: -1
      name: Get timestamp for Azure detections
      description: |
        Retrieves the current date and time.
      scriptName: GetTime
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "25"
    scriptarguments:
      dateFormat:
        simple: ISO
      daysAgo:
        simple: "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 250,
          "y": 1260
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: c395b4ba-61f8-473a-8d89-ea1b14cb5c3c
    type: regular
    task:
      id: c395b4ba-61f8-473a-8d89-ea1b14cb5c3c
      version: -1
      name: Extract user related alerts
      description: Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      key:
        simple: UserRelatedAlerts
      value:
        complex:
          root: foundIncidents
          accessor: name
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 650,
          "y": 1420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 3a471508-44dd-47d1-82f7-315079933c4b
    type: collection
    task:
      id: 3a471508-44dd-47d1-82f7-315079933c4b
      version: -1
      name: Manual Task - Disable user account decision
      type: collection
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#none#':
      - "35"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1570,
          "y": 2440
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: |-
            #### Resource User:
            - **User Name**: `${Core.OriginalAlert.raw_abioc.event.identity_orig.user.userPrincipalName}`

            ---

            ### Malicious IP Found:
            - **Malicious IP**: `${.=val.MaliciousIP || "None"}`

            ---

            ### User Risk Analysis:
            - **User is risky (Core)**: `${.=val.UserRiskyCoreReason ? "Yes, Reason: " + val.UserRiskyCoreReason : "N/A"}`

            ---

            ### User Azure Security Alerts:
            - **Alerts from last day**: `${.=val.AzureSecurityAlerts || "N/A"}`

            ---

            ### User Related Alerts
            - `${.=val.UserRelatedAlerts || "N/A"}`

            ---

            ### Action Required:
            - We recommend deleting the new authentication method that was added to the user before closing the alert.
            - Please choose the action you want to perform.
        required: false
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - simple: No Action
        - simple: Disable user
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Analyst Action
      description: Analyst review.
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 53e0ccb3-581e-43f1-81d1-4c6cc11d2567
    type: condition
    task:
      id: 53e0ccb3-581e-43f1-81d1-4c6cc11d2567
      version: -1
      name: Evaluate conditions for soft remediation
      type: condition
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#default#':
      - "43"
      "yes":
      - "46"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: CoreRiskyUser
            iscontext: true
          right:
            value: {}
        - operator: isNotEmpty
          left:
            value:
              simple: UserRiskyAzureDetections
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: UserRelatedAlerts
            iscontext: true
        - operator: greaterThanOrEqual
          left:
            value:
              simple: Core.OriginalAlert.raw_abioc.event.features_sum
            iscontext: true
          right:
            value:
              simple: "2"
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "2"
                    ignorecase: true
                accessor: |
                  Indicator
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 370,
          "y": 2100
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: ee052c3b-83d1-4388-8c35-14ece67c5c68
    type: condition
    task:
      id: ee052c3b-83d1-4388-8c35-14ece67c5c68
      version: -1
      name: Evaluate Analyst Response for Next Action
      type: condition
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      Disable user:
      - "8"
      No Action:
      - "9"
    separatecontext: false
    conditions:
    - label: No Action
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: No Action
          ignorecase: true
    - label: Disable user
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: Disable resource user
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1570,
          "y": 2610
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: 3bcedb8d-530d-48fd-87dc-bda42c0f67c8
    type: regular
    task:
      id: 3bcedb8d-530d-48fd-87dc-bda42c0f67c8
      version: -1
      name: Get source IP reputation results
      description: Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      key:
        simple: MaliciousIP
      value:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: ip
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
              ignorecase: true
          accessor: Indicator
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -150,
          "y": 1420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: f0ec862f-1615-4c5a-80c2-c5b55cc983a0
    type: regular
    task:
      id: f0ec862f-1615-4c5a-80c2-c5b55cc983a0
      version: -1
      name: Revoke user session
      description: |-
        Revoke a user session- Invalidates all the refresh tokens issued to applications for a user.
        Permission: Directory.AccessAsUser.All(Delegated).
      script: '|||msgraph-user-session-revoke'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      user:
        complex:
          root: Core.OriginalAlert.raw_abioc.event.identity_orig.user
          accessor: userPrincipalName
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 830,
          "y": 2450
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: d4157383-05f2-4596-8d15-3c2da1357c97
    type: condition
    task:
      id: d4157383-05f2-4596-8d15-3c2da1357c97
      version: -1
      name: Evaluate conditions for hard remediation
      type: condition
      iscommand: false
      brand: ""
      description: ""
    nexttasks:
      '#default#':
      - "34"
      "yes":
      - "44"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: UserRiskyAzureDetections
            iscontext: true
          right:
            value: {}
        - operator: isTrue
          left:
            value:
              simple: UserIsRisky
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: AzureSecurityAlerts
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: MaliciousIP
            iscontext: true
      - - operator: isNotEmpty
          left:
            value:
              simple: UserRelatedAlerts
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 860,
          "y": 1920
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "42":
    id: "42"
    taskid: ddaee487-efa8-4fd2-842d-bbb033a7eddb
    type: title
    task:
      id: ddaee487-efa8-4fd2-842d-bbb033a7eddb
      version: -1
      name: Enrich IP
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -150,
          "y": 1120
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: b0f18feb-2458-4994-8ca3-ef5172a642c3
    type: regular
    task:
      id: b0f18feb-2458-4994-8ca3-ef5172a642c3
      version: -1
      name: Close alert as False Positive
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      closeNotes:
        simple: Handled by the playbook "Authentication method added to an Azure account"
      closeReason:
        simple: Resolved - False Positive
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 370,
          "y": 2950
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: 92393a30-30fe-4653-8bec-7196763539f5
    type: condition
    task:
      id: 92393a30-30fe-4653-8bec-7196763539f5
      version: -1
      name: Check if MSGraph Security integration is enabled
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "48"
      "yes":
      - "47"
    scriptarguments:
      brandname:
        simple: Microsoft Graph User
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1170,
          "y": 2110
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: 9d9faccd-bc23-4ab3-892f-e3ea795d072a
    type: regular
    task:
      id: 9d9faccd-bc23-4ab3-892f-e3ea795d072a
      version: -1
      name: Manual Remediation
      description: "#### Resource User:\n- **User Name**: `${Core.OriginalAlert.raw_abioc.event.identity_orig.user.userPrincipalName}`\n\n---\n\n### Malicious IP Found:\n- **Malicious IP**: `${.=val.MaliciousIP || \"None\"}`\n\n---\n\n### User Risk Analysis:\n- **User is risky (Core)**: `${.=val.UserRiskyCoreReason ? \"Yes, Reason: \" + val.UserRiskyCoreReason : \"N/A\"}`\n\n---\n\n### User Azure Security Alerts:\n- **Alerts from last day**: `${.=val.AzureSecurityAlerts || \"N/A\"}`\n\n---\n\n### User Related Alerts\n- `${.=val.UserRelatedAlerts || \"N/A\"}`\n\n---\n\n### Action Required:\nSince the MSGraph integration is not enabled on this XSIAM tenant, we recommend performing the following steps manually:\n* Revoke the session of both ${Core.OriginalAlert.event.identity_name} \n"
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 590,
          "y": 2780
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: 8901dda6-dbd3-4034-835d-231b4f3a73f8
    type: condition
    task:
      id: 8901dda6-dbd3-4034-835d-231b4f3a73f8
      version: -1
      name: Check if MSGraph Security integration is enabled
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "45"
      "yes":
      - "40"
    scriptarguments:
      brandname:
        simple: Microsoft Graph User
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 590,
          "y": 2280
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: d1c155ec-cad5-4230-876c-d290bf4a704c
    type: regular
    task:
      id: d1c155ec-cad5-4230-876c-d290bf4a704c
      version: -1
      name: Revoke user session
      description: |-
        Revoke a user session- Invalidates all the refresh tokens issued to applications for a user.
        Permission: Directory.AccessAsUser.All(Delegated).
      script: '|||msgraph-user-session-revoke'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      user:
        complex:
          root: Core.OriginalAlert.raw_abioc.event.identity_orig.user
          accessor: userPrincipalName
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1570,
          "y": 2280
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: 20823679-1f44-45e0-80d9-3d7576b4131d
    type: regular
    task:
      id: 20823679-1f44-45e0-80d9-3d7576b4131d
      version: -1
      name: Manual Remediation
      description: "#### Resource User:\n- **User Name**: `${Core.OriginalAlert.raw_abioc.event.identity_orig.user.userPrincipalName}`\n\n---\n\n### Malicious IP Found:\n- **Malicious IP**: `${.=val.MaliciousIP || \"None\"}`\n\n---\n\n### User Risk Analysis:\n- **User is risky (Core)**: `${.=val.UserRiskyCoreReason ? \"Yes, Reason: \" + val.UserRiskyCoreReason : \"N/A\"}`\n\n---\n\n### User Azure Security Alerts:\n- **Alerts from last day**: `${.=val.AzureSecurityAlerts || \"N/A\"}`\n\n---\n\n### User Related Alerts\n- `${.=val.UserRelatedAlerts || \"N/A\"}`\n\n---\n\n### Action Required:\nSince the MSGraph integration is not enabled on this XSIAM tenant, we recommend performing the following steps manually:\n\n- Revoke the session and Disable the following user: ${Core.OriginalAlert.event.identity_name} \n- We recommend deleting the new authentication method that was added to the user before closing the alert.\n"
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1170,
          "y": 2280
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "22_18_yes": 0.43,
      "22_21_#default#": 0.11,
      "34_43_#default#": 0.21,
      "34_46_yes": 0.45,
      "35_8_Disable user": 0.54,
      "35_9_No Action": 0.29,
      "41_34_#default#": 0.3,
      "41_44_yes": 0.31,
      "44_47_yes": 0.5,
      "44_48_no": 0.32,
      "46_40_yes": 0.57,
      "46_45_no": 0.53
    },
    "paper": {
      "dimensions": {
        "height": 2505,
        "width": 2400,
        "x": -150,
        "y": 680
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 8.9.0
