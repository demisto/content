id: silent-External Login Password Spray Test
version: -1
contentitemexportablefields:
  contentitemfields: {}
name: silent-External Login Password Spray Test
description: |-
  This playbook is designed to handle the following alerts:

  - Successful External Login Password Spray
  - External Login Password Spray on a Domain Controller
  - External Login Password Spray Involving a Honey User
  - Successful External Login Password Spray on a Domain Controller
  - Successful External Login Password Spray on a sensitive server

  The playbook is designed to investigate and respond to external login password sprays. It enriches the external IP to enable early containment, retrieves event information, and determines how the attack was carried out and whether it was successful.

  Playbook Stages:

  Early Containment:

  - The playbook automatically blocks malicious external IP addresses involved in the password spray attack via PAN-OS firewall, limiting the attacker's ability to continue their actions.

  Investigation:

  - The playbook analyzes the timestamps of the login attempts to detect patterns and determine if automation was likely used.
  - It checks whether any logons were successful and retrieves the Risk Score for users who successfully logged in as part of the attack.
  - It examines source IP behavior, including prevalence in the organization and history of password spray activity.
  - For successful logins, it proactively queries for any suspicious command-line activity executed by the compromised users.
  - The playbook checks if sensitive or privileged accounts were targeted during the attack.
  - It analyzes login failure reasons to differentiate between various authentication failure types, providing insight into the nature of the attack.

  Containment:

  - Based on the investigation findings, the playbook offers various remediation options:
    - Soft Remediation: Terminate active RDP sessions for affected users to limit ongoing access.
    - Hard Remediation: For confirmed compromises, the playbook can disable user accounts in Active Directory and local systems.
    - Manual Remediation: For cases requiring human decision, the playbook presents evidence and allows SOC analysts to choose appropriate actions.
  - When possible, the playbook contacts affected users via Slack to verify if the activity was legitimate.

  Requirements:

  - For some response actions, the following integrations are required: Active Directory (AD), PAN-OS, Core - IR.
  - For user verification, the SlackV3 integration is required.
tags:
- T1110.003 - Password Spraying
- T1110 - Brute Force
- TA0006 - Credential Access
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 5b3b36a9-54de-46e5-8d25-977a87925b85
    type: start
    task:
      id: 5b3b36a9-54de-46e5-8d25-977a87925b85
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "45"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -330
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: 6e912ef2-7231-44f6-a765-95945a0a7f67
    type: condition
    task:
      id: 6e912ef2-7231-44f6-a765-95945a0a7f67
      version: -1
      name: Any risky users to remediate?
      description: "Checks whether hard remediation should be performed. \n\nTo perform hard remediation, all of the following conditions have to be met:\n\n1. At least one user logged in successfully.\n2. At least one of the logged in users has a High risk level (available with ITDR license).\n3. The interval analysis suggests automation was used OR the failed logon attempts exceeded the baseline for the host.\n4. The alert severity is Medium or above."
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      "Yes":
      - "41"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: RiskyLogonUsernames
            iscontext: true
          right:
            value: {}
      - - operator: isTrue
          left:
            value:
              simple: IntervalAnalysis.IsPatternLikelyAutomated
            iscontext: true
        - operator: isTrue
          left:
            value:
              simple: Core.OriginalAlert.stateful_raw_data.is_count_failed_users_above_baseline
            iscontext: true
        - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidence
                transformers:
                - operator: DT
                  args:
                    dt:
                      value:
                        simple: .=Object.values(val).filter(value => value == "True").length
            iscontext: true
          right:
            value:
              simple: "3"
      - - operator: greaterThanOrEqual
          left:
            value:
              simple: alert.severity
            iscontext: true
          right:
            value:
              simple: "2"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 106,
          "y": 5086
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 62b00df4-6f8c-42de-8a7c-b1b8bd3c6687
    type: regular
    task:
      id: 62b00df4-6f8c-42de-8a7c-b1b8bd3c6687
      version: -1
      name: Analyze intervals of login attempts
      description: Analyze a list of Unix timestamps in milliseconds, to detect simple patterns of consistency or high frequency. The script can aid in the investigation of multi-event alerts that contain a list of timestamps.
      scriptName: AnalyzeTimestampIntervals
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "50"
    scriptarguments:
      timestamps:
        simple: ${Core.OriginalAlert._all_events.event_timestamp}
      verbose:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 90,
          "y": 832
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: f09ca1e7-0b34-4375-9a26-6868f1c19f40
    type: regular
    task:
      id: f09ca1e7-0b34-4375-9a26-6868f1c19f40
      version: -1
      name: Save users who logged in successfully
      description: Saves the users who logged in successfully in a new context key.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: SuccessfulLoginUsernames
      value:
        complex:
          root: Core.OriginalAlert._all_events
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: Core.OriginalAlert._all_events.outcome
                iscontext: true
              right:
                value:
                  simple: SUCCESS
              ignorecase: true
          accessor: dst_identity
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 449
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: Affected Users
      output:
        complex:
          root: |2-

            Core.OriginalAlert._all_events
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: |2-

                    Core.OriginalAlert._all_events.outcome
                iscontext: true
              right:
                value:
                  simple: SUCCESS
              ignorecase: true
          accessor: dst_identity
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 72c11bd8-4417-47ad-8699-8f1118551c42
    type: condition
    task:
      id: 72c11bd8-4417-47ad-8699-8f1118551c42
      version: -1
      name: Check for any successful login
      description: Checks whether any logon attempt was successful.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "50"
      "Yes":
      - "28"
      - "59"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: SuccessfulLoginUsernames
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 666,
          "y": 841
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 06d72149-b58b-4a87-b787-7968729575df
    type: regular
    task:
      id: 06d72149-b58b-4a87-b787-7968729575df
      version: -1
      name: Get logon event information
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 322
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: f7b61352-1377-4bf8-8cd1-bb769476a36e
    type: title
    task:
      id: f7b61352-1377-4bf8-8cd1-bb769476a36e
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "95"
      - "96"
      - "97"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: fcc95117-cf0a-4dfa-8c1c-4686e81b49fe
    type: title
    task:
      id: fcc95117-cf0a-4dfa-8c1c-4686e81b49fe
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "10"
      - "131"
      - "154"
      - "142"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1038,
          "y": 4940
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: 43bc9013-8020-4de9-8208-394c78020139
    type: regular
    task:
      id: 43bc9013-8020-4de9-8208-394c78020139
      version: -1
      name: Get user risk score of logged in users
      description: Gets the risk score of the users that successfully logged in.
      script: '|||core-list-risky-users'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "31"
    scriptarguments:
      user_id:
        complex:
          root: SuccessfulLoginUsernames
          transformers:
          - operator: join
            args:
              separator:
                value:
                  simple: ','
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: \
              toReplace:
                value:
                  simple: \\
          - operator: split
            args:
              delimiter:
                value:
                  simple: ','
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 666,
          "y": 980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: ea7a6e5f-d8a8-4eda-a5e7-1a216c8b29f1
    type: regular
    task:
      id: ea7a6e5f-d8a8-4eda-a5e7-1a216c8b29f1
      version: -1
      name: Save risky users that logged in (if exist)
      description: Saves a separate list of users who successfully logged on as part of the attack, and were found risky.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "171"
    scriptarguments:
      key:
        simple: RiskyLogonUsernames
      value:
        complex:
          root: Core.RiskyUser
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: Core.RiskyUser.risk_level
                iscontext: true
              right:
                value:
                  simple: HIGH
          accessor: id
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 666,
          "y": 1096
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 77cb92f8-37de-4391-9072-91e1c57ece0d
    type: regular
    task:
      id: 77cb92f8-37de-4391-9072-91e1c57ece0d
      version: -1
      name: Close alert
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    scriptarguments:
      closeReason:
        complex:
          root: CloseReason
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: Resolved - False Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1038,
          "y": 5911
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: 8621bbad-97f5-43c5-8cf8-e876a8d3b86b
    type: title
    task:
      id: 8621bbad-97f5-43c5-8cf8-e876a8d3b86b
      version: -1
      name: Risky User Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "81"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 106,
          "y": 5242
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: e678030d-5c8d-4724-812e-98a36e8fbb80
    type: regular
    task:
      id: e678030d-5c8d-4724-812e-98a36e8fbb80
      version: -1
      name: Check source IP reputation
      description: Enriches the external source IP of the attack to check if it's known as malicious. Skips on errors for cases where the IP address or the !ip command is empty.
      script: '|||ip'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "46"
    scriptarguments:
      ip:
        simple: ${alert.localip}
    reputationcalc: 2
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -172
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: a1924082-41b3-47f8-8766-d268b29a9658
    type: condition
    task:
      id: a1924082-41b3-47f8-8766-d268b29a9658
      version: -1
      name: Is the IP malicious?
      description: Checks if the external Source IP is malicious (DBotScore above 2).
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "15"
      "Yes":
      - "47"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                - - operator: greaterThan
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "2"
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: alert.localip.[0]
                      iscontext: true
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -49
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: 2ef06d13-aafd-4c49-8ad7-9a310e53e5bd
    type: title
    task:
      id: 2ef06d13-aafd-4c49-8ad7-9a310e53e5bd
      version: -1
      name: Early Containment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "84"
      - "15"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 199,
          "y": 92
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "50":
    id: "50"
    taskid: 71ceef0a-d7f9-46fc-a0f6-ebb78038f8ef
    type: condition
    task:
      id: 71ceef0a-d7f9-46fc-a0f6-ebb78038f8ef
      version: -1
      name: Analyze evidence
      description: "Checks whether soft remediation should be performed. \n\nTo perform soft remediation, all of the following conditions have to be met:\n\n1. At least one user logged in successfully.\n2. The interval analysis suggests automation was used OR the failed logon attempts exceeded the baseline for the host.\n"
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "99"
      - "108"
      - "110"
      - "168"
      True Positive:
      - "166"
    separatecontext: false
    conditions:
    - label: True Positive
      condition:
      - - operator: isTrue
          left:
            value:
              simple: IntervalAnalysis.IsPatternLikelyAutomated
            iscontext: true
          right:
            value: {}
        - operator: isTrue
          left:
            value:
              simple: Core.OriginalAlert.stateful_raw_data.is_count_failed_users_above_baseline
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1385
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "59":
    id: "59"
    taskid: df38478e-ae21-469c-8454-bd65afc04aeb
    type: regular
    task:
      id: df38478e-ae21-469c-8454-bd65afc04aeb
      version: -1
      name: Prepare list of usernames for soft remediation
      description: Saves a general list of all the users that will require soft remediation. Specific types of remediation may need the names to appear in different structures or syntax.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "50"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: UsersToDisconnect
      value:
        complex:
          root: SuccessfulLoginUsernames
          transformers:
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: \
              toReplace:
                value:
                  simple: \\
          - operator: concat
            args:
              prefix:
                value:
                  simple: ''''
              suffix:
                value:
                  simple: ''''
          - operator: join
            args:
              separator:
                value:
                  simple: ','
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1076,
          "y": 980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "63":
    id: "63"
    taskid: 4b7750d2-d870-4dec-a91d-0d7bd273c5a4
    type: condition
    task:
      id: 4b7750d2-d870-4dec-a91d-0d7bd273c5a4
      version: -1
      name: Check host operating system
      description: Checks if the operating system reported by the agent of the machine to which the users logged in is Windows or another OS.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      Windows:
      - "65"
    separatecontext: false
    conditions:
    - label: Windows
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: alert
                accessor: hostos
                transformers:
                - operator: uniq
                - operator: FirstArrayElement
            iscontext: true
          right:
            value:
              simple: AGENT_OS_WINDOWS
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 540,
          "y": 5204
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "65":
    id: "65"
    taskid: b6911013-8c0a-458c-8c31-77e98216dd96
    type: condition
    task:
      id: b6911013-8c0a-458c-8c31-77e98216dd96
      version: -1
      name: Which logon type was used?
      description: Checks the logon type (E.g., Network, RemoteInteractive, etc) used in the attack.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      RemoteInteractive:
      - "73"
    separatecontext: false
    conditions:
    - label: RemoteInteractive
      condition:
      - - operator: containsGeneral
          left:
            value:
              complex:
                root: Core.OriginalAlert._all_events.login_data
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: Core.OriginalAlert._all_events.login_data.outcome
                      iscontext: true
                    right:
                      value:
                        simple: SUCCESS
                    ignorecase: true
                accessor: type
                transformers:
                - operator: uniq
            iscontext: true
          right:
            value:
              simple: RemoteInteractive
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 540,
          "y": 5351
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "67":
    id: "67"
    taskid: 868e45e4-7156-42ff-8e69-98cdd60d2a07
    type: regular
    task:
      id: 868e45e4-7156-42ff-8e69-98cdd60d2a07
      version: -1
      name: Terminate RDP Session
      description: Initiates a shell command that runs a Powershell script. The script checks for active user sessions and terminates them in order to logoff offending users during interactive sessions.
      script: '|||core-run-script-execute-commands'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      commands:
        complex:
          root: RDPLogoffUsers
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: powershell -Command "$users = @(
              suffix:
                value:
                  simple: ) -split ';'; query user | Select-Object -Skip 1 | ForEach-Object { $sessionInfo = $_ -split '\s+' | Where-Object { $_ -ne '' -and $_ -notlike 'Disc' }; if ($sessionInfo.Length -ge 6) { $username = $sessionInfo[0].TrimStart('>'); $sessionId = $sessionInfo[2]; if ($users -contains $username) { logoff $sessionId } } }"
      endpoint_ids:
        simple: ${alert.agentid}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 540,
          "y": 5598
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "73":
    id: "73"
    taskid: cc623958-b2a1-46ba-892e-c9e8988f72a1
    type: regular
    task:
      id: cc623958-b2a1-46ba-892e-c9e8988f72a1
      version: -1
      name: Prepare list of users for RDP session termination
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "67"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: RDPLogoffUsers
      value:
        complex:
          root: SuccessfulLoginUsernames
          transformers:
          - operator: RegexExtractAll
            args:
              error_if_no_match: {}
              ignore_case: {}
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: (?:\\+)(.*)
              unpack_matches: {}
          - operator: join
            args:
              separator:
                value:
                  simple: ;
          - operator: concat
            args:
              prefix:
                value:
                  simple: ''''
              suffix:
                value:
                  simple: ''''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 540,
          "y": 5476
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "81":
    id: "81"
    taskid: 1a4db1bf-2951-49ce-8054-2dbf6ef1be99
    type: collection
    task:
      id: 1a4db1bf-2951-49ce-8054-2dbf6ef1be99
      version: -1
      name: Choose risky users for password expiration
      description: Asks the analyst to choose users whose passwords will be expired.
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "83"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 106,
          "y": 5371
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: Choose the risky users whose passwords will be expired.
        required: false
        gridcolumns: []
        defaultrows: []
        type: multiSelect
        options: []
        optionsarg:
        - complex:
            root: RiskyLogonUsernames
            transformers:
            - operator: uniq
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Password Expiration - Risky Users
      description: Decide whether the password should be expired for users who have successfully logged in.
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "82":
    id: "82"
    taskid: fe2e0381-5631-4733-8e7c-4568bd50d8df
    type: regular
    task:
      id: fe2e0381-5631-4733-8e7c-4568bd50d8df
      version: -1
      name: Expire the user passwords
      description: Expires the passwords of the selected risky users.
      script: '|||ad-expire-password'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      username:
        complex:
          root: Password Expiration - Risky Users.Answers
          accessor: "0"
          transformers:
          - operator: RegexExtractAll
            args:
              error_if_no_match: {}
              ignore_case: {}
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: (?:.*\\)?(.*)
              unpack_matches: {}
          - operator: RemoveEmpty
            args:
              empty_values: {}
              remove_keys:
                value:
                  simple: "true"
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 106,
          "y": 5656
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "83":
    id: "83"
    taskid: 1ee77baf-bb82-443f-8104-a41f7c68fade
    type: condition
    task:
      id: 1ee77baf-bb82-443f-8104-a41f7c68fade
      version: -1
      name: Was any user selected?
      description: Checks whether any user was selected for password expiration.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      "yes":
      - "82"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: Password Expiration - Risky Users.Answers
                accessor: "0"
                transformers:
                - operator: uniq
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 106,
          "y": 5508
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "84":
    id: "84"
    taskid: 7796a846-df10-4734-8974-d253ae9a6db3
    type: playbook
    task:
      id: 7796a846-df10-4734-8974-d253ae9a6db3
      version: -1
      name: PAN-OS - Block IP
      description: |-
        This playbook blocks IP addresses with 2 optional actions:

        - Block IP addresses using Static Address Groups in Palo Alto Networks Panorama or Firewall. The playbook receives malicious IP addresses and an address group name as inputs, verifies that the addresses are not already a part of the address group, adds them and commits the configuration.


        - Utilize the Dynamic Address Group (DAG) capability of PAN-OS. DAG enables analysts to create a rule one time, where the group is the source/destination, and adds IP addresses dynamically without the need to commit the configuration every time.
        The playbook checks if the given tag already exists. If the tag exists, then the IP address is added to the tag.
        If the tag does not exist, a new address group is created with the given tag and a matching rule, and the configuration is committed.
      playbookName: PAN-OS - Block IP
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "86"
    scriptarguments:
      MaliciousIPs:
        complex:
          root: alert
          accessor: localip
          transformers:
          - operator: uniq
          - operator: FirstArrayElement
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 199,
          "y": 210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "86":
    id: "86"
    taskid: b60ffcc8-827d-4c93-897f-5811dd2aff58
    type: title
    task:
      id: b60ffcc8-827d-4c93-897f-5811dd2aff58
      version: -1
      name: Continue
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "33"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -455,
          "y": 5651
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "87":
    id: "87"
    taskid: ed457c99-62a9-4818-a00a-891db6d272ad
    type: regular
    task:
      id: ed457c99-62a9-4818-a00a-891db6d272ad
      version: -1
      name: Analyze failed login history for IP
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "106"
      '#none#':
      - "125"
    scriptarguments:
      interval_in_seconds:
        simple: "8"
      max_fields:
        simple: "100"
      query:
        simple: "preset = xdr_login_events\n| filter outcome != \"SUCCESS\"\n    and action_local_ip = \"${alert.localip.[0]}\"\n    and login_data_dst_normalized_user -> identity_type not in (\"machine\", \"builtin\", \"virtual\")\n| alter \n    src_ip = action_local_ip,\n    dst_identity = login_data_dst_normalized_user -> identity,\n    bin_time = _time\n| fields src_ip, dst_identity, bin_time\n| bin bin_time span = 10m\n| comp count() as failed_attempts, count_distinct(dst_identity) as targeted_users by src_ip, bin_time\n| filter failed_attempts >= 15 and targeted_users >= 10\n| comp count() as past_spray_count by src_ip\n"
      query_name:
        simple: Find short bursts of failed user logins from source IP
      time_frame:
        simple: between ${IPQueryStartTime} and ${IPQueryEndTime}
      timeout_in_seconds:
        simple: "200"
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": 721,
          "y": 2266
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "89":
    id: "89"
    taskid: 1398385d-b068-4568-ba61-b60ca33c7610
    type: regular
    task:
      id: 1398385d-b068-4568-ba61-b60ca33c7610
      version: -1
      name: Set query start time
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "90"
    scriptarguments:
      key:
        simple: IPQueryStartTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 7 days ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 721,
          "y": 1748
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "90":
    id: "90"
    taskid: d3de6f55-e6bd-47d7-a0be-7a85f198fd79
    type: regular
    task:
      id: d3de6f55-e6bd-47d7-a0be-7a85f198fd79
      version: -1
      name: Set query end time
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "87"
    scriptarguments:
      key:
        simple: IPQueryEndTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 10 min ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 721,
          "y": 1881
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "95":
    id: "95"
    taskid: 7121d01a-c3fc-47ee-9495-8905aa2c4e41
    type: title
    task:
      id: 7121d01a-c3fc-47ee-9495-8905aa2c4e41
      version: -1
      name: Risky Users
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "14"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 666,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "96":
    id: "96"
    taskid: 4452ef81-fa85-41bf-b109-b5fe64293ced
    type: title
    task:
      id: 4452ef81-fa85-41bf-b109-b5fe64293ced
      version: -1
      name: Timestamp Analysis
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "12"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 90,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "97":
    id: "97"
    taskid: 450f0aa2-a2d4-4d3a-808f-e90b95feb7e7
    type: title
    task:
      id: 450f0aa2-a2d4-4d3a-808f-e90b95feb7e7
      version: -1
      name: Related Alerts
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "98"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1506,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "98":
    id: "98"
    taskid: eccfcbb4-ff7a-43c6-9e91-ae945a818165
    type: regular
    task:
      id: eccfcbb4-ff7a-43c6-9e91-ae945a818165
      version: -1
      name: Search case for brute-force alerts
      description: Searches for Script Engine Activity alerts in the current alert, which could indicate malicious script activity related to the creation of the user.
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "50"
      - "167"
    scriptarguments:
      query:
        complex:
          root: alert
          accessor: parentXDRIncident
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '-'
              fields:
                value:
                  simple: "2"
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'caseid:'
              suffix:
                value:
                  simple: ' and name:"Possible Brute-Force attempt with a successful login and suspicious characteristics"'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1506,
          "y": 841
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "99":
    id: "99"
    taskid: 720e6a1e-da76-42c1-a99c-e4493a32ef6d
    type: title
    task:
      id: 720e6a1e-da76-42c1-a99c-e4493a32ef6d
      version: -1
      name: Behavior Analysis
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "105"
      - "100"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 957,
          "y": 1506
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "100":
    id: "100"
    taskid: 32d8f4ff-2274-4afa-8b44-4c3137f40f1a
    type: title
    task:
      id: 32d8f4ff-2274-4afa-8b44-4c3137f40f1a
      version: -1
      name: Source IP Behavior
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "89"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 721,
          "y": 1632
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "101":
    id: "101"
    taskid: d6135a92-6c6e-429c-ac59-7cb76312d58f
    type: regular
    task:
      id: d6135a92-6c6e-429c-ac59-7cb76312d58f
      version: -1
      name: Get post login user activity
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "106"
      '#none#':
      - "104"
    scriptarguments:
      interval_in_seconds:
        simple: "8"
      max_fields:
        simple: "100"
      query:
        simple: |-
          dataset = xdr_data
          | filter event_type = ENUM.PROCESS
              and lowercase(actor_effective_username) in (${SuccessfulLoginUsernamesQuery})
              and lowercase(agent_hostname) = lowercase("${alert.hostname}")
          | filter action_process_image_command_line != null
          | dedup actor_effective_username, action_process_image_command_line
          | fields
              _time,
              agent_hostname,
              actor_effective_username,
              action_process_image_command_line
      query_name:
        simple: Get post login user activity commands
      time_frame:
        simple: between ${CmdQueryStartTime} and ${CmdQueryEndTime}
      timeout_in_seconds:
        simple: "200"
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": 1180,
          "y": 2266
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "102":
    id: "102"
    taskid: fe1d76a1-8b3c-4c07-82ea-6b85e0ffdd68
    type: regular
    task:
      id: fe1d76a1-8b3c-4c07-82ea-6b85e0ffdd68
      version: -1
      name: Set query start time
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "103"
    scriptarguments:
      key:
        simple: CmdQueryStartTime
      value:
        simple: ${alert.timestamp}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1180,
          "y": 2021
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "103":
    id: "103"
    taskid: 1701881f-477b-4046-84e0-f774ff90233f
    type: regular
    task:
      id: 1701881f-477b-4046-84e0-f774ff90233f
      version: -1
      name: Set query end time
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "101"
    scriptarguments:
      key:
        simple: CmdQueryEndTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: in 30 minutes
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1180,
          "y": 2145
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "104":
    id: "104"
    taskid: e0c605c1-c830-45b8-8852-818f835db535
    type: condition
    task:
      id: e0c605c1-c830-45b8-8852-818f835db535
      version: -1
      name: Any results from XQL?
      description: ' '
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "106"
      "yes":
      - "130"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.GenericQuery
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.query_name
                      iscontext: true
                    right:
                      value:
                        simple: Get post login user activity commands
                    ignorecase: true
                accessor: results
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1180,
          "y": 2403
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "105":
    id: "105"
    taskid: bc5ebe9f-7640-4032-9ed9-39fad2a97e89
    type: title
    task:
      id: bc5ebe9f-7640-4032-9ed9-39fad2a97e89
      version: -1
      name: Post-login Activity
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "107"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1180,
          "y": 1632
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "106":
    id: "106"
    taskid: 88907eea-4958-4a81-9656-eb2ce261a404
    type: condition
    task:
      id: 88907eea-4958-4a81-9656-eb2ce261a404
      version: -1
      name: Analyze evidence
      description: Extracts the values (true/false) from the Evidence key and counts the occurrences of "true" - indicating a positive detection, then checks if 3 or more detections returned as positive.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "124"
      True Positive:
      - "165"
    separatecontext: false
    conditions:
    - label: True Positive
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidence
                transformers:
                - operator: DT
                  args:
                    dt:
                      value:
                        simple: .=Object.values(val).filter(value => value == "True").length
            iscontext: true
          right:
            value:
              simple: "3"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1767,
          "y": 3181
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "107":
    id: "107"
    taskid: 4b6bd9e8-ddc6-4712-a740-bccf5c177a8f
    type: condition
    task:
      id: 4b6bd9e8-ddc6-4712-a740-bccf5c177a8f
      version: -1
      name: Check for any successful login
      description: Checks whether any logon attempt was successful.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "106"
      "Yes":
      - "112"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: SuccessfulLoginUsernames
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1180,
          "y": 1748
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "108":
    id: "108"
    taskid: 42664d84-2e17-42eb-a31d-5522b8e3496d
    type: title
    task:
      id: 42664d84-2e17-42eb-a31d-5522b8e3496d
      version: -1
      name: IP Prevalence
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "109"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1768,
          "y": 1506
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "109":
    id: "109"
    taskid: 56365fcb-c642-491f-b848-57ca55d373ff
    type: regular
    task:
      id: 56365fcb-c642-491f-b848-57ca55d373ff
      version: -1
      name: Check IP prevalence
      description: Get the prevalence of an ip, identified by ip_address.
      script: Cortex Core - IR|||core-get-IP-analytics-prevalence
      type: regular
      iscommand: true
      brand: Cortex Core - IR
    nexttasks:
      '#none#':
      - "161"
    scriptarguments:
      ip_address:
        complex:
          root: alert
          accessor: localip
          transformers:
          - operator: FirstArrayElement
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1768,
          "y": 1607
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "110":
    id: "110"
    taskid: 8fd85cbc-a5a7-40c8-a23a-e3c230d82ead
    type: title
    task:
      id: 8fd85cbc-a5a7-40c8-a23a-e3c230d82ead
      version: -1
      name: Targeted Users Analysis
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "111"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2200,
          "y": 1506
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "111":
    id: "111"
    taskid: fbb1d31d-a083-483b-b1e9-c891528e2a64
    type: regular
    task:
      id: fbb1d31d-a083-483b-b1e9-c891528e2a64
      version: -1
      name: Count sensitive accounts targeted
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "162"
    scriptarguments:
      key:
        simple: SensitiveAccountsTargeted
      value:
        complex:
          root: Core.OriginalAlert.stateful_raw_data
          accessor: count_distinct_user_service_account
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: Core.OriginalAlert.stateful_raw_data.count_distinct_user_administrator
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: Core.OriginalAlert.stateful_raw_data.count_distinct_user_sensitive_user
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: Core.OriginalAlert.stateful_raw_data.count_distinct_dst_identity_honey_user
                iscontext: true
          - operator: SumList
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2200,
          "y": 1607
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "112":
    id: "112"
    taskid: da68c6cb-4528-43a8-a8cc-dc02c467dfee
    type: regular
    task:
      id: da68c6cb-4528-43a8-a8cc-dc02c467dfee
      version: -1
      name: Prepare user list for query
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "102"
    scriptarguments:
      key:
        simple: SuccessfulLoginUsernamesQuery
      value:
        complex:
          root: SuccessfulLoginUsernames
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: lowercase("
              suffix:
                value:
                  simple: '")'
          - operator: join
            args:
              separator:
                value:
                  simple: ', '
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1180,
          "y": 1895
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "121":
    id: "121"
    taskid: 3521e3b9-b33d-4976-a930-964a8411a45c
    type: regular
    task:
      id: 3521e3b9-b33d-4976-a930-964a8411a45c
      version: -1
      name: Analyze command-lines
      description: |-
        This script evaluates command-line threats by analyzing both original and decoded inputs. It assigns weighted scores to detected patterns, such as AMSI bypass or credential dumping, and applies risk combination bonuses for multiple detections. The total score is normalized to a 0-100 scale, with risk levels categorized as follows:

        * 0-25: Low Risk
        * 26-50: Medium Risk
        * 51-90: High Risk
        * 91-100: Critical Risk

        The scoring mechanism provides a comprehensive risk assessment, considering both the severity and frequency of malicious behaviors.
      scriptName: CommandLineAnalysis
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "129"
    scriptarguments:
      command_line:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Get post login user activity commands
          accessor: results.action_process_image_command_line
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1440,
          "y": 2659
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "124":
    id: "124"
    taskid: 5b628351-75c9-4913-9afa-aa9c73299f68
    type: title
    task:
      id: 5b628351-75c9-4913-9afa-aa9c73299f68
      version: -1
      name: False Positive
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2183,
          "y": 3320
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "125":
    id: "125"
    taskid: 66ee5be6-a0a6-4de6-a9ae-4562744af487
    type: condition
    task:
      id: 66ee5be6-a0a6-4de6-a9ae-4562744af487
      version: -1
      name: Any results from XQL?
      description: ' '
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "106"
      "yes":
      - "126"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.GenericQuery
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.query_name
                      iscontext: true
                    right:
                      value:
                        simple: Find short bursts of failed user logins from source IP
                    ignorecase: true
                accessor: results
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 721,
          "y": 2403
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "126":
    id: "126"
    taskid: 2251ae78-f007-4d1f-8317-146a3eb107ae
    type: regular
    task:
      id: 2251ae78-f007-4d1f-8317-146a3eb107ae
      version: -1
      name: Save IP spray count
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "163"
    scriptarguments:
      key:
        simple: IPSprayCount
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Find short bursts of failed user logins from source IP
              ignorecase: true
          accessor: results.past_spray_count
          transformers:
          - operator: LastArrayElement
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 721,
          "y": 2571
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "128":
    id: "128"
    taskid: 92d3c96b-5dbc-4ee3-b310-067ede5a52fc
    type: regular
    task:
      id: 92d3c96b-5dbc-4ee3-b310-067ede5a52fc
      version: -1
      name: Save post login activity users
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "164"
    scriptarguments:
      key:
        simple: PostLoginActivityUsernames
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery.results
          filters:
          - - operator: in
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.results.action_process_image_command_line
                iscontext: true
              right:
                value:
                  simple: SuspiciousCommandlinesList
                iscontext: true
              ignorecase: true
          accessor: actor_effective_username
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1439,
          "y": 2899
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "129":
    id: "129"
    taskid: 37544daa-e0c6-4897-aa88-c9d4b5b0a8a0
    type: regular
    task:
      id: 37544daa-e0c6-4897-aa88-c9d4b5b0a8a0
      version: -1
      name: Save suspicious commandlines list
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "128"
    scriptarguments:
      key:
        simple: SuspiciousCommandlinesList
      value:
        complex:
          root: CommandLineAnalysis
          filters:
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: CommandLineAnalysis.score
                iscontext: true
              right:
                value:
                  simple: "50"
          accessor: original_command
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1440,
          "y": 2780
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "130":
    id: "130"
    taskid: 08afce62-c614-472c-8438-a7b3001ad504
    type: title
    task:
      id: 08afce62-c614-472c-8438-a7b3001ad504
      version: -1
      name: Command-line Analysis
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "121"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1439,
          "y": 2535
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "131":
    id: "131"
    taskid: f105cb8a-038d-4d69-ae6e-fc66552b770c
    type: title
    task:
      id: f105cb8a-038d-4d69-ae6e-fc66552b770c
      version: -1
      name: Hard Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "147"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1038,
          "y": 5096
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "132":
    id: "132"
    taskid: fd403ef3-f774-4723-b707-791f3f5f549f
    type: regular
    task:
      id: fd403ef3-f774-4723-b707-791f3f5f549f
      version: -1
      name: Retrieve Slack user details
      description: Get details about a specified user.
      script: '|||slack-get-user-details'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "135"
    scriptarguments:
      user:
        complex:
          root: ActiveDirectory.Users
          accessor: mail
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1551,
          "y": 4219
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "133":
    id: "133"
    taskid: a0c18845-b03b-418f-a9ae-9ebfc593b396
    type: title
    task:
      id: a0c18845-b03b-418f-a9ae-9ebfc593b396
      version: -1
      name: User Verification
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "157"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1549,
          "y": 3580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "135":
    id: "135"
    taskid: 63ce6ba9-2f6c-433b-ad24-d0cda531fba8
    type: condition
    task:
      id: 63ce6ba9-2f6c-433b-ad24-d0cda531fba8
      version: -1
      name: Check if details were retrieved
      description: Checks if a Slack user exists with the email found for the user.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "144"
      "yes":
      - "137"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: Slack.User.Email
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1551,
          "y": 4341
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "137":
    id: "137"
    taskid: a42252fc-07f1-48f8-ba6b-8d37810f9ac0
    type: collection
    task:
      id: a42252fc-07f1-48f8-ba6b-8d37810f9ac0
      version: -1
      name: Confirm alert details with user
      description: ""
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "139"
    separatecontext: false
    sla:
      minutes: 0
      hours: 1
      days: 0
      weeks: 0
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1767,
          "y": 4475
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
        complex:
          root: Slack.User
          accessor: Email
          transformers:
          - operator: uniq
      subject:
        simple: External login password spray detected
      body:
        simple: " Security Alert  Action Required\n\nWeve detected suspicious authentication activity involving your account, including multiple failed login attempts from an external source.\n\nPlease review the alert details and let us know whether any of this activity was performed by you."
      methods:
      - SlackV3
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 3
        retriesinterval: 15
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: true
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: |
            Please review the alert information below and indicate whether or not you recognize this activity.



            ### Alert Details
            Occurred: ${alert.occurred}

            Source IP: ${alert.localip}

            Target Host: ${alert.hostname}
        required: true
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - {}
        - simple: Yes - it was me
        - simple: No - it was not me
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: External Login Password Spray Detected
      description: |-
        We have received an alert suggesting potential unauthorized login attempts targeting your account.
        The activity includes several failed external login attempts followed by behavior that may indicate a successful login. This prompted an investigation and a request for your verification.
      sender: Your SOC team
      expired: false
      totalanswers: 0
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "139":
    id: "139"
    taskid: 3b75a461-0d51-4385-a144-75ea8c80aaa6
    type: condition
    task:
      id: 3b75a461-0d51-4385-a144-75ea8c80aaa6
      version: -1
      name: Check user reply
      description: ' '
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "144"
      False Positive:
      - "170"
      True Positive:
      - "140"
    separatecontext: false
    conditions:
    - label: False Positive
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: External Login Password Spray Detected.Answers.0
            iscontext: true
          right:
            value:
              simple: yes -
          ignorecase: true
    - label: True Positive
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: External Login Password Spray Detected.Answers.0
            iscontext: true
          right:
            value:
              simple: no -
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1767,
          "y": 4600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "140":
    id: "140"
    taskid: 7caa151b-eeb6-43ce-a490-3a23f9a3b15d
    type: regular
    task:
      id: 7caa151b-eeb6-43ce-a490-3a23f9a3b15d
      version: -1
      name: Save hard remediation flag
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      key:
        simple: PerformHardRemediation
      value:
        simple: "True"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1767,
          "y": 4742
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "142":
    id: "142"
    taskid: 10782cbd-2140-46f0-a9b0-204860a4f7e6
    type: title
    task:
      id: 10782cbd-2140-46f0-a9b0-204860a4f7e6
      version: -1
      name: Manual Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "145"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2297,
          "y": 5086
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "143":
    id: "143"
    taskid: 5975d2e2-4a9a-4cc4-b579-2f06833a52fa
    type: condition
    task:
      id: 5975d2e2-4a9a-4cc4-b579-2f06833a52fa
      version: -1
      name: Check successful domain user logins
      description: Checks whether any logon attempt was successful.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "144"
      "Yes":
      - "133"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: SuccessfulLoginUsernames
                filters:
                - - operator: notStartWith
                    left:
                      value:
                        simple: SuccessfulLoginUsernames
                      iscontext: true
                    right:
                      value:
                        simple: alert.hostname
                      iscontext: true
                    ignorecase: true
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1291,
          "y": 3450
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "144":
    id: "144"
    taskid: d3ccfc7e-7693-4e75-8e2a-8ed229c842b5
    type: regular
    task:
      id: d3ccfc7e-7693-4e75-8e2a-8ed229c842b5
      version: -1
      name: Save manual remediation flag
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      key:
        simple: PerformManualRemediation
      value:
        simple: "True"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1291,
          "y": 4742
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "145":
    id: "145"
    taskid: 28ad4ea4-d3b1-4826-b121-424aa6729bca
    type: condition
    task:
      id: 28ad4ea4-d3b1-4826-b121-424aa6729bca
      version: -1
      name: Check manual remediation flag
      description: |
        We have identified multiple suspicious indicators during the course of this investigation. However, the activity could not be conclusively verified with the relevant user(s).

        Please review the findings below and determine the appropriate next steps.
        Any check resulting in "True" indicates that supporting evidence was identified for that condition.

        ### Investigation Findings
        Related brute-force alert detected in this incident:
        `${.=val.foundIncidents && val.foundIncidents.length > 0 ? "True" : "False"}`

        Failure reasons appear suspicious (not primarily due to expired passwords):
        `${.=val.Core && val.Core.OriginalAlert && val.Core.OriginalAlert.stateful_raw_data && val.Core.OriginalAlert.stateful_raw_data.ratio_logins_expired_password <= 0.3 ? "True" : "False"}`

        Privileged or sensitive accounts were targeted:
        `${.=val.SpecialAccountsTargeted >= 2 ? "True" : "False"}`

        Source IP shows low prevalence within the organization:
        `${.=val.Core && val.Core.AnalyticsPrevalence && val.Core.AnalyticsPrevalence.Ip && val.Core.AnalyticsPrevalence.Ip.data && val.Core.AnalyticsPrevalence.Ip.data.local_prevalence && val.Core.AnalyticsPrevalence.Ip.data.local_prevalence.value <= 0.5 ? "True" : "False"}`

        At least one user successfully logged in and executed processes with suspicious command-line arguments:
        `${.=val.PostLoginActivityUsernames ? "True" : "False"}`

        The source IP has been observed in previous password spray activity:
         `${.=val.IPSprayCount >= 2 ? "True" : "False"}`


        ### Users To Disable
        Would you like to disable the following user account(s)?
        User list:
        ${SuccessfulLoginUsernames}
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      "Yes":
      - "146"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: PerformManualRemediation
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2297,
          "y": 5204
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "146":
    id: "146"
    taskid: 569299d1-f584-4bbc-b66c-30db7b830d43
    type: condition
    task:
      id: 569299d1-f584-4bbc-b66c-30db7b830d43
      version: -1
      name: Manually remediate the alert
      description: |
        We found suspicious indicators in this investigation. However, the activity could not be verified with the user/s.
        Please review the findings and decide on the next steps:
        Any check  that results in "True" indicates evidence was found for that check.

        ### Investigation Findings
        Related brute-force alert found in the incident: `${.=val.foundIncidents && val.foundIncidents.length > 0 ? "True" : "False"}`

        The failure reasons are suspicious (not due to expired passwords): `${.=val.Core && val.Core.OriginalAlert && val.Core.OriginalAlert.stateful_raw_data && val.Core.OriginalAlert.stateful_raw_data.ratio_logins_expired_password <= 0.3 ? "True" : "False"}`

        Privileged or sensitive accounts were targeted: `${.=val.SensitiveAccountsTargeted>= 2 ? "True" : "False"}`

        The source IP is not prevalent in the organization: `${.=val.Core && val.Core.AnalyticsPrevalence && val.Core.AnalyticsPrevalence.Ip && val.Core.AnalyticsPrevalence.Ip.data && val.Core.AnalyticsPrevalence.Ip.data.local_prevalence && val.Core.AnalyticsPrevalence.Ip.data.local_prevalence.value <= 0.5 ? "True" : "False"}`

        At least 1 user logged in and executed processes with suspicious commandlines: `${.=val.PostLoginActivityUsernames ? "True" : "False"}`

        The IP was seen spraying accounts on at least 1 other occasion: `${.=val.IPSprayCount >= 2 ? "True" : "False"}`


        ### Users To Disable
        Would you like to disable the following users?
        User list:

        ${SuccessfulLoginUsernames}
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      DIsable all affected users:
      - "156"
      Do not disable users:
      - "33"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2297,
          "y": 5336
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "147":
    id: "147"
    taskid: fc37af91-370b-45ed-85a5-3f37f3e7473b
    type: condition
    task:
      id: fc37af91-370b-45ed-85a5-3f37f3e7473b
      version: -1
      name: Check hard remediation flag
      description: ' '
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      "yes":
      - "156"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: PerformHardRemediation
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1125,
          "y": 5204
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "148":
    id: "148"
    taskid: 16cd0089-dcf3-4237-9637-9b310a284f52
    type: regular
    task:
      id: 16cd0089-dcf3-4237-9637-9b310a284f52
      version: -1
      name: Disable logged in users in AD
      description: Disables an Active Directory user account.
      script: Active Directory Query v2|||ad-disable-account
      type: regular
      iscommand: true
      brand: Active Directory Query v2
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      username:
        complex:
          root: SuccessfulLoginUsernames
          filters:
          - - operator: notStartWith
              left:
                value:
                  simple: SuccessfulLoginUsernames
                iscontext: true
              right:
                value:
                  simple: alert.hostname
                iscontext: true
              ignorecase: true
          transformers:
          - operator: RegexExtractAll
            args:
              error_if_no_match: {}
              ignore_case: {}
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: '[^\\]+\\(.+)'
              unpack_matches: {}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1260,
          "y": 5726
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "149":
    id: "149"
    taskid: 27ce4bc5-ac49-4a47-9abc-a27d96ec7ecd
    type: regular
    task:
      id: 27ce4bc5-ac49-4a47-9abc-a27d96ec7ecd
      version: -1
      name: Get user emails from AD
      description: Retrieves detailed information about a user account. The user can be specified by name, email address, or as an Active Directory Distinguished Name (DN). If no filter is specified, all users are returned.
      script: '|||ad-get-user'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "150"
    scriptarguments:
      username:
        complex:
          root: SuccessfulLoginUsernames
          filters:
          - - operator: notStartWith
              left:
                value:
                  simple: SuccessfulLoginUsernames
                iscontext: true
              right:
                value:
                  simple: alert.hostname
                iscontext: true
              ignorecase: true
          transformers:
          - operator: RegexExtractAll
            args:
              error_if_no_match: {}
              ignore_case: {}
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: '[^\\]+\\(.+)'
              unpack_matches: {}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1549,
          "y": 3829
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "150":
    id: "150"
    taskid: f8296b60-9116-4c25-be41-b93a5c3e9b77
    type: condition
    task:
      id: f8296b60-9116-4c25-be41-b93a5c3e9b77
      version: -1
      name: Check if emails were retrieved
      description: Checks if an email was returned for the user from Active Directory.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "144"
      "yes":
      - "158"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: ActiveDirectory.Users.mail
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1549,
          "y": 3947
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "152":
    id: "152"
    taskid: 5c4f927c-1c5a-4258-94b5-35d5aae4caff
    type: condition
    task:
      id: 5c4f927c-1c5a-4258-94b5-35d5aae4caff
      version: -1
      name: Check domain user logins
      description: Checks whether any login for a domain user occurred.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      "Yes":
      - "148"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: SuccessfulLoginUsernames
                filters:
                - - operator: notStartWith
                    left:
                      value:
                        simple: SuccessfulLoginUsernames
                      iscontext: true
                    right:
                      value:
                        simple: alert.hostname
                      iscontext: true
                    ignorecase: true
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1260,
          "y": 5598
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "153":
    id: "153"
    taskid: ae872fff-d67f-4ddd-8f76-00f4bad2c4cc
    type: condition
    task:
      id: ae872fff-d67f-4ddd-8f76-00f4bad2c4cc
      version: -1
      name: Check local user logins
      description: Checks whether a login for any local user occurred.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      Local login - Mac/Linux:
      - "160"
      Local login - Windows:
      - "155"
    separatecontext: false
    conditions:
    - label: Local login - Windows
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: SuccessfulLoginUsernames
                filters:
                - - operator: startWith
                    left:
                      value:
                        simple: SuccessfulLoginUsernames
                      iscontext: true
                    right:
                      value:
                        simple: alert.hostname
                      iscontext: true
                    ignorecase: true
            iscontext: true
          right:
            value: {}
      - - operator: isEqualString
          left:
            value:
              simple: alert.hostos
            iscontext: true
          right:
            value:
              simple: AGENT_OS_WINDOWS
          ignorecase: true
    - label: Local login - Mac/Linux
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: SuccessfulLoginUsernames
                filters:
                - - operator: startWith
                    left:
                      value:
                        simple: SuccessfulLoginUsernames
                      iscontext: true
                    right:
                      value:
                        simple: alert.hostname
                      iscontext: true
                    ignorecase: true
            iscontext: true
      - - operator: isEqualString
          left:
            value:
              simple: alert.hostos
            iscontext: true
          right:
            value:
              simple: AGENT_OS_MAC
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: alert.hostos
            iscontext: true
          right:
            value:
              simple: AGENT_OS_LINUX
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1860,
          "y": 5601
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "154":
    id: "154"
    taskid: ea594320-856e-4dc0-b283-c8cfa038ba3d
    type: title
    task:
      id: ea594320-856e-4dc0-b283-c8cfa038ba3d
      version: -1
      name: Soft Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "63"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 540,
          "y": 5091
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "155":
    id: "155"
    taskid: 81e7bed4-0ef3-4e80-971d-20978afdca73
    type: regular
    task:
      id: 81e7bed4-0ef3-4e80-971d-20978afdca73
      version: -1
      name: Disable local logged in users (Windows)
      description: Runs Powershell code on the affected host to disable the local user on the machine.
      script: '|||core-run-script-execute-commands'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      command_type:
        simple: powershell
      commands:
        complex:
          root: SuccessfulLoginUsernames
          filters:
          - - operator: startWith
              left:
                value:
                  simple: SuccessfulLoginUsernames
                iscontext: true
              right:
                value:
                  simple: alert.hostname
                iscontext: true
              ignorecase: true
          transformers:
          - operator: RegexExtractAll
            args:
              error_if_no_match: {}
              ignore_case: {}
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: '[^\\]+\\(.+)'
              unpack_matches: {}
          - operator: concat
            args:
              prefix:
                value:
                  simple: '"'
              suffix:
                value:
                  simple: '"'
          - operator: join
            args:
              separator:
                value:
                  simple: ','
          - operator: concat
            args:
              prefix:
                value:
                  simple: $users = @(
              suffix:
                value:
                  simple: |-
                    )
                    foreach ($user in $users) {
                        Disable-LocalUser -Name $user
                    }
      endpoint_ids:
        complex:
          root: alert
          accessor: agentid
          transformers:
          - operator: uniq
      is_raw_command:
        simple: "true"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1660,
          "y": 5739
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "156":
    id: "156"
    taskid: eb9dae75-4a22-4f64-b41c-4c8a50cd2495
    type: title
    task:
      id: eb9dae75-4a22-4f64-b41c-4c8a50cd2495
      version: -1
      name: Disable Users
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "153"
      - "152"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1515,
          "y": 5480
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "157":
    id: "157"
    taskid: b02af827-90cb-4bce-bf0d-96f3972d8fb3
    type: condition
    task:
      id: b02af827-90cb-4bce-bf0d-96f3972d8fb3
      version: -1
      name: Check Active Directory availability
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "144"
      "yes":
      - "149"
    scriptarguments:
      brandname:
        simple: Active Directory Query v2
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1549,
          "y": 3701
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "158":
    id: "158"
    taskid: 6e080c31-a9e0-4a6e-aa6e-f993e80798bb
    type: condition
    task:
      id: 6e080c31-a9e0-4a6e-aa6e-f993e80798bb
      version: -1
      name: Check Slack availability
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "144"
      "yes":
      - "132"
    scriptarguments:
      brandname:
        simple: SlackV3
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1549,
          "y": 4087
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "160":
    id: "160"
    taskid: 21b878b3-30c2-4234-bc98-81f446a2fa18
    type: regular
    task:
      id: 21b878b3-30c2-4234-bc98-81f446a2fa18
      version: -1
      name: Disable local logged in users (Linux/Mac)
      description: Runs Powershell code on the affected host to disable the local user on the machine.
      script: '|||core-run-script-execute-commands'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      command_type:
        simple: native
      commands:
        complex:
          root: SuccessfulLoginUsernames
          filters:
          - - operator: startWith
              left:
                value:
                  simple: SuccessfulLoginUsernames
                iscontext: true
              right:
                value:
                  simple: alert.hostname
                iscontext: true
              ignorecase: true
          transformers:
          - operator: RegexExtractAll
            args:
              error_if_no_match: {}
              ignore_case: {}
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: '[^\\]+\\(.+)'
              unpack_matches: {}
          - operator: join
            args:
              separator:
                value:
                  simple: ' '
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'for user in '
              suffix:
                value:
                  simple: ; do if id "$user" &>/dev/null; then sudo passwd -l "$user"; else echo "User $user not found"; fi; done
      endpoint_ids:
        complex:
          root: alert
          accessor: agentid
          transformers:
          - operator: uniq
      is_raw_command:
        simple: "true"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2057,
          "y": 5739
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "161":
    id: "161"
    taskid: b087865d-b4c1-4654-9063-25a55353c0f4
    type: regular
    task:
      id: b087865d-b4c1-4654-9063-25a55353c0f4
      version: -1
      name: Save prevalence to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "106"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidence.IPPrevalence
      value:
        simple: '${.=val.Core && val.Core.AnalyticsPrevalence && val.Core.AnalyticsPrevalence.Ip && val.Core.AnalyticsPrevalence.Ip[0].data && val.Core.AnalyticsPrevalence.Ip[0].data.local_prevalence && val.Core.AnalyticsPrevalence.Ip[0].data.local_prevalence.value <= 0.5 ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1767,
          "y": 1724
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "162":
    id: "162"
    taskid: bcf51ef3-fd2a-49db-b585-2d122ea4b8b3
    type: regular
    task:
      id: bcf51ef3-fd2a-49db-b585-2d122ea4b8b3
      version: -1
      name: Save sensitive accounts to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "106"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidence.SensitiveAccounts
      value:
        simple: '${.=val.SensitiveAccountsTargeted >= 2 ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2200,
          "y": 1724
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "163":
    id: "163"
    taskid: 5205bb85-0341-4e23-bf69-e61123607ce4
    type: regular
    task:
      id: 5205bb85-0341-4e23-bf69-e61123607ce4
      version: -1
      name: Save IP spray count to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "106"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidence.IPSprayHistory
      value:
        simple: '${.=val.IPSprayCount >= 2 ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 721,
          "y": 2710
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "164":
    id: "164"
    taskid: 8732f695-88ed-4811-93de-9a2258f8ddf9
    type: regular
    task:
      id: 8732f695-88ed-4811-93de-9a2258f8ddf9
      version: -1
      name: Save post login count to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "106"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidence.PostLoginActivity
      value:
        simple: '${.=val.PostLoginActivityUsernames ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1440,
          "y": 3029
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "165":
    id: "165"
    taskid: ca76a197-2b9e-4c07-a400-829c7c3721bb
    type: regular
    task:
      id: ca76a197-2b9e-4c07-a400-829c7c3721bb
      version: -1
      name: Save close reason - true positive
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "143"
    scriptarguments:
      append:
        simple: "false"
      key:
        simple: CloseReason
      value:
        simple: Resolved - True Positive
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1291,
          "y": 3315
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "166":
    id: "166"
    taskid: 3f2381fa-28b5-4643-84a8-50de0d98ec77
    type: regular
    task:
      id: 3f2381fa-28b5-4643-84a8-50de0d98ec77
      version: -1
      name: Save close reason - true positive
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      append:
        simple: "false"
      key:
        simple: CloseReason
      value:
        simple: Resolved - True Positive
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 452,
          "y": 1547
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "167":
    id: "167"
    taskid: b93def7a-5bc6-4c5c-839e-8d710073077c
    type: regular
    task:
      id: b93def7a-5bc6-4c5c-839e-8d710073077c
      version: -1
      name: Save related alerts to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "50"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidence.RelatedAlerts
      value:
        simple: '${.=val.foundIncidents && val.foundIncidents.id ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1506,
          "y": 980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "168":
    id: "168"
    taskid: 17579c31-caf3-4b70-adc0-2ea5a165cba7
    type: title
    task:
      id: 17579c31-caf3-4b70-adc0-2ea5a165cba7
      version: -1
      name: Login Failure Reason Analysis
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "169"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2671,
          "y": 1506
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "169":
    id: "169"
    taskid: 920802d7-aa42-417d-a4b9-02a7d8bcf93d
    type: regular
    task:
      id: 920802d7-aa42-417d-a4b9-02a7d8bcf93d
      version: -1
      name: Save outcome analysis to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "106"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidence.NotExpiredPasswords
      value:
        simple: '${.=val.Core && val.Core.OriginalAlert && val.Core.OriginalAlert.stateful_raw_data && val.Core.OriginalAlert.stateful_raw_data.ratio_logins_expired_password <= 0.3 ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2671,
          "y": 1607
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "170":
    id: "170"
    taskid: c3816efc-7a08-4f59-b0e5-9f6e0dcd8eff
    type: title
    task:
      id: c3816efc-7a08-4f59-b0e5-9f6e0dcd8eff
      version: -1
      name: Close Alert As False Positive
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "33"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2841,
          "y": 5096
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "171":
    id: "171"
    taskid: a92df35a-1677-4cfa-afb4-6a45a2c8ae03
    type: regular
    task:
      id: a92df35a-1677-4cfa-afb4-6a45a2c8ae03
      version: -1
      name: Save risky user logins to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "50"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidence.RiskyUserLogons
      value:
        simple: '${.=val.RiskyLogonUsernames ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 666,
          "y": 1224
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "101_106_#error#": 0.14,
      "104_106_#default#": 0.1,
      "106_124_#default#": 0.11,
      "106_165_True Positive": 0.34,
      "107_106_#default#": 0.31,
      "10_33_#default#": 0.28,
      "125_106_#default#": 0.11,
      "125_126_yes": 0.42,
      "135_144_#default#": 0.2,
      "139_144_#default#": 0.35,
      "139_170_False Positive": 0.32,
      "143_144_#default#": 0.1,
      "145_33_#default#": 0.18,
      "146_156_DIsable all affected users": 0.56,
      "146_33_Do not disable users": 0.1,
      "147_33_#default#": 0.35,
      "14_50_#default#": 0.22,
      "150_144_#default#": 0.28,
      "152_33_#default#": 0.23,
      "153_33_#default#": 0.11,
      "157_144_no": 0.18,
      "157_149_yes": 0.35,
      "158_144_no": 0.28,
      "46_15_#default#": 0.14,
      "46_47_Yes": 0.4,
      "50_166_True Positive": 0.53,
      "63_33_#default#": 0.18,
      "63_65_Windows": 0.52,
      "65_33_#default#": 0.21,
      "65_73_RemoteInteractive": 0.69,
      "83_33_#default#": 0.25,
      "87_106_#error#": 0.13
    },
    "paper": {
      "dimensions": {
        "height": 6311,
        "width": 3677,
        "x": -455,
        "y": -330
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 8.9.0
issilent: true