id: A mail forwarding rule was configured in Google Workspace
version: -1
name: A mail forwarding rule was configured in Google Workspace
description: "This playbook addresses the following alerts:\n\n- A mail forwarding rule was configured in Google Workspace.\n- A mail forwarding rule was configured in Google Workspace to an uncommon domain.\n\nPlaybook Stages:\n \nTriage: \n\n- The playbook retrieves the caller's IP, the forwarding email address, and associated filters.\n\nEarly Containment:\n\n- The playbook checks if the IP or domain of the forwarding email address is malicious. If so, it suggests blocking the IP using PAN-OS while continuing the investigation in parallel.\n\nInvestigation:\n\n- The playbook verifies if the rule was created outside of working hours or from an unusual geolocation and extracts suspicious keywords from the forwarding rules. It then aggregates all evidence collected during the investigation.\n\nContainment:\n\n- If only one suspicious evidence is found, the playbook executes soft response actions, including signing the user out and deleting the forwarding email address from the user account mailbox. The user will be notified of these actions via email.\n- If multiple suspicious evidences are found, the playbook executes both soft and hard response actions, recommending the analyst suspend the user account.\n\nRequirements: \n\nFor any response action, you need one of the following integrations:\n- Gmail integration to fetch filters and remove the forwarding email address.\n- Google Workspace Admin access to sign out and suspend the user account.\n"
tags:
- TA0009 - Collection
- T1114 - Email Collection
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: f54996ae-66c2-4d51-8fe3-a1ad489e4afb
    type: start
    task:
      id: f54996ae-66c2-4d51-8fe3-a1ad489e4afb
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": -20
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 586f11c0-89b5-4c58-86df-36aa1af4305d
    type: regular
    task:
      id: 586f11c0-89b5-4c58-86df-36aa1af4305d
      version: -1
      name: Get caller IP and forwarding mail address
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "6"
      - "2"
      - "12"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 110
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: bfb51251-f775-4f54-8ad2-20a46e1f1ac0
    type: regular
    task:
      id: bfb51251-f775-4f54-8ad2-20a46e1f1ac0
      version: -1
      name: Get forwarding email domain reputation
      description: Checks the reputation of a domain.
      script: '|||domain'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      domain:
        complex:
          root: Core.OriginalAlert.event.raw_log.events.parameters
          accessor: value
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '@'
              fields:
                value:
                  simple: "2"
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 280
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 4f9ab5b8-efb8-4999-873c-8390d318895c
    type: condition
    task:
      id: 4f9ab5b8-efb8-4999-873c-8390d318895c
      version: -1
      name: Check if forwarding email domain or IP is malicious
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "5"
      "yes":
      - "48"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                accessor: Indicator
            iscontext: true
          right:
            value: {}
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: domain
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                accessor: Indicator
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": 450
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: 65753a7c-d6c1-4592-8094-7a9efe197055
    type: title
    task:
      id: 65753a7c-d6c1-4592-8094-7a9efe197055
      version: -1
      name: Verdict
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "37"
      - "17"
      - "46"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 1100
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 971290fa-daf4-4510-81d2-610dd2cb9751
    type: title
    task:
      id: 971290fa-daf4-4510-81d2-610dd2cb9751
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "22"
      - "40"
      - "21"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 59e8a285-2f0f-49c3-83c8-f7126a101b53
    type: regular
    task:
      id: 59e8a285-2f0f-49c3-83c8-f7126a101b53
      version: -1
      name: Get filters for the specific forwarding address
      description: Lists all filters in a user's mailbox.
      script: '|||gmail-list-filters'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      user-id:
        simple: ${Core.OriginalAlert.event.raw_log.actor.profileId}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 830,
          "y": 280
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: f636844f-1e17-47eb-8b12-e862f2863b85
    type: regular
    task:
      id: f636844f-1e17-47eb-8b12-e862f2863b85
      version: -1
      name: Gmail - Get forwarding email address
      description: Gets the specified forwarding address or a list of the forwarding addresses for the specified account.
      script: '|||gmail-forwarding-address-get'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      forwarding_email:
        simple: ${Core.OriginalAlert.event.raw_log.events.parameters.value}
      user_id:
        simple: ${Core.OriginalAlert.event.raw_log.actor.profileId}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1530
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 4a1a1abf-ed23-4539-892a-03f8111fb08c
    type: regular
    task:
      id: 4a1a1abf-ed23-4539-892a-03f8111fb08c
      version: -1
      name: Get caller IP reputation
      description: Checks the reputation of an IP address.
      script: '|||ip'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      ip:
        complex:
          root: Core.OriginalAlert.raw_abioc.event
          accessor: caller_ip
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": 280
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 23be2a95-6283-4e18-865a-9ce05445701f
    type: title
    task:
      id: 23be2a95-6283-4e18-865a-9ce05445701f
      version: -1
      name: Early Containment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "15"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -580,
          "y": 810
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: f0dd7de0-9eac-4e6f-86a1-dd9ff4dc93f6
    type: playbook
    task:
      id: f0dd7de0-9eac-4e6f-86a1-dd9ff4dc93f6
      version: -1
      name: PAN-OS - Block IP
      description: |-
        This playbook blocks IP addresses with 2 optional actions:

        - Block IP addresses using Static Address Groups in Palo Alto Networks Panorama or Firewall. The playbook receives malicious IP addresses and an address group name as inputs, verifies that the addresses are not already a part of the address group, adds them and commits the configuration.


        - Utilize the Dynamic Address Group (DAG) capability of PAN-OS. DAG enables analysts to create a rule one time, where the group is the source/destination, and adds IP addresses dynamically without the need to commit the configuration every time.
        The playbook checks if the given tag already exists. If the tag exists, then the IP address is added to the tag.
        If the tag does not exist, a new address group is created with the given tag and a matching rule, and the configuration is committed.
      playbookName: PAN-OS - Block IP
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    scriptarguments:
      MaliciousIPs:
        complex:
          root: Core.OriginalAlert.raw_abioc.event
          accessor: caller_ip
          transformers:
          - operator: uniq
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -580,
          "y": 945
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 3028fe8a-9e44-4203-8458-c6be36fc42a7
    type: regular
    task:
      id: 3028fe8a-9e44-4203-8458-c6be36fc42a7
      version: -1
      name: Close Alert
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "20"
    scriptarguments:
      closeReason:
        complex:
          root: ${
          accessor: '}'
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs != rhs
              conditionB: {}
              conditionInBetween: {}
              else:
                value:
                  simple: Resolved as FALSE_POSITIVE - Handled by the playbook "A mail forwarding rule was configured in Google Workspace"
              equals: {}
              lhs:
                value:
                  simple: Evidences
                iscontext: true
              lhsB: {}
              options: {}
              optionsB: {}
              rhs: {}
              rhsB: {}
              then:
                value:
                  simple: Resolved as TRUE_POSITIVE - Handled by the playbook "A mail forwarding rule was configured in Google Workspace"
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 2410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: de8e5625-536a-4bb9-8bdc-70ee14eb72ff
    type: condition
    task:
      id: de8e5625-536a-4bb9-8bdc-70ee14eb72ff
      version: -1
      name: Check if the forwarding mail address still exists
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "17"
      "yes":
      - "25"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: Gmail.ForwardingAddress.forwardingEmail
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1690
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: fe775a32-55a3-45a0-8502-c6e319e7ae91
    type: title
    task:
      id: fe775a32-55a3-45a0-8502-c6e319e7ae91
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 2570
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: 252d8473-0602-420c-8fef-df880efcc695
    type: regular
    task:
      id: 252d8473-0602-420c-8fef-df880efcc695
      version: -1
      name: Check if the rule was created outside of working hours
      description: Checks whether the given value is within the specified time (hour) range.
      scriptName: BetweenHours
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "45"
    scriptarguments:
      begin_time:
        simple: "22:00:00"
      end_time:
        simple: "06:00:00"
      extend-context:
        simple: IsOutOfWorkingHours=
      value:
        complex:
          root: Core.OriginalAlert.raw_abioc.event
          accessor: event_timestamp
          transformers:
          - operator: TimeStampToDate
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 0,
          "y": 765
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: a1b2240d-c96c-46a2-8749-c94f8a214538
    type: regular
    task:
      id: a1b2240d-c96c-46a2-8749-c94f8a214538
      version: -1
      name: Check for unusual geolocation connections
      description: |-
        Returns all elements from the left side that have a substring that is equal to an element from the right side. Note: This filter is case-insensitive.
        E.g -AnyMatch left=baby right=A will return baby. For more examples see the filter's Readme.
      scriptName: AnyMatch
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      extend-context:
        simple: IsAbnormalGeolocation=
      left:
        simple: ${Core.OriginalAlert.raw_abioc.event.saas_caller_ip_geolocation_days_seen_count},${Core.OriginalAlert.raw_abioc.event.service_caller_ip_asn_days_seen_count}
      right:
        simple: "0"
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 765
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 3023b302-dc80-4e51-8b44-4489de9d410c
    type: regular
    task:
      id: 3023b302-dc80-4e51-8b44-4489de9d410c
      version: -1
      name: Gmail - Remove forwarding mail address
      description: Deletes the specified forwarding address and revokes any verification that may have been required. This method is only available to service account clients that have been delegated domain-wide authority.
      script: '|||gmail-forwarding-address-remove'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "52"
    scriptarguments:
      forwarding_email:
        simple: ${Gmail.ForwardingAddress.forwardingEmail}
      user_id:
        simple: ${Gmail.ForwardingAddress.userId}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1880
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: f069e81d-7b35-45fc-864e-25e9051482ab
    type: title
    task:
      id: f069e81d-7b35-45fc-864e-25e9051482ab
      version: -1
      name: Soft Response
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "10"
      - "49"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1400
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: 68992710-f44d-47dc-8ddb-82e8cea3339c
    type: title
    task:
      id: 68992710-f44d-47dc-8ddb-82e8cea3339c
      version: -1
      name: Hard Response
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "29"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 160,
          "y": 1400
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 10a29f38-0fc1-4df2-82bc-e7afb761788b
    type: collection
    task:
      id: 10a29f38-0fc1-4df2-82bc-e7afb761788b
      version: -1
      name: Decide Whether to Suspend User Account
      type: collection
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "33"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 160,
          "y": 1530
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: "The following evidence was found: \n\n${Evidences}\n\nWould you like to suspend the account ${Core.OriginalAlert.raw_abioc.event.identity_name} using Google Workspace Admin?"
        required: false
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - {}
        - simple: "Yes"
        - simple: 'No '
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Select user account containment steps
      description: The investigation identified several suspicious indicators, suggesting that the user who created the forwarding rule may have been compromised. The forwarding email and associated filters have been automatically removed. Please review and decide if any additional actions should be taken.
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: 172b1869-9064-4a18-869e-a522b8602b9a
    type: regular
    task:
      id: 172b1869-9064-4a18-869e-a522b8602b9a
      version: -1
      name: Sign-Out user account from Google Workspace
      description: Signs a user out of all web and device sessions and reset their sign-in cookies.
      script: '|||gsuite-user-signout'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      user_key:
        simple: ${Core.OriginalAlert.raw_abioc.event.identity_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1130,
          "y": 2240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: 1b880cd2-e9af-4734-8364-ead4ccdb0a7b
    type: regular
    task:
      id: 1b880cd2-e9af-4734-8364-ead4ccdb0a7b
      version: -1
      name: Suspend user in google workspace
      description: Updates a user.
      script: '|||gsuite-user-update'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      suspended:
        simple: "true"
      user_key:
        simple: ${Core.OriginalAlert.raw_abioc.event.identity_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 160,
          "y": 1880
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 2e040f98-61ea-4032-826c-66b48eece3d7
    type: condition
    task:
      id: 2e040f98-61ea-4032-826c-66b48eece3d7
      version: -1
      name: Check analyst decision
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "17"
      "yes":
      - "31"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: Select user account containment steps.Answers.0
            iscontext: true
          right:
            value:
              simple: "yes"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 160,
          "y": 1690
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 52b78c1f-6c70-4221-8440-d99cd5fa754c
    type: title
    task:
      id: 52b78c1f-6c70-4221-8440-d99cd5fa754c
      version: -1
      name: Early Containment Complete
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "17"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -580,
          "y": 2270
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: fdc9701c-599a-4494-8a76-9b500a2bf90e
    type: condition
    task:
      id: fdc9701c-599a-4494-8a76-9b500a2bf90e
      version: -1
      name: Check if suspicious evidence detected
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "17"
      "yes":
      - "26"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidences
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "1"
          ignorecase: true
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: domain
                    ignorecase: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                accessor: Indicator
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: cc0a92a6-27ec-43ee-852a-d6368282a74d
    type: regular
    task:
      id: cc0a92a6-27ec-43ee-852a-d6368282a74d
      version: -1
      name: Extract suspicious keywords from the forwarding rules
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations 
        - For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "44"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: SuspiciousKeyWords
      stringify:
        simple: "true"
      value:
        complex:
          root: Gmail.Filter
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: Gmail.Filter.Action.forward
                iscontext: true
              right:
                value:
                  simple: Core.OriginalAlert.event.raw_log.events.parameters.value
                iscontext: true
              ignorecase: true
          accessor: Criteria.query
          transformers:
          - operator: StringifyArray
          - operator: RegexExtractAll
            args:
              error_if_no_match: {}
              ignore_case:
                value:
                  simple: "true"
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: \b(accounting|agreement|bank|bic|capital call|cash|confidential|contribution|credentials|credit|deposit|dividend|docusign|finance|fund|iban|invoice|password|payment|payroll|purchase|sensitive|shares|ssn|statement|swift|tax|transfer|w2|wire|wiring info|withdrawal)\b
              unpack_matches: {}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 860,
          "y": 765
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 9b154689-28ab-4f05-8ba4-e3cc23859851
    type: regular
    task:
      id: 9b154689-28ab-4f05-8ba4-e3cc23859851
      version: -1
      name: Set abnormal geolocation to evidence
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations 
        - For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidences
      stringify:
        simple: "true"
      value:
        complex:
          root: ${
          accessor: '}'
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs==rhs
              conditionB: {}
              conditionInBetween: {}
              else: {}
              equals: {}
              lhs:
                value:
                  simple: IsAbnormalGeolocation.[0]
                iscontext: true
              lhsB: {}
              options: {}
              optionsB: {}
              rhs:
                value:
                  simple: "True"
              rhsB: {}
              then:
                value:
                  simple: The user connected from an unusual geolocation.
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 440,
          "y": 930
        }
      }
    note: true
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: 47ef82fb-1c7d-4c4b-8f3b-40c46d3c5bac
    type: regular
    task:
      id: 47ef82fb-1c7d-4c4b-8f3b-40c46d3c5bac
      version: -1
      name: Set suspicious keywords to evidence
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations 
        - For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidences
      value:
        complex:
          root: ${
          accessor: '}'
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs!=rhs
              conditionB: {}
              conditionInBetween: {}
              else: {}
              equals: {}
              lhs:
                value:
                  simple: SuspiciousKeyWords
                iscontext: true
              lhsB: {}
              options: {}
              optionsB: {}
              rhs: {}
              rhsB: {}
              then:
                value:
                  simple: User has defined forwarding rule with querying for suspicious words
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 860,
          "y": 930
        }
      }
    note: true
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: 80b45a10-5b09-4f0f-89af-c4aced6131cd
    type: regular
    task:
      id: 80b45a10-5b09-4f0f-89af-c4aced6131cd
      version: -1
      name: Set abnormal working hours to evidence
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations 
        - For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidences
      stringify:
        simple: "true"
      value:
        complex:
          root: ${
          accessor: '}'
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs==rhs
              conditionB:
                value:
                  simple: lhsB==rhsB
              conditionInBetween:
                value:
                  simple: and
              else: {}
              equals: {}
              lhs:
                value:
                  simple: IsOutOfWorkingHours
                iscontext: true
              lhsB:
                value:
                  simple: alert.severity
                iscontext: true
              options: {}
              optionsB: {}
              rhs:
                value:
                  simple: "true"
              rhsB:
                value:
                  simple: "3"
              then:
                value:
                  simple: User took action outside of working hours
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 0,
          "y": 930
        }
      }
    note: true
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: 652eb822-a99d-4d31-8777-3d912ffd8e29
    type: condition
    task:
      id: 652eb822-a99d-4d31-8777-3d912ffd8e29
      version: -1
      name: Check if multiple suspicious evidence detected
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "17"
      "yes":
      - "27"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidences
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "2"
          ignorecase: true
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: domain
                    ignorecase: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                accessor: Indicator
            iscontext: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: GSuiteAdmin
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
                accessor: brand
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 160,
          "y": 1240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: 8f88c80e-c7e1-41f0-8f57-2e0b353172ca
    type: regular
    task:
      id: 8f88c80e-c7e1-41f0-8f57-2e0b353172ca
      version: -1
      name: Send user notification via Email
      description: Sends an email.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      htmlBody:
        simple: "<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body {\n      font-family: Arial, sans-serif;\n      background-color: #f4f4f9;\n      margin: 0;\n      padding: 0;\n    }\n    .container {\n      width: 80%;\n      max-width: 600px;\n      margin: 50px auto;\n      padding: 20px;\n      background-color: #ffffff;\n      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);\n      border-radius: 8px;\n    }\n    h2 {\n      color: #333;\n    }\n    p {\n      color: #555;\n      line-height: 1.6;\n    }\n    .highlight {\n      color: #d9534f;\n      font-weight: bold;\n    }\n  </style>\n</head>\n<body>\n\n<div class=\"container\">\n  <h2>Dear <span class=\"highlight\">&lt;${Core.OriginalAlert.raw_abioc.event.identity_name}&gt;</span>,</h2>\n  \n  <p>As part of our ongoing security measures, we detected unusual activity associated with your mailbox. A forwarding address and associated rule were automatically removed from your account to protect your data and ensure the security of our systems.</p>\n\n  <p>If you did not set up these rules, we recommend reviewing your recent activity and updating your account password immediately. If you require assistance or further information, please contact our security team.</p>\n\n  <p>Thank you for your understanding and cooperation.</p>\n</div>\n\n</body>\n</html>\n"
      subject:
        simple: Forwarding Rule and Address Removed from Your Mailbox
      to:
        simple: ${Core.OriginalAlert.raw_abioc.event.identity_name}
      using:
        simple: Built-in Mail Sender
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 2240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: f747c163-e58c-4da6-883b-a245234aed44
    type: regular
    task:
      id: f747c163-e58c-4da6-883b-a245234aed44
      version: -1
      name: Save known malicious indicators detected to evidences
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations 
        - For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidences
      stringify:
        simple: "true"
      value:
        simple: Known malicious indicators detected
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -580,
          "y": 620
        }
      }
    note: true
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "49":
    id: "49"
    taskid: 89920c84-f44d-45ce-8bc5-0577831df61f
    type: regular
    task:
      id: 89920c84-f44d-45ce-8bc5-0577831df61f
      version: -1
      name: Get Google Workspace user account
      description: Retrieve a user's details given a user key.
      script: '|||gsuite-user-get'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "50"
    scriptarguments:
      user:
        simple: ${Core.OriginalAlert.raw_abioc.event.identity_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1130,
          "y": 1880
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "50":
    id: "50"
    taskid: 212fa2bf-f6ce-458e-846d-0536d50ed840
    type: condition
    task:
      id: 212fa2bf-f6ce-458e-846d-0536d50ed840
      version: -1
      name: Check if Google Workspace user account found
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "17"
      "yes":
      - "30"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: GSuite.User.id
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1130,
          "y": 2040
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: d87cf812-ca8d-4017-85a4-aedb561018e7
    type: condition
    task:
      id: d87cf812-ca8d-4017-85a4-aedb561018e7
      version: -1
      name: Check user notification requirement
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "17"
      "yes":
      - "47"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.SendNotification
            iscontext: true
          right:
            value:
              simple: "true"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 2040
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "18_17_#default#": 0.31,
      "18_25_yes": 0.55,
      "33_17_#default#": 0.32,
      "37_17_#default#": 0.19,
      "3_5_#default#": 0.37,
      "46_17_#default#": 0.19,
      "50_17_#default#": 0.19,
      "50_30_yes": 0.76,
      "52_17_#default#": 0.5,
      "52_47_yes": 0.81
    },
    "paper": {
      "dimensions": {
        "height": 2655,
        "width": 2090,
        "x": -580,
        "y": -20
      }
    }
  }
inputs:
- key: SendNotification
  value:
    simple: "true"
  required: false
  description: If set to "true," the playbook will send an email notification to the user informing them that the forwarding address was deleted. If "false," no notification will be sent.
  playbookInputQuery:
inputSections:
- inputs:
  - SendNotification
  name: General (Inputs group)
  description: Generic group for inputs
outputSections:
- outputs: []
  name: General (Outputs group)
  description: Generic group for outputs
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.10.0
marketplaces:
- marketplacev2