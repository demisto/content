id: silent-Suspicious Local User Account Creation
version: -1
name: silent-Suspicious Local User Account Creation
description: |-
  This playbook addresses the following alerts:
  - Suspicious Local User Account Creation

  Playbook Stages:

  Triage:
  - Retrieve extra information about the alert, such as the SID of the created user.

  Investigation:
  - Get host risk level for the machine where the user was created.
  - Search for related alerts in the incident that hint of privilege escalation or persistence.
  - Retrieve local user password expiration status using PowerShell commands.
  - Get creator user risk level from the system.
  - Search for privileged group memberships of the created user (Administrators, Domain Admins, etc.).
  - Analyze command line executions for both created user and creator user to detect suspicious activities.
  - Check creator's historical user creation patterns.

  Containment:
  - Analyze evidence using multiple indicators to determine if the alert is a true positive, false positive, or inconclusive.
  - For true positives: Automatically disable the suspicious local user account.
  - Present analyst review with comprehensive findings including related alerts, privileged groups, host/user risk levels, and suspicious command lines.
  - Upon analyst approval: Disable the creator user account either locally or in Active Directory based on user type detection.

  Requirements:

  For response actions, you need the following integrations:
  - Cortex Core - Investigation and Response
  - Active Directory Query v2.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: e81e6c9b-318a-44f0-8ac0-61506641c4be
    type: start
    task:
      id: e81e6c9b-318a-44f0-8ac0-61506641c4be
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 30
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: acbd2f29-52a9-48d1-81e4-e23c2cedb2a9
    type: regular
    task:
      id: acbd2f29-52a9-48d1-81e4-e23c2cedb2a9
      version: -1
      name: Get event information
      description: Retrieves extra information about the alert, such as the SID of the created user.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 277
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 88b7dd78-37a7-4953-83c6-bbe29e467cb5
    type: title
    task:
      id: 88b7dd78-37a7-4953-83c6-bbe29e467cb5
      version: -1
      name: Triage
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 158
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 8c75c670-2c40-4784-8071-95e866bce1e1
    type: title
    task:
      id: 8c75c670-2c40-4784-8071-95e866bce1e1
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "13"
      - "12"
      - "31"
      - "17"
      - "48"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 388
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 6ff2db27-c0e8-490c-8325-2ac719c84783
    type: regular
    task:
      id: 6ff2db27-c0e8-490c-8325-2ac719c84783
      version: -1
      name: Get host risk level
      description: Gets the risk level of the host on which the user was created.
      script: '|||core-list-risky-hosts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "32"
    scriptarguments:
      host_id:
        simple: ${alert.hostname}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 041f6c30-c183-47a3-8cfb-c13b1694f783
    type: regular
    task:
      id: 041f6c30-c183-47a3-8cfb-c13b1694f783
      version: -1
      name: Search suspicious user activity alerts
      description: Searches for known related alerts in the same case.
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      query:
        complex:
          root: alert
          accessor: parentXDRIncident
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '-'
              fields:
                value:
                  simple: "2"
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'caseid:'
              suffix:
                value:
                  simple: ' and (name:"Masquerading as a default local account for the first time" or name:"Execution of an uncommon process with a local/domain user SID at an early startup stage with suspicious characteristics" or name:"Privilege Escalation - 1216127025" or name:"Suspicious disablement of the Windows Firewall" or name:"PowerShell runs suspicious base64-encoded commands")'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1284,
          "y": 620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: 35502b85-dcf2-4586-813c-65ed36de7bb2
    type: regular
    task:
      id: 35502b85-dcf2-4586-813c-65ed36de7bb2
      version: -1
      name: Retrieve local user password status
      description: Runs a Powershell code snipper on the endpoint where the user was created, in order to retrieve the PASSWORDEXPIRES attribute of the local user.
      script: '|||core-run-script-execute-commands'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      command_type:
        simple: native
      commands:
        complex:
          root: Core.OriginalAlert.event
          accessor: evtlog_target_username
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'powershell -Command "NET USER '
              suffix:
                value:
                  simple: '"'
      endpoint_ids:
        complex:
          root: alert
          accessor: agentid
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 871,
          "y": 620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 0e8a2866-b958-4a00-8de1-de445b576154
    type: title
    task:
      id: 0e8a2866-b958-4a00-8de1-de445b576154
      version: -1
      name: Host Risk
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "5"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: fb9d21c9-a982-43f4-85aa-cb2c71018bf8
    type: title
    task:
      id: fb9d21c9-a982-43f4-85aa-cb2c71018bf8
      version: -1
      name: Related Alerts
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "6"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1284,
          "y": 512
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 8fe57217-d147-4f36-89f9-be99db85dcdd
    type: regular
    task:
      id: 8fe57217-d147-4f36-89f9-be99db85dcdd
      version: -1
      name: Get execution results
      description: Gets the execution results for the Powershell code that was run.
      script: '|||core-get-script-execution-results'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      action_id:
        simple: ${Core.ScriptRun.action_id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 871,
          "y": 743
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 92d1867d-59ca-4ef8-8069-cc273ea1a622
    type: regular
    task:
      id: 92d1867d-59ca-4ef8-8069-cc273ea1a622
      version: -1
      name: Save password expiry to evidence
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.PasswordNeverExpires
      value:
        complex:
          root: Core.ScriptResult.results.[0].command_output
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: Core.ScriptResult.results.[0].command_output
                iscontext: true
              right:
                value:
                  simple: Password expires
          transformers:
          - operator: DT
            args:
              dt:
                value:
                  simple: '.=val.includes("Never") || val.includes("%%1794") ? "True" : "False"'
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: "False"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 871,
          "y": 866
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: ecb9c9a9-40dc-47c7-8a9d-9a8c9bb2814e
    type: title
    task:
      id: ecb9c9a9-40dc-47c7-8a9d-9a8c9bb2814e
      version: -1
      name: Behavior Checks
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -485,
          "y": 511
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 4f0e652b-d3cb-4ed2-88ad-3224a0f37b9c
    type: condition
    task:
      id: 4f0e652b-d3cb-4ed2-88ad-3224a0f37b9c
      version: -1
      name: Check XQL Query Engine availability
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      "yes":
      - "38"
    scriptarguments:
      brandname:
        simple: XQL Query Engine
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -485,
          "y": 631
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: 3ad53f79-9993-455d-84a2-5e4652337046
    type: regular
    task:
      id: 3ad53f79-9993-455d-84a2-5e4652337046
      version: -1
      name: Command line analysis
      description: |-
        This script evaluates command-line threats by analyzing both original and decoded inputs. It assigns weighted scores to detected patterns, such as AMSI bypass or credential dumping, and applies risk combination bonuses for multiple detections. The total score is normalized to a 0-100 scale, with risk levels categorized as follows:

        * 0-25: Low Risk
        * 26-50: Medium Risk
        * 51-90: High Risk
        * 91-100: Critical Risk

        The scoring mechanism provides a comprehensive risk assessment, considering both the severity and frequency of malicious behaviors.
      scriptName: CommandLineAnalysis
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "36"
    scriptarguments:
      command_line:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Get created user process command lines
          accessor: results.action_process_image_command_line
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -261,
          "y": 1429
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: 504444d0-23fc-4a5c-8394-e7dd83176688
    type: regular
    task:
      id: 504444d0-23fc-4a5c-8394-e7dd83176688
      version: -1
      name: Search created user group memberships
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "33"
      '#none#':
      - "25"
    scriptarguments:
      query:
        simple: |-
          dataset = xdr_data
          | filter event_type = ENUM.EVENT_LOG and action_evtlog_event_id = 4732
          | alter
              Target_SID = trim(arrayindex(regextract(action_evtlog_message, "Member:\s+Security ID:\s+(S-\d+-\d+(?:-\d+)+)"), 0)),
              Group_Name = trim(arrayindex(regextract(action_evtlog_message, "Group Name:[\\t ]*([^\r\n]+)"), 0)),
              Host_Name = trim(arrayindex(regextract(action_evtlog_message, "(?i)Subject:\\r\\n\\tSecurity ID:\\t\\t[^\\r\\n]+\\r\\n\\tAccount Name:\\t\\t[^\\r\\n]+\\r\\n\\tAccount Domain:\\t\\t([^\r\n]+)"), 0))
          | filter Group_Name in (
              "Administrators",
              "Domain Admins",
              "Enterprise Admins",
              "Remote Desktop Users",
              "Backup Operators",
              "Power Users",
              "Account Operators",
              "Server Operators",
              "Print Operators",
              "Device Owners")
              and Target_SID = "${Core.OriginalAlert.event.action_evtlog_data_fields.TargetSid}"
              and lowercase(agent_hostname) = lowercase("${alert.hostname}")
          | fields action_evtlog_message, Target_SID, Group_Name, agent_hostname
      query_name:
        simple: Created user assigned to a privileged group
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -699,
          "y": 1187
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: ccf7e47f-6263-4833-80e4-075001dd96ad
    type: regular
    task:
      id: ccf7e47f-6263-4833-80e4-075001dd96ad
      version: -1
      name: Search created user processes
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "33"
      '#none#':
      - "56"
    scriptarguments:
      query:
        simple: |-
          dataset = xdr_data
          | filter event_type = ENUM.PROCESS
              and lowercase(actor_effective_username) = lowercase("${Core.OriginalAlert.event.normalized_evtlog_target_user}")
              and lowercase(agent_hostname) = lowercase("${alert.hostname}")
          | filter action_process_image_command_line != null
          | dedup actor_effective_username, action_process_image_command_line
          | fields
              _time,
              agent_hostname,
              actor_effective_username,
              action_process_image_command_line
      query_name:
        simple: Get created user process command lines
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -261,
          "y": 1187
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 7fc51c06-3e68-41c8-81b2-932375b6c4d8
    type: regular
    task:
      id: 7fc51c06-3e68-41c8-81b2-932375b6c4d8
      version: -1
      name: Save found privileged groups
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    scriptarguments:
      key:
        simple: CreatedUserAddedToPrivilegedGroup
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Created user assigned to a privileged group
              ignorecase: true
          - - operator: greaterThan
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.number_of_results
                iscontext: true
              right:
                value:
                  simple: "0"
          accessor: results.Group_Name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -699,
          "y": 1305
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: a9dde28a-f631-4ff4-8b90-b1fa76b25df4
    type: regular
    task:
      id: a9dde28a-f631-4ff4-8b90-b1fa76b25df4
      version: -1
      name: Save related alerts to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.RelatedAlerts
      value:
        simple: '${.=val.foundIncidents && val.foundIncidents.id ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1284,
          "y": 743
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: fca79bba-06a8-4dfe-8f6e-1d37d9803213
    type: title
    task:
      id: fca79bba-06a8-4dfe-8f6e-1d37d9803213
      version: -1
      name: Created User Attributes
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "11"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 871,
          "y": 510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: 47c7776f-c9e1-429e-a08d-37027fd4dce4
    type: regular
    task:
      id: 47c7776f-c9e1-429e-a08d-37027fd4dce4
      version: -1
      name: Save host risk to evidence
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.RiskyHost
      value:
        complex:
          root: Core.RiskyHost
          accessor: risk_level
          transformers:
          - operator: DT
            args:
              dt:
                value:
                  simple: '.=val === "HIGH" ? "True" : "False"'
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: "False"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 743
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 1c347b6c-7319-4227-8d80-e6cd1e0a2855
    type: condition
    task:
      id: 1c347b6c-7319-4227-8d80-e6cd1e0a2855
      version: -1
      name: Analyze evidence
      description: Analyzes the evidence to reach a verdict or the alert.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "46"
      True Positive:
      - "40"
    separatecontext: false
    conditions:
    - label: True Positive
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidence
                transformers:
                - operator: DT
                  args:
                    dt:
                      value:
                        simple: .=Object.values(val).filter(value => value == "True").length
            iscontext: true
          right:
            value:
              simple: "3"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1876
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 6d8453cf-58cd-4830-8d9d-43d4c351118d
    type: regular
    task:
      id: 6d8453cf-58cd-4830-8d9d-43d4c351118d
      version: -1
      name: Save privileged group to evidence
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.CreatedUserPrivilegedGroup
      value:
        simple: '${.=val.CreatedUserAddedToPrivilegedGroup ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -699,
          "y": 1429
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: 409d47f7-c6c5-4156-84bd-a8ee36aa7cb6
    type: regular
    task:
      id: 409d47f7-c6c5-4156-84bd-a8ee36aa7cb6
      version: -1
      name: Save suspicious commandlines list
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      key:
        simple: SuspiciousCommandlinesList
      value:
        complex:
          root: CommandLineAnalysis
          filters:
          - - operator: lessThanOrEqual
              left:
                value:
                  simple: CommandLineAnalysis.score
                iscontext: true
              right:
                value:
                  simple: "50"
          accessor: original_command
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -261,
          "y": 1557
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: a56f92e8-d35b-406d-8b46-02beacfbd4c0
    type: regular
    task:
      id: a56f92e8-d35b-406d-8b46-02beacfbd4c0
      version: -1
      name: Save post login count to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidence.SuspiciousProcessCommandlines
      value:
        simple: '${.=val.SuspiciousCommandlinesList ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -261,
          "y": 1679
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: c48ad76a-bbf1-4a5b-8e37-347bcfa88253
    type: regular
    task:
      id: c48ad76a-bbf1-4a5b-8e37-347bcfa88253
      version: -1
      name: Retrieve start time
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "39"
    scriptarguments:
      key:
        simple: QueryStartTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 5 min ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -485,
          "y": 797
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 606e7f53-f228-4a69-8df5-866241e1cf18
    type: regular
    task:
      id: 606e7f53-f228-4a69-8df5-866241e1cf18
      version: -1
      name: Retrieve end time
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "51"
      - "52"
    scriptarguments:
      key:
        simple: QueryEndTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 60 min after
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -485,
          "y": 919
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: a11d7a0f-9ad3-4472-82d3-ab48c337227e
    type: regular
    task:
      id: a11d7a0f-9ad3-4472-82d3-ab48c337227e
      version: -1
      name: Save close reason - true positive
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "41"
    scriptarguments:
      append:
        simple: "false"
      key:
        simple: CloseReason
      value:
        simple: Resolved - True Positive
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2024
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: 48995ab6-aa6e-458b-8943-7829f8a3cfdd
    type: title
    task:
      id: 48995ab6-aa6e-458b-8943-7829f8a3cfdd
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "45"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 449,
          "y": 2154
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 652c02ba-ef65-4c2d-8bfc-d74b5786f45f
    type: regular
    task:
      id: 652c02ba-ef65-4c2d-8bfc-d74b5786f45f
      version: -1
      name: Close Investigation
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    scriptarguments:
      closeReason:
        simple: ${CloseReason}
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2951
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: 849b04b4-54b7-422d-80f8-5915546f13b9
    type: condition
    task:
      id: 849b04b4-54b7-422d-80f8-5915546f13b9
      version: -1
      name: Analyst review - disable suspicious user?
      description: |-
        We found suspicious indicators in this investigation and have taken action by disabling the suspicious local user that was created.

        Review the findings and decide on the next steps:

        ### Alert Information
        The subject (creator) user: `${Core.OriginalAlert.event.normalized_evtlog_subject_user}`

        The target (created) user: `${Core.OriginalAlert.event.evtlog_target_username}`

        Involved Host: `${alert.hostname}`


        ---

        ### Related Alerts
        Suspicious alerts related to either user showing potential evasion or privilege escalation attempts: `${.=val.foundIncidents && val.foundIncidents.length > 0 ? "True" : "False"}`

        Alert names:
        `${foundIncidents.name}`


        ---

        ### User added to privileged groups
        If the created user was added to privileged groups after being created, the group names will be listed below.

        Group names: `${.=val.UserAddedToPrivilegedGroup || "N/A"}`

        ---

        ### Host & User Risk Levels
        Host risk level: `${Core.RiskyHost.risk_level}`

        Creator user risk level: `${Core.RiskyUser.risk_level}`

        ---

        ### Suspicious command line executions
        Created user: `${.=val.SuspiciousCommandlinesList || "N/A"}`
        CMD findings: `${CommandLineAnalysis.findings}`

        Creator user: `${.=val.CreatorSuspiciousCommandlinesList || "N/A"}`
        CMD findings: `${CreatorCommandLineAnalysis.findings}
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "43"
      "Yes":
      - "66"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 449,
          "y": 2389
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
        complex:
          root: Core.OriginalAlert.event.action_evtlog_data_fields
          accessor: SubjectUserName
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: "Would you like to disable the following user? \n"
              suffix: {}
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
      replyOptions:
      - "Yes"
      - "No"
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: 8940c279-192e-4b96-89f4-b473efd965d2
    type: regular
    task:
      id: 8940c279-192e-4b96-89f4-b473efd965d2
      version: -1
      name: Disable local user
      description: Runs Powershell code on the affected host to disable the local user on the machine.
      script: '|||core-run-script-execute-commands'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "44"
    scriptarguments:
      command_type:
        simple: native
      commands:
        complex:
          root: Core.OriginalAlert.event
          accessor: evtlog_target_username
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: powershell -Command Disable-LocalUser -Name "
              suffix:
                value:
                  simple: '"'
      endpoint_ids:
        complex:
          root: alert
          accessor: agentid
          transformers:
          - operator: uniq
      is_raw_command:
        simple: "true"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 449,
          "y": 2265
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: c9d4dc13-fd92-49b0-8321-7dc11f10109b
    type: title
    task:
      id: c9d4dc13-fd92-49b0-8321-7dc11f10109b
      version: -1
      name: Inconclusive
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 871,
          "y": 2154
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: 3cc0f3de-19ca-46ab-86eb-2dd951113c95
    type: title
    task:
      id: 3cc0f3de-19ca-46ab-86eb-2dd951113c95
      version: -1
      name: User Risk
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "49"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 6,
          "y": 510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "49":
    id: "49"
    taskid: 0214b6ed-d0d7-4d91-8704-d6af8bf6e1ee
    type: regular
    task:
      id: 0214b6ed-d0d7-4d91-8704-d6af8bf6e1ee
      version: -1
      name: Get creator user info & risk level
      description: This script gathers user data from multiple integrations and returns an Account entity with consolidated information to the context.
      scriptName: get-user-data
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "50"
    scriptarguments:
      user_name:
        complex:
          root: Core.OriginalAlert.event
          accessor: evtlog_subject_username
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: Core.OriginalAlert.event.normalized_evtlog_subject_user
                iscontext: true
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 6,
          "y": 620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "50":
    id: "50"
    taskid: 24463b46-7ad2-44ec-83a6-6652790f2038
    type: regular
    task:
      id: 24463b46-7ad2-44ec-83a6-6652790f2038
      version: -1
      name: Save creator user risk to evidence
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.CreatorUserRisky
      value:
        complex:
          root: UserData
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: UserData.Username
                iscontext: true
              right:
                value:
                  simple: Core.OriginalAlert.event.normalized_evtlog_subject_user
                iscontext: true
          - - operator: isEqualString
              left:
                value:
                  simple: UserData.Source
                iscontext: true
              right:
                value:
                  simple: Cortex Core - IR
          accessor: RiskLevel
          transformers:
          - operator: DT
            args:
              dt:
                value:
                  simple: '.=val === "HIGH" ? "True" : "False"'
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: "False"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 6,
          "y": 743
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "51":
    id: "51"
    taskid: 1fd20b89-1a2a-498f-843b-4febe158e5a8
    type: title
    task:
      id: 1fd20b89-1a2a-498f-843b-4febe158e5a8
      version: -1
      name: 'Created User '
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "22"
      - "20"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -485,
          "y": 1057
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: 5140a36b-3291-49cb-8f9c-03f0507d8841
    type: title
    task:
      id: 5140a36b-3291-49cb-8f9c-03f0507d8841
      version: -1
      name: Creator User
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "53"
      - "63"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1402,
          "y": 1057
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "53":
    id: "53"
    taskid: 6584bf50-bac1-440b-820c-e93f3dce0af6
    type: regular
    task:
      id: 6584bf50-bac1-440b-820c-e93f3dce0af6
      version: -1
      name: Search creator user processes
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "33"
      '#none#':
      - "54"
    scriptarguments:
      query:
        simple: |-
          dataset = xdr_data
          | filter event_type = ENUM.PROCESS
              and lowercase(actor_effective_username) = lowercase("${Core.OriginalAlert.event.normalized_evtlog_subject_user}")
              and lowercase(agent_hostname) = lowercase("${alert.hostname}")
          | filter action_process_image_command_line != null
          | dedup actor_effective_username, action_process_image_command_line
          | fields
              _time,
              agent_hostname,
              actor_effective_username,
              action_process_image_command_line
      query_name:
        simple: Get creator user process command lines
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -1174,
          "y": 1187
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "54":
    id: "54"
    taskid: 36bd9515-5613-4a64-8d4b-ff0d7de8b278
    type: condition
    task:
      id: 36bd9515-5613-4a64-8d4b-ff0d7de8b278
      version: -1
      name: Check process command line results
      description: Check if any results were retrivied.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "58"
      "yes":
      - "55"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.GenericQuery
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.query_name
                      iscontext: true
                    right:
                      value:
                        simple: Get creator user process command lines
                accessor: results.action_process_image_command_line
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1174,
          "y": 1305
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "55":
    id: "55"
    taskid: f41985d0-e673-41d5-8a9d-dbbc5346f4ad
    type: regular
    task:
      id: f41985d0-e673-41d5-8a9d-dbbc5346f4ad
      version: -1
      name: Command line analysis
      description: |-
        This script evaluates command-line threats by analyzing both original and decoded inputs. It assigns weighted scores to detected patterns, such as AMSI bypass or credential dumping, and applies risk combination bonuses for multiple detections. The total score is normalized to a 0-100 scale, with risk levels categorized as follows:

        * 0-25: Low Risk
        * 26-50: Medium Risk
        * 51-90: High Risk
        * 91-100: Critical Risk

        The scoring mechanism provides a comprehensive risk assessment, considering both the severity and frequency of malicious behaviors.
      scriptName: CommandLineAnalysis
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "57"
    scriptarguments:
      command_line:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Get creator user process command lines
          accessor: results.action_process_image_command_line
          transformers:
          - operator: uniq
      extend-context:
        simple: CreatorCommandLineAnalysis=
      ignore-outputs:
        simple: "true"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1174,
          "y": 1449
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "56":
    id: "56"
    taskid: bc09d3bd-4fef-492a-8b88-855ac3cd370f
    type: condition
    task:
      id: bc09d3bd-4fef-492a-8b88-855ac3cd370f
      version: -1
      name: Check process command line results
      description: Check if any results were retrivied.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "37"
      "yes":
      - "19"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.GenericQuery
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.query_name
                      iscontext: true
                    right:
                      value:
                        simple: Get created user process command lines
                accessor: results.action_process_image_command_line
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -261,
          "y": 1305
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "57":
    id: "57"
    taskid: 0a7dd1d4-f80d-4f30-853b-e10984dbfe6a
    type: regular
    task:
      id: 0a7dd1d4-f80d-4f30-853b-e10984dbfe6a
      version: -1
      name: Save suspicious commandlines list
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "58"
    scriptarguments:
      key:
        simple: CreatorSuspiciousCommandlinesList
      value:
        complex:
          root: CreatorCommandLineAnalysis
          filters:
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: CreatorCommandLineAnalysis.score
                iscontext: true
              right:
                value:
                  simple: "50"
          accessor: original_command
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1174,
          "y": 1569
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "58":
    id: "58"
    taskid: 9d6fd1a3-665f-470e-882d-d036d2a9e972
    type: regular
    task:
      id: 9d6fd1a3-665f-470e-882d-d036d2a9e972
      version: -1
      name: Save post login count to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidence.CreatorSuspiciousProcessCommandlines
      value:
        simple: '${.=val.CreatorSuspiciousCommandlinesList ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1174,
          "y": 1690
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "62":
    id: "62"
    taskid: 0a125e80-1f1d-4ba0-8bfa-4a68323aa70d
    type: regular
    task:
      id: 0a125e80-1f1d-4ba0-8bfa-4a68323aa70d
      version: -1
      name: Search user creation history
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "33"
      '#none#':
      - "64"
    scriptarguments:
      query:
        simple: "dataset = xdr_data\n| filter event_type = ENUM.EVENT_LOG and action_evtlog_event_id = 4720\n| alter \n    Subject_User_SID = action_evtlog_data_fields -> SubjectUserSid, \n    Subject_Username = action_evtlog_data_fields -> SubjectUserName\n| filter lowercase(Subject_User_SID) = lowercase(\"${Core.OriginalAlert.event.action_evtlog_data_fields.SubjectUserSid}\")\n| comp count() as user_creation_count"
      query_name:
        simple: Get user creation history for a user
      time_frame:
        simple: between ${CreatorHistoryQueryStartTime} and ${alert.timestamp}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -1591,
          "y": 1305
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "63":
    id: "63"
    taskid: c4a1eef3-d655-431c-874c-c5352319d317
    type: regular
    task:
      id: c4a1eef3-d655-431c-874c-c5352319d317
      version: -1
      name: Query start time - 3 months ago
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "62"
    scriptarguments:
      key:
        simple: CreatorHistoryQueryStartTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 90 days ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1591,
          "y": 1187
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "64":
    id: "64"
    taskid: 73a9fadf-dbac-412d-8239-a601918985bb
    type: regular
    task:
      id: 73a9fadf-dbac-412d-8239-a601918985bb
      version: -1
      name: Save past creations count
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: CreatorPastCreationCount
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Get user creation history for a user
          accessor: results.user_creation_count
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1591,
          "y": 1449
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "66":
    id: "66"
    taskid: b6369b75-af3f-40bb-8bc8-86eb7b3d3385
    type: title
    task:
      id: b6369b75-af3f-40bb-8bc8-86eb7b3d3385
      version: -1
      name: Creator User Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "71"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 786,
          "y": 2526
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "67":
    id: "67"
    taskid: 7e1080e0-0c29-45bb-8b34-73d4bc9bc125
    type: regular
    task:
      id: 7e1080e0-0c29-45bb-8b34-73d4bc9bc125
      version: -1
      name: Disable creator locally
      description: Runs Powershell code on the affected host to disable the local user on the machine.
      script: '|||core-run-script-execute-commands'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      command_type:
        simple: native
      commands:
        complex:
          root: Core.OriginalAlert.event.action_evtlog_data_fields
          accessor: SubjectUserName
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: powershell -Command Disable-LocalUser -Name "
              suffix:
                value:
                  simple: '"'
      endpoint_ids:
        complex:
          root: alert
          accessor: agentid
          transformers:
          - operator: uniq
      is_raw_command:
        simple: "true"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1186,
          "y": 2804
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "70":
    id: "70"
    taskid: ed49a894-45a8-4571-8d11-008c7dbcd124
    type: regular
    task:
      id: ed49a894-45a8-4571-8d11-008c7dbcd124
      version: -1
      name: Undetermined user type - manual
      description: |-
        Active Directory was unavailable, and user details for "${Core.OriginalAlert.event.action_evtlog_data_fields.SubjectUserName}" could not be retrieved.

        Determine whether the user is a domain user or a local user. Then, proceed to disable the account either in Active Directory or locally on the host where the alert was triggered.

        Complete this task only after ensuring that the alert can be closed.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1584,
          "y": 2804
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "71":
    id: "71"
    taskid: 3c0b772a-4af3-4427-8a9d-92a49ea8adde
    type: condition
    task:
      id: 3c0b772a-4af3-4427-8a9d-92a49ea8adde
      version: -1
      name: Check user type
      description: Checks if the user is a local or domain user.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "67"
      Domain:
      - "72"
      Undetermined:
      - "70"
    separatecontext: false
    conditions:
    - label: Undetermined
      condition:
      - - operator: isEmpty
          left:
            value:
              complex:
                root: UserData.Source
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: UserData.Source
                      iscontext: true
                    right:
                      value:
                        simple: Active Directory Query v2
            iscontext: true
    - label: Domain
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: UserData
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: UserData.Username
                      iscontext: true
                    right:
                      value:
                        simple: Core.OriginalAlert.event.evtlog_subject_username
                      iscontext: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: UserData.Source
                      iscontext: true
                    right:
                      value:
                        simple: Active Directory Query v2
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 786,
          "y": 2636
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "72":
    id: "72"
    taskid: dd1bf520-abe8-46b8-8473-5c789cb3079d
    type: regular
    task:
      id: dd1bf520-abe8-46b8-8473-5c789cb3079d
      version: -1
      name: Disable creator in Active Directory
      description: Disables an Active Directory user account.
      script: '|||ad-disable-account'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      username:
        complex:
          root: Core.OriginalAlert.event.action_evtlog_data_fields
          accessor: SubjectUserName
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 786,
          "y": 2804
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "18_33_#default#": 0.1,
      "18_38_yes": 0.5,
      "20_33_#error#": 0.14,
      "22_33_#error#": 0.32,
      "33_40_True Positive": 0.34,
      "33_46_#default#": 0.61,
      "44_43_#default#": 0.11,
      "53_33_#error#": 0.1,
      "54_58_#default#": 0.29,
      "56_37_#default#": 0.25,
      "62_33_#error#": 0.1,
      "71_72_Domain": 0.45
    },
    "paper": {
      "dimensions": {
        "height": 2991,
        "width": 3556,
        "x": -1591,
        "y": 30
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 8.9.0
issilent: true
