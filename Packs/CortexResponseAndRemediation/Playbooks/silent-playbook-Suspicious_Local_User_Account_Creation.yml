id: silent-Suspicious Local User Account Creation
version: -1
name: silent-Suspicious Local User Account Creation
description: |-
  This playbook addresses the following alerts:
  - Suspicious Local User Account Creation

  Playbook Stages:

  Triage:
  - Retrieve extra information about the alert, such as the SID of the created user.

  Investigation:
  - Get host risk level for the machine where the user was created.
  - Search for related alerts in the incident that hint of privilege escalation or persistence.
  - Retrieve local user password expiration status using PowerShell commands.
  - Get creator user risk level from the system.
  - Search for privileged group memberships of the created user (Administrators, Domain Admins, etc.).
  - Analyze command line executions for both created user and creator user to detect suspicious activities.
  - Check creator's historical user creation patterns.

  Containment:
  - Analyze evidence using multiple indicators to determine if the alert is a true positive, false positive, or inconclusive.
  - For true positives: Automatically disable the suspicious local user account.
  - Present analyst review with comprehensive findings including related alerts, privileged groups, host/user risk levels, and suspicious command lines.
  - Upon analyst approval: Disable the creator user account either locally or in Active Directory based on user type detection.

  Requirements:

  For response actions, you need the following integrations:
  - Cortex Core - Investigation and Response
  - Active Directory Query v2.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: af676245-8028-4b4c-8001-78e53cc617e4
    type: start
    task:
      id: af676245-8028-4b4c-8001-78e53cc617e4
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 30
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 40bda7d5-cb4b-4725-8ab9-47ac9fd6b93f
    type: regular
    task:
      id: 40bda7d5-cb4b-4725-8ab9-47ac9fd6b93f
      version: -1
      name: Get event information
      description: Retrieves extra information about the alert, such as the SID of the created user.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 277
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 5591f225-71f8-488d-8aa3-6a89dc4264e0
    type: title
    task:
      id: 5591f225-71f8-488d-8aa3-6a89dc4264e0
      version: -1
      name: Triage
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 158
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: cbcd3f2e-0cd7-44ab-86a3-e81ae69f1d7f
    type: title
    task:
      id: cbcd3f2e-0cd7-44ab-86a3-e81ae69f1d7f
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "13"
      - "12"
      - "31"
      - "17"
      - "48"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 388
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 212c71c0-5233-4233-b7d4-2ed825a3e6c9
    type: regular
    task:
      id: 212c71c0-5233-4233-b7d4-2ed825a3e6c9
      version: -1
      name: Get host risk level
      description: This script gathers endpoint data from multiple integrations and returns an endpoint entity with consolidated information to the context.
      type: regular
      iscommand: false
      brand: ""
      scriptName: get-endpoint-data
    nexttasks:
      '#none#':
      - "78"
    scriptarguments:
      endpoint_id:
        simple: ${alert.agentid}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1511,
          "y": 622
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 895db559-6a34-432b-8aee-0027c3b21fd3
    type: regular
    task:
      id: 895db559-6a34-432b-8aee-0027c3b21fd3
      version: -1
      name: Search suspicious user activity alerts
      description: Searches for known related alerts in the same case.
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      query:
        complex:
          root: alert
          accessor: parentXDRIncident
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '-'
              fields:
                value:
                  simple: "2"
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'caseid:'
              suffix:
                value:
                  simple: ' and (name:"Masquerading as a default local account for the first time" or name:"Execution of an uncommon process with a local/domain user SID at an early startup stage with suspicious characteristics" or name:"Privilege Escalation - 1216127025" or name:"Suspicious disablement of the Windows Firewall" or name:"PowerShell runs suspicious base64-encoded commands")'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 621
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: c6f3e9a9-cc23-4b73-99ee-0754eb0d227e
    type: regular
    task:
      id: c6f3e9a9-cc23-4b73-99ee-0754eb0d227e
      version: -1
      name: Retrieve local user password status
      description: Run a shell command on a specific endpoint and return its result.
      script: '|||core-execute-command'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      command_type:
        simple: native
      endpoint_ids:
        complex:
          root: alert
          accessor: agentid
          transformers:
          - operator: uniq
      command:
        complex:
          root: Core.OriginalAlert.event
          accessor: evtlog_target_username
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'powershell -Command "NET USER '
              suffix:
                value:
                  simple: '"'
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -16,
          "y": 622
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 68738a22-937f-4cbe-8c6d-b0d015d84b4d
    type: title
    task:
      id: 68738a22-937f-4cbe-8c6d-b0d015d84b4d
      version: -1
      name: Host Risk
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "5"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1511,
          "y": 512
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 96dacab6-58e5-4ff1-869b-05a41683945d
    type: title
    task:
      id: 96dacab6-58e5-4ff1-869b-05a41683945d
      version: -1
      name: Related Alerts
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "6"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 513
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: ef272a04-a9df-482a-a9c0-437a5e29ded5
    type: regular
    task:
      id: ef272a04-a9df-482a-a9c0-437a5e29ded5
      version: -1
      name: Save password expiry to evidence
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.PasswordNeverExpires
      value:
        complex:
          root: Core.ScriptResult.results.executed_command.command_output
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: Core.ScriptResult.results.executed_command.command_output
                iscontext: true
              right:
                value:
                  simple: Password expires
              ignorecase: true
          - - operator: containsGeneral
              left:
                value:
                  simple: Core.ScriptResult.results.executed_command.command_output
                iscontext: true
              right:
                value:
                  simple: Never
              ignorecase: true
            - operator: containsGeneral
              left:
                value:
                  simple: Core.ScriptResult.results.executed_command.command_output
                iscontext: true
              right:
                value:
                  simple: '%%1794'
          transformers:
          - operator: DT
            args:
              dt:
                value:
                  simple: '.=val ? "True" : "False"'
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: "False"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -16,
          "y": 745
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 18c1b3f8-fb2b-4cd4-8115-371f845c3ec4
    type: title
    task:
      id: 18c1b3f8-fb2b-4cd4-8115-371f845c3ec4
      version: -1
      name: Behavior Checks
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -601,
          "y": 509
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: f5624764-1fdf-4689-813a-88ddbd2f33b1
    type: condition
    task:
      id: f5624764-1fdf-4689-813a-88ddbd2f33b1
      version: -1
      name: Check XQL Query Engine availability
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      "yes":
      - "38"
    scriptarguments:
      brandname:
        simple: XQL Query Engine
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -601,
          "y": 629
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: 6ea1237a-86f2-42ad-8e3d-ff27cc92b5d6
    type: regular
    task:
      id: 6ea1237a-86f2-42ad-8e3d-ff27cc92b5d6
      version: -1
      name: Command line analysis
      description: |-
        This script evaluates command-line threats by analyzing both original and decoded inputs. It assigns weighted scores to detected patterns, such as AMSI bypass or credential dumping, and applies risk combination bonuses for multiple detections. The total score is normalized to a 0-100 scale, with risk levels categorized as follows:

        * 0-25: Low Risk
        * 26-50: Medium Risk
        * 51-90: High Risk
        * 91-100: Critical Risk

        The scoring mechanism provides a comprehensive risk assessment, considering both the severity and frequency of malicious behaviors.
      scriptName: CommandLineAnalysis
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "36"
    scriptarguments:
      command_line:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Get created user process command lines
          accessor: results.action_process_image_command_line
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -377,
          "y": 1427
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: 5559eab4-6f0a-4417-819c-8f83f9326238
    type: regular
    task:
      id: 5559eab4-6f0a-4417-819c-8f83f9326238
      version: -1
      name: Search created user group memberships
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "33"
      '#none#':
      - "25"
    scriptarguments:
      query:
        simple: |-
          dataset = xdr_data
          | filter event_type = ENUM.EVENT_LOG and action_evtlog_event_id = 4732
          | alter
              Target_SID = trim(arrayindex(regextract(action_evtlog_message, "Member:\s+Security ID:\s+(S-\d+-\d+(?:-\d+)+)"), 0)),
              Group_Name = trim(arrayindex(regextract(action_evtlog_message, "Group Name:[\\t ]*([^\r\n]+)"), 0)),
              Host_Name = trim(arrayindex(regextract(action_evtlog_message, "(?i)Subject:\\r\\n\\tSecurity ID:\\t\\t[^\\r\\n]+\\r\\n\\tAccount Name:\\t\\t[^\\r\\n]+\\r\\n\\tAccount Domain:\\t\\t([^\r\n]+)"), 0))
          | filter Group_Name in (
              "Administrators",
              "Domain Admins",
              "Enterprise Admins",
              "Remote Desktop Users",
              "Backup Operators",
              "Power Users",
              "Account Operators",
              "Server Operators",
              "Print Operators",
              "Device Owners")
              and Target_SID = "${Core.OriginalAlert.event.action_evtlog_data_fields.TargetSid}"
              and lowercase(agent_hostname) = lowercase("${alert.hostname}")
          | fields action_evtlog_message, Target_SID, Group_Name, agent_hostname
      query_name:
        simple: Created user assigned to a privileged group
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -815,
          "y": 1185
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 15aa42dc-2478-4c95-853b-bd1a593a766f
    type: regular
    task:
      id: 15aa42dc-2478-4c95-853b-bd1a593a766f
      version: -1
      name: Search created user processes
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "33"
      '#none#':
      - "56"
    scriptarguments:
      query:
        simple: |-
          dataset = xdr_data
          | filter event_type = ENUM.PROCESS
              and lowercase(actor_effective_username) = lowercase("${Core.OriginalAlert.event.normalized_evtlog_target_user}")
              and lowercase(agent_hostname) = lowercase("${alert.hostname}")
          | filter action_process_image_command_line != null
          | dedup actor_effective_username, action_process_image_command_line
          | fields
              _time,
              agent_hostname,
              actor_effective_username,
              action_process_image_command_line
      query_name:
        simple: Get created user process command lines
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -377,
          "y": 1185
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 9683d3f7-43ae-4570-80e5-d7b62f3be296
    type: regular
    task:
      id: 9683d3f7-43ae-4570-80e5-d7b62f3be296
      version: -1
      name: Save found privileged groups
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    scriptarguments:
      key:
        simple: CreatedUserAddedToPrivilegedGroup
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Created user assigned to a privileged group
              ignorecase: true
          - - operator: greaterThan
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.number_of_results
                iscontext: true
              right:
                value:
                  simple: "0"
          accessor: results.Group_Name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -815,
          "y": 1303
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 6bd132a8-fea1-424d-8161-aefe39412a43
    type: regular
    task:
      id: 6bd132a8-fea1-424d-8161-aefe39412a43
      version: -1
      name: Save related alerts to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.RelatedAlerts
      value:
        simple: '${.=val.foundIncidents && val.foundIncidents.id ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 744
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: b542c756-30ae-4cd3-8004-7f8e3280465f
    type: title
    task:
      id: b542c756-30ae-4cd3-8004-7f8e3280465f
      version: -1
      name: Created User Attributes
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "11"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -16,
          "y": 512
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: 7cf6006a-9dfc-4159-988e-7a974277170a
    type: regular
    task:
      id: 7cf6006a-9dfc-4159-988e-7a974277170a
      version: -1
      name: Save host risk to evidence
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.RiskyHost
      value:
        simple: "True"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1667,
          "y": 991
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 17c8832d-493d-4deb-8210-8bbe649587ab
    type: condition
    task:
      id: 17c8832d-493d-4deb-8210-8bbe649587ab
      version: -1
      name: Analyze evidence
      description: Analyzes the evidence to reach a verdict or the alert.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "46"
      True Positive:
      - "85"
    separatecontext: false
    conditions:
    - label: True Positive
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidence
                transformers:
                - operator: DT
                  args:
                    dt:
                      value:
                        simple: .=Object.values(val).filter(value => value == "True").length
            iscontext: true
          right:
            value:
              simple: "3"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1863
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 4fd6a3b6-bc43-41da-83e9-02ead2f46934
    type: regular
    task:
      id: 4fd6a3b6-bc43-41da-83e9-02ead2f46934
      version: -1
      name: Save privileged group to evidence
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.CreatedUserPrivilegedGroup
      value:
        simple: '${.=val.CreatedUserAddedToPrivilegedGroup ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -815,
          "y": 1427
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: 6c7c08c0-a73b-412f-86c3-dac8cc4f8451
    type: regular
    task:
      id: 6c7c08c0-a73b-412f-86c3-dac8cc4f8451
      version: -1
      name: Save suspicious commandlines list
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      key:
        simple: SuspiciousCommandlinesList
      value:
        complex:
          root: CommandLineAnalysis
          filters:
          - - operator: lessThanOrEqual
              left:
                value:
                  simple: CommandLineAnalysis.score
                iscontext: true
              right:
                value:
                  simple: "50"
          accessor: original_command
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -377,
          "y": 1555
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: aa7a7d71-df8c-4c67-8508-7ca8d0eea195
    type: regular
    task:
      id: aa7a7d71-df8c-4c67-8508-7ca8d0eea195
      version: -1
      name: Save post login count to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidence.SuspiciousProcessCommandlines
      value:
        simple: '${.=val.SuspiciousCommandlinesList ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -377,
          "y": 1677
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: c8572659-11a5-4de2-8079-bb2d772408d1
    type: regular
    task:
      id: c8572659-11a5-4de2-8079-bb2d772408d1
      version: -1
      name: Retrieve start time
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "39"
    scriptarguments:
      key:
        simple: QueryStartTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 5 min ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -601,
          "y": 795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 022d862d-21a9-44b9-85ff-e16cbe0ba66c
    type: regular
    task:
      id: 022d862d-21a9-44b9-85ff-e16cbe0ba66c
      version: -1
      name: Retrieve end time
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "51"
      - "52"
    scriptarguments:
      key:
        simple: QueryEndTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 60 min after
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -601,
          "y": 917
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: 0c5995cc-28b5-43c5-8c27-1a4da494e7cb
    type: title
    task:
      id: 0c5995cc-28b5-43c5-8c27-1a4da494e7cb
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "45"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 452,
          "y": 2130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 1de6c5a3-4057-441e-98aa-275a5478dac7
    type: regular
    task:
      id: 1de6c5a3-4057-441e-98aa-275a5478dac7
      version: -1
      name: Close Investigation
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    scriptarguments:
      closeReason:
        simple: Resolved - True Positive
      id:
        simple: ${alert.id}
      closeNotes:
        simple: Handled by the playbook “Suspicious Local User Account Creation”.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 447,
          "y": 2938
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: 5d81f19d-03a9-4c5d-a5fd-6c6aaaa013e6
    type: condition
    task:
      id: 5d81f19d-03a9-4c5d-a5fd-6c6aaaa013e6
      version: -1
      name: Analyst review - disable suspicious user?
      description: |-
        We found suspicious indicators in this investigation and have taken action by disabling the suspicious local user that was created.

        Review the findings and decide on the next steps:

        ### Alert Information
        The subject (creator) user: `${Core.OriginalAlert.event.normalized_evtlog_subject_user}`

        The target (created) user: `${Core.OriginalAlert.event.evtlog_target_username}`

        Involved Host: `${alert.hostname}`


        ---

        ### Related Alerts
        Suspicious alerts related to either user showing potential evasion or privilege escalation attempts: `${.=val.foundIncidents && val.foundIncidents.length > 0 ? "True" : "False"}`

        Alert names:
        `${foundIncidents.name}`


        ---

        ### User added to privileged groups
        If the created user was added to privileged groups after being created, the group names will be listed below.

        Group names: `${.=val.UserAddedToPrivilegedGroup || "N/A"}`

        ---

        ### Host & User Risk Levels
        Host risk level: `${EndpointData.RiskLevel}`

        Creator user risk level: `${UserData.RiskLevel}`

        ---

        ### Suspicious command line executions
        Created user: `${.=val.SuspiciousCommandlinesList || "N/A"}`
        CMD findings: `${CommandLineAnalysis.findings}`

        Creator user: `${.=val.CreatorSuspiciousCommandlinesList || "N/A"}`
        CMD findings: `${CreatorCommandLineAnalysis.findings}
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "43"
      "Yes":
      - "66"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 452,
          "y": 2365
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
        complex:
          root: Core.OriginalAlert.event.action_evtlog_data_fields
          accessor: SubjectUserName
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: "Would you like to disable the following user? \n"
              suffix: {}
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
      replyOptions:
      - "Yes"
      - "No"
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: 2132b36e-285f-44dd-8679-a90dbb1125dd
    type: regular
    task:
      id: 2132b36e-285f-44dd-8679-a90dbb1125dd
      version: -1
      name: Disable local user
      description: Run a shell command on a specific endpoint and return its result.
      script: '|||core-execute-command'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "44"
    scriptarguments:
      command_type:
        simple: native
      endpoint_ids:
        complex:
          root: alert
          accessor: agentid
          transformers:
          - operator: uniq
      is_raw_command:
        simple: "true"
      command:
        complex:
          root: Core.OriginalAlert.event
          accessor: evtlog_target_username
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: powershell -Command Disable-LocalUser -Name "
              suffix:
                value:
                  simple: '"'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 452,
          "y": 2241
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: 10ec2ee2-ca1f-459a-87d0-9e9ee69c1821
    type: title
    task:
      id: 10ec2ee2-ca1f-459a-87d0-9e9ee69c1821
      version: -1
      name: Inconclusive
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 874,
          "y": 2130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: 0fbfef77-8b6f-45bf-801f-79f157b623ef
    type: title
    task:
      id: 0fbfef77-8b6f-45bf-801f-79f157b623ef
      version: -1
      name: User Risk
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "49"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 946,
          "y": 512
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "49":
    id: "49"
    taskid: 69192dd4-e6db-4d47-ac7f-80609d90aac5
    type: regular
    task:
      id: 69192dd4-e6db-4d47-ac7f-80609d90aac5
      version: -1
      name: Get creator user info & risk level
      description: This script gathers user data from multiple integrations and returns an Account entity with consolidated information to the context.
      scriptName: get-user-data
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "81"
    scriptarguments:
      user_name:
        complex:
          root: Core.OriginalAlert.event
          accessor: evtlog_subject_username
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: Core.OriginalAlert.event.normalized_evtlog_subject_user
                iscontext: true
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 946,
          "y": 624
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "50":
    id: "50"
    taskid: 1a0521a5-2a5f-4c12-b9a1-137873d19e09
    type: regular
    task:
      id: 1a0521a5-2a5f-4c12-b9a1-137873d19e09
      version: -1
      name: Save creator user risk to evidence
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.CreatorUserRisky
      value:
        simple: "True"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1088,
          "y": 991
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "51":
    id: "51"
    taskid: 4f3c1115-9b61-4783-8903-f0a7a0950df1
    type: title
    task:
      id: 4f3c1115-9b61-4783-8903-f0a7a0950df1
      version: -1
      name: 'Created User '
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "22"
      - "20"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -601,
          "y": 1055
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: 829b1e43-c254-4f89-8764-34ec80dd2c1d
    type: title
    task:
      id: 829b1e43-c254-4f89-8764-34ec80dd2c1d
      version: -1
      name: Creator User
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "53"
      - "63"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1518,
          "y": 1055
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "53":
    id: "53"
    taskid: 1fc78e38-4fb7-402b-8539-6c9279e8b8bf
    type: regular
    task:
      id: 1fc78e38-4fb7-402b-8539-6c9279e8b8bf
      version: -1
      name: Search creator user processes
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "33"
      '#none#':
      - "54"
    scriptarguments:
      query:
        simple: |-
          dataset = xdr_data
          | filter event_type = ENUM.PROCESS
              and lowercase(actor_effective_username) = lowercase("${Core.OriginalAlert.event.normalized_evtlog_subject_user}")
              and lowercase(agent_hostname) = lowercase("${alert.hostname}")
          | filter action_process_image_command_line != null
          | dedup actor_effective_username, action_process_image_command_line
          | fields
              _time,
              agent_hostname,
              actor_effective_username,
              action_process_image_command_line
      query_name:
        simple: Get creator user process command lines
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -1290,
          "y": 1185
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "54":
    id: "54"
    taskid: 1c2a5f38-b2f7-4522-83a5-165bce196350
    type: condition
    task:
      id: 1c2a5f38-b2f7-4522-83a5-165bce196350
      version: -1
      name: Check process command line results
      description: Check if any results were retrivied.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "58"
      "yes":
      - "55"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.GenericQuery
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.query_name
                      iscontext: true
                    right:
                      value:
                        simple: Get creator user process command lines
                accessor: results.action_process_image_command_line
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1290,
          "y": 1303
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "55":
    id: "55"
    taskid: 6bb7306a-ce33-4468-8aa6-09360506e634
    type: regular
    task:
      id: 6bb7306a-ce33-4468-8aa6-09360506e634
      version: -1
      name: Command line analysis
      description: |-
        This script evaluates command-line threats by analyzing both original and decoded inputs. It assigns weighted scores to detected patterns, such as AMSI bypass or credential dumping, and applies risk combination bonuses for multiple detections. The total score is normalized to a 0-100 scale, with risk levels categorized as follows:

        * 0-25: Low Risk
        * 26-50: Medium Risk
        * 51-90: High Risk
        * 91-100: Critical Risk

        The scoring mechanism provides a comprehensive risk assessment, considering both the severity and frequency of malicious behaviors.
      scriptName: CommandLineAnalysis
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "57"
    scriptarguments:
      command_line:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Get creator user process command lines
          accessor: results.action_process_image_command_line
          transformers:
          - operator: uniq
      extend-context:
        simple: CreatorCommandLineAnalysis=
      ignore-outputs:
        simple: "true"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1290,
          "y": 1447
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "56":
    id: "56"
    taskid: 39a4529a-5a82-40ed-870b-0bc93848b40f
    type: condition
    task:
      id: 39a4529a-5a82-40ed-870b-0bc93848b40f
      version: -1
      name: Check process command line results
      description: Check if any results were retrivied.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "37"
      "yes":
      - "19"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.GenericQuery
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.query_name
                      iscontext: true
                    right:
                      value:
                        simple: Get created user process command lines
                accessor: results.action_process_image_command_line
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -377,
          "y": 1303
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "57":
    id: "57"
    taskid: bd9bddea-5b32-4607-86e4-283689ea8753
    type: regular
    task:
      id: bd9bddea-5b32-4607-86e4-283689ea8753
      version: -1
      name: Save suspicious commandlines list
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "58"
    scriptarguments:
      key:
        simple: CreatorSuspiciousCommandlinesList
      value:
        complex:
          root: CreatorCommandLineAnalysis
          filters:
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: CreatorCommandLineAnalysis.score
                iscontext: true
              right:
                value:
                  simple: "50"
          accessor: original_command
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1290,
          "y": 1567
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "58":
    id: "58"
    taskid: 82a1af65-046d-47f0-88fa-f5e720955326
    type: regular
    task:
      id: 82a1af65-046d-47f0-88fa-f5e720955326
      version: -1
      name: Save post login count to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidence.CreatorSuspiciousProcessCommandlines
      value:
        simple: '${.=val.CreatorSuspiciousCommandlinesList ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1290,
          "y": 1688
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "62":
    id: "62"
    taskid: ba714af5-6bf2-4f43-8842-372c138d8760
    type: regular
    task:
      id: ba714af5-6bf2-4f43-8842-372c138d8760
      version: -1
      name: Search user creation history
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "33"
      '#none#':
      - "64"
    scriptarguments:
      query:
        simple: "dataset = xdr_data\n| filter event_type = ENUM.EVENT_LOG and action_evtlog_event_id = 4720\n| alter \n    Subject_User_SID = action_evtlog_data_fields -> SubjectUserSid, \n    Subject_Username = action_evtlog_data_fields -> SubjectUserName\n| filter lowercase(Subject_User_SID) = lowercase(\"${Core.OriginalAlert.event.action_evtlog_data_fields.SubjectUserSid}\")\n| comp count() as user_creation_count"
      query_name:
        simple: Get user creation history for a user
      time_frame:
        simple: between ${CreatorHistoryQueryStartTime} and ${alert.timestamp}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -1707,
          "y": 1303
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "63":
    id: "63"
    taskid: c14af013-3646-4a99-8ed9-8d9a14cd3f25
    type: regular
    task:
      id: c14af013-3646-4a99-8ed9-8d9a14cd3f25
      version: -1
      name: Query start time - 3 months ago
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "62"
    scriptarguments:
      key:
        simple: CreatorHistoryQueryStartTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 90 days ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1707,
          "y": 1185
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "64":
    id: "64"
    taskid: c469ea18-2b12-4f55-8330-3afbe367c85e
    type: regular
    task:
      id: c469ea18-2b12-4f55-8330-3afbe367c85e
      version: -1
      name: Save past creations count
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: CreatorPastCreationCount
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Get user creation history for a user
          accessor: results.user_creation_count
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1707,
          "y": 1447
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "66":
    id: "66"
    taskid: 54318302-afdf-4540-8f69-e21e7a201085
    type: title
    task:
      id: 54318302-afdf-4540-8f69-e21e7a201085
      version: -1
      name: Creator User Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "71"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 783,
          "y": 2513
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "67":
    id: "67"
    taskid: 267cc42c-e34b-4f0c-806a-b53d4196a9da
    type: regular
    task:
      id: 267cc42c-e34b-4f0c-806a-b53d4196a9da
      version: -1
      name: Disable creator locally
      description: Run a shell command on a specific endpoint and return its result.
      script: '|||core-execute-command'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      command_type:
        simple: native
      endpoint_ids:
        complex:
          root: alert
          accessor: agentid
          transformers:
          - operator: uniq
      is_raw_command:
        simple: "true"
      command:
        complex:
          root: Core.OriginalAlert.event.action_evtlog_data_fields
          accessor: SubjectUserName
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: powershell -Command Disable-LocalUser -Name "
              suffix:
                value:
                  simple: '"'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1183,
          "y": 2791
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "70":
    id: "70"
    taskid: 13800def-5e06-44d4-983e-46d505fe164a
    type: regular
    task:
      id: 13800def-5e06-44d4-983e-46d505fe164a
      version: -1
      name: Undetermined user type - manual
      description: |-
        ### **Analyst Action Required: User Account Investigation**

        ---

        #### **Issue**

        Active Directory was unavailable, and user details for **`${Core.OriginalAlert.event.action_evtlog_data_fields.SubjectUserName}`** could not be retrieved.

        ---

        #### **Required Actions**

        1.  **Determine** whether the user is a **domain user** or a **local user**.
        2.  **Proceed to disable** the account either in Active Directory or locally on the host where the alert was triggered.

        ---

        #### **⚠️ Important Prerequisite**

        Complete this task **only after ensuring** that the alert can be closed.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1581,
          "y": 2791
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "71":
    id: "71"
    taskid: 2b460ab4-3083-49bc-b73a-02db608194ee
    type: condition
    task:
      id: 2b460ab4-3083-49bc-b73a-02db608194ee
      version: -1
      name: Check user type
      description: Checks if the user is a local or domain user.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "67"
      Domain:
      - "72"
      Undetermined:
      - "70"
    separatecontext: false
    conditions:
    - label: Undetermined
      condition:
      - - operator: isEmpty
          left:
            value:
              complex:
                root: UserData
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: UserData.Source
                      iscontext: true
                    right:
                      value:
                        simple: Active Directory Query v2
                accessor: Username
            iscontext: true
          right:
            value: {}
    - label: Domain
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: UserData
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: UserData.Username
                      iscontext: true
                    right:
                      value:
                        simple: Core.OriginalAlert.event.evtlog_subject_username
                      iscontext: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: UserData.Source
                      iscontext: true
                    right:
                      value:
                        simple: Active Directory Query v2
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 783,
          "y": 2625
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "72":
    id: "72"
    taskid: c56893da-28f1-4de5-9305-e109cee5db85
    type: regular
    task:
      id: c56893da-28f1-4de5-9305-e109cee5db85
      version: -1
      name: Disable creator in Active Directory
      description: This script disables users for multiple services.
      type: regular
      iscommand: false
      brand: ""
      scriptName: disable-user
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      brands:
        simple: Active Directory Query v2
      user_name:
        simple: ${Core.OriginalAlert.event.action_evtlog_data_fields.SubjectUserName}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 783,
          "y": 2791
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "78":
    id: "78"
    taskid: f0dff102-eb23-411d-8c28-125591ad38cd
    type: condition
    task:
      id: f0dff102-eb23-411d-8c28-125591ad38cd
      version: -1
      name: Check host risk level
      description: Checks if the client host's risk level is high.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "80"
      High:
      - "32"
    separatecontext: false
    conditions:
    - label: High
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: EndpointData.RiskLevel
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: EndpointData.RiskLevel
                      iscontext: true
                    right:
                      value:
                        simple: HIGH
                    ignorecase: true
            iscontext: true
          right:
            value: {}
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1511,
          "y": 745
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "80":
    id: "80"
    taskid: f2fda2d4-b1a5-4eac-bf98-cd312d30a53e
    type: regular
    task:
      id: f2fda2d4-b1a5-4eac-bf98-cd312d30a53e
      version: -1
      name: Save host risk to evidence
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.RiskyHost
      value:
        simple: "False"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1436,
          "y": 895
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "81":
    id: "81"
    taskid: a9134ab5-f4af-44a1-b661-8fe6adf11961
    type: condition
    task:
      id: a9134ab5-f4af-44a1-b661-8fe6adf11961
      version: -1
      name: Check user risk level
      description: Checks if the client host's risk level is high.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "83"
      High:
      - "50"
    separatecontext: false
    conditions:
    - label: High
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: UserData
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: UserData.RiskLevel
                      iscontext: true
                    right:
                      value:
                        simple: HIGH
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: UserData.Username
                      iscontext: true
                    right:
                      value:
                        simple: Core.OriginalAlert.event.normalized_evtlog_subject_user
                      iscontext: true
                    ignorecase: true
            iscontext: true
          right:
            value: {}
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 946,
          "y": 764
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "83":
    id: "83"
    taskid: 2787af16-bd36-422f-8852-6c9e14505b6e
    type: regular
    task:
      id: 2787af16-bd36-422f-8852-6c9e14505b6e
      version: -1
      name: Save creator user risk to evidence
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.CreatorUserRisky
      value:
        simple: "False"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 853,
          "y": 895
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "85":
    id: "85"
    taskid: 445cab85-e52d-4792-bacb-a124c34efe02
    type: regular
    task:
      id: 445cab85-e52d-4792-bacb-a124c34efe02
      version: -1
      name: Increase alert severity
      description: Optionally increases the alert severity to the new value if it is greater than the existing severity.
      scriptName: IncreaseAlertSeverity
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "41"
    scriptarguments:
      severity:
        simple: Medium
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 452,
          "y": 2002
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "18_33_#default#": 0.1,
      "18_38_yes": 0.5,
      "20_33_#error#": 0.14,
      "22_33_#error#": 0.32,
      "33_46_#default#": 0.61,
      "44_43_#default#": 0.11,
      "53_33_#error#": 0.1,
      "54_58_#default#": 0.29,
      "56_37_#default#": 0.25,
      "62_33_#error#": 0.1,
      "71_72_Domain": 0.45,
      "78_80_#default#": 0.62,
      "81_83_#default#": 0.56
    },
    "paper": {
      "dimensions": {
        "height": 2978,
        "width": 3755,
        "x": -1707,
        "y": 30
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 8.9.0
issilent: true
