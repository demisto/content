id: silent-Suspicious Local User Account Creation
version: -1
name: silent-Suspicious Local User Account Creation
description: |-
  This playbook addresses the following alerts:
  - Suspicious local user account creation

  Playbook Stages:

  Triage:

  - Retrieve extra information about the alert, such as the SID of the created user.

  Investigation:

  - Get host risk level for the machine where the user was created.
  - Search for related alerts in the incident that hint of privilege escalation or persistence.
  - Retrieve local user password expiration status using PowerShell commands.
  - Get creator user risk level from the system.
  - Search for privileged group memberships of the created user (Administrators, Domain Admins, etc.).
  - Analyze command line executions for both created user and creator user to detect suspicious activities.
  - Check creator's historical user creation patterns.

  Containment:

  - Analyze evidence using multiple indicators to determine if the alert is a true positive, false positive, or inconclusive.
  - For true positives: Automatically disable the suspicious local user account.
  - Present analyst review with comprehensive findings including related alerts, privileged groups, host/user risk levels, and suspicious command lines.
  - Upon analyst approval: Disable the creator user account either locally or in Active Directory based on user type detection.

  Requirements:

  For response actions, you need the following integrations:
  - Cortex Core - Investigation and Response
  - Active Directory Query v2.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: f62f662d-e8f5-4fec-8224-67b7d2f2fa93
    type: start
    task:
      id: f62f662d-e8f5-4fec-8224-67b7d2f2fa93
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 37
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 2c5df0e1-83d1-4db9-960d-86176d054ac5
    type: regular
    task:
      id: 2c5df0e1-83d1-4db9-960d-86176d054ac5
      version: -1
      name: Get event information
      description: Retrieves extra information about the alert, such as the SID of the created user.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 277
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 46b0938c-8ea2-4547-8cc1-2c279a65ec2e
    type: title
    task:
      id: 46b0938c-8ea2-4547-8cc1-2c279a65ec2e
      version: -1
      name: Triage
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 158
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: bd21cdbc-9100-44c2-afe4-bfdd8e961b91
    type: title
    task:
      id: bd21cdbc-9100-44c2-afe4-bfdd8e961b91
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "13"
      - "12"
      - "31"
      - "17"
      - "48"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 388
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 7d0c89e1-a8a0-440b-8fa6-ba710a481f06
    type: regular
    task:
      id: 7d0c89e1-a8a0-440b-8fa6-ba710a481f06
      version: -1
      name: Get host risk level
      description: Gets the risk level of the host on which the user was created.
      script: '|||core-list-risky-hosts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "32"
    scriptarguments:
      host_id:
        simple: ${alert.hostname}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 2fe4d3ae-4ad1-44e0-928c-997af07f4343
    type: regular
    task:
      id: 2fe4d3ae-4ad1-44e0-928c-997af07f4343
      version: -1
      name: Search related alerts
      description: Searches for known related alerts in the same case.
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      query:
        complex:
          root: alert
          accessor: parentXDRIncident
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '-'
              fields:
                value:
                  simple: "2"
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'caseid:'
              suffix:
                value:
                  simple: ' and (name:"Masquerading as a default local account for the first time" or name:"Execution of an uncommon process with a local/domain user SID at an early startup stage with suspicious characteristics" or name:"Privilege Escalation - 1216127025" or name:"Suspicious disablement of the Windows Firewall" or name:"PowerShell runs suspicious base64-encoded commands")'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1284,
          "y": 620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: ceabad22-9b7a-46d4-a02a-ad731ca6a548
    type: regular
    task:
      id: ceabad22-9b7a-46d4-a02a-ad731ca6a548
      version: -1
      name: Retrieve local user password status
      description: Runs a Powershell code snipper on the endpoint where the user was created, in order to retrieve the PASSWORDEXPIRES attribute of the local user.
      script: '|||core-run-script-execute-commands'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      command_type:
        simple: native
      commands:
        complex:
          root: Core.OriginalAlert.event
          accessor: evtlog_target_username
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'powershell -Command "NET USER '
              suffix:
                value:
                  simple: '"'
      endpoint_ids:
        complex:
          root: alert
          accessor: agentid
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 871,
          "y": 620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 63e42b5a-c69e-4ea1-a5ec-d38dc7183a62
    type: title
    task:
      id: 63e42b5a-c69e-4ea1-a5ec-d38dc7183a62
      version: -1
      name: Host Risk
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "5"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 4f980f2c-94d1-473a-a176-4da9dbb69727
    type: title
    task:
      id: 4f980f2c-94d1-473a-a176-4da9dbb69727
      version: -1
      name: Related Alerts
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "6"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1284,
          "y": 512
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 36d68c2c-c7a2-4748-868f-932c99f62112
    type: regular
    task:
      id: 36d68c2c-c7a2-4748-868f-932c99f62112
      version: -1
      name: Get execution results
      description: Gets the execution results for the Powershell code that was run.
      script: '|||core-get-script-execution-results'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      action_id:
        simple: ${Core.ScriptRun.action_id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 871,
          "y": 743
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: a609f7b8-f826-4407-9926-1edd3954855b
    type: regular
    task:
      id: a609f7b8-f826-4407-9926-1edd3954855b
      version: -1
      name: Save attribute to evidence
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.PasswordNeverExpires
      value:
        complex:
          root: Core.ScriptResult.results.[0].command_output
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: Core.ScriptResult.results.[0].command_output
                iscontext: true
              right:
                value:
                  simple: Password expires
          transformers:
          - operator: DT
            args:
              dt:
                value:
                  simple: '.=val.includes("Never") || val.includes("%%1794") ? "True" : "False"'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 871,
          "y": 866
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 2381c619-178e-404c-8fd5-2b0ff2e7fdd6
    type: title
    task:
      id: 2381c619-178e-404c-8fd5-2b0ff2e7fdd6
      version: -1
      name: Behavior Checks
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -485,
          "y": 511
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: ab482efa-fcd5-48f1-a5d7-872654ee8b2e
    type: condition
    task:
      id: ab482efa-fcd5-48f1-a5d7-872654ee8b2e
      version: -1
      name: Check XQL Query Engine availability
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      "yes":
      - "38"
    scriptarguments:
      brandname:
        simple: XQL Query Engine
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -485,
          "y": 631
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: 09b95fc5-a540-4056-a0a2-63fb16357fcf
    type: regular
    task:
      id: 09b95fc5-a540-4056-a0a2-63fb16357fcf
      version: -1
      name: Command line analysis
      description: |-
        This script evaluates command-line threats by analyzing both original and decoded inputs. It assigns weighted scores to detected patterns, such as AMSI bypass or credential dumping, and applies risk combination bonuses for multiple detections. The total score is normalized to a 0-100 scale, with risk levels categorized as follows:

        * 0-25: Low Risk
        * 26-50: Medium Risk
        * 51-90: High Risk
        * 91-100: Critical Risk

        The scoring mechanism provides a comprehensive risk assessment, considering both the severity and frequency of malicious behaviors.
      scriptName: CommandLineAnalysis
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "36"
    scriptarguments:
      command_line:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Get created user process command lines
          accessor: results.action_process_image_command_line
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -261,
          "y": 1429
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: 118e29c6-0b4b-4a80-b2cd-d85e26509f0f
    type: regular
    task:
      id: 118e29c6-0b4b-4a80-b2cd-d85e26509f0f
      version: -1
      name: Search created user group memberships
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "33"
      '#none#':
      - "25"
    scriptarguments:
      query:
        simple: |-
          dataset = xdr_data
          | filter event_type = ENUM.EVENT_LOG and action_evtlog_event_id = 4732
          | alter
              Target_SID = trim(arrayindex(regextract(action_evtlog_message, "Member:\s+Security ID:\s+(S-\d+-\d+(?:-\d+)+)"), 0)),
              Group_Name = trim(arrayindex(regextract(action_evtlog_message, "Group Name:[\\t ]*([^\r\n]+)"), 0)),
              Host_Name = trim(arrayindex(regextract(action_evtlog_message, "(?i)Subject:\\r\\n\\tSecurity ID:\\t\\t[^\\r\\n]+\\r\\n\\tAccount Name:\\t\\t[^\\r\\n]+\\r\\n\\tAccount Domain:\\t\\t([^\r\n]+)"), 0))
          | filter Group_Name in (
              "Administrators",
              "Domain Admins",
              "Enterprise Admins",
              "Remote Desktop Users",
              "Backup Operators",
              "Power Users",
              "Account Operators",
              "Server Operators",
              "Print Operators",
              "Device Owners")
              and Target_SID = "${Core.OriginalAlert.event.action_evtlog_data_fields.TargetSid}"
              and lowercase(agent_hostname) = lowercase("${alert.hostname}")
          | fields action_evtlog_message, Target_SID, Group_Name, agent_hostname
      query_name:
        simple: Created user assigned to a privileged group
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -699,
          "y": 1187
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: bc2e289e-0cc8-42bc-968d-c2625d0050a7
    type: regular
    task:
      id: bc2e289e-0cc8-42bc-968d-c2625d0050a7
      version: -1
      name: Search created user processes
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "33"
      '#none#':
      - "56"
    scriptarguments:
      query:
        simple: |-
          dataset = xdr_data
          | filter event_type = ENUM.PROCESS
              and lowercase(actor_effective_username) = lowercase("${Core.OriginalAlert.event.normalized_evtlog_target_user}")
              and lowercase(agent_hostname) = lowercase("${alert.hostname}")
          | filter action_process_image_command_line != null
          | dedup actor_effective_username, action_process_image_command_line
          | fields
              _time,
              agent_hostname,
              actor_effective_username,
              action_process_image_command_line
      query_name:
        simple: Get created user process command lines
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -261,
          "y": 1187
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: bcc3a330-244b-4034-b267-ca61ea7f0e14
    type: regular
    task:
      id: bcc3a330-244b-4034-b267-ca61ea7f0e14
      version: -1
      name: Save found privileged groups
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    scriptarguments:
      key:
        simple: CreatedUserAddedToPrivilegedGroup
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Created user assigned to a privileged group
              ignorecase: true
          - - operator: greaterThan
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.number_of_results
                iscontext: true
              right:
                value:
                  simple: "0"
          accessor: results.Group_Name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -699,
          "y": 1305
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 1ca5ab03-8c84-485b-801c-74f3d2d7b38e
    type: regular
    task:
      id: 1ca5ab03-8c84-485b-801c-74f3d2d7b38e
      version: -1
      name: Save related alerts to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.RelatedAlerts
      value:
        simple: '${.=val.foundIncidents && val.foundIncidents.id ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1284,
          "y": 743
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: c327b4dc-87be-4629-b8fb-d9053b488c89
    type: title
    task:
      id: c327b4dc-87be-4629-b8fb-d9053b488c89
      version: -1
      name: Created User Attributes
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "11"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 871,
          "y": 510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: f7e4bfc9-1265-415d-abb1-ac6d729376d7
    type: regular
    task:
      id: f7e4bfc9-1265-415d-abb1-ac6d729376d7
      version: -1
      name: Save host risk to evidence
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.RiskyHost
      value:
        complex:
          root: Core.RiskyHost
          accessor: risk_level
          transformers:
          - operator: FirstArrayElement
          - operator: DT
            args:
              dt:
                value:
                  simple: '.=val === "LOW" ? "True" : "False"'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 743
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 5c487e86-0f62-475f-b067-aa9befc23d90
    type: condition
    task:
      id: 5c487e86-0f62-475f-b067-aa9befc23d90
      version: -1
      name: Analyze evidence
      description: Analyzes the evidence to reach a verdict or the alert.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "46"
      False Positive:
      - "43"
      True Positive:
      - "40"
    separatecontext: false
    conditions:
    - label: True Positive
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidence
                transformers:
                - operator: DT
                  args:
                    dt:
                      value:
                        simple: .=Object.values(val).filter(value => value == "True").length
            iscontext: true
          right:
            value:
              simple: "3"
    - label: False Positive
      condition:
      - - operator: lessThanOrEqual
          left:
            value:
              complex:
                root: Evidence
                transformers:
                - operator: DT
                  args:
                    dt:
                      value:
                        simple: .=Object.values(val).filter(value => value == "True").length
            iscontext: true
          right:
            value:
              simple: "1"
      - - operator: greaterThanOrEqual
          left:
            value:
              simple: Core.OriginalAlert.event.evtlog_host_count_distinct_target_user_created
            iscontext: true
          right:
            value:
              simple: "3"
        - operator: greaterThanOrEqual
          left:
            value:
              simple: CreatorPastCreationCount
            iscontext: true
          right:
            value:
              simple: "3"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 448,
          "y": 1858
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 510f4f7f-69ca-44de-b4de-24775e7277ff
    type: regular
    task:
      id: 510f4f7f-69ca-44de-b4de-24775e7277ff
      version: -1
      name: Save privileged group to evidence
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.CreatedUserPrivilegedGroup
      value:
        simple: '${.=val.CreatedUserAddedToPrivilegedGroup ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -699,
          "y": 1429
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: 14370b3d-69fc-44b7-ac6e-6fbc0e026c4f
    type: regular
    task:
      id: 14370b3d-69fc-44b7-ac6e-6fbc0e026c4f
      version: -1
      name: Save suspicious commandlines list
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      key:
        simple: SuspiciousCommandlinesList
      value:
        complex:
          root: CommandLineAnalysis
          filters:
          - - operator: lessThanOrEqual
              left:
                value:
                  simple: CommandLineAnalysis.score
                iscontext: true
              right:
                value:
                  simple: "50"
          accessor: original_command
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -261,
          "y": 1557
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: b91a28fd-342a-46fc-8e58-220ea95c61d0
    type: regular
    task:
      id: b91a28fd-342a-46fc-8e58-220ea95c61d0
      version: -1
      name: Save post login count to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidence.SuspiciousProcessCommandlines
      value:
        simple: '${.=val.SuspiciousCommandlinesList ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -261,
          "y": 1679
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: fff0a8cf-c419-44c5-af23-4dd73c60e6b1
    type: regular
    task:
      id: fff0a8cf-c419-44c5-af23-4dd73c60e6b1
      version: -1
      name: Retrieve start time
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "39"
    scriptarguments:
      key:
        simple: QueryStartTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 5 min ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -485,
          "y": 797
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 1d67bf4c-b7e8-489b-840d-da595de4b192
    type: regular
    task:
      id: 1d67bf4c-b7e8-489b-840d-da595de4b192
      version: -1
      name: Retrieve end time
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "51"
      - "52"
    scriptarguments:
      key:
        simple: QueryEndTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 60 min after
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -485,
          "y": 919
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: 76ad3515-4931-4b31-bb3b-4d4d1d9bf8ce
    type: regular
    task:
      id: 76ad3515-4931-4b31-bb3b-4d4d1d9bf8ce
      version: -1
      name: Save close reason - true positive
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "41"
    scriptarguments:
      append:
        simple: "false"
      key:
        simple: CloseReason
      value:
        simple: Resolved - True Positive
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 448,
          "y": 2024
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: 40fa80a5-652e-45fe-90f4-e225de10248a
    type: title
    task:
      id: 40fa80a5-652e-45fe-90f4-e225de10248a
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "45"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 448,
          "y": 2154
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 53babb1d-1c09-4857-8f6d-1c71deecbad2
    type: regular
    task:
      id: 53babb1d-1c09-4857-8f6d-1c71deecbad2
      version: -1
      name: Close Investigation
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    scriptarguments:
      closeReason:
        complex:
          root: CloseReason
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: Resolved - False Positive
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 448,
          "y": 3143
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: ce712cfe-c409-46bf-9d4a-9e1a54c57b96
    type: condition
    task:
      id: ce712cfe-c409-46bf-9d4a-9e1a54c57b96
      version: -1
      name: Analyst review - disable suspicious user?
      description: |
        We found suspicious indicators in this investigation and have taken action by disabling the suspicious local user that was created.

        Review the findings and decide on the next steps:

        ### Alert Information
        The subject (creator) user: `${Core.OriginalAlert.event.normalized_evtlog_subject_user}`

        The target (created) user: `${Core.OriginalAlert.event.evtlog_target_username}`

        Involved Host: `${alert.hostname}`


        ---

        ### Related Alerts
        Suspicious related alerts found: `${.=val.foundIncidents && val.foundIncidents.length > 0 ? "True" : "False"}`

        ---

        ### User added to privileged groups
        If the created user was added to privileged groups after being created, the group names will be listed below.

        Group names: `${.=val.UserAddedToPrivilegedGroup || "N/A"}`

        ---

        ### Host & User Risk Levels
        Host risk level: `${Core.RiskyHost.risk_level}`

        Creator user risk level: `${Core.RiskyHost.risk_level}`

        ---

        ### Suspicious command line executions
        Created user: `${.=val.SuspiciousCommandlinesList || "N/A"}`

        Creator user: `${.=val.CreatorSuspiciousCommandlinesList || "N/A"}`
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "43"
      "Yes":
      - "66"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 448,
          "y": 2394
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
        complex:
          root: Core.OriginalAlert.event.action_evtlog_data_fields
          accessor: SubjectUserName
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: "Would you like to disable the following user? \n"
              suffix: {}
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
      replyOptions:
      - "Yes"
      - "No"
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: f1ca7797-cc29-4871-9c30-f1337130efc1
    type: regular
    task:
      id: f1ca7797-cc29-4871-9c30-f1337130efc1
      version: -1
      name: Disable local user
      description: Runs Powershell code on the affected host to disable the local user on the machine.
      script: '|||core-run-script-execute-commands'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "44"
    scriptarguments:
      command_type:
        simple: native
      commands:
        complex:
          root: Core.OriginalAlert.event
          accessor: evtlog_target_username
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: powershell -Command Disable-LocalUser -Name "
              suffix:
                value:
                  simple: '"'
      endpoint_ids:
        complex:
          root: alert
          accessor: agentid
          transformers:
          - operator: uniq
      is_raw_command:
        simple: "true"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 448,
          "y": 2265
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: 54fc9cb5-8624-4744-9ae9-40962a871f6d
    type: title
    task:
      id: 54fc9cb5-8624-4744-9ae9-40962a871f6d
      version: -1
      name: Inconclusive
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 869,
          "y": 2154
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: 1b8608b6-30a7-4b7d-8779-fe14d65befb2
    type: title
    task:
      id: 1b8608b6-30a7-4b7d-8779-fe14d65befb2
      version: -1
      name: User Risk
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "49"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 6,
          "y": 510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "49":
    id: "49"
    taskid: afa2e31c-a222-4b52-85b8-0f99b239ac5f
    type: regular
    task:
      id: afa2e31c-a222-4b52-85b8-0f99b239ac5f
      version: -1
      name: Get creator user risk level
      description: Retrieve the risk score of a specific user or list of users with the highest risk score in the environment along with the reason affecting each score.
      script: '|||core-list-risky-users'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "50"
    scriptarguments:
      user_id:
        simple: ${Core.OriginalAlert.event.normalized_evtlog_subject_user}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 6,
          "y": 620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "50":
    id: "50"
    taskid: 69c50e13-2d1b-4894-8b97-cdf511817bf0
    type: regular
    task:
      id: 69c50e13-2d1b-4894-8b97-cdf511817bf0
      version: -1
      name: Save creator user risk to evidence
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: Evidence.CreatorUserRisky
      value:
        complex:
          root: Core.RiskyUser
          accessor: risk_level
          transformers:
          - operator: FirstArrayElement
          - operator: DT
            args:
              dt:
                value:
                  simple: '.=val === "HIGH" ? "True" : "False"'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 6,
          "y": 743
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "51":
    id: "51"
    taskid: c21e4720-a342-4d5a-98e5-dfb6c50ec3d4
    type: title
    task:
      id: c21e4720-a342-4d5a-98e5-dfb6c50ec3d4
      version: -1
      name: 'Created User '
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "22"
      - "20"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -485,
          "y": 1057
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: 830439b5-16cc-43ad-afb1-bc8e71de9172
    type: title
    task:
      id: 830439b5-16cc-43ad-afb1-bc8e71de9172
      version: -1
      name: Creator User
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "53"
      - "63"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1402,
          "y": 1057
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "53":
    id: "53"
    taskid: 00f15e65-22fd-458e-aba4-34eecf33fdbd
    type: regular
    task:
      id: 00f15e65-22fd-458e-aba4-34eecf33fdbd
      version: -1
      name: Search creator user processes
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "33"
      '#none#':
      - "54"
    scriptarguments:
      query:
        simple: |-
          dataset = xdr_data
          | filter event_type = ENUM.PROCESS
              and lowercase(actor_effective_username) = lowercase("${Core.OriginalAlert.event.normalized_evtlog_subject_user}")
              and lowercase(agent_hostname) = lowercase("${alert.hostname}")
          | filter action_process_image_command_line != null
          | dedup actor_effective_username, action_process_image_command_line
          | fields
              _time,
              agent_hostname,
              actor_effective_username,
              action_process_image_command_line
      query_name:
        simple: Get creator user process command lines
      time_frame:
        simple: between ${QueryStartTime} and ${QueryEndTime}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -1174,
          "y": 1187
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "54":
    id: "54"
    taskid: 9489efff-f498-4a32-a4c7-a42f874dc61f
    type: condition
    task:
      id: 9489efff-f498-4a32-a4c7-a42f874dc61f
      version: -1
      name: Check process command line results
      description: Check if any results were retrivied.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "58"
      "yes":
      - "55"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.GenericQuery
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.query_name
                      iscontext: true
                    right:
                      value:
                        simple: Get creator user process command lines
                accessor: results.action_process_image_command_line
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1174,
          "y": 1305
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "55":
    id: "55"
    taskid: 66def0e5-ddf8-4457-8334-0d33b4d1afd3
    type: regular
    task:
      id: 66def0e5-ddf8-4457-8334-0d33b4d1afd3
      version: -1
      name: Command line analysis
      description: |-
        This script evaluates command-line threats by analyzing both original and decoded inputs. It assigns weighted scores to detected patterns, such as AMSI bypass or credential dumping, and applies risk combination bonuses for multiple detections. The total score is normalized to a 0-100 scale, with risk levels categorized as follows:

        * 0-25: Low Risk
        * 26-50: Medium Risk
        * 51-90: High Risk
        * 91-100: Critical Risk

        The scoring mechanism provides a comprehensive risk assessment, considering both the severity and frequency of malicious behaviors.
      scriptName: CommandLineAnalysis
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "57"
    scriptarguments:
      command_line:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Get creator user process command lines
          accessor: results.action_process_image_command_line
          transformers:
          - operator: uniq
      extend-context:
        simple: CreatorCommandLineAnalysis=
      ignore-outputs:
        simple: "true"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1174,
          "y": 1449
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "56":
    id: "56"
    taskid: 8c4c6e5e-539e-44c5-8586-34697d4b076d
    type: condition
    task:
      id: 8c4c6e5e-539e-44c5-8586-34697d4b076d
      version: -1
      name: Check process command line results
      description: Check if any results were retrivied.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "37"
      "yes":
      - "19"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.GenericQuery
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.query_name
                      iscontext: true
                    right:
                      value:
                        simple: Get created user process command lines
                accessor: results.action_process_image_command_line
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -261,
          "y": 1305
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "57":
    id: "57"
    taskid: b828409f-a20d-454d-ab28-6af3adfb2d1e
    type: regular
    task:
      id: b828409f-a20d-454d-ab28-6af3adfb2d1e
      version: -1
      name: Save suspicious commandlines list
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "58"
    scriptarguments:
      key:
        simple: CreatorSuspiciousCommandlinesList
      value:
        complex:
          root: CreatorCommandLineAnalysis
          filters:
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: CreatorCommandLineAnalysis.score
                iscontext: true
              right:
                value:
                  simple: "50"
          accessor: original_command
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1174,
          "y": 1569
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "58":
    id: "58"
    taskid: d13c2472-ddbf-4761-9893-7b6a4d634e38
    type: regular
    task:
      id: d13c2472-ddbf-4761-9893-7b6a4d634e38
      version: -1
      name: Save post login count to evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Evidence.CreatorSuspiciousProcessCommandlines
      value:
        simple: '${.=val.CreatorSuspiciousCommandlinesList ? "True" : "False"}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1174,
          "y": 1690
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "62":
    id: "62"
    taskid: 0b69f7e7-d2f0-4a4e-8205-359d6c857366
    type: regular
    task:
      id: 0b69f7e7-d2f0-4a4e-8205-359d6c857366
      version: -1
      name: Search user creation history
      description: |-
        Execute an XQL query and retrieve results of an executed XQL query API. The command will be executed every 10 seconds until results are retrieved or until a timeout error is raised.
        When more than 1000 results are retrieved, the command will return a compressed gzipped JSON format file,
        unless the argument 'parse_result_file_to_context' is set to true and then the results will be extracted to the context.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "33"
      '#none#':
      - "64"
    scriptarguments:
      query:
        simple: "dataset = xdr_data\n| filter event_type = ENUM.EVENT_LOG and action_evtlog_event_id = 4720\n| alter \n    Subject_User_SID = action_evtlog_data_fields -> SubjectUserSid, \n    Subject_Username = action_evtlog_data_fields -> SubjectUserName\n| filter lowercase(Subject_User_SID) = lowercase(\"${Core.OriginalAlert.event.action_evtlog_data_fields.SubjectUserSid}\")\n| comp count() as user_creation_count"
      query_name:
        simple: Get user creation history for a user
      time_frame:
        simple: between ${CreatorHistoryQueryStartTime} and ${alert.timestamp}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": -1591,
          "y": 1305
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "63":
    id: "63"
    taskid: 58d9144d-3306-4e17-8640-8455b6a10f7b
    type: regular
    task:
      id: 58d9144d-3306-4e17-8640-8455b6a10f7b
      version: -1
      name: Query start time - 3 months ago
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "62"
    scriptarguments:
      key:
        simple: CreatorHistoryQueryStartTime
      value:
        complex:
          root: alert
          accessor: timestamp
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: 90 days ago
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1591,
          "y": 1187
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "64":
    id: "64"
    taskid: 75aa5508-cc37-4a17-a0db-1e605f604882
    type: regular
    task:
      id: 75aa5508-cc37-4a17-a0db-1e605f604882
      version: -1
      name: Save past creations count
      description: Extracts and saves the PASSWORDEXPIRES value of the locally created user from the results of the Powershell script execution.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      key:
        simple: CreatorPastCreationCount
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: Get user creation history for a user
          accessor: results.user_creation_count
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1591,
          "y": 1449
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "66":
    id: "66"
    taskid: f3c6fe2d-cd09-4935-80bb-f0626194e6ef
    type: title
    task:
      id: f3c6fe2d-cd09-4935-80bb-f0626194e6ef
      version: -1
      name: Creator User Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "68"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 786,
          "y": 2526
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "67":
    id: "67"
    taskid: 4e06f579-a56a-447f-838c-7f5a98db85f3
    type: regular
    task:
      id: 4e06f579-a56a-447f-838c-7f5a98db85f3
      version: -1
      name: Disable creator locally
      description: Runs Powershell code on the affected host to disable the local user on the machine.
      script: '|||core-run-script-execute-commands'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      command_type:
        simple: native
      commands:
        complex:
          root: Core.OriginalAlert.event.action_evtlog_data_fields
          accessor: SubjectUserName
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: powershell -Command Disable-LocalUser -Name "
              suffix:
                value:
                  simple: '"'
      endpoint_ids:
        complex:
          root: alert
          accessor: agentid
          transformers:
          - operator: uniq
      is_raw_command:
        simple: "true"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1183,
          "y": 3010
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "68":
    id: "68"
    taskid: 971323dd-1c06-4fb6-8574-0542edec8d86
    type: condition
    task:
      id: 971323dd-1c06-4fb6-8574-0542edec8d86
      version: -1
      name: Check Active Directory availability
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "70"
      "yes":
      - "69"
    scriptarguments:
      brandname:
        simple: Active Directory Query v2
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 785,
          "y": 2635
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "69":
    id: "69"
    taskid: 1a251d63-830b-4137-9418-dbe014dcf3e1
    type: regular
    task:
      id: 1a251d63-830b-4137-9418-dbe014dcf3e1
      version: -1
      name: Attempt to get creator from AD
      description: Retrieves detailed information about a user account. The user can be specified by name, email address, or as an Active Directory Distinguished Name (DN). If no filter is specified, all users are returned.
      script: '|||ad-get-user'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "71"
    scriptarguments:
      limit:
        simple: "1"
      username:
        simple: ${Core.OriginalAlert.event.action_evtlog_data_fields.SubjectUserName}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 786,
          "y": 2761
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "70":
    id: "70"
    taskid: 18e9f289-19ea-4b1b-b1e3-034b89c56d0f
    type: regular
    task:
      id: 18e9f289-19ea-4b1b-b1e3-034b89c56d0f
      version: -1
      name: Undetermined user type - manual
      description: |-
        Active Directory was unavailable, and user details for "${Core.OriginalAlert.event.action_evtlog_data_fields.SubjectUserName}" could not be retrieved.

        Determine whether the user is a domain user or a local user. Then, proceed to disable the account either in Active Directory or locally on the host where the alert was triggered.

        Complete this task only after ensuring that the alert can be closed.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1577,
          "y": 3010
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "71":
    id: "71"
    taskid: 70bd4180-9118-4b10-bcf4-965888cafc55
    type: condition
    task:
      id: 70bd4180-9118-4b10-bcf4-965888cafc55
      version: -1
      name: Check user type
      description: Checks if the user is a local or domain user.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "67"
      Domain:
      - "72"
    separatecontext: false
    conditions:
    - label: Domain
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: ActiveDirectory.Users.sAMAccountName
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 786,
          "y": 2882
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "72":
    id: "72"
    taskid: 518820a9-a66b-4ced-9ad7-7c68c1d3ca16
    type: regular
    task:
      id: 518820a9-a66b-4ced-9ad7-7c68c1d3ca16
      version: -1
      name: Disable creator in Active Directory
      description: Disables an Active Directory user account.
      script: '|||ad-disable-account'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      username:
        complex:
          root: Core.OriginalAlert.event.action_evtlog_data_fields
          accessor: SubjectUserName
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 786,
          "y": 3010
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "18_33_#default#": 0.1,
      "18_38_yes": 0.5,
      "20_33_#error#": 0.14,
      "22_33_#error#": 0.32,
      "33_43_False Positive": 0.24,
      "33_46_#default#": 0.61,
      "44_43_#default#": 0.11,
      "53_33_#error#": 0.1,
      "54_58_#default#": 0.29,
      "56_37_#default#": 0.25,
      "62_33_#error#": 0.1,
      "68_70_#default#": 0.28
    },
    "paper": {
      "dimensions": {
        "height": 3176,
        "width": 3549,
        "x": -1591,
        "y": 37
      }
    }
  }
inputs: []
outputs: []
issilent: true
tests:
- No tests (auto formatted)
fromversion: 8.9.0
