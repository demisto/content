id: silent-Azure AD account unlock or password reset Test
version: -1
name: silent-Azure AD account unlock or password reset Test
description: |-
  **This playbook addresses the following alert**:
  - Azure AD account unlock/successful password reset

  **Playbook Stages**:

  **Triage**:
  - Gather initial information about the user.

  **Investigation**:
  - **Check IP Reputation**:
    - Analyze the reputation of the IP address related to the alert.
  - **Check for Azure Alerts**:
    - Extract recent Azure security alerts for the user.
  - **Check if User is Risky**:
    - Assess the risk score of the user based on Core and Azure risk indicators.
    - Investigate reasons behind any identified risks, including recent detections.

  **Containment**:
  - Check if feature sum is greater than 2 (Possible features:new user agent/new asn/new country). If yes, continue to revoke user's active sessions to ensure immediate containment.
  If no, continue to check investigation findings.
  - Provide a manual task for an analyst to review the findings and decide the next steps.
  - Possible actions:
    - Disable the target user.
    - Disable the resource user.
    - Disable both users.
    - Take no action.

  **Requirements**:
  For the best results, it's recommended to ensure these integrations are configured and working:
  - `Cortex Core - Investigation and Response` for Core user risk evaluation.
  - `Azure Risky Users` for retrieving user risk scores.
  - `Microsoft 365 Defender` for advanced hunting queries and Azure security alerts.
  - `Microsoft Graph User` for disabling accounts and revoking sessions.
tags:
- T1078 - Valid Accounts
- TA0003 - Persistence
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 5e4b610f-ffdb-423f-8fe1-c54b8ada2e68
    type: start
    task:
      id: 5e4b610f-ffdb-423f-8fe1-c54b8ada2e68
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 854,
          "y": 821
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: ce1b1b8f-0d0f-4983-84d4-c071ecfc0ee5
    type: title
    task:
      id: ce1b1b8f-0d0f-4983-84d4-c071ecfc0ee5
      version: -1
      name: Enrich IP
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
      - "11"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 854,
          "y": 1049
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 3bc71303-5ccd-4f2f-8761-aeeb4671c954
    type: regular
    task:
      id: 3bc71303-5ccd-4f2f-8761-aeeb4671c954
      version: -1
      name: Get event information
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "1"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 854,
          "y": 931
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 419782ea-b5f7-43e0-a4ae-aeb91391500a
    type: regular
    task:
      id: 419782ea-b5f7-43e0-a4ae-aeb91391500a
      version: -1
      name: Check source IP reputation
      description: This script gathers ip reputation data from multiple integrations and returns an ip entity with consolidated information to the context.
      type: regular
      iscommand: false
      brand: ""
      scriptName: ip-enrichment
    nexttasks:
      '#none#':
      - "38"
    scriptarguments:
      external_enrichment:
        simple: "true"
      ip_list:
        complex:
          root: alert
          accessor: hostip
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1063,
          "y": 1168
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: ccfd074a-6c39-496c-82f0-af012e9db237
    type: condition
    task:
      id: ccfd074a-6c39-496c-82f0-af012e9db237
      version: -1
      name: Check user agent
      description: Checks if the user agent is suspicious.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "21"
      "yes":
      - "5"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: Core.OriginalAlert.event.user_agent_data
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 245,
          "y": 1655
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 901ec269-a6ff-4c89-841d-4922f6361cac
    type: regular
    task:
      id: 901ec269-a6ff-4c89-841d-4922f6361cac
      version: -1
      name: Save suspicious user agent
      description: Extracts regex data from the provided text. The script support groups and looping.
      scriptName: MatchRegexV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      contextKey:
        simple: SuspiciousUserAgent
      data:
        simple: ${Core.OriginalAlert.event.user_agent_data}
      regex:
        simple: \b(Python-urllib|libwww-perl|Scrapy|curl|Wget|sqlmap|Nikto|Xrumer|Hydra|JohnTheRipper|LOIC|HOIC|MJ12bot|Baiduspider|BlackWidow|HeadlessChrome|PhantomJS|Selenium|REST)\b
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 14,
          "y": 1779
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: 57d886c2-4008-47b6-887d-0392b762952b
    type: regular
    task:
      id: 57d886c2-4008-47b6-887d-0392b762952b
      version: -1
      name: Close alert as true positive
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      closeNotes:
        simple: Handled by the playbook "Azure AD account unlock or password reset".
      closeReason:
        simple: Resolved - True Positive
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1074,
          "y": 2927
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: a7b912f5-66c7-4190-8639-55d1d2860720
    type: title
    task:
      id: a7b912f5-66c7-4190-8639-55d1d2860720
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 855,
          "y": 3051
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: c870efe1-6e26-4239-8283-bd8907b6edd3
    type: title
    task:
      id: c870efe1-6e26-4239-8283-bd8907b6edd3
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "19"
      - "20"
      - "37"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 854,
          "y": 1415
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: a6221dae-a261-41af-a86e-edab80205d86
    type: regular
    task:
      id: a6221dae-a261-41af-a86e-edab80205d86
      version: -1
      name: 'Get Azure user alerts '
      description: 'Advanced hunting is a threat-hunting tool that uses specially constructed queries to examine the past 30 days of event data in Microsoft 365 Defender. Details on how to write queries: https://docs.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-query-language?view=o365-worldwide.'
      script: '|||microsoft-365-defender-advanced-hunting'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "24"
    scriptarguments:
      query:
        simple: let _start = now(-1d); AlertEvidence | where Timestamp >= _start | where AccountUpn == "${Core.OriginalAlert.raw_abioc.event.identity_invoked_by_name}"
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1042,
          "y": 1655
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 4a1449ce-823c-4225-8208-8002607aadf5
    type: regular
    task:
      id: 4a1449ce-823c-4225-8208-8002607aadf5
      version: -1
      name: Get source IP related alerts
      description: |-
        Searches Demisto alerts. A summarized version of this script is available with the summarizedversion argument.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSIAM/Cortex-XSIAM-Administrator-Guide/Permission-Management
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "32"
    scriptarguments:
      fromdate:
        simple: 3 hours ago
      query:
        simple: (name:"Suspicious authentication method addition to Azure account" or name:"Suspicious Azure AD Administrator Role assignment״ or name:״Abnormal sign-in followed by suspicious activity in Azure AD") and caller_ip=${alert.hostip}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 648,
          "y": 1655
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: d12fe789-b844-48ed-8097-78aa7af90a55
    type: title
    task:
      id: d12fe789-b844-48ed-8097-78aa7af90a55
      version: -1
      name: Check if user is risky
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "43"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1446,
          "y": 1544
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: d8ce9808-3363-48c1-86b5-7b5ca9c883fe
    type: title
    task:
      id: d8ce9808-3363-48c1-86b5-7b5ca9c883fe
      version: -1
      name: Check for related alerts
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "15"
      - "14"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 854,
          "y": 1544
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: 3e571631-0c12-4a50-87a0-4edb5a5988e1
    type: title
    task:
      id: 3e571631-0c12-4a50-87a0-4edb5a5988e1
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "34"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 854,
          "y": 1919
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 0a2fb63e-da5b-42aa-8629-bf1adaaf1f85
    type: regular
    task:
      id: 0a2fb63e-da5b-42aa-8629-bf1adaaf1f85
      version: -1
      name: Save Azure user alerts
      description: Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6.x see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      key:
        simple: AzureSecurityAlerts
      value:
        complex:
          root: Microsoft365Defender.Hunt.results
          accessor: Title
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1042,
          "y": 1779
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: 9c1816c9-03ff-4198-be22-a407fadf598a
    type: regular
    task:
      id: 9c1816c9-03ff-4198-be22-a407fadf598a
      version: -1
      name: Save source IP related alerts
      description: Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      key:
        simple: CallerIpAlerts
      value:
        complex:
          root: foundIncidents
          accessor: name
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 648,
          "y": 1779
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 0992e905-128a-4752-8806-d4d88ff2f03e
    type: collection
    task:
      id: 0992e905-128a-4752-8806-d4d88ff2f03e
      version: -1
      name: Manual Task - Disable user account decision
      description: ""
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "35"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1075,
          "y": 2541
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: |-
            #### Source User:
            `${Core.OriginalAlert.raw_abioc.event.identity_orig.user.userPrincipalName}`

            #### Target User:
            `${Core.OriginalAlert.event.raw_log.properties.targetResources.userPrincipalName}`

            ---

            ### Malicious Indicators Found:
            - **Malicious IP**: `${.=val.MaliciousIP || "None"}`
            - **Malicious User Agent**: `${.=val.SuspiciousUserAgent || "None"}`

            ---

            ### User Risk Analysis:
            - **User is risky**: `${.=val.RiskyUser || "N/A"}`
            ---

            ### User Azure Security Alerts:
            - **Alerts from last day**: `${.=val.AzureSecurityAlerts || "N/A"}`

            ---

            ### Caller IP Related Alerts
            - `${.=val.CallerIpAlerts || "N/A"}`

            ---

            ### Action Required:
            Please select the action you would like to perform.
        required: false
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - simple: No Action
        - simple: Disable source user
        - simple: Disable target user
        - simple: Disable both
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Analyst Action
      description: Analyst review.
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 9974c83b-8eeb-4be3-a212-d1f3b8de88d0
    type: condition
    task:
      id: 9974c83b-8eeb-4be3-a212-d1f3b8de88d0
      version: -1
      name: Evaluate conditions for soft remediation
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "48"
      "yes":
      - "44"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: RiskyUser
            iscontext: true
          right:
            value: {}
        - operator: isNotEmpty
          left:
            value:
              simple: UserRiskyAzureDetections
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
        - operator: greaterThanOrEqual
          left:
            value:
              simple: Core.OriginalAlert.raw_abioc.event.features_sum
            iscontext: true
          right:
            value:
              simple: "2"
        - operator: isNotEmpty
          left:
            value:
              simple: MaliciousIP
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: SuspiciousUserAgent
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 854,
          "y": 2031
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: c3d13b4a-f46e-48e0-b773-7cb64690e6f0
    type: condition
    task:
      id: c3d13b4a-f46e-48e0-b773-7cb64690e6f0
      version: -1
      name: Evaluate Analyst Response for Next Action
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      Disable both:
      - "45"
      Disable target user:
      - "47"
      No Action:
      - "9"
      Disable source user:
      - "46"
    separatecontext: false
    conditions:
    - label: No Action
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: No Action
          ignorecase: true
    - label: Disable source user
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: Disable source user
          ignorecase: true
    - label: Disable target user
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: Disable target user
          ignorecase: true
    - label: Disable both
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: Disable both
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1075,
          "y": 2661
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: 47d4e985-1c95-4977-8508-87920395aa14
    type: title
    task:
      id: 47d4e985-1c95-4977-8508-87920395aa14
      version: -1
      name: Check User Agent
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "4"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 245,
          "y": 1544
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: 84ad8308-bf69-4697-9db2-1eb2604292b0
    type: regular
    task:
      id: 84ad8308-bf69-4697-9db2-1eb2604292b0
      version: -1
      name: Get source IP reputation results
      description: Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      key:
        simple: MaliciousIP
      value:
        complex:
          root: IPEnrichment
          filters:
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: IPEnrichment.TIMScore
                iscontext: true
              right:
                value:
                  simple: "3"
              ignorecase: true
          accessor: Value
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1063,
          "y": 1293
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: bfbd0706-89fd-41b5-9ee0-d5237b29254d
    type: regular
    task:
      id: bfbd0706-89fd-41b5-9ee0-d5237b29254d
      version: -1
      name: Save user risk score
      description: Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      key:
        simple: RiskyUser
      value:
        complex:
          root: UserData.RiskLevel
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: UserData.RiskLevel
                iscontext: true
              right:
                value:
                  simple: HIGH
              ignorecase: true
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1444,
          "y": 1779
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: 283afae7-24ad-4fac-803a-c155b9bb8244
    type: condition
    task:
      id: 283afae7-24ad-4fac-803a-c155b9bb8244
      version: -1
      name: Evaluate conditions for hard remediation
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "10"
      "yes":
      - "33"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: RiskyUser
            iscontext: true
          right:
            value: {}
        - operator: isNotEmpty
          left:
            value:
              simple: UserRiskyAzureDetections
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 854,
          "y": 2420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "42":
    id: "42"
    taskid: e2d42d80-1e9b-4df3-8730-d5b4979104b0
    type: regular
    task:
      id: e2d42d80-1e9b-4df3-8730-d5b4979104b0
      version: -1
      name: Revoke user session
      description: This script clears user sessions across multiple integrations for a list of usernames.
      scriptName: clear-user-session
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "41"
    scriptarguments:
      user_name:
        complex:
          root: Core.OriginalAlert.raw_abioc.event.identity_orig.user
          accessor: userPrincipalName
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 854,
          "y": 2289
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 015ac38f-ac39-4197-b473-f3f8f403a787
    type: regular
    task:
      id: 015ac38f-ac39-4197-b473-f3f8f403a787
      version: -1
      name: Get user risk score
      description: This script gathers user data from multiple integrations and returns an Account entity with consolidated information to the context.
      scriptName: get-user-data
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "39"
    scriptarguments:
      user_name:
        simple: ${alert.username}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1444,
          "y": 1655
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: f5bf613e-1c8a-4ac6-9c49-9a7dbf93cafd
    type: regular
    task:
      id: f5bf613e-1c8a-4ac6-9c49-9a7dbf93cafd
      version: -1
      name: Increase alert severity
      description: Optionally increases the alert severity to the new value if it is greater than the existing severity.
      scriptName: IncreaseAlertSeverity
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "42"
    scriptarguments:
      severity:
        simple: Medium
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 854,
          "y": 2159
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: c8d812c9-be7a-4548-84c9-596bcc3f1207
    type: regular
    task:
      id: c8d812c9-be7a-4548-84c9-596bcc3f1207
      version: -1
      name: Disable both users
      description: This script disables users for multiple services.
      scriptName: disable-user
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      brands:
        simple: Microsoft Graph User
      user_name:
        complex:
          root: Core.OriginalAlert.raw_abioc.event.identity_orig.user
          accessor: userPrincipalName
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: Core.OriginalAlert.event.raw_log.properties.targetResources.userPrincipalName
                iscontext: true
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2130,
          "y": 2798
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: 710a9ee7-2520-4506-afd6-64f6c939ccc6
    type: regular
    task:
      id: 710a9ee7-2520-4506-afd6-64f6c939ccc6
      version: -1
      name: Disable source user
      description: This script disables users for multiple services.
      scriptName: disable-user
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      brands:
        simple: Microsoft Graph User
      user_name:
        complex:
          root: Core.OriginalAlert.raw_abioc.event.identity_orig.user
          accessor: userPrincipalName
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1726,
          "y": 2798
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: 415f0e0b-f17c-4ada-a170-dc8b9ee58cfe
    type: regular
    task:
      id: 415f0e0b-f17c-4ada-a170-dc8b9ee58cfe
      version: -1
      name: Disable target user
      description: This script disables users for multiple services.
      scriptName: disable-user
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      brands:
        simple: Microsoft Graph User
      user_name:
        complex:
          root: Core.OriginalAlert.event.raw_log.properties.targetResources
          accessor: userPrincipalName
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1325,
          "y": 2798
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: 488284a1-cf66-4218-8722-44f7eadba617
    type: regular
    task:
      id: 488284a1-cf66-4218-8722-44f7eadba617
      version: -1
      name: Inconclusive | No suspicious evidence
      description: Saves a key in the context indicating no suspicious evidence was found.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: Builtin
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      key:
        simple: Inconclusive
      value:
        simple: No suspicious evidence
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 428,
          "y": 2159
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "35_45_Disable both": 0.78,
      "35_46_Disable source user": 0.74,
      "35_47_Disable target user": 0.53,
      "35_9_No Action": 0.68,
      "41_10_#default#": 0.67,
      "4_21_#default#": 0.1,
      "4_5_yes": 0.44
    },
    "paper": {
      "dimensions": {
        "height": 2290,
        "width": 2497,
        "x": 14,
        "y": 821
      }
    }
  }
inputs: []
outputs: []
fromversion: 8.9.0
issilent: true
marketplaces:
- marketplacev2
- platform
tests:
- No tests (auto formatted)
contentitemexportablefields:
  contentitemfields: {}
