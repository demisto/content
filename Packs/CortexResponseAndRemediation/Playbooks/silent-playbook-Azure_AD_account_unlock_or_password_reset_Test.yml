description: "**This playbook addresses the following alert**:\n- Azure AD account\
  \ unlock/successful password reset\n\n**Playbook Stages**:\n\n**Triage**:\n- Gather\
  \ initial information about the user.\n\n**Investigation**:\n- **Check IP Reputation**:\n\
  \  - Analyze the reputation of the IP address related to the alert.\n- **Check for\
  \ Azure Alerts**:\n  - Extract recent Azure security alerts for the user.\n- **Check\
  \ if User is Risky**:\n  - Assess the risk score of the user based on Core and Azure\
  \ risk indicators.\n  - Investigate reasons behind any identified risks, including\
  \ recent detections.\n\n**Containment**:\n- Check if feature sum is greater than\
  \ 2 (Possible features:new user agent/new asn/new country). If yes, continue to\
  \ revoke user's active sessions to ensure immediate containment.\nIf no, continue\
  \ to check investigation findings.\n- Provide a manual task for an analyst to review\
  \ the findings and decide the next steps.\n- Possible actions:\n  - Disable the\
  \ target user.\n  - Disable the resource user.\n  - Disable both users.\n  - Take\
  \ no action.\n\n**Requirements**:\nFor the best results, it's recommended to ensure\
  \ these integrations are configured and working:\n- `Cortex Core - Investigation\
  \ and Response` for Core user risk evaluation.\n- `Azure Risky Users` for retrieving\
  \ user risk scores.\n- `Microsoft 365 Defender` for advanced hunting queries and\
  \ Azure security alerts.\n- `Microsoft Graph User` for disabling accounts and revoking\
  \ sessions."
fromversion: 8.9.0
id: silent-Azure AD account unlock or password reset Test
inputs: []
issilent: true
marketplaces:
- marketplacev2
name: silent-Azure AD account unlock or password reset Test
outputs: []
starttaskid: '0'
tags:
- T1078 - Valid Accounts
- TA0003 - Persistence
tasks:
  '0':
    continueonerrortype: ''
    id: '0'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '2'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 5e4b610f-ffdb-423f-8fe1-c54b8ada2e68
      iscommand: false
      name: ''
      version: -1
    taskid: 5e4b610f-ffdb-423f-8fe1-c54b8ada2e68
    timertriggers: []
    type: start
    view: "{\n  \"position\": {\n    \"x\": 860,\n    \"y\": 190\n  }\n}"
  '1':
    continueonerrortype: ''
    id: '1'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '3'
      - '11'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: ce1b1b8f-0d0f-4983-84d4-c071ecfc0ee5
      iscommand: false
      name: Enrich IP
      type: title
      version: -1
    taskid: ce1b1b8f-0d0f-4983-84d4-c071ecfc0ee5
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 860,\n    \"y\": 480\n  }\n}"
  '10':
    continueonerrortype: ''
    id: '10'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: a7b912f5-66c7-4190-8639-55d1d2860720
      iscommand: false
      name: Done
      type: title
      version: -1
    taskid: a7b912f5-66c7-4190-8639-55d1d2860720
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 850,\n    \"y\": 3400\n  }\n}"
  '11':
    continueonerrortype: ''
    id: '11'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '19'
      - '20'
      - '37'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: c870efe1-6e26-4239-8283-bd8907b6edd3
      iscommand: false
      name: Investigtion
      type: title
      version: -1
    taskid: c870efe1-6e26-4239-8283-bd8907b6edd3
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 860,\n    \"y\": 970\n  }\n}"
  '13':
    continueonerror: true
    continueonerrortype: ''
    id: '13'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '22'
    note: false
    quietmode: 0
    scriptarguments:
      updated_after:
        simple: 1 day
    separatecontext: false
    skipunavailable: true
    task:
      brand: ''
      description: Returns a list of all risky users and their properties.
      id: bff3bca0-fccb-41e1-8947-57c8dc132d8f
      iscommand: true
      name: Get Azure user risk score
      script: '|||azure-risky-users-list'
      type: regular
      version: -1
    taskid: bff3bca0-fccb-41e1-8947-57c8dc132d8f
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 1500,\n    \"y\": 1260\n  }\n}"
  '14':
    continueonerror: true
    continueonerrortype: ''
    id: '14'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '24'
    note: false
    quietmode: 0
    scriptarguments:
      query:
        simple: let _start = now(-1d); AlertEvidence | where Timestamp >= _start |
          where AccountUpn == "${Core.OriginalAlert.raw_abioc.event.identity_invoked_by_name}"
    separatecontext: false
    skipunavailable: true
    task:
      brand: ''
      description: 'Advanced hunting is a threat-hunting tool that uses specially
        constructed queries to examine the past 30 days of event data in Microsoft
        365 Defender. Details on how to write queries: https://docs.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-query-language?view=o365-worldwide.'
      id: 9031985a-2a22-409b-8121-ad55fcb546c5
      iscommand: true
      name: 'Get Azure user alerts '
      script: '|||microsoft-365-defender-advanced-hunting'
      type: regular
      version: -1
    taskid: 9031985a-2a22-409b-8121-ad55fcb546c5
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 1070,\n    \"y\": 1260\n  }\n}"
  '15':
    continueonerrortype: ''
    id: '15'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '32'
    note: false
    quietmode: 0
    scriptarguments:
      fromdate:
        simple: 3 hours ago
      query:
        simple: "(name:\"Suspicious authentication method addition to Azure account\"\
          \ or name:\"Suspicious Azure AD Administrator Role assignment\u05F4 or name:\u05F4\
          Abnormal sign-in followed by suspicious activity in Azure AD\") and caller_ip=${alert.hostip}"
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: 'Searches Demisto alerts. A summarized version of this script is
        available with the summarizedversion argument.


        This automation runs using the default Limited User role, unless you explicitly
        change the permissions.

        For more information, see the section about permissions here:

        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSIAM/Cortex-XSIAM-Administrator-Guide/Permission-Management'
      id: 4a1449ce-823c-4225-8208-8002607aadf5
      iscommand: false
      name: Get source IP related alerts
      scriptName: SearchAlertsV2
      type: regular
      version: -1
    taskid: 4a1449ce-823c-4225-8208-8002607aadf5
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 640,\n    \"y\": 1260\n  }\n}"
  '16':
    continueonerrortype: ''
    id: '16'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '39'
    note: false
    quietmode: 0
    scriptarguments:
      user_id:
        simple: ${alert.username}
    separatecontext: false
    skipunavailable: true
    task:
      brand: ''
      description: Retrieve the risk score of a specific user or list of users with
        the highest risk score in the environment along with the reason affecting
        each score.
      id: 7f0ec57c-0d61-4b37-8086-2f71a31beb9a
      iscommand: true
      name: Get core risky user
      script: '|||core-list-risky-users'
      type: regular
      version: -1
    taskid: 7f0ec57c-0d61-4b37-8086-2f71a31beb9a
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 2160,\n    \"y\": 1590\n  }\n}"
  '18':
    continueonerrortype: ''
    id: '18'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '21'
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: RiskyUserReason
      value:
        complex:
          accessor: description
          root: Core.RiskyUser.reasons
          transformers:
          - operator: uniq
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Set a value in context under the key you entered. If no value is
        entered, the script doesn't do anything.\n\nThis automation runs using the
        default Limited User role, unless you explicitly change the permissions.\nFor
        more information, see the section about permissions here:\n- For Cortex see
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n-
        For Cortex.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      id: 10eb3e27-4068-4ee5-8d18-08db15710e1d
      iscommand: false
      name: Extract user risk reasons
      scriptName: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: 10eb3e27-4068-4ee5-8d18-08db15710e1d
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 2160,\n    \"y\": 1910\n  }\n}"
  '19':
    continueonerrortype: ''
    id: '19'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '13'
      - '16'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: d12fe789-b844-48ed-8097-78aa7af90a55
      iscommand: false
      name: Check if user is risky
      type: title
      version: -1
    taskid: d12fe789-b844-48ed-8097-78aa7af90a55
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 1500,\n    \"y\": 1120\n  }\n}"
  '2':
    continueonerrortype: ''
    id: '2'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '1'
    note: false
    quietmode: 0
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: 'false'
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Returns information about each alert ID.
      id: 3bc71303-5ccd-4f2f-8761-aeeb4671c954
      iscommand: true
      name: Get event information
      script: '|||core-get-cloud-original-alerts'
      type: regular
      version: -1
    taskid: 3bc71303-5ccd-4f2f-8761-aeeb4671c954
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 860,\n    \"y\": 320\n  }\n}"
  '20':
    continueonerrortype: ''
    id: '20'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '15'
      - '14'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: d8ce9808-3363-48c1-86b5-7b5ca9c883fe
      iscommand: false
      name: Check for related alerts
      type: title
      version: -1
    taskid: d8ce9808-3363-48c1-86b5-7b5ca9c883fe
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 860,\n    \"y\": 1120\n  }\n}"
  '21':
    continueonerrortype: ''
    id: '21'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '34'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 3e571631-0c12-4a50-87a0-4edb5a5988e1
      iscommand: false
      name: Remediation
      type: title
      version: -1
    taskid: 3e571631-0c12-4a50-87a0-4edb5a5988e1
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 850,\n    \"y\": 2080\n  }\n}"
  '22':
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              complex:
                filters:
                - - left:
                      iscontext: true
                      value:
                        simple: AzureRiskyUsers.RiskyUser.userPrincipalName
                    operator: in
                    right:
                      iscontext: true
                      value:
                        simple: Core.OriginalAlert.event.identity_orig.user.userPrincipalName
                root: AzureRiskyUsers.RiskyUser.userPrincipalName
                transformers:
                - operator: uniq
          operator: isEqualString
          right:
            iscontext: true
            value:
              complex:
                accessor: userPrincipalName
                root: Core.OriginalAlert.event.identity_orig.user
                transformers:
                - operator: uniq
      label: 'yes'
    continueonerrortype: ''
    id: '22'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '21'
      'yes':
      - '27'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 5704aa11-540c-495a-8af9-108025d7a5fe
      iscommand: false
      name: Check user azure risk score
      type: condition
      version: -1
    taskid: 5704aa11-540c-495a-8af9-108025d7a5fe
    timertriggers: []
    type: condition
    view: "{\n  \"position\": {\n    \"x\": 1500,\n    \"y\": 1420\n  }\n}"
  '24':
    continueonerrortype: ''
    id: '24'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '21'
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: AzureSecurityAlerts
      value:
        complex:
          accessor: Title
          root: Microsoft365Defender.Hunt.results
          transformers:
          - operator: uniq
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Set a value in context under the key you entered. If no value is
        entered, the script doesn't do anything.\n\nThis automation runs using the
        default Limited User role, unless you explicitly change the permissions.\nFor
        more information, see the section about permissions here:\n- For Cortex XSOAR
        6.x see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n-
        For Cortex XSOAR On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      id: ed4dabc2-05b3-4032-8034-bd5376d17f9f
      iscommand: false
      name: Extract Azure user alerts
      scriptName: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: ed4dabc2-05b3-4032-8034-bd5376d17f9f
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 1070,\n    \"y\": 1420\n  }\n}"
  '25':
    continueonerrortype: ''
    id: '25'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '26'
    note: false
    quietmode: 0
    scriptarguments:
      detected_date_time_after:
        simple: ${TimeNow}
    separatecontext: false
    skipunavailable: true
    task:
      brand: ''
      description: Returns a comma-separated list of the Risk Detection objects and
        their properties.
      id: 56edf542-2170-4215-8659-844df93992e1
      iscommand: true
      name: Get user risky detection list
      script: '|||azure-risky-users-risk-detections-list'
      type: regular
      version: -1
    taskid: 56edf542-2170-4215-8659-844df93992e1
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 1750,\n    \"y\": 1750\n  }\n}"
  '26':
    continueonerrortype: ''
    id: '26'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '21'
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: UserRiskyAzureDetections
      value:
        complex:
          accessor: riskEventType
          filters:
          - - left:
                iscontext: true
                value:
                  simple: AzureRiskyUsers.RiskDetection.userPrincipalName
              operator: in
              right:
                iscontext: true
                value:
                  simple: Core.OriginalAlert.event.identity_orig.user.userPrincipalName
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
              operator: isEqualString
              right:
                value:
                  simple: atRisk
            - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
              operator: isEqualString
              right:
                value:
                  simple: confirmedCompromised
          root: AzureRiskyUsers.RiskDetection
          transformers:
          - operator: uniq
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Set a value in context under the key you entered. If no value is
        entered, the script doesn't do anything.\n\nThis automation runs using the
        default Limited User role, unless you explicitly change the permissions.\nFor
        more information, see the section about permissions here:\n- For Cortex XSOAR
        6.x see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n-
        For Cortex XSOAR On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      id: fa26a407-b086-48c3-8eb5-7d306d91c7fe
      iscommand: false
      name: Extract Azure user detections
      scriptName: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: fa26a407-b086-48c3-8eb5-7d306d91c7fe
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 1750,\n    \"y\": 1910\n  }\n}"
  '27':
    continueonerrortype: ''
    id: '27'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '25'
    note: false
    quietmode: 0
    scriptarguments:
      dateFormat:
        simple: ISO
      daysAgo:
        simple: '1'
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: 'Retrieves the current date and time.

        '
      id: c1105dd3-87ba-458e-8d93-d1a8e60f2c6d
      iscommand: false
      name: Get timestamp for Azure detections
      scriptName: GetTime
      type: regular
      version: -1
    taskid: c1105dd3-87ba-458e-8d93-d1a8e60f2c6d
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 1750,\n    \"y\": 1590\n  }\n}"
  '3':
    continueonerror: true
    continueonerrortype: ''
    id: '3'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '38'
    note: false
    quietmode: 0
    scriptarguments:
      ip:
        complex:
          accessor: '[0]'
          root: alert.hostip
          transformers:
          - operator: uniq
    separatecontext: false
    skipunavailable: true
    task:
      brand: ''
      description: Checks the reputation of an IP address.
      id: 969fb1db-b3df-4a51-8489-b1060bebf3fe
      iscommand: true
      name: Check source IP reputation
      script: '|||ip'
      type: regular
      version: -1
    taskid: 969fb1db-b3df-4a51-8489-b1060bebf3fe
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 1070,\n    \"y\": 620\n  }\n}"
  '31':
    continueonerrortype: ''
    id: '31'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '9'
    note: false
    quietmode: 0
    scriptarguments:
      user:
        complex:
          accessor: userPrincipalName
          root: Core.OriginalAlert.event.raw_log.properties.targetResources
          transformers:
          - operator: uniq
    separatecontext: false
    skipunavailable: true
    task:
      brand: ''
      description: 'Disables a user from all Office 365 applications, and prevents
        sign in. Note: This command disables a user,

        but does not terminate an existing session. Supported only in a self-deployed
        app flow with the

        Permission: Directory.AccessAsUser.All(Delegated).'
      id: a6ee8fab-96cd-402e-8270-a64f974ab311
      iscommand: true
      name: Disable target user
      script: '|||msgraph-user-account-disable'
      type: regular
      version: -1
    taskid: a6ee8fab-96cd-402e-8270-a64f974ab311
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 1270,\n    \"y\": 3065\n  }\n}"
  '32':
    continueonerrortype: ''
    id: '32'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '21'
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: CallerIpAlerts
      value:
        complex:
          accessor: name
          root: foundIncidents
          transformers:
          - operator: uniq
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Set a value in context under the key you entered. If no value is
        entered, the script doesn't do anything.\n\nThis automation runs using the
        default Limited User role, unless you explicitly change the permissions.\nFor
        more information, see the section about permissions here:\n- For Cortex see
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n-
        For Cortex.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      id: 88ee5b7e-f3e5-4ed3-84ee-46196dbc2c14
      iscommand: false
      name: Extract source ip related alerts
      scriptName: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: 88ee5b7e-f3e5-4ed3-84ee-46196dbc2c14
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 640,\n    \"y\": 1420\n  }\n}"
  '33':
    continueonerrortype: ''
    form:
      description: Analyst review.
      expired: false
      questions:
      - defaultrows: []
        fieldassociated: ''
        gridcolumns: []
        id: '0'
        label: ''
        labelarg:
          simple: '#### Resource User:

            `${Core.OriginalAlert.raw_abioc.event.identity_orig.user.userPrincipalName}`


            #### Target User:

            `${Core.OriginalAlert.event.raw_log.properties.targetResources.userPrincipalName}`


            ---


            ### Malicious Indicators Found:

            - **Malicious IP**: `${.=val.MaliciousIP || "None"}`

            - **Malicious User Agent**: `${.=val.SuspiciousUserAgent || "None"}`


            ---


            ### User Risk Analysis:

            - **User is risky (Core)**: `${.=val.UserRiskyCoreReason ? "Yes, Reason:
            " + val.UserRiskyCoreReason : "N/A"}`

            - **User is risky (Azure)**: `${.=val.UserRiskyAzureDetections ? "Yes,
            Risk Types: " + val.UserRiskyAzureDetections : "N/A"}`


            ---


            ### User Azure Security Alerts:

            - **Alerts from last day**: `${.=val.AzureSecurityAlerts || "N/A"}`


            ---


            ### Caller IP Related Alerts

            - `${.=val.CallerIpAlerts || "N/A"}`


            ---


            ### Action Required:

            Please choose the action you want to perform.'
        options: []
        optionsarg:
        - simple: No Action
        - simple: Disable resource user
        - simple: Disable target user
        - simple: Disable both
        placeholder: ''
        readonly: false
        required: false
        tooltip: ''
        type: singleSelect
      sender: ''
      title: Analyst Action
      totalanswers: 0
    id: '33'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    message:
      bcc: null
      body: null
      cc: null
      format: ''
      methods: []
      subject: null
      timings:
        completeafterreplies: 1
        completeaftersla: false
        completeafterv2: true
        retriescount: 2
        retriesinterval: 360
      to: null
    nexttasks:
      '#none#':
      - '35'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 824395c1-ba17-412d-862a-2e55fdea816a
      iscommand: false
      name: Manual Task - Disable user account decision
      type: collection
      version: -1
    taskid: 824395c1-ba17-412d-862a-2e55fdea816a
    timertriggers: []
    type: collection
    view: "{\n  \"position\": {\n    \"x\": 1060,\n    \"y\": 2730\n  }\n}"
  '34':
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: CoreRiskyUser
          operator: isNotEmpty
          right:
            value: {}
        - left:
            iscontext: true
            value:
              simple: UserRiskyAzureDetections
          operator: isNotEmpty
        - left:
            iscontext: true
            value:
              simple: foundIncidents.name
          operator: isNotEmpty
        - left:
            iscontext: true
            value:
              simple: Core.OriginalAlert.raw_abioc.event.features_sum
          operator: greaterThanOrEqual
          right:
            value:
              simple: '2'
        - left:
            iscontext: true
            value:
              simple: MaliciousIP
          operator: isNotEmpty
        - left:
            iscontext: true
            value:
              simple: SuspiciousUserAgent
          operator: isNotEmpty
      label: 'yes'
    continueonerrortype: ''
    id: '34'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '41'
      'yes':
      - '40'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 9507bf6e-0bea-4883-80e1-695e5b21b167
      iscommand: false
      name: Evaluate conditions for soft remediation
      type: condition
      version: -1
    taskid: 9507bf6e-0bea-4883-80e1-695e5b21b167
    timertriggers: []
    type: condition
    view: "{\n  \"position\": {\n    \"x\": 850,\n    \"y\": 2210\n  }\n}"
  '35':
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: Analyst Action.Answers.0
          operator: isEqualString
          right:
            value:
              simple: No Action
      label: No Action
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: Analyst Action.Answers.0
          operator: isEqualString
          right:
            value:
              simple: Disable resource user
      label: Disable resource user
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: Analyst Action.Answers.0
          operator: isEqualString
          right:
            value:
              simple: Disable target user
      label: Disable target user
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: Analyst Action.Answers.0
          operator: isEqualString
          right:
            value:
              simple: Disable both
      label: Disable both
    continueonerrortype: ''
    id: '35'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      Disable both:
      - '36'
      Disable resource user:
      - '8'
      Disable target user:
      - '31'
      No Action:
      - '9'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 8716fa1c-18b7-4d93-8e5f-16ab80309eb4
      iscommand: false
      name: Evaluate Analyst Response for Next Action
      type: condition
      version: -1
    taskid: 8716fa1c-18b7-4d93-8e5f-16ab80309eb4
    timertriggers: []
    type: condition
    view: "{\n  \"position\": {\n    \"x\": 1060,\n    \"y\": 2890\n  }\n}"
  '36':
    continueonerrortype: ''
    id: '36'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '9'
    note: false
    quietmode: 0
    scriptarguments:
      user:
        complex:
          accessor: userPrincipalName
          root: Core.OriginalAlert.raw_abioc.event.identity_orig.user
          transformers:
          - args:
              item:
                iscontext: true
                value:
                  simple: ${Core.OriginalAlert.event.raw_log.properties.targetResources.userPrincipalName}
            operator: append
          - operator: uniq
    separatecontext: false
    skipunavailable: true
    task:
      brand: ''
      description: 'Disables a user from all Office 365 applications, and prevents
        sign in. Note: This command disables a user,

        but does not terminate an existing session. Supported only in a self-deployed
        app flow with the

        Permission: Directory.AccessAsUser.All(Delegated).'
      id: 1af19eea-5223-4d7f-8852-d18e51a9c561
      iscommand: true
      name: Disable both users
      script: '|||msgraph-user-account-disable'
      type: regular
      version: -1
    taskid: 1af19eea-5223-4d7f-8852-d18e51a9c561
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 2060,\n    \"y\": 3065\n  }\n}"
  '37':
    continueonerrortype: ''
    id: '37'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '4'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 47d4e985-1c95-4977-8508-87920395aa14
      iscommand: false
      name: Check User Agent
      type: title
      version: -1
    taskid: 47d4e985-1c95-4977-8508-87920395aa14
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 200,\n    \"y\": 1120\n  }\n}"
  '38':
    continueonerrortype: ''
    id: '38'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '11'
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: MaliciousIP
      value:
        complex:
          accessor: Indicator
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: DBotScore.Type
              operator: isEqualString
              right:
                value:
                  simple: ip
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: DBotScore.Score
              operator: greaterThanOrEqual
              right:
                value:
                  simple: '3'
          root: DBotScore
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Set a value in context under the key you entered. If no value is
        entered, the script doesn't do anything.\n\nThis automation runs using the
        default Limited User role, unless you explicitly change the permissions.\nFor
        more information, see the section about permissions here:\n- For Cortex see
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n-
        For Cortex.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      id: 3bcedb8d-530d-48fd-87dc-bda42c0f67c8
      iscommand: false
      name: Get source IP reputation results
      scriptName: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: 3bcedb8d-530d-48fd-87dc-bda42c0f67c8
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 1070,\n    \"y\": 785\n  }\n}"
  '39':
    continueonerrortype: ''
    id: '39'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '18'
    note: false
    quietmode: 0
    scriptarguments:
      key:
        simple: CoreRiskyUser
      value:
        complex:
          filters:
          - - ignorecase: true
              left:
                iscontext: true
                value:
                  simple: Core.RiskyUser.risk_level
              operator: isEqualString
              right:
                value:
                  simple: HIGH
          root: Core.RiskyUser
          transformers:
          - operator: uniq
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Set a value in context under the key you entered. If no value is
        entered, the script doesn't do anything.\n\nThis automation runs using the
        default Limited User role, unless you explicitly change the permissions.\nFor
        more information, see the section about permissions here:\n- For Cortex see
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n-
        For Cortex.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      id: e6c72ffe-f542-4967-8e36-0a601dae93fc
      iscommand: false
      name: Extract user risk score
      scriptName: SetAndHandleEmpty
      type: regular
      version: -1
    taskid: e6c72ffe-f542-4967-8e36-0a601dae93fc
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 2160,\n    \"y\": 1750\n  }\n}"
  '4':
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: Core.OriginalAlert.event.user_agent_data
          operator: isNotEmpty
      label: 'yes'
    continueonerrortype: ''
    id: '4'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '21'
      'yes':
      - '5'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: e9a066c5-a971-4c93-8339-89f10881daf2
      iscommand: false
      name: Check user agent
      type: condition
      version: -1
    taskid: e9a066c5-a971-4c93-8339-89f10881daf2
    timertriggers: []
    type: condition
    view: "{\n  \"position\": {\n    \"x\": 200,\n    \"y\": 1260\n  }\n}"
  '40':
    continueonerrortype: ''
    id: '40'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '41'
    note: false
    quietmode: 0
    scriptarguments:
      user:
        complex:
          accessor: userPrincipalName
          root: Core.OriginalAlert.raw_abioc.event.identity_orig.user
          transformers:
          - operator: uniq
    separatecontext: false
    skipunavailable: true
    task:
      brand: ''
      description: 'Revoke a user session- Invalidates all the refresh tokens issued
        to applications for a user.

        Permission: Directory.AccessAsUser.All(Delegated).'
      id: f0ec862f-1615-4c5a-80c2-c5b55cc983a0
      iscommand: true
      name: Revoke user session
      script: '|||msgraph-user-session-revoke'
      type: regular
      version: -1
    taskid: f0ec862f-1615-4c5a-80c2-c5b55cc983a0
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 1060,\n    \"y\": 2390\n  }\n}"
  '41':
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: CoreRiskyUser
          operator: isNotEmpty
          right:
            value: {}
        - left:
            iscontext: true
            value:
              simple: UserRiskyAzureDetections
          operator: isNotEmpty
        - left:
            iscontext: true
            value:
              simple: foundIncidents.name
          operator: isNotEmpty
      label: 'yes'
    continueonerrortype: ''
    id: '41'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '9'
      'yes':
      - '33'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: e61bd954-7afa-4a37-8b15-ef9959339128
      iscommand: false
      name: Evaluate conditions for hard remediation
      type: condition
      version: -1
    taskid: e61bd954-7afa-4a37-8b15-ef9959339128
    timertriggers: []
    type: condition
    view: "{\n  \"position\": {\n    \"x\": 850,\n    \"y\": 2560\n  }\n}"
  '5':
    continueonerrortype: ''
    id: '5'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '21'
    note: false
    quietmode: 0
    scriptarguments:
      contextKey:
        simple: SuspiciousUserAgent
      data:
        simple: ${Core.OriginalAlert.event.user_agent_data}
      regex:
        simple: \b(Python-urllib|libwww-perl|Scrapy|curl|Wget|sqlmap|Nikto|Xrumer|Hydra|JohnTheRipper|LOIC|HOIC|MJ12bot|Baiduspider|BlackWidow|HeadlessChrome|PhantomJS|Selenium|REST)\b
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Extracts regex data from the provided text. The script support
        groups and looping.
      id: 8b56f37b-d3ad-46fd-8a71-21e6dfc498ec
      iscommand: false
      name: Extract suspicious user agent
      scriptName: MatchRegexV2
      type: regular
      version: -1
    taskid: 8b56f37b-d3ad-46fd-8a71-21e6dfc498ec
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 40,\n    \"y\": 1450\n  }\n}"
  '8':
    continueonerrortype: ''
    id: '8'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '9'
    note: false
    quietmode: 0
    scriptarguments:
      user:
        complex:
          accessor: userPrincipalName
          root: Core.OriginalAlert.raw_abioc.event.identity_orig.user
          transformers:
          - operator: uniq
    separatecontext: false
    skipunavailable: true
    task:
      brand: ''
      description: 'Disables a user from all Office 365 applications, and prevents
        sign in. Note: This command disables a user,

        but does not terminate an existing session. Supported only in a self-deployed
        app flow with the

        Permission: Directory.AccessAsUser.All(Delegated).'
      id: c752a467-d872-4669-87e9-689bbef4e94f
      iscommand: true
      name: Disable source user
      script: '|||msgraph-user-account-disable'
      type: regular
      version: -1
    taskid: c752a467-d872-4669-87e9-689bbef4e94f
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 1660,\n    \"y\": 3065\n  }\n}"
  '9':
    continueonerrortype: ''
    id: '9'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '10'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: commands.local.cmd.close.inv
      id: ac620832-65be-484c-822b-56339cdfbddb
      iscommand: true
      name: Close Alert
      script: Builtin|||closeInvestigation
      type: regular
      version: -1
    taskid: ac620832-65be-484c-822b-56339cdfbddb
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 850,\n    \"y\": 3235\n  }\n}"
tests:
- No tests (auto formatted)
version: -1
view: "{\n  \"linkLabelsPosition\": {\n    \"22_21_#default#\": 0.1,\n    \"22_27_yes\"\
  : 0.5,\n    \"34_40_yes\": 0.54,\n    \"34_41_#default#\": 0.49,\n    \"35_31_Disable\
  \ target user\": 0.62,\n    \"35_8_Disable resource user\": 0.67,\n    \"35_9_No\
  \ Action\": 0.45,\n    \"41_33_yes\": 0.56,\n    \"4_21_#default#\": 0.13,\n   \
  \ \"4_5_yes\": 0.44\n  },\n  \"paper\": {\n    \"dimensions\": {\n      \"height\"\
  : 3275,\n      \"width\": 2500,\n      \"x\": 40,\n      \"y\": 190\n    }\n  }\n\
  }"
