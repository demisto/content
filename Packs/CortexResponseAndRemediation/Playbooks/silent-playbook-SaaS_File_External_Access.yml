id: 'silent-SaaS File External Access'
version: -1
name: 'silent-SaaS File External Access'
description: |-
  ### This playbook addresses the following alerts:
  - External user accessed a sensitive SaaS file via anonymous link.

  ### Playbook Stages:

  #### Triage:
  - Retrieve past **file activities**.
  - Gather the **users** involved in the SaaS file (e.g., owner, sharer, actor).
  - Get **any anomalies** related to the alert.

  #### Investigation:
  - Analyze the **IP/domain/email** reputation.
  - Assess the user's **risk level** in Cortex.
  - Verify that the sharing link has not been forgotten.
  - Determine if the user account has been **disabled or deleted**.
  - Look for the sharer user's anonymous link creation count.
  - Search for medium or high **Azure Risk Detections and Defender Alerts** (*SharePoint/OneDrive only*).
  - Check for anomalies in **User Agent, ASN, and Geo-location** (*SharePoint/OneDrive only*).
  - Check the actor user's frequency of accessing various external files (*Drive only*).

  #### Verdict:
  - If there are at least *2 pieces of LOW* evidence.
  - **OR** if there are at least *1 piece of HIGH* evidence.

  #### Remediation:
  - *Immediately* delete anonymous links from the file.
  - Delete all file permissions (*approval needed*).
  - Notify the owner and/or their manager (*approval needed*).

  ### Requirements:

  #### Triage:
  - `Microsoft Graph Files`/`Google Drive` for retrieving **File Activities**.

  #### Investigation:
  - `Azure Risky Users` or `MSGraph Identity and Access` for retrieving **Azure Risk Detections**.
  - `Microsoft 365 Defender` for retrieving **Defender Alerts**.
  - `Microsoft Graph User`/`GSuite Admin` for retrieving user properties.
  - `XQL Query Engine` to count past events.

  #### Remediation:
  - `Microsoft Graph Files`/`Google Drive` for removing permissions.
  - `Mail Sender` or a similar intergration (e.g., Gmail, EWS) for notifying.
tags:
- T1530 - Data from Cloud Storage
- TA0009 - Collection
fromversion: 8.9.0
issilent: true
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 787b4329-0fc3-49bd-824b-c9dd163df035
    type: start
    task:
      id: 787b4329-0fc3-49bd-824b-c9dd163df035
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 449,
          "y": 260
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 39391c99-d941-4f0a-8b82-0f11b1ae2e58
    type: title
    task:
      id: 39391c99-d941-4f0a-8b82-0f11b1ae2e58
      version: -1
      name: Triage
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 449,
          "y": 378
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 0799179e-8dc6-4dab-aac9-aa370b4f8848
    type: regular
    task:
      id: 0799179e-8dc6-4dab-aac9-aa370b4f8848
      version: -1
      name: Get Extended Alert Data
      description: Provides additional information about the alert, such as **users, IP address, anomalies, SaaS raw log** (extended context).
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      extend-context:
        simple: RawLog=alerts.[0].original_alert_json=JSON.parse(val).raw_abioc.event.raw_log
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 449,
          "y": 505
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 3baf1f29-cf45-467b-999e-1648df42bbcb
    type: condition
    task:
      id: 3baf1f29-cf45-467b-999e-1648df42bbcb
      version: -1
      name: Check SaaS Service
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "11"
      Drive:
      - "10"
      - "4"
      SharePoint/OneDrive:
      - "7"
      - "5"
    separatecontext: false
    conditions:
    - label: SharePoint/OneDrive
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: SharePoint
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: OneDrive
          ignorecase: true
    - label: Drive
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: Drive
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 449,
          "y": 625
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: 1c5e6f05-bbe7-4a59-838c-8eaea385cab0
    type: regular
    task:
      id: 1c5e6f05-bbe7-4a59-838c-8eaea385cab0
      version: -1
      name: Set Actor & Owner Users
      description: |-
        **Actor**: The user who **accessed** or **viewed** the file via the anonymous link.
        **Owner**: The user who **uploaded** or **owns** the file.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      key:
        simple: InvestigationUsers
      value:
        complex:
          root: Core.OriginalAlert
          accessor: event
          transformers:
          - operator: jmespath
            args:
              expression:
                value:
                  simple: |-
                    {
                    Actor:{UPN: identity_name},
                    Owner:{UPN: google_drive_owner}
                    }
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 694,
          "y": 771
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: ce16b5ec-4b28-4b6a-b283-e3f460396a1c
    type: regular
    task:
      id: ce16b5ec-4b28-4b6a-b283-e3f460396a1c
      version: -1
      name: Set Actor User
      description: |-
        **Actor**: The user who **accessed** or **viewed** the file via the anonymous link.
        In *SharePoint/OneDrive*, actor user is available rarely.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      key:
        simple: InvestigationUsers.Actor
      value:
        complex:
          root: Core.OriginalAlert.event.identity_name
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: Core.OriginalAlert.event.identity_name
                iscontext: true
              right:
                value:
                  simple: '#ext#'
              ignorecase: true
          transformers:
          - operator: DT
            args:
              dt:
                value:
                  simple: .={"UPN":val.split('#ext#')[0].replace(/_(?=[^_]*$)/, '@')}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 214,
          "y": 771
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 93411c32-e479-46eb-aef5-25b18fd4c86f
    type: regular
    task:
      id: 93411c32-e479-46eb-aef5-25b18fd4c86f
      version: -1
      name: Get File Owner User Details
      description: Gathers more **owner** user details to determine owner's legitimacy.
      script: '|||gsuite-user-get'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "77"
    scriptarguments:
      ignore-outputs:
        simple: "false"
      user:
        simple: ${InvestigationUsers.Owner.UPN}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1892,
          "y": 1662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: a2057309-b931-4dd8-bc8f-aa3a6b83ae72
    type: regular
    task:
      id: a2057309-b931-4dd8-bc8f-aa3a6b83ae72
      version: -1
      name: Get SharePoint File Activities
      description: Retrieves past **file** activity in SharePoint/OneDrive.
      script: '|||msgraph-list-drives-in-site'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "71"
      - "70"
    scriptarguments:
      extend-context:
        simple: MsGraphFiles.Activities=value
      ignore-outputs:
        simple: "true"
      site_id:
        simple: ${RawLog.Site}/drive/items/${RawLog.ListItemUniqueId}/activities?
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -188.5,
          "y": 771
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: a8019d42-2c0e-4943-bc1d-69ffec15f687
    type: regular
    task:
      id: a8019d42-2c0e-4943-bc1d-69ffec15f687
      version: -1
      name: Get File Owner+Sharer Users Details
      description: Gathers more **owner/sharer** user details to determine user's legitimacy.
      script: '|||msgraph-user-get'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "54"
    scriptarguments:
      properties:
        simple: ID,UserPrincipalName,AccountEnabled,DeletedDateTime
      user:
        complex:
          root: InvestigationUsers.Owner
          accessor: UPN
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: InvestigationUsers.Sharer.UPN
                iscontext: true
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 676,
          "y": 1662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: 6387057f-5c95-46d0-8245-c6102fb214a0
    type: regular
    task:
      id: 6387057f-5c95-46d0-8245-c6102fb214a0
      version: -1
      name: Get Drive File Activities
      description: Retrieves past **file** activity in Google Drive.
      script: '|||google-drive-activity-list'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "79"
    scriptarguments:
      item_name:
        simple: items/${Core.OriginalAlert.event.referenced_resource}
      user_id:
        simple: ${Core.OriginalAlert.event.google_drive_owner}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1089,
          "y": 771
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: e2f7ccd1-27d3-49ae-88b2-7a48028d4a94
    type: title
    task:
      id: e2f7ccd1-27d3-49ae-88b2-7a48028d4a94
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "12"
      - "25"
      - "69"
      - "88"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1139
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: c216bd59-7b84-4e73-878b-414ce712a433
    type: title
    task:
      id: c216bd59-7b84-4e73-878b-414ce712a433
      version: -1
      name: Users Indicators Enrichment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "19"
      - "13"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1846,
          "y": 1267
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: aa508004-a077-4482-a8cd-ef3b5b3353d0
    type: condition
    task:
      id: aa508004-a077-4482-a8cd-ef3b5b3353d0
      version: -1
      name: Has the Actor IP returned?
      description: In *Drive* alerts, actor IP address is available rarely.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "37"
      "yes":
      - "14"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: Core.OriginalAlert.event.caller_ip
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2050,
          "y": 1454
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: a9bd170f-11e3-4f70-ba88-af34c82690b5
    type: regular
    task:
      id: a9bd170f-11e3-4f70-ba88-af34c82690b5
      version: -1
      name: Enrich Actor IP
      script: '|||ip'
      type: regular
      iscommand: true
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      ip:
        simple: ${Core.OriginalAlert.event.caller_ip}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -2252,
          "y": 1662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 4c6a537a-086e-4806-a042-f62711663c6e
    type: regular
    task:
      id: 4c6a537a-086e-4806-a042-f62711663c6e
      version: -1
      name: Enrich Domains
      script: '|||domain'
      type: regular
      iscommand: true
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      domain:
        complex:
          root: InvestigationUsers.Actor
          accessor: UPN
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: InvestigationUsers.Owner.UPN
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: InvestigationUsers.Sharer.UPN
                iscontext: true
          - operator: RemoveEmpty
            args:
              empty_values: {}
              remove_keys: {}
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '@'
              fields:
                value:
                  simple: "2"
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1846,
          "y": 1662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: f5dba435-f08e-4811-bc72-d009ac7e007b
    type: regular
    task:
      id: f5dba435-f08e-4811-bc72-d009ac7e007b
      version: -1
      name: Save Malicious User Indicators
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      key:
        simple: Evidence.Low.MaliciousUserIndicator
      value:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: IP
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: Domain
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: Email
              ignorecase: true
          - - operator: greaterThan
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "2"
          accessor: Indicator
          transformers:
          - operator: join
            args:
              separator:
                value:
                  simple: ' | '
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1846,
          "y": 1795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: 47c384da-bfcb-4b9a-bbaa-0b78e0ee8f42
    type: condition
    task:
      id: 47c384da-bfcb-4b9a-bbaa-0b78e0ee8f42
      version: -1
      name: Has a User returned?
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "37"
      "yes":
      - "22"
      - "17"
      - "20"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: InvestigationUsers
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1224,
          "y": 1454
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: ac4dcd87-0b8d-4760-a926-cd81ce44b795
    type: regular
    task:
      id: ac4dcd87-0b8d-4760-a926-cd81ce44b795
      version: -1
      name: Enrich Emails
      script: '|||email'
      type: regular
      iscommand: true
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      email:
        complex:
          root: InvestigationUsers.Actor
          accessor: UPN
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: InvestigationUsers.Owner.UPN
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: InvestigationUsers.Sharer.UPN
                iscontext: true
          - operator: RemoveEmpty
            args:
              empty_values: {}
              remove_keys: {}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1430,
          "y": 1662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 8ffd4b5f-dd6c-427b-947c-c600f0ba2992
    type: regular
    task:
      id: 8ffd4b5f-dd6c-427b-947c-c600f0ba2992
      version: -1
      name: Get User Risky Data
      description: Retrieve the risk score of investigation users.
      script: '|||core-list-risky-users'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "24"
    scriptarguments:
      user_id:
        complex:
          root: InvestigationUsers.Actor
          accessor: UPN
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: InvestigationUsers.Owner.UPN
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: InvestigationUsers.Sharer.UPN
                iscontext: true
          - operator: RemoveEmpty
            args:
              empty_values: {}
              remove_keys: {}
          - operator: replaceMatch
            args:
              regex:
                value:
                  simple: ^(.*?)@([^.]+)\.?.*$
              replaceWith:
                value:
                  simple: $2\$1
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1016,
          "y": 1662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: cf348daa-c671-4747-928c-16add6f625c4
    type: regular
    task:
      id: cf348daa-c671-4747-928c-16add6f625c4
      version: -1
      name: Save High-Risk Users
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      key:
        simple: Evidence.Low.HighRiskUser
      value:
        complex:
          root: Core.RiskyUser
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: Core.RiskyUser.risk_level
                iscontext: true
              right:
                value:
                  simple: HIGH
              ignorecase: true
          accessor: id
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1016,
          "y": 1795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 014fc474-4916-47f7-804e-450e6c80b237
    type: condition
    task:
      id: 014fc474-4916-47f7-804e-450e6c80b237
      version: -1
      name: Check SaaS Service
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "37"
      Drive:
      - "27"
      SharePoint/OneDrive:
      - "78"
      - "89"
    separatecontext: false
    conditions:
    - label: SharePoint/OneDrive
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: SharePoint
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: OneDrive
          ignorecase: true
    - label: Drive
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: Drive
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 449,
          "y": 1262
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: b94a9003-ec55-4de8-8a0d-3d1bb6b066fb
    type: title
    task:
      id: b94a9003-ec55-4de8-8a0d-3d1bb6b066fb
      version: -1
      name: Drive
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "66"
      - "6"
      - "99"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1892,
          "y": 1394
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: 17448ca2-66e4-44b9-855c-6a76952216b6
    type: regular
    task:
      id: 17448ca2-66e4-44b9-855c-6a76952216b6
      version: -1
      name: Get Azure Risk Detections
      description: Returns a list of the **Risk Detection** objects and their properties from the **past day**.
      script: '|||azure-risky-users-risk-detections-list'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      detected_date_time_after:
        simple: ${.=new Date(Date.now()-(1000*60*60*24)).toISOString()}
      limit:
        simple: "100"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -610,
          "y": 1662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 15852200-27b5-4dd4-8bdb-078dd2020074
    type: regular
    task:
      id: 15852200-27b5-4dd4-8bdb-078dd2020074
      version: -1
      name: Save Owner-Triggered Detections
      description: Where the owner's detections **risk state** is either *atRisk* or *confirmedCompromised* and the **risk level** is *medium* or *high*.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      key:
        simple: Evidence.Low.OwnerAzureRiskDetections
      value:
        complex:
          root: AzureRiskyUsers.RiskDetection
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.userPrincipalName
                iscontext: true
              right:
                value:
                  simple: InvestigationUsers.Owner.UPN
                iscontext: true
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
                iscontext: true
              right:
                value:
                  simple: atRisk
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
                iscontext: true
              right:
                value:
                  simple: confirmedCompromised
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskLevel
                iscontext: true
              right:
                value:
                  simple: medium
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskLevel
                iscontext: true
              right:
                value:
                  simple: high
              ignorecase: true
          accessor: riskEventType
          transformers:
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: ' | '
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -610,
          "y": 1795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: d8eac52d-5fce-4d6e-85ef-74e8f528e585
    type: regular
    task:
      id: d8eac52d-5fce-4d6e-85ef-74e8f528e585
      version: -1
      name: Get Azure Risk Detections
      description: Retrieves owner's **Risk Detections** from the **past day** where the **risk state** is either *atRisk* or *confirmedCompromised* and the **risk level** is *medium* or *high*.
      script: '|||msgraph-identity-protection-risks-list'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "31"
    scriptarguments:
      odata_query:
        simple: $filter=(userPrincipalName eq '${InvestigationUsers.Owner.UPN}') and (riskState eq 'atRisk' or riskState eq 'confirmedCompromised') and (riskLevel eq 'medium' or riskLevel eq 'high') and (detectedDateTime ge ${.=new Date(Date.now()-(1000*60*60*24)).toISOString()})
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -199.5,
          "y": 1662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: 1e427260-8109-4954-811d-e8d365adcba1
    type: regular
    task:
      id: 1e427260-8109-4954-811d-e8d365adcba1
      version: -1
      name: Save Owner-Triggered Detections
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      key:
        simple: Evidence.Low.OwnerAzureRiskDetections
      value:
        complex:
          root: MSGraph.identityProtection.risks.riskDetections
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: MSGraph.identityProtection.risks.riskDetections.userPrincipalName
                iscontext: true
              right:
                value:
                  simple: InvestigationUsers.Owner.UPN
                iscontext: true
              ignorecase: true
          accessor: riskEventType
          transformers:
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: ' | '
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -199.5,
          "y": 1795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: fd17d242-4153-450b-83c1-c18c446cd85b
    type: condition
    task:
      id: fd17d242-4153-450b-83c1-c18c446cd85b
      version: -1
      name: Check Available Integrations
      description: Integration with *MSGraph Identity and Access* or with *Azure Risky Users* is required to retrieve **Azure Risk Detections**.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "37"
      Azure Risky Users:
      - "28"
      MSGraph Identity and Access:
      - "30"
    separatecontext: false
    conditions:
    - label: MSGraph Identity and Access
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: MicrosoftGraphIdentityandAccess
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
                    ignorecase: true
                accessor: brand
            iscontext: true
    - label: Azure Risky Users
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: AzureRiskyUsers
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
                    ignorecase: true
                accessor: brand
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -404,
          "y": 1524
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: ce29b707-eb06-43dd-8ef6-0602c6eab9df
    type: regular
    task:
      id: ce29b707-eb06-43dd-8ef6-0602c6eab9df
      version: -1
      name: Get Defender Alerts
      description: |
        Retrieves alerts from **the past day** for owner user, excluding those with **Info** severity status.
      script: '|||microsoft-365-defender-advanced-hunting'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    scriptarguments:
      query:
        simple: AlertEvidence | where Timestamp >= ago(1d) | where AccountUpn in ("${InvestigationUsers.Owner.UPN}") | where Severity != "Informational"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 214,
          "y": 1662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 3ff6d4fb-6c8c-4217-84ac-b7094c89416e
    type: regular
    task:
      id: 3ff6d4fb-6c8c-4217-84ac-b7094c89416e
      version: -1
      name: Save Owner-Triggered Alerts
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      key:
        simple: Evidence.Low.OwnerDefenderAlerts
      value:
        complex:
          root: Microsoft365Defender.Hunt.results
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: Microsoft365Defender.Hunt.results.AccountUpn
                iscontext: true
              right:
                value:
                  simple: InvestigationUsers.Owner.UPN
                iscontext: true
              ignorecase: true
          accessor: Title
          transformers:
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: ' | '
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 214,
          "y": 1795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: 9297db24-df71-4d89-8e1a-4690acab0737
    type: regular
    task:
      id: 9297db24-df71-4d89-8e1a-4690acab0737
      version: -1
      name: Check Actor's UA|ASN|Country
      description: Save *User Agent, ASN, and Country* if **two** of these are identified **as new**.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      key:
        simple: Evidence.Low.NewUA-ASN-Country
      value:
        complex:
          root: Core.OriginalAlert
          accessor: event
          transformers:
          - operator: If-Elif
            args:
              conditions:
                value:
                  simple: |-
                    [{
                      "condition": "#{service_caller_ip_asn_days_seen_count} + #{saas_caller_ip_geolocation_days_seen_count} + #{saas_best_identity_user_agent_days_seen_count} == 0",
                      "return": #{caller_ip_asn}+" | "+#{caller_ip_geolocation}+" | "+#{user_agent}
                    }, {
                      "condition": "#{service_caller_ip_asn_days_seen_count} + #{saas_caller_ip_geolocation_days_seen_count} == 0",
                      "return": #{caller_ip_asn}+" | "+#{caller_ip_geolocation}
                    }, {
                      "condition": "#{service_caller_ip_asn_days_seen_count} + #{saas_best_identity_user_agent_days_seen_count} == 0",
                      "return": #{caller_ip_asn}+" | "+#{user_agent}
                    }, {
                      "condition": "#{saas_caller_ip_geolocation_days_seen_count} + #{saas_best_identity_user_agent_days_seen_count} == 0",
                      "return": #{caller_ip_geolocation}+" | "+#{user_agent}
                    }, {
                      "default": ""
                    }]
              flags: {}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1075,
          "y": 1662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: 44d02a2f-00e9-474a-8619-71522cd1a74a
    type: title
    task:
      id: 44d02a2f-00e9-474a-8619-71522cd1a74a
      version: -1
      name: Verdict
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "38"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1956
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: 435907c3-f8a4-4394-b40b-5efe6bb1d53b
    type: condition
    task:
      id: 435907c3-f8a4-4394-b40b-5efe6bb1d53b
      version: -1
      name: Check Evidence
      description: |-
        - `True Positive ->`If there are at least *2 pieces of LOW* evidence, **OR** if there are at least *1 piece of HIGH* evidence.
        - `Else ->`Done with the alert open.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "52"
      True Positive:
      - "39"
    separatecontext: false
    conditions:
    - label: True Positive
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidence
                accessor: Low
                transformers:
                - operator: SetIfEmpty
                  args:
                    applyIfEmpty: {}
                    defaultValue:
                      value:
                        simple: '{}'
                - operator: jmespath
                  args:
                    expression:
                      value:
                        simple: '*'
                - operator: count
            iscontext: true
          right:
            value:
              simple: "2"
        - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidence
                accessor: High
                transformers:
                - operator: SetIfEmpty
                  args:
                    applyIfEmpty: {}
                    defaultValue:
                      value:
                        simple: '{}'
                - operator: jmespath
                  args:
                    expression:
                      value:
                        simple: '*'
                - operator: count
            iscontext: true
          right:
            value:
              simple: "1"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 449,
          "y": 2087
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: a63f7ee6-d121-4a4e-88ff-572a47799dd2
    type: title
    task:
      id: a63f7ee6-d121-4a4e-88ff-572a47799dd2
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "40"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2235
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: c1112878-8731-4aaf-8f51-3095615e82f5
    type: condition
    task:
      id: c1112878-8731-4aaf-8f51-3095615e82f5
      version: -1
      name: Check SaaS Service
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "43"
      Drive:
      - "83"
      - "80"
      SharePoint/OneDrive:
      - "85"
      - "41"
    separatecontext: false
    conditions:
    - label: SharePoint/OneDrive
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: SharePoint
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: OneDrive
          ignorecase: true
    - label: Drive
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: Drive
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2357
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: 7765ee33-d198-4f97-9ad4-f3737b98719d
    type: regular
    task:
      id: 7765ee33-d198-4f97-9ad4-f3737b98719d
      version: -1
      name: Get File Permissions
      description: Retrieves the list of all **file** permissions.
      script: '|||msgraph-list-drives-in-site'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "94"
    scriptarguments:
      extend-context:
        simple: MsGraphFiles.Permissions=value
      ignore-outputs:
        simple: "true"
      site_id:
        simple: ${RawLog.Site}/drive/items/${RawLog.ListItemUniqueId}/permissions?
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 214,
          "y": 2502
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "42":
    id: "42"
    taskid: 4713160e-5c65-4725-b37a-65bc9cb995fb
    type: regular
    task:
      id: 4713160e-5c65-4725-b37a-65bc9cb995fb
      version: -1
      name: Delete Anonymous Links
      description: Deletes all *anonymous-link* permissions from the **file**.
      script: '|||msgraph-delete-site-permissions'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      permission_id:
        complex:
          root: MsGraphFiles.Permissions
          filters:
          - - operator: isExists
              left:
                value:
                  simple: MsGraphFiles.Permissions.link
                iscontext: true
          - - operator: isEqualString
              left:
                value:
                  simple: MsGraphFiles.Permissions.link.scope
                iscontext: true
              right:
                value:
                  simple: anonymous
              ignorecase: true
          accessor: id
      site_id:
        simple: ${RawLog.Site}/drive/items/${RawLog.ListItemUniqueId}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 214,
          "y": 2749
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 0edf8ae1-fb5e-4eaf-9974-00c1f2b0f066
    type: collection
    task:
      id: 0edf8ae1-fb5e-4eaf-9974-00c1f2b0f066
      version: -1
      name: Manual Task - Analyst Action Decision
      type: collection
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "44"
      - "46"
      - "48"
    scriptarguments:
      key:
        simple: Message
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 449,
          "y": 2877
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: "---\n\n### **ðŸ’» Alert Extended Info ðŸ’»**\n\n**What?**\n- File: `${Core.OriginalAlert.event=val.sharepoint_source_filename ? val.sharepoint_source_filename : val.referenced_resource_name}`\n- SaaS Service: `${Core.OriginalAlert.event.service_type}`\n\n**Who?**\n${InvestigationUsers=Object.keys(val||{}).length > 0 ? Object.entries(val).filter(([_, user]) => user && user.UPN).map(([title, user]) => '- '+title+': `'+user.UPN+'`').join('\\n') : \"- Not Available\"}\n\n**When?**\n${InvestigationUsers=Object.keys(val||{}).length > 0 ? Object.values(val).flatMap(user => Object.entries(user)).filter(([key, value]) => key.includes(\"Datetime\")).map(([title, datetime]) => '- '+title+': `'+datetime+'`').join('\\n') : \"\"}\n- FileAccessedDateTime: `${Core.OriginalAlert.event._time}`\n\n---\n\n### **ðŸš¥ Evidence ðŸš¥**\n\n**Low:**\n${Evidence=Object.keys(val.Low||{}).length > 0 ? Object.entries(val.Low).map(([k, v]) => '- '+k+': `'+v+'`').join('\\n') : \"- None\"}\n\n**High:**\n${Evidence=Object.keys(val.High||{}).length > 0 ? Object.entries(val.High).map(([k, v]) => '- '+k+': `'+v+'`').join('\\n') : \"- None\"}\n\n---\n\nWe recommend enabling the **\"Disable Anonymous Link Creation\"** feature in your SaaS service."
        required: true
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - {}
        - simple: Confirm
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      - id: "1"
        label: ""
        labelarg:
          complex:
            root: Available.Integrations
            filters:
            - - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: Microsoft_Graph_Files
                ignorecase: true
              - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: GoogleDrive
                ignorecase: true
            transformers:
            - operator: count
            - operator: If-Elif
              args:
                conditions:
                  value:
                    simple: |-
                      [{
                        "condition": "#{.} > 0",
                        "return": "Based on the evidence, we deleted the **file's anonymous links**. You may also **delete the other file permissions** by selecting `Delete All Permissions` below."
                      }, {
                        "default": "You may need to **manually delete the file's links** directly in your SaaS service. For enhanced future efficiency, we advise setting up the `Microsoft Graph Files` or `Google Drive` integration."
                      }]
                flags: {}
        required: false
        gridcolumns: []
        defaultrows: []
        type: multiSelect
        options: []
        optionsarg:
        - complex:
            root: Available.Integrations
            filters:
            - - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: Microsoft_Graph_Files
                ignorecase: true
              - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: GoogleDrive
                ignorecase: true
            transformers:
            - operator: count
            - operator: If-Elif
              args:
                conditions:
                  value:
                    simple: |-
                      [{
                        "condition": "#{.} > 0",
                        "return": "Delete All Permissions"
                      }, {
                        "default": "Confirm"
                      }]
                flags: {}
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      - id: "2"
        label: ""
        labelarg:
          complex:
            root: Available.Integrations
            filters:
            - - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: MicrosoftGraphMail
              - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: Gmail Single User
                ignorecase: true
              - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: Gmail
                ignorecase: true
              - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: EWSO365
                ignorecase: true
            transformers:
            - operator: count
            - operator: If-Elif
              args:
                conditions:
                  value:
                    simple: |-
                      [{
                        "condition": "#{.} > 0",
                        "return": "Also, you can send an email to the file owner by selecting `Notify the Owner` below."
                      }, {
                        "default": "Also, we advise manually notifying the file owner or their manager. For enhanced efficiency, we recommend setting up the `Microsoft Graph Mail` or `Gmail` integration."
                      }]
                flags: {}
        required: false
        gridcolumns: []
        defaultrows: []
        type: multiSelect
        options: []
        optionsarg:
        - complex:
            root: Available.Integrations
            filters:
            - - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: MicrosoftGraphMail
                ignorecase: true
              - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: Gmail Single User
                ignorecase: true
              - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: Gmail
                ignorecase: true
              - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: EWSO365
                ignorecase: true
            transformers:
            - operator: count
            - operator: If-Elif
              args:
                conditions:
                  value:
                    simple: |-
                      [{
                        "condition": "#{.} > 0",
                        "return": "Notify the Owner"
                      }, {
                        "default": "Confirm"
                      }]
                flags: {}
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      - id: "3"
        label: ""
        labelarg:
          complex:
            root: Available
            filters:
            - - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: MicrosoftGraphMail
              - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: Gmail Single User
                ignorecase: true
              - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: Gmail
                ignorecase: true
              - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: EWSO365
                ignorecase: true
            - - operator: isNotEmpty
                left:
                  value:
                    simple: Available.Manager
                  iscontext: true
            accessor: Integrations
            transformers:
            - operator: count
            - operator: If-Elif
              args:
                conditions:
                  value:
                    simple: |-
                      [{
                        "condition": "#{.} > 0",
                        "return": "Additionally, you can send an email to their manager by selecting `Notify the Owner's Manager` below."
                      }, {
                        "default": "Additionally, we advise manually notifying their manager."
                      }]
                flags: {}
        required: false
        gridcolumns: []
        defaultrows: []
        type: multiSelect
        options: []
        optionsarg:
        - complex:
            root: Available
            filters:
            - - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: MicrosoftGraphMail
                ignorecase: true
              - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: Gmail Single User
                ignorecase: true
              - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: Gmail
                ignorecase: true
              - operator: isEqualString
                left:
                  value:
                    simple: Available.Integrations
                  iscontext: true
                right:
                  value:
                    simple: EWSO365
                ignorecase: true
            - - operator: isNotEmpty
                left:
                  value:
                    simple: Available.Manager
                  iscontext: true
            accessor: Integrations
            transformers:
            - operator: count
            - operator: If-Elif
              args:
                conditions:
                  value:
                    simple: |-
                      [{
                        "condition": "#{.} > 0",
                        "return": "Notify the Owner's Manager"
                      }, {
                        "default": "Confirm"
                      }]
                flags: {}
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: "ðŸ” Analyst Action Required ðŸ”"
      description: '**Review and take action if needed:**'
      sender: Your SOC team
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: 4c53a25d-8b07-43b2-b911-05316696f245
    type: condition
    task:
      id: 4c53a25d-8b07-43b2-b911-05316696f245
      version: -1
      name: Notify the Owner
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "53"
      "yes":
      - "45"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: "ðŸ” Analyst Action Required ðŸ”.Answers.0"
            iscontext: true
          right:
            value:
              simple: Notify the Owner
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: "ðŸ” Analyst Action Required ðŸ”.Answers.1"
            iscontext: true
          right:
            value:
              simple: Notify the Owner
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: "ðŸ” Analyst Action Required ðŸ”.Answers.2"
            iscontext: true
          right:
            value:
              simple: Notify the Owner
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: "ðŸ” Analyst Action Required ðŸ”.Answers.3"
            iscontext: true
          right:
            value:
              simple: Notify the Owner
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1089,
          "y": 2999
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: 7bb49927-c384-4be1-a56d-98b866cdb156
    type: regular
    task:
      id: 7bb49927-c384-4be1-a56d-98b866cdb156
      version: -1
      name: Send Mail to Owner
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "53"
    scriptarguments:
      body:
        simple: |-
          Dear User,

          This email is to inform you about a recent security incident involving a sensitive file in your possession. Our Security Operations Center (SOC) detected unauthorized external access to your file: ${Core.OriginalAlert.event=val.sharepoint_source_filename ? val.sharepoint_source_filename : val.referenced_resource_name} in ${Core.OriginalAlert.event.service_type}.

          Please be assured that we have taken immediate action to mitigate this risk. The following steps have been completed:

          - Anonymous Link Deletion: Any anonymous sharing links associated with the file have been removed.
          - Permissions Reviewed and Modified: The permissions on the file have been reviewed and additional restrictions have been applied to enhance its security.

          We recommend that you review the file's contents and ensure no sensitive information was compromised. If you notice anything unusual or have any concerns, please do not hesitate to contact the IT Help Desk immediately.

          Thank you for your cooperation in maintaining our security standards.

          Sincerely,

          The SOC Team
      subject:
        simple: 'Security Notification: Unauthorized Access to Your Sensitive File in ${Core.OriginalAlert.event.service_type}'
      to:
        simple: ${InvestigationUsers.Owner.UPN}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1089,
          "y": 3246
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: 8ccd3bef-b43a-4c59-a4bc-657dd1340cfa
    type: condition
    task:
      id: 8ccd3bef-b43a-4c59-a4bc-657dd1340cfa
      version: -1
      name: Notify the Owner's Manager
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "53"
      "yes":
      - "47"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: "ðŸ” Analyst Action Required ðŸ”.Answers.0"
            iscontext: true
          right:
            value:
              simple: Notify the Owner's Manager
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: "ðŸ” Analyst Action Required ðŸ”.Answers.1"
            iscontext: true
          right:
            value:
              simple: Notify the Owner's Manager
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: "ðŸ” Analyst Action Required ðŸ”.Answers.2"
            iscontext: true
          right:
            value:
              simple: Notify the Owner's Manager
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: "ðŸ” Analyst Action Required ðŸ”.Answers.3"
            iscontext: true
          right:
            value:
              simple: Notify the Owner's Manager
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 676,
          "y": 2999
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: ba1ac8a0-c985-46b8-a0be-ae6e8c29cfba
    type: regular
    task:
      id: ba1ac8a0-c985-46b8-a0be-ae6e8c29cfba
      version: -1
      name: Send Mail to Owner's Manager
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "53"
    scriptarguments:
      body:
        simple: |-
          Dear Manager,

          This email is to inform you about a recent security incident involving a sensitive file belonging to ${InvestigationUsers.Owner.UPN} from your team. Our Security Operations Center (SOC) detected unauthorized external access to their file: ${Core.OriginalAlert.event=val.sharepoint_source_filename ? val.sharepoint_source_filename : val.referenced_resource_name} in ${Core.OriginalAlert.event.service_type}.

          Please be assured that we have taken immediate action to mitigate this risk. The following steps have been completed:

          - Anonymous Link Deletion: Any anonymous sharing links associated with the file have been removed.
          - Permissions Reviewed and Modified: The permissions on the file have been reviewed and additional restrictions have been applied to enhance its security.

          We recommend you follow up with ${InvestigationUsers.Owner.UPN} to ensure they are aware and reinforce the importance of secure file handling and sharing best practices.

          Thank you for your understanding and cooperation in maintaining our security standards.

          Sincerely,

          The SOC Team
      subject:
        simple: 'Security Notification: Incident Regarding a Sensitive File of ${InvestigationUsers.Owner.UPN}'
      to:
        simple: ${Available.Manager}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 676,
          "y": 3246
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: 6ef79dd4-97e7-42b2-a9af-5fd8e59e0488
    type: condition
    task:
      id: 6ef79dd4-97e7-42b2-a9af-5fd8e59e0488
      version: -1
      name: Delete All Permissions
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "53"
      "yes":
      - "49"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: "ðŸ” Analyst Action Required ðŸ”.Answers.0"
            iscontext: true
          right:
            value:
              simple: Delete All Permissions
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: "ðŸ” Analyst Action Required ðŸ”.Answers.1"
            iscontext: true
          right:
            value:
              simple: Delete All Permissions
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: "ðŸ” Analyst Action Required ðŸ”.Answers.2"
            iscontext: true
          right:
            value:
              simple: Delete All Permissions
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: "ðŸ” Analyst Action Required ðŸ”.Answers.3"
            iscontext: true
          right:
            value:
              simple: Delete All Permissions
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 4,
          "y": 2999
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "49":
    id: "49"
    taskid: e569c72d-3084-482c-8f35-2ba582103548
    type: condition
    task:
      id: e569c72d-3084-482c-8f35-2ba582103548
      version: -1
      name: Check SaaS Service
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "53"
      Drive:
      - "97"
      SharePoint/OneDrive:
      - "96"
    separatecontext: false
    conditions:
    - label: SharePoint/OneDrive
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: SharePoint
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: OneDrive
          ignorecase: true
    - label: Drive
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: Drive
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 4,
          "y": 3118
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "51":
    id: "51"
    taskid: fd7460d4-d8eb-4101-9274-0efed736ffa0
    type: regular
    task:
      id: fd7460d4-d8eb-4101-9274-0efed736ffa0
      version: -1
      name: Delete All Other Permissions
      description: Deletes all *other link* permissions from the **file**, except *default* permissions.
      script: '|||msgraph-delete-site-permissions'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "53"
    scriptarguments:
      permission_id:
        complex:
          root: MsGraphFiles.Permissions
          filters:
          - - operator: isExists
              left:
                value:
                  simple: MsGraphFiles.Permissions.link
                iscontext: true
          - - operator: isNotEqualString
              left:
                value:
                  simple: MsGraphFiles.Permissions.link.scope
                iscontext: true
              right:
                value:
                  simple: anonymous
              ignorecase: true
          accessor: id
      site_id:
        simple: ${RawLog.Site}/drive/items/${RawLog.ListItemUniqueId}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -199.5,
          "y": 3376
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: 8a284373-d1a9-47fd-8520-a89486a194b5
    type: title
    task:
      id: 8a284373-d1a9-47fd-8520-a89486a194b5
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -442,
          "y": 3627
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "53":
    id: "53"
    taskid: 5e530fa5-5f85-4ebf-8c5c-48b2ec98176d
    type: regular
    task:
      id: 5e530fa5-5f85-4ebf-8c5c-48b2ec98176d
      version: -1
      name: Close Alert as True Positive
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
      description: ''
    nexttasks:
      '#none#':
      - "52"
    scriptarguments:
      closeNotes:
        simple: Handled by the playbook "test5"
      closeReason:
        simple: Resolved - True Positive
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 449,
          "y": 3504
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "54":
    id: "54"
    taskid: b24188ee-14dc-4c40-9a01-d70665c37087
    type: regular
    task:
      id: b24188ee-14dc-4c40-9a01-d70665c37087
      version: -1
      name: Check Microsoft Users Details
      description: Determines if Microsoft account has been disabled or deleted.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      key:
        simple: Evidence.Low.MicrosoftUserIndicators
      value:
        complex:
          root: MSGraphUser
          transformers:
          - operator: If-Elif
            args:
              conditions:
                value:
                  simple: |-
                    [{
                      "condition": "#{AccountEnabled} == false and #{DeletedDateTime} != null",
                      "return": "Account Disabled & Deleted"
                    }, {
                      "condition": "#{AccountEnabled} == false",
                      "return": "Account Disabled"
                    }, {
                      "condition": "#{DeletedDateTime} != null",
                      "return": "Account Deleted"
                    }, {
                      "default": ""
                    }]
              flags: {}
          - operator: join
            args:
              separator:
                value:
                  simple: ' '
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 676,
          "y": 1795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "59":
    id: "59"
    taskid: df491c09-c4b4-4813-a208-61bcae01ef25
    type: regular
    task:
      id: df491c09-c4b4-4813-a208-61bcae01ef25
      version: -1
      name: Save Days Since Share
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      key:
        simple: Evidence.High.DaysSinceShare
      value:
        complex:
          root: InvestigationUsers.Sharer
          accessor: FileLastSharedDatetime
          transformers:
          - operator: DT
            args:
              dt:
                value:
                  simple: .=Math.floor((new Date() - new Date(val))/(1000*60*60*24))
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1485,
          "y": 1795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "61":
    id: "61"
    taskid: 1efea01e-cf1b-484b-82b7-e0dc721076ff
    type: regular
    task:
      id: 1efea01e-cf1b-484b-82b7-e0dc721076ff
      version: -1
      name: Check SharePoint Link Creations
      description: Runs an XQL query to get the **sharer user's** *anonymous link creation count* in the last week.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "92"
    scriptarguments:
      query:
        simple: |-
          dataset = saas_audit_logs
          | filter service_type in (ENUM.SharePoint, ENUM.OneDrive)
            and service_sub_type = ENUM.SharePointSharingOperation
            and operation_name_orig = "AnonymousLinkCreated"
            and identity_name = "${InvestigationUsers.Sharer.UPN}"
          | fields raw_log, event_id
          | comp count_distinct(event_id) as unique_anonymous_link_creations
      query_name:
        simple: unique_anonymous_link_creations
      time_frame:
        simple: 7d
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2722,
          "y": 1541
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "65":
    id: "65"
    taskid: bd4e8b49-1344-4cb1-aec9-e9e7b9c345cf
    type: regular
    task:
      id: bd4e8b49-1344-4cb1-aec9-e9e7b9c345cf
      version: -1
      name: Check Drive Link Creations
      description: Runs an XQL query to get the **sharer user's** *anonymous link creation count* in the last week.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "92"
    scriptarguments:
      query:
        simple: |-
          dataset = saas_audit_logs
          | filter service_type = ENUM.DRIVE
            and service_sub_type = ENUM.ACL_CHANGE
            and operation_name_orig = "change_document_visibility"
            and (identity_name = "${InvestigationUsers.Sharer.UPN}" or identity_uuid = "${InvestigationUsers.Sharer.UserID=val.split('/')[1]}")
          | alter parameters_array = json_extract_array(raw_log, "$.events.parameters")
          | alter visibility_found_in_array = arrayfilter(parameters_array, json_extract_scalar("@element", "$.name") = "visibility")
          | alter visibility_param_object = arrayindex(visibility_found_in_array, 0)
          | alter visibility_value = json_extract_scalar(visibility_param_object, "$.value")
          | filter visibility_value in ("people_with_link", "public_on_the_web")
          | fields raw_log, event_id
          | comp count_distinct(event_id) as unique_anonymous_link_creations
      query_name:
        simple: unique_anonymous_link_creations
      time_frame:
        simple: 7d
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 3137,
          "y": 1541
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "66":
    id: "66"
    taskid: f50fc918-81b2-458c-ac04-2d1d152a42ad
    type: regular
    task:
      id: f50fc918-81b2-458c-ac04-2d1d152a42ad
      version: -1
      name: Check Actor Visits
      description: Runs an XQL query to check the **actor user's** *frequency of accessing various external files* in last week.
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "90"
    scriptarguments:
      query:
        simple: |-
          dataset = saas_audit_logs
          | filter service_type = ENUM.DRIVE
            and service_sub_type = ENUM.ACCESS
            and operation_name_orig = "view"
            and identity_name = "${InvestigationUsers.Actor.UPN}"
          | fields raw_log, referenced_resource
          | alter parameters_array = json_extract_array(raw_log, "$.events.parameters")
          | alter visibility_found_in_array = arrayfilter(parameters_array, json_extract_scalar("@element", "$.name") = "visibility")
          | alter visibility_param_object = arrayindex(visibility_found_in_array, 0)
          | alter visibility_value = json_extract_scalar(visibility_param_object, "$.value")
          | filter visibility_value in ("people_with_link", "public_on_the_web")
          | fields raw_log, referenced_resource
          | comp count_distinct(referenced_resource) as unique_external_views
      query_name:
        simple: unique_external_views
      time_frame:
        simple: 7d
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2315,
          "y": 1541
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "69":
    id: "69"
    taskid: fbc757f6-fea2-4951-8159-238a7f108e1e
    type: title
    task:
      id: fbc757f6-fea2-4951-8159-238a7f108e1e
      version: -1
      name: Core User Risk
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1016,
          "y": 1267
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "70":
    id: "70"
    taskid: 7da5c0b6-626e-48c4-b59b-1a81d3233912
    type: regular
    task:
      id: 7da5c0b6-626e-48c4-b59b-1a81d3233912
      version: -1
      name: Extract File Sharer User
      description: '**Sharer**: The user who **last shared** the file or **created** the anonymous link.'
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      key:
        simple: InvestigationUsers.Sharer
      value:
        complex:
          root: MsGraphFiles.Activities
          filters:
          - - operator: isExists
              left:
                value:
                  simple: MsGraphFiles.Activities.action.share
                iscontext: true
          - - operator: isEmpty
              left:
                value:
                  simple: MsGraphFiles.Activities.action.share
                iscontext: true
          transformers:
          - operator: FirstArrayElement
          - operator: jmespath
            args:
              expression:
                value:
                  simple: "{\nUPN: actor.user.userPrincipalName, \nFileLastSharedDatetime: times.recordedDateTime\n}"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 14,
          "y": 895
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "71":
    id: "71"
    taskid: 8be65647-8f61-4561-a4fa-88dfb9b12a4f
    type: regular
    task:
      id: 8be65647-8f61-4561-a4fa-88dfb9b12a4f
      version: -1
      name: Extract File Owner User
      description: '**Owner**: The user who **uploaded** or **owns** the file.'
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      key:
        simple: InvestigationUsers.Owner
      value:
        complex:
          root: MsGraphFiles.Activities
          filters:
          - - operator: isExists
              left:
                value:
                  simple: MsGraphFiles.Activities.action.create
                iscontext: true
          transformers:
          - operator: FirstArrayElement
          - operator: jmespath
            args:
              expression:
                value:
                  simple: "{\nUPN: actor.user.userPrincipalName, \nFileCreatedDatetime: times.recordedDateTime\n}"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -393,
          "y": 895
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "77":
    id: "77"
    taskid: a48cd947-739f-4ebd-925c-89e7b57ebaf5
    type: regular
    task:
      id: a48cd947-739f-4ebd-925c-89e7b57ebaf5
      version: -1
      name: Check Google Users Details
      description: Determines if GoogleÂ account has been archived, suspended or deleted.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      key:
        simple: Evidence.Low.GoogleUserIndicators
      value:
        complex:
          root: GSuite
          accessor: User
          transformers:
          - operator: If-Elif
            args:
              conditions:
                value:
                  simple: |-
                    [{
                      "condition": "#{suspended} == true and #{archived} == true and #{deletionTime} != null",
                      "return": "Account suspended, archived, and deleted"
                    }, {
                      "condition": "#{suspended} == true and #{archived} == true",
                      "return": "Account suspended, and archived"
                    }, {
                      "condition": "#{archived} == true and #{deletionTime} != null",
                      "return": "Account archived, and deleted"
                    }, {
                      "condition": "#{suspended} == true and #{deletionTime} != null",
                      "return": "Account suspended, and deleted"
                    }, {
                      "condition": "#{archived} == true",
                      "return": "Account archived"
                    }, {
                      "condition": "#{suspended} == true",
                      "return": "Account suspended"
                    }, {
                      "condition": "#{deletionTime} != null",
                      "return": "Account deleted"
                    }, {
                      "default": ""
                    }]
              flags: {}
          - operator: join
            args:
              separator:
                value:
                  simple: ' '
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1892,
          "y": 1795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "78":
    id: "78"
    taskid: 509e7eda-511b-400b-8f5a-c745bd15523d
    type: title
    task:
      id: 509e7eda-511b-400b-8f5a-c745bd15523d
      version: -1
      name: Detections & Alerts
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "32"
      - "33"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -199.5,
          "y": 1394
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "79":
    id: "79"
    taskid: ea076bf7-319e-4607-b239-5393ea425766
    type: regular
    task:
      id: ea076bf7-319e-4607-b239-5393ea425766
      version: -1
      name: Extract File Sharer UserID
      description: '**Sharer**: The user who **last shared** the file or **created** the anonymous link.'
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "87"
    scriptarguments:
      key:
        simple: InvestigationUsers.Sharer
      value:
        complex:
          root: GoogleDrive.DriveActivity
          filters:
          - - operator: isExists
              left:
                value:
                  simple: GoogleDrive.DriveActivity.primaryActionDetail.permissionChange.addedPermissions.anyone
                iscontext: true
              ignorecase: true
          transformers:
          - operator: FirstArrayElement
          - operator: jmespath
            args:
              expression:
                value:
                  simple: "{\nUserID: actors[?user.knownUser].user.knownUser.personName|[0] \nFileLastSharedDatetime: timestamp\n}"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1089,
          "y": 885
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "80":
    id: "80"
    taskid: 39f08d37-53bd-4b33-aa48-b30f77215ec7
    type: regular
    task:
      id: 39f08d37-53bd-4b33-aa48-b30f77215ec7
      version: -1
      name: Get File Permissions
      description: Retrieves the list of all **file** permissions.
      script: '|||google-drive-file-permissions-list'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "95"
    scriptarguments:
      file_id:
        simple: ${Core.OriginalAlert.event.referenced_resource}
      user_id:
        simple: ${InvestigationUsers.Owner.UPN}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 676,
          "y": 2502
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "81":
    id: "81"
    taskid: 8bb3441a-6fa1-4782-ac6a-df76ea1bee1c
    type: regular
    task:
      id: 8bb3441a-6fa1-4782-ac6a-df76ea1bee1c
      version: -1
      name: Delete Anonymous Links
      description: Deletes all *anonymous-link* permissions from the **file**.
      script: '|||google-drive-file-permission-delete'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      file_id:
        simple: ${Core.OriginalAlert.event.referenced_resource}
      ignore-outputs:
        simple: "true"
      permission_id:
        complex:
          root: GoogleDrive.FilePermission.FilePermission
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: GoogleDrive.FilePermission.FilePermission.type
                iscontext: true
              right:
                value:
                  simple: anyone
              ignorecase: true
          accessor: id
      user_id:
        simple: ${InvestigationUsers.Owner.UPN}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 676,
          "y": 2749
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "82":
    id: "82"
    taskid: 55ae96b5-3e48-4941-8a2c-303ddcea9476
    type: regular
    task:
      id: 55ae96b5-3e48-4941-8a2c-303ddcea9476
      version: -1
      name: Delete All Other Permissions
      description: Deletes all *other* permissions from the **file**, except *owner* permissions.
      script: '|||google-drive-file-permission-delete'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "53"
    scriptarguments:
      file_id:
        simple: ${Core.OriginalAlert.event.referenced_resource}
      ignore-outputs:
        simple: "true"
      permission_id:
        complex:
          root: GoogleDrive.FilePermission.FilePermission
          filters:
          - - operator: isNotEqualString
              left:
                value:
                  simple: GoogleDrive.FilePermission.FilePermission.type
                iscontext: true
              right:
                value:
                  simple: anyone
              ignorecase: true
          - - operator: isNotEqualString
              left:
                value:
                  simple: GoogleDrive.FilePermission.FilePermission.role
                iscontext: true
              right:
                value:
                  simple: owner
              ignorecase: true
          accessor: id
      user_id:
        simple: ${InvestigationUsers.Owner.UPN}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 214,
          "y": 3376
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "83":
    id: "83"
    taskid: a99e517b-0253-4c62-b2a4-0550435d310e
    type: regular
    task:
      id: a99e517b-0253-4c62-b2a4-0550435d310e
      version: -1
      name: Get Available Google Integrations
      description: Marks relevant activated Google integrations (e.g., Gmail, Drive) for the manual task.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "84"
    scriptarguments:
      key:
        simple: Available.Integrations
      value:
        complex:
          root: modules
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: modules.brand
                iscontext: true
              right:
                value:
                  simple: GoogleDrive
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: modules.brand
                iscontext: true
              right:
                value:
                  simple: Gmail Single User
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: modules.brand
                iscontext: true
              right:
                value:
                  simple: Gmail
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: modules.state
                iscontext: true
              right:
                value:
                  simple: active
              ignorecase: true
          accessor: brand
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1089,
          "y": 2502
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "84":
    id: "84"
    taskid: 72b0f5e2-48f1-4465-84b4-bdd5a259bb56
    type: regular
    task:
      id: 72b0f5e2-48f1-4465-84b4-bdd5a259bb56
      version: -1
      name: Check Manager Availability
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      key:
        simple: Available.Manager
      value:
        complex:
          root: GSuite.User.relations
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: GSuite.User.relations.type
                iscontext: true
              right:
                value:
                  simple: manager
              ignorecase: true
          accessor: value
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1089,
          "y": 2620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "85":
    id: "85"
    taskid: 5a5fbe73-6f7c-4acc-905c-8c99db3eb253
    type: regular
    task:
      id: 5a5fbe73-6f7c-4acc-905c-8c99db3eb253
      version: -1
      name: Get Available Microsoft Integrations
      description: Marks relevant activated Microsoft integrations (e.g., mail, files) for the manual task.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "86"
    scriptarguments:
      key:
        simple: Available.Integrations
      value:
        complex:
          root: modules
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: modules.brand
                iscontext: true
              right:
                value:
                  simple: Microsoft_Graph_Files
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: modules.brand
                iscontext: true
              right:
                value:
                  simple: MicrosoftGraphMail
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: modules.brand
                iscontext: true
              right:
                value:
                  simple: EWSO365
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: modules.state
                iscontext: true
              right:
                value:
                  simple: active
              ignorecase: true
          accessor: brand
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -199.5,
          "y": 2502
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "86":
    id: "86"
    taskid: 286b1230-17d6-4ba9-9d91-b0849581ff9e
    type: regular
    task:
      id: 286b1230-17d6-4ba9-9d91-b0849581ff9e
      version: -1
      name: Get Owner's Manager
      description: Retrieves the **owner's** manager properties.
      script: '|||msgraph-user-get-manager'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      extend-context:
        simple: Available.Manager=userPrincipalName
      user:
        simple: ${InvestigationUsers.Owner.UPN}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -199.5,
          "y": 2620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "87":
    id: "87"
    taskid: 1abb2125-6c89-458a-bc75-1b53aee3d9e2
    type: regular
    task:
      id: 1abb2125-6c89-458a-bc75-1b53aee3d9e2
      version: -1
      name: Get File Sharer User Details
      description: Retrieves a user's details, especially their **UPN**.
      script: '|||gsuite-user-get'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      extend-context:
        simple: InvestigationUsers.Sharer.UPN=primaryEmail
      user:
        complex:
          root: InvestigationUsers.Sharer
          accessor: UserID
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: /
              fields:
                value:
                  simple: "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1089,
          "y": 1000
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "88":
    id: "88"
    taskid: 8d270c13-6697-4300-b138-3c08db3c0597
    type: condition
    task:
      id: 8d270c13-6697-4300-b138-3c08db3c0597
      version: -1
      name: Has a File Sharer User returned?
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "92"
      Yes Drive:
      - "65"
      Yes SharePoint:
      - "61"
    separatecontext: false
    conditions:
    - label: Yes SharePoint
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: InvestigationUsers.Sharer
            iscontext: true
          right:
            value: {}
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: SharePoint
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: OneDrive
          ignorecase: true
    - label: Yes Drive
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: InvestigationUsers.Sharer
            iscontext: true
      - - operator: isEqualString
          left:
            value:
              simple: Core.OriginalAlert.event.service_type
            iscontext: true
          right:
            value:
              simple: Drive
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2923,
          "y": 1347
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "89":
    id: "89"
    taskid: f6be79d5-0cad-4845-ba08-37bbed9ed740
    type: title
    task:
      id: f6be79d5-0cad-4845-ba08-37bbed9ed740
      version: -1
      name: SharePoint/OneDrive
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "98"
      - "35"
      - "99"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1075,
          "y": 1394
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "90":
    id: "90"
    taskid: 387e48fb-379a-413a-8767-aed07ce85936
    type: condition
    task:
      id: 387e48fb-379a-413a-8767-aed07ce85936
      version: -1
      name: Is the result back and at least 5?
      description: If there were 5 or more views by the same **actor user**, it looks suspicious.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "37"
      "yes":
      - "91"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.GenericQuery
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.query_name
                      iscontext: true
                    right:
                      value:
                        simple: unique_external_views
                    ignorecase: true
                accessor: results.unique_external_views
            iscontext: true
          right:
            value:
              simple: "5"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2315,
          "y": 1662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "91":
    id: "91"
    taskid: f8645a5e-9428-4707-b538-2437b3c3c103
    type: regular
    task:
      id: f8645a5e-9428-4707-b538-2437b3c3c103
      version: -1
      name: Save Actor Visits
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      key:
        simple: Evidence.High.ActorVisits
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: unique_external_views
              ignorecase: true
          accessor: results.unique_external_views
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2315,
          "y": 1795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "92":
    id: "92"
    taskid: 080bd3af-ac00-46ee-8c10-5b555733d97d
    type: condition
    task:
      id: 080bd3af-ac00-46ee-8c10-5b555733d97d
      version: -1
      name: Is the result back and at least 10?
      description: If the **sharer user** creates 10 or more anonymous links, it looks suspicious.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "37"
      "yes":
      - "93"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: PaloAltoNetworksXQL.GenericQuery
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXQL.GenericQuery.query_name
                      iscontext: true
                    right:
                      value:
                        simple: unique_anonymous_link_creations
                    ignorecase: true
                accessor: results.unique_anonymous_link_creations
            iscontext: true
          right:
            value:
              simple: "10"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2923,
          "y": 1662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "93":
    id: "93"
    taskid: b4fa6b57-b795-4a54-8984-05bc1466e8c1
    type: regular
    task:
      id: b4fa6b57-b795-4a54-8984-05bc1466e8c1
      version: -1
      name: Save Anonymous Link Creations
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      key:
        simple: Evidence.High.AnonymousLinkCreations
      value:
        complex:
          root: PaloAltoNetworksXQL.GenericQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXQL.GenericQuery.query_name
                iscontext: true
              right:
                value:
                  simple: unique_anonymous_link_creations
              ignorecase: true
          accessor: results.unique_anonymous_link_creations
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2923,
          "y": 1795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "94":
    id: "94"
    taskid: b651813f-1bba-4593-bf1a-95e8a259be4b
    type: condition
    task:
      id: b651813f-1bba-4593-bf1a-95e8a259be4b
      version: -1
      name: Check for Anonymous Links
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "43"
      "yes":
      - "42"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: MsGraphFiles.Permissions
                filters:
                - - operator: isExists
                    left:
                      value:
                        simple: MsGraphFiles.Permissions.link
                      iscontext: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: MsGraphFiles.Permissions.link.scope
                      iscontext: true
                    right:
                      value:
                        simple: anonymous
                    ignorecase: true
                accessor: id
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 214,
          "y": 2620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "95":
    id: "95"
    taskid: bae4d391-940d-4c89-92ee-38eedc944dbc
    type: condition
    task:
      id: bae4d391-940d-4c89-92ee-38eedc944dbc
      version: -1
      name: Check for Anonymous Links
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "43"
      "yes":
      - "81"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: GoogleDrive.FilePermission.FilePermission
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: GoogleDrive.FilePermission.FilePermission.type
                      iscontext: true
                    right:
                      value:
                        simple: anyone
                    ignorecase: true
                accessor: id
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 676,
          "y": 2620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "96":
    id: "96"
    taskid: 1455de56-31c5-4b7a-a8f3-ae2f6402dfa3
    type: condition
    task:
      id: 1455de56-31c5-4b7a-a8f3-ae2f6402dfa3
      version: -1
      name: Check for Other Permissions
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "53"
      "yes":
      - "51"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: MsGraphFiles.Permissions
                filters:
                - - operator: isExists
                    left:
                      value:
                        simple: MsGraphFiles.Permissions.link
                      iscontext: true
                - - operator: isNotEqualString
                    left:
                      value:
                        simple: MsGraphFiles.Permissions.link.scope
                      iscontext: true
                    right:
                      value:
                        simple: anonymous
                    ignorecase: true
                accessor: id
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -199.5,
          "y": 3246
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "97":
    id: "97"
    taskid: 7f84599e-ed08-4348-ac4a-e9dfbcec0bf3
    type: condition
    task:
      id: 7f84599e-ed08-4348-ac4a-e9dfbcec0bf3
      version: -1
      name: Check for Other Permissions
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "53"
      "yes":
      - "82"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: GoogleDrive.FilePermission.FilePermission
                filters:
                - - operator: isNotEqualString
                    left:
                      value:
                        simple: GoogleDrive.FilePermission.FilePermission.type
                      iscontext: true
                    right:
                      value:
                        simple: anyone
                    ignorecase: true
                - - operator: isNotEqualString
                    left:
                      value:
                        simple: GoogleDrive.FilePermission.FilePermission.role
                      iscontext: true
                    right:
                      value:
                        simple: owner
                    ignorecase: true
                accessor: id
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 214,
          "y": 3246
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "98":
    id: "98"
    taskid: bff29851-21f6-4fe7-851a-b267a7d5888d
    type: condition
    task:
      id: bff29851-21f6-4fe7-851a-b267a7d5888d
      version: -1
      name: Has a Owner/Sharer User returned?
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "37"
      "Yes":
      - "9"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: InvestigationUsers.Owner
            iscontext: true
          right:
            value: {}
        - operator: isNotEmpty
          left:
            value:
              simple: InvestigationUsers.Sharer
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 676,
          "y": 1541
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "99":
    id: "99"
    taskid: dc89bd29-5d8c-42e5-b914-f9187d89bed6
    type: condition
    task:
      id: dc89bd29-5d8c-42e5-b914-f9187d89bed6
      version: -1
      name: Was the link forgotten?
      description: Verify the file's sharing link hasn't been **forgotten** by checking if its **share date** is *less than a week old*.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "37"
      "yes":
      - "59"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: InvestigationUsers.Sharer
                accessor: FileLastSharedDatetime
                transformers:
                - operator: DT
                  args:
                    dt:
                      value:
                        simple: .=Math.floor((new Date() - new Date(val))/(1000*60*60*24))
            iscontext: true
          right:
            value:
              simple: "7"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1485,
          "y": 1662
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "13_37_#default#": 0.12,
      "19_37_#default#": 0.17,
      "25_27_Drive": 0.9,
      "25_37_#default#": 0.1,
      "32_37_#default#": 0.14,
      "38_39_True Positive": 0.58,
      "38_52_#default#": 0.19,
      "3_11_#default#": 0.18,
      "40_43_#default#": 0.78,
      "44_53_#default#": 0.9,
      "46_53_#default#": 0.84,
      "48_53_#default#": 0.89,
      "49_53_#default#": 0.88,
      "88_92_#default#": 0.38,
      "90_37_#default#": 0.11,
      "92_37_#default#": 0.1,
      "96_53_#default#": 0.89,
      "97_53_#default#": 0.76,
      "98_37_#default#": 0.37,
      "99_37_#default#": 0.19
    },
    "paper": {
      "dimensions": {
        "height": 3427,
        "width": 5770,
        "x": -2252,
        "y": 260
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
