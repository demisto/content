id: silent-Suspicious Conditional Access operation for an identity
version: -1
contentitemexportablefields:
  contentitemfields: {}
name: silent-Suspicious Conditional Access operation for an identity
description: "**This playbook addresses the following alert**:\n- Suspicious Conditional Access operation for an identity\n\n**Playbook Stages**:\n\n**Triage**:\n- Gather initial information about the initiating user.\n**User Investigation**:\n- **IP Enrichment**:\n  - Analyze the reputation of the initiating user IP addresses.\n- **Azure Detection Analysis**:\n  - Investigate recent Azure security alerts for the initiating user to detect additional suspicious activity.\n  - If any detections found, investigate the related user agent. \n- **User Risk Analysis**:\n  - Assess the risk level of the initiating user based on XSIAM Core and Azure risk score.\n  - Investigate reasons behind any identified risks, including recent detections.\n- **Attacker Geolocation Analysis**:\n  - Investigate the initiating user connection geolocation.\n- **Insights Analysis**:\n  - Investigate the XSIAM insights that related to the initiating user to detect additional suspicious activity.\n\n**User Investigation**:\n- **Search for suspicious MFA activity**:\n  - Search for a policy change that indicates on disabling the need in MFA\n- **Search for suspicious guest user activity**:\n  - Search for a policy change that indicates on allowing \n**Verdict & Containment**:\n- If any suspicious evidence found during the user investigation phase and the integration \"Microsoft Graph User\" integration is enabled, the playbook will revoke the sessions of the initiating user and the destination user. If the integration is not enabled, the playbook will recommend to perform the same action but manually.\n- If the initiating user IP is malicious, or the initiating user risk is HIGH, or more than one suspicious evidence found during the Azure detection analysis and the CA policy investigation phase, and the integration \"Microsoft Graph User\" is enabled, the playbook will revoke the sessions of the initiating user and the destination user and will recommend manually to disable either one of the users or both of the users. If the integration is not enabled, the playbook will recommend to perform the same action but manually.\n\n**Requirements**:\n- `Azure Risky Users` for retrieving user risk scores.\n- `Microsoft 365 Defender` for advanced hunting queries and Azure security alerts.\n- `Microsoft Graph User` for disabling accounts and revoking sessions."
tags:
- T1548 - Abuse Elevation Control Mechanism
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: b12d4c53-13c9-48a5-8c6c-9e9af30cebbd
    type: start
    task:
      id: b12d4c53-13c9-48a5-8c6c-9e9af30cebbd
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "93"
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 1047
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 15ad8b43-778b-44d9-8c04-0c3db6637cfb
    type: regular
    task:
      id: 15ad8b43-778b-44d9-8c04-0c3db6637cfb
      version: -1
      name: Get CA policy information
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "26"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    reputationcalc: 2
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 679,
          "y": 1181
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 791f010a-8a4d-4bc1-87e6-393f9b37cf4f
    type: title
    task:
      id: 791f010a-8a4d-4bc1-87e6-393f9b37cf4f
      version: -1
      name: User Risk Analysis
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "7"
      - "8"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 650,
          "y": 1720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: b74c1def-9483-4db5-838d-328838a1ad30
    type: regular
    task:
      id: b74c1def-9483-4db5-838d-328838a1ad30
      version: -1
      name: Get user risk score
      description: Retrieve the risk score of a specific user or list of users with the highest risk score in the environment along with the reason affecting each score.
      script: '|||core-list-risky-users'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "19"
    scriptarguments:
      user_id:
        simple: ${Core.OriginalAlert.event.identity_name}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 650,
          "y": 1860
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 1454580e-4f0b-45a8-8f6d-5d3a4d907508
    type: regular
    task:
      id: 1454580e-4f0b-45a8-8f6d-5d3a4d907508
      version: -1
      name: Get user Azure risk score
      description: Returns a list of all risky users and their properties.
      script: '|||azure-risky-users-list'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "19"
    scriptarguments:
      risk_level:
        simple: high
      updated_after:
        simple: 5 hours
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1080,
          "y": 1860
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: bd8b0b32-d4e4-4bf5-866c-f40ef42ff026
    type: title
    task:
      id: bd8b0b32-d4e4-4bf5-866c-f40ef42ff026
      version: -1
      name: Azure Detection Analysis
      description: Returns a list of all risky users and their properties.
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "10"
      - "24"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 200,
          "y": 1720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: c06091ae-a391-49da-8246-9d73e51878d3
    type: regular
    task:
      id: c06091ae-a391-49da-8246-9d73e51878d3
      version: -1
      name: Get Azure alerts using MS365 integration
      description: 'Advanced hunting is a threat-hunting tool that uses specially constructed queries to examine the past 30 days of event data in Microsoft 365 Defender. Details on how to write queries: https://docs.microsoft.com/en-us/microsoft-365/security/defender/advanced-hunting-query-language?view=o365-worldwide.'
      script: '|||microsoft-365-defender-advanced-hunting'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "69"
    scriptarguments:
      query:
        simple: let _start = now(-5h); AlertEvidence | where Timestamp >= _start | where AccountUpn == "${Core.OriginalAlert.raw_abioc.event.identity_name}"
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 200,
          "y": 1860
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: b81d9289-d148-45e9-8d74-551b52757e88
    type: regular
    task:
      id: b81d9289-d148-45e9-8d74-551b52757e88
      version: -1
      name: Get Azure risky user detections using Azure integration
      description: Returns a comma-separated list of the Risk Detection objects and their properties.
      script: '|||azure-risky-users-risk-detections-list'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "69"
      - "94"
    scriptarguments:
      detected_date_time_after:
        simple: ${TimeNow}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -210,
          "y": 1978
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: ed8d7b94-cdff-4057-89cd-c0857607c022
    type: condition
    task:
      id: ed8d7b94-cdff-4057-89cd-c0857607c022
      version: -1
      name: Check if user is risky
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "29"
      "yes":
      - "39"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: AzureRiskyUsers.RiskyUser
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: AzureRiskyUsers.RiskyUser.userPrincipalName
                      iscontext: true
                    right:
                      value:
                        simple: Core.OriginalAlert.event.identity_name
                      iscontext: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: AzureRiskyUsers.RiskyUser.riskState
                      iscontext: true
                    right:
                      value:
                        simple: atRisk
                  - operator: isEqualString
                    left:
                      value:
                        simple: AzureRiskyUsers.RiskyUser
                      iscontext: true
                    right:
                      value:
                        simple: confirmedCompromised
                    ignorecase: true
                accessor: userPrincipalName
            iscontext: true
          right:
            value: {}
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: Core.RiskyUser.risk_leve
            iscontext: true
          right:
            value:
              simple: LOW
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 650,
          "y": 2030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: f4f0ad46-6346-467a-8d9b-8cb6654b756e
    type: regular
    task:
      id: f4f0ad46-6346-467a-8d9b-8cb6654b756e
      version: -1
      name: Get timestamp for Azure detections
      description: |
        Retrieves the current date and time.
      scriptName: GetTime
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "16"
    scriptarguments:
      dateFormat:
        simple: ISO
      daysAgo:
        simple: "40"
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -210,
          "y": 1860
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: 46e9466f-75bf-43de-8544-d0f376e4ac22
    type: title
    task:
      id: 46e9466f-75bf-43de-8544-d0f376e4ac22
      version: -1
      name: User Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "6"
      - "9"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 1580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 9b93b016-3f0e-4f4a-8cae-f86be05c5ae1
    type: title
    task:
      id: 9b93b016-3f0e-4f4a-8cae-f86be05c5ae1
      version: -1
      name: CA Policy Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "75"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 2540
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 89646bac-87db-4a3a-86a4-53799ac2c067
    type: regular
    task:
      id: 89646bac-87db-4a3a-86a4-53799ac2c067
      version: -1
      name: Close alert
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      closeNotes:
        simple: ' Handled by the playbook "MFA was disabled by an Azure identity"'
      closeReason:
        simple: Resolved as TRUE_POSITIVE
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 665,
          "y": 4436
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: 6608d7d2-761a-4f41-8292-5beb9d77ced9
    type: title
    task:
      id: 6608d7d2-761a-4f41-8292-5beb9d77ced9
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 428,
          "y": 4581
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: cf552f80-8be3-478e-828f-260d66d101a1
    type: regular
    task:
      id: cf552f80-8be3-478e-828f-260d66d101a1
      version: -1
      name: Clear user session
      description: "Revoke a user session by invalidating all refresh tokens issued to applications for a user. \nThis command requires an administrator role.\nPermission required: Directory.AccessAsUser.All (Delegated)."
      script: '|||msgraph-user-session-revoke'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "56"
    scriptarguments:
      user:
        simple: ${Core.OriginalAlert.event.identity_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1060,
          "y": 3807
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 9f3a2374-591c-45a1-8fc3-0e13a81236c9
    type: regular
    task:
      id: 9f3a2374-591c-45a1-8fc3-0e13a81236c9
      version: -1
      name: Set risky user
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6.x, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      key:
        simple: UserIsRisky
      value:
        simple: "True"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 870,
          "y": 2200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: 735fb741-3608-48ee-9b89-db7fae38958f
    type: regular
    task:
      id: 735fb741-3608-48ee-9b89-db7fae38958f
      version: -1
      name: Search for alerts related to the identity
      description: |-
        Searches Demisto alerts. A summarized version of this scrips is available with the summarizedversion argument.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSIAM/Cortex-XSIAM-Administrator-Guide/Permission-Management
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "92"
    scriptarguments:
      fromdate:
        simple: 5 hours ago
      query:
        simple: (name:"MFA Was disabled for an azure identity" or name:"Rare successful guest invitation in the organization" or name:"Suspicious authentication method addition to Azure account") and identity_name="${Core.OriginalAlert.event.identity_name}"
      todate:
        simple: now
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 2793
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 4133dada-d26e-4bf3-8438-ba24f999a6cd
    type: regular
    task:
      id: 4133dada-d26e-4bf3-8438-ba24f999a6cd
      version: -1
      name: Get IP Address reputation
      description: Checks the reputation of an IP address.
      script: '|||ip'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "68"
    scriptarguments:
      ip:
        simple: ${alert.hostip}
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 81,
          "y": 1323
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "56":
    id: "56"
    taskid: 06174ad4-0c33-4a7b-b278-7342bd41e59b
    type: collection
    task:
      id: 06174ad4-0c33-4a7b-b278-7342bd41e59b
      version: -1
      name: Manual Task - User Account Disablement Decision
      type: collection
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "57"
    scriptarguments:
      key:
        simple: Message
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1060,
          "y": 3943
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: "#### Source User: \n##### The user who updated the CA policy\n`${Core.OriginalAlert.event.identity_name}`\n\n#### CA Policy:\n#####  The conditional access policy who updated:\n`${Core.OriginalAlert.event.referenced_resource_name}`\n\n---\n\n### Suspicious Policy Changes:\n- **Authentication Settings Changes**: `${.=val.SuspiciousMFA || \"None\"}`\n${.=val.SuspiciousAuthentication || \"None\"}`\n- **Guest User Changes**: `${.=val.SuspiciousGuestUser || \"None\"}`\n---\n\n### Malicious IP Found:\n- **Malicious IP**: `${.=val.MaliciousIP || \"None\"}`\n\n---\n\n### Source User Agent Analysis:\n- **Suspicious user agent**: `${.=val.SuspiciousUserAgent || \"None\"}`\n\n---\n\n### Source User Risk Analysis:\n- **User is risky**: `${.=val.UserIsRisky ? \"Yes, Reason: \" + val.UserRiskyCoreReason : \"N/A\"}`\n\n---\n### Source User Azure Detections Analysis:\n- `${.=val.UserRiskyAzureDetections ? \"Yes, Risk Types: \" + val.UserRiskyAzureDetections : \"N/A\"}`\n\n---\n### Manual Actions Recommended:\n\nWe recommend to revert the Conditional Access Policy changes made above.\n\n### Action Required:\nPlease choose the action you want to perform.\n"
        required: false
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - simple: No Action
        - simple: Disable ${Core.OriginalAlert.event.identity_name}
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Analyst Action
      description: Analyst review
      sender: Your SOC team
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "57":
    id: "57"
    taskid: 2e64dc82-fac7-479c-82ba-ee834e3c1f42
    type: condition
    task:
      id: 2e64dc82-fac7-479c-82ba-ee834e3c1f42
      version: -1
      name: Evaluate Analyst Response for Next Action
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "33"
      Disable User:
      - "59"
    separatecontext: false
    conditions:
    - label: Disable User
      condition:
      - - operator: containsString
          left:
            value:
              simple: Analyst Action.Answers.0
            iscontext: true
          right:
            value:
              simple: ${Core.OriginalAlert.event.identity_name}
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1060,
          "y": 4104
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "59":
    id: "59"
    taskid: 8182a84c-af30-4cab-8c01-6a6814ea7400
    type: regular
    task:
      id: 8182a84c-af30-4cab-8c01-6a6814ea7400
      version: -1
      name: Disable source user
      description: |-
        Disables a user from all Office 365 applications, and prevents sign in. Note: This command disables user,
        but does not terminate an existing session. Supported only in a self deployed app flow with the
        Permission: Directory.AccessAsUser.All(Delegated).
      script: '|||msgraph-user-account-disable'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      user:
        complex:
          root: Core.OriginalAlert.event
          accessor: identity_name
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1060,
          "y": 4294
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "62":
    id: "62"
    taskid: a536075b-c998-40f6-8a64-c3b5bbe0c71b
    type: condition
    task:
      id: a536075b-c998-40f6-8a64-c3b5bbe0c71b
      version: -1
      name: Check if MSGraph Security integration is enabled
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'.
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "83"
      "yes":
      - "38"
    scriptarguments:
      brandname:
        simple: Microsoft Graph User
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 665,
          "y": 3651
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "66":
    id: "66"
    taskid: 2b928a00-f3ec-45ed-8815-cf2b455a9db5
    type: title
    task:
      id: 2b928a00-f3ec-45ed-8815-cf2b455a9db5
      version: -1
      name: Verdict & Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "82"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 428,
          "y": 3361
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "68":
    id: "68"
    taskid: cd329007-58a9-4623-81ef-5ee6c8d87f2e
    type: regular
    task:
      id: cd329007-58a9-4623-81ef-5ee6c8d87f2e
      version: -1
      name: Set malicious IP if exits
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6.x, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "26"
    scriptarguments:
      key:
        simple: MaliciousIP
      value:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: ip
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 81,
          "y": 1443
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "69":
    id: "69"
    taskid: b85d59e4-60b9-428a-88b7-80b16f3d7a02
    type: regular
    task:
      id: b85d59e4-60b9-428a-88b7-80b16f3d7a02
      version: -1
      name: Extract Azure user detection titles
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6.x, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "71"
    scriptarguments:
      key:
        simple: UserRiskyAzureDetections
      value:
        complex:
          root: AzureRiskyUsers.RiskDetection
          filters:
          - - operator: in
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.userPrincipalName
                iscontext: true
              right:
                value:
                  simple: Core.OriginalAlert.raw_abioc.event.identity_name
                iscontext: true
          - - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
                iscontext: true
              right:
                value:
                  simple: atRisk
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
                iscontext: true
              right:
                value:
                  simple: confirmedCompromised
              ignorecase: true
          accessor: riskEventType
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: Microsoft365Defender.Hunt.results.Title
                iscontext: true
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 200,
          "y": 2245
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "70":
    id: "70"
    taskid: 5011e863-7693-4110-8ea2-f2a1c66901ab
    type: regular
    task:
      id: 5011e863-7693-4110-8ea2-f2a1c66901ab
      version: -1
      name: Extract suspicious user agent from Azure detections
      description: Extracts regex data from the provided text. The script support groups and looping.
      scriptName: MatchRegexV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "72"
    scriptarguments:
      contextKey:
        simple: SuspiciousUserAgent
      data:
        complex:
          root: AzureRiskyUsers.RiskDetection
          filters:
          - - operator: in
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.userPrincipalName
                iscontext: true
              right:
                value:
                  simple: Core.OriginalAlert.raw_abioc.event.identity_name
                iscontext: true
          accessor: additionalInfo
      regex:
        simple: \b(Python-urllib|libwww-perl|Scrapy|curl|Wget|sqlmap|Nikto|Xrumer|Hydra|JohnTheRipper|LOIC|HOIC|MJ12bot|Baiduspider|BlackWidow|HeadlessChrome|PhantomJS|Selenium|REST)\b
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -210,
          "y": 2245
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "71":
    id: "71"
    taskid: 2615281a-b51a-4ca2-8cfe-5125abe1f6ed
    type: regular
    task:
      id: 2615281a-b51a-4ca2-8cfe-5125abe1f6ed
      version: -1
      name: Add Azure user detections to evidence
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6.x, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      key:
        simple: Evidence
      stringify:
        simple: "true"
      value:
        complex:
          root: AzureRiskyUsers.RiskDetection
          filters:
          - - operator: in
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.userPrincipalName
                iscontext: true
              right:
                value:
                  simple: Core.OriginalAlert.raw_abioc.event.identity_name
                iscontext: true
          - - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
                iscontext: true
              right:
                value:
                  simple: atRisk
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: AzureRiskyUsers.RiskDetection.riskState
                iscontext: true
              right:
                value:
                  simple: confirmedCompromised
              ignorecase: true
          accessor: riskEventType
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: Microsoft365Defender.Hunt.results.Title
                iscontext: true
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 200,
          "y": 2370
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "72":
    id: "72"
    taskid: e3755be5-3c19-4493-8ec1-2718787bcb74
    type: regular
    task:
      id: e3755be5-3c19-4493-8ec1-2718787bcb74
      version: -1
      name: Add suspicious user agent to evidence
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        - For Cortex XSOAR 6.x, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations
        - For Cortex XSOAR 8 Cloud, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
        - For Cortex XSOAR On-prem, see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      key:
        simple: Evidence
      stringify:
        simple: "true"
      value:
        simple: ${SuspiciousUserAgent}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -210,
          "y": 2370
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "75":
    id: "75"
    taskid: bb832347-70b7-4e2a-ab26-35995d94ed7b
    type: regular
    task:
      id: bb832347-70b7-4e2a-ab26-35995d94ed7b
      version: -1
      name: Extract CA policy changes
      description: Loads a json from string input, and returns a json object result.
      scriptName: JSONDiff
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "41"
    scriptarguments:
      new_json:
        simple: ${Core.OriginalAlert.raw_abioc.event.raw_log.properties.targetResources.[0].modifiedProperties.[0].newValue}
      old_json:
        simple: ${Core.OriginalAlert.raw_abioc.event.raw_log.properties.targetResources.[0].modifiedProperties.[0].oldValue}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 2673
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "79":
    id: "79"
    taskid: 15d160c5-5603-42f4-ac96-a7084d298872
    type: regular
    task:
      id: 15d160c5-5603-42f4-ac96-a7084d298872
      version: -1
      name: Set suspicious MFA activity as evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "66"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: SuspiciousMFA
      value:
        simple: The identity has disabled MFA for one or multiple users and removed the need of MFA from the CA policy ${Core.OriginalAlert.raw_abioc.event.referenced_resource_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1807,
          "y": 3222
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "82":
    id: "82"
    taskid: 4800711b-b54e-4448-af79-31e042196344
    type: condition
    task:
      id: 4800711b-b54e-4448-af79-31e042196344
      version: -1
      name: Checks if disabling the identity is recommended
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "37"
      "yes":
      - "62"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: UserIsRisky
            iscontext: true
          right:
            value:
              simple: "true"
          ignorecase: true
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                accessor: Indicator
            iscontext: true
        - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Evidence
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "2"
        - operator: isNotEmpty
          left:
            value:
              simple: SuspiciousMFA
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: SuspiciousGuestUser
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: SuspiciousAuthentication
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 428,
          "y": 3478
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "83":
    id: "83"
    taskid: dd7bf907-8eee-4dfe-b447-83649ec2aedf
    type: regular
    task:
      id: dd7bf907-8eee-4dfe-b447-83649ec2aedf
      version: -1
      name: Investigation Summary And Needed Response Actions
      description: "#### Source User: \n##### The user who updated the CA policy\n`${Core.OriginalAlert.event.identity_name}`\n\n#### CA Policy:\n#####  The conditional access policy who updated:\n`${Core.OriginalAlert.event.referenced_resource_name}`\n\n---\n\n### Suspicious Policy Changes:\n- **Authentication Settings Changes**: `${.=val.SuspiciousMFA || \"None\"}`\n${.=val.SuspiciousAuthentication || \"None\"}`\n- **Guest User Changes**: `${.=val.SuspiciousGuestUser || \"None\"}`\n---\n\n### Malicious IP Found:\n- **Malicious IP**: `${.=val.MaliciousIP || \"None\"}`\n\n---\n\n### Source User Agent Analysis:\n- **Suspicious user agent**: `${.=val.SuspiciousUserAgent || \"None\"}`\n\n---\n\n### Source User Risk Analysis:\n- **User is risky**: `${.=val.UserIsRisky ? \"Yes, Reason: \" + val.UserRiskyCoreReason : \"N/A\"}`\n\n---\n### Source User Azure Detections Analysis:\n- `${.=val.UserRiskyAzureDetections ? \"Yes, Risk Types: \" + val.UserRiskyAzureDetections : \"N/A\"}`\n\n---\n### Manual Actions Recommended:\nSince there is no MSGraph integration connected to XSIAM, we recommend to perform the following actions manually:\n\n- Revert the Conditional Access Policy changes made above.\n- Revoke the user session and disable it"
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 665,
          "y": 3943
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "84":
    id: "84"
    taskid: 8606ee77-d86f-4d0f-8664-ee3de0c710fa
    type: condition
    task:
      id: 8606ee77-d86f-4d0f-8664-ee3de0c710fa
      version: -1
      name: Search for suspicious MFA activity
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "66"
      "yes":
      - "79"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: MFA Was disabled for an azure identity
          ignorecase: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: JSONDiff.changed
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: JSONDiff.changed.field
                      iscontext: true
                    right:
                      value:
                        simple: grantControls.builtInControls
                    ignorecase: true
                - - operator: containsGeneral
                    left:
                      value:
                        simple: JSONDiff.changed.from
                      iscontext: true
                    right:
                      value:
                        simple: mfa
                    ignorecase: true
                - - operator: isEmpty
                    left:
                      value:
                        simple: JSONDiff.changed.to
                      iscontext: true
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1679,
          "y": 3058
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "85":
    id: "85"
    taskid: 6378dca5-e379-4970-a7b3-71f02251eab4
    type: condition
    task:
      id: 6378dca5-e379-4970-a7b3-71f02251eab4
      version: -1
      name: Search for suspicious guest user activity
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "66"
      "yes":
      - "86"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Rare successful guest invitation in the organization
          ignorecase: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: JSONDiff.changed
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: JSONDiff.changed.field
                      iscontext: true
                    right:
                      value:
                        simple: includeUsers
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: JSONDiff.changed.to
                      iscontext: true
                    right:
                      value:
                        simple: guest_user
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: JSONDiff.changed
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: JSONDiff.changed.field
                      iscontext: true
                    right:
                      value:
                        simple: "userAttributeFilter\t"
                - - operator: isEqualString
                    left:
                      value:
                        simple: JSONDiff.changed.to
                      iscontext: true
                    right:
                      value:
                        simple: guest_domain
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1158,
          "y": 3058
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "86":
    id: "86"
    taskid: 159aafd0-d0f8-4748-9253-1eeb2b3c70ee
    type: regular
    task:
      id: 159aafd0-d0f8-4748-9253-1eeb2b3c70ee
      version: -1
      name: Set suspicious guest user activity as evidence
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "66"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: SuspiciousGuestUser
      value:
        simple: The external guest user ${} was invited to the organization and added to the CA policy ${Core.OriginalAlert.raw_abioc.event.referenced_resource_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1298,
          "y": 3222
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "87":
    id: "87"
    taskid: 2f7e5fd7-10f2-4442-8032-3aa59c11dc58
    type: regular
    task:
      id: 2f7e5fd7-10f2-4442-8032-3aa59c11dc58
      version: -1
      name: "Set suspicious authentication activity\t"
      description: "Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "66"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: SuspiciousAuthentication
      value:
        simple: The identity has recentlly invited rare external user to the organizations and added users to the CA policy ${Core.OriginalAlert.event.referenced_resource_name}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 811,
          "y": 3202
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "88":
    id: "88"
    taskid: 3f089f50-4806-438b-863d-78cb55c4658f
    type: condition
    task:
      id: 3f089f50-4806-438b-863d-78cb55c4658f
      version: -1
      name: "Search for suspicious authentication activity\t"
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "66"
      "yes":
      - "87"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Rare successful guest invitation in the organization
          ignorecase: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: JSONDiff.changed
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: JSONDiff.changed.field
                      iscontext: true
                    right:
                      value:
                        simple: includeUsers
                    ignorecase: true
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: JSONDiff.changed
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: JSONDiff.changed.field
                      iscontext: true
                    right:
                      value:
                        simple: "userAttributeFilter\t"
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 650,
          "y": 3058
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "92":
    id: "92"
    taskid: 463ab128-880c-4505-a25e-31db2b2deb1c
    type: condition
    task:
      id: 463ab128-880c-4505-a25e-31db2b2deb1c
      version: -1
      name: Checks if related alerts were found
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "66"
      "yes":
      - "88"
      - "85"
      - "84"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: foundIncidents
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 431,
          "y": 2906
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "93":
    id: "93"
    taskid: 588aed78-6987-417b-bf83-cfa138489953
    type: condition
    task:
      id: 588aed78-6987-417b-bf83-cfa138489953
      version: -1
      name: Checks if IP address exists in the alert
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "26"
      "yes":
      - "43"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: alert.hostip
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 81,
          "y": 1181
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "94":
    id: "94"
    taskid: 46d444ea-942b-47ab-86a6-e9389c5cfe20
    type: condition
    task:
      id: 46d444ea-942b-47ab-86a6-e9389c5cfe20
      version: -1
      name: Checks if user agent from detections exists
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "69"
      "yes":
      - "70"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: AzureRiskyUsers.RiskDetection
                filters:
                - - operator: in
                    left:
                      value:
                        simple: AzureRiskyUsers.RiskDetection.userPrincipalName
                      iscontext: true
                    right:
                      value:
                        simple: Core.OriginalAlert.raw_abioc.event.identity_name
                      iscontext: true
                accessor: additionalInfo
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -209,
          "y": 2118
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "19_29_#default#": 0.16,
      "19_39_yes": 0.4,
      "57_33_#default#": 0.44,
      "84_66_#default#": 0.15,
      "85_66_#default#": 0.25,
      "88_66_#default#": 0.25,
      "92_66_#default#": 0.45
    },
    "paper": {
      "dimensions": {
        "height": 3594,
        "width": 2398,
        "x": -210,
        "y": 1047
      }
    }
  }
inputs: []
issilent: true
outputs: []
tests:
- No tests (auto formatted)
fromversion: 8.9.0
