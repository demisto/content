id: Post Intrusion Ransomware Investigation
version: -1
contentitemexportablefields:
  contentitemfields: {}
name: Post Intrusion Ransomware Investigation
description: |+
  Provides the first step in the investigation of ransomware attacks.
   The playbook requires the ransom note and an example of an encrypted file (<1MB) to try to identify the ransomware and find a recovery tool via the online database.
   You will be guided with further investigation steps throughout the playbook, some of the key features are:

  - Encrypted file owner investigation
   - Endpoint forensic investigation
   - Active Directory investigation
   - Timeline of the breach investigation
   - Indicator and account enrichment

  Playbook settings and mapping:
   For the full operation of the playbook, the following data should be mapped to the relevant incident fields.
   Username - Usernames (common incident field)
   Hostname - Hostnames (common incident field)



starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: cc248270-27db-4597-8e8f-637d3ee6913a
    type: start
    task:
      id: cc248270-27db-4597-8e8f-637d3ee6913a
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "5"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": -3000
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 90fb1d1d-6c6f-4ea8-8060-b2ba30d8cf32
    type: playbook
    task:
      id: 90fb1d1d-6c6f-4ea8-8060-b2ba30d8cf32
      version: -1
      name: Isolate Endpoint - Generic
      description: |-
        This playbook isolates a given endpoint using the following integrations:
        - Carbon Black Enterprise Response
        - Palo Alto Networks Traps
      playbookName: Isolate Endpoint - Generic
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    scriptarguments:
      Hostname:
        complex:
          root: incident
          accessor: hosts
      xdr_endpoint_id:
        complex:
          root: PaloAltoNetworksXDR
          accessor: Endpoint.endpoint_id
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 220,
          "y": -2110
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: de1544f5-3d6f-4a65-8a02-6d19aac0a2fd
    type: title
    task:
      id: de1544f5-3d6f-4a65-8a02-6d19aac0a2fd
      version: -1
      name: Identification
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "66"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": -2850
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: e0a889fb-c378-459b-8ab0-ae27282ce50d
    type: regular
    task:
      id: e0a889fb-c378-459b-8ab0-ae27282ce50d
      version: -1
      name: Upload ransomware files
      description: "Ransomware creates unique files that can help identify the ransomware strain that you are dealing with. \nSome of the special features that we can look for are: \n1. File extension of the encrypted files created by the ransomware strain.\n2. Special attributes, such as HEX characters.\n3. Ransomware notes can contain several indicators, such as BTC wallets, email addresses, or URLs/onion links to communicate with the attackers.\nMake sure to retrieve the following files as they will be required for further investigation in this playbook:\n1. Ransom note: \nText or HTML file. The file will usually be located on the desktop or in other main folders like c:\\, program files, temp, etc.\nIn case of an HTML file, it can be located by the path in the address bar.\n2.Any encrypted file <1MB. \n3. Other suspicious files that are visible and can be related to the incident.\nNote: Keep in mind that you can use XSOAR CLI to run commands in the context of the incident on enabled integrations to assist in this task. "
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "104"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": -1630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: ccdc6cea-8781-47af-8afc-f64476ab741a
    type: collection
    task:
      id: ccdc6cea-8781-47af-8afc-f64476ab741a
      version: -1
      name: Ransomware enrichment
      description: "For enrichment, it is recommended to use the community ransomware identification service: \nhttps://id-ransomware.malwarehunterteam.com/ made by malware hunter team.\nThis free service can identify more than 1,000 strains of ransomware (and expanding every day) and may provide a tool or further assistance to decrypt the files, depending on the ransomware strain you're dealing with.\nAs requested in the previous steps, you can upload the following files to try to identify the ransomware strain:\n1. Ransom note.\n2. Encrypted file <1MB. \n3. Email address or links. \nPlease refer to the service FAQ to understand the terms of service and the confidentiality of the uploaded data."
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "99"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": -260
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
        simple: Analyst
      subject:
        simple: Ransomware Enrichment
      body:
        simple: Enrich the ransomware according to the task details and update the results
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: false
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: Ransomware Strain
        required: false
        gridcolumns: []
        defaultrows: []
        type: shortText
        options: []
        optionsarg: []
        fieldassociated: ""
        placeholder: Ryuk (or leave empty if not identified)
        tooltip: 'Result of the enrichment from ID-Ransomware '
        readonly: false
      - id: "1"
        label: ""
        labelarg:
          simple: Was a recovery tool found?
        required: false
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options:
        - Not Available
        - Available
        optionsarg: []
        fieldassociated: ""
        placeholder: ""
        tooltip: Result of the enrichment from ID-Ransomware
        readonly: false
      title: Ransomware Enrichment
      description: Ransomware Enrichment
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: 058f6f3e-89f7-40ac-8dce-9fb2573b1bbb
    type: regular
    task:
      id: 058f6f3e-89f7-40ac-8dce-9fb2573b1bbb
      version: -1
      name: Send ransomware notification to relevant stakeholders
      description: Sends an email using EWS.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "12"
    scriptarguments:
      body:
        complex:
          root: inputs.EmailBody
      subject:
        simple: Ransomware attack is spreading in the organization
      to:
        complex:
          root: inputs.NotificationEmail
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 650,
          "y": 490
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 596a5595-3403-4ec0-841f-eecad201e414
    type: title
    task:
      id: 596a5595-3403-4ec0-841f-eecad201e414
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "64"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 35185970-7407-4063-84d4-8dd515616fec
    type: collection
    task:
      id: 35185970-7407-4063-84d4-8dd515616fec
      version: -1
      name: File owner investigation
      description: "The owner of encrypted files can provide an indication of a user whose activity should be investigated. This user may have encrypted the files across the domain. \nThis action can help to determine the following:\n1. User/account that have been compromised by the attacker and responsible for the encryption. \n2. The level of the privileges the attacker was able to compromise.\n3. Indication of a source endpoint to investigate further.\n\nVerify file ownership on Windows OS by right-clicking one of the encrypted files > Security tab > Advanced. In the pop-up window you will see the file owner in the top left corner.\n"
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "88"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 975
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
        simple: Analyst
      subject:
        simple: Ransomware file owner investigation
      body:
        simple: Retrieve and update encrypted file owner
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: false
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: Who is the file owner?
        required: false
        gridcolumns: []
        defaultrows: []
        type: shortText
        options: []
        optionsarg: []
        fieldassociated: ""
        placeholder: ""
        tooltip: 'The owner of the encrypted files can provide an indication of a user or the source user who encrypts the files across the domain. This action can help to determine the following: 1. User/account which have been compromised by the attacker and is responsible for the encryption 2. Level of the privileges the attacker was able to compromise. 3. Indicates a source endpoint to further investigate. To verify file ownership on windows OS, right click on one of the encrypted files, under security tab click advanced. in the popup window you will able to see the file owner on the top left corner.'
        readonly: false
      title: Ransomware file owner investigation
      description: Retrieve and update the owner of the encrypted file.
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 92579c0c-6cc4-4ba3-892f-0f6a0a8a26d2
    type: playbook
    task:
      id: 92579c0c-6cc4-4ba3-892f-0f6a0a8a26d2
      version: -1
      name: Detonate File - Generic
      playbookName: Detonate File - Generic
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "107"
    separatecontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 200,
          "y": -1290
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 289d8295-1458-4621-8365-d038a3ef55dc
    type: regular
    task:
      id: 289d8295-1458-4621-8365-d038a3ef55dc
      version: -1
      name: Test the ransomware recovery tool.
      description: |
        If a recovery tool was found, it is recommended to test it prior to using it on all of the encrypted files.
        Test the tool on a low-impact endpoint to verify that it can decrypt the data without causing permanent data loss of the encrypted files.
        If the tool decrypted the files successfully, make sure to deploy the tool only after applying all the necessary countermeasures to clean everything related to the breach from your environment.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "38"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 2540
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: 2f4f5773-27fc-42f7-8894-fcf52694a1ad
    type: title
    task:
      id: 2f4f5773-27fc-42f7-8894-fcf52694a1ad
      version: -1
      name: 'Containment '
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "103"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 2720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "42":
    id: "42"
    taskid: 245643d3-4a2f-4215-8a1b-87316ed6684e
    type: regular
    task:
      id: 245643d3-4a2f-4215-8a1b-87316ed6684e
      version: -1
      name: Read ransom note
      description: Load the content of a file into context.
      scriptName: ReadFile
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "90"
    scriptarguments:
      entryID:
        complex:
          root: File
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: File.Extension
                iscontext: true
              right:
                value:
                  simple: txt
            - operator: isEqualString
              left:
                value:
                  simple: File.Extension
                iscontext: true
              right:
                value:
                  simple: html
          accessor: EntryID
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": -1290
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: Note
      output:
        complex:
          root: FileData
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "50":
    id: "50"
    taskid: 9421b826-4b9f-4caa-8d51-ca88fc1455cb
    type: playbook
    task:
      id: 9421b826-4b9f-4caa-8d51-ca88fc1455cb
      version: -1
      name: Detonate File - Generic
      description: Detonate the file using active integrations that support file detonation.
      playbookName: Detonate File - Generic
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "86"
    separatecontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 200,
          "y": 2130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: 75d041fc-0e41-4748-8405-006285459e53
    type: condition
    task:
      id: 75d041fc-0e41-4748-8405-006285459e53
      version: -1
      name: Were binary files retrieved?
      description: ''
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "86"
      "yes":
      - "50"
      - "108"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: Endpoint Forensics Data Collection.Answers
                accessor: "0"
            iscontext: true
          right:
            value:
              simple: "Yes"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 1960
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "62":
    id: "62"
    taskid: 71136de3-bdb6-4ed5-82d9-446ce52bc89f
    type: title
    task:
      id: 71136de3-bdb6-4ed5-82d9-446ce52bc89f
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 3200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "64":
    id: "64"
    taskid: 559c1220-9b8d-4c97-8c6d-909d196ced5f
    type: regular
    task:
      id: 559c1220-9b8d-4c97-8c6d-909d196ced5f
      version: -1
      name: Fetch related incidents
      description: Fetches incidents that are related/close to the given incident.
      script: Builtin|||relatedIncidents
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "13"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "65":
    id: "65"
    taskid: 4250d6fa-6e87-49f4-8a22-b6f1aa88eb25
    type: condition
    task:
      id: 4250d6fa-6e87-49f4-8a22-b6f1aa88eb25
      version: -1
      name: Auto Remediation?
      description: ''
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "6"
      "True":
      - "1"
      - "82"
    separatecontext: false
    conditions:
    - label: "True"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.AutoRemediation
            iscontext: true
          right:
            value:
              simple: "True"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": -2310
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "66":
    id: "66"
    taskid: 43bf5d03-32ae-4701-8070-22481db94a89
    type: playbook
    task:
      id: 43bf5d03-32ae-4701-8070-22481db94a89
      version: -1
      name: Endpoint Enrichment - Generic v2.1
      description: |-
        Enrich an endpoint by hostname using one or more integrations.
        Supported integrations:
        - Active Directory Query v2
        - McAfee ePolicy Orchestrator
        - Carbon Black Enterprise Response v2
        - Cylance Protect v2
        - CrowdStrike Falcon Host
        - ExtraHop Reveal(x)
      playbookName: Endpoint Enrichment - Generic v2.1
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "67"
    scriptarguments:
      Hostname:
        complex:
          root: incident
          accessor: hostnames
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 430,
          "y": -2690
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "67":
    id: "67"
    taskid: 0d266dbf-0fdf-4150-8aa6-a37cf75ad967
    type: playbook
    task:
      id: 0d266dbf-0fdf-4150-8aa6-a37cf75ad967
      version: -1
      name: Account Enrichment - Generic v2.1
      description: |-
        Enrich accounts using one or more integrations.
        Supported integrations:
        - Active Directory
      playbookName: Account Enrichment - Generic v2.1
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "65"
    scriptarguments:
      Username:
        complex:
          root: incident
          accessor: usernames
          transformers:
          - operator: uniq
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 430,
          "y": -2510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "68":
    id: "68"
    taskid: 1851cc04-6bf2-453c-8f5e-cb27afb2fda9
    type: regular
    task:
      id: 1851cc04-6bf2-453c-8f5e-cb27afb2fda9
      version: -1
      name: 'Active Directory - disable user account '
      description: Disables an Active Directory user account.
      script: Active Directory Query v2|||ad-disable-account
      type: regular
      iscommand: true
      brand: Active Directory Query v2
    nexttasks:
      '#none#':
      - "6"
    scriptarguments:
      username:
        complex:
          root: incident
          accessor: users
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 690,
          "y": -1820
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "77":
    id: "77"
    taskid: 05064b46-20be-4963-801f-a589fdaf10c5
    type: playbook
    task:
      id: 05064b46-20be-4963-801f-a589fdaf10c5
      version: -1
      name: Active Directory Investigation
      description: |-
        Active Directory Investigation playbook provides tools and guidance to investigate changes and manipulation in Active Directory containers, ACLs, Schema, and objects.
        This playbook uses a 3rd party tool provided by Microsoft to scan the Active Directory access list, trees, and objects.
        Additional investigative information is provided for manual investigation.
      playbookName: Active Directory Investigation
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "83"
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 430,
          "y": 1490
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "82":
    id: "82"
    taskid: bbc5aa42-ce7c-4f14-8612-171c91e74ce8
    type: condition
    task:
      id: bbc5aa42-ce7c-4f14-8612-171c91e74ce8
      version: -1
      name: Is Active Directory enabled?
      description: ''
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "6"
      "yes":
      - "68"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.name
                      iscontext: true
                    right:
                      value:
                        simple: Active Directory Query v2
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
          right:
            value:
              simple: Active Directory Query v2
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 640,
          "y": -2110
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "83":
    id: "83"
    taskid: 6d947ea4-43a3-49da-8d2c-a8840f7d3d59
    type: collection
    task:
      id: 6d947ea4-43a3-49da-8d2c-a8840f7d3d59
      version: -1
      name: Advanced forensic investigation
      description: "Single endpoint forensics - if possible, use the file owner endpoint.\n\n1. Behavioral Signature:\nas a first step, it is required to gain a behavioral signature that is used to discover encrypted endpoints across the domain.\nLook for a simple behavioral signature that might be observed on all endpoints, such as:\n-  File creation in a common folder\n-  Unique process  creation\n-  File Hash\n-  Unique network connection \n\n2. Forensic Investigation :\nAnalyse Network Share, running process, network connection, auto-run data, memory dump, and other forensics methods to help you gain more knowledge about the ransomware.\n\n3. Search for additional infected endpoints:\nUse the behavioral signature collected from the forensic investigation task to search for additional infected endpoints.\n\nPerimeter Investigation\n\nFor a proper recovery process, it is essential to set the timeline for the breach. Encrypting the data is the final step in the attack. \nBefore data encryption, attackers must have gained initial access and moved laterally across the domain to gain higher privileges so they can distribute the encryption payload to the highest number of endpoints. \n1. Use Cortex XSOAR to investigate past incidents from the last three weeks with users/accounts involved in the current incident. \n2. Investigate past incidents with file owner user/account of the encrypted files. \n3. Look for a correlation between users/accounts and past Phishing/Malware alerts. \n4. Use available security/network tools to investigate and identify lateral movement in the domain.\n5. Look for suspicious activity or known vulnerabilities on external-facing applications and services like web servers/VPN/RDP.\n\n\n\n"
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "89"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 1650
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
        simple: Endpoint Forensics Data Collection
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: false
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: 'Were binary files retrieved? '
        required: false
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - simple: "Yes"
        - simple: "No"
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      - id: "1"
        label: ""
        labelarg:
          simple: What is the total number of encrypted endpoints?
        required: false
        gridcolumns: []
        defaultrows: []
        type: shortText
        options: []
        optionsarg: []
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Endpoint Forensics Data Collection
      description: ""
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "86":
    id: "86"
    taskid: 62f9e35a-6c75-4695-8c5e-b74541d7d039
    type: condition
    task:
      id: 62f9e35a-6c75-4695-8c5e-b74541d7d039
      version: -1
      name: Was a Recovery tool found?
      description: ''
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "38"
      "Yes":
      - "29"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: Ransomware Enrichment
                accessor: Answers.1
            iscontext: true
          right:
            value:
              simple: Available
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 2325
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "88":
    id: "88"
    taskid: d29e4095-262a-46e6-8b61-a923b1ece1eb
    type: regular
    task:
      id: d29e4095-262a-46e6-8b61-a923b1ece1eb
      version: -1
      name: Set file owner field
      description: Updates the file owner field for the incident.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "94"
    scriptarguments:
      encryptedfileowner:
        complex:
          root: Ransomware file owner investigation
          accessor: Answers.0
      ransomwareencryptedfileowner:
        complex:
          root: Ransomware file owner investigation.Answers
          accessor: "0"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 1150
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "89":
    id: "89"
    taskid: f243007b-60bc-480f-8c28-8731b96535e3
    type: regular
    task:
      id: f243007b-60bc-480f-8c28-8731b96535e3
      version: -1
      name: Count
      description: Sets the number of affected endpoints.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "52"
    scriptarguments:
      app:
        simple: Cuount
      approximatenumberofencryptedendpoints:
        complex:
          root: Total Number of encrypted endpoints?
          accessor: Answers.0
      ransomwareapproximatenumberofencryptedendpoints:
        complex:
          root: Endpoint Forensics Data Collection.Answers
          accessor: "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 1800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "90":
    id: "90"
    taskid: 588f9504-feec-4011-8b38-6f3581604979
    type: regular
    task:
      id: 588f9504-feec-4011-8b38-6f3581604979
      version: -1
      name: Display ransom note
      description: Converts the body of an email to an image file or a PDF file.
      tags:
      - RansomwareNote
      script: Rasterize|||rasterize-email
      type: regular
      iscommand: true
      brand: Rasterize
    nexttasks:
      '#none#':
      - "98"
    scriptarguments:
      height:
        simple: "800"
      htmlBody:
        complex:
          root: FileData
      width:
        simple: "600"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": -1090
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "91":
    id: "91"
    taskid: cd343302-1066-4e82-8bc2-1cc8b2162616
    type: regular
    task:
      id: cd343302-1066-4e82-8bc2-1cc8b2162616
      version: -1
      name: Set attacker information fields
      description: Updates the incident with attacker information.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "101"
    scriptarguments:
      attackeremail:
        complex:
          root: Account
          accessor: Email.Address
          transformers:
          - operator: uniq
      attackerurl:
        complex:
          root: Onion
          accessor: URL
          transformers:
          - operator: uniq
      ransomwareemail:
        complex:
          root: Account
          accessor: Email.Address
          transformers:
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: ','
      ransomwareonionaddress:
        complex:
          root: Onion
          accessor: Address
          transformers:
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: ','
      ransomwareonionurl:
        complex:
          root: Onion
          accessor: Address
          transformers:
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: ','
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": -740
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "94":
    id: "94"
    taskid: f617287b-9aee-421a-86ae-dd0a09536f3f
    type: playbook
    task:
      id: f617287b-9aee-421a-86ae-dd0a09536f3f
      version: -1
      name: Account Enrichment - Generic v2.1
      description: |-
        Enrich accounts using one or more integrations.
        Supported integrations:
        - Active Directory
      playbookName: Account Enrichment - Generic v2.1
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "77"
    scriptarguments:
      Username:
        complex:
          root: incident
          accessor: encryptedfileowner
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 430,
          "y": 1335
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "95":
    id: "95"
    taskid: 5b2a96ee-e342-47af-8386-d488f87fdaa6
    type: condition
    task:
      id: 5b2a96ee-e342-47af-8386-d488f87fdaa6
      version: -1
      name: Send ransomware notification?
      description: ''
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "12"
      "yes":
      - "11"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.NotificationEmail
            iscontext: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.EmailBody
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 280
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "97":
    id: "97"
    taskid: 8582bffd-fda6-46c6-8872-da0acecbbba1
    type: regular
    task:
      id: 8582bffd-fda6-46c6-8872-da0acecbbba1
      version: -1
      name: Manual containment
      description: Block the indicators extracted during the investigation manually.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "62"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 190,
          "y": 3030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "98":
    id: "98"
    taskid: 0e50b5d3-40d2-47c4-8026-aeb396604802
    type: playbook
    task:
      id: 0e50b5d3-40d2-47c4-8026-aeb396604802
      version: -1
      name: Extract Indicators From File - Generic v2
      playbookName: Extract Indicators From File - Generic v2
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "91"
    separatecontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": -910
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "99":
    id: "99"
    taskid: d95c6ee9-5b61-471e-8bae-bc4a05963d38
    type: regular
    task:
      id: d95c6ee9-5b61-471e-8bae-bc4a05963d38
      version: -1
      name: Set Ransomware information
      description: Updates the incident with ransomware information.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "100"
    scriptarguments:
      ransomwarecryptocurrencyaddress:
        complex:
          root: Cryptocurrency
          accessor: Address
          transformers:
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: ','
      ransomwarecryptocurrencyaddresstype:
        complex:
          root: Cryptocurrency
          accessor: AddressType
          transformers:
          - operator: uniq
      ransomwaredataencryptionstatus:
        simple: Encrypted
      ransomwarerecoverytool:
        complex:
          root: Ransomware Enrichment.Answers
          accessor: "1"
      ransomwarestrain:
        complex:
          root: Ransomware Enrichment.Answers
          accessor: "0"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": -80
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "100":
    id: "100"
    taskid: 8c8a6c82-ed87-4575-850b-16ea33c5acc1
    type: regular
    task:
      id: 8c8a6c82-ed87-4575-850b-16ea33c5acc1
      version: -1
      name: 'Set cryptocurrency indicators as malicious '
      description: Updates the severity of the cryptocurrency indicators to malicious.
      script: Builtin|||setIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "95"
    scriptarguments:
      indicatorsValues:
        complex:
          root: Cryptocurrency
          accessor: Address
      reputation:
        simple: Bad
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": 90
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "101":
    id: "101"
    taskid: ada85671-9ebc-48d2-81f2-b7ca23c4bdac
    type: regular
    task:
      id: ada85671-9ebc-48d2-81f2-b7ca23c4bdac
      version: -1
      name: 'Set onion addresses indicators as malicious '
      description: Updates the severity of the onion address indicators to malicious.
      script: Builtin|||setIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "102"
    scriptarguments:
      indicatorsValues:
        complex:
          root: Onion
          accessor: Address
      reputation:
        simple: Bad
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": -580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "102":
    id: "102"
    taskid: e81b5502-8775-4ada-82d3-2b1f4e0f7559
    type: regular
    task:
      id: e81b5502-8775-4ada-82d3-2b1f4e0f7559
      version: -1
      name: 'Set attacker email addresses indicators as malicious '
      description: Updates the severity of the attacker email address indicators to malicious.
      script: Builtin|||setIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      indicatorsValues:
        complex:
          root: Account.Email
          accessor: Address
      reputation:
        simple: Bad
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": -430
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "103":
    id: "103"
    taskid: 43f76b1a-a347-49ff-84b8-2839dfa3a08e
    type: condition
    task:
      id: 43f76b1a-a347-49ff-84b8-2839dfa3a08e
      version: -1
      name: Auto Remediation?
      description: ''
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "97"
      "True":
      - "109"
    separatecontext: false
    conditions:
    - label: "True"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.AutoRemediation
            iscontext: true
          right:
            value:
              simple: "True"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": 2850
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "104":
    id: "104"
    taskid: f10ea50f-2081-494b-8327-f11cb0315d7e
    type: condition
    task:
      id: f10ea50f-2081-494b-8327-f11cb0315d7e
      version: -1
      name: Handle ransomware files
      description: ''
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "95"
      Binary:
      - "15"
      Note:
      - "42"
    separatecontext: false
    conditions:
    - label: Note
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: File..Extension
            iscontext: true
          right:
            value:
              simple: txt
        - operator: isEqualString
          left:
            value:
              simple: File.Extension
            iscontext: true
          right:
            value:
              simple: html
    - label: Binary
      condition:
      - - operator: isNotEqualString
          left:
            value:
              simple: File.Extension
            iscontext: true
          right:
            value:
              simple: txt
        - operator: isEqualString
          left:
            value:
              simple: File.Extension
            iscontext: true
          right:
            value:
              simple: html
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 430,
          "y": -1460
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "107":
    id: "107"
    taskid: 38543939-4f14-400b-8826-2b6f8fb1f616
    type: playbook
    task:
      id: 38543939-4f14-400b-8826-2b6f8fb1f616
      version: -1
      name: File Enrichment - File reputation
      playbookName: File Enrichment - File reputation
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "95"
    separatecontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 200,
          "y": -1100
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "108":
    id: "108"
    taskid: 4f0b92e8-6179-4382-8aac-a3541d0f125b
    type: playbook
    task:
      id: 4f0b92e8-6179-4382-8aac-a3541d0f125b
      version: -1
      name: File Enrichment - File reputation
      playbookName: File Enrichment - File reputation
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "86"
    scriptarguments:
      MD5:
        complex:
          root: File
          accessor: MD5
      SHA1:
        complex:
          root: File
          accessor: SHA1
      SHA256:
        complex:
          root: File
          accessor: SHA256
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 660,
          "y": 2130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "109":
    id: "109"
    taskid: 565d7793-811c-421f-826b-1eaff095e501
    type: playbook
    task:
      id: 565d7793-811c-421f-826b-1eaff095e501
      version: -1
      name: Block Indicators - Generic v3
      description: |+
        This playbook blocks malicious indicators using all integrations that are enabled, using the following sub-playbooks:

        - Block URL - Generic v2
        - Block Account - Generic v2
        - Block IP - Generic v3
        - Block File - Generic v2
        - Block Email - Generic v2
        - Block Domain - Generic v2

      playbookName: Block Indicators - Generic v3
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "62"
    scriptarguments:
      AutoBlockIndicators:
        complex:
          root: inputs.AutoBlockIndicators
      AutoCommit:
        simple: "No"
      CustomBlockRule:
        simple: "True"
      CustomURLCategory:
        simple: XSOAR Remediation - Malicious URLs
      IP:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: ip
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: uniq
      MD5:
        complex:
          root: File
          accessor: MD5
      SHA256:
        complex:
          root: File
          accessor: SHA256
      URL:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: url
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: uniq
      UserVerification:
        complex:
          root: inputs.UserVerification
      Username:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: username
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 670,
          "y": 3030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "103_109_True": 0.44,
      "103_97_#default#": 0.38,
      "104_15_Binary": 0.59,
      "104_42_Note": 0.51,
      "104_95_#default#": 0.11,
      "52_108_yes": 0.4,
      "52_50_yes": 0.27,
      "52_86_#default#": 0.43,
      "65_1_True": 0.5,
      "65_6_#default#": 0.39,
      "65_82_True": 0.54,
      "82_68_yes": 0.63,
      "82_6_#default#": 0.17,
      "86_29_Yes": 0.66,
      "86_38_#default#": 0.16,
      "95_11_yes": 0.45,
      "95_12_#default#": 0.38
    },
    "paper": {
      "dimensions": {
        "height": 6265,
        "width": 880,
        "x": 190,
        "y": -3000
      }
    }
  }
inputs:
- key: AutoRemediation
  value:
    simple: "False"
  required: false
  description: "Determines whether to perform auto-isolation and remediation for the infected endpoint and indicators.\nValues:\n- True\n- False. This is the default. "
  playbookInputQuery:
- key: NotificationEmail
  value: {}
  required: false
  description: |-
    The email addresses to notify if there is a possibility of the malware spreading and infecting other endpoints.
    Can be a CSV list.
  playbookInputQuery:
- key: EmailBody
  value:
    simple: |-
      During an endpoint investigation in XSOAR, other infected endpoints were found, indicating the malware is spreading in your organization and requires your attention.
      To get more information, go to this incident in XSOAR: ${incident.id}.
  required: false
  description: The malware notification message content.
  playbookInputQuery:
- key: UserVerification
  value:
    simple: "False"
  required: false
  description: "Possible values: True/False. \nWhether to provide user verification for blocking IPs. \n\nFalse - No prompt will be displayed to the user.\nTrue - The server will ask the user for blocking verification and will display the blocking list."
  playbookInputQuery:
- key: AutoBlockIndicators
  value:
    simple: "True"
  required: false
  description: |-
    Possible values: True/False.  Default: True.
    Should the given indicators be automatically blocked, or should the user be given the option to choose?

    If set to False - no prompt will appear, and all provided indicators will be blocked automatically.
    If set to True - the user will be prompted to select which indicators to block.
  playbookInputQuery:
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.0.0
