id: Uncover Unknown Malware Using SSDeep
version: -1
name: Uncover Unknown Malware Using SSDeep
description: |-
  This playbook leverages the case management and TIM aspects of XSOAR to uncover unknown malware.
  The playbook does the following:
  - Gets the SSDeep hash of a known malicious MD5 or SHA256 hash by enriching the hash via VirusTotal, and attempting to retrieve the related file from an endpoint.
  - Creates relationships between otherwise unknown indicators - based on their correspondence to the SSDeep that was deemed similar to the original SSDeep of the malicious hash.
  - Links incidents that had any of the indicators which were found related based on the SSDeep hash similarity.
  - Enriches the original hash to get the threat actor, malware family and VirusTotal community comments.
  - Finds endpoints where occurences of any of the similar hashes exists.
  - Sets detected similar hashes and original hash as malicious, if one of them is detected as malicious.
  - Remediates the incident by blocking all the malicious hashes in the organization (with user approval).

  These steps allow the analyst to find new files, incidents and endpoints which could be related to the the original hash that was searched simply based on the similarity of SSDeep hashes.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 6c2383b2-e7e4-455f-8d3b-052960c0983f
    type: start
    task:
      id: 6c2383b2-e7e4-455f-8d3b-052960c0983f
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "84"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 450,
          "y": -1190
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 2c40df7e-9ab1-42f4-8747-23672de011c7
    type: regular
    task:
      id: 2c40df7e-9ab1-42f4-8747-23672de011c7
      version: -1
      name: Search all existing hashes
      description: Searches for all existing hashes in the system, to create an "SSDeep hash pool" which will be used for comparison against the SSDeep obtained for the originally provided hash.
      script: Builtin|||findIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "20"
    scriptarguments:
      extend-context:
        simple: AllHashes=
      fromdate:
        complex:
          root: inputs.SearchFromDate
      ignore-outputs:
        simple: "true"
      query:
        simple: type:File
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 356f005e-9de9-45f2-8085-c2630e968e07
    type: regular
    task:
      id: 356f005e-9de9-45f2-8085-c2630e968e07
      version: -1
      name: Save SSDeep hashes of all hashes
      description: Saves all of the SSDeep hashes available in XSOAR in a separate context key.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "55"
    scriptarguments:
      key:
        simple: AllSSDeeps.SSDeep
      value:
        complex:
          root: AllHashes.CustomFields.ssdeep
          filters:
          - - operator: isNotEmpty
              left:
                value:
                  simple: AllHashes.CustomFields.ssdeep
                iscontext: true
          - - operator: isNotEqualString
              left:
                value:
                  simple: AllHashes.CustomFields.ssdeep
                iscontext: true
              right:
                value:
                  simple: InputHash
                iscontext: true
              ignorecase: true
          transformers:
          - operator: uniq
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2760
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: 95f2f4ae-4bb1-4f3d-85be-3190fb808526
    type: regular
    task:
      id: 95f2f4ae-4bb1-4f3d-85be-3190fb808526
      version: -1
      name: Check SSDeep similarity
      description: This script finds similar files that can be related to each other by fuzzy hash (SSDeep).
      scriptName: SSDeepSimilarity
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "12"
    scriptarguments:
      ssdeep_hash:
        complex:
          root: InputHash
          transformers:
          - operator: uniq
      ssdeep_hashes_to_compare:
        complex:
          root: AllSSDeeps.SSDeep
          filters:
          - - operator: isNotEmpty
              left:
                value:
                  simple: AllSSDeeps.SSDeep
                iscontext: true
          - - operator: isNotEqualString
              left:
                value:
                  simple: AllSSDeeps.SSDeep
                iscontext: true
              right:
                value:
                  simple: InputHash
                iscontext: true
              ignorecase: true
          transformers:
          - operator: uniq
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 780,
          "y": 3290
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 7592c696-2940-44b1-8793-39281f2bcb4e
    type: regular
    task:
      id: 7592c696-2940-44b1-8793-39281f2bcb4e
      version: -1
      name: Create relationships between input hash and simillar hashes
      description: This automation creates a relationship between indicator objects.
      scriptName: CreateIndicatorRelationship
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "27"
    scriptarguments:
      description:
        simple: Detected while comparing SSDeep hashes.
      entity_a:
        complex:
          root: inputs.fileHash
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: incident.filehash
                iscontext: true
          - operator: toLowerCase
      entity_a_type:
        simple: File
      entity_b:
        complex:
          root: similarIndicators.CustomFields
          accessor: md5
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: similarIndicators.CustomFields.sha1
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: similarIndicators.CustomFields.sha256
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: similarIndicators.CustomFields.ssdeep
                iscontext: true
          - operator: toLowerCase
      entity_b_type:
        simple: File
      relationship:
        simple: similar-to
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1110,
          "y": 4660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 94e85ca1-1c40-4b7f-8f38-fc15619eb9d1
    type: title
    task:
      id: 94e85ca1-1c40-4b7f-8f38-fc15619eb9d1
      version: -1
      name: Create Relationships with Similar Files & Incidents
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "8"
      - "14"
      - "78"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1270,
          "y": 4325
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 6df17d6f-c3c0-459b-8248-d9b38b1b9fcb
    type: regular
    task:
      id: 6df17d6f-c3c0-459b-8248-d9b38b1b9fcb
      version: -1
      name: Find incidents with any similar hash
      description: Searches Demisto incidents
      scriptName: SearchIncidentsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      fromdate:
        complex:
          root: inputs.SearchFromDate
      query:
        complex:
          root: similarIndicators.CustomFields
          accessor: md5
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: similarIndicators.CustomFields.sha1
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: similarIndicators.CustomFields.sha256
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: similarIndicators.CustomFields.ssdeep
                iscontext: true
          - operator: toLowerCase
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: ' OR '
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1530,
          "y": 4485
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: Number of Related Incidents
      output:
        complex:
          root: foundIncidents
          accessor: id
          transformers:
          - operator: count
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: baa5d610-c7cd-440e-827a-50f973b70615
    type: condition
    task:
      id: baa5d610-c7cd-440e-827a-50f973b70615
      version: -1
      name: Are there any related incidents?
      description: Checks whether incidents with any related hash were found.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "27"
      "yes":
      - "11"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: foundIncidents
                accessor: id
                transformers:
                - operator: uniq
            iscontext: true
    view: |-
      {
        "position": {
          "x": 1530,
          "y": 4660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: b9e6336c-471f-40fb-8ac5-0e2a2856f989
    type: regular
    task:
      id: b9e6336c-471f-40fb-8ac5-0e2a2856f989
      version: -1
      name: Link to all related incidents
      description: commands.local.cmd.linkIncidents
      script: Builtin|||linkIncidents
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "27"
    scriptarguments:
      incidentId:
        complex:
          root: incident
          accessor: id
      linkedIncidentIDs:
        complex:
          root: foundIncidents.id
          filters:
          - - operator: isNotEqualString
              left:
                value:
                  simple: foundIncidents.id
                iscontext: true
              right:
                value:
                  simple: incident.id
                iscontext: true
          transformers:
          - operator: uniq
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1900,
          "y": 4830
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 29d880e5-6ea8-4cc7-84a2-13fe9be80125
    type: condition
    task:
      id: 29d880e5-6ea8-4cc7-84a2-13fe9be80125
      version: -1
      name: Were SSDeeps with high similarity found?
      description: Checks whether the SSDeep hashes have a high similarity to the SSDeep hash of the file we're hunting for.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "22"
      High Similarity:
      - "13"
    separatecontext: false
    conditions:
    - label: High Similarity
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: SSDeepSimilarity
                filters:
                - - operator: greaterThanOrEqual
                    left:
                      value:
                        simple: SSDeepSimilarity.compared_hashes.similarityValue
                      iscontext: true
                    right:
                      value:
                        simple: inputs.SimilarityThreshold
                      iscontext: true
                transformers:
                - operator: uniq
            iscontext: true
    view: |-
      {
        "position": {
          "x": 780,
          "y": 3445
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 6958aff0-19f7-4240-87ce-5f3e68d77ea5
    type: regular
    task:
      id: 6958aff0-19f7-4240-87ce-5f3e68d77ea5
      version: -1
      name: Save Hashes with high SSDeep similarity
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "36"
    scriptarguments:
      key:
        simple: HighSimilarity
      value:
        complex:
          root: SSDeepSimilarity.compared_hashes
          filters:
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: SSDeepSimilarity.compared_hashes.similarityValue
                iscontext: true
              right:
                value:
                  simple: inputs.SimilarityThreshold
                iscontext: true
          transformers:
          - operator: uniq
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1270,
          "y": 3620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: Number of similar files
      output:
        complex:
          root: HighSimilarity
          transformers:
          - operator: uniq
          - operator: count
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 59d03edc-b768-4841-83cb-bd3810f4cd42
    type: regular
    task:
      id: 59d03edc-b768-4841-83cb-bd3810f4cd42
      version: -1
      name: Find relationships of similar hashes to other indicators
      description: This automation outputs the indicator relationships to context according to the provided query, using the entities, entityTypes, and relationships arguments. All arguments will use the AND operator. For example, using the following arguments entities=8.8.8.8 entities_types=Domain will provide only relationships that the 8.8.8.8 indicator has with indicators of type domain.
      scriptName: SearchIndicatorRelationships
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
      - "64"
    scriptarguments:
      entities:
        complex:
          root: similarIndicators.CustomFields
          accessor: md5
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: similarIndicators.CustomFields.sha1
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: similarIndicators.CustomFields.sha256
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: similarIndicators.CustomFields.ssdeep
                iscontext: true
          - operator: uniq
      limit:
        simple: "40"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1020,
          "y": 4470
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 154690d3-0284-4bb2-86ab-cdc2b749af70
    type: title
    task:
      id: 154690d3-0284-4bb2-86ab-cdc2b749af70
      version: -1
      name: Search Endpoints for Indicators Related By SSDeep Similarity
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1530,
          "y": 5980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: 1e1ce804-d649-474f-8d32-16951fb8ca9f
    type: playbook
    task:
      id: 1e1ce804-d649-474f-8d32-16951fb8ca9f
      version: -1
      name: Search Endpoints By Hash - Generic V2
      description: Hunt using available tools
      playbookName: Search Endpoints By Hash - Generic V2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "60"
    scriptarguments:
      MD5Hash:
        complex:
          root: similarIndicators.CustomFields
          accessor: md5
          transformers:
          - operator: uniq
      SHA1Hash:
        complex:
          root: similarIndicators.CustomFields
          accessor: sha1
          transformers:
          - operator: uniq
      SHA256Hash:
        complex:
          root: similarIndicators.CustomFields
          accessor: sha256
          transformers:
          - operator: uniq
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 1530,
          "y": 6120
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: 8d95179d-8301-4081-8efc-a44c75f609c3
    type: condition
    task:
      id: 8d95179d-8301-4081-8efc-a44c75f609c3
      version: -1
      name: Are there hashes that are missing an SSDeep value?
      description: |-
        Checks whether there are hashes in XSOAR which are missing SSDeep hash values.
        Also checks whether the indicators can be enriched according to the EnrichExistingIndicators playbook input.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "2"
      "yes":
      - "21"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: AllHashes
                filters:
                - - operator: isEmpty
                    left:
                      value:
                        simple: AllHashes.CustomFields.ssdeep
                      iscontext: true
                accessor: value
            iscontext: true
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.EnrichExistingIndicators
            iscontext: true
          right:
            value:
              simple: "True"
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1890
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: 99416d11-0860-4f54-8a73-3cdae230da35
    type: title
    task:
      id: 99416d11-0860-4f54-8a73-3cdae230da35
      version: -1
      name: Enrich File Indicators to Expand SSDeep Pool
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "35"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 790,
          "y": 2090
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 91e15d1f-7a1c-4724-8605-71c7a0780ebe
    type: title
    task:
      id: 91e15d1f-7a1c-4724-8605-71c7a0780ebe
      version: -1
      name: |+
        Remediation

      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "75"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 780,
          "y": 6630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: b8b8ecb5-db3c-48ae-8611-55c2c3fe8a50
    type: title
    task:
      id: b8b8ecb5-db3c-48ae-8611-55c2c3fe8a50
      version: -1
      name: Malware Family and Threat Actor Enrichment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "58"
      - "62"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1510,
          "y": 5360
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 53b24148-4f90-41e2-89ef-9594cce157fc
    type: regular
    task:
      id: 53b24148-4f90-41e2-89ef-9594cce157fc
      version: -1
      name: Get VirusTotal community comments
      description: Retrieves comments for a given resource.
      tags:
      - vt-community-comments
      script: '|||vt-comments-get'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      resource:
        complex:
          root: inputs.fileHash
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: incident.filehash
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: similarIndicators.CustomFields.md5
                iscontext: true
      resource_type:
        simple: file
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1800,
          "y": 5770
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: 8d325307-9434-4d3a-8d07-30df6ed35028
    type: regular
    task:
      id: 8d325307-9434-4d3a-8d07-30df6ed35028
      version: -1
      name: Search for SSDeep of the hash in VirusTotal
      description: Checks the file reputation of the specified hash.
      script: VirusTotal (API v3)|||file
      type: regular
      iscommand: true
      brand: VirusTotal (API v3)
    nexttasks:
      '#none#':
      - "49"
    scriptarguments:
      extend-context:
        simple: sourceHash=
      file:
        complex:
          root: inputs.fileHash
      ignore-outputs:
        simple: "true"
    reputationcalc: 2
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 30,
          "y": 420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: File MD5
      output:
        simple: ${sourceHash.data.attributes.md5}
    - incidentfield: File SHA1
      output:
        simple: ${sourceHash.data.attributes.sha1}
    - incidentfield: File SHA256
      output:
        simple: ${sourceHash.data.attributes.sha256}
    - incidentfield: SSDeep
      output:
        simple: ${sourceHash.data.attributes.ssdeep}
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: d57dc5e4-b209-4e1c-8d28-3a65d44fc9b5
    type: regular
    task:
      id: d57dc5e4-b209-4e1c-8d28-3a65d44fc9b5
      version: -1
      name: Get MD5/SHA1/SHA256 for high similarity SSDeeps
      description: commands.local.cmd.find.indicators
      script: Builtin|||findIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "65"
    scriptarguments:
      extend-context:
        simple: similarIndicators=
      ignore-outputs:
        simple: "true"
      query:
        complex:
          root: HighSimilarity.hash
          filters:
          - - operator: isNotEqualString
              left:
                value:
                  simple: HighSimilarity.hash
                iscontext: true
              right:
                value:
                  simple: InputHash
                iscontext: true
              ignorecase: true
          transformers:
          - operator: toLowerCase
          - operator: uniq
          - operator: concat
            args:
              prefix:
                value:
                  simple: '"'
              suffix:
                value:
                  simple: '"'
          - operator: join
            args:
              separator:
                value:
                  simple: ' OR '
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1270,
          "y": 3970
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: 9cd805c8-f230-421a-8596-5d409a104bfa
    type: regular
    task:
      id: 9cd805c8-f230-421a-8596-5d409a104bfa
      version: -1
      name: Enrich files that are missing SSDeep hashes
      description: Enriches existing indicators in order to increase the available SSDeep hashes to compare against.
      script: Builtin|||enrichIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "53"
    scriptarguments:
      indicatorsValues:
        complex:
          root: AllHashes
          filters:
          - - operator: isEmpty
              left:
                value:
                  simple: AllHashes.CustomFields.ssdeep
                iscontext: true
          - - operator: isNotEmpty
              left:
                value:
                  simple: AllHashes.CustomFields.md5
                iscontext: true
          accessor: value
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: AllHashes.CustomFields.sha1
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: AllHashes.CustomFields.sha1
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: AdditionalHashesToEnrich.CustomFields.md5
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: AdditionalHashesToEnrich.CustomFields.sha1
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: AdditionalHashesToEnrich.CustomFields.sha256
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: AdditionalHashesToEnrich.value
                iscontext: true
          - operator: uniq
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 790,
          "y": 2220
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: abe5a203-011d-47f1-81ef-feb6739569c5
    type: regular
    task:
      id: abe5a203-011d-47f1-81ef-feb6739569c5
      version: -1
      name: Display SSDeep similarity grid
      description: Creates a Grid table from items or key-value pairs.
      scriptName: SetGridField
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "31"
    scriptarguments:
      columns:
        simple: Similarity Score,File SSDeep
      context_path:
        simple: HighSimilarity
      grid_id:
        simple: similarfilehashesbasedonssdeep
      keys:
        simple: similarityValue,hash
      sort_by:
        simple: Similarity Score
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1270,
          "y": 3790
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: a0c9f302-63d9-4aaa-8c85-533991cbed2c
    type: regular
    task:
      id: a0c9f302-63d9-4aaa-8c85-533991cbed2c
      version: -1
      name: Save SSDeep of the file hash
      description: Saves the SSDeep found in the XSOAR / VirusTotal search to a context key. This is used for normalization, so regardless of where the SSDeep hash was obtained from, it will be saved in the same key.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "39"
    scriptarguments:
      key:
        simple: InputHash
      value:
        complex:
          root: sourceHash.data.attributes
          accessor: ssdeep
          transformers:
          - operator: uniq
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: foundssdeep
                iscontext: true
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: File.SSDeep
                iscontext: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1390
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: SSDeep
      output:
        complex:
          root: InputHash
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: 28c4fba3-19f3-427b-8470-be3973a2e138
    type: title
    task:
      id: 28c4fba3-19f3-427b-8470-be3973a2e138
      version: -1
      name: Obtain SSDeep Of Original File
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "80"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -190,
          "y": -510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: db205757-da3d-46ca-8785-6a0a02e67644
    type: title
    task:
      id: db205757-da3d-46ca-8785-6a0a02e67644
      version: -1
      name: Creating an SSDeep Pool
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1575
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: a0fd8f4d-0291-43cf-8d89-e16a6f161fd9
    type: title
    task:
      id: a0fd8f4d-0291-43cf-8d89-e16a6f161fd9
      version: -1
      name: Search Similar Files Based on SSDeeps
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "4"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 780,
          "y": 3145
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: 73630e11-6d4f-4c65-8be1-b7cc65ee6b85
    type: regular
    task:
      id: 73630e11-6d4f-4c65-8be1-b7cc65ee6b85
      version: -1
      name: Display relationship of similar hashes in layout
      description: Creates a Grid table from items or key-value pairs.
      scriptName: SetGridField
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "27"
    scriptarguments:
      columns:
        simple: Relationship Type,Relationship Target
      context_path:
        simple: Relationships
      grid_id:
        simple: filerelationships
      keys:
        simple: Relationship,EntityB
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 710,
          "y": 4850
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: eb347d82-5054-463f-8dba-f8ea6470ad8e
    type: regular
    task:
      id: eb347d82-5054-463f-8dba-f8ea6470ad8e
      version: -1
      name: Display related endpoints
      description: Displays endpoint where any of the related hashes was detected.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      relatedendpoints:
        complex:
          root: Endpoint
          accessor: Hostname
          transformers:
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: ', '
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1530,
          "y": 6460
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "49":
    id: "49"
    taskid: 2017dc07-ac8a-4608-8f72-2c7bfd08c1f9
    type: condition
    task:
      id: 2017dc07-ac8a-4608-8f72-2c7bfd08c1f9
      version: -1
      name: Was an SSDeep hash found?
      description: Checks whether an SSDeep hash was found in VirusTotal for the input hash provided by the user.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "52"
      "yes":
      - "37"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: sourceHash.data.attributes.ssdeep
            iscontext: true
    view: |-
      {
        "position": {
          "x": 30,
          "y": 590
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "50":
    id: "50"
    taskid: 60586bbb-5353-4f02-8a44-1459e7896d66
    type: regular
    task:
      id: 60586bbb-5353-4f02-8a44-1459e7896d66
      version: -1
      name: Search XSOAR for SSDeep hash of the provided hash
      description: commands.local.cmd.find.indicators
      script: Builtin|||findIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "51"
    scriptarguments:
      extend-context:
        simple: foundssdeep=CustomFields.ssdeep::foundmd5=CustomFields.md5::foundsha1=CustomFields.sha1::foundsha256=CustomFields.sha256
      ignore-outputs:
        simple: "true"
      value:
        complex:
          root: inputs.fileHash
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -190,
          "y": -230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: File MD5
      output:
        simple: ${foundmd5}
    - incidentfield: File SHA256
      output:
        simple: ${foundsha256}
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "51":
    id: "51"
    taskid: 720fbf19-fa7f-478f-8598-acf6419c1760
    type: condition
    task:
      id: 720fbf19-fa7f-478f-8598-acf6419c1760
      version: -1
      name: Was an SSDeep hash found in XSOAR?
      description: Checks whether an SSDeep hash that corresponds to the input hash exists already in XSOAR. This is based on the local indicator search done to try and save VirusTotal quota.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "79"
      "yes":
      - "37"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: foundssdeep
            iscontext: true
    view: |-
      {
        "position": {
          "x": 160,
          "y": -60
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: 02091f23-ce27-4452-8e25-122ca50c6e54
    type: title
    task:
      id: 02091f23-ce27-4452-8e25-122ca50c6e54
      version: -1
      name: Obtain SSDeep Through Endpoint File Retrieval
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "56"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -190,
          "y": 880
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "53":
    id: "53"
    taskid: d12a4917-dc6a-40db-8029-e4756a205d44
    type: regular
    task:
      id: d12a4917-dc6a-40db-8029-e4756a205d44
      version: -1
      name: Remove previously searched hashes
      description: Deletes the context of the previously searched hashes because it may negatively impact performance, since the search can provide a huge number of results.
      scriptName: DeleteContext
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "54"
    scriptarguments:
      all:
        simple: "no"
      key:
        simple: AllHashes
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 790,
          "y": 2390
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "54":
    id: "54"
    taskid: 047b79a5-6fdb-4885-8f8e-1a5f748e809e
    type: regular
    task:
      id: 047b79a5-6fdb-4885-8f8e-1a5f748e809e
      version: -1
      name: Get available hashes after enrichment
      description: Searches for all file indicators that have an SSDeep hash.
      script: Builtin|||findIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      extend-context:
        simple: AllHashes=
      fromdate:
        complex:
          root: inputs.SearchFromDate
      ignore-outputs:
        simple: "true"
      query:
        simple: type:File ssdeep:*
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 790,
          "y": 2550
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "55":
    id: "55"
    taskid: 5bc2bb9a-d8f1-42f2-89ac-11c936ebb4c5
    type: condition
    task:
      id: 5bc2bb9a-d8f1-42f2-89ac-11c936ebb4c5
      version: -1
      name: Is there an SSDeep pool to compare against?
      description: Checks whether SSDeep hashes were gathered for potentially similar files, to compare against the original hash's respective SSDeep.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "72"
      "yes":
      - "40"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: AllSSDeeps.SSDeep
            iscontext: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: AllSSDeeps.SSDeep
                filters:
                - - operator: isNotEqualString
                    left:
                      value:
                        simple: AllSSDeeps.SSDeep
                      iscontext: true
                    right:
                      value:
                        simple: InputHash
                      iscontext: true
                    ignorecase: true
            iscontext: true
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2940
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "56":
    id: "56"
    taskid: 09c3255c-26bb-44e6-84d2-4299d6df0ded
    type: playbook
    task:
      id: 09c3255c-26bb-44e6-84d2-4299d6df0ded
      version: -1
      name: Retrieve File from Endpoint - Generic V3
      description: |-
        'This playbook retrieves a file sample from an endpoint using the following playbooks:'
        - Get File Sample From Path - Generic v2.
        - Get File Sample By Hash - Generic v3.
      playbookName: Retrieve File from Endpoint - Generic V3
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "57"
    scriptarguments:
      MD5:
        complex:
          root: inputs.fileHash
          filters:
          - - operator: hasLength
              left:
                value:
                  simple: inputs.fileHash
                iscontext: true
              right:
                value:
                  simple: "32"
      SHA256:
        complex:
          root: inputs.fileHash
          filters:
          - - operator: hasLength
              left:
                value:
                  simple: inputs.fileHash
                iscontext: true
              right:
                value:
                  simple: "64"
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -190,
          "y": 1010
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "57":
    id: "57"
    taskid: 3fdae635-0fa7-423b-80e8-e4f470953619
    type: condition
    task:
      id: 3fdae635-0fa7-423b-80e8-e4f470953619
      version: -1
      name: Was a file retrieved?
      description: |-
        Checks whether a file which has an MD5/SHA256 hash of the input hash we are hunting for, was retrieved.
        If a file was retrieved then we should have an SSDeep hash that we can compare against other SSDeep hashes.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "72"
      "yes":
      - "37"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: File
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: File.MD5
                      iscontext: true
                    right:
                      value:
                        simple: inputs.fileHash
                      iscontext: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: File.SHA256
                      iscontext: true
                    right:
                      value:
                        simple: inputs.fileHash
                      iscontext: true
                accessor: SSDeep
            iscontext: true
    view: |-
      {
        "position": {
          "x": 30,
          "y": 1180
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "58":
    id: "58"
    taskid: 94bb0391-91b8-4ed7-8801-42c65b3e8d94
    type: condition
    task:
      id: 94bb0391-91b8-4ed7-8801-42c65b3e8d94
      version: -1
      name: Is VirusTotal (API v3) enabled?
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "17"
      "yes":
      - "29"
    scriptarguments:
      brandname:
        simple: VirusTotal (API v3)
    results:
    - brandInstances
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1800,
          "y": 5520
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "60":
    id: "60"
    taskid: 05d11ed9-e0e7-4c80-85f5-02f944546fb7
    type: condition
    task:
      id: 05d11ed9-e0e7-4c80-85f5-02f944546fb7
      version: -1
      name: Were related endpoints found?
      description: Checks whether endpoints were found for the related hashes.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "22"
      "yes":
      - "48"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: Endpoint
                accessor: Hostname
            iscontext: true
    view: |-
      {
        "position": {
          "x": 1530,
          "y": 6270
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "61":
    id: "61"
    taskid: 96f63971-5fc9-435c-833f-dd0bc457c894
    type: condition
    task:
      id: 96f63971-5fc9-435c-833f-dd0bc457c894
      version: -1
      name: Is VirusTotal (API v3) enabled?
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "52"
      "yes":
      - "30"
    scriptarguments:
      brandname:
        simple: VirusTotal (API v3)
    results:
    - brandInstances
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -190,
          "y": 240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "62":
    id: "62"
    taskid: fb97fc6e-94c5-4354-858e-72009bd2a115
    type: playbook
    task:
      id: fb97fc6e-94c5-4354-858e-72009bd2a115
      version: -1
      name: Intezer - Analyze by hash
      description: Analyze the given file hash on Intezer Analyze and enrich the file reputation. Supports SHA256, SHA1, and MD5.
      playbookName: Intezer - Analyze by hash
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "63"
    scriptarguments:
      Interval:
        simple: "1"
      Timeout:
        simple: "10"
      hash:
        complex:
          root: inputs.fileHash
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: incident.filehash
                iscontext: true
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 1280,
          "y": 5520
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "63":
    id: "63"
    taskid: d03df350-8517-4e43-8586-c69c5f5cc5a4
    type: regular
    task:
      id: d03df350-8517-4e43-8586-c69c5f5cc5a4
      version: -1
      name: Save analysis results in layout
      description: commands.local.cmd.set.incident
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      analysisreport:
        complex:
          root: File.Metadata
          accessor: analysis_url
          transformers:
          - operator: uniq
      malwarefamily:
        complex:
          root: File.Metadata
          accessor: family_name
      verdict:
        complex:
          root: File.Metadata
          accessor: verdict
          transformers:
          - operator: uniq
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1280,
          "y": 5770
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "64":
    id: "64"
    taskid: dd3c09ce-95a4-4438-8472-1fe4b0fdb379
    type: condition
    task:
      id: dd3c09ce-95a4-4438-8472-1fe4b0fdb379
      version: -1
      name: Were relationships found?
      description: Checks whether relationships of similar hashes with any indicator were found.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "27"
      "yes":
      - "47"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: Relationships
            iscontext: true
    view: |-
      {
        "position": {
          "x": 720,
          "y": 4660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "65":
    id: "65"
    taskid: 00dba649-6919-4449-8a21-724b0e51173a
    type: condition
    task:
      id: 00dba649-6919-4449-8a21-724b0e51173a
      version: -1
      name: Were other hash types found for similar SSDeep hashes?
      description: Checks whether MD5, SHA1 or SHA256 hashes were found for the SSDeep hashes that were found similar to the original hash that is being hunted, by its SSDeep value.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "66"
      "yes":
      - "6"
      - "67"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: |
                similarIndicators.CustomFields.md5
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: similarIndicators.CustomFields.sha1
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: similarIndicators.CustomFields.sha256
            iscontext: true
    view: |-
      {
        "position": {
          "x": 1270,
          "y": 4140
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "66":
    id: "66"
    taskid: f392e0c8-728f-4aef-8801-33d4c8360b89
    type: title
    task:
      id: f392e0c8-728f-4aef-8801-33d4c8360b89
      version: -1
      name: Found Similar SSDeeps, But No Other Hash Types
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "71"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2180,
          "y": 4325
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "67":
    id: "67"
    taskid: db2e5727-e530-4fcf-8a2f-e53e3604a457
    type: title
    task:
      id: db2e5727-e530-4fcf-8a2f-e53e3604a457
      version: -1
      name: Set Reputation For Unknown Hashes
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "68"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -320,
          "y": 4325
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "68":
    id: "68"
    taskid: e438c917-3c6e-48c6-8e41-1550b8ade8f3
    type: condition
    task:
      id: e438c917-3c6e-48c6-8e41-1550b8ade8f3
      version: -1
      name: Is the input hash or any similar hash malicious?
      description: Checks whether the original hash or any hash found similar through SSDeep comparison, was detected as malicious.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "70"
      "yes":
      - "69"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: greaterThanOrEqual
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: inputs.fileHash
                      iscontext: true
                    ignorecase: true
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: similarIndicators
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: similarIndicators.score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: greaterThanOrEqual
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: incident.filehash
                      iscontext: true
                    ignorecase: true
            iscontext: true
    view: |-
      {
        "position": {
          "x": -320,
          "y": 4450
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "69":
    id: "69"
    taskid: 5a26d14e-a5cd-4f60-8634-e29237bc1c33
    type: regular
    task:
      id: 5a26d14e-a5cd-4f60-8634-e29237bc1c33
      version: -1
      name: Set input hash and similar indicators as malicious
      description: Sets the input hash the similar indicators, and the similar SSDeep hashes as malicious, because one of them was found malicious and they're all related to each other.
      script: Builtin|||setIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      indicatorsValues:
        complex:
          root: inputs.inputHash
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: incident.filehash
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: similarIndicators.value
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: HighSimilarity.hash
                iscontext: true
          - operator: uniq
      verdict:
        simple: Malicious
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 40,
          "y": 4990
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "70":
    id: "70"
    taskid: c949fe15-fa90-439c-877b-0ab05677b0d4
    type: condition
    task:
      id: c949fe15-fa90-439c-877b-0ab05677b0d4
      version: -1
      name: Do you know whether the hash is malicious or not?
      description: The input hash and the similar hashes were not detected as malicious. However, if you know that they are malicious you can set all of them as malicious. Do you know if one of them is malicious?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "77"
      Yes, malicious:
      - "69"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -320,
          "y": 4735
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "71":
    id: "71"
    taskid: 2e2b14cf-5210-4eaa-8a21-b5c5d02ce05b
    type: regular
    task:
      id: 2e2b14cf-5210-4eaa-8a21-b5c5d02ce05b
      version: -1
      name: Find incidents with similar SSDeep hashes
      description: Searches for incidents with the SSDeep hashes that were found similar to the SSDeep of the input hash.
      scriptName: SearchIncidentsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      query:
        complex:
          root: HighSimilarity
          accessor: hash
          transformers:
          - operator: toLowerCase
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: ' OR '
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2180,
          "y": 4485
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: Number of Related Incidents
      output:
        complex:
          root: foundIncidents
          accessor: id
          transformers:
          - operator: count
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "72":
    id: "72"
    taskid: 5e660968-d983-44ea-8214-699967ee9a10
    type: title
    task:
      id: 5e660968-d983-44ea-8214-699967ee9a10
      version: -1
      name: No SSDeep Found
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "77"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -1030,
          "y": 4325
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "73":
    id: "73"
    taskid: 8cfcb519-b924-4be3-8cf8-60174ca4baa2
    type: condition
    task:
      id: 8cfcb519-b924-4be3-8cf8-60174ca4baa2
      version: -1
      name: Would you like to automatically block malicious indicators?
      description: The original hash and/or one of the related hashes were found as malicious. Would you like to block the malicious indicators automatically?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "77"
      "Yes":
      - "76"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 520,
          "y": 6950
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "75":
    id: "75"
    taskid: 9fa8531a-7017-417a-8543-4b943492b5ac
    type: condition
    task:
      id: 9fa8531a-7017-417a-8543-4b943492b5ac
      version: -1
      name: Is the input hash or any similar hash malicious?
      description: Checks whether the original hash or any hash found similar through SSDeep comparison, was detected as malicious.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "77"
      "yes":
      - "73"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: greaterThanOrEqual
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: inputs.fileHash
                      iscontext: true
                    ignorecase: true
            iscontext: true
        - operator: isEqualString
          left:
            value:
              complex:
                root: similarIndicators
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: similarIndicators.score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
            iscontext: true
          right:
            value:
              simple: "3"
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: greaterThanOrEqual
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: incident.filehash
                      iscontext: true
                    ignorecase: true
            iscontext: true
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 780,
          "y": 6760
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "76":
    id: "76"
    taskid: b0e9b9f8-742a-40a2-8ba2-e4e82ffc25e1
    type: playbook
    task:
      id: b0e9b9f8-742a-40a2-8ba2-e4e82ffc25e1
      version: -1
      name: Block Indicators - Generic v3
      playbookName: Block Indicators - Generic v3
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "77"
    separatecontext: true
    view: |-
      {
        "position": {
          "x": 520,
          "y": 7210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "77":
    id: "77"
    taskid: 135a99d1-63b9-4e54-8b64-02d7a60f92a1
    type: title
    task:
      id: 135a99d1-63b9-4e54-8b64-02d7a60f92a1
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 100,
          "y": 7500
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "78":
    id: "78"
    taskid: 493f824a-9537-414a-86d8-c406ebdae80f
    type: regular
    task:
      id: 493f824a-9537-414a-86d8-c406ebdae80f
      version: -1
      name: Display discovered similar hashes in layout
      description: Displays in the layout all known hash types for the similar SSDeep hashes.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "27"
    scriptarguments:
      additionalindicators:
        complex:
          root: similarIndicators.CustomFields
          accessor: md5
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: similarIndicators.CustomFields.sha256
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: similarIndicators.CustomFields.sha1
                iscontext: true
          - operator: toLowerCase
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: |
                    ,
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 360,
          "y": 4485
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "79":
    id: "79"
    taskid: e24bbf02-7ffd-4262-89ee-59b7807501d6
    type: title
    task:
      id: e24bbf02-7ffd-4262-89ee-59b7807501d6
      version: -1
      name: Obtain SSDeep Via VirusTotal
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "61"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -190,
          "y": 130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "80":
    id: "80"
    taskid: a72a7cc3-235b-42bf-8b4f-4c3dec23b0af
    type: title
    task:
      id: a72a7cc3-235b-42bf-8b4f-4c3dec23b0af
      version: -1
      name: Obtain SSDeep From XSOAR
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "50"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -190,
          "y": -360
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "82":
    id: "82"
    taskid: 57fff06e-118a-40cb-8d1c-5b42de4183e0
    type: condition
    task:
      id: 57fff06e-118a-40cb-8d1c-5b42de4183e0
      version: -1
      name: Was the original file attached?
      description: Checks whether a file that should be used as a sample from which to begin investigation, is attached to the incident.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "38"
      "yes":
      - "83"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: File.EntryID
            iscontext: true
    view: |-
      {
        "position": {
          "x": 450,
          "y": -900
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "83":
    id: "83"
    taskid: 333219e0-2aa0-4bd1-87fa-6f38a7b0c8fb
    type: regular
    task:
      id: 333219e0-2aa0-4bd1-87fa-6f38a7b0c8fb
      version: -1
      name: Save original file hashes in layout
      description: commands.local.cmd.set.incident
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      filehash:
        complex:
          root: File
          accessor: MD5
      filemd5:
        complex:
          root: File
          accessor: MD5
      filesha256:
        complex:
          root: File
          accessor: SHA256
      ssdeep:
        complex:
          root: File
          accessor: SSDeep
    reputationcalc: 2
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 450,
          "y": -710
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "84":
    id: "84"
    taskid: 307b0b08-1b4d-4e52-84f3-174d53680d98
    type: regular
    task:
      id: 307b0b08-1b4d-4e52-84f3-174d53680d98
      version: -1
      name: Wait for incident attachments to be created
      description: Sleep for X seconds
      scriptName: Sleep
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "82"
    scriptarguments:
      seconds:
        simple: "15"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 450,
          "y": -1070
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "12_13_High Similarity": 0.32,
      "12_22_#default#": 0.1,
      "20_2_#default#": 0.21,
      "49_37_yes": 0.2,
      "49_52_#default#": 0.31,
      "51_37_yes": 0.16,
      "51_79_#default#": 0.23,
      "55_40_yes": 0.57,
      "55_72_#default#": 0.12,
      "57_37_yes": 0.15,
      "57_72_#default#": 0.11,
      "58_17_#default#": 0.21,
      "58_29_yes": 0.26,
      "60_22_#default#": 0.2,
      "60_48_yes": 0.46,
      "61_30_yes": 0.23,
      "61_52_#default#": 0.53,
      "64_27_#default#": 0.33,
      "65_66_#default#": 0.25,
      "65_67_yes": 0.21,
      "65_6_yes": 0.46,
      "68_69_yes": 0.22,
      "70_69_Yes, malicious": 0.57,
      "70_77_#default#": 0.14,
      "73_76_Yes": 0.45,
      "73_77_#default#": 0.18,
      "75_77_#default#": 0.16,
      "9_11_yes": 0.37,
      "9_27_#default#": 0.18
    },
    "paper": {
      "dimensions": {
        "height": 8755,
        "width": 3590,
        "x": -1030,
        "y": -1190
      }
    }
  }
inputs:
- key: fileHash
  value:
    complex:
      root: incident
      accessor: filehash
  required: true
  description: The file hash to hunt for. Supported hash types are MD5 and SHA256.
  playbookInputQuery:
- key: SimilarityThreshold
  value:
    simple: "50"
  required: true
  description: |-
    SSDeep hashes with a similarity value equal to or greater than the value specified, will be considered as similar hashes.
    The SSDeep hashes are given a similarity value between 0 and 100. The similarity is calculated based on the linux "ssdeep" command which is based on the SpamSum program. It basically calculates how many character edits are needed to reach from one hash to the other hash. More information can be found in:
    https://www.samba.org/ftp/unpacked/junkcode/spamsum/README
  playbookInputQuery:
- key: SearchFromDate
  value:
    simple: 2020-01-01T00:00:00
  required: false
  description: |-
    When looking for existing hashes in the system, this is the date that it will look for hashes from.
    The value should be in YYYY-MM-DDTHH:MM:SS.
    For example: 2022-02-15T08:31:00
  playbookInputQuery:
- key: EnrichExistingIndicators
  value:
    simple: "False"
  required: false
  description: 'Whether indicators found in XSOAR will be enriched using the enrichIndicators command. Note: this may use up quota in your threat intelligence products. This is used to increase the SSDeep pool size to improve the coverage when comparing the input hash against other SSDeeps in the system.'
  playbookInputQuery:
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.5.0
