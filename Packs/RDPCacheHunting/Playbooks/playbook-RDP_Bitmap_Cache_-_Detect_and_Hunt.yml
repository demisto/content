id: RDP Bitmap Cache - Detect and Hunt
version: -1
contentitemexportablefields:
  contentitemfields: {}
name: RDP Bitmap Cache - Detect and Hunt
description: This playbook automates the collection and forensic analysis of RDP sessions cache data by collecting the cache files and convert it to an image, extract readable text from the image and build IOC's from text and finally enrich any extracted indicators for further hunting
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 7e0b59dc-2b02-4284-8ac8-7bef3ca61007
    type: start
    task:
      id: 7e0b59dc-2b02-4284-8ac8-7bef3ca61007
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "33"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -1570
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: dea6b43c-829a-4120-8aab-b0348cdb9e9d
    type: regular
    task:
      id: dea6b43c-829a-4120-8aab-b0348cdb9e9d
      version: -1
      name: OCR
      description: Extracts text from an image.
      script: '|||image-ocr-extract-text'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      entryid:
        complex:
          root: File
          filters:
          - - operator: startWith
              left:
                value:
                  simple: File.Name
                iscontext: true
              right:
                value:
                  simple: grayscale
              ignorecase: true
            - operator: startWith
              left:
                value:
                  simple: File.Name
                iscontext: true
              right:
                value:
                  simple: sharpen
            - operator: startWith
              left:
                value:
                  simple: File.Name
                iscontext: true
              right:
                value:
                  simple: original
          accessor: EntryID
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 390
        }
      }
    note: false
    evidencedata:
      description:
        simple: RDP Bitmap Cache OCR Output
      customfields: {}
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: 7de8b5f2-8c08-4616-87a7-02c1680147c0
    type: regular
    task:
      id: 7de8b5f2-8c08-4616-87a7-02c1680147c0
      version: -1
      name: Parse RDP cache files
      description: Parse RDP bitmap cache data into a single collage image file.
      scriptName: BMCTool
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "38"
    scriptarguments:
      EntryID:
        complex:
          root: File
          filters:
          - - operator: containsString
              left:
                value:
                  simple: File.Extension
                iscontext: true
              right:
                value:
                  simple: bin
              ignorecase: true
          accessor: EntryID
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -590
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: a545fdfe-b3a9-4919-89d3-eaa9c44d13ca
    type: regular
    task:
      id: a545fdfe-b3a9-4919-89d3-eaa9c44d13ca
      version: -1
      name: Suspicious tools hunting
      description: This automation calculates the similarity ratio between a Text and a list of strings and outputs a decimal value between 0.0 and 1.0 (1.0 if the sequences are identical, and 0.0 if they don't have anything in common).
      scriptName: StringSimilarity
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      string_A:
        complex:
          root: File
          accessor: Text
          transformers:
          - operator: uniq
          - operator: split
            args:
              delimiter:
                value:
                  simple: ' '
      string_B:
        complex:
          root: lists
          accessor: MalTools
          transformers:
          - operator: split
            args:
              delimiter:
                value:
                  simple: ','
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -210,
          "y": 1390
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: d624b2a0-9b5d-4e82-8d78-14d59118f6eb
    type: regular
    task:
      id: d624b2a0-9b5d-4e82-8d78-14d59118f6eb
      version: -1
      name: Suspicious strings hunting
      description: This script runs stringsifter ML tool for malware anlisys and ranking of words.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1090,
          "y": 1390
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: 6e9db268-53c4-403e-8222-f510be234080
    type: title
    task:
      id: 6e9db268-53c4-403e-8222-f510be234080
      version: -1
      name: Process RDP Cache Files
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "4"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: f18e2c3a-39d7-454b-89cf-ea9abdc51078
    type: title
    task:
      id: f18e2c3a-39d7-454b-89cf-ea9abdc51078
      version: -1
      name: Extract Indicators
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "12"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 3880fbf7-f43a-465e-85f6-6713bc9b7a3b
    type: regular
    task:
      id: 3880fbf7-f43a-465e-85f6-6713bc9b7a3b
      version: -1
      name: Extract indicators from the OCR output
      description: commands.local.cmd.extract.indicators
      script: Builtin|||extractIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      text:
        complex:
          root: File
          accessor: Text
    reputationcalc: 2
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: Total Indicator Count
      output:
        complex:
          root: ExtractedIndicators
          accessor: Domain
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: ExtractedIndicators.URL
          - operator: append
            args:
              item:
                value:
                  simple: ExtractedIndicators.Windows_Path
          - operator: append
            args:
              item:
                value:
                  simple: ExtractedIndicators.Windows_Path_2
          - operator: append
            args:
              item:
                value:
                  simple: ExtractedIndicators.IP
          - operator: uniq
          - operator: count
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: f189b6c1-6a45-4c75-861a-b5f9383dde87
    type: title
    task:
      id: f189b6c1-6a45-4c75-861a-b5f9383dde87
      version: -1
      name: Threat Hunting
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "7"
      - "27"
      - "26"
      - "6"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 2ab3172e-ab10-4d23-8fe1-dab1893dfec0
    type: title
    task:
      id: 2ab3172e-ab10-4d23-8fe1-dab1893dfec0
      version: -1
      name: Set Layout
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "16"
      - "24"
      - "28"
      - "29"
      - "30"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: 4e5fa482-50e7-4326-8d3b-2606266d95d4
    type: regular
    task:
      id: 4e5fa482-50e7-4326-8d3b-2606266d95d4
      version: -1
      name: Set String Sifter results in the layout
      description: Creates a Grid table from items or key-value pairs.
      scriptName: SetGridField
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      columns:
        simple: Rating,String
      context_path:
        simple: Stringsifter.Results
      grid_id:
        simple: stringsifter
      keys:
        simple: Rating,Word
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 10,
          "y": 1860
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 8684daa2-cc12-4573-8fc1-509b73e640d9
    type: title
    task:
      id: 8684daa2-cc12-4573-8fc1-509b73e640d9
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: b915ddc2-5255-41f8-8b85-85b9956bb759
    type: regular
    task:
      id: b915ddc2-5255-41f8-8b85-85b9956bb759
      version: -1
      name: Set strings similarity results in the layout
      description: Creates a Grid table from items or key-value pairs.
      scriptName: SetGridField
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      columns:
        simple: Found String,MITRE ATT&CK Tool,Similarity Ratio
      context_path:
        complex:
          root: similarityCheck
          filters:
          - - operator: isExists
              left:
                value:
                  simple: similarityCheck
                iscontext: true
      grid_id:
        simple: stringssimilarity
      keys:
        simple: StringFromText,StringFromList,similarityRatio
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1860
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: 7507e553-ee84-4263-85c2-5a5e4b37a196
    type: playbook
    task:
      id: 7507e553-ee84-4263-85c2-5a5e4b37a196
      version: -1
      name: Threat Hunting - Generic
      description: "This playbook enables threat hunting for IOCs in your enterprise. It currently supports the following integrations: \n- Splunk\n- Qradar\n- Pan-os \n- Cortex data lake \n- Autofocus\n- Microsoft 365 Defender"
      playbookName: Threat Hunting - Generic
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      IPAddress:
        complex:
          root: ExtractedIndicators
          accessor: IP
          transformers:
          - operator: uniq
      QRadarTimeFrame:
        simple: LAST 7 DAYS
      SplunkEarliestTime:
        simple: -7d@d
      SplunkLatestTime:
        simple: now
      URLDomain:
        complex:
          root: ExtractedIndicators
          accessor: Domain
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: ExtractedIndicators.URL
                iscontext: true
          - operator: uniq
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 230,
          "y": 1390
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: bcc6d2ba-4b32-4c3c-87ba-c4d780443c77
    type: regular
    task:
      id: bcc6d2ba-4b32-4c3c-87ba-c4d780443c77
      version: -1
      name: Hunt RDP IoCs - Exe + Path
      description: Searches Splunk for events.
      script: '|||splunk-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      earliest_time:
        simple: ${inputs.splunkEarliestTime}
      latest_time:
        simple: ${inputs.splunkLatestTime}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": 1390
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: f9e8f06a-e5ad-4784-857a-a85637633d28
    type: regular
    task:
      id: f9e8f06a-e5ad-4784-857a-a85637633d28
      version: -1
      name: Set the original collage in the layout
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      key:
        simple: RDPImageEntryID
      value:
        complex:
          root: File
          filters:
          - - operator: containsString
              left:
                value:
                  simple: File.Name
                iscontext: true
              right:
                value:
                  simple: original
              ignorecase: true
          accessor: EntryID
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 880,
          "y": 1860
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 0380a060-f956-46b9-8071-499cf364e29a
    type: playbook
    task:
      id: 0380a060-f956-46b9-8071-499cf364e29a
      version: -1
      name: Set RDP Bitmap Cache Overall Score
      description: This playbook sets the RDP bitmap cache overall score
      playbookName: Set RDP Bitmap Cache Overall Score
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    separatecontext: false
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -420,
          "y": 1860
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: 7a58e00c-1f74-44d7-8c63-d3b5f3c51f59
    type: regular
    task:
      id: 7a58e00c-1f74-44d7-8c63-d3b5f3c51f59
      version: -1
      name: Set the Technical Details tab in the layout
      description: commands.local.cmd.set.incident
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      usecasedescription:
        simple: "**Remote Desktop Protocol (RDP) is a Microsoft protocol that allows users to connect to other Windows operating systems via a graphical user interface (GUI).**\n\nRDP Bitmap Cache was introduced to improve the RDP user experience while reducing network bandwidth usage. Simply said, it saves cached tiles of your RDP sessions into a file so your session can reuse them and avoid potential delays.\n\n**Why?**\n\n* Attackers often operate outside the organization's working hours, therefore, Weekends and holidays are the best time to operate.\n* As shown - RDP is still massively used by attackers, either as an initial attack vector or for lateral movement within the network.\n* Without any session recording tool, it is almost impossible to tell what happened during the RDP session.\n\n**How do we investigate?**\n\n**Preparation:**\n\n1. Collect the RDP bitmap cache files using Cortex XDR integration.\n2. Process the files and extract the cached tiles using BMC-Tools.\n3. Improve the quality of the extracted collage using PIL and OpenCV.\n4. Extract text from the tiles collage using OCR.\n5. Extract IoCs from the extracted OCR text.\n\n**Analysis:**\n\n6. Search for similar strings against the MITRE ATT&CK Software list.\n7. Detect suspicious strings using Mandiant Stringsifter ML ranking capabilities.\n8. Hunt for the extracted IoCs prevalence using your SIEM.\n\n\n**What will you achieve using this playbook?**\n\n* Helps the analyst determine whether there were internal RDP sessions on predefined hosts.\n* Points out any suspicious activity that was detected.\n* Allows the analyst to hunt for suspicious indicators found during the process.\n* Provide the analyst with the collage processed for further analysis.\n\n**How do we calculate the overall score?**\n\nThe overall score is a combination of:\n1. Tools found in the similarity check:\nThe similarity check produces a similarity ratio for each string and tool pair; the score can be somewhere between 0 to 1. Then we take the similarity ratio and multiply it by 5, meaning a finding can have a maximum score of 5.\ne.g. \nFor a finding with a similarity ratio of 0.85, the score will be 0.85*5 = 4.25.\nWe then sum up all the findings scores and move on to the next step.\n2. Executables found using 'extractindicators' and appear in the Stringsifter results:\nIn this step, we are basing the score on both the extracted indicators of type 'Executables' and the Stringsifter ranking.\nIf an executable was successfully extracted using '!extractindicators' and also appears in the Stringsifter results, we'll take the score and add it to the combined score we got from step 1.\ne.g.\nIf mimikatz.exe was extracted using '!extractinidcators' and also appears in the Stringsifter results with a rank of 9.5, we'll add 9.5 to the overall score.\n\n**Note:**\n* The maximum score can be 100.\n* If the score is 0, no suspicious **strings** were found.\n"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1310,
          "y": 1860
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: c5d895cc-0d8a-49b2-824a-449eff38bd5f
    type: condition
    task:
      id: c5d895cc-0d8a-49b2-824a-449eff38bd5f
      version: -1
      name: Was the file retrieved successfully?
      description: Checkif the file was successfully retrieved
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "32"
      "yes":
      - "10"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: containsString
          left:
            value:
              complex:
                root: File
                accessor: Extension
            iscontext: true
          right:
            value:
              simple: bin
          ignorecase: true
        - operator: containsString
          left:
            value:
              complex:
                root: File
                accessor: Extension
            iscontext: true
          right:
            value:
              simple: bmc
          ignorecase: true
        - operator: isExists
          left:
            value:
              complex:
                root: incident
                accessor: attachment
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -900
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: adb731eb-3747-454f-8420-154a702b8807
    type: title
    task:
      id: adb731eb-3747-454f-8420-154a702b8807
      version: -1
      name: No Files to Process
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "17"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -840,
          "y": 1890
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 8e69838c-895e-4502-8b8c-91e3d1fd02fb
    type: condition
    task:
      id: 8e69838c-895e-4502-8b8c-91e3d1fd02fb
      version: -1
      name: Should collect RDP cache files?
      description: Check if should collect RDP cache from endpoints or cache files to be provided manually.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "31"
      "yes":
      - "35"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.ShouldCollectRDPCache
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -1420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 83a592fb-794f-4a1c-8857-36dc30a0677d
    type: playbook
    task:
      id: 83a592fb-794f-4a1c-8857-36dc30a0677d
      version: -1
      name: Retrieve File from Endpoint - Generic V3
      description: |-
        'This playbook retrieves a file sample from an endpoint using the following playbooks:'
        - Get File Sample From Path - Generic v2.
        - Get File Sample By Hash - Generic v3.
      playbookName: Retrieve File from Endpoint - Generic V3
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "31"
    scriptarguments:
      Agent_ID:
        complex:
          root: inputs.EndpointIDs
          transformers:
          - operator: uniq
      Path:
        complex:
          root: inputs.FilePath
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 690,
          "y": -1080
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: 2e9077f1-944d-4a35-8761-3a93dbce6e3d
    type: title
    task:
      id: 2e9077f1-944d-4a35-8761-3a93dbce6e3d
      version: -1
      name: Get Cache Files
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "36"
      - "34"
      - "31"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -1220
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: d6dae20c-ec34-4bdf-8506-1783736ceb2f
    type: regular
    task:
      id: d6dae20c-ec34-4bdf-8506-1783736ceb2f
      version: -1
      name: Get RDP cache files
      description: Retrieves files from selected endpoints. You can retrieve up to 20 files, from no more than 10 endpoints. At least one endpoint ID and one file path are necessary in order to run the command. After running this command, you can use the xdr-action-status-get command with returned action_id, to check the action status.
      script: '|||xdr-file-retrieve'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "31"
    scriptarguments:
      endpoint_ids:
        complex:
          root: inputs.EndpointIDs
      windows_file_paths:
        complex:
          root: inputs.FilePath
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 200,
          "y": -1080
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: 71205af2-43d9-4957-8cc4-ffaf68ee8454
    type: title
    task:
      id: 71205af2-43d9-4957-8cc4-ffaf68ee8454
      version: -1
      name: Prepare RDP cache image for OCR
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "39"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -430
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 6708e984-cef0-442b-8fe4-94d8f709e615
    type: regular
    task:
      id: 6708e984-cef0-442b-8fe4-94d8f709e615
      version: -1
      name: Preprocess Grayscale Image
      description: This script pre-processes (resizes, sharpens, and grayscales) an image file from context, given an entry_id.
      scriptName: PreProcessImage
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "40"
    scriptarguments:
      action:
        simple: grayscale
      file_entry_id:
        complex:
          root: File
          filters:
          - - operator: containsString
              left:
                value:
                  simple: File.Extension
                iscontext: true
              right:
                value:
                  simple: bmp
              ignorecase: true
          accessor: EntryID
          transformers:
          - operator: uniq
      image_resize_height:
        simple: "4961"
      image_resize_width:
        simple: "7016"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -280
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: eecb86f7-83b0-4b1f-8dcd-8adf43795dd0
    type: regular
    task:
      id: eecb86f7-83b0-4b1f-8dcd-8adf43795dd0
      version: -1
      name: Preprocess Sharpened Image
      description: This script pre-processes (resizes, sharpens, and grayscales) an image file from context, given an entry_id.
      scriptName: PreProcessImage
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "41"
    scriptarguments:
      action:
        simple: sharpened
      file_entry_id:
        complex:
          root: File
          filters:
          - - operator: containsString
              left:
                value:
                  simple: File.Extension
                iscontext: true
              right:
                value:
                  simple: bmp
              ignorecase: true
          accessor: EntryID
          transformers:
          - operator: uniq
      image_resize_height:
        simple: "4961"
      image_resize_width:
        simple: "7016"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -100
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: fb56e0e1-63c3-4c95-8b9d-d3a1c98263d0
    type: regular
    task:
      id: fb56e0e1-63c3-4c95-8b9d-d3a1c98263d0
      version: -1
      name: Preprocess Original Image
      description: This script pre-processes (resizes, sharpens, and grayscales) an image file from context, given an entry_id.
      scriptName: PreProcessImage
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "44"
      - "42"
    scriptarguments:
      action:
        simple: original
      file_entry_id:
        complex:
          root: File
          filters:
          - - operator: containsString
              left:
                value:
                  simple: File.Extension
                iscontext: true
              right:
                value:
                  simple: bmp
              ignorecase: true
          accessor: EntryID
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 70
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "42":
    id: "42"
    taskid: 005cc594-74b1-4aff-8cec-ba5016d8b9bf
    type: title
    task:
      id: 005cc594-74b1-4aff-8cec-ba5016d8b9bf
      version: -1
      name: OCR text extraction
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: be0b1b9a-6ed6-4844-8966-e2f1e9c5bce5
    type: playbook
    task:
      id: be0b1b9a-6ed6-4844-8966-e2f1e9c5bce5
      version: -1
      name: Set list of indicator types
      description: This playbook takes IOCs as input and adds the type into a list to be able to calculate stats about the types of the extracted indicators
      playbookName: Set list of indicator types
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      Domain:
        complex:
          root: ExtractedIndicators
          accessor: Domain
      EmailAddresses:
        complex:
          root: ExtractedIndicators
          accessor: Email
      IP:
        complex:
          root: ExtractedIndicators
          accessor: IP
      URL:
        complex:
          root: ExtractedIndicators
          accessor: URL
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1000
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: 8f9cb3d9-9ce6-42fa-8a5d-0d9c0996401d
    type: title
    task:
      id: 8f9cb3d9-9ce6-42fa-8a5d-0d9c0996401d
      version: -1
      name: Display RDP Cache image
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "45"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1060,
          "y": 240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: e9b330dc-d584-4ddb-8000-c6a61bb42093
    type: regular
    task:
      id: e9b330dc-d584-4ddb-8000-c6a61bb42093
      version: -1
      name: Convert image to png
      description: 'Converts a file from one format to a different format by using the convert-to function of Libre Office. For a list of supported input/output formats see:  https://wiki.openoffice.org/wiki/Framework/Article/Filter/FilterList_OOo_3_0'
      scriptName: ConvertFile
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "47"
    scriptarguments:
      entry_id:
        complex:
          root: File
          filters:
          - - operator: containsString
              left:
                value:
                  simple: File.Name
                iscontext: true
              right:
                value:
                  simple: Original
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: File.Extension
                iscontext: true
              right:
                value:
                  simple: bin_collage
              ignorecase: true
          accessor: EntryID
      format:
        simple: png
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1060,
          "y": 390
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: 5b45875f-222b-4951-8800-8bfa8a377210
    type: regular
    task:
      id: 5b45875f-222b-4951-8800-8bfa8a377210
      version: -1
      name: Convert image to pdf
      description: Converts a PDF file to an image file.
      tags:
      - RDPCacheImage
      script: Rasterize|||rasterize-pdf
      type: regular
      iscommand: true
      brand: Rasterize
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      EntryID:
        complex:
          root: InfoFile
          filters:
          - - operator: containsString
              left:
                value:
                  simple: InfoFile.Name
                iscontext: true
              right:
                value:
                  simple: RDPCacheImage
              ignorecase: true
          - - operator: containsString
              left:
                value:
                  simple: InfoFile.Extension
                iscontext: true
              right:
                value:
                  simple: pdf
              ignorecase: true
          accessor: EntryID
      file_name:
        simple: RDPCacheImage
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1060,
          "y": 810
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: baef2a3c-06f5-454a-87d1-ce1a06e0b83f
    type: regular
    task:
      id: baef2a3c-06f5-454a-87d1-ce1a06e0b83f
      version: -1
      name: Convert pdf to image
      description: Converts an image file to a PDF file.
      script: Rasterize|||rasterize-image
      type: regular
      iscommand: true
      brand: Rasterize
    nexttasks:
      '#none#':
      - "46"
    scriptarguments:
      EntryID:
        complex:
          root: File
          filters:
          - - operator: containsString
              left:
                value:
                  simple: File.Name
                iscontext: true
              right:
                value:
                  simple: original
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: File.Extension
                iscontext: true
              right:
                value:
                  simple: png
              ignorecase: true
          accessor: EntryID
      file_name:
        simple: RDPCacheImage
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1060,
          "y": 620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
system: true
view: |-
  {
    "linkLabelsPosition": {
      "31_10_yes": 0.35,
      "31_32_#default#": 0.1,
      "33_35_yes": 0.48
    },
    "paper": {
      "dimensions": {
        "height": 3665,
        "width": 2530,
        "x": -840,
        "y": -1570
      }
    }
  }
inputs:
- key: ShouldCollectRDPCache
  value:
    simple: "false"
  required: true
  description: When set to True, will use XDR to get RDP cache files from the endpoints, but set to False will try and use existing cache file from context
  playbookInputQuery:
- key: EndpointIDs
  value: {}
  required: false
  description: A comma seperated list of endpoint ID's to retrieve cache files from
  playbookInputQuery:
- key: FilePath
  value:
    simple: C:\Users\administrator\AppData\Local\Microsoft\Terminal Server Client\Cache\
  required: false
  description: |-
    The path of the file to retrieve.
    For example:
    C:\users\folder\file.txt
  playbookInputQuery:
- key: Hostname
  value: {}
  required: false
  description: Hostname of the machine on which the file is located for PS remote it can also be an IP address.
  playbookInputQuery:
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.9.0
