import demistomock as demisto
from CommonServerPython import *
import json


def parse_vulnerability(raw_json):
    data = json.loads(raw_json)
    if 'kind' not in data or data['kind'] != 'vulnerability':
        raise ValueError(f'Input should be a raw JSON vulnerability Alert, received: {raw_json}')

    outputs = {'PrismaCloudCompute.VulnerabilityAlert': data}
    readable_outputs = tableToMarkdown('Vulnerability Information',
                                       data,
                                       headers=['time', 'imageName', 'distroName', 'labels'])
    # add another table for vulnerabilities
    readable_outputs += tableToMarkdown('Vulnerabilities', data['vulnerabilities'])

    return (
        readable_outputs,
        outputs,
        raw_json
    )


def main():
    try:
        return_outputs(*parse_vulnerability(demisto.args().get('alert_raw_json', '')))
    except Exception as ex:
        return_error(f'Failed to execute PrismaCloudComputeParseVulnerabilityAlert. Error: {str(ex)}')


if __name__ in ('__builtin__', 'builtins'):
    main()
