id: Cloud Credentials Rotation - AWS
version: -1
name: Cloud Credentials Rotation - AWS
description: |-
  ## **AWS Credentials Rotation Playbook**

  ### **Identity Remediation**
  Secure compromised accounts by taking swift action:
  - **Reset Password**: Resets the user password to halt any unauthorized access.

  - **Access Key Deactivation**: Deactivate any suspicious or known-compromised access keys.

  - **Combo Action**: In some cases, you may want to reset both the password and deactivate the access key for absolute security.

  ### **Role Remediation**
  If a role is suspected to be compromised:
  - **Deny Policy Implementation**: Attach a deny-all policy to the compromised role, thus preventing it from performing any further actions.

  - **Role Cloning**: Before outright remediation, clone the role. This ensures that you have a backup with the same permissions, making transition smoother.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 9313d1a5-8579-4193-88e6-8f078c78f378
    type: start
    task:
      id: 9313d1a5-8579-4193-88e6-8f078c78f378
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "52"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 490,
          "y": -490
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: fc75c831-3e3e-48a6-8b87-fa216287ec9f
    type: title
    task:
      id: fc75c831-3e3e-48a6-8b87-fa216287ec9f
      version: -1
      name: Compute
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "53"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -40,
          "y": -165
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: 14cb1da4-e792-41ba-8fc8-56f9072eb9bb
    type: title
    task:
      id: 14cb1da4-e792-41ba-8fc8-56f9072eb9bb
      version: -1
      name: Identity
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "35"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1240,
          "y": -165
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: b1c6f9b4-50f4-418d-8f61-b09ce8bd59df
    type: regular
    task:
      id: b1c6f9b4-50f4-418d-8f61-b09ce8bd59df
      version: -1
      name: Deactivate the user's access key
      description: Changes the status of the specified access key from Active to Inactive, or vice versa. This operation can be used to disable a user's key as part of a key rotation workflow.
      script: AWS - IAM|||aws-iam-update-access-key
      type: regular
      iscommand: true
      brand: AWS - IAM
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      accessKeyId:
        complex:
          root: inputs.accessKeyID
      status:
        simple: Inactive
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1030,
          "y": 280
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 816121ba-9b51-48f0-8bfd-cb360284a4d1
    type: regular
    task:
      id: 816121ba-9b51-48f0-8bfd-cb360284a4d1
      version: -1
      name: Force password reset
      description: Changes the password for the specified IAM user.
      script: AWS - IAM|||aws-iam-update-login-profile
      type: regular
      iscommand: true
      brand: AWS - IAM
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      newPassword:
        complex:
          root: NEW_PASSWORD
      passwordResetRequired:
        simple: "True"
      userName:
        complex:
          root: inputs.username
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1450,
          "y": 440
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 445bd7d4-9684-47bd-80c9-78bd1e2f9de2
    type: regular
    task:
      id: 445bd7d4-9684-47bd-80c9-78bd1e2f9de2
      version: -1
      name: Describe regions
      description: Describes one or more regions that are currently available to you.
      script: '|||aws-ec2-describe-regions'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "20"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -40,
          "y": 330
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: 4038fa0a-d0af-45b5-8175-93af1711a170
    type: regular
    task:
      id: 4038fa0a-d0af-45b5-8175-93af1711a170
      version: -1
      name: Describe instances
      description: Describes one or more of your instances.
      script: '|||aws-ec2-describe-instances'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      filters:
        simple: Name=iam-instance-profile.arn,Values=${AWS.EC2.IamInstanceProfileAssociations.IamInstanceProfile.Arn}
      region:
        complex:
          root: AWS.Regions
          accessor: RegionName
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -40,
          "y": 500
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: f6b68df4-eba6-4322-8375-52482d099106
    type: regular
    task:
      id: f6b68df4-eba6-4322-8375-52482d099106
      version: -1
      name: Describe IAM instance profile associations
      description: Describes your IAM instance profile associations.
      script: '|||aws-ec2-describe-iam-instance-profile-associations'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      filters:
        simple: Name=instance-id,Values=${inputs.instanceID}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -40,
          "y": 155
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 67bdf453-1162-4450-8c19-faee5d6d74f9
    type: regular
    task:
      id: 67bdf453-1162-4450-8c19-faee5d6d74f9
      version: -1
      name: Get instance profile
      description: Retrieves information about the specified instance profile.
      script: '|||aws-iam-get-instance-profile'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    scriptarguments:
      instanceProfileName:
        complex:
          root: AWS.EC2.Instances.IamInstanceProfile
          accessor: Arn
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: /
              fields:
                value:
                  simple: "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -40,
          "y": 675
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: a71dee34-aa5d-43c9-8193-6c5a8768e372
    type: regular
    task:
      id: a71dee34-aa5d-43c9-8193-6c5a8768e372
      version: -1
      name: List attached role policies
      description: List all managed policies that are attached to the specified IAM role.
      script: '|||aws-iam-list-attached-role-policies'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "41"
    scriptarguments:
      roleName:
        complex:
          root: AWS.IAM.InstanceProfiles.Roles
          accessor: RoleName
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 170,
          "y": 1300
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: bd5f8612-597c-44b0-838c-8a87304f30e8
    type: regular
    task:
      id: bd5f8612-597c-44b0-838c-8a87304f30e8
      version: -1
      name: List role inline-policies
      description: Lists the names of the inline policies that are embedded in the specified IAM role.
      script: '|||aws-iam-list-role-policies'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "42"
    scriptarguments:
      roleName:
        complex:
          root: AWS.IAM.InstanceProfiles.Roles
          accessor: RoleName
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -250,
          "y": 1460
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: b4701718-20e7-45bf-8949-07adf22eb121
    type: regular
    task:
      id: b4701718-20e7-45bf-8949-07adf22eb121
      version: -1
      name: Create instance profile
      description: Creates a new instance profile.
      script: '|||aws-iam-create-instance-profile'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "26"
    scriptarguments:
      instanceProfileName:
        complex:
          root: inputs.newInstanceProfileName
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -40,
          "y": 2160
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: ebd22fc4-820d-4ace-8c6d-433beb0697a6
    type: regular
    task:
      id: ebd22fc4-820d-4ace-8c6d-433beb0697a6
      version: -1
      name: Create role
      description: Creates a new role for your AWS account.
      script: '|||aws-iam-create-role'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "31"
    scriptarguments:
      assumeRolePolicyDocument:
        complex:
          root: AWS.IAM.InstanceProfiles.Roles
          accessor: AssumeRolePolicyDocument
          transformers:
          - operator: Stringify
      roleName:
        complex:
          root: inputs.newRoleName
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -40,
          "y": 2320
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 01c92e57-1236-4a3f-853f-b0979f979df4
    type: title
    task:
      id: 01c92e57-1236-4a3f-853f-b0979f979df4
      version: -1
      name: Clone Compromised Service Account
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "48"
      - "47"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -40,
          "y": 1025
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: febe1b1d-6a49-4c7b-89ef-944a3fa0be56
    type: title
    task:
      id: febe1b1d-6a49-4c7b-89ef-944a3fa0be56
      version: -1
      name: Change Instance Profile IAM Role
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "33"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -560,
          "y": 2905
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: 658a17ae-262d-40e4-891e-2ea2f8760cb7
    type: regular
    task:
      id: 658a17ae-262d-40e4-891e-2ea2f8760cb7
      version: -1
      name: Attach role policy
      description: Attaches the specified managed policy to the specified IAM resource.
      script: '|||aws-iam-attach-policy'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "49"
    scriptarguments:
      entityName:
        complex:
          root: inputs.newRoleName
      policyArn:
        complex:
          root: AWS.IAM.Roles.AttachedPolicies.Policies
          accessor: PolicyArn
      type:
        simple: Role
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -40,
          "y": 2480
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 32a94fb8-0bb1-444f-8950-3fa159f8a80b
    type: regular
    task:
      id: 32a94fb8-0bb1-444f-8950-3fa159f8a80b
      version: -1
      name: Attach deny policy to a user
      description: Adds or updates an inline policy document that is embedded in the specified IAM role.
      script: '|||aws-iam-put-role-policy'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "36"
    scriptarguments:
      policyDocument:
        simple: |-
          {
              "Version": "2012-10-17",
              "Statement": [
                  {
                      "Effect": "Deny",
                      "Action": [
                          "*"
                      ],
                      "Resource": [
                          "*"
                      ],
                      "Condition": {
                          "DateLessThan": {
                              "aws:TokenIssueTime": "[policy creation time]"
                          }
                  }
              ]
          }
      policyName:
        simple: XSIAM-DenyPolicy-Alert ${alert.id}
      roleName:
        complex:
          root: AWS.IAM.InstanceProfiles.Roles
          accessor: RoleName
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: inputs.roleNameToRestrict
                iscontext: true
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -560,
          "y": 3040
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 4cd4ded3-d8b3-4164-8b3d-8c7c90120bc3
    type: condition
    task:
      id: 4cd4ded3-d8b3-4164-8b3d-8c7c90120bc3
      version: -1
      name: Should clone before putting a deny policy?
      description: Checks whether to clone the service account before putting a deny policy to it.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "30"
      "Yes":
      - "29"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.shouldCloneSA
            iscontext: true
          right:
            value:
              simple: "True"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -40,
          "y": 840
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: a8449be1-af83-4779-8b0e-c66617b0c254
    type: condition
    task:
      id: a8449be1-af83-4779-8b0e-c66617b0c254
      version: -1
      name: Check remediation type
      description: Checks the remediation type provided by the user.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      ALL:
      - "39"
      Deactivate Access Key:
      - "16"
      Reset Password:
      - "51"
    separatecontext: false
    conditions:
    - label: Deactivate Access Key
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.IAMRemediationType
            iscontext: true
          right:
            value:
              simple: Deactivate
          ignorecase: true
    - label: Reset Password
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.IAMRemediationType
            iscontext: true
          right:
            value:
              simple: Reset
          ignorecase: true
    - label: ALL
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.IAMRemediationType
            iscontext: true
          right:
            value:
              simple: ALL
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1240,
          "y": -30
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: bb75f89d-76b4-40f8-86ea-34a5f89e309f
    type: title
    task:
      id: bb75f89d-76b4-40f8-86ea-34a5f89e309f
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 490,
          "y": 3220
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: 9d6df99a-ba48-4f06-866b-513bc4e20370
    type: title
    task:
      id: 9d6df99a-ba48-4f06-866b-513bc4e20370
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1030,
          "y": 675
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 580ab97b-9f0b-489c-82e6-242ceccf0d8a
    type: title
    task:
      id: 580ab97b-9f0b-489c-82e6-242ceccf0d8a
      version: -1
      name: ALL
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "16"
      - "51"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1830,
          "y": 140
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: 22f43dcc-ecaa-444c-8e9c-d1d461e0099c
    type: regular
    task:
      id: 22f43dcc-ecaa-444c-8e9c-d1d461e0099c
      version: -1
      name: Set attached policies ARN
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "45"
    scriptarguments:
      key:
        simple: attachedPoliciesARN
      value:
        complex:
          root: AWS.IAM.Roles.AttachedPolicies.Policies
          accessor: PolicyArn
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 170,
          "y": 1460
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "42":
    id: "42"
    taskid: 2fda800e-a38f-47aa-8948-faaf2abe2200
    type: regular
    task:
      id: 2fda800e-a38f-47aa-8948-faaf2abe2200
      version: -1
      name: Set policies name
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "44"
    scriptarguments:
      key:
        simple: policyNames
      value:
        complex:
          root: AWS.IAM.Roles
          accessor: Policies
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -250,
          "y": 1620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 5a61f856-188a-479f-85b5-734b844f4b58
    type: condition
    task:
      id: 5a61f856-188a-479f-85b5-734b844f4b58
      version: -1
      name: Was role policies retrieved?
      description: Checks whether managed or inline policies are available.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "36"
      "yes":
      - "25"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: AWS.IAM.Policies.Versions.Document
            iscontext: true
          right:
            value: {}
        - operator: isNotEmpty
          left:
            value:
              simple: AWS.IAM.Roles.PolicyDocument
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -40,
          "y": 1950
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: 311463fc-149a-4934-868f-21e75633cb5a
    type: regular
    task:
      id: 311463fc-149a-4934-868f-21e75633cb5a
      version: -1
      name: Get role policies
      description: Retrieves the specified inline policy document that is embedded with the specified IAM role.
      script: '|||aws-iam-get-role-policy'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      policyName:
        complex:
          root: policyNames
      roleName:
        simple: AmazonEKSNodeRole
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -250,
          "y": 1780
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: 3458d994-1152-4c3f-805d-4d3248ba0e58
    type: regular
    task:
      id: 3458d994-1152-4c3f-805d-4d3248ba0e58
      version: -1
      name: List policy versions
      description: Lists information about the versions of the specified managed policy, including the version that is currently set as the policy's default version.
      script: '|||aws-iam-list-policy-versions'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "46"
    scriptarguments:
      policyArn:
        complex:
          root: attachedPoliciesARN
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 170,
          "y": 1620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: c68afd18-41de-4728-82fd-540c58ebf89c
    type: regular
    task:
      id: c68afd18-41de-4728-82fd-540c58ebf89c
      version: -1
      name: Get policy version
      description: Retrieves information about the specified version of the specified managed policy, including the policy document.
      script: '|||aws-iam-get-policy-version'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      policyArn:
        complex:
          root: AWS.IAM.Policies.Versions
          accessor: PolicyArn
      versionId:
        complex:
          root: AWS.IAM.Policies.Versions
          accessor: VersionId
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 170,
          "y": 1780
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: Policy Details
      output:
        complex:
          root: AWS.IAM.Policies.Versions.Document
          accessor: Version
          transformers:
          - operator: toUpperCase
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: f66f3a00-f50c-4017-8527-0e8c4d305e63
    type: title
    task:
      id: f66f3a00-f50c-4017-8527-0e8c4d305e63
      version: -1
      name: Managed Policies
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "23"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 170,
          "y": 1170
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: 278c77ca-ad08-48aa-8769-965511e79a90
    type: title
    task:
      id: 278c77ca-ad08-48aa-8769-965511e79a90
      version: -1
      name: Inline Policies
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "24"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -250,
          "y": 1170
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "49":
    id: "49"
    taskid: 6140183f-9ba6-43f7-83e2-fd6cef36939e
    type: regular
    task:
      id: 6140183f-9ba6-43f7-83e2-fd6cef36939e
      version: -1
      name: Put role policy
      description: Adds or updates an inline policy document that is embedded in the specified IAM role.
      script: '|||aws-iam-put-role-policy'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "36"
      - "30"
    scriptarguments:
      policyDocument:
        complex:
          root: AWS.IAM.Policies.Versions
          accessor: Document
          transformers:
          - operator: Stringify
      policyName:
        complex:
          root: policyNames
      roleName:
        complex:
          root: inputs.newRoleName
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -40,
          "y": 2640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "51":
    id: "51"
    taskid: 977a78f1-6c7e-4ebc-8362-e818d9370394
    type: regular
    task:
      id: 977a78f1-6c7e-4ebc-8362-e818d9370394
      version: -1
      name: Generate a temporary password
      description: "This function generates a password and allows various parameters to customize the properties of the password depending on the use case (e.g. password complexity requirements).  The default behavior is to generate a password of  *random length* including all four character classes (upper, lower, digits, symbols) with at least five and at most ten characters per class. \n\nThe min_* values all default to 0. This means that if the command is executed in this way:\n!GeneratePassword max_lcase=10\nIt is possible that a password of length zero could be generated. It is therefore recommended to always include a min_* parameter that matches. \n\nThe debug parameter will print certain properties of the command into the WarRoom for easy diagnostics."
      scriptName: GeneratePassword
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      min_digits:
        simple: "5"
      min_lcase:
        simple: "5"
      min_symbols:
        simple: "2"
      min_ucase:
        simple: "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1450,
          "y": 280
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: 07983ad3-75ac-4fe0-893a-287ce94d25cb
    type: condition
    task:
      id: 07983ad3-75ac-4fe0-893a-287ce94d25cb
      version: -1
      name: Check identity type
      description: Checks the identity type that was part of the alert.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "36"
      - "37"
      ROLE:
      - "1"
      USER:
      - "10"
    separatecontext: false
    conditions:
    - label: ROLE
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.identityType
            iscontext: true
          right:
            value:
              simple: Compute
          ignorecase: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.instanceID
            iscontext: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.instanceProfileName
            iscontext: true
    - label: USER
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.identityType
            iscontext: true
          right:
            value:
              simple: User
          ignorecase: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.username
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.accessKeyID
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 490,
          "y": -350
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "53":
    id: "53"
    taskid: 27716a5f-f106-47ac-81b1-78bf798c5c47
    type: condition
    task:
      id: 27716a5f-f106-47ac-81b1-78bf798c5c47
      version: -1
      name: Should investigate the compromised instance?
      description: Checks if the user provided a role name to put a deny policy to.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "30"
      "yes":
      - "21"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEmpty
          left:
            value:
              complex:
                root: inputs.roleName
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -40,
          "y": -30
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "34_29_Yes": 0.39,
      "34_30_#default#": 0.17,
      "35_16_Deactivate Access Key": 0.51,
      "35_39_ALL": 0.7,
      "35_51_Reset Password": 0.51,
      "43_25_yes": 0.44,
      "43_36_#default#": 0.26,
      "52_10_USER": 0.77,
      "52_1_ROLE": 0.7,
      "52_36_#default#": 0.18,
      "52_37_#default#": 0.74,
      "53_21_yes": 0.46,
      "53_30_#default#": 0.12
    },
    "paper": {
      "dimensions": {
        "height": 3775,
        "width": 2770,
        "x": -560,
        "y": -490
      }
    }
  }
inputs:
- key: IAMRemediationType
  value: {}
  required: false
  description: |-
    The response playbook provides the following remediation actions for IAM users:

    Reset - By entering "Reset" in the input, the playbook will execute password reset.

    Deactivate - By entering "Deactivate" in the input, the playbook will execute access key deactivation.

    ALL - By entering "ALL" in the input, the playbook will execute both password reset and access key deactivation.
  playbookInputQuery:
- key: shouldCloneSA
  value: {}
  required: false
  description: Whether to clone the compromised SA before putting a deny policy to it.
  playbookInputQuery:
- key: identityType
  value: {}
  required: false
  description: |-
    The type of identity involved. Usually mapped to the incident field named 'cloudidentitytype'.
    e.g.
    USER,SERVICE_ACCOUNT,APPLICATION
  playbookInputQuery:
- key: newRoleName
  value: {}
  required: false
  description: The new role name to assign in the clone service account flow.
  playbookInputQuery:
- key: newInstanceProfileName
  value: {}
  required: false
  description: The new instance profile name to assign in the clone service account flow.
  playbookInputQuery:
- key: accessKeyID
  value: {}
  required: false
  description: The access key ID.
  playbookInputQuery:
- key: username
  value: {}
  required: false
  description: The user name.
  playbookInputQuery:
- key: instanceID
  value: {}
  required: false
  description: The instance ID.
  playbookInputQuery:
- key: roleNameToRestrict
  value: {}
  required: false
  description: If provided, the role will be attached with a deny policy without the compute instance analysis flow.
  playbookInputQuery:
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.9.0
