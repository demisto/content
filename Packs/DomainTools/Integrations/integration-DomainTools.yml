versionedfields: {}
commonfields:
  id: DomainTools
  version: -1
name: DomainTools
fromversion: 5.0.0
display: DomainTools
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: Domain name, DNS and Internet OSINT-based cyber threat intelligence and cybercrime forensics products and data
configuration:
- display: DomainTools API URL
  name: server
  defaultvalue: http://api.domaintools.com/
  type: 0
  required: true
- display: API Username
  name: username
  defaultvalue: ""
  type: 0
  required: true
- display: API Key
  name: key
  defaultvalue: ""
  type: 4
  required: true
- display: Trust any certificate (not secure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: >-
    var toCamelCase = function(string){
        var str = ' '+string.trim();
        str=str.replace(/ ([a-z,A-Z])/g, function (g) { return g[1].toUpperCase(); });
        return str;
    };


    var sendRequest = function(url) {
        var res = http(
            url,
            {
                Method: 'GET',
                Headers: {
                    Accept: ['application/json']
                }
            },
            params.insecure,
            params.proxy
        );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }

        try {
            return JSON.parse(res.Body);
        }
        catch (err) {
            throw 'Failed to parse JSON';
        }
    };


    var addKeyToJson = function(cur, toAdd){
        if(!cur){
            return toAdd;
        }
        if(!Array.isArray(cur)){
            return [cur, toAdd];
        }
        cur.push(toAdd);
        return cur;
    };


    var changeKeys = function(conv, obj){
        var output = {};
        for (var i in obj) {
            if (Object.prototype.toString.apply(obj[i]) === '[object Object]') {
                output[conv(i)] = changeKeys(conv, obj[i]);
            } else {
                output[conv(i)] = obj[i];
            }
        }
        return output;
    };


    var callWhoIs = function(query, parsed,url){
        var res = sendRequest(url + query + '/whois/parsed/'+encodeToURLQuery({'api_username':params.username,'api_key':params.key}));
        var error = res.response.error;
        if(error && error.code === 206){
            parsed = false;
            log('error code 206');
        }
        var splitRes = res.response.whois.record.split('\n');
        var md = '### DomainTools whois result for '+ query + '\n';
        var resMap = {};
        splitRes.forEach(function(entry){
            splitEntry = entry.split(/:\s(.+)/);
            if(splitEntry[1]){
                splitEntry[0] = toCamelCase(splitEntry[0]);
                md += '**'+splitEntry[0]+':** '+splitEntry[1]+'\n';
                resMap[splitEntry[0]] = addKeyToJson(resMap[splitEntry[0]], splitEntry[1]);
            }
        });

        var context;
        if(parsed === 'false'){
            context = {'Domain': {'Name': res.response.record_source, 'Whois': resMap}};
        }else{
            context = {'Domain': {'Name': res.response.record_source, 'Whois': changeKeys(toCamelCase, res.response.parsed_whois)}};
        }

        return {
                Type: entryTypes.note,
                Contents: res,
                ContentsFormat: formats.json,
                ReadableContentsFormat: formats.markdown,
                HumanReadable: md,
                EntryContext: context
            };
    };


    var scoreConv = function(score, threshold){
        if(threshold){
            return score>=threshold ? 3 : 1;
        }
        if(score === 0)
            return 1;
        if(score > 0 && score <=69)
            return 2;
        if(score >= 70)
            return 3;
        return -1;
    };


    var callDomain = function(url, domain, threshold){
        var repRes = sendRequest(url + 'reputation/'+encodeToURLQuery({'api_username':params.username,'api_key':params.key, 'domain' : domain}));
        var md = 'Domain '+repRes.response.domain+' found with risk score of '+ repRes.response.risk_score +'.';
        var context = {
            'DBotScore' : {
                'Indicator' : domain,
                'Score' : scoreConv(repRes.response.risk_score, threshold),
                'Type': 'domain',
                'Vendor': 'domaintools'
            }
        };
        if(context.DBotScore.Score === 3){
            addMalicious(context, outputPaths.domain, {'Name' : domain, 'RiskScore': repRes.response.risk_score ,'Malicious' : {'Vendor' : 'DomainTools'}});
        }

        return {
                Type: entryTypes.note,
                Contents: repRes,
                ContentsFormat: formats.json,
                HumanReadable: md,
                ReadableContentsFormat: formats.markdown,
                EntryContext: context
            };
    };


    var callProfile= function(url, domain){
        var domRes = sendRequest(url + domain + '/'+encodeToURLQuery({'api_username':params.username,'api_key':params.key}));
        return {
                Type: entryTypes.note,
                Contents: domRes,
                ContentsFormat: formats.json
            };
    };


    var argToUrlParam = function(string){
        var map = {
            'exclude':'exclude_query',
            'maxLength':'max_length',
            'minLength':'min_length',
            'hesHyphen':'has_hyphen',
            'hasNumber':'has_number',
            'activeOnly':'active_only',
            'deletedOnly':'deleted_only',
            'anchorLeft':'anchor_left',
            'anchorRight':'anchor_right',
            'pageNumber':'page'
        };
        return map[string] ? map[string] : string;
    };


    var callDomainSearch = function(url, args){
        args = changeKeys(argToUrlParam,args);
        args.api_username = params.username;
        args.api_key = params.key;
        var res = sendRequest(url +  'domain-search/'+encodeToURLQuery(args));
        var results = res.response.results;

        var md = '';
        var numDomains = 0;
        var context = {'Domain' : []};
        if(results && results.length > 0){
            results.forEach(function(result){
                if(result.hashad_tlds && result.hashad_tlds.length > 0){
                    result.hashad_tlds.forEach(function(tld){
                        md+='* '+result.sld+'.'+tld+'\n';
                        numDomains++;
                        context.Domain.push({'Name' : result.sld+'.'+tld});
                    });
                }
            });
        }

        return {
                Type: entryTypes.note,
                Contents: res,
                ContentsFormat: formats.json,
                ReadableContentsFormat: formats.markdown,
                HumanReadable: 'Found '+numDomains +' domains:\n'+md,
                EntryContext: context
            };
    };


    var callReverseIP = function(url, args){
        var md = '';
        var context = {'Domain' : []};
        var res;
        var addresses;
        if(args.domain){
            res = sendRequest(url + args.domain+'/reverse-ip/'+encodeToURLQuery({'api_username':params.username,'api_key':params.key, 'limit': args.limit? args.limit : 50}));

        }
        else if(args.ip){
            res = sendRequest(url + args.ip+'/host-domains/'+encodeToURLQuery({'api_username':params.username,'api_key':params.key, 'limit': args.limit? args.limit : 50}));
        }
        addresses = res.response.ip_addresses;
        if(!Array.isArray(addresses)){
            addresses = [addresses];
        }

        addresses.forEach(function(address){
            md+= '\nFound ' + address.domain_count + ' domains for ' +address.ip_address + '\n';
            address.domain_names.forEach(function(domain){
                md += '* ' + domain + '\n';
                context.Domain.push({'Name': domain, 'DNS' : {'Address' : address.ip_address}});
            });
        });

        return {
            Type: entryTypes.note,
            Contents: res,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: md,
            EntryContext: context
        };
    }


    var callReverseNameServer = function(url, server, limit){
        var res = sendRequest(url +server + '/name-server-domains/' + encodeToURLQuery({'api_username':params.username,'api_key':params.key, 'limit': limit? limit : 50}));
        var md = 'Found ' +  res.response.primary_domains.length + ' domains\n';
        var context = {'Domain' : []};
        res.response.primary_domains.forEach(function(domain){
            md += '* ' + domain + '\n';
            context.Domain.push({'Name' : domain});
        });

        return {
            Type: entryTypes.note,
            Contents: res,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: md,
            EntryContext: context
        };
    }


    var callReverseWhoIs = function(url, args){
        args.api_username = params.username;
        args.api_key = params.key;
        args.mode = args.quoteMode;
        args.scope = 'current';
        if(args.onlyHistoricScope === 'true'){
            args.scope = 'historic';
        }
        delete args.quoteModel
        delete args.onlyHistoricScope;

        var res = sendRequest(url + encodeToURLQuery(args));
        var context = {'Domain' : []};
        var md = 'Found '+res.response.domains.length+ ' domains: \n';
        res.response.domains.forEach(function(domain){
            md += '* ' + domain + '\n';
            context.Domain.push({'Name' : domain});
        });

        return {
            Type: entryTypes.note,
            Contents: res,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: md,
            EntryContext: context
        };
    }


    /*http://api.domaintools.com/v1/domaintools.com/whois/history/*/

    var callWhoisHistory = function(url, domain){
        var res = sendRequest(url+domain+'/whois/history/'+ encodeToURLQuery({'api_username':params.username,'api_key':params.key}));
        var splitRecord;
        var context = {'Domain' : {'Name' : domain, 'WhoisHistory' : []}};
        var md = '';
        var entryContext, record;
        res.response.history.forEach(function(entry){
            entryContext = {};
            record = entry.whois.record;
            if(record){
                var splitRecord = record.split('\n');
                splitRecord.forEach(function(pair){
                    splitEntry = pair.split(/:\s(.+)/);
                        if(splitEntry[1]){
                            splitEntry[0] = toCamelCase(splitEntry[0]);
                            md += '**'+splitEntry[0]+':** '+splitEntry[1]+'\n';
                            entryContext[splitEntry[0]] = splitEntry[1];
                        }
                });
            }
            context.Domain.WhoisHistory.push(entryContext);
        });

        return {
            Type: entryTypes.note,
            Contents: res,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: md,
            EntryContext: context
        };
    }


    var url = params.server.replace(/[\/]+$/, '');

    switch (command) {
        case 'test-module':
                var res = sendRequest(url + '/v1/demisto.com/whois/parsed/'+encodeToURLQuery({'api_username':params.username,'api_key':params.key}));
                if(res.response.error){
                    log('Something went wrong - error code ' + error.code);
                }
                return 'ok';
        case 'domain':
            return callDomain(url+'/v1/', args.domain, args.threshold);
        case 'domainSearch':
            return callDomainSearch(url+'/v2/', args);
        case 'reverseIP':
            return callReverseIP(url+'/v1/', args);
        case 'reverseNameServer':
            return callReverseNameServer(url+'/v1/', args.nameServer, args.limit);
        case 'reverseWhois':
            return callReverseWhoIs(url + '/v1/reverse-whois/', args);
        case 'whois':
            return callWhoIs(args.query, args.parsed, url+'/v1/');
        case 'whoisHistory':
            return callWhoisHistory(url+'/v1/', args.domain);
        case 'domainProfile':
            return callProfile(url+'/v1/', args.domain);
    }
  type: javascript
  commands:
  - name: domain
    arguments:
    - name: domain
      required: true
      description: Domain name to check reputation
    - name: long
      description: Should we return full response with detected URLs
    - name: sampleSize
      description: The number of samples from each type (resolutions, detections, etc.) to display for long format
    - name: threshold
      description: 'If number of positive detected domains is bigger than the threshold we will consider it malicious'
    - name: wait
      description: Wait time between tries if we reach the API rate limit in seconds
    - name: retries
      description: Number of retries for API rate limit
    outputs:
    - contextPath: Domain.Name
      description: The tested domain
    - contextPath: Domain.RiskScore
      description: The reputation returned from DomainTools
    - contextPath: Domain.Malicious.Vendor
      description: For malicious domains, the vendor that made the decision
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
    - contextPath: DBotScore.Type
      description: The indicator type.
    - contextPath: DBotScore.Vendor
      description: The vendor used to calculate the score.
    - contextPath: DBotScore.Score
      description: The actual score.
    description: Retrieve domain information.
  - name: domainSearch
    arguments:
    - name: query
      required: true
      default: true
      description: (mandatory and default) Query strings. Each term in the query string must be at least three characters long. Use spaces to separate multiple terms
    - name: pageNumber
      description: 'Sets the page of results to retrieve from the server. Each page is limited to 100 results. Default: 1'
      defaultValue: "1"
    - name: maxLength
      description: 'Limit the maximum domain character count. Default: 25'
      defaultValue: "25"
    - name: minLength
      description: 'Limit the minimum domain character count. Default: 1'
      defaultValue: "1"
    - name: hesHyphen
      description: '(true or false) Return results with hyphens in the domain name. Default: true'
    - name: exclude
      description: Terms to exclude from matching
    - name: activeOnly
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: '(true or false) Return only domains currently registered.Default: false'
      defaultValue: "false"
    - name: deletedOnly
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: '(true or false) Return only domains previously registered but not currently registered. Default: false'
      defaultValue: "false"
    - name: anchorLeft
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: '(true or false) Return only domains that start with the query term. Default: false'
      defaultValue: "false"
    - name: anchorRight
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: '(true or false) Return only domains that end with the query term. Default: false'
      defaultValue: "false"
    - name: hasNumber
      auto: PREDEFINED
      predefined:
      - "false"
      - "true"
      description: '(true or false) Return results with numbers in the domain name. Default: true'
      defaultValue: "true"
    outputs:
    - contextPath: Domain.Name
      description: Domain found by command
    description: Search for domain based on the given parameters
  - name: reverseIP
    arguments:
    - name: ip
      default: true
      description: (default) specify IP address
    - name: domain
      description: 'If you provide a domain name, DomainTools will respond with the list of other domains that share the same IP'
    - name: limit
      description: Limits the size of the domain list than can appear in a response. The limit is applied per-IP address, not for the entire request.
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Domain.DNS.Address
      description: IP address
    description: Reverse loopkup of an IP address
  - name: reverseNameServer
    arguments:
    - name: nameServer
      required: true
      default: true
      description: '(default and mandatory) specify the name of the primary or secondary name server'
    - name: limit
      description: Limit the size of the domain list than can appear in a response
    outputs:
    - contextPath: Domain.Name
      description: Name of domain
    description: Reverse nameserver lookup
  - name: reverseWhois
    arguments:
    - name: terms
      required: true
      default: true
      description: '(mandatory and default) List of one or more terms to search for in the Whois record, separated with the pipe character ( | ).'
    - name: exclude
      description: Domain names with Whois records that match these terms will be excluded from the result set. Separate multiple terms with the pipe character ( | ).
    - name: onlyHistoricScope
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: Show only historic records
      defaultValue: "false"
    - name: quoteMode
      description: 'Only lists the size and retail price of the query if you have per-domain pricing access purchase : includes the complete list of domain names that match the query'
      defaultValue: purchase
    outputs:
    - contextPath: Domain.Name
      description: Name of domain
    description: Reverse lookup of whois information
  - name: whois
    arguments:
    - name: query
      required: true
      default: true
      description: '(mandatory and default) enter domain (do not use full URL). e.g. !whois [query=]demisto.com'
    - name: parsed
      description: Should return parsed or raw response. Default is true
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      defaultValue: "true"
    outputs:
    - contextPath: Domain.Name
      description: Requested domain name
    - contextPath: Domain.Whois
      description: Whois data
    description: Provides registration details about a domain
  - name: whoisHistory
    arguments:
    - name: domain
      required: true
      default: true
      description: Specify domain e.g. mycompany.com
    outputs:
    - contextPath: Domain.Name
      description: Name of domain
    - contextPath: Domain.WhoisHistory
      description: Domain Whois history data
    description: Display a history of whois for a given domain
  - name: domainProfile
    description: Display profile for a given domain
    arguments:
    - name: domain
      description: Specify domain e.g. mycompany.com
