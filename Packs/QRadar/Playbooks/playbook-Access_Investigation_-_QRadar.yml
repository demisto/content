id: Access Investigation - QRadar
version: -1
contentitemexportablefields:
  contentitemfields: {}
name: Access Investigation - QRadar
fromversion: 5.0.0
description: |-
  This playbook uses the QRadar integration to investigate an access incident by gathering user and IP information.

  The playbook then interacts with the user that triggered the incident to confirm whether or not they initiated the access action.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 9191bc70-1a40-4150-83d9-66731d89243f
    type: start
    task:
      id: 9191bc70-1a40-4150-83d9-66731d89243f
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": -640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 0397e09e-ea98-47a4-8148-7df722f74fe4
    type: title
    task:
      id: 0397e09e-ea98-47a4-8148-7df722f74fe4
      version: -1
      name: QRadar alert
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "12"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": -510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 12caaa45-7f58-4a12-8c36-319eaa965335
    type: title
    task:
      id: 12caaa45-7f58-4a12-8c36-319eaa965335
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": 760
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: f70f96cb-af85-4d16-8cf5-bd5a7b49faa3
    type: title
    task:
      id: f70f96cb-af85-4d16-8cf5-bd5a7b49faa3
      version: -1
      name: Investigate access incident
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "16"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 330,
          "y": 460
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 9f8ca299-84fc-4f06-83ba-c6732c8e2a94
    type: condition
    task:
      id: 9f8ca299-84fc-4f06-83ba-c6732c8e2a94
      version: -1
      name: Is QRadar v3 enabled?
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "13"
      "yes":
      - "14"
    scriptarguments:
      brandname:
        simple: QRadar v3
    results:
    - brandInstances
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": -380
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: d98f60dc-6fce-438c-8274-38b0d42044d6
    type: playbook
    task:
      id: d98f60dc-6fce-438c-8274-38b0d42044d6
      version: -1
      name: QRadar - Get Offense Logs
      playbookName: QRadar - Get Offense Logs
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      ApiVersion:
        simple: "17"
      Fields:
        simple: QIDNAME(qid), LOGSOURCENAME(logsourceid), CATEGORYNAME(highlevelcategory), CATEGORYNAME(category), PROTOCOLNAME(protocolid), sourceip, sourceport, destinationip, destinationport, QIDDESCRIPTION(qid), username, PROTOCOLNAME(protocolid), RULENAME("creEventList"), sourcegeographiclocation, sourceMAC, sourcev6, destinationgeographiclocation, destinationv6, LOGSOURCETYPENAME(devicetype), credibility, severity, magnitude, eventcount, eventDirection, postNatDestinationIP, postNatDestinationPort, postNatSourceIP, postNatSourcePort, preNatDestinationPort, preNatSourceIP, preNatSourcePort, UTF8(payload), starttime, devicetime
      GetOnlyCREEvents:
        simple: All
      ID:
        complex:
          root: incident
          accessor: idoffense
      MaxLogsCount:
        simple: "50"
      StartTime:
        complex:
          root: Time
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 50,
          "y": -40
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 46a1eb43-95b0-467f-8d3a-b0788e69fefa
    type: regular
    task:
      id: 46a1eb43-95b0-467f-8d3a-b0788e69fefa
      version: -1
      name: Set timestamp to epoch
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      key:
        simple: Time
      value:
        complex:
          root: incident.labels
          accessor: start_time
          transformers:
          - operator: FormattedDateToEpoch
            args:
              formatter:
                value:
                  simple: '%Y-%m-%dT%H:%M:%S.%fZ'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 330,
          "y": -210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: ea580cc9-542b-4fe0-809a-ca20b3ca2f1c
    type: regular
    task:
      id: ea580cc9-542b-4fe0-809a-ca20b3ca2f1c
      version: -1
      name: Set QRadar information into access custom fields
      description: |-
        Set the information retrieved from QRadar into the access incident custom fields:
        * Dest
        * Src
        * Src User
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "6"
    scriptarguments:
      destinationip:
        complex:
          root: QRadar
          accessor: DestinationIP
          transformers:
          - operator: uniq
          - operator: Stringify
      sourceip:
        complex:
          root: QRadar
          accessor: SourceIP
          transformers:
          - operator: uniq
          - operator: Stringify
      sourceusername:
        complex:
          root: QRadar
          accessor: Username
          transformers:
          - operator: uniq
          - operator: Stringify
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 330,
          "y": 295
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: 15f52d7e-9c46-41b1-8130-5509012548b6
    type: playbook
    task:
      id: 15f52d7e-9c46-41b1-8130-5509012548b6
      version: -1
      name: Access Investigation - Generic
      description: |-
        This playbook investigates an access incident by gathering user and IP information.

        The playbook then interacts with the user that triggered the incident to confirm whether or not they initiated the access action.
      playbookName: Access Investigation - Generic
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      DstIP:
        complex:
          root: QRadar
          accessor: DestinationIP
          transformers:
          - operator: uniq
      OnCall:
        simple: "false"
      Role:
        simple: Administrator
      SrcIP:
        complex:
          root: QRadar
          accessor: SourceIP
          transformers:
          - operator: uniq
      Username:
        complex:
          root: QRadar
          accessor: Username
          transformers:
          - operator: uniq
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 330,
          "y": 590
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 8adcf912-ff35-438c-8887-10d8f325d59d
    type: condition
    task:
      id: 8adcf912-ff35-438c-8887-10d8f325d59d
      version: -1
      name: Offense logs found?
      type: condition
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#default#':
      - "5"
      "yes":
      - "15"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: QRadar
                accessor: SourceIP
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: QRadar
                accessor: DestinationIP
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: QRadar
                accessor: Username
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": 120
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
system: true
view: |-
  {
    "linkLabelsPosition": {
      "12_13_#default#": 0.53
    },
    "paper": {
      "dimensions": {
        "height": 1465,
        "width": 660,
        "x": 50,
        "y": -640
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
