import json

from QutteraWebsiteMalwareScanner import Client, scan_start, rescan_status

SERVER_URL = "scannerapi.quttera.com"
HTTPS_BASE = f"https://{SERVER_URL}/api/v3"

def test_start_scan(requests_mock):
    """
    Given
            An API key, and domain to scan
    When
            Calling the scan
    Then
            Test the scan trigger response
    """
    mock_response = {
        "error": 200,
        "errorstr": "success"
    }
    requests_mock.post(
        f"${HTTPS_BASE}/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/url/scan/domain.test",
        json=mock_response
    )

    args = {
        "domain": "domain.test"
    }

    client = Client({
        "base_url": f"${HTTPS_BASE}",
        "apikey": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
    })

    response = scan_start(client, args)
    assert response.outputs == mock_response

def test_rescan_status(requests_mock):
    """
    Given
            An API key, and domain to scan
    When
            Rescan the domain
    Then
            Test the scan trigger response
    """
    mock_response = {
        'error': 200,
        'errorstr': 'success',
        'status': { 
            'blacklisted': 'no',
            'files': 12,
            'scanner_result': 'undef',
            'sensitivity': 'HEURISTIC',
            'state': 'SCAN',
            'time': 1653420189,
            'url': 'quttera.com'
        }
    }
    requests_mock.put(
        f"${HTTPS_BASE}/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/url/scan/domain.test.json",
        json=mock_response
    )

    args = {
        "domain": "domain.test"
    }

    client = Client({
        "base_url": f"${HTTPS_BASE}",
        "apikey": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
    })

    response = rescan_status(client, args)
    assert response.outputs == mock_response
