import json

from QutteraWebsiteMalwareScanner import Client, scan_start, rescan_status


def test_start_scan(requests_mock):
    """test start-scan command
    """
    mock_response = {
        "error": 200,
        "errorstr": "success"
    }
    requests_mock.get(
        "https://scannerapi.quttera.com/api/v3/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/url/scan/domain.test",
        json=mock_response
    )

    args = {
        "domain": "domain.test"
    }

    client = Client(
        base_url = "https://scannerapi.quttera.com/api/v3/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
    )

    response = scan_start(client, args)
    assert response.output_key_field == 'QutteraWebsiteMalwareScanning.start'
    assert response.outputs == mock_response

def test_rescan_status(request_mock):
    """test rescan
    """
    mock_response = {
        'error': 200,
        'errorstr': 'success',
        'status': { 
            'blacklisted': 'no',
            'files': 12,
            'scanner_result': 'undef',
            'sensitivity': 'HEURISTIC',
            'state': 'SCAN',
            'time': 1653420189,
            'url': 'quttera.com'
        }
    }
    request_mock.put(
        "https://scannerapi.quttera.com/api/v3/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/url/scan/domain.test",
        json=mock_response
    )

    args = {
        "domain": "domain.test"
    }

    client = Client(
        base_url = "https://scannerapi.quttera.com/api/v3/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
    )

    response = rescan_status(client, args)
    assert response.output_key_field == 'QutteraWebsiteMalwareScanning.start'
    assert response.outputs == mock_response