"""QutteraWebsiteMalwareScanner Integration for Cortex XSOAR (aka Demisto)
"""
import demistomock as demisto
from CommonServerPython import *


# Disable insecure warnings
urllib3.disable_warnings()

''' CONSTANTS '''
DATE_FORMAT = "%Y-%m-%dT%H:%M:%SZ"


class Client(BaseClient):
    """Client class for basic interaction with Quttera API.
    """
    def _api_request(self, domain: str, request_type: str) -> Dict:
        """Start domain scanning

        :type domain: ``str``
        :param domain: Domain to scan

        :return: dict containing response from start scanning
        :rtype: ``Dict``
        """

        return self._http_request(
            method=request_type,
            url_suffix='/url/scan/{}'.format(domain),
        )

def scan_start(client: Client, args: Dict[str, Any]) -> CommandResults:
    """
    quttera-scan-start command: initiates scan of the provided URL or domain.

    :type client: ``Client``
    :param Client: Qutter API client

    :type args: ``Dict[str, Any]``
    :param args: all command arguments from ``demisto.args()``

    :return: ``CommandResults`` object contain the start scan response
    :rtype: ``CommandResults``
    """
    domain = args.get('domain', None)
    if not domain:
        raise ValueError('domain is missing')

    start = client._api_request(domain=domain, request_type='POST')
    readable_output = f'Started scan of {domain}'
    if start.get('errorstr') is not 'success':
        readable_output = f'Failed to scan domain {domain}'

    return CommandResults(
        readable_output=readable_output,
        outputs_prefix='',
        outputs_key_field='QutteraWebsiteMalwareScanning.start',
        outputs=start
    )

def rescan_status(client: Client, args: Dict[str, Any]) -> CommandResults:
    """
    Retrieves scan status for previously submitted domain
    name or URL.

    """
    domain = args.get('domain', None)
    if not domain:
        raise ValueError('domain is missing')

    start = client._api_request(domain=domain, request_type='PUT')
    readable_output = f'Rescan of {domain}'
    if start.get('errorstr') is not 'success':
        readable_output = f'Failed to scan domain {domain}'

    return CommandResults(
        readable_output=readable_output,
        outputs_prefix='',
        outputs_key_field='QutteraWebsiteMalwareScanning.restart',
        outputs=start
    )

def scan_report(self):
    """
    Retrieves scan report for previously submitted domain
    or URL in context or as a File (default)

    """
    domain = args.get('domain', None)
    if not domain:
        raise ValueError('domain is missing')

    start = client._api_request(domain=domain, request_type='GET')
    readable_output = f'Rescan of {domain}'
    if start.get('errorstr') is not 'success':
        readable_output = f'Failed to get the report for domain {domain}'

    return CommandResults(
        readable_output=readable_output,
        outputs_prefix='',
        outputs_key_field='QutteraWebsiteMalwareScanning.report',
        outputs=start
    )

def report_malware(self):
    """
    Returns malware status for given domain

    """
    domain = args.get('domain', None)
    if not domain:
        raise ValueError('domain is missing')

    start = client._api_request(domain=domain, request_type='GET')
    readable_output = f'Rescan of {domain}'
    if start.get('errorstr') is not 'success':
        readable_output = f'Failed to get the report for domain {domain}'

    return CommandResults(
        readable_output=readable_output,
        outputs_prefix='',
        outputs_key_field='QutteraWebsiteMalwareScanning.report_malware',
        outputs=start
    )

def status_blacklist(self):
    """
    Returns url blacklisting information and reputation.

    """
    domain = args.get('domain', None)
    if not domain:
        raise ValueError('domain is missing')

    start = client._api_request(domain=domain, request_type='GET')
    readable_output = f'Rescan of {domain}'
    if start.get('errorstr') is not 'success':
        readable_output = f'Failed to get the report for domain {domain}'

    return CommandResults(
        readable_output=readable_output,
        outputs_prefix='',
        outputs_key_field='QutteraWebsiteMalwareScanning.status_blacklist',
        outputs=start
    )


''' MAIN FUNCTION '''
def main(params: dict, args: dict:, command: str):
    """main function, parses params and runs command functions
    """
    demisto.debug("Command called {command}")
    client = Client(params)
    if command == 'quttera-scan-start':
        results = scan_start(client, args)
    elif command == 'quttera-rescan-status':
        results = rescan_status(client, args)
    elif command == 'quttera-scan-report':
        results = scan_report(client, args)
    elif command == 'quttera-report-malware':
        results = report_malware(client, args)
    elif command == 'quttera-status-blacklist':
        results = status_blacklist(client, args)
    else:
        raise NotImplementedError(f'Command {command} not implemented')
    return_results(results)

if  __name__ in ('__main__', '__builtin__', 'builtins'):
    try:
        main(demisto.params(), demisto.args(), demisto.command())
    except Exception as exception:
        return_error(exception)
