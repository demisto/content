commonfields:
  id: FireEye iSIGHT
  version: -1
name: FireEye iSIGHT
display: FireEye iSIGHT
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAAyCAYAAACXpx/YAAAAAXNSR0IArs4c6QAADKFJREFUeAHtWntwVcUZ38c55948bgISiORFsAGBm4SHYBWnxQd1Oo5o61C1TuvoPzpKRQKooK2mUtRCgAAVWh06Ustoy3TG2s4UQQsDvlpAQpILoUASwqNAeCUhN/dxzm5/e/Hgzc29IcGBP+zuzM2es/vtt7u/77l7QoguGgGNgEZAI6AR0AhoBDQCGgGNgEZAI6AR0AhoBDQCGgGNgEZAI6AR0AhoBDQCGgGNgEZAI/BNRIBezqYkudVoKDg92jHEBOnQ6ymTQUHZtrLmuq1gKC+Hpx5zZRDol4B355cXmNx5SBJ6vySyzKTMUgzUzyEyFKZk3tjm+uWfFtycZlknrImNjW1XZtmaa18R6JOAPy8pycqIeCsYJU9YhObaMFJbQsRxs3BCYcxyj+W1b+aO4w1GvDMMn3zFHwhE4sj041VGwLjUfLuK/eOsCH3DonRSBELtIiI2RGkGhEog9JgFM1QOIUWhqHeo2WEfo145xe4kTSBbe6k5dP+VQwBySV3qikq/Z0n6gUHJpC4pCIUwvZQRCFsNCkHUTVEiPg9L+UGXoBukkJ9YMhLuMs8KWHc7E3ROYLA/M/UM/1c9tLKysle8k6EhpVRgxwBP1n+ptpQDdxeNuQMx9i8gyFZEym4htQYIbhMjcqvDWL3liRwdtW9fR+IknxYUpGXzAa9nEPZABxOPljXV/zmRxn0HP/7FMP+UNMkeF0QMxzzd1qReQINGcdxMM2eO2lfbtJkQI7uwdJzJ5POOKReMO7Bnl+IXKPBfIyhZZDA6NgpvE19iTCURnNFWPP++M8fzt4k7d0Zri4oGmsQ3XVL6mAo7qQrDCjglh2xClpYdqv/0qaeeLTAsOoMyPtWx0ZqiMK6CF/mXYPY7VPAykN2Efa6rrvr1h5SiJ0mBIhjnOoJ3Y8b7qBQfOg5pZCZ7GKTjBV5SFQbDQ+DcB0Gtrq5e/ImiS+qia4rG+A3K1nkIzYblYu9kAyT8WyfCPxp7orYz1QTx7ZgqhHcLhv8gdrEeoPbYzGbMv6fQf5eXsHeAQoMjyC7MpXTpYnEFjMFnBTMVT+KDvDMpGehQeguLkoEucUcwbGdmevajGzy6T6fesCbuSFpoULnScyo8HG3L9nT5ok6ac5wTE0rSfYzLV9VQaoQkdryTky8VmocBfjPWHVOueNr459hKuDwowuQk53Ib3ODtnPGXZs2dp6z5g3ha9aysHML9ASN8HhZcIwX9mFLhQSzcT+3U61NjhYqTghymlLWrd1Viin3h8cLf3bnlGczjbPExPrFTiK2w2oVlh+s3xtNc6llZcBbJrvZw9liXlEcjhpw8sTHQkjiuIed6XyTd+AhxPNzutN05+ciRrkSaZO87CDHTi8qmRKlYB619oKy5fksyumRtas5ourkAG78FBvsg9nYwGd2Vaps5c26p4bFeJELkwtv8srrqtX+6cyl3PGvOc9M45S9AlAFY4q+WLXut0e2/nLpHTGAe8YKHspLz0pnRNdgztb/CVYsoxA+Lz1T6ZsLSLMHGq/bEAiuKwmrWUGnM76twE3n09/38qX0hWOIXUCqLSTmov+O/Lv2KFVX1Ihp9BZH1LJP0+YqKZ77j8qyYO+/7nBrPAZP9ERl+7esKV/Ht5qJr8keNhA8fcV7KWya0BPaQQ+7U/avPRKOMWSRHHaQ4pTwqRTk4/DWRy3DSHCIt5Hdu+/6SEo/7nKwuOXAgAsvr1U/tuOEGM7utrYfiKn6toRDLMHJyHWnfK6Rstb1Wk2oHQ36gpMSAb++1DPN45JhAwMYaVBhRSRM/ffo073UQOsPhsMjLy3NAr8YRxMeap5+es5CZnpcoM1+YOXP2y5xb6QhP82HFR+xI9JXXVy79j8tXue1jQ4dyT3190n25dKpOnKubgIVFwzTIH5mAOFs3rHQydn5dWUv9H+MZ9OW508zxZFFSoNIB7B7hiymjTlqUuzWLy6cbQjwVisgCgA38ehYoy7G91437CWmsSSmHvfmjBtmnQr9xiHcSkiwrnhee7SxqRWxhD8CaDguDzZtwYFdrbVHZwL1SPEQi5Ol85AwAOen8sSQrSg7uHuZfQA4FNs+ePbvgXEdojuX13WXbdkrFZJwR08r85GxHaBl2td3d2fLlS7bPmjV3IWHsRW561iD/o0LQeuJEF65cuWSPS6fq9vbgjZmdzT+TVsbNQohuMouno5gr3UgPgH4x2jervm7EE5r2HlKN2MSTJqFVNhV2IM+/1X+sZ/xUdMlKJQTqIxSCkkUOghwyT4iMpiejvRBLSx9EXrUGeehGuK1/4JZM5Qo9Cq5D20OMnuvREdcgItyUhiy2JT0rKH3vKz4yDQKa7GFsYliI1abDV45pqT2ihspw0BSe9CGcyjQq5To0nY9jGfcokecYp5AxH1aNts29xBT5OArilEjeRkIMHUpSsCnBZRO3+fHE3urqqs9mzZq3GNl4JURxPhyNLlq5vKo2kQ5WnYV4nA+DO0AYErWYH0ikAsyOJA6jx6mgsTUqim4CVg21haO/a0i6wsGyLJx5Q4Z4Gc2PqL6+lLvJDZyx0E3IwjPDSKGVQX6ZUfcYnplzvRep6AwuyIaylsA9PQgup0GSKOL/9rGH6hfGD9+d+60hYcv7lmR06IijF4Sr+pGJQzBSOsiIDR9dhJu3M/Hjen2WMiKks2tF9aIFvdL13tlo285BINVJbN6UihSWG4TRbFyxdPHyVDTJ2r9S8ou9bKIHcVO51xAEZFL6cG2h/5GL3Zd6yPuvKQSZ5pJhAoQ72eq+x9fnLenhkgwSktXEt3+dZ0gLXlZFhu4leuIgrJotxdFmamBY+e1uL79wkQDrpLSzk1hue19qDIF2xC4ikuDYFw6xxSKESa5+jMGiUhe1L9WvfGKfSw+GaNiGo41KJGIFxyRqMLK8tqBsyqW4VmIBXjpwBOVkChKrGDnwg7ekKeMmiCCT/i06xriffyYSEsWQnVjV+4I4T+4uL89QLAzTi73KLoPQNJzHB/SVrRDASCJnYWxgRUVFyhjcV3690Qm4RPRjKjbgViR2vdEm9vVw0aWHA9tri0rXpFP2eBBCwlci+HGaxZl8t6bAf++4I4F/JzJx36cUF1uIAz+1CPepO2ulJCEiIoLw3i4DoJkxK3DZ9Ll2lTBhgGpO2lXWUtcWyPevloyspe3Oj0D31skjgfYhReU7cLv0KBK9qtriMW/i+NIOD9aNhwGnQG0S7PBF9n+7oeE0PGYr4QO2MSEWIJgtmVnxzPvwHWG8dx9nGMSm7AyJBpurq6tT5BDIEBhU74JNJGxHHTWdBpubDbDy6ePbQkfLZz97EPMow+heMBcygY50iza++uqrp1VnDwtWjUEr9CyseFPalx5DXeHh3Hitxcl7tUWjpyqaxFIJXtfa3hG49nr0QuyFn8QVDHKP+gyzs1tW6I7NQOaEVUYApbKufpUorpCw+JCq3YHqig3qHUaukfTuEMgLGiEHVTIHPH/8ReH4vNtUvhQmn+Pz2M/haQqZZOtx27UJer0x/iek2MgNscYb4pPUfKtWrTofFOH3pRBLoQvTkGn8HSvZhP0jWfzqh0RzIzD4NcTkd9cZX3Nu4K5Q4kqf4NtM8kvCqqqqk1jvaqznQ4SEJVCHDfFzuM+Q7kYgurqrS9zoztFN29xGVe8qHjfAFNE3kWhNj8CSlXIZytYkCQLTX5w8NHjFbWTLRSB35I3MsQzzXSjFHerDhCpplHcFqfPE2ObA2lhDwh9cUPPRhaXFUY/Zro4sCd29vgYGD86M+PKHsk5xzL0+3YwlZg8fne+RmWF/8/YeWavL8OOcHN9Ab24uyR583B/YcjFr3pGXl+7h1wyF2ieNxV5BIpGsnBPxY9QZ9dy5c1mMpQ0RwkniPi3i8UQ7z6alnXqjsjLorsGtMd46dSqYk5aGLK95Uuv69fer9CdpAa1x7GxXns9g6Y7jJJWdbYiQyMxsXVVZGdtXUiKX+2b858agota5OOo8b+L0oyxTDUDiBYVXHx3o/NEtdTsVfd2Q4bnSk77UZGQabop8sJJoyJF/MLLkk/qbsIvo1a97FbC7nNg3YUHnIx+6BxbtVXEZwoUflG1wS2ujjK4ub65rqISbvi9v5EjDssaCoq1rkPmR+mLj8tH11UegTwJ2l1VXUFrOGPkh4sCdCHxj8FluQDoiYQdxQpD5uzhdvd3mnPnsat0ru+vSdWoE+iXgeDb78f9ZjkFGOsQuFoRdx6icSh22CUnPn8Yerq2Pp9XPGgGNgEZAI6AR0AhoBDQCGgGNgEZAI6AR0AhoBDQCGgGNgEZAI6AR0Ah8cxH4H9aAFXVhrGASAAAAAElFTkSuQmCC
description: FireEye cyber threat intelligence
configuration:
- display: Public Key
  name: publicKey
  defaultvalue: ""
  type: 0
  required: true
- display: Private Key
  name: privateKey
  defaultvalue: ""
  type: 4
  required: true
- display: Version
  name: version
  defaultvalue: "2.5"
  type: 0
  required: true
- display: Trust any certificate (not secure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: >2

    var baseUrl = 'https://api.isightpartners.com'; // iSight base url

    var publicKey = params.publicKey;

    var privateKey = params.privateKey;

    var acceptVersion = params.version;

    var insecure = params.insecure;

    var proxy = params.proxy;


    var VENDOR_NAME = 'FireEye iSIGHT';


    // we use this to map record-type to dbot-score

    var intelligenceTypeToScore = {
        'overview': 1,
        'vulnerability': 2,
        'malware': 3,
        'threat': 3
    };


    // we use this to determine the order of reputation sevirity of the types

    var intelligenceTypeOrder = ['overview', 'vulnerability', 'malware', 'threat'];


    var epoch2DateStr = function(epochStr) {
        return new Date(parseInt(epochStr) * 1000).toString();
    }


    var createTableEntry = function (name, contents, table, context) {
        return {
            // type
            Type: entryTypes.note,
             // contents
            ContentsFormat: formats.json,
            Contents: contents,
            // human-readable
            ReadableContentsFormat: formats.markdown,
            HumanReadable: tableToMarkdown(name, table),
            // context
            EntryContext: context
        };
    }


    var getHeaders = function(query) {
        var timestamp = new Date().toUTCString();
        if (timestamp.indexOf('+') > 0) {
            timestamp = timestamp.substring(0,timestamp.indexOf('+'));
        } else if (timestamp.indexOf('-') > 0) {
            timestamp = timestamp.substring(0,timestamp.indexOf('-'));
        }
        message = query + acceptVersion + 'application/json' + timestamp;
        hashed = HMAC_SHA256_MAC(privateKey, message);

        return {
            'Accept': ['application/json'],
            'Accept-Version': [acceptVersion],
            'X-Auth': [publicKey],
            'X-Auth-Hash': [hashed],
            'Date': [timestamp]
        }
    }


    var sendRequest = function(query) {
        var headers = getHeaders(query);
        var requestUrl = baseUrl + query;

        var res = http(
            requestUrl,
            {
                Method: 'GET',
                Headers: headers,
                Body: ''
            },
            insecure,
            proxy
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nUrl: ' + requestUrl + '\nStatus code: ' + res.StatusCode + '.\nResult: ' + JSON.stringify(res);
        }

        if (res.StatusCode === 204) {
            return [];
        }

        var body = JSON.parse(res.Body);
        if (!body || !body.success) {
            throw 'Request Failed.\nResonse body: ' + body;
        }
        return body;
    };


    var basicSearch = function(key, value) {
        var basicSearchQuery = '/search/basic?' + key + '=' + encodeURIComponent(value);
        var res = sendRequest(basicSearchQuery);
        return res.message;
    }


    var createContextReportsAndScore = function(records) {
        var dbotScore = 0;
        var highetsRecordType = 'None';
        var reports = [];

        // 1. set dbotScore to to the highest record-type among all records
        // 2. create report context-object for each record
        records && records.forEach(function(record) {
           var recordType = record['intelligenceType'];
           var recordScore =  intelligenceTypeToScore[recordType] || 0;
           if (dbotScore < recordScore) {
               dbotScore = recordScore;
           }
           if(intelligenceTypeOrder.indexOf(highetsRecordType) < intelligenceTypeOrder.indexOf(recordType)) {
               highetsRecordType = recordType;
           }
           var reportUrl = record['reportLink'];
           reports.push({
               ID: record['reportId'],
               title: record['title'],
               publishDate: epoch2DateStr(record['publishDate']),
               intelligenceType: recordType
           });
        });

        return {
            dbotScore: dbotScore,
            reports: reports,
            highetsRecordType: highetsRecordType
        }
    }


    var basicSearchIP = function(ip) {
        var records = basicSearch('ip', ip);

        if (!records) {
            return {
                Type: entryTypes.note,
                Contents: "No items match your search",
                ContentsFormat: formats.text,
                EntryContext: {
                    DBotScore: {
                        Indicator: ip,
                        Type: 'IP',
                        Vendor: VENDOR_NAME,
                        Score: 0
                    }
                }
            };
        }

        var res = createContextReportsAndScore(records);
        var context = {
            DBotScore: {Indicator: ip, Type: 'IP', Vendor: VENDOR_NAME, Score: res.dbotScore},
            'Report(val.ID && val.ID == obj.ID)': res.reports,
            'IP.Address': ip
        };

        if (res.dbotScore > 2) {
            addMalicious(context, outputPaths.ip,{
                Address: ip,
                Malicious: {Vendor: VENDOR_NAME, Description: 'IP was identified as ' + res.highetsRecordType}
            });
        }

        return createTableEntry("Results:", records, records, context);
    }


    var basicSearchDomain = function(domain) {
        var records = basicSearch('domain', domain);

        if (!records) {
            return {
                Type: entryTypes.note,
                Contents: "No items match your search",
                ContentsFormat: formats.text,
                EntryContext: {
                    DBotScore: {
                        Indicator: domain,
                        Type: 'domain',
                        Vendor: VENDOR_NAME,
                        Score: 0
                    }
                }
            };
        }

        var res = createContextReportsAndScore(records);
        var context = {
            DBotScore: {Indicator: domain, Type: 'domain', Vendor: VENDOR_NAME, Score: res.dbotScore},
            'Report(val.ID && val.ID == obj.ID)': res.reports,
            'Domain.Name': domain
        };

        if (res.dbotScore > 2) {
            addMalicious(context, outputPaths.domain,{
                Name: domain,
                Malicious: {Vendor: VENDOR_NAME, Description: 'domain was identified as ' + res.highetsRecordType}
            });
        }

        return createTableEntry("Results:", records, records, context);
    }


    var basicSearchfile = function(key, value) {
        var records = basicSearch(key, value);

        if (!records) {
            return {
                Type: entryTypes.note,
                Contents: "No items match your search",
                ContentsFormat: formats.text,
                EntryContext: {
                    DBotScore: {
                        Indicator: value,
                        Type: 'file',
                        Vendor: VENDOR_NAME,
                        Score: 0
                    }
                }
            };
        }

        var res = createContextReportsAndScore(records);
        var context = {
            DBotScore: {Indicator: value, Type: 'file', Vendor: VENDOR_NAME, Score: res.dbotScore},
            'Report(val.ID && val.ID == obj.ID)': res.reports
        };

        if (res.dbotScore > 2) {
            var malicuousObj = {
                Malicious: {
                    Vendor: VENDOR_NAME,
                    Description: 'file was identified as ' + res.highetsRecordType
                }
            };
            malicuousObj[key.toUpperCase()] = value;
            addMalicious(context, outputPaths.file, malicuousObj);
        }

        return createTableEntry("Results:", records, records, context);
    }


    var getReport = function(reportID) {
        var reportQuery = '/report/'+ encodeURIComponent(reportID);

        var res = sendRequest(reportQuery);
        var report = res.message.report;

        var context = {
            'Report(val.ID && val.ID == obj.ID)' : {
                ID: report.reportId,
                title: report.title,
                intelligenceType: report.intelligenceType,
                audience: report.audience,
                publishDate: report.publishDate,
                ThreatScape: report.ThreatScape.product,
                operatingSystems: report.operatingSystems,
                riskRating: report.riskRating,
                version: report.version,
                tagSection: report.tagSection
            }
        }

        var table = [{
            ID: report.reportId,
            title: report.title,
            intelligenceType: report.intelligenceType,
            audience: report.audience.join(),
            publishDate: report.publishDate,
            ThreatScape: report.ThreatScape.product.join(),
            operatingSystems: report.operatingSystems,
            riskRating: report.riskRating,
            version: report.version
        }];

        return createTableEntry("Report - " + reportID, res, table, context);
    }


    var submitFile = function(entryID, description, type) {
        var query = '/submit/data';
        var requestUrl = baseUrl + query;
        var headers = getHeaders(query);
        var res = httpMultipart(
                requestUrl, // URL
                entryID, // Optional - FilePath / EntryID
                { // HTTP Request Headers
                    Method: 'POST',
                    Headers: headers
                },
                { // Multipart Contents
                    type: type,
                    description: description
                },
                insecure,
                proxy
            );

        var statusCode = res && res.StatusCode;

        switch (statusCode) {
            case 200:
                return "The file was submitted sucessfully";
            case 403:
                throw "\nGot 403 error\nQuery valid but the response was refused because the user has exceeded their daily quota of submission requests";
            default:
                throw '\nSubmit File Failed.\nUrl: ' + requestUrl + '\nStatus code: ' + statusCode + '.\nResult: ' + JSON.stringify(res, null, 2);
        }
    }


    switch (command) {
        case 'test-module':
            basicSearch('ip', '66.34.253.56');
            return 'ok';
        case 'ip':
            return basicSearchIP(args.ip);
        case 'domain':
            return basicSearchDomain(args.domain);
        case 'file':
            var hash = args.file;
            var hashLength = hash && hash.length
            if(hashLength === 32) {
                return basicSearchfile('md5', hash);
            } else if(hashLength === 40) {
                return basicSearchfile('sha1', hash);
            } else {
                throw 'file argument must be md5(32 charecters) or sha1(40 charecters) ';
            }
        case 'isight-get-report':
            return getReport(args.reportID);
        case 'isight-submit-file':
            return submitFile(args.entryID, args.description, args.type);
    }
  type: javascript
  commands:
  - name: ip
    arguments:
    - name: ip
      required: true
      default: true
      description: ip to search by
    outputs:
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    - contextPath: IP.Address
      description: The IP address
    - contextPath: Report.ID
      description: Report ID
    - contextPath: Report.title
      description: Report title
    - contextPath: Report.publishDate
      description: Report publish date
    - contextPath: Report.intelligenceType
      description: Report intelligence type (overview, vulnerability, malware, threat)
    description: basic search reports by ip
  - name: domain
    arguments:
    - name: domain
      required: true
      default: true
      description: domain to search by
    outputs:
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    - contextPath: Domain.Name
      description: The domain name.
    - contextPath: Report.ID
      description: Report ID
    - contextPath: Report.title
      description: Report title
    - contextPath: Report.publishDate
      description: Report publish date
    - contextPath: Report.intelligenceType
      description: Report intelligence type (overview, vulnerability, malware, threat)
    description: basic search reports by domain
  - name: file
    arguments:
    - name: file
      description: md5 or sha1 to search by
    outputs:
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
    - contextPath: Report.ID
      description: Report ID
    - contextPath: Report.title
      description: Report title
    - contextPath: Report.publishDate
      description: Report publish date
    - contextPath: Report.intelligenceType
      description: Report intelligence type (overview, vulnerability, malware, threat)
    description: basic search file report by md5/sha1. NOTE - specify only one of md5/sha1 arguments
  - name: isight-get-report
    arguments:
    - name: reportID
      required: true
      default: true
      description: Report ID to search by
    outputs:
    - contextPath: Report.ID
      description: Report ID
    - contextPath: Report.title
      description: Report title
    - contextPath: Report.publishDate
      description: Report publish date
    - contextPath: Report.intelligenceType
      description: Report intelligence type (overview, vulnerability, malware, threat)
    - contextPath: Report.audience
      description: Report audience
    - contextPath: Report.ThreatScape
      description: Report threat scape
    - contextPath: Report.operatingSystems
      description: Report operating systems
    - contextPath: Report.riskRating
      description: Report risk rating
    - contextPath: Report.version
      description: Report version
    - contextPath: Report.tagSection
      description: Report tag section
    description: Get specific report
  - name: isight-submit-file
    arguments:
    - name: entryID
      required: true
      default: true
      description: entry-id of the file to submit (e.g. 41@18)
    - name: description
      required: true
      description: file description
    - name: type
      description: "Type of the given file"
      required: true
      auto: PREDEFINED
      predefined:
      - malware
      - other
    description: Submission of malware and other files for community sharing
tests:
- No test
fromversion: 5.0.0
