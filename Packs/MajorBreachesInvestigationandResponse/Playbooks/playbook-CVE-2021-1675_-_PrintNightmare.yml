id: CVE-2021-1675 - PrintNightmare
version: -1
name: CVE-2021-1675 - PrintNightmare
description: |-
  CVE-2021-1675 is a vulnerability dubbed “PrintNightmare” which allows remote code execution on Windows Print Spooler. Microsoft patched the vulnerability in June but an exploit POC and complete technical analysis were made publicly available online.
  This playbook includes the following tasks:
  - Manual actions to mitigate the exploit
  - Search Vulnerable Devices using the CVE
  - Query SIEM, FW, XDR to detect malicious activity and compromised hosts

  [More details on the vulnerability](https://nvd.nist.gov/vuln/detail/CVE-2021-1675)
  ** Note: This is a beta playbook, which lets you implement and test pre-release software. Since the playbook is beta, it might contain bugs. Updates to the pack during the beta phase might include non-backward compatible features. We appreciate your feedback on the quality and usability of the pack to help us identify issues, fix them, and continually improve.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: f1cfc2ee-24a8-469d-842d-be83b7dc2ca1
    type: start
    task:
      id: f1cfc2ee-24a8-469d-842d-be83b7dc2ca1
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "4"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 440,
          "y": -50
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "1":
    id: "1"
    taskid: 612f38a3-e731-4ca6-849e-8ead91858932
    type: regular
    task:
      id: 612f38a3-e731-4ca6-849e-8ead91858932
      version: -1
      name: Install Microsoft spooler service patches
      description: |2+
         the patch is currently not effective against the vulnerability, it is still recommended to patch windows systems.
        The security patch can be found [here](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-1675)


      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -20,
          "y": 250
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "2":
    id: "2"
    taskid: a26d7d7c-a25e-414b-83c8-8c00b2087390
    type: regular
    task:
      id: a26d7d7c-a25e-414b-83c8-8c00b2087390
      version: -1
      name: Run vulnerability scan
      description: |+
        Run a vulnerability scan to find vulnerable devices. Either by running PowerShell script or initiate a new scan with vulnerability scanner tool.

      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 440,
          "y": 560
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "3":
    id: "3"
    taskid: 329a9d80-376b-49ac-8db6-53270ec7775e
    type: regular
    task:
      id: 329a9d80-376b-49ac-8db6-53270ec7775e
      version: -1
      name: Disable Print Spooler service
      description: |-
        Disable the Print Spooler service for unnecessary devices especially servers (like the Domain Controllers)
        [Example command to disable print spooler service](https://github.com/cube0x0/CVE-2021-1675) to disable the Print Spooler service:
        'Stop-Service Spooler
        REG ADD  "HKLM\SYSTEM\CurrentControlSet\Services\Spooler"  /v "Start " /t REG_DWORD /d "4" /f'
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 440,
          "y": 250
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "4":
    id: "4"
    taskid: ea215848-498b-407b-8194-2c681f03c6cc
    type: title
    task:
      id: ea215848-498b-407b-8194-2c681f03c6cc
      version: -1
      name: CVE Mitigations
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
      - "1"
      - "21"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 440,
          "y": 100
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "5":
    id: "5"
    taskid: 0cf3ee69-f657-46e3-8369-a1b0102de028
    type: title
    task:
      id: 0cf3ee69-f657-46e3-8369-a1b0102de028
      version: -1
      name: Search Vulnerable Devices
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "7"
      - "12"
      - "22"
      - "23"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 440,
          "y": 750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "6":
    id: "6"
    taskid: 0c90e265-d762-414e-8a33-d7eed8a9bd1d
    type: title
    task:
      id: 0c90e265-d762-414e-8a33-d7eed8a9bd1d
      version: -1
      name: Vulnerability Scan
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 440,
          "y": 420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "7":
    id: "7"
    taskid: 2a67bf0f-29f4-45ac-8634-8179c695e438
    type: playbook
    task:
      id: 2a67bf0f-29f4-45ac-8634-8179c695e438
      version: -1
      name: Search Endpoint by CVE - Generic
      playbookName: Search Endpoint by CVE - Generic
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      CVE_ID:
        complex:
          root: inputs.CVE
    separatecontext: false
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 860,
          "y": 890
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
  "9":
    id: "9"
    taskid: 21a9d6cc-f618-4656-85d9-a85ba15a4b76
    type: title
    task:
      id: 21a9d6cc-f618-4656-85d9-a85ba15a4b76
      version: -1
      name: Splunk
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "13"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 200,
          "y": 1070
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "10":
    id: "10"
    taskid: b0655aa0-9ac3-42eb-84e0-8ce440b9a142
    type: title
    task:
      id: b0655aa0-9ac3-42eb-84e0-8ce440b9a142
      version: -1
      name: Qradar
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "15"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -960,
          "y": 1070
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "11":
    id: "11"
    taskid: afeb0f51-42c5-4907-87bf-a8973e4ea518
    type: title
    task:
      id: afeb0f51-42c5-4907-87bf-a8973e4ea518
      version: -1
      name: 'Manually Hunt Windows Event Logs '
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "17"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -360,
          "y": 1070
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "12":
    id: "12"
    taskid: b9a94039-e18b-4460-8f6c-e594f7d22bc5
    type: condition
    task:
      id: b9a94039-e18b-4460-8f6c-e594f7d22bc5
      version: -1
      name: Is SIEM enabled?
      description: Returns 'yes' if integration brand is available. Otherwise returns
        'no'
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "11"
      Qradar:
      - "10"
      Splunk:
      - "9"
    separatecontext: false
    conditions:
    - label: Splunk
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: SplunkPy
                    ignorecase: true
                accessor: state
            iscontext: true
          right:
            value:
              simple: active
          ignorecase: true
    - label: Qradar
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: QRadar_v2
                    ignorecase: true
                accessor: state
            iscontext: true
          right:
            value:
              simple: active
          ignorecase: true
    view: |-
      {
        "position": {
          "x": -360,
          "y": 890
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "13":
    id: "13"
    taskid: ebb2609a-821c-4555-8ee8-3ee3b293fe04
    type: regular
    task:
      id: ebb2609a-821c-4555-8ee8-3ee3b293fe04
      version: -1
      name: Search for print spooler event ID 808
      description: Searches Splunk for events.
      script: '|||splunk-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      app: {}
      batch_limit: {}
      earliest_time: {}
      event_limit: {}
      latest_time: {}
      query:
        simple: index="*" sourcetype="WinEventLog" source="WinEventLog:Security" EventCode=
          808
      update_context: {}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 200,
          "y": 1220
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
  "14":
    id: "14"
    taskid: 70171c70-8d33-40d3-8cc7-45fe20616e58
    type: regular
    task:
      id: 70171c70-8d33-40d3-8cc7-45fe20616e58
      version: -1
      name: Search for print spooler event ID 31017
      description: Searches Splunk for events.
      script: '|||splunk-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      app: {}
      batch_limit: {}
      earliest_time: {}
      event_limit: {}
      latest_time: {}
      query:
        simple: index="*" sourcetype="WinEventLog" source="WinEventLog:Security" EventCode=
          31017
      update_context: {}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 200,
          "y": 1410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
  "15":
    id: "15"
    taskid: 25fb0abb-92e9-4187-8557-4b9715b855af
    type: playbook
    task:
      id: 25fb0abb-92e9-4187-8557-4b9715b855af
      version: -1
      name: QRadarFullSearch
      description: This playbook runs a QRadar query and return its results to the
        context.
      playbookName: QRadarFullSearch
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "16"
    scriptarguments:
      headers: {}
      interval:
        simple: "1"
      query_expression:
        simple: select * from events WHERE LogSourceTypeName(deviceType) = 'Microsoft
          Windows Security Event Log' and UTF8(payload) LIKE '%808%' Last 7 days
      range: {}
      timeout:
        simple: "600"
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -960,
          "y": 1210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
  "16":
    id: "16"
    taskid: ef1f9962-f372-458f-8d72-b1ade510bdc7
    type: playbook
    task:
      id: ef1f9962-f372-458f-8d72-b1ade510bdc7
      version: -1
      name: QRadarFullSearch
      description: This playbook runs a QRadar query and return its results to the
        context.
      playbookName: QRadarFullSearch
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      headers: {}
      interval:
        simple: "1"
      query_expression:
        simple: select * from events WHERE LogSourceTypeName(deviceType) = 'Microsoft
          Windows Security Event Log' and UTF8(payload) LIKE '%31017%' Last 7 days
      range: {}
      timeout:
        simple: "600"
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": -960,
          "y": 1410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
  "17":
    id: "17"
    taskid: 0a5e5ce9-05de-4aca-8543-6114a0fe0607
    type: regular
    task:
      id: 0a5e5ce9-05de-4aca-8543-6114a0fe0607
      version: -1
      name: Search for print spooler event IDs 808 and 31017
      description: Search for the windows event IDs 808 and 31017 to find indication
        of the exploit.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -360,
          "y": 1220
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "18":
    id: "18"
    taskid: 9a8c4457-da99-4503-8936-b02d8cc19dd8
    type: title
    task:
      id: 9a8c4457-da99-4503-8936-b02d8cc19dd8
      version: -1
      name: Investigate further
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 440,
          "y": 1590
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "19":
    id: "19"
    taskid: f4846682-387c-4e0d-8fe6-ceb61a37ba56
    type: regular
    task:
      id: f4846682-387c-4e0d-8fe6-ceb61a37ba56
      version: -1
      name: 'Investigate with all related security tools '
      description: Investigate further for indication of the exploit using the organization
        available tools.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "20"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 440,
          "y": 1710
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "20":
    id: "20"
    taskid: c0721a3f-91f6-4eba-8420-3f328f3c348f
    type: title
    task:
      id: c0721a3f-91f6-4eba-8420-3f328f3c348f
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 440,
          "y": 1850
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "21":
    id: "21"
    taskid: deb0a907-db54-4e80-86c4-f5e7f34b6973
    type: regular
    task:
      id: deb0a907-db54-4e80-86c4-f5e7f34b6973
      version: -1
      name: Restricting the ACLs
      description: |-
        The exploit dropping a DLL in a subdirectory. If restricting the ACLs on the directory (and subdirectories), the exploit will be prevented.
        Relevant directory: 'C:\Windows\System32\spool\drivers'

        example of PowerShell script:
        $Path = "C:\Windows\System32\spool\drivers"

        $Acl = Get-Acl $Path

        $Ar = New-Object  System.Security.AccessControl.FileSystemAccessRule("System", "Modify", "ContainerInherit, ObjectInherit", "None", "Deny")

        $Acl.AddAccessRule($Ar)

        Set-Acl $Path $Acl

        [Source](https://blog.truesec.com/2021/06/30/fix-for-printnightmare-cve-2021-1675-exploit-to-keep-your-print-servers-running-while-a-patch-is-not-available/)
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 940,
          "y": 250
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "22":
    id: "22"
    taskid: 7c357618-343d-441e-896b-7608f5856f48
    type: regular
    task:
      id: 7c357618-343d-441e-896b-7608f5856f48
      version: -1
      name: XDR XQL queries
      description: |-
        Run related advanced XQL queries in Cortex XDR to find any malicious related activity.
        [Cortex XDR Hunting Blog](https://www.paloaltonetworks.com/blog/security-operations/hunting-printnightmare/)
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1330,
          "y": 890
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "23":
    id: "23"
    taskid: a4b817b8-3041-4dfd-82c7-6c6cc70d34bd
    type: playbook
    task:
      id: a4b817b8-3041-4dfd-82c7-6c6cc70d34bd
      version: -1
      name: Panorama Query Logs
      playbookName: Panorama Query Logs
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      action: {}
      addr-dst: {}
      addr-src: {}
      filedigest: {}
      ip: {}
      log_type:
        simple: threat
      port-dst: {}
      query:
        simple: (threatid eq 91333) or (threatid eq 91323)
      rule: {}
      time-generated: {}
      url: {}
      zone-dst: {}
      zone-src: {}
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 1770,
          "y": 890
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
view: |-
  {
    "linkLabelsPosition": {},
    "paper": {
      "dimensions": {
        "height": 1965,
        "width": 3110,
        "x": -960,
        "y": -50
      }
    }
  }
inputs:
- key: CVE
  value:
    simple: CVE-2021-1675
  required: false
  description: ""
  playbookInputQuery:
outputs: []
tests:
- No tests (auto formatted)
fromversion: 5.5.0
