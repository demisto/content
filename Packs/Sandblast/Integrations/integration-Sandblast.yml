commonfields:
  id: Check Point Sandblast
  version: -1
name: Check Point Sandblast
display: Check Point Sandblast Cloud Services
category: Forensics & Malware Analysis
image: data:image/png;base64,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
description: Query, upload and download data using Check Point Sandblast on cloud.
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: https://te.checkpoint.com
  type: 0
  required: true
- display: Version
  name: version
  defaultvalue: v1
  type: 0
  required: true
- display: Use API Key
  name: useApiKey
  defaultvalue: "true"
  type: 8
  required: false
- display: API key
  name: token
  defaultvalue: ""
  type: 4
  required: false
- display: Trust any certificate (not secure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |-
    var server = params.server;
    var insecure = params.insecure;
    var proxy = params.proxy;
    var version = params.version;
    var requestTemplate = JSON.stringify({request:[{features:['te']}]});
    var base = server.replace(/[\/]+$/, '') +'/tecloud/api/' + version + '/file/';
    var useApiKey = params.useApiKey;
    if (useApiKey === undefined) {
      useApiKey = true;
    }

    var headers = {};
    if (useApiKey) {
        if (!params.token) {
            throw 'API Key not provided.';
        }
        headers = {'Authorization': [params.token]};
    }

    var urlDict = {
        'sb-query': 'query',
        'sb-upload': 'upload',
        'sb-download': 'download',
        'sb-quota': 'quota',
        'sandblast-query': 'query',
        'sandblast-upload': 'upload',
        'sandblast-download': 'download',
        'sandblast-quota': 'quota',
    };

    var contentTypeDict = {
        'sb-query': 'application/json',
        'sandblast-query': 'application/json',
    };

    var saveCookies = function(res, requestCookies) {
        if (requestCookies) {
            for (var i = 0; i < res.Cookies.length; i++) {
                if (res.Cookies[i].Domain === 'te.checkpoint.com') {
                    setIntegrationContext({cookies: [res.Cookies[i]]});
                }
            }
        }
    }

    var sendRequest = function(url, body, contentType, queryName, cookies, requestCookies) {
        if (contentType) {
            headers['Content-type'] = [contentType];
        }
        var res = http(
                base + url,
                {
                    Method: 'POST',
                    Body: body,
                    Headers: headers,
                    Cookies: cookies
                },
                insecure,
                proxy
            );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Failed to ' + queryName + ' , request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }
        saveCookies(res, requestCookies);
        return JSON.parse(res.Body);
    }

    var teArgs = {'images': 0, 'reports': 0, 'benign_reports': 1};

    var createRequest = function(args) {
        if (!args.features) {
            args.features = 'all';
        }
        if (args.features !== 'extraction' && args.features !== 'av') {
            var feature = {};
                var keys = Object.keys(teArgs);
                for (var i = 0; i < keys.length; i++) {
                    if (args[keys[i]]) {
                        if (teArgs[keys[i]] === 0) {
                            feature[keys[i]] = JSON.parse(args[keys[i]]);
                        } else if (teArgs[keys[i]] === 1) {
                            feature[keys[i]] = args[keys[i]] === 'true';
                        }
                        delete args[keys[i]];
                    }
                }
                if (Object.keys(feature).length) {
                    args['te'] = feature;
                }
        }
        if (args.features === 'all') {
            args.features = ['te', 'av', 'extraction'];
        } else {
            args.features = [args.features];
        }
        var request = {request: args};
        return JSON.stringify(request);
    }

    var contextData = getIntegrationContext();
    var cookies = contextData.cookies;
    var requestCookies = !cookies;
    for (var i = 0; !requestCookies && i < cookies.length; i++) {
        var currentTime = new Date();
        var date = new Date(cookies[i].Expires);
        var timeDiffernceInDays = (date.getTime() - currentTime.getTime()) / (1000 * 60 * 60 * 24)
        if (timeDiffernceInDays < 100) {
            requestCookies = true;
        }
    }

    var raw;
    switch (command) {
        case 'test-module':
            command = 'sb-query'
            if (sendRequest(
                urlDict[command],
                createRequest({md5: '36bd4be7042f6de7e332c05cef287d05'}),
                contentTypeDict[command],
                'test',
                cookies,
                requestCookies)) {
                return 'ok';
            }
            return 'not-cool';
        case 'sandblast-download':
        case 'sb-download':
            var res = http(
                base + urlDict[command] + encodeToURLQuery(args),
                {
                    Method: 'GET',
                    Headers: headers,
                    Cookies: cookies
                },
                insecure,
                proxy
            );
            if (res.StatusCode < 200 || res.StatusCode >= 300) {
                throw 'Failed to ' + urlDict[command] + ' , request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
            }
            // Extract file name from response
            var currentTime = new Date();
            var fileName = command + '_at_' + currentTime.getTime();
            if (res.Headers && res.Headers['Content-Disposition']) {
                var match = /filename=\"(.*)\"/.exec(res.Headers['Content-Disposition']);
                if (match && match[1]) {
                    fileName = match[1];
                }
            }
            saveCookies(res, requestCookies);
            raw = {Type: 3, FileID: saveFile(res.Bytes), File: fileName, Contents: fileName};
            break;
        case 'sandblast-upload':
        case 'sb-upload':
            var file_id = args['file_id'];
            delete args['file_id'];
            var res = httpMultipart(
                base + urlDict[command],
                file_id,
                {
                    Method: 'POST',
                    Headers: headers,
                    Cookies: cookies
                },
                {
                    'request': createRequest(args)
                },
                insecure,
                proxy
                );
            if (res.StatusCode < 200 || res.StatusCode >= 300) {
                throw 'Failed to sb-upload , request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
            }
            saveCookies(res, requestCookies);
            var contents = JSON.parse(res.Body);
            break;
        default:
            var contents = sendRequest(
                urlDict[command],
                command === 'sb-query' || command === 'sandblast-query'? createRequest(args) : requestTemplate,
                contentTypeDict[command],
                command,
                cookies,
                requestCookies);
            raw = {Type: entryTypes.note, ContentsFormat: formats.json, Contents: contents};
    }

    if (command === 'sandblast-upload' || command === 'sandblast-query' || command === 'sb-upload' || command === 'sb-query') {
        var dbot_con = [];
        var hashTypes = ['md5', 'sha1', 'sha256'];
        var ec = {};
        if (contents.response &&
            contents.response.av &&
            contents.response.av.malware_info &&
            contents.response.av.malware_info.malware_type) {
            var maliciousData = {
                Malicious: {
                    Vendor: 'Sandblast',
                    Description: 'Sandblast found this file malicious',
                    Confidence: contents.response.av.malware_info.confidence,
                    MalwareFamily: contents.response.av.malware_info.malware_family,
                    MalwareType: contents.response.av.malware_info.malware_type,
                    Severity: contents.response.av.malware_info.severity,
                    SignatureName: contents.response.av.malware_info.signature_name,
                }
            };
            for (var key in hashTypes) {
                if (contents.response[hashTypes[key]]) {
                    maliciousData[hashTypes[key].toUpperCase()] = contents.response[hashTypes[key]];
                    dbot_con.push({'Indicator': contents.response[hashTypes[key]], 'Type': 'hash', 'Vendor': 'SandBlast', 'Score': 3, 'SubType': 'av'});
                }
            }
            ec.DBotScore = dbot_con;
            addMalicious(ec, outputPaths.file, maliciousData);

        } else if (contents.response.te && contents.response.te.combined_verdict && contents.response.te.combined_verdict == "malicious") {
            var maliciousData = {
                Malicious: {
                    Vendor: 'Sandblast',
                    Description: 'Sandblast found this file malicious',
                    Confidence: contents.response.te.confidence,
                    Severity: contents.response.te.severity
                }
            };
            for (var key in hashTypes) {
                if (contents.response[hashTypes[key]]) {
                    maliciousData[hashTypes[key].toUpperCase()] = contents.response[hashTypes[key]];
                    dbot_con.push({'Indicator': contents.response[hashTypes[key]], 'Type': 'hash', 'Vendor': 'SandBlast', 'Score': 3, 'SubType': 'te'});
                }
            }
            ec.DBotScore = dbot_con;
            addMalicious(ec, outputPaths.file, maliciousData);

        } else {
            for (var key in hashTypes) {
                if (contents.response[hashTypes[key]]) {
                    var val = {};
                    val[hashTypes[key].toUpperCase()] = contents.response[hashTypes[key]];
                    ec['File(val.' + hashTypes[key].toUpperCase() + ' == obj.' + hashTypes[key].toUpperCase() + ')'] = val;
                    dbot_con.push({'Indicator': contents.response[hashTypes[key]], 'Type': 'hash', 'Vendor': 'SandBlast', 'Score': 3, 'SubType': '--'});
                }
            }
            ec.DBotScore = dbot_con;
        }


        var prefix = command === 'sandblast-upload' ? 'Upload' : 'Query';
        HumanReadable = tableToMarkdown(
            prefix + ' status for file ' +
            contents.response.file_name + (contents.response.file_type ? (' file type ' + contents.response.file_type) : '') +
            ', md5 ' + contents.response.md5,
            contents.response.status
        ) + '\n' +
        tableToMarkdown(
            prefix + ' av for file ' +
            contents.response.file_name + (contents.response.file_type ? (' file type ' + contents.response.file_type) : '') +
            ', md5 ' + contents.response.md5,
            contents.response.av)+ '\n' +
        tableToMarkdown(
            prefix + ' extraction for file ' +
            contents.response.file_name + (contents.response.file_type ? (' file type ' + contents.response.file_type) : '') +
            ', md5 ' + contents.response.md5,
            contents.response.extraction)+ '\n' +
        tableToMarkdown(prefix + ' TE for file ' +
            contents.response.file_name + (contents.response.file_type ? (' file type ' + contents.response.file_type) : '') +
            ', md5 ' + contents.response.md5,
            contents.response.te);
    } else if (command === 'sandblast-quota' || command === 'sb-quota') {
        ReadableContentsFormat = formats.markdown;
        HumanReadable = tableToMarkdown('Sandblast Quota Status', contents.response);
    }

    return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: contents,
            EntryContext: ec,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: HumanReadable
        };

  type: javascript
  commands:
  - name: sb-query
    deprecated: true
    arguments:
    - name: md5
      description: The md5 to query
    - name: sha1
      description: The sha1 to query
    - name: sha256
      description: The sha256 to query
    - name: file_type
      description: File extension (although the service identifies the type)
    - name: features
      auto: PREDEFINED
      predefined:
      - te
      - av
      - extraction
      - all
      description: Available features - default is te and av
    - name: images
      description: Array of objects with id and revision of available OS images
    - name: reports
      description: Array of supported report formats of - pdf | xml | tar
    - name: benign_reports
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: By default, reports are returned only for malicious files - you
        can mark this as true and get benign reports
    - name: quota
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: If true, response delivers the quota data (for cloud services only)
    - name: file_name
      description: File name - service calculates the file name from the part name
    description: Use the Query API to have a client application look for either the
      analysis report of a specific file on the Check Point Threat Prevention service
      databases or the status of a file, uploaded for analysis
  - name: sandblast-query
    arguments:
    - name: md5
      description: The md5 to query
    - name: sha1
      description: The sha1 to query
    - name: sha256
      description: The sha256 to query
    - name: file_type
      description: File extension (although the service identifies the type)
    - name: features
      auto: PREDEFINED
      predefined:
      - te
      - av
      - extraction
      - all
      description: Available features - default is te and av
    - name: images
      description: Array of objects with id and revision of available OS images
    - name: reports
      description: Array of supported report formats of - pdf | xml | tar
    - name: benign_reports
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: By default, reports are returned only for malicious files - you
        can mark this as true and get benign reports
    - name: quota
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: If true, response delivers the quota data (for cloud services only)
    - name: file_name
      description: File name - service calculates the file name from the part name
    outputs:
    - contextPath: File.Malicious.Vendor
      description: The vendor which found the file as malicious
    - contextPath: File.Malicious.Description
      description: A description of the file as malicious
    - contextPath: File.Malicious.Confidence
      description: Level of confidence that the file is malicious
    - contextPath: File.Malicious.MalwareFamily
      description: The family of malware this file belong to
    - contextPath: File.Malicious.MalwareType
      description: The type of this malware
    - contextPath: File.Malicious.Severity
      description: The severity of this malware
    - contextPath: File.Malicious.SignatureName
      description: The file signature name
    - contextPath: File.MD5
      description: The file md5
    - contextPath: File.SHA1
      description: The file sha1
    - contextPath: File.SHA256
      description: The file sha256
    description: Use the Query API to have a client application look for either the
      analysis report of a specific file on the Check Point Threat Prevention service
      databases or the status of a file, uploaded for analysis
  - name: sb-upload
    deprecated: true
    arguments:
    - name: file_name
      required: true
      default: true
      description: File name - service calculates the file name from the part name
    - name: md5
      description: The md5 to upload
    - name: sha1
      description: The sha1 to upload
    - name: sha256
      description: The sha256 to upload
    - name: file_type
      description: File extension (although the service identifies the type)
    - name: features
      auto: PREDEFINED
      predefined:
      - te
      - av
      - extraction
      - all
      description: Available features - default is te and av
    - name: images
      description: Array of objects with id and revision of available OS images
    - name: reports
      description: Array of supported report formats of - pdf | xml | tar
    - name: benign_reports
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: By default, reports are returned only for malicious files - you
        can mark this as true and get benign reports
    - name: file_id
      required: true
      description: The file id
    description: Use the Upload API to have a client application request that Check
      Point Threat Prevention modules scan and analyze a file. When you upload a file
      to the service, the file is encrypted. It is un-encrypted during analysis, and
      then deleted
  - name: sandblast-upload
    arguments:
    - name: file_name
      required: true
      default: true
      description: File name - service calculates the file name from the part name
    - name: md5
      description: The md5 to upload
    - name: sha1
      description: The sha1 to upload
    - name: sha256
      description: The sha256 to upload
    - name: file_type
      description: File extension (although the service identifies the type)
    - name: features
      auto: PREDEFINED
      predefined:
      - te
      - av
      - extraction
      - all
      description: Available features - default is te and av
    - name: images
      description: Array of objects with id and revision of available OS images
    - name: reports
      description: Array of supported report formats of - pdf | xml | tar
    - name: benign_reports
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      description: By default, reports are returned only for malicious files - you
        can mark this as true and get benign reports
    - name: file_id
      required: true
      description: The file id
    outputs:
    - contextPath: File.Malicious.Vendor
      description: The vendor which found the file as malicious
    - contextPath: File.Malicious.Description
      description: A description of the file as malicious
    - contextPath: File.Malicious.Confidence
      description: Level of confidence that the file is malicious
    - contextPath: File.Malicious.MalwareFamily
      description: The family of malware this file belong to
    - contextPath: File.Malicious.MalwareType
      description: The type of this malware
    - contextPath: File.Malicious.Severity
      description: The severity of this malware
    - contextPath: File.Malicious.SignatureName
      description: The file signature name
    - contextPath: File.MD5
      description: The file md5
    - contextPath: File.SHA1
      description: The file sha1
    - contextPath: File.SHA256
      description: The file sha256
    description: Use the Upload API to have a client application request that Check
      Point Threat Prevention modules scan and analyze a file. When you upload a file
      to the service, the file is encrypted. It is un-encrypted during analysis, and
      then deleted
  - name: sb-download
    deprecated: true
    arguments:
    - name: id
      required: true
      default: true
      description: File id to download
    description: 'Use the Download API to have a client application download files
      generated by the Check Point Threat Prevention service: analysis reports, Threat
      Emulation sandbox outputs, and more. The request must have the ID of the file
      to download'
  - name: sandblast-download
    arguments:
    - name: id
      required: true
      default: true
      description: File id to download
    outputs:
    - contextPath: File.MD5
      description: The file md5
    - contextPath: File.SHA1
      description: The file sha1
    - contextPath: File.SHA256
      description: The file sha256
    - contextPath: File.Name
      description: The file name
    description: 'Use the Download API to have a client application download files
      generated by the Check Point Threat Prevention service: analysis reports, Threat
      Emulation sandbox outputs, and more. The request must have the ID of the file
      to download'
  - name: sb-quota
    deprecated: true
    arguments: []
    description: Use the Quote API to have a client application get the current license
      and quota status of the API Key that you use
  - name: sandblast-quota
    arguments: []
    description: Use the Quote API to have a client application get the current license
      and quota status of the API Key that you use
hidden: false
fromversion: 3.5.0
tests:
  - Sandblast_malicious_test
