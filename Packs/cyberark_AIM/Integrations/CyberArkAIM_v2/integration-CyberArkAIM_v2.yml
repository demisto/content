category: Authentication & Identity Management
commonfields:
  id: CyberArkAIM v2 - test-cyberark_AIM-previous-docker
  version: -1
configuration:
- defaultvalue: https://example.net:1234
  display: Server URL and Port (e.g., https://example.net:1234)
  name: url
  required: true
  type: 0
- display: AppID as configured in AIM
  name: app_id
  type: 0
  required: false
- display: Folder to search in safe
  name: folder
  required: true
  type: 0
- display: Safe to search in
  name: safe
  required: true
  type: 0
- display: A comma-separated list of credential names in the safe.
  additionalinfo: Partial names are not supported. If left empty, no credentials will be fetched.
  name: credential_names
  type: 12
  required: false
- display: Username
  name: credentials
  type: 9
  required: false
- additionalinfo: Add a certificate file in text format to use to connect to the CyberArk AIM server.
  display: Certificate File as Text
  name: cert_text
  type: 12
  required: false
- additionalinfo: Add a key file in text format to use to connect to the CyberArk AIM server.
  display: Key File as Text
  name: key_text
  type: 4
  hidden: true
  required: false
- name: key_text_creds
  type: 9
  displaypassword: Key File as Text
  hiddenusername: true
  required: false
- display: Fetch credentials
  name: isFetchCredentials
  type: 8
  defaultvalue: 'true'
  required: false
- display: Trust any certificate (not secure)
  name: insecure
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  type: 8
  required: false
description: The CyberArk Application Identity Manager (AIM) provides a secure safe in which to store your account credentials. Use this integration to retrieve the account credentials in CyberArk AIM.
display: CyberArk AIM v2 - test-cyberark_AIM-previous-docker
name: CyberArkAIM v2 - test-cyberark_AIM-previous-docker
script:
  commands:
  - description: Lists all available credentials according to the list of credential names configured.
    name: cyberark-aim-list-credentials
    outputs:
    - contextPath: CyberArkAIM.AccountType
      description: The type of the account.
      type: String
    - contextPath: CyberArkAIM.Address
      description: The address of the account.
      type: String
    - contextPath: CyberArkAIM.CPMStatus
      description: The CPM status of the account.
      type: String
    - contextPath: CyberArkAIM.Domain
      description: The domain of the account.
      type: String
    - contextPath: CyberArkAIM.Name
      description: The credential name of the account.
      type: String
  dockerimage: demisto/ntlm:1.0.0.48903*
  runonce: false
  script: >
    register_module_line('CyberArkAIM v2', 'start', __line__())

    ### pack version: 1.0.13



    from requests_ntlm import HttpNtlmAuth

    import tempfile




    # disable insecure warnings

    import urllib3

    urllib3.disable_warnings()



    class Client(BaseClient):
        def __init__(self, server_url: str, use_ssl: bool, proxy: bool, app_id: str, folder: str, safe: str,
                     credentials_object: str, username: str, password: str, cert_text: str, key_text: str):
            super().__init__(base_url=server_url, verify=use_ssl, proxy=proxy)
            self._app_id = app_id
            self._folder = folder
            self._safe = safe
            self._credentials_list = argToList(credentials_object)
            self._username = username
            self._password = password
            self._cert_text = cert_text
            self._key_text = key_text
            self.auth = self.create_windows_authentication_param()
            self.crt, self.cf, self.kf = self.create_crt_param()

        def create_windows_authentication_param(self):
            auth = None
            if self._username:
                # if username and password were added - use ntlm authentication
                auth = HttpNtlmAuth(self._username, self._password)
            return auth

        def create_crt_param(self):
            if not self._cert_text and not self._key_text:
                return None, None, None
            elif not self._cert_text or not self._key_text:
                raise Exception('You can not configure either certificate text or key, both are required.')
            elif self._cert_text and self._key_text:
                cert_text_list = self._cert_text.split('-----')
                # replace spaces with newline characters
                cert_text_fixed = '-----'.join(
                    cert_text_list[:2] + [cert_text_list[2].replace(' ', '\n')] + cert_text_list[3:])
                cf = tempfile.NamedTemporaryFile(delete=False)
                cf.write(cert_text_fixed.encode())
                cf.flush()

                key_text_list = self._key_text.split('-----')
                # replace spaces with newline characters
                key_text_fixed = '-----'.join(
                    key_text_list[:2] + [key_text_list[2].replace(' ', '\n')] + key_text_list[3:])
                kf = tempfile.NamedTemporaryFile(delete=False)
                kf.write(key_text_fixed.encode())
                kf.flush()
                return (cf.name, kf.name), cf, kf
            return None

        def get_credentials(self, creds_object: str):
            url_suffix = '/AIMWebService/api/Accounts'
            params = {
                "AppID": self._app_id,
                "Safe": self._safe,
                "Folder": self._folder,
                "Object": creds_object,
            }

            return self._http_request("GET", url_suffix, params=params, auth=self.auth, cert=self.crt)

        def list_credentials(self):
            credential_result = [self.get_credentials(credentials) for credentials in self._credentials_list]
            return credential_result


    def list_credentials_command(client):
        """Lists all credentials available.
        :param client: the client object with the given params
        :return: the credentials info without the explicit password
        """
        creds_list = client.list_credentials()
        for cred in creds_list:
            # the password value in the json appears under the key "Content"
            if "Content" in cred:
                del cred["Content"]
        # notice that the raw_response doesn't contain the password either
        results = CommandResults(
            outputs=creds_list,
            raw_response=creds_list,
            outputs_prefix='CyberArkAIM',
            outputs_key_field='Name',
        )
        return results


    def fetch_credentials(client, args: dict):
        """Fetches the available credentials.
        :param client: the client object with the given params
        :param args: demisto args dict
        :return: a credentials object
        """
        creds_name = args.get('identifier')
        demisto.debug('name of cred used: ', creds_name)

        if creds_name:
            try:
                creds_list = [client.get_credentials(creds_name)]
            except Exception as e:
                demisto.debug(f"Could not fetch credentials: {creds_name}. Error: {e}")
                creds_list = []
        else:
            creds_list = client.list_credentials()
        credentials = []
        for cred in creds_list:
            credentials.append({
                "user": cred.get("UserName"),
                "password": cred.get("Content"),
                "name": cred.get("Name"),
            })
        demisto.credentials(credentials)


    def test_module(client: Client) -> str:
        """Performing a request to the AIM server with the given params
        :param client: the client object with the given params
        :return: ok if the request succeeded
        """
        if client._credentials_list:
            client.list_credentials()
        else:
            try:
                # Running a dummy credential just to check connection itself.
                client.get_credentials("test_cred")
            except DemistoException as e:
                if 'Error in API call [500]' in e.message or 'Error in API call [404]' in e.message:
                    return 'ok'
                else:
                    raise e
        return "ok"


    def main():
        params = demisto.params()

        url = params.get('url')
        use_ssl = not params.get('insecure', False)
        proxy = params.get('proxy', False)

        app_id = params.get('app_id') or ""
        folder = params.get('folder')
        safe = params.get('safe')
        credentials_object = params.get('credential_names') or ""

        cert_text = params.get('cert_text') or ""
        key_text = (
            params.get('key_text_creds', {}).get('password')
            or params.get('key_text', ''))

        username = ""
        password = ""
        if params.get('credentials'):
            # credentials are not mandatory in this integration
            username = params.get('credentials').get('identifier')
            password = params.get('credentials').get('password')

        try:
            client = Client(server_url=url, use_ssl=use_ssl, proxy=proxy, app_id=app_id, folder=folder, safe=safe,
                            credentials_object=credentials_object, username=username, password=password,
                            cert_text=cert_text, key_text=key_text)

            command = demisto.command()
            demisto.debug(f'Command being called in CyberArk AIM is: {command}')

            if command == 'test-module':
                return_results(test_module(client))
            elif command == 'cyberark-aim-list-credentials':
                return_results(list_credentials_command(client))
            elif command == 'fetch-credentials':
                fetch_credentials(client, demisto.args())

            else:
                raise NotImplementedError(f'{command} is not an existing CyberArk AIM command')
        except Exception as err:
            return_error(f'Unexpected error: {str(err)}', error=traceback.format_exc())
        finally:
            try:
                if client.crt:
                    cf_name, kf_name = client.crt
                    if client.cf:
                        client.cf.close()
                        os.remove(cf_name)
                    if client.cf:
                        client.kf.close()
                        os.remove(kf_name)
            except Exception as err:
                return_error(f"CyberArk AIM error: {str(err)}")


    if __name__ in ['__main__', 'builtin', 'builtins']:
        main()

    register_module_line('CyberArkAIM v2', 'end', __line__())
  subtype: python3
  type: python
tests:
- No tests
fromversion: 5.0.0
image: data:image/png;base64,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
detaileddescription: "## CyberArk AIM\nThe CyberArk Application Identity Manager (AIM) for credential management.\nUse it to store your passwords and other sensitive information and use them for authentication.\n\nPlease notice that currently the **username** and **password** in the integration are optional and used in\n order to perform windows authentication.\n \n\n---\n[View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/cyber-ark-aim-v2)"
