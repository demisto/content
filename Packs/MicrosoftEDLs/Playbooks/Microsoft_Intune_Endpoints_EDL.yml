id: Microsoft Intune Endpoints EDL
version: -1
name: Microsoft Intune Endpoints EDL
description: This playbook is triggered by scheduling a job or manually creating an
  incident of type  "EDL Microsoft Intune".  It scrapes Microsoft Intune website for
  endpoints information, compares the current list of  endpoint entries with the new
  one and, if there are any relevant changes, assigns the incident to an analyst in
  order to decide whether or not to update the internal list and the enabled integrations
  EDL entries.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 6383f335-e064-4781-88db-03fa76b440c6
    type: start
    task:
      id: 6383f335-e064-4781-88db-03fa76b440c6
      version: -1
      name: ""
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 592.5,
          "y": 0
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "2":
    id: "2"
    taskid: 61b67410-74f4-4576-8fad-40303efc05ac
    type: regular
    task:
      id: 61b67410-74f4-4576-8fad-40303efc05ac
      version: -1
      name: Assign Analyst
      description: |-
        Assign analyst to incident.
        By default,  the analyst is picked randomly from the available users, according to the provided roles (if no roles provided, will fetch all users).
        Otherwise, the analyst will be picked according to the 'assignBy' arguments.
        machine-learning: DBot will calculated and decide who is the best analyst for the job.
        top-user: The user that is most commonly owns this type of incident
        less-busy-user: The less busy analyst will be picked to be the incident owner.
        online: The analyst is picked randomly from all online analysts, according to the provided roles (if no roles provided, will fetch all users).
        current: The user that executed the command
      scriptName: AssignAnalystToIncident
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      assignBy:
        simple: machine-learning
      email: {}
      roles: {}
      username: {}
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 480,
          "y": 895
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "3":
    id: "3"
    taskid: e4b4ad3f-2232-4cc8-8124-e3ffbdb8c250
    type: condition
    task:
      id: e4b4ad3f-2232-4cc8-8124-e3ffbdb8c250
      version: -1
      name: Analyst Aproval Needed
      description: Analyst to review the Incident Info details and take a decision.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      "Yes":
      - "4"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 480,
          "y": 1070
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "4":
    id: "4"
    taskid: 04f54956-53d7-47c5-8ee5-e18f5a97c4a4
    type: title
    task:
      id: 04f54956-53d7-47c5-8ee5-e18f5a97c4a4
      version: -1
      name: Update EDL's
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "23"
      - "29"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1270,
          "y": 1290
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "5":
    id: "5"
    taskid: e3d92e13-db91-4cd8-84a5-1d9287d1f81a
    type: regular
    task:
      id: e3d92e13-db91-4cd8-84a5-1d9287d1f81a
      version: -1
      name: Review Microsoft Intune Website and Scraping Script
      description: |-
        Please check if there have been changes to the Microsoft Intune site that break the scraping script.

        Microsoft Inute Site:
        https://docs.microsoft.com/en-us/intune/fundamentals/intune-endpoints

        Scraping Script:
        GetMSFTIntuneEndpointsList
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "7"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 480,
          "y": 1355
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "7":
    id: "7"
    taskid: 4d1ac59d-b179-4914-869f-4503873c4a27
    type: regular
    task:
      id: 4d1ac59d-b179-4914-869f-4503873c4a27
      version: -1
      name: Close Task
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      action: {}
      alertcategory: {}
      alertdescription: {}
      alertdescriptionextended: {}
      alertseverity: {}
      alerttype: {}
      assetid: {}
      attacktype: {}
      autofocustaggroups: {}
      closeNotes: {}
      closeReason: {}
      containerid: {}
      containername: {}
      containerscanresults: {}
      emailclassification: {}
      hostname: {}
      id:
        complex:
          root: incident
          accessor: id
      imageid: {}
      imagename: {}
      phishingsubtype: {}
      process: {}
      processid: {}
      relatedalerts: {}
      rulename: {}
      twistlockindicator: {}
      username: {}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 695,
          "y": 2230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "8":
    id: "8"
    taskid: 5092b425-05b1-41e5-805c-f5b8263bb0fe
    type: regular
    task:
      id: 5092b425-05b1-41e5-805c-f5b8263bb0fe
      version: -1
      name: Add indicatores to MineMeld
      description: Add indicator to a miner.
      script: Palo Alto Minemeld|||minemeld-add-to-miner
      type: regular
      iscommand: true
      brand: Palo Alto Minemeld
    nexttasks:
      '#none#':
      - "7"
    scriptarguments:
      comment:
        simple: MSFT-Domain
      indicator:
        complex:
          root: MSFT
          accessor: MSFTDomains
      miner:
        complex:
          root: inputs.Miner
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1020,
          "y": 1645
        }
      }
    note: true
    timertriggers: []
    ignoreworker: false
  "13":
    id: "13"
    taskid: 35fd7d2e-5b87-4f10-8617-0bdba8dd5252
    type: regular
    task:
      id: 35fd7d2e-5b87-4f10-8617-0bdba8dd5252
      version: -1
      name: Update list file on EDL Web Server
      description: Updates a remote file with the contents of an internal list.
      script: palo_alto_networks_pan_os_edl_management|||pan-os-edl-update-external-file
      type: regular
      iscommand: true
      brand: palo_alto_networks_pan_os_edl_management
    nexttasks:
      '#none#':
      - "7"
    scriptarguments:
      file_path:
        complex:
          root: inputs.EDL-Filename
      list_name:
        simple: msft-intune
      verbose: {}
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1500,
          "y": 2020
        }
      }
    note: true
    timertriggers: []
    ignoreworker: false
  "16":
    id: "16"
    taskid: 935cb839-25cb-4e34-883b-98e1c9132c32
    type: regular
    task:
      id: 935cb839-25cb-4e34-883b-98e1c9132c32
      version: -1
      name: Update Demisto Internal List
      description: commands.local.cmd.list.set
      script: Builtin|||setList
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "27"
    scriptarguments:
      listData:
        complex:
          root: MSFT
          accessor: MSFTDomains
          transformers:
          - operator: join
            args:
              separator:
                value:
                  simple: ', '
          - operator: Stringify
      listName:
        simple: msft-intune
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1500,
          "y": 1630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "21":
    id: "21"
    taskid: c69e97b6-1a40-4c77-8f2a-7c5009fa7599
    type: title
    task:
      id: c69e97b6-1a40-4c77-8f2a-7c5009fa7599
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 695,
          "y": 2410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "22":
    id: "22"
    taskid: a541969f-3ac4-4e84-8a85-efe56ffd2689
    type: condition
    task:
      id: a541969f-3ac4-4e84-8a85-efe56ffd2689
      version: -1
      name: Is there an MSFT Intune Internal List?
      description: Check if list exist in demisto lists.
      scriptName: IsListExist
      type: condition
      iscommand: false
      brand: Builtin
    nexttasks:
      '#default#':
      - "24"
      "yes":
      - "28"
    scriptarguments:
      listName:
        simple: msft-intune
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 592.5,
          "y": 140
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: Current EDL Entries
      output:
        complex:
          root: lists
          accessor: msft-intune
  "23":
    id: "23"
    taskid: 4399e328-6664-4cd2-89d0-bd8c11845876
    type: condition
    task:
      id: 4399e328-6664-4cd2-89d0-bd8c11845876
      version: -1
      name: Is MineMeld Integration enabled?
      description: Check if MineMeld integration is enabled before running the branch.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "yes":
      - "8"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: containsString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: Palo Alto Minemeld
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
                accessor: brand
            iscontext: true
    view: |-
      {
        "position": {
          "x": 1020,
          "y": 1450
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "24":
    id: "24"
    taskid: d86acca7-098f-4cc6-854e-23a62a53658b
    type: regular
    task:
      id: d86acca7-098f-4cc6-854e-23a62a53658b
      version: -1
      name: Create MSFT Intune Internal List
      description: commands.local.cmd.list.create
      script: Builtin|||createList
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "28"
    scriptarguments:
      listData:
        simple: microsoft.com
      listName:
        simple: msft-intune
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 820,
          "y": 350
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "26":
    id: "26"
    taskid: 0ca759d5-b5ea-4c7b-82f6-c93167071b69
    type: condition
    task:
      id: 0ca759d5-b5ea-4c7b-82f6-c93167071b69
      version: -1
      name: Any difference between current EDL and Microsoft Intune site?
      description: Checks if there are any differences between current EDL and scraped
        one.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "7"
      "yes":
      - "2"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: notIn
          left:
            value:
              complex:
                root: MSFT
                accessor: MSFTDomains
            iscontext: true
          right:
            value:
              complex:
                root: lists
                accessor: msft-intune
                transformers:
                - operator: split
                  args:
                    delimiter:
                      value:
                        simple: ', '
            iscontext: true
    view: |-
      {
        "position": {
          "x": 592.5,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "27":
    id: "27"
    taskid: a54bbf40-df36-4b24-8660-07322fe6869a
    type: condition
    task:
      id: a54bbf40-df36-4b24-8660-07322fe6869a
      version: -1
      name: Confirm the list is not empty
      description: Check if list is empty before proceeding to update the EDL file.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "yes":
      - "13"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: lists
                accessor: msft-intune
            iscontext: true
    view: |-
      {
        "position": {
          "x": 1500,
          "y": 1815
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "28":
    id: "28"
    taskid: 12aacb86-4313-4478-8b66-b8a419faff28
    type: regular
    task:
      id: 12aacb86-4313-4478-8b66-b8a419faff28
      version: -1
      name: Scrape and parse entries from Microsoft Intune website
      description: |-
        This script scrapes Microsoft Intune endpoints website, compares the list of entries with the current list and provides the results of the analysis to the analyst.

        The result of the scrape will clearly indicate when there have been relevant changes to the website. In such case, the analyst will need to review the script and/or open a ticket with Demisto Support notifying the issue.
      scriptName: GetMSFTIntuneEndpointsList
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "26"
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 592.5,
          "y": 535
        }
      }
    note: true
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: Scraped Entries
      output:
        complex:
          root: MSFT
          accessor: MSFTDomains
          transformers:
          - operator: join
            args:
              separator:
                value:
                  simple: ', '
    - incidentfield: Total Current EDL
      output:
        complex:
          root: MSFT
          accessor: TotalCurrent
    - incidentfield: Total Scraped
      output:
        complex:
          root: MSFT
          accessor: TotalNum
    - incidentfield: EDL Delta Entries
      output:
        complex:
          root: MSFT
          accessor: DiffEntries
          transformers:
          - operator: join
            args:
              separator:
                value:
                  simple: ', '
  "29":
    id: "29"
    taskid: 25e03f49-2a05-49fe-88dc-574a8bc85290
    type: condition
    task:
      id: 25e03f49-2a05-49fe-88dc-574a8bc85290
      version: -1
      name: Is EDL Management integration enabled?
      description: Check if EDL Management integration is enabled before running the
        branch.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "7"
      "yes":
      - "16"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: containsString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: palo_alto_networks_pan_os_edl_management
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
                accessor: brand
            iscontext: true
    view: |-
      {
        "position": {
          "x": 1500,
          "y": 1450
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
view: |-
  {
    "linkLabelsPosition": {
      "23_8_yes": 0.6,
      "26_7_#default#": 0.23,
      "27_13_yes": 0.55,
      "29_7_#default#": 0.44,
      "3_4_Yes": 0.4,
      "3_5_#default#": 0.24
    },
    "paper": {
      "dimensions": {
        "height": 2475,
        "width": 1400,
        "x": 480,
        "y": 0
      }
    }
  }
inputs:
- key: Miner
  value: {}
  required: false
  description: Specifiy the MineMeld Miner to update
- key: EDL-Filename
  value: {}
  required: false
  description: 'Specify the filename of the EDL text file on the Web Server (i.e.:
    msft-intune.txt)'
outputs: []
