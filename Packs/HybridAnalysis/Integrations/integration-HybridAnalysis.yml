commonfields:
  id: Hybrid Analysis
  version: -1
fromversion: 5.0.0
name: Hybrid Analysis
display: Hybrid Analysis
category: Forensics & Malware Analysis
image: data:image/png;base64,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
description: Fully automated malware analysis with unique Hybrid Analysis.
configuration:
- display: Server URL (e.g. https://216.3.128.82)
  name: serverUrl
  defaultvalue: https://www.hybrid-analysis.com
  type: 0
  required: true
- display: API Key
  name: apiKey
  defaultvalue: ""
  type: 4
  required: false
- display: Trust any certificate (not secure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: >+
    var serverUrl = params.serverUrl;

    var insecure = params.insecure;

    var proxy = params.proxy;

    var version = params.version;

    var apiKey;

    var integrationContext = getIntegrationContext();

    var licenseID = getLicenseID();

    var HEADERS = {
        'User-Agent': ['Hybrid Analysis'],
        'accept': ['application/json'],
        'Content-Type': ['application/x-www-form-urlencoded'],
        'DemistoLicense': [licenseID]
    };


    if (params.apiKey) {
        apiKey = params.apiKey;
    } else if (integrationContext.apiKey) {
        apiKey = integrationContext.apiKey;
    } else {
        apiKey = generateKey();
    }


    HEADERS['api-key'] = [apiKey];


    // handle '/' at the end of serverUrl

    if (serverUrl[serverUrl.length - 1] === '/') {
        serverUrl = serverUrl.substring(0, serverUrl.length - 1);
    }


    function generateKey() {
        HEADERS['api-key'] = [integrationContext.masterApiKey];
        var cmdUrl = '/api/v2/key/create';
        var response = sendRequest('POST', cmdUrl, 'uid=DemistoLimitedEdition');
        key = response.api_key;
        integrationContext.apiKey = key;
        setIntegrationContext(integrationContext);
        return key;
    }


    function entryError(errorCode, text) {
        var error = 'Hybrid Analysis returned an error (' + errorCode + ') - ' + text;
        return {Type: entryTypes.error, ContentsFormat: formats.text, Contents: error};
    }


    //Originally, there was a mismatch between some context fields and their corresponding YML outputs.

    //For example: the context field name was 'environment_id' while the corresponding YML output was 'environmentId'.

    //This function gets a context entry and adds the existing YML outputs into the context, with the values of the original fields from context.

    //The old context fields are not being deleted in order to prevent braking backwards compatibility.

    function addYMLOutputsToContext(contextEntry) {
         Object.keys(contextEntry).forEach(function(key) {
                switch (key) {
                    case 'environment_id':
                        contextEntry.environmentId = contextEntry['environment_id'];
                        break;
                    case 'submit_name':
                        contextEntry.submitname = contextEntry['submit_name'];
                        break;
                    case 'vx_family':
                        contextEntry.vxfamily = contextEntry['vx_family'];
                        break;
                    case 'interesting':
                        contextEntry.isinteresting = contextEntry['interesting'];
                        break;
                    case 'url_analysis':
                        contextEntry.isurlanalysis = contextEntry['url_analysis'];
                        break;
                }
            });
        return contextEntry;
    }

     //  get threat level and calculate Dbot score by the following rule: 0=No Threat, 1=Suspicious, 2=Malicious, 3=Unknown
    function threatLevelToDbotScore(threatLevel, maliciousThreatLevels) {
        var dbotScore = 0;
        if (maliciousThreatLevels.indexOf(threatLevel) !== -1){
            dbotScore = 3;
        }

        else {
            switch (threatLevel) {
                case 0:
                    dbotScore = 1;
                    break;
                case 1:
                    dbotScore = 2;
                    break;
                case 2:
                    dbotScore = 2;
                    break;
                case 3:
                    dbotScore = 0;
                    break;
            }
        }
        return dbotScore;
    }



    // return a function that maps object keys by mapper (or capitlize keys if key is not exists in mapper)

    function mapObject(mapper, isContextMapper, maliciousThreatLevels) {
        return function(obj) {
            var res = {};
            Object.keys(obj).forEach(function(key) {
                // map key or capitalize if not exists
                var newKey = mapper[key] || key;
                res[newKey] = obj[key];
                if (maliciousThreatLevels && obj.threat_level && maliciousThreatLevels.indexOf(obj.threat_level) !== -1 && isContextMapper) {
                    res.Malicious = {
                        Vendor: 'Hybrid Analysis',
                        Description: 'Score above ' + obj.threat_score
                    };
                }
            });
            if (isContextMapper)
                res = addYMLOutputsToContext(res);
            return res;
        };
    }



    function createTableEntry(name, rawResponse, table, context, headers) {
        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: rawResponse,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: tableToMarkdown(name, table, headers, undefined, headerTransform=undefined, removeNull=true),
            EntryContext: context
        };
    }


    function sendRequest(method, endpoint, body) {
        var requestUrl = serverUrl + endpoint;
        var res = http(
            requestUrl,
            {
                Method: method,
                Headers: HEADERS,
                Body: body
            },
            insecure,
            proxy
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }

        var body;
        try {
            body = JSON.parse(res.Body);
        } catch (ex) {
            throw 'Error parsing response - ' + res.Body + ' - ' + ex;
        }

        return body;
    }


    function scan(hash) {
       return sendRequest('POST', '/api/v2/search/hash', 'hash='+hash);

    }

    function scanToEntry(res, hash, maliciousThreatLevels) {
        var response = res;

        // create table from response
        var tableMapper = {
           threatlevel: 'threat level',
           total_network_connections: 'total network connections',
           targeturl: 'target url',
           classification_tags: 'classification tags',
           threatscore: 'threat score',
           total_processes: 'total processes',
           submitname: 'submit name',
           environmentDescription: 'environment description',
           isinteresting: 'interesting',
           environmentId: 'environment id',
           isurlanalysis: 'url analysis',
           analysis_start_time: 'analysis start time',
           total_signatures: 'total signatures'
        };

        var table = response.map(mapObject(tableMapper, false, maliciousThreatLevels));
        // create context from response
        var context = {};

        var contextMapper = {
            sha1: 'SHA1',
            sha256: 'SHA256',
            md5: 'MD5'
        };

        context[outputPaths.file] = response.map(mapObject(contextMapper, true, maliciousThreatLevels));

        // add DbotScore to context
        response.forEach(function(res) {
            var dbotScore = threatLevelToDbotScore(res.threat_level, maliciousThreatLevels);
            context["DBotScore"] = {
                "Indicator": hash,
                "Type": "File",
                "Vendor": "Hybrid Analysis",
                "Score": dbotScore
            };
        });

        return createTableEntry('Scan Results:', response, table, context);
    }


    function submitFile (entryId, environmentId) {
        var requestUrl = serverUrl + '/api/v2/submit/file';

        // submit file
        var res = httpMultipart(
                    requestUrl, // URL
                    entryId, // Optional - FilePath / EntryID
                    {
                        Method: 'POST',
                        Headers: HEADERS
                    },
                    { // Multipart Contents
                        environment_id: environmentId // For API v2
                    },
                    insecure,
                    proxy
                );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Multipart Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }
        var body;

        try {
            body = JSON.parse(res.Body);
        } catch (ex) {
            throw 'Error parsing response - ' + res.Body + ' - ' + ex;
        }

        return body;
    }


    function submitFileMsg(response) {
        var result = {
            'JobID':  response.job_id,
            'SHA256': response.sha256,
            'EnvironmentID': response.environment_id
        };
        var context = {
            'HybridAnalysis.Submit(val.JobID && val.JobID == obj.JobID)': result
        };
        return createTableEntry('Submission information:', result, result, context);
    }


    function searchQuery(query, minMaliciousScanners) {
        body = '';
            if (args.query) {
                args.query.split(',').forEach(function(keyValue){
                   splittedObject = keyValue.split(/:(.+)/); // Split by first ':' only
                   key = splittedObject[0];
                   value = splittedObject[1];
                   body += key + '=' + value + '&'
                });
            } else {
            // Build Crowd Strike query syntax from arguments, i.e. key:value
                for (var key in args) {
                    if (key != 'min_malicious_scanners') {
                        body += key + '=' + args[key] + '&';
                    }
                }
            }
        var res = sendRequest('POST', '/api/v2/search/terms', body);

        var result = res.result;

        // create table from search result
        var tableMapper = {
           environmentDescription: 'environment description',
           start_time: 'start time',
           submitname: 'submit name',
           threatscore: 'threat score',
           type_short: 'type short',
        };

        var table = result.map(mapObject(tableMapper, false, null));

        // create context from search result
        var contextMapper = {
            job_id: 'JobID',
            sha256: 'SHA256',
            environment_id: 'EnvironmentID'
        };

        var context = {
            'HybridAnalysis.Search((val.JobID && val.JobID == obj.JobID) || (val.SHA256 && val.SHA256 == obj.SHA256))': result.map(mapObject(contextMapper, true, null))
        };

        //dbotScore pre-calculation
        var unknownCounter = 0;
        var maliciousCounter = 0;
        result.forEach(function(key) {
            if (key.verdict == null){
                unknownCounter++;
            }
            else if (key.verdict == 'malicious'){
                maliciousCounter++;
            }
        });

        // add DbotScore to context
        if (result.length != 0){
            var dbotScore = calculateDbotScore(unknownCounter, maliciousCounter, minMaliciousScanners, res.count);
            context["DBotScore"] = {
              "Indicator": res.search_terms[0].value,
                "Type": "File",
                "Vendor": "Hybrid Analysis",
                "Score": dbotScore
                };
        }

        return createTableEntry('Search results:', result, table, context);
    }



    //Return the state of the submission

    function reportState(){

        var jobID = args.jobID;
        var sha256 = args.sha256;
        var environmentID = args.environmentID;

        var hybridAnalysisID = '';

        if (jobID) {
            hybridAnalysisID = jobID;
        } else if (sha256 && environmentID) {
            hybridAnalysisID = '{0}:{1}'.format(sha256, environmentID);
        } else {
            throw 'Job ID or SHA-256 and environment ID must be provided.'
        }

        var commandURL = '/api/v2/report/{0}/state'.format(hybridAnalysisID);

        var response = sendRequest('GET', commandURL);

        var state = response.state

        var output = 'Submission state: ' + state;

        var context = {
            'HybridAnalysis.Submit(val.JobID && val.JobID == obj.JobID)': {
                State: state,
                SHA256: sha256,
                JobID: jobID,
                EnvironmentID: environmentID
            }
        };

        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: response,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: output,
            EntryContext: context
        };
    }



    function detonateFile(entryId, environmentId, malicious_threat_levels, delay, timeout) {
        var file = submitFile(entryId, environmentId);
        var hash = file.sha256;

        delayTime = parseInt(delay);
        timeOut = parseInt(timeout);
        var waitTime = delayTime;

        wait(delayTime);
        while (waitTime<timeOut) {
            var res = scan(hash);
            if (res.length > 0) {
                return scanToEntry(res, hash, malicious_threat_levels);
            } else {
                waitTime = waitTime + delayTime;
                wait(delayTime);
            }
        }
        throw ('Timeout due to no answer after ' + timeOut + ' seconds.');

    }


    //Dbot score calculation for a response without 'threat_level' field

    function calculateDbotScore(unknownCounter, maliciousCounter,minMaliciousScanners, numOfScanners){
        var dbotScore = 0;

        if (maliciousCounter >= minMaliciousScanners)
            dbotScore = 3;
        else if (maliciousCounter >= 1)
            dbotScore = 2;
        else if (unknownCounter == numOfScanners)
            dbotScore = 0;
        else if (maliciousCounter == 0) // some scanners found it clean and no scanner found it malicious
            dbotScore = 1;

        return dbotScore;
    }



    function createFileContext (url, response, dbotScore, baseContext, urlContext, DbotContext, maliciousContext){
        var fileName = url.replace(/^.*[\\\/]/, '');
        DbotContext.Indicator = fileName;
        var fileContext = {
            'Name': fileName,
            'SHA256': response.sha256
        };
        if (dbotScore == 3) {
            fileContext.Malicious = maliciousContext;
        }

        context= {
            'HybridAnalysis.URL(val.ScanID && val.ScanID == obj.ScanID)' : baseContext,
            'URL(val.Data && val.Data == obj.Data)' : urlContext,
            'File(val.SHA256 && val.SHA256 == obj.SHA256)' : fileContext,
            'DBotScore' : DbotContext
        }
        return context;
    }



    // create the context, different between file and url context

    function createQuickScanContext(response, scanners, dbotScore, maliciousDescription){

        var baseContext = {
            'ScanID': response.id,
            'SHA256': response.sha256,
            'Scanner' : scanners,
            'Finished': response.finished
        };

        var DbotContext = {
            'Vendor': 'Hybrid Analysis',
            'Score': dbotScore,
            'Type': 'URL'
        }

        var url = getIntegrationContext()[response.id];
        var urlContext = {'Data' : url};

        if (dbotScore == 3){
            var maliciousContext = {
                Vendor: 'Hybrid Analysis',
                Description: 'The following scanners reported this URL as malicious: ' + maliciousDescription
            };
            urlContext.Malicious = maliciousContext;
        }

        var context = {};

        if (getIntegrationContext()[url] == 'file_url') {
            context = createFileContext (url, response, dbotScore, baseContext, urlContext, DbotContext, maliciousContext);
        }

        else {
            DbotContext.Indicator = url;
            context = {
                'HybridAnalysis.URL(val.ScanID && val.ScanID == obj.ScanID)' : baseContext,
                'URL(val.Data && val.Data == obj.Data)' : urlContext,
                'DBotScore' : DbotContext
            }
        }

        return context;
    }



    function createQuickScanHumanReadable (response, scannersContext, headers){
        var mdTable = {
            'ScanID': response.id,
            'SHA256': response.sha256,
            'Finished': response.finished
        };
        var md = '### Scan Results:\n' + tableToMarkdown(null, mdTable, ['ScanID', 'SHA256', 'Finished'], undefined, headerTransform=undefined, removeNull=true);
        var scanTable = '##### scanners:\n' + tableToMarkdown(null, scannersContext, headers, undefined, headerTransform=undefined, removeNull=true);
        var humanReadable = md + scanTable;

        return humanReadable;
    }


        // create scanners entry context and calculate counters
    function createScannersContext (response) {
        var unknownCounter = 0;
        var maliciousCounter = 0;
        var maliciousDescription = "";
        var scannersContext = [];

        response.scanners.forEach(function(key) {
            scannersContext.push(
                {
                    'Name': key.name,
                    'Status': key.status,
                    'Positives': key.positives
                });
            if (key.status == 'unknown' || key.status =='no-result' || key.status == 'not-supported')
                unknownCounter++;
            else if (key.status == 'malicious'){
                maliciousCounter++;
                maliciousDescription = maliciousDescription + ', ' + key.name;
            }
        });

        maliciousDescription = maliciousDescription.substr(2); // remove the first ", "
        var res = {
            'scannersContext' : scannersContext,
            'unknownCounter' : unknownCounter,
            'maliciousCounter' : maliciousCounter,
            'maliciousDescription' : maliciousDescription
        }

        return res;
    }



    //create table entry from response after 'quick-scan-url-results' command

    function quickScanResultToEntry(response, minMaliciousScanners) {

        var scannersResult = createScannersContext (response);
        var scannersContext = scannersResult['scannersContext'];
        var unknownCounter = scannersResult['unknownCounter'];
        var maliciousCounter = scannersResult['maliciousCounter'];
        var maliciousDescription = scannersResult['maliciousDescription'];

        var dbotScore = calculateDbotScore(unknownCounter, maliciousCounter, minMaliciousScanners, response.scanners.lenght);

        var context = createQuickScanContext (response, scannersContext, dbotScore, maliciousDescription);
        var humanReadable = createQuickScanHumanReadable (response, scannersContext);

        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: response,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: humanReadable,
            EntryContext: context
        };
    }


    function createContext (response, hybridContext) {
        var url = hybridContext.URL;
        if (response.submission_type == 'page_url') {
            var context = {
                'HybridAnalysis.URL(val.ScanID && val.ScanID == obj.ScanID)': hybridContext,
                'URL(val.Data && val.Data == obj.Data)':{
                    'Data': url
                }
            }
        }

        else {
            var filename = url.replace(/^.*[\\\/]/, '');
            var context = {
                'HybridAnalysis.URL(val.ScanID && val.ScanID == obj.ScanID)': hybridContext,
                'URL(val.Data && val.Data == obj.Data)':{
                    'Data': url
                },
                'File(val.SHA256 && val.SHA256 == obj.SHA256)' : {
                    'SHA256': response.sha256,
                    'Name': filename,
                }
            }
        }

        return context;
    }



    //create table entry from response after 'quick-scan-url/file' command

    function quickScanToEntry(response, url) {
        var ScanID = response.id;
        var hybridContext = {
            'URL': url,
            'ScanID': response.id,
            'SHA256': response.sha256,
            'Finished': response.finished,
            'SubmissionType' : response.submission_type
        };

        var context = createContext(response, hybridContext)

        // adding { ScanID : url } to the integration context for future use
        var addToContext = {};
        addToContext[ScanID] = url;
        addToContext[url] = response.submission_type;
        setIntegrationContext(addToContext);

        var headers = ['ScanID', 'URL', 'Finished', 'SHA256', 'SubmissionType']
        return createTableEntry('Scan information:', response, hybridContext, context, headers);
    }



    //Quick Scan commands

    function quickScanUrl(scan_type, url, endpoint) {
        var body = 'scan_type=' + scan_type + '&url=' + encodeURIComponent(url);
        return sendRequest('POST', endpoint, body);
    }



    function quickScanId(id) {
        return sendRequest('GET', '/api/v2/quick-scan/' + id );
    }



    function scanStates(headers) {
        var result = sendRequest('GET', '/api/v2/quick-scan/state');
        var scannersContext = [];
        result.forEach(function(key) {// create scanner entry
            scannersContext.push(
                {
                    'Name': key.name,
                    'Available': key.available,
                    'Description': key.description
                }
            );
        });

        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: result,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: '### Scanner:\n' + tableToMarkdown(null, scannersContext, ['Name', 'Available', 'Description'], undefined, headerTransform=undefined, removeNull=true),
            EntryContext: {'HybridAnalysis.Scanner(val.Name && val.Name == obj.Name) :' : scannersContext}
        };

    }



    //Sandbox Submission commands

    function submitUrl(url, environment_id, endpoint) {
        var body= 'url=' + url + '&environment_id=' + environment_id;
        return sendRequest('POST', endpoint, body);
    }



    switch (command) {
        case 'test-module':
            var res = quickScanUrl('all', 'www.google.com', '/api/v2/quick-scan/url');
            if (res != null && res.submission_type == 'page_url') {
               return 'ok';
            }
            return 'the response is: ' + JSON.stringify(res) ;
        case 'hybrid-analysis-scan':
            var res = scan(args.file);
            return scanToEntry(res, args.file, args.malicious_threat_levels);
        case 'hybrid-analysis-submit-sample':
            var response = submitFile(args.entryId, args.environmentID);
            return submitFileMsg(response);
        case 'hybrid-analysis-search':
            return searchQuery(args.query, args.min_malicious_scanners);
        case 'hybrid-analysis-detonate-file':
            return detonateFile(args.entryId, args.environmentID, args.malicious_threat_levels, args.delay, args.timeout);
        case 'hybrid-analysis-get-report-status':
            return reportState();
        //Quick Scan commands
        case 'hybrid-analysis-quick-scan-url':
            var res = quickScanUrl(args.scan_type, args.url, '/api/v2/quick-scan/url');
            return quickScanToEntry(res, args.url);
        case 'hybrid-analysis-quick-scan-url-results':
            var res = quickScanId(args.scanID);
            return quickScanResultToEntry(res, args.min_malicious_scanners);
        case 'hybrid-analysis-list-scanners':
            return scanStates();
        //Sandbox Submission commands
        case 'hybrid-analysis-submit-url':
            var response = submitUrl(args.url, args.environmentID, '/api/v2/submit/url' );
            return submitFileMsg(response);
    }



  type: javascript
  commands:
  - name: hybrid-analysis-scan
    arguments:
    - name: file
      required: true
      description: The MD5, SHA1, or SHA256 hash of the file.
    - name: malicious_threat_levels
      description: A CSV list of threat level values. Files that have a threat level specified in the list will be considered malicious.
      isArray: true
      defaultValue: "2"
    outputs:
    - contextPath: File.SHA256
      description: SHA256 hash of the file.
      type: string
    - contextPath: File.SHA1
      description: SHA1 hash of the file.
      type: string
    - contextPath: File.MD5
      description: MD5 hash of the file.
      type: string
    - contextPath: File.environmentId
      description: 'The environment ID of the file. '
      type: string
    - contextPath: File.analysis_start_time
      description: The start time of the file analysis.
      type: string
    - contextPath: File.submitname
      description: The submission name of the file.
      type: string
    - contextPath: File.classification_tags
      description: A list of classification tags of the file.
      type: string
    - contextPath: File.vxfamily
      description: The family classification of the file.
      type: string
    - contextPath: File.total_network_connections
      description: The total number of network connections of the file.
      type: string
    - contextPath: File.total_processes
      description: The total processes count of the file.
      type: string
    - contextPath: File.total_signatures
      description: The total signatures count of the file.
      type: string
    - contextPath: File.hosts
      description: A list of hosts of the file.
      type: string
    - contextPath: File.isinteresting
      description: Whether the server found the file interesting.
      type: string
    - contextPath: File.domains
      description: A list of domains related to the file.
      type: string
    - contextPath: File.isurlanalysis
      description: Whether the file was analyzed by a URL.
      type: string
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision.
      type: string
    - contextPath: File.Malicious.Description
      description: For malicious files, the reason that the vendor made the decision.
      type: string
    - contextPath: DBotScore.Indicator
      description: The indicator.
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type.
      type: string
    - contextPath: DBotScore.Vendor
      description: The DBot score vendor.
      type: string
    - contextPath: DBotScore.Score
      description: The DBot score.
      type: number
    description: Returns summary information for a given MD5, SHA1 or SHA256 hash, and all reports generated for any environment ID.
  - name: hybrid-analysis-submit-sample
    arguments:
    - name: entryId
      required: true
      default: true
      description: TheWar-room entry ID of sample file
    - name: environmentID
      required: true
      description: The environment ID to which to submit the file. Run the vx-get-environments command to get all environment IDs.
    outputs:
    - contextPath: HybridAnalysis.Submit.JobID
      description: JobID of the submission
      type: string
    - contextPath: HybridAnalysis.Submit.SHA256
      description: 'The SHA256 hash of the submission. '
      type: string
    - contextPath: HybridAnalysis.Submit.EnvironmentID
      description: 'The environment ID of the submission. '
      type: string
    description: Submits a file from the investigation to the analysis server. The minimum required authorization is "default".
  - name: hybrid-analysis-search
    arguments:
    - name: query
      description: 'The query to run, in the Hybrid Analysis query syntax. For more information, see `<server url>/faq#advanced-search-options`. For example: url:google, host:95.181.53.78.'
    - name: filename
      description: The full file name, including the file extension.
    - name: filetype
      description: Filetype e.g. docx
    - name: filetype_desc
      description: A description of the file type, for example, PE32 executable.
    - name: env_id
      description: The environment ID.
    - name: country
      description: 'The ISO code of the country by which to filter results, for example: swe'
    - name: verdict
      description: 'The verdict by which to filter results. Can be "1- whitelisted", "2- no verdict", "3- "no specific threat", "4- suspicious", or "5- malicious".'
    - name: av_detect
      description: 'The AV multi-scan range (0-100) by which to filter results, for example: "50-70".'
    - name: vx_family
      description: 'The AV family substring by which to filter results, for example: "nemucod".'
    - name: tag
      description: 'The hashtag by which to filter results, for example: "ransomware".'
    - name: port
      description: The port by which to filter results.
    - name: host
      description: The host (IP address) by which to filter results.
    - name: domain
      description: The domain by which to filter results.
    - name: url
      description: The HTTP request substring by which to filter results.
    - name: similar_to
      description: 'Similar samples, for example: <sha256>.'
    - name: context
      description: 'Sample context, for example: <sha256>.'
    - name: imp_hash
      description: The import hash.
    - name: ssdeep
      description: The ssdeep hash.
    - name: authentihash
      description: The authentication hash.
    - name: min_malicious_scanners
      description: The number of scanners that report the file as malicious to determine whether the file is malicious. Default is "2".
      defaultValue: "2"
    outputs:
    - contextPath: HybridAnalysis.Search.SHA256
      description: The SHA256 hash of the search result.
      type: string
    - contextPath: HybridAnalysis.Search.SHA1
      description: The SHA1 hash of the search result.
      type: string
    - contextPath: HybridAnalysis.Search.MD5
      description: The MD5 hash of the search result.
      type: string
    - contextPath: HybridAnalysis.Search.environmentId
      description: The environment ID of the search result.
      type: string
    - contextPath: HybridAnalysis.Search.start_time
      description: The start time of the search result.
      type: date
    - contextPath: HybridAnalysis.Search.threatscore
      description: The threat score of the search result, by server.
      type: string
    - contextPath: HybridAnalysis.Search.verdict
      description: The verdict of the search result.
      type: string
    - contextPath: HybridAnalysis.Search.environmentDescription
      description: The environment description of search result.
      type: string
    - contextPath: HybridAnalysis.Search.submitname
      description: The submission name of the search result.
      type: string
    - contextPath: HybridAnalysis.Search.vxfamily
      description: The family of search result.
      type: string
    - contextPath: HybridAnalysis.Search.threatscore
      description: The threat score of the search result.
      type: string
    - contextPath: HybridAnalysis.Search.type_short
      description: 'The type of search result, for example: "url" or "host".'
      type: string
    - contextPath: HybridAnalysis.Search.size
      description: The size of the search result.
      type: number
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision.
      type: string
    - contextPath: File.Malicious.Description
      description: For malicious files, the reason that the vendor made the decision.
      type: string
    - contextPath: DBotScore.Indicator
      description: The indicator.
    - contextPath: DBotScore.Type
      description: The indicator type.
    - contextPath: DBotScore.Vendor
      description: The DBotScore vendor.
    - contextPath: DBotScore.Score
      description: The DBot score.
    description: Performs a search on the database using the Hybrid Analysis search syntax.
  - name: hybrid-analysis-detonate-file
    arguments:
    - name: entryId
      required: true
      description: The War Room entry ID of the sample file you want to detonate.
    - name: environmentID
      required: true
      description: The environment ID to which to submit the file for detonation. Run the vx-get-environments command to get all environment IDs. Default is 100, or other WINDOWS ID.
    - name: delay
      description: The amount of time (in seconds) to wait between calls. Default is "3".
      defaultValue: "3"
    - name: timeout
      description: The total wait time (in seconds) before timeout. Default is "60".
      defaultValue: "60"
    - name: malicious_threat_levels
      description: A CSV list of threat level values. Files that have a threat level specified in the list will be considered malicious.
      isArray: true
      defaultValue: "2"
    outputs:
    - contextPath: File.SHA256
      description: SHA256 hash of the file.
      type: string
    - contextPath: File.SHA1
      description: SHA1 hash of the file.
      type: string
    - contextPath: File.MD5
      description: MD5 hash of the file.
      type: string
    - contextPath: File.environmentId
      description: 'The environment ID of the file. '
      type: string
    - contextPath: File.analysis_start_time
      description: The start time of the file analysis.
      type: string
    - contextPath: File.submitname
      description: The submission name of the file.
      type: string
    - contextPath: File.classification_tags
      description: A list of classification tags of the file.
      type: string
    - contextPath: File.vxfamily
      description: The family classification of the file.
      type: string
    - contextPath: File.total_network_connections
      description: The total number of network connections of the file.
      type: string
    - contextPath: File.total_processes
      description: The total processes count of the file.
      type: string
    - contextPath: File.total_signatures
      description: The total signatures count of the file.
      type: string
    - contextPath: File.hosts
      description: A list of hosts of the file.
      type: string
    - contextPath: File.isinteresting
      description: Whether the server found the file interesting.
      type: string
    - contextPath: File.domains
      description: A list of domains related to the file.
      type: string
    - contextPath: File.isurlanalysis
      description: Whether the file was analyzed by a URL.
      type: string
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision.
      type: string
    - contextPath: File.Malicious.Description
      description: For malicious files, the reason that the vendor made the decision.
      type: string
    - contextPath: DBotScore.Indicator
      description: The indicator.
      type: string
    - contextPath: DBotScore.Type
      description: The indicator type.
      type: string
    - contextPath: DBotScore.Vendor
      description: The DBot score vendor.
      type: string
    - contextPath: DBotScore.Score
      description: The DBot score.
      type: number
    description: Submits a file for detonation in Hybrid Analysis.
  - name: hybrid-analysis-get-report-status
    arguments:
    - name: jobID
      description: The Job ID of the submission.
    - name: sha256
      description: The submission SHA256.
    - name: environmentID
      description: The environmentID of the submission.
    outputs:
    - contextPath: HybridAnalysis.Submit.State
      description: The state of the process.
      type: string
    - contextPath: HybridAnalysis.Submit.SHA256
      description: The SHA256 hash of the submission.
      type: string
    - contextPath: HybridAnalysis.Submit.JobID
      description: The job ID of the submission.
      type: string
    - contextPath: HybridAnalysis.Submit.EnvironmentID
      description: The environment ID of the submission.
      type: string
    description: Returns the state of the file submission.
  - name: hybrid-analysis-quick-scan-url
    arguments:
    - name: scan_type
      description: The type of scan. Run the hybrid-analysis-list-scanners command to view available scanners.
      defaultValue: all
    - name: url
      required: true
      description: The website URL, or the URL that contains the file to submit.
    outputs:
    - contextPath: HybridAnalysis.URL.Data
      description: The URL.
      type: string
    - contextPath: HybridAnalysis.URL.ScanID
      description: The scan ID.
      type: string
    - contextPath: HybridAnalysis.URL.SHA256
      description: The SHA256 hash of the URL.
      type: string
    - contextPath: HybridAnalysis.URL.Finished
      description: Whether the scan completed.
      type: boolean
    - contextPath: File.Name
      description: The URL.
      type: string
    - contextPath: File.SHA256
      description: The SHA256 hash of the file.
      type: string
    - contextPath: HybridAnalysis.URL.SubmissionType
      description: The type of the submission. Can be "file" or "url".
      type: string
    description: Submits the URL of a website, or the URL that contains the file, for analysis.
  - name: hybrid-analysis-submit-url
    arguments:
    - name: url
      required: true
      description: The URL of the file to submit.
      defaultValue: The URL of the website, or the URL that contains the file to submit.
    - name: environmentID
      required: true
      description: The environment ID to which to submit the file. Run the vx-get-environments command to get all environment IDs.
    outputs:
    - contextPath: HybridAnalysis.Submit.JobID
      description: The job ID of the submission.
      type: string
    - contextPath: HybridAnalysis.Submit.SHA256
      description: The SHA256 of the submission.
      type: string
    - contextPath: HybridAnalysis.Submit.EnvironmentID
      description: The environment ID of the submission.
      type: number
    - contextPath: HybridAnalysis.Submit.SubmissionType
      description: The type of the submission. Can be "file" or "url".
      type: string
    description: Submits The URL of a website or the URL that contains the file, for analysis.
  - name: hybrid-analysis-list-scanners
    arguments: []
    outputs:
    - contextPath: HybridAnalysis.Scanner.Available
      description: Whether the scanner is available.
    - contextPath: HybridAnalysis.Scanner.Name
      description: The scanner name.
    - contextPath: HybridAnalysis.Scanner.Description
      description: The scanner description.
    description: ' Returns a list of available scanners.'
  - name: hybrid-analysis-quick-scan-url-results
    arguments:
    - name: scanID
      required: true
      description: The scan ID of the scanned URL.
    - name: min_malicious_scanners
      required: true
      description: The number of scanners that report the file as malicious to determine whether the file is malicious. Default is "2".
      defaultValue: "2"
    outputs:
    - contextPath: HybridAnalysis.URL.ScanID
      description: The scan ID.
      type: string
    - contextPath: HybridAnalysis.URL.SHA256
      description: The SHA256 hash of the indicator.
      type: string
    - contextPath: HybridAnalysis.URL.Finished
      description: Whether the process completed.
      type: boolean
    - contextPath: HybridAnalysis.URL.Scanner.Name
      description: The scanner name.
      type: string
    - contextPath: HybridAnalysis.URL.Scanner.Positives
      description: The number of positive results.
      type: number
    - contextPath: HybridAnalysis.URL.Scanner.Status
      description: The status of the file.
      type: string
    - contextPath: File.SHA256
      description: The SHA256 hash of the file.
      type: string
    description: Returns the scan results of the given URL ID.
  runonce: false
tests:
- Detonate File - HybridAnalysis - Test
- HybridAnalysis-Test
