id: SentinelOne - Fetch File from Endpoint
version: 4
vcShouldKeepItemLegacyProdMachine: false
name: SentinelOne - Fetch File from Endpoint
description: |+
  # Collect endpoint information based on SentinelOne commands.

  Input:
  * Hostname (Default: ${Endpoint.Hostname})
  * Password (Used for protecting zip file that file is stored in)
  * Path (Full path of the file)
  * Timeout - how long to poll for the file to appear in the activity feed. For example, if a host is offline

  Notes:
  The SentinelOne API for downloading files is aynchronous. At the time this was written there is no way to correlate a request for a file to the file entry that shows up in the activities feed. So, if two requests were submitted simultaneously to download two different files from the same host, there is no way to determine which file entry in the activity entry corresponds to which request.  So this playbook *assumes* that the most recent file upload from a given agent ID that occurs *after* we submit a file fetch request is our request. It uses locks to ensure that this is the case *if* the only source of file upload request is this XSOAR playbook. If analysts on XSOAR, other playbooks, or other systems are also submitting file fetches, this logic will fail.

  If a file does not exist on an endpoint, the fetch-files API will still return success, and a zip file of the upload will still be uploaded to SentinelOne. However, the zip contents will be empty, except for a metadata.json file

starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 9eaadccd-2057-4500-8880-850cf1787207
    type: start
    task:
      id: 9eaadccd-2057-4500-8880-850cf1787207
      version: -1
      name: ""
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "16"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 377.5,
          "y": 50
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: c42a7888-a590-48c4-8397-0404772e8207
    type: regular
    task:
      id: c42a7888-a590-48c4-8397-0404772e8207
      version: -1
      name: Get  Host Agent info
      description: Returns all agents that match the specified criteria.
      script: '|||sentinelone-list-agents'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      computer_name:
        simple: ${inputs.Hostname}
      limit:
        simple: "1"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 377.5,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: c6d4fec1-edaf-46bf-85f8-ce057c60f5ca
    type: condition
    task:
      id: c6d4fec1-edaf-46bf-85f8-ce057c60f5ca
      version: -1
      name: Did we get the Agent info & Agent is Online?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "3"
      "yes":
      - "5"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: SentinelOne.Agents.ID
            iscontext: true
          right:
            value: {}
      - - operator: isTrue
          left:
            value:
              simple: SentinelOne.Agents.IsActive
            iscontext: true
    view: |-
      {
        "position": {
          "x": 377.5,
          "y": 895
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 6fe36b2e-8774-4335-8fb1-28f4f171ca9f
    type: regular
    task:
      id: 6fe36b2e-8774-4335-8fb1-28f4f171ca9f
      version: -1
      name: No Agent was found
      scriptName: Print
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      value:
        simple: No Agent was found or Agent is not online for ${inputs.Hostname}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1300,
          "y": 3110
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: fc658896-ef41-4684-871e-a80e9e7ea145
    type: title
    task:
      id: fc658896-ef41-4684-871e-a80e9e7ea145
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1600,
          "y": 3410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: e16f7fd9-203f-452a-85a5-928806bf8928
    type: title
    task:
      id: e16f7fd9-203f-452a-85a5-928806bf8928
      version: -1
      name: Determine Start Timestamp for Querying Fetch Results
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "12"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 490,
          "y": 1070
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: b5a3f162-aca9-40c6-8f6d-1438368cbd03
    type: condition
    task:
      id: b5a3f162-aca9-40c6-8f6d-1438368cbd03
      version: -1
      name: Is SentinelOne v2 enabled?
      description: Returns 'yes' if integration brand is available. Otherwise returns
        'no'
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "4"
      "yes":
      - "28"
    scriptarguments:
      brandname:
        simple: SentinelOne V2
    results:
    - brandInstances
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 377.5,
          "y": 370
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 8a566c6b-407e-48d5-8336-15888cae9b15
    type: regular
    task:
      id: 8a566c6b-407e-48d5-8336-15888cae9b15
      version: -1
      name: Submit Fetch File Request
      description: Invokes a fetch files command against an agent endpoint
      script: '|||sentinelone-fetch-file'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      agent_id:
        simple: ${SentinelOne.Agents.ID}
      file_path:
        simple: ${inputs.Path}
      password:
        simple: ${inputs.Password}
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 705,
          "y": 2235
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: f6211d69-ba0b-4717-8e49-135cbbe22fde
    type: title
    task:
      id: f6211d69-ba0b-4717-8e49-135cbbe22fde
      version: -1
      name: Fetch File
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 705,
          "y": 1915
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: d7167673-9f8e-401f-85d3-951a932822eb
    type: regular
    task:
      id: d7167673-9f8e-401f-85d3-951a932822eb
      version: -1
      name: Get Latest Activity to Get Timestamp on SentinelOne
      description: Returns a list of activities.
      script: '|||sentinelone-get-activities'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      limit:
        simple: "1"
      sort_by:
        simple: createdAt
      sort_order:
        simple: desc
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 490,
          "y": 1215
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 036aed5c-57f1-4164-8277-e3d26bb5b4df
    type: condition
    task:
      id: 036aed5c-57f1-4164-8277-e3d26bb5b4df
      version: -1
      name: Activity Found?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "14"
      "yes":
      - "15"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: SentinelOne.Activity.CreatedAt
            iscontext: true
    view: |-
      {
        "position": {
          "x": 490,
          "y": 1390
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 5d957e25-4ed5-489c-897f-112dbc6bb324
    type: regular
    task:
      id: 5d957e25-4ed5-489c-897f-112dbc6bb324
      version: -1
      name: 'Error: Unexpected Condition'
      description: Prints an error entry with a given message
      scriptName: PrintErrorEntry
      type: regular
      iscommand: false
      brand: ""
    scriptarguments:
      message:
        simple: This Playbook assumes that there is at least one activity entry already
          in SentinelOne.  Please perform an operation in your console to begin filling
          the Activity feed and then restart this playbook.
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 275,
          "y": 1565
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: e14a0400-3825-452e-874f-ad39144f16ad
    type: regular
    task:
      id: e14a0400-3825-452e-874f-ad39144f16ad
      version: -1
      name: Set StartTimestamp for Query
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "24"
    scriptarguments:
      key:
        simple: StartTimestamp
      value:
        simple: ${SentinelOne.Activity.CreatedAt}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 705,
          "y": 1565
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: cf171117-67c4-43a7-834c-1e254fe1f2d5
    type: regular
    task:
      id: cf171117-67c4-43a7-834c-1e254fe1f2d5
      version: -1
      name: DeleteContext
      description: |-
        Delete field from context.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs.paloaltonetworks.com/cortex/cortex-xsoar/6-2/cortex-xsoar-admin/playbooks/automations.html
      scriptName: DeleteContext
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "7"
    scriptarguments:
      all:
        simple: "yes"
      subplaybook:
        simple: auto
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 377.5,
          "y": 195
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: c8c453ae-86cd-436e-8e8a-daba367334cf
    type: regular
    task:
      id: c8c453ae-86cd-436e-8e8a-daba367334cf
      version: -1
      name: Get Synchronization Lock
      description: Get a lock. If the lock is already in use - will wait until it
        is released or until timeout is reached
      script: '|||demisto-lock-get'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "8"
    scriptarguments:
      name:
        simple: SentinelOne-${inputs.Hostname}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 705,
          "y": 2060
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 6ceb0948-7535-433e-8202-a3fa48850d3a
    type: regular
    task:
      id: 6ceb0948-7535-433e-8202-a3fa48850d3a
      version: -1
      name: Release Synchronization Lock
      description: Release a lock
      script: '|||demisto-lock-release'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "26"
    scriptarguments:
      name:
        simple: SentinelOne-${inputs.Hostname}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 705,
          "y": 2760
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: ce06fa6e-ad2e-4942-8173-f5324f72fc14
    type: condition
    task:
      id: ce06fa6e-ad2e-4942-8173-f5324f72fc14
      version: -1
      name: Error?
      description: Check whether given entry/entries returned an error. Use ${lastCompletedTaskEntries}
        to check the previous task entries. If array is provided, will return yes
        if one of the entries returned an error.
      scriptName: isError
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "25"
      "yes":
      - "18"
    scriptarguments:
      entryId:
        simple: ${lastCompletedTaskEntries}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 705,
          "y": 2410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 0d93a98b-2bd2-407f-82ab-1446a6d75551
    type: regular
    task:
      id: 0d93a98b-2bd2-407f-82ab-1446a6d75551
      version: -1
      name: Delete SentinelOne.Activity
      description: |-
        Delete field from context.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs.paloaltonetworks.com/cortex/cortex-xsoar/6-2/cortex-xsoar-admin/playbooks/automations.html
      scriptName: DeleteContext
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      key:
        simple: SentinelOne.Activity
      subplaybook:
        simple: auto
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 705,
          "y": 1740
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 14e296ca-fbe0-43a0-8313-aff59d5b44fa
    type: playbook
    task:
      id: 14e296ca-fbe0-43a0-8313-aff59d5b44fa
      version: -1
      name: SentinelOne - Check for New File Upload Activity
      playbookName: SentinelOne - Check for New File Upload Activity
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      AgentId:
        simple: ${SentinelOne.Agents.ID}
      StartTimestamp:
        simple: ${StartTimestamp}
      Timeout:
        simple: "10"
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 490,
          "y": 2585
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: 7a34a45f-bda5-43e6-86b1-d3bd3bd5808f
    type: condition
    task:
      id: 7a34a45f-bda5-43e6-86b1-d3bd3bd5808f
      version: -1
      name: Upload to SentinelOne Console Succeeded?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "4"
      "yes":
      - "27"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: SentinelOne.Activity
            iscontext: true
    view: |-
      {
        "position": {
          "x": 705,
          "y": 2935
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: 7b0c570a-dbc0-4fe2-879f-6e4e6e23e7d3
    type: regular
    task:
      id: 7b0c570a-dbc0-4fe2-879f-6e4e6e23e7d3
      version: -1
      name: Download File from SentinelOne Console
      description: Download a file fetched using sentinelone-fetch-file to submit
        the request and sentinelone-get-activities to get the download path
      tags:
      - sentinelone-file-download
      script: '|||sentinelone-download-fetched-file'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      activity_id:
        simple: ${SentinelOne.Activity.ID}
      agent_id:
        simple: ${SentinelOne.Agents.ID}
      password:
        simple: ${inputs.Password}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 817.5,
          "y": 3110
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: 16b9bccc-8f24-4a64-8528-8cc9b024d223
    type: condition
    task:
      id: 16b9bccc-8f24-4a64-8528-8cc9b024d223
      version: -1
      name: Is Demisto Lock Enabled
      description: Returns 'yes' if integration brand is available. Otherwise returns
        'no'
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "4"
      "yes":
      - "1"
    scriptarguments:
      brandname:
        simple: Demisto Lock
    results:
    - brandInstances
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 377.5,
          "y": 545
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "21_25_no": 0.89
    },
    "paper": {
      "dimensions": {
        "height": 3425,
        "width": 1705,
        "x": 275,
        "y": 50
      }
    }
  }
inputs:
- key: Hostname
  value:
    simple: ${Endpoint.Hostname}
  required: false
  description: The Hostname of the device to run on
  playbookInputQuery: null
- key: Path
  value: {}
  required: true
  description: Full path of file to upload from the agent
  playbookInputQuery: null
- key: Password
  value:
    simple: PossiblyInfected)(*&7890
  required: false
  description: Password to use for protecting the resulting zip file. Modify this
    if you also want to access the files from the SentinelOne web UI and have password
    you use for that access
  playbookInputQuery: null
- key: Timeout
  value:
    simple: "10"
  required: false
  description: Timeout in minutes of max time spent waiting for file to upload
  playbookInputQuery: null
outputs: []
