commonfields:
  id: ArcSight ESM_fixes
  version: -1
name: ArcSight ESM_fixes
display: ArcSight ESM_fixes
category: Analytics & SIEM
image: data:image/png;base64,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
description: ArcSight ESM SIEM by Micro Focus (Formerly HPE Software).
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: server
  defaultvalue: ""
  type: 0
  required: true
- display: Port
  name: port
  defaultvalue: "8443"
  type: 0
  required: true
- display: Credentials
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
- display: Fetch Events as incidents via Query Viewer ID. Mandatory fields for query
    are Start Time and Event ID.
  name: viewerId
  defaultvalue: ""
  type: 0
  required: false
- display: Fetch Cases as incidents via Query Viewer ID. Mandatory fields for query
    are Create Time and ID.
  name: casesQueryViewerId
  defaultvalue: ""
  type: 0
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Do not validate server certificate (insecure)
  name: insecure
  defaultvalue: "true"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "false"
  type: 8
  required: false
script:
  script: |-
    // table from JSON to human readable table
    var eventTranslateMap = {
        'endTime' : 'endTime=new Date(Number(val)).toLocaleString()',
        // 'Source Address': 'source.address=intToIP(val)' + intToIpDT,
        // 'Destination Address': 'destination.address=intToIP(val)' + intToIpDT,
        'Source Address': 'source.address',
        'Destination Address': 'destination.address',
        'Name': 'name',
        'source Port': 'source.port',
        'Vendor': 'device.vendor',
        'AgentReceiptTime': 'agentReceiptTime=new Date(Number(val)).toLocaleString()',
        'DeviceAction': 'deviceAction',
        'DeviceCustom': 'deviceCustom',
        'UserDisplayName': 'deviceCustomString2'
    };

    function humanTime(t) {
        return new Date(Number(t)).toLocaleString();
    }
    var caseTimeFields =  ['Event-Manager Receipt Time', 'Modification Time', 'Create Time', 'Event-End Time', 'Event-Start Time', 'Start Time'];


    var server = params.server.replace(/[\/]+$/, '') + ':' + params.port + '/';

    // Arcsight field names
    var eventIdField = 'Event ID';
    var caseIdField = 'ID';
    var eventsTimeField = 'Start Time';
    var casesTimeField = 'Create Time';

    var pathDictionary = {
        login: 'www/core-service/rest/LoginService/login',
        logout: 'www/core-service/rest/LoginService/logout',
        'as-get-matrix-data': 'www/manager-service/rest/QueryViewerService/getMatrixData',
        'as-get-all-cases': 'www/manager-service/rest/CaseService/findAllIds',
        'as-get-case': 'www/manager-service/rest/CaseService/getResourceById',
        'as-get-all-query-viewers': 'www/manager-service/rest/QueryViewerService/findAllIds',
        'as-get-case-event-ids': 'www/manager-service/rest/CaseService/getCaseEventIDs',
        ActiveListService: 'www/manager-service/services/ActiveListService/'
    };

    function getToken() {
        var res = JSON.parse(sendRequest(
            pathDictionary.login, {
                login: params.credentials.identifier,
                password: params.credentials.password
            },
            true));

        if (res && res['log.loginResponse'] && res['log.loginResponse']['log.return']) {
            return res['log.loginResponse']['log.return'];
        }

        throw 'Failed to login. Check username/password. Original login response: ' + res;
    }

    function logout() {
        sendRequest(pathDictionary.logout, {
            authToken: args.authToken
        });
    }

    function sendRequest(url, args, login) {
        var newArgs = args || {};
        newArgs.alt = 'json';
        var fullUrl = server + url + encodeToURLQuery(newArgs);
        // logDebug('ArcSight sendRequest: sending request to ' + fullUrl);
        var res = http(
            fullUrl, {
                Method: 'GET',
                Headers: {
                    'Content-Type': ['application/x-www-form-urlencoded'],
                    'Accept': ['application/json']
                }
            },
            params.insecure,
            params.proxy
        );
        // logDebug('ArcSight sendRequest: got reply from ' + fullUrl);

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            if (!login) {
                sendRequest(pathDictionary.logout, {
                    authToken: args.authToken
                });
            }
            throw 'Request to ArcSight ' + fullUrl + ' failed, request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }

        return res.Body;
    }

    function sendAndParse(command, url, args) {
        var json = parseSOAPResponse(sendRequest(url, args));
        if (!json) {
            return null;
        }

        var result = json;
        return result;
    }

    function postRestRequest(queryPath, param, body) {
        var stringBody = body;
        if (body && typeof body !== 'string') {
            stringBody = JSON.stringify(body)
        }

        var newArgs = param || {};
        newArgs.alt = 'json';

        // prepare the request url (make sure to encode the query parameter value)
        var requestUrl = server + queryPath;
        if (newArgs) {
            requestUrl += encodeToURLQuery(newArgs);
        }
    logDebug('postRestRequest: sending request to ' + requestUrl);
    logDebug('postRestRequest: body is ' + stringBody);
    var res = http(
            requestUrl, {
                Method: 'POST',
                Headers: {
                    'Content-Type': ['application/json'],
                    'Accept': ['application/json']
                },
                Body: stringBody
            },
            params.insecure,
            params.useproxy
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Body: ' + stringBody + '\n' + 'Request Failed to ' + requestUrl + '.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }
        return res;
    }

    function sendSOAPRequest(queryPath, param, body) {
        // prepare the request url (make sure to encode the query parameter value)
        var requestUrl = server + queryPath;
        if (param) {
            requestUrl += encodeToURLQuery(param);
        }

        var res = http(
            requestUrl, {
                Method: 'POST',
                Body: body
            },
            params.insecure,
            params.proxy
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed to ' + requestUrl + '.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }

        return res;
    }

    function parseSOAPResponse(resBody) {
        var matches = resBody.match(/<ns\d{1,3}:return>(.|[\r\n])*<\/ns\d{1,3}:return>/);
        if (!matches || !matches[0]) {
            return null;
        }

        var match = matches[0].replace(/:return><ns/gi, ':return>##==##==#<ns').split('##==##==#');
        if (match.length === 1) {
            match = match[0];
            var json = JSON.parse(x2j(match));
            return json;
        } else {
            var arr = [];
            for (var i = 0; i < match.length; i++) {
                arr.push(JSON.parse(x2j(match[i])).return);
            }

            return arr;
        }
    }

    function convertByMap(arrSrc, translationMap) {
        var arrDest = [];

        if (!arrSrc) {
            throw 'arrSrc can\'t be undefined or null';
        }

        if (!Array.isArray(arrSrc)) {
            arrSrc = [arrSrc];
        }

        if (!translationMap) {
            throw 'translationMap must contain map';
        }

        /*
        [
            {
                "name": "Anar",
                "age": 19
            }
        ]

        ==> { "NAME": "name" }
        [
            {
                "NAME": "Anar"
            }
        ]

        */
        arrSrc.forEach(function(objSrc) {
            var objDest = {};
            Object.keys(translationMap).forEach(function(destKey) {
                var srcKey = translationMap[destKey];
                objDest[destKey] = dq(objSrc, srcKey);
            });
            arrDest.push(objDest);
        });

        return arrDest;
    }


    function getAllQueryViewerCases() {
        var response;
        try {
            response = getQueryViewerResultsRequest(args.authToken, args.QueryViewerId, false);
        } catch (ex) {
            throw 'Cases response to query is not in the correct format. Error: ' + ex;
        }
        if (!response) {
            throw 'Cases response to query is empty';
        }
        var fieldNames = response.columnHeaders;

        var data = response.data;

        return {"res": data};
    }

    function getCasesIncidents(lastRun) {
        var timeField = 'Create Time'; // Query must contain Start Time field
        var newIncidents = [];

        var response;
        try {
            response = getQueryViewerResultsRequest(args.authToken, params.casesQueryViewerId, false);
        } catch (ex) {
            throw 'Cases response to query is not in the correct format. Error: ' + ex;
        }
        if (!response) {
            throw 'Cases response to query is empty';
        }
        var fieldNames = response.columnHeaders;
        if (fieldNames.indexOf(timeField) === -1) {
            throw 'Cases Query must contain ' + timeField + ' fields';
        }
        var data = response.data;

        var lastEventTime = (lastRun && lastRun.caseLastEventTime) ? lastRun.caseLastEventTime : 0;
        var maxEventTime = lastEventTime;
        for (var i = 0; i < data.length; i++) {
            var eventTimeInMillis = Number(data[i][timeField]);
            if (lastEventTime < eventTimeInMillis) {
                if (maxEventTime < eventTimeInMillis) {
                    maxEventTime = eventTimeInMillis;
                }
                var keys = Object.keys(data[i]);
                var labels = [];
                var timeOccurred = null;
                for (var j = 0; j < keys.length; j++) {
                    if (keys[j] !== 'Name') {
                        if (data[i][keys[j]]) {
                            if (keys[j] === 'Event-Manager Receipt Time') {
                                timeOccurred = new Date(Number(data[i][keys[j]])).toISOString();
                            }
                            val = data[i][keys[j]];
                            if(caseTimeFields.indexOf(keys[j]) > -1) {
                                val = humanTime(val);
                            }
                            //
                            logInfo('ArcsightDebug' + val);
                            labels.push({
                                type: keys[j],
                                value: String(val)
                            });
                        }
                    }
                }

                var newIncident = {
                    name: data[i].Name || ('New case from arcsight at ' + Date.now()),
                    labels: labels,
                    rawJSON: JSON.stringify(data[i])
                };
                if (timeOccurred) {
                    newIncident['occurred'] = timeOccurred;
                }
                newIncidents.push(newIncident);
            }
        }

        lastRun.caseLastEventTime = maxEventTime;
        return newIncidents;
    }

    function getEventsIncidents(lastRun) {
        var timeField = 'Start Time'; // Query must contain Start Time field
        var newIncidents = [];

        var response;
        try {
            response = getQueryViewerResultsRequest(args.authToken, params.viewerId, false);
        } catch (ex) {
            throw 'Events response to query is not in the correct format. Error: ' + ex;
        }
        if (!response) {
            throw 'Events response to query is empty';
        }
        var fieldNames = response.columnHeaders;
        if (fieldNames.indexOf(timeField) === -1) {
            throw 'Events Query must contain ' + timeField + ' fields';
        }
        var data = response.data;
        var lastEventTime = lastRun && lastRun.lastEventTime ? lastRun.lastEventTime : 0;
        var maxEventTime = lastEventTime;
        for (var i = 0; i < data.length; i++) {
            var eventTimeInMillis = Number(data[i][timeField]);
            if (lastEventTime < eventTimeInMillis) {
                if (maxEventTime < eventTimeInMillis) {
                    maxEventTime = eventTimeInMillis;
                }

                var keys = Object.keys(data[i]);
                var labels = [];
                for (var j = 0; j < keys.length; j++) {
                    if (keys[j] !== 'Name') {
                        labels.push({
                            type: keys[j],
                            value: String(data[i][keys[j]])
                        });
                    }
                }
                newIncidents.push({
                    name: data[i].Name || ('New event from arcsight at ' + Date.now()),
                    labels: labels,
                    rawJSON: JSON.stringify(data[i])
                });
            }
        }

        lastRun.lastEventTime = maxEventTime;
        return newIncidents;
    }

    function convertRowsToStruct(fields, rows) {
        var data = [];
        for (var i = 0; i < rows.length; i++) {
            var newData = {};
            for (var j = 0; j < fields.length; j++) {
                if (rows[i].value[j]['#text']) {
                    newData[fields[j]] = rows[i].value[j]['#text'];
                }
            }
            data.push(newData);
        }
        return data;
    }

    function getCase() {
        var ccase = getCaseRequest(args.authToken, args.resourceId);

        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: ccase,
            ReadableContensFormat: formats.markdown,
            HumanReadable: tableToMarkdown('Case ' + args.resourceId, convertByMap(ccase, {
                'Name': 'name',
                'EventIDs': 'eventIDs',
                'Action': 'action',
                'Stage': 'stage',
                'CaseID': 'resourceid',
                'CreatedTime': 'createdTimestamp=Date(val)'
            })),
            EntryContext: {
              'ArcSightESM.Cases(val.resourceid===obj.resourceid)': ccase
            }
        };
    }

    function getCaseRequest(authToken, resourceId) {
        var reqArgs = {
            authToken: authToken,
            resourceId: resourceId
        };

        var res = sendRequest(pathDictionary['as-get-case'], reqArgs);
        var json = JSON.parse(res);
        if (json && json['cas.getResourceByIdResponse'] && json['cas.getResourceByIdResponse']['cas.return']) {
            return json['cas.getResourceByIdResponse']['cas.return'];
        }

        return null;
    }

    function dlog(obj) {
        try {
            log(JSON.stringify(obj, null, 2));
        } catch (err) {
            log(obj);
        }

    }

    function getMatrixData() {
        args.onlyColumns = args.onlyColumns === 'true' ? true : false;
        var results = getQueryViewerResultsRequest(args.authToken, args.id, args.onlyColumns);

        var entries = [{
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: results.columnHeaders,
            ReadableContensFormat: formats.markdown,
            HumanReadable: arrayToMarkdownTable(results.columnHeaders, 'Column Headers') // will print only query viewer column headers
        }];

        if (!args.onlyColumns) {
            entries.push({
                Type: entryTypes.note,
                ContentsFormat: formats.json,
                Contents: results.data,
                ReadableContensFormat: formats.markdown,
                HumanReadable: tableToMarkdown('Query Viewer Results: ' + args.id, results.data) // will print all the results table
            });
        }

        return entries;
    }

    function getQueryViewerResultsRequest(authToken, queryViewerId, includeOnlyHeaders) {
        var reqArgs = {
            authToken: authToken,
            id: queryViewerId
        };
        var json = JSON.parse(sendRequest(pathDictionary['as-get-matrix-data'], reqArgs));

        if (json && json['qvs.getMatrixDataResponse'] && json['qvs.getMatrixDataResponse']['qvs.return']) {
            var returnObject = json['qvs.getMatrixDataResponse']['qvs.return'];
            var columnHeaders = dq(returnObject, 'columnHeaders');
            if (columnHeaders && !Array.isArray(columnHeaders)) {
                columnHeaders = [columnHeaders];
            }
            if (includeOnlyHeaders) {
                return {
                    columnHeaders: columnHeaders
                };
            }

            if (!returnObject.rows || !Array.isArray(returnObject.rows) || returnObject.rows.length === 0) {
                // there are no results
                return {
                    columnHeaders: columnHeaders,
                    data: []
                };
            }

            if (!columnHeaders || !columnHeaders.length || columnHeaders.length === 0) {
                // no columns exists
                return {
                    columnHeaders: [],
                    data: []
                };
            }

            // we should parse the raws by column headers and create result objects from them
            var queryResults = [];
            for (var i = 0; i < returnObject.rows.length; i++) {
                var row = returnObject.rows[i].value;
                var qResult = {};
                for (var columnIdx = 0; columnIdx < columnHeaders.length; columnIdx++) {
                    column = columnHeaders[columnIdx];
                    qResult[column] = row[columnIdx]['$'];
                }
                queryResults.push(qResult);
            }

            return {
                columnHeaders: columnHeaders,
                data: queryResults
            };
        }

        return null;
    }

    function getAllCases() {
        var allCases = getAllCasesRequest(args.authToken);

        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: allCases,
            ReadableContensFormat: formats.markdown,
            HumanReadable: arrayToMarkdownTable(allCases, 'Case ID'),
            EntryContext: {
              'ArcSightESM.AllCaseIDs': allCases
            }
        };
    }

    function getAllCasesRequest(authToken) {
        var reqArgs = {
            authToken: authToken
        };

        var json = JSON.parse(sendRequest(pathDictionary['as-get-all-cases'], reqArgs));
        if (json && json['cas.findAllIdsResponse'] && json['cas.findAllIdsResponse']['cas.return']) {
            return json['cas.findAllIdsResponse']['cas.return'];
        }

        return null;
    }

    function getAllQueryViewers() {
        var json = JSON.parse(sendRequest(pathDictionary['as-get-all-query-viewers'], args));
        if (!json || !json['qvs.findAllIdsResponse'] || !json['qvs.findAllIdsResponse']['qvs.return']) {
            return null;
        }

        var queryList = json['qvs.findAllIdsResponse']['qvs.return'];
        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: queryList,
            ReadableContensFormat: formats.markdown,
            HumanReadable: arrayToMarkdownTable(queryList, 'Query Viewers'),
            EntryContext: {
                'ArcSightESM.AllQueryViewers': queryList
            }
        };
    }

    // convertCsvToEntryListObject converts entries which is array of entry objects into entryList object according to the SOAP request
    // entryList object contains separately the columns and the entries
    function convertCsvToEntryListObject(entries) {
        var entryList = [];
        var columns = [];
        var column;

        if (!entries || !Array.isArray(entries) || entries.length === 0) {
            return {
                columns: [],
                entryList: []
            };
        }

        // extract the columns
        for (column in entries[0]) {
            if (entries[0].hasOwnProperty(column)) {
                columns.push(column);
            }
        }

        // get the entries
        for (var i = 0; i < entries.length; i++) {
            entryRow = [];
            for (var j = 0; j < columns.length; j++) {
                column = columns[j];
                var innerEntryValue = entries[i][column];
                entryRow.push(innerEntryValue);
            }
            entryList.push(entryRow);
        }


        return {
            columns: columns,
            entryList: entryList
        };
    }

    function convertFromEntryListToJSON(entryList) {
        var columns = entryList.return.columns;
        var entries = entryList.return.entryList;

        if (!entries) {
            return [];
        }

        // if there is only single column in columns then columns will be parsed as string instead of array
        // the algorithm requires columns to be array
        if (columns && !Array.isArray(columns)) {
            columns = [columns];
            for (var k = 0; k < entries.length; k++) {
                entries[k].entry = [entries[k].entry];
            }
        }

        var entriesArray = [];
        for (var i = 0; i < entries.length; i++) {
            var newEntry = {};
            for (var columnIdx = 0; columnIdx < columns.length; columnIdx++) {
                var column = columns[columnIdx];

                var innerEntry = entries[i].entry[columnIdx];
                newEntry[column] = innerEntry;
            }

            entriesArray.push(newEntry);
        }

        return entriesArray;
    }


    var addEntriesTemplate = '<?xml version="1.0" encoding="UTF-8"?><soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:act="http://ws.v1.service.resource.manager.product.arcsight.com/activeListService/" xmlns:xsd="http://activelist.model.v1.service.resource.manager.product.arcsight.com/xsd"><soapenv:Header /><soapenv:Body><act:addEntries><act:authToken>%authToken%</act:authToken><act:resourceId>%resourceId%</act:resourceId><act:entryList>%entryList%</act:entryList></act:addEntries></soapenv:Body></soapenv:Envelope>';

    function addEntries() {
        var entries;
        if (typeof args.entries === 'string') {
            try {
                entries = JSON.parse(args.entries);
            } catch (err) {
                throw 'entries must be in JSON format. Must be array of objects.'
            }
        }
        var entryList = convertCsvToEntryListObject(entries)
        var stringBuilder = [];
        entryList.columns.forEach(function(column) {
            stringBuilder.push(replaceInTemplates('<columns>%column%</columns>', {
                column: column
            }));
        });

        entryList.entryList.forEach(function(entryRow) {
            stringBuilder.push('<entryList>');
            entryRow.forEach(function(entry) {
                stringBuilder.push(replaceInTemplates('<entry>%entry%</entry>', {
                    entry: entry
                }));
            })
            stringBuilder.push('</entryList>');
        });

        var entryListXml = stringBuilder.join('');
        var soapReq = replaceInTemplates(addEntriesTemplate, {
            authToken: args.authToken,
            resourceId: args.resourceId,
            entryList: entryListXml
        });
        sendSOAPRequest('www/manager-service/services/ActiveListService/', null, soapReq);
        return 'Success';
    }

    var clearEntriesTemplate = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:act="http://ws.v1.service.resource.manager.product.arcsight.com/activeListService/"><soapenv:Header/><soapenv:Body><act:clearEntries><act:authToken>%authToken%</act:authToken><act:resourceId>%resourceId%</act:resourceId></act:clearEntries></soapenv:Body></soapenv:Envelope>';

    function clearEntries() {
        var soapReq = replaceInTemplates(clearEntriesTemplate, {
            authToken: args.authToken,
            resourceId: args.resourceId
        });
        var res = sendSOAPRequest('www/manager-service/services/ActiveListService/', null, soapReq);
        return 'Success';
    }

    var getEntriesTemplate = '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:act="http://ws.v1.service.resource.manager.product.arcsight.com/activeListService/">\
    <soapenv:Header/>\
    <soapenv:Body>\
    <act:getEntries>\
    <act:authToken>%authToken%</act:authToken>\
    <act:resourceId>%resourceId%</act:resourceId>\
    </act:getEntries>\
    </soapenv:Body>\
    </soapenv:Envelope>';

    function getEntries() {
        var soapReq = replaceInTemplates(getEntriesTemplate, {
            authToken: args.authToken,
            resourceId: args.resourceId
        });
        var res = sendSOAPRequest('www/manager-service/services/ActiveListService/', null, soapReq);

        var parsedResponse = parseSOAPResponse(res.Body);
        var entryArray = convertFromEntryListToJSON(parsedResponse);

        // get the column headers which exists in Active List
        var columns = dq(parsedResponse, 'return.columns');
        if (columns && !Array.isArray(columns)) {
          columns = [columns];
        }

        if (args.entryFilter) {
            var filteredEntries = [];
            var conditions = args.entryFilter.split(':');
            var conditionKey = conditions[0]; // moo
            var conditionValue = conditions[1]; // moo1

            for (var i = 0; i < entryArray.length; i++) {
                var entry = entryArray[i];

                if (entry[conditionKey] === conditionValue) {
                    filteredEntries.push(entry);
                }
            }
            entryArray = filteredEntries;
        }

        var entryContext = {};
        entryContext['ArcSightESM.ActiveList.' + args.resourceId] = entryArray;
        return [
          {
              Type: entryTypes.note,
              ContentsFormat: formats.json,
              Contents: {
                  columns: columns
              },
              ReadableContentsFormat: formats.markdown,
              HumanReadable: columns ? arrayToMarkdownTable(columns, 'Columns') : 'Active list has no columns'
          },
          {
              Type: entryTypes.note,
              ContentsFormat: formats.json,
              Contents: {
                  result: entryArray
              },
              ReadableContentsFormat: formats.markdown,
              HumanReadable: (!entryArray || entryArray.length) ? tableToMarkdown('Active List Entries: ' + args.resourceId, entryArray) : 'Active List has no entries',
              EntryContext: entryContext
          }
        ];
    }


    function getCaseEventIDs() {
        var json = JSON.parse(sendRequest(pathDictionary['as-get-case-event-ids'], args));
        if (!json || !json['cas.getCaseEventIDsResponse'] || !json['cas.getCaseEventIDsResponse']['cas.return']) {
            return null;
        }

        var eventIds = json['cas.getCaseEventIDsResponse']['cas.return'];
        if (!eventIds) {
            // case has no events
            return null;
        }

        if (!Array.isArray(eventIds)) {
            eventIds = [eventIds];
        }
        var entryContext = {};
        entryContext['ArcSightESM.CaseEvents'] = eventIds;
        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: json,
            ReadableContentsFormat: formats.markdown,
            HumanReadable: arrayToMarkdownTable(eventIds, 'Case ' + args.caseId + ' Event IDs'),
            EntryContext: entryContext
        };
    }

    function updateCase() {
        var currentCase = getCaseRequest(args.authToken, args.caseId);
        if (!currentCase) {
            throw 'There is no such case: ' + args.caseId;
        }

        var updatedCase = currentCase;
        updatedCase.stage = args.stage;
        var soapReq = {
            'cas.update': {
                'cas.authToken': args.authToken,
                'cas.resource': updatedCase
            }
        };

        logDebug('ArcSight: updateCase: sending POST request. soapReq=' + JSON.stringify(updatedCase));
        try {
            var res = postRestRequest('www/manager-service/rest/CaseService/update', null, soapReq);
        } catch (err) {
            throw 'soapReq: ' + soapReq + '\n' + err;
        }
        logDebug('ArcSight: updateCase: got POST request ');
        // creating human readable table
        var response = JSON.parse(res.Body);

        if (!response || !response['cas.updateResponse'] || !response['cas.updateResponse']['cas.return']) {
            return null;
        }

        var responseUpdatedCase = response['cas.updateResponse']['cas.return'];
        var entryContext = {};
        entryContext['ArcSightESM.Cases(val.resourceid===obj.resourceid)'] = responseUpdatedCase;
        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: responseUpdatedCase,
            ReadableContensFormat: formats.markdown,
            HumanReadable: tableToMarkdown('Case ' + args.caseId, convertByMap(responseUpdatedCase, {
                'Name': 'name',
                'EventIDs': 'eventIDs',
                'Action': 'action',
                'Stage': 'stage',
                'CaseID': 'resourceid',
                'CreatedTime': 'createdTimestamp=Date(val)'
            })),
            EntryContext: entryContext
        };
    }

    function deleteCase() {
        var reqBody = {
            'cas.deleteByUUID': {
                'cas.authToken': args.authToken,
                'cas.id': args.caseId
            }
        };

        try {
            var res = postRestRequest('www/manager-service/rest/CaseService/deleteByUUID', null, reqBody);
        } catch (err) {
            throw 'soapReq: ' + reqBody + '\n' + err;
        }

        throw res;
    }

    var intToIpDT = ';function intToIP(int){ var part1 = int & 255; var part2 = ((int >> 8) & 255); var part3 = ((int >> 16) & 255); var part4 = ((int >> 24) & 255); return part4 + "." + part3 + "." + part2 + "." + part1; };';


    function getSecurityEvents() {
        var events = getSecurityEventsRequest(args.authToken, args.ids, args.startDate, args.endDate);
        var hr = 'No events found';
        if (events) {
            hr = tableToMarkdown('Security Event: ' + args.ids, convertByMap(events, eventTranslateMap))
        }

        var entryContext = {};
        entryContext['ArcSightESM.SecurityEvents(val.eventId===obj.eventId)'] = events;
        return {
            Type: entryTypes.note,
            ContentsFormat: formats.json,
            Contents: { events: events },
            ReadableContentsFormat: formats.markdown,
            HumanReadable: hr,
            EntryContext: entryContext
        };
    }

    function getSecurityEventsRequest(authToken, ids, startDate, endDate) {
        var startMillis = -1;
        if (startDate) {
            if (isNaN(Date.parse(startDate))) {
                throw 'startDate must be of format yyyy-mm-ddTHH:MM:SS. Example: 2015-09-22T10:00:00';
            }
            startMillis = new Date(startDate).getTime();
        }
        var endMillis = -1;
        if (endDate) {
            if (isNaN(Date.parse(endDate))) {
                throw 'endDate must be of format yyyy-mm-ddTHH:MM:SS. Example: 2015-09-22T10:00:00';
            }
            endMillis = new Date(endDate).getTime();
        }

        var arrIDs = [];
        if (typeof ids === 'string') {
          var split = ids.split(',');
          for (var i = 0; i < split.length; i++) {
              var id = split[i];
              if (isNaN(id)) {
                  throw 'id ' + id + ' must be numeric';
              }
              arrIDs.push(parseInt(id));
          }
        } else if (typeof ids === 'number') {
          // ids passed as number
          // so there only single id
          arrIDs.push(ids);
        }

        var soapReq = {
            'sev.getSecurityEvents': {
                'sev.authToken': authToken,
                'sev.ids': arrIDs,
                'sev.startMillis': startMillis,
                'sev.endMillis': endMillis
            }
        };
        var res = postRestRequest('www/manager-service/rest/SecurityEventService/getSecurityEvents', null, soapReq);

        // creating human readable table
        var json = JSON.parse(res.Body);
        if (!json || !json['sev.getSecurityEventsResponse'] || !json['sev.getSecurityEventsResponse']['sev.return']) {
            return null;
        }

        var events = json['sev.getSecurityEventsResponse']['sev.return'];

        if (!Array.isArray(events)) {
            events = [events];
        }

        return events;
    }


    var dashboardDataTemplateWithEnv = '<soapenv:Envelope xmlns:soapenv=\'http://schemas.xmlsoap.org/soap/envelope/\'  xmlns:ns2=\'http://ws.v1.service.resource.manager.product.arcsight.com/dashboardService/\'  xmlns:ns5=\'http://model.v1.service.resource.manager.product.arcsight.com/xsd\'>\
                                        <soapenv:Header/>\
                                        <soapenv:Body>\
                                          <ns2:getDashboardIfNewer>\
                                            <ns2:authToken>%authToken%</ns2:authToken>\
                                            <ns2:id>%monitorID%</ns2:id>\
                                            <ns2:currentSignature>\
                                                <ns5:id>%monitorID%</ns5:id>\
                                                <ns5:modificationCount>%modificationCount%</ns5:modificationCount>\
                                            </ns2:currentSignature>\
                                          </ns2:getDashboardIfNewer>\
                                        </soapenv:Body>\
                                      </soapenv:Envelope>';

    // currently this function is not works
    function getDashboardData(authToken, modCount, monitorID) {
        var soapReq = replaceInTemplates(dashboardDataTemplateWithEnv, {
            authToken: authToken,
            modificationCount: modCount,
            monitorID: monitorID
        });
        //return soapReq;
        var res = postRestRequest('www/manager-service/services/DashboardService/', null, soapReq);
        return res.Body;
    }


    var monitorDataTemplateWithEnv = '<soapenv:Envelope xmlns:soapenv=\'http://schemas.xmlsoap.org/soap/envelope/\'  xmlns:ns2=\'http://ws.v1.service.resource.manager.product.arcsight.com/dataMonitorService/\'  xmlns:ns5=\'http://model.v1.service.resource.manager.product.arcsight.com/xsd\'>\
                                      <soapenv:Header/>\
                                      <soapenv:Body>\
                                        <ns2:getDataMonitorIfNewer>\
                                          <ns2:authToken>%authToken%</ns2:authToken>\
                                          <ns2:id>%monitorID%</ns2:id>\
                                          <ns2:currentSignature>\
                                            <ns5:id>%monitorID%</ns5:id>\
                                            <ns5:modificationCount>%modificationCount%</ns5:modificationCount>\
                                          </ns2:currentSignature>\
                                        </ns2:getDataMonitorIfNewer>\
                                      </soapenv:Body>\
                                    </soapenv:Envelope>';

    function getDataMonitor(authToken, modCount, monitorID) {
        var soapReq = replaceInTemplates(monitorDataTemplateWithEnv, {
            authToken: authToken,
            modificationCount: modCount,
            monitorID: monitorID
        });
        var res = postRestRequest('www/manager-service/services/DataMonitorService/', null, soapReq);
        return res.Body;
    }

    function test() {
        var isFetch = params.isFetch;
        if (isFetch && !params.viewerId && !params.casesQueryViewerId) {
            throw 'If Fetch incidents is on, then Events Query Viewer ID or Case Query Viewer ID must be passed';
        }

        var results;
        var columnHeaders
        if (isFetch && params.viewerId) {
            try {
                results = getQueryViewerResultsRequest(args.authToken, params.viewerId, true);
            } catch(ex) {
                throw 'Make sure Events query viewer id is valid.\nOriginal Error: ' + ex;
            }
            columnHeaders = results.columnHeaders;
            if (columnHeaders.indexOf(eventsTimeField) === -1) {
                throw 'Event Query in ArcSight must select "' + eventsTimeField + '" field';
            }
            if (columnHeaders.indexOf(eventIdField) === -1) {
                throw 'Event Query in ArcSight  must select "' + eventIdField + '" field';
            }
        }

        if (isFetch && params.casesQueryViewerId) {
            try {
                results = getQueryViewerResultsRequest(args.authToken, params.casesQueryViewerId, true);
            } catch(ex) {
                throw 'Make sure Cases query viewer id is valid.\nOriginal Error: ' + ex;
            }
            columnHeaders = results.columnHeaders;
            if (columnHeaders.indexOf(casesTimeField) === -1) {
                throw 'Case Query in ArcSight must select "' + casesTimeField + '" field';
            }
            if (columnHeaders.indexOf(caseIdField) === -1) {
                throw 'Case Query in ArcSight must select "' + caseIdField + '" field';
            }
        }
    }

    var result;
    args.authToken = getToken();
    switch (command) {
        case 'test-module':
            test();
            result = 'ok';
            break;
        case 'fetch-incidents':
            var lastRun = getLastRun();
            lastRun = lastRun && lastRun.value ? JSON.parse(lastRun.value) : {};
            var casesIncidents = [];
            var eventsIncidents = [];
            if (params.casesQueryViewerId) {
                casesIncidents = getCasesIncidents(lastRun);
            }
            if (params.viewerId) {
                eventsIncidents = getEventsIncidents(lastRun);
            }

            setLastRun({
                value: JSON.stringify(lastRun)
            });
            result = JSON.stringify(casesIncidents.concat(eventsIncidents));
            break;
        case 'as-get-matrix-data':
            result = getMatrixData();
            break;
        case 'as-get-all-cases':
            result = getAllCases();
            break;
        case 'as-get-all-query-viewers':
            result = getAllQueryViewers();
            break;
        case 'as-get-case':
            result = getCase();
            break;
        case 'as-add-entries':
            result = addEntries();
            break;
        case 'as-clear-entries':
            result = clearEntries();
            break;
        case 'as-get-entries':
            result = getEntries();
            break;
        case 'as-get-security-events':
            result = getSecurityEvents();
            break;
        case 'as-get-case-event-ids':
            result = getCaseEventIDs();
            break;
        case 'as-update-case':
            result = updateCase();
            break;
        case 'as-get-all-queryviewer-cases':
            result = getAllQueryViewerCases();
            break;
        case 'as-case-delete':
            result = deleteCase();
            break;
        default:
            result = sendAndParse(command, pathDictionary[command], args);
    }
    logout();
    return result;
  type: javascript
  commands:
  - name: as-get-all-cases
    arguments: []
    outputs:
    - contextPath: ArcSightESM.AllCaseIDs
      description: All cases ids
    description: commands.server.arcsight.getallcases.description
  - name: as-get-case
    arguments:
    - name: resourceId
      required: true
      default: true
      description: commands.server.arcsight.arguments.caseid.description
    outputs:
    - contextPath: ArcSightESM.Cases.resourceid
      description: The id of the case
    - contextPath: ArcSightESM.Cases.name
      description: Name of the case
    - contextPath: ArcSightESM.Cases.eventIDs
      description: Related base event ids
    - contextPath: ArcSightESM.Cases.createdTimestamp
      description: The time case created
    description: commands.server.arcsight.getspecificcase.description
  - name: as-get-matrix-data
    arguments:
    - name: id
      required: true
      default: true
      description: commands.server.arcsight.arguments.queryid.description
    - name: onlyColumns
      auto: PREDEFINED
      predefined:
      - "true"
      - "false"
      defaultValue: "true"
    description: commands.server.arcsight.query.description
  - name: as-add-entries
    arguments:
    - name: resourceId
      required: true
      description: resource id of the Active list
    - name: entries
      required: true
      description: 'Entries in JSON format. JSON must be array of entries. Each entry
        must contain the same columns like in the Active list. Example: [{ "UserName":
        "john", "IP":"19.12.13.11"},{ "UserName": "bob", "IP":"22.22.22.22"}]'
      isArray: true
    description: Add new entries to Active List
    execution: true
  - name: as-clear-entries
    arguments:
    - name: resourceId
      required: true
      description: resource id of Active list
    description: Clean all entries in the Active List
    execution: true
  - name: as-get-entries
    arguments:
    - name: resourceId
      required: true
      description: resource id of Active list
    - name: entryFilter
      description: 'Filters the entries. Example: entryFilter="moo:moo1"'
    outputs:
    - contextPath: ArcSightESM.ActiveList
      description: Active List is a map of active list resource id => active list
        entries
    description: Get all entries from Active List
  - name: as-get-security-events
    arguments:
    - name: startDate
      description: 'Start time filter. Example: 2017-05-22T10:00:00'
    - name: endDate
      description: 'End time filter. Example: 2017-05-22T10:00:00'
    - name: ids
      required: true
    outputs:
    - contextPath: ArcSightESM.SecurityEvents
      description: List of security events
    - contextPath: ArcSightESM.SecurityEvents.name
      description: The name of the event
    - contextPath: ArcSightESM.SecurityEvents.eventId
      description: Event id
    - contextPath: ArcSightESM.SecurityEvents.type
      description: Type of the event
    - contextPath: ArcSightESM.SecurityEvents.baseEventIds
      description: Base event ids
    - contextPath: ArcSightESM.SecurityEvents.startTime
      description: Start time in milliseconds
    description: Returns the security event details
  - name: as-get-case-event-ids
    arguments:
    - name: caseId
      required: true
    outputs:
    - contextPath: ArcSightESM.CaseEvents
      description: Map of caseId => related event ids
    - contextPath: ArcSightESM.CaseEvents.LatestResult
      description: Event ids of the last execution of this command
    description: Returns all case event IDs
  - name: as-update-case
    arguments:
    - name: caseId
      required: true
      description: The ID of the case
    - name: stage
      auto: PREDEFINED
      predefined:
      - CLOSED
      - QUEUED
      - FINAL
      - FOLLOW_UP
      - INITIAL
      description: The stage of case
    outputs:
    - contextPath: ArcSightESM.Cases
      description: List of cases
    description: Updates a case
  - name: as-get-all-query-viewers
    arguments: []
    outputs:
    - contextPath: ArcSightESM.AllQueryViewers
      description: List of all query viewer ids
    description: Returns all the query viewer ids
  - name: as-case-delete
    arguments:
    - name: caseId
      required: true
      description: The resource id of the case
    description: Deletes a case
    execution: true
  - name: as-get-all-queryviewer-cases
    arguments:
    - name: QueryViewerId
      description: QueryViewerID
    description: 'Get all QueryViewer cases '
  isfetch: true
  runonce: false
