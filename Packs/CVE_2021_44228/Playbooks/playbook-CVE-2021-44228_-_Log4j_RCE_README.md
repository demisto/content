Critical RCE Vulnerability: log4j - CVE-2021-44228

On Dec. 9, 2021, a remote code execution (RCE) vulnerability in Apache log4j 2 was identified being exploited in the wild. Public proof of concept (PoC) code was released and subsequent investigation revealed that exploitation was incredibly easy to perform. 

On Dec. 14 2021, another vulnerability was discovered related the log4j 0-day exploit known as CVE-2021-45046.

On Dec 18 2021, yet another vulnerability was discovered related the log4j 0-day exploit known as CVE-2021-45105 that allows an attacker with control over Thread Context Map data to cause a denial of service when a crafted string is interpreted. This issue was fixed in Log4j 2.17.0 and 2.12.3.

**Affected Version**

Apache Log4j 2.x <= 2.15.0-rc1

**The playbook includes the following tasks:**

* Collecting Indicators - related known indicators from several sources.
* Investigation and Hunting - indicators and exploitation patterns hunting using PAN-OS, Cortex XDR and SIEM products.
* Search for potentially vulnerable servers using Xpanse.
* Remediation - Blocking indicators automatically or manually based on **playbook inputs**.
* Mitigations:
    * Apache official CVE-2021-44228, CVE-2021-45046 patch.
    * Unit42 recommended mitigations.
    * Detection rules for.
        * Snort
        * Suricata
        * Sigma
        * Yara

**How to Use The Playbook**
1. Create a new incident with the incident type "Rapid Breach Response" and choose the "CVE-2021-44228 - Log4j RCE" playbook.
    1. The playbook can be configured as a job as newer indicators might be pulled in. Just create a new job with the incident type and playbook mentioned above.
2. Look and change the playbook inputs. For example, 
    1. To run the shell scripts on XDR endpoints - you will need to change "XDRScriptExecution" and the "XDREndpointIDs" playbook inputs. Note that running the scripts on **all** XDR connected linux endpoints might impact performance on the XDR (depending on number of endpoints).
    2. Change the SIEM search time frame as requested (default is 1 day). If you are using Splunk , you can change the index by changing the "SplunkSourcetype" playbook input.
    3. To block indicators automatically - change the playbook input "BlockIndicatorsAutomatically" to "True".

Read more about the vulnerability on our Unit 42 blog:
[Apache Log4j Vulnerability Is Actively Exploited in the Wild (CVE-2021-44228)](https://unit42.paloaltonetworks.com/apache-log4j-vulnerability-cve-2021-44228/)

Note: This is a beta playbook, which lets you implement and test pre-release software. Since the playbook is beta, it might contain bugs. Updates to the pack during the beta phase might include non-backward compatible features. We appreciate your feedback on the quality and usability of the pack to help us identify issues, fix them, and continually improve.

## Dependencies
This playbook uses the following sub-playbooks, integrations, and scripts.

### Sub-playbooks
* Hunt /var/log for exploitation patterns - Uncompressed
* PAN-OS - Block Domain - External Dynamic List
* Rapid Breach Response - Set Incident Info
* QRadarFullSearch
* QRadar Indicator Hunting V2
* Block Indicators - Generic v2
* Hunt /var/log for exploitation patterns - Compressed
* Splunk Indicator Hunting
* Panorama Query Logs for Related Session
* Palo Alto Networks - Hunting And Threat Detection

### Integrations
This playbook does not use any integrations.

### Scripts
* http
* ParseHTMLIndicators
* QRadarCreateAQLQuery
* IsIntegrationAvailable

### Commands
* xdr-xql-generic-query
* xdr-get-endpoints
* associateIndicatorsToIncident
* createNewIndicator
* closeInvestigation
* xdr-get-endpoints
* splunk-search
* extractIndicators

## Playbook Inputs
---

| **Name** | **Description** | **Default Value** | **Required** |
| --- | --- | --- | --- |
| SplunkIndex | The Splunk index field to search in.<br/>Default is "\*" | * | Optional |
| SplunkSourcetype | The Splunk sourcetype field to search in.<br/>Default is "\*" | * | Optional |
| SplunkEarliestTime | The earliest time for Splunk query. | -1d@d | Optional |
| QRadarTimeRange | The time range for QRadar query. | Last 1 DAYS | Optional |
| XDRScriptExecution | Whether to investigate automatically the endpoint logs "/var/log" using XDR Endpoint Script Execution or manually. | False | Optional |
| XDREndpointIDs | The Endpoint IDs to search using XDR Endpoint Script Execution in a comma delimited format. If you would like the playbook to execute the command on all known Linux OS endpoints Set to "ALL". |  | Optional |
| PlaybookDescription | The playbook description for Rapid Breach Response layout. | Critical RCE Vulnerability: log4j - CVE-2021-44228<br/><br/>On Dec. 9, 2021, a remote code execution (RCE) vulnerability in Apache log4j 2 was identified being exploited in the wild. Public proof of concept (PoC) code was released and subsequent investigation revealed that exploitation was incredibly easy to perform. <br/><br/>Affected Version<br/>Apache Log4j 2.x &lt;= 2.15.0-rc1<br/><br/>This playbook should be trigger manually and includes the following tasks: <br/><br/>* Collect related known indicators from several sources.<br/>* Indicators and exploitation patterns hunting using PAN-OS, Cortex XDR and SIEM products.<br/>* Block indicators automatically or manually.<br/><br/>Mitigations:<br/>* Apache official CVE-2021-44228 patch.<br/>* Unit42 recommended mitigations.<br/><br/>More information:<br/>[Apache Log4j Vulnerability Is Actively Exploited in the Wild (CVE-2021-44228)](https://unit42.paloaltonetworks.com/apache-log4j-vulnerability-cve-2021-44228/)<br/><br/>Note: This is a beta playbook, which lets you implement and test pre-release software. Since the playbook is beta, it might contain bugs. Updates to the pack during the beta phase might include non-backward compatible features. We appreciate your feedback on the quality and usability of the pack to help us identify issues, fix them, and continually improve. | Optional |
| EDLDomainBlocklist | The EDL domain blocklist name. |  | Optional |
| BlockIndicatorsAutomatically | Whether to block the indicators automatically or not. | False | Optional |
| CollectedIndicatorsSeverity | The verdict of the collected indicators. Default is "Malicious". <br/>Other options can be "Suspicious" and "Unknown". | Malicious | Optional |
| RunXQLHuntingQueries | Whether to perform XQL hunting queries. Default is "False". | False | Optional |

## Playbook Outputs
---
There are no outputs for this playbook.

## Playbook Image
---
![CVE-2021-44228 - Log4j RCE1](https://raw.githubusercontent.com/demisto/content/0f7c54d47da9839926275b15bc3d950db35bd3e6/Packs/CVE_2021_44228/doc_files/CVE-2021-44228_-_Log4j_RCE.png)