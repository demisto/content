commonfields:
  id: IAMGetOktaInstances
  version: -1
name: IAMGetOktaInstances
script: |
  def to_cli_name(field_name):
      return field_name.lower().replace(' ', '')

  OKTA_INSTANCE_FIELD = to_cli_name('Okta IAM Instance')

  incident = demisto.incidents()[0]
  instances = []
  all_instances = demisto.getModules()
  for instance_name, details in all_instances.items():
      if details.get('brand') == 'Okta IAM' and details.get('state') == 'active':
          instances.append(instance_name)

  if len(instances) == 1:
      incident_data = {'id': incident.get('id'), 'customFields': {OKTA_INSTANCE_FIELD: instances[0]}}
      demisto.executeCommand('setIncident', incident_data)

  demisto.results({"hidden": False, "options": sorted(instances)})
type: python
tags:
- field-display
comment: Updates "Okta IAM Instance" field with the list of Okta IAM instances.
enabled: true
args:
- name: incident
  description: Incident object
- name: field
  description: Field definition object
scripttarget: 0
subtype: python3
dockerimage: demisto/python3:3.9.8.24399
runonce: false
runas: DBotWeakRole
fromversion: 6.0.0
tests:
- No tests (auto formatted)
