commonfields:
  id: AlphaSOC Network Behavior Analytics
  version: -1
name: AlphaSOC Network Behavior Analytics
display: AlphaSOC Network Behavior Analytics
category: Analytics & SIEM
image: data:image/png;base64,R0lGODdhkAGQAZEAAAAAADGq4f///wAAACH5BAkAAAMALAAAAACQAZABAAL/nI+py+0Po5y02ouz3rz7D4biSJbmiabqyrbuC8fyTNf2jef6zvf+DwwKh8Si8YhMKpfMpvMJjUqn1Kr1is1qt9yu9wsOi8fksvmMTqvX7Lb7DY/L5/S6/Y7P6/f8vv8PGCg4SFhoeIiYqLjI2Oj4CBkpOUlZaXmJmam5ydnp+QkaKjpKWmp6ipqqusra6voKGys7S1tre4ubOxTA2+v7Cxzsq3srbHyMHEy8mtzs/BywHApNXZ0sjWmtvX2MHckNHq7sjShufv5LPojO3q7e1x4fDyZfn12Pz96VL1/J/49uC8CAkwYaNIflIMJvChuCs+Lw4aOIFLlRqajNEcaN/9amcITW6KNIalBGOltkMuVJJyqRKWoJs1uTmMLK0bw5TgnOYYZ2+kyX5CevnkKLBhVKqKjSoUeQrlu6tOlPQVCrRiNiFJBVq1id+tkKVohXPmCZXhgJJCvZqiMwph2bB2oKij/UxrW7wqEPuHaUzmjIA28dwTIO7iAsh68NgzoQw5m6d2AOxXEgv/13w7Ebn0YALqa8eScSzDU0rxG9hF9py4lxssz3F/Rp109UxzCNBnUUfIVZv9EthTcM2blpVxHeAncZ4Mf7uVA+hjlE5yyILzeuxV5132o476OOAjo96dnnqRDvxft4d3O5F79Jxnx492bUi5FfAj0X+/fxt/+1/gV/0bGXH30DktefPgUKeB12Z/j3gX5ZMFifgiJIeIWB8REIAoD7UfighR1qGCCIIRIUoYflIZgGhx2oOCGJJ54zoonp2dgiii/KKBCPMy7EAYYX4didiBnAmKGPOdIYpJJJEjmbjhgg2RyUUQI5JZUeafljOBpwGZyTV4rzpZhDmlkkk2ehuRuYS5K5JpslufkelhPQOZOQY0pUAZ5M6LmnRRb4qROggW7TJ6FHyRkanHcymqeidXr5qJVnQtqGmhFIKhWmmWrqAKedGfqbnQ2IWoRfhUjJAKq7qLqqqQu4Khapj4GqAK1BRGWTo616uqiukyIaKrCj2dqarwn/INupsG8KOquxzUp7q7IHONuDXIzIOgC2gcGKkrXdensYuOFSigC5jfEakrXqTsZuu+ga8C4O2mrkK7Opxosvn+Na2qa58vJZb2b8DgxtwasdjDCiCi8scMMZPUzDvZKQSXFvDPdb1ko3bsxxxzKVCLLEIgMTBluWnOwSyREzxHJNLusLT8wor/cyzDb3krLF/uzM08clQwI0zzPTXDPQPfu8stI4I/2V00dTq9XOT0MddcxLD32xzVvn/DPLX2OdtcgJcl3QyWNnXJnaV7NdbcdrU/1UWWeDfYnZcwNMtNx7s5iJ31PD3fZWd+N9D1d/Ax644Ys76ElYj8M3iuKT/8dUiuVv000U0x+qTIrnn4seOdrTgR464k+SXjrZtaJeueuvs94632HCHjvnXeEuiuy7ap677bfTzonvv/MOivF1OZ454RojXzvjK0LfifLLU1+988+b3rjuuxOvifXXg9+98MNzn7f226tePuSXY5669/tiH77664uftPnns5++/vvjvwcARoZ+ifNfwMjXNPnND4Fhk953CNg/B44OfWlT4AIp2DULfg+DOnPfgRhYQQlOkH8hFGGPIEgJ+0GMgxPR4AVJmEETnhCEfXPhBmFYQxnOkIUmgwkbmBc9yqWJhiHz4IZQ2EEhDpGH59LhDnFYRJp8CoktNODqoLgtG/9OS4B0UKG9qBhF+E2RiYnQ4ha9WCErXpGLyXLiA8l4CDQajIhNVOIY4ZgUM55RjoeTYtzwWDcjPguLvRLkIPm4OR+2kZCdM+Qh9fhHPy6SjXe0Y6no2EhHDguRQrPkJQFZNTe+ryXt8+QnKXkoUvYFk3kUZR/V+AdIpoaVVIHlGxkZCFnOkpah1OQPeVk2X6ZSmHG0ZSc5GSNXHhGXwTTlJHXZJTHehZn5c+YcgLkWZTYIldu05jWxOU1iVhKay5RkNrn5SlVWk5zpVEksQXkHdr6GmnhA5zyRuSV5Rgqf/zNnAOH5TXv+CaDPFGej+HlPhA5QoQOlZzeNWTiHflD/n9OT6EQhelCLtlOahSRoIv2ZSY9+VJFlBOI/GbpHjY6UpCEFZzm1GVHg6UGlj3TpRtUZK8Ht8hoLwugmZXqsZpiApmnU205b1lOYjtOkQeVpUg0aULEddWQkEGg/JVcooZ7AqrWx2lSNMR+KdtWrwULqUMW6T6+V1axPBek5yToqj50VrVkt2lrBeh663lWtcXVqWJX6UKm9EK959ekx7dpXtm5Vr4NF7A2p2h7A3lQk/5rX8bSaF8bOzo+4Gp9fCwvVn7qzspb1rGL/6s1TSrOz33rGCzRrWpyS1l8L/WxmJTtCls4WWrEl7HNw+0TZ7pa3rZVrcgxbJbcOl1jZ/wLJbYCbEA8aCV7OfW5oV/qRU013jq69n3CXmpJibbdiJCFvaqM5Wu2O17uQHQ50r2oSCEAoNuU1r3Jrihb5zte91eAuR5eoW/Wudzsd+cx5R1mRSrnotQX2b4DRG18FL5jA/aXuf4v64Acg57gZsfCFL/pdDW84ssz94n2xy5E4aYfEHS7XiQ8b3izBZrG09XB6X3rjQXnmP+JycI5R7JYy7ThF3DLxh4Mb4w0YRskTXteRKxriRClEyuCp7Y+RHOEmFa29zX1ycjMs4y3f7FVg/nKUwyzmoG32ymZms5DTbLTG5je6Lz4SnOMsZ8qu0c1avvNe9dzmJPMYzl+dM/98Ad1WwTaVz382dKLh2ugUz6nOHvBzQgVd6CyzWNGZzm5DvXwhMR96I532NIcdO+kydxnUj9bpAc/sYla32m6ng7WPGb1po9ba1vSVNWrdRmdVW5fStwV2Mn2da15TWNfHRnZV38tkY+cW18+Gdp+xOjhqE9na12bqLQ+M5usuG4yXUqNIB03uQCvJ21YmaqTvrGwbc/XW8NZ2cect73o7OqXExrG+g/xp5Obz3wlONbcHTvApj1rTg0k4Y9SN6Xg6fMQQR/RJJ87aipO6lhgnLpY33sqOd3eyCi+pyH3r74hU8eRXAbDKk0jwSJa8gYTu4svrx+mGPzx5rn7rik17ge9Xs4oZEa9jjWmx5E20+B2/kpksgML0qEt96lSvutWvjvWsa33rXO+6178O9rCLfexkL7vZz472tKt97Wxvu9vfDve4y33udK+73e+O97zrfe9877vf/w74wAt+8IQvvOEPj/jEK37xjG+84x8P+chLfvKUr7zlKVAAADs=
description: Retrieve alerts from the AlphaSOC Analytics Engine
detaileddescription: |-
  Not using the AlphaSOC Analytics Engine?
  Review the deployment options at [https://www.alphasoc.com](https://www.alphasoc.com)
configuration:
- display: AlphaSOC Analytics Engine URL
  name: server
  defaultvalue: https://api.alphasoc.net
  type: 0
  required: true
- display: AlphaSOC API Key
  name: APIKey
  defaultvalue: ""
  type: 4
  required: true
- display: Ignore events below severity
  name: severity
  defaultvalue: "4"
  additionalinfo: "AlphaSOC alert severity: (1) info, (2) low, (3) medium, (4) high, (5) critical"
  type: 0
  required: true
- display: Include policy violations
  name: policy
  defaultvalue: "true"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
- display: Trust any certificate (not secure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Fetch incidents
  name: isFetch
  type: 8
  required: false
- display: Incident type
  name: incidentType
  type: 13
  required: false
script:
  script: >
    var API_PATH_ALERTS = '/v1/alerts';


    var SERVER = params.server.replace(/[\/]+$/, '');

    var API_KEY = params.APIKey;


    var INSECURE = params.insecure;

    var PROXY = params.proxy;


    var INCLUDE_POLICY = params.policy;

    var SEVERITY = params.severity;


    function sendRequest(requestUrl) {
        logInfo('Sending HTTP request to: ' + requestUrl);

        var response = http(
            requestUrl,
            {
                Method: 'GET',
                Headers: {
                    Authorization: ['Basic ' + btoa(API_KEY + ':')],
                    Accept: ['application/json']
                }
            },
            INSECURE,
            PROXY
        );

        var errorString = validateRequestResponse(requestUrl, response);
        if (errorString) {
            throw errorString;
        }

        try {
            return JSON.parse(response.Body);
        } catch (err) {
            throw 'Failed to parse JSON response: ' + response.Body;
        }
    };


    function validateRequestResponse(requestUrl, response) {
        if (!response) {
            return 'Error: Unexpected HTTP response\n\nRequest URL: ' + requestUrl;
        } else if (response.StatusCode < 200 || response.StatusCode >= 300) {
            var errorString = '';

            if (response.StatusCode === 401 || response.StatusCode === 403) {
                errorString = 'Error: Invalid API key\n';
            } else if (response.StatusCode === 429) {
                errorString = 'Error: Too many requests\n';
            }

            try {
                var body = JSON.parse(response.Body);
                if (body && body.message) {
                    errorString += '\nMessage: ' + JSON.stringify(body.message);
                }
            } catch (err) {
                errorString += '\nCould not parse response body';
            }

            errorString += '\nRequest URL: ' + requestUrl + '\nStatus code: ' + response.StatusCode;
            return errorString;
        }

        return null;
    }


    function createAlertsURL(follow) {
        var severity = getSeverityThereshold();
        return SERVER + API_PATH_ALERTS + '?follow=' + follow + '&threats=all&minSeverity=' + severity;
    }


    function parseFollow() {
        var lastRun = getLastRun();
        return lastRun && lastRun.follow ? lastRun.follow : '0';
    }


    function saveFollow(follow) {
        if (follow) {
            setLastRun({ follow: follow });
        }
    }


    function testGetAlerts() {
        var response = sendRequest(createAlertsURL('0'));
        return response && response.alerts ? true : false;
    }


    function getAlerts(follow) {
        var response = sendRequest(createAlertsURL(follow));

        return {
            follow: response.follow,
            content: response.alerts,
            threats: response.threats
        }
    }


    function appendIncidentsFromAlert(incidents, alert, threats) {
        if (!threats || !alert || !alert.threats) {
            logInfo('Invalid alert format or empty threats definition');
            return;
        }

        var occurredTs = getOccurredTs(alert);
        for (var i = 0; i < alert.threats.length; i++) {
            var threatId = alert.threats[i];

            var threat = threats[threatId];
            if (!threat) {
                logInfo('Error: Invalid alert content. Definition for threat "' + threatId + '" not found');
                continue;
            }

            if (inScope(threat.severity, threat.policy)) {
                alert.policy = threat.policy === true ? true : false;

                incidents.push({
                    'name': threat.title,
                    'occurred': occurredTs,
                    'severity': convertSeverity(threat.severity),
                    'labels': getLabels(alert),
                    'rawJSON': JSON.stringify(alert)
                });
            }
        }
    }


    function getOccurredTs(alert) {
        try {
            return alert.event.ts;
        } catch (exc) {
            return null;
        }
    }


    function getLabels(alert) {
        var labels = [];
        if (!alert) {
            return labels;
        }

        if (alert.eventType) {
            labels.push(createLabelEntry('eventType', alert.eventType));
        }

        if (alert.policy !== undefined && alert.policy !== null) {
            labels.push(createLabelEntry('policy', alert.policy));
        }

        if (alert.event) {
            var eventKeys = Object.keys(alert.event);
            for (var i = 0; i < eventKeys.length; i++) {
                var eventKey = eventKeys[i];
                if (eventKey !== 'ts') {
                    labels.push(createLabelEntry(eventKey, alert.event[eventKey]));
                }
            }
        }

        if (alert.wisdom) {
            var wisdomKeys = Object.keys(alert.wisdom);
            for (var i = 0; i < wisdomKeys.length; i++) {
                var wisdomKey = wisdomKeys[i];
                labels.push(createLabelEntry('wisdom.' + wisdomKey, alert.wisdom[wisdomKey]));
            }
        }

        return labels;
    }


    function createLabelEntry(key, value) {
        return { 'type': key, 'value': String(value) };
    }


    function inScope(severity, policy) {
        var severityThereshold = getSeverityThereshold();
        if (!severity || severity < severityThereshold) {
            return false;
        }

        if (policy === true && !INCLUDE_POLICY) {
            return false;
        }

        return true;
    }


    function convertSeverity(severity) {
        var demistoSeverity = 0;

        try {
            demistoSeverity = severity === 1 ? .5 : severity - 1;
        } catch (exc) {
            demistoSeverity = 0;
        }

        return demistoSeverity < 0 || demistoSeverity > 4 ? 0 : demistoSeverity;
    }


    function getSeverityThereshold() {
        try {
            var severity = parseInt(SEVERITY);
        } catch (exc) {
            var severity = NaN;
        }

        if (isNaN(severity) || severity > 5) {
            throw 'Error: Invalid severity parameter. Please provide a number in range 0-5.';
        }

        return severity < 0 ? 0 : severity;
    }


    switch (command) {
        case 'test-module':
            try {
                getSeverityThereshold();
                return testGetAlerts() === true ? 'ok' : 'not ok';
            } catch (exc) {
                return String(exc);
            }
        case 'fetch-incidents':
            var follow = parseFollow();
            var alerts = getAlerts(follow);

            var incidents = [];
            if (alerts && alerts.content) {
                for (var i = 0; i < alerts.content.length; i++) {
                    appendIncidentsFromAlert(incidents, alerts.content[i], alerts.threats);
                }
            }

            saveFollow(alerts.follow);
            return JSON.stringify(incidents);
    }
  type: javascript
  isfetch: true
  runonce: false
tests:
- No tests
fromversion: 5.0.0
