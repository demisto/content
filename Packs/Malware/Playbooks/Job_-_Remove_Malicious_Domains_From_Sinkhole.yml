id: 92bcb4ca-e7e1-4d23-80b4-cfcbf6897049
version: 31
vcShouldKeepItemLegacyProdMachine: false
name: Job - Remove Malicious Domains From Sinkhole
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 59964f1b-d04b-4ede-8fbe-3c5d81afe4b1
    type: start
    task:
      id: 59964f1b-d04b-4ede-8fbe-3c5d81afe4b1
      version: -1
      name: ""
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "1"
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 50
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: b6608cc7-1823-49d7-88ed-6aec51bfff6a
    type: regular
    task:
      id: b6608cc7-1823-49d7-88ed-6aec51bfff6a
      version: -1
      name: Get domains with sinkhole tag
      description: commands.local.cmd.find.indicators
      script: Builtin|||findIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      extend-context:
        simple: indicators=
      query:
        complex:
          root: inputs.SinkholeTag
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: tags:"
              suffix:
                value:
                  simple: '" and type:Domain'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 55e5585c-542f-4eae-82d2-91c6892759ca
    type: condition
    task:
      id: 55e5585c-542f-4eae-82d2-91c6892759ca
      version: -1
      name: Should any domain be removed from the sinkhole action?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      "yes":
      - "4"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: indicators
                filters:
                - - operator: containsString
                    left:
                      value:
                        simple: indicators.comments.content
                      iscontext: true
                    right:
                      value:
                        simple: inputs.SinkholeTag
                      iscontext: true
                    ignorecase: true
                - - operator: containsString
                    left:
                      value:
                        simple: indicators.comments.content
                      iscontext: true
                    right:
                      value:
                        simple: was added
                    ignorecase: true
                - - operator: isBefore
                    left:
                      value:
                        simple: indicators.comments.created
                      iscontext: true
                    right:
                      value:
                        simple: MinimumTimeTimeNow
                      iscontext: true
                accessor: value
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 5bb27c03-2208-4c9d-862e-2476202ec6d6
    type: regular
    task:
      id: 5bb27c03-2208-4c9d-862e-2476202ec6d6
      version: -1
      name: Get the minimum decay date
      description: |
        Retrieves the current date and time.
      scriptName: GetTime
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      contextKey:
        simple: MinimumTime
      dateFormat:
        simple: ISO
      daysAgo:
        complex:
          root: inputs.DaysTaggedBeforeRemoval
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -10,
          "y": 200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: 96eeaa7e-1b03-47fc-8b47-502505a3148e
    type: regular
    task:
      id: 96eeaa7e-1b03-47fc-8b47-502505a3148e
      version: -1
      name: Remove tags from the decayed domains
      description: commands.local.cmd.remove.values.to.indicator.multi.select.field
      script: Builtin|||removeIndicatorField
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      field:
        simple: tags
      fieldValue:
        complex:
          root: inputs.SinkholeTag
      indicatorsValues:
        complex:
          root: indicators
          filters:
          - - operator: containsString
              left:
                value:
                  simple: indicators.comments.content
                iscontext: true
              right:
                value:
                  simple: inputs.SinkholeTag
                iscontext: true
              ignorecase: true
          - - operator: containsString
              left:
                value:
                  simple: indicators.comments.content
                iscontext: true
              right:
                value:
                  simple: was added
              ignorecase: true
          - - operator: isBefore
              left:
                value:
                  simple: indicators.comments.created
                iscontext: true
              right:
                value:
                  simple: MinimumTimeTimeNow
                iscontext: true
          accessor: value
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 170,
          "y": 600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: e35a4a0b-aca0-4f03-8572-d70614c500e5
    type: title
    task:
      id: e35a4a0b-aca0-4f03-8572-d70614c500e5
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 770
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "2_4_yes": 0.41,
      "2_5_#default#": 0.33
    },
    "paper": {
      "dimensions": {
        "height": 785,
        "width": 840,
        "x": -10,
        "y": 50
      }
    }
  }
inputs:
- key: SinkholeTag
  value:
    simple: to_sinkhole
  required: true
  description: |-
    The tag that will be removed from the tagged domain indicators.
    This should be the tag that was used to export the domains to the EDL using the Generic Export Indicators Service integration, which is used by the firewall's sinkhole configuration.
  playbookInputQuery: null
- key: DaysTaggedBeforeRemoval
  value:
    simple: "1"
  required: true
  description: |-
    How many days should pass since the domains were tagged, before removing the sinkhole tag from those domains.
    The value should be a number of days. For example: 30.
    Note: due to the way the dates are being compared, the tags will be removed only if the tag was added BEFORE the date derived from this value. This means that if you specified a value of 30, then only domains that were tagged before 30 days (meaning 31 days or more) will have the tag removed.
  playbookInputQuery: null
outputs: []
