"""
A wrapper script to the 'AppendindicatorField' script, that enables adding tags to certain indicators.
Note: You can use this script as a layout button that allows adding tags to indicators.
"""

import demistomock as demisto
from CommonServerPython import *
from CommonServerUserPython import *

from typing import Dict, Any
import traceback


''' COMMAND FUNCTION '''


def run_append_indicator_field_script(args: Dict[str, Any]) -> CommandResults:
    """
    Run the 'appendIndicatorField' script in order to add the given tags to the given indicators.
    Args:
        args: demisto args object containing the following arguments:
              - indicators_values: The values of the indicators. For example, for an IP indicator, 1.1.1.1.
              - tags: The values to add to the indicators tags.

    Returns: A CommandResults object contains the readable output string.

    """
    indicators_values = argToList(args.get('indicators_values'))
    tags = argToList(args.get('tags'))

    # Handle missing arguments:
    err_msg_prefix = 'Failed to execute AppendindicatorFieldWrapper. Error:'
    if not indicators_values:
        err_msg = f'{err_msg_prefix} Indicators values were not specified.'
        demisto.error(err_msg)
        readable_output = err_msg

    elif not tags:
        err_msg = f'{err_msg_prefix} Tags were not specified.'
        demisto.error(err_msg)
        readable_output = err_msg

    else:
        # Run 'appendIndicatorField' script:
        execute_command('appendIndicatorField',
                        {'indicatorsValues': indicators_values, 'field': 'tags', 'fieldValue': tags})

        readable_output = tableToMarkdown('The following tags were added successfully:',
                                          [{'Indicator': indicator, 'Tags': tags} for indicator in indicators_values])

    return CommandResults(
        outputs_prefix='AppendindicatorFieldWrapper',
        outputs_key_field='',
        readable_output=readable_output
    )


''' MAIN FUNCTION '''


def main():
    try:
        return_results(run_append_indicator_field_script(demisto.args()))

    except Exception as ex:
        return_error(f'Failed to execute AppendindicatorFieldWrapper. Error: {str(ex)}')


''' ENTRY POINT '''


if __name__ in ('__main__', '__builtin__', 'builtins'):
    main()
