"""
TODO: add script description - verify description with sasha
TODO: add script outputs
TODO: verify what should happens when we get both name and ID of the process.
"""


import demistomock as demisto
from CommonServerPython import *
from CommonServerUserPython import *

from typing import Dict, Any

XDR_PROCESS_KILL_COMMAND = 'xdr-run-script-kill-process'
CROWDSTRIKE_PROCESS_KILL_COMMAND = 'cs-falcon-rtr-kill-process'

''' STANDALONE FUNCTION '''


def create_commands(endpoint_id: str = None,
                    process_id: str = None,
                    process_name: str = None) -> List[CommandRunner.Command]:
    """
    Create a list of process kill commands (of `Cortex XDR`and `CrowdstrikeFalcon`), that should be executed
    according to the given arguments.

    Args:
        endpoint_id: The Endpoint ID of the process.
        process_id: The ID of the process to kill.
        process_name: The name of the process to kill.

    Returns: A list of Commands.
    """
    commands = []
    if process_id and not process_name:
        commands.append(CommandRunner.Command(commands=))

    msde_command, msde_args = MSDE_ACTIONS[action]
    msde_args.update({'machine_id': ','.join(device_ids),
                      'comment': f'XSOAR - related incident {INCIDENT_ID}'})
    return [CommandRunner.Command(commands=XDR_ACTIONS.get(action),
                                  args_lst=[{'endpoint_id': device_id} for device_id in device_ids]),
            CommandRunner.Command(commands=msde_command,
                                  args_lst=msde_args),
            CommandRunner.Command(commands=CROWDSTRIKE_ACTIONS.get(action),
                                  args_lst={'ids': ','.join(device_ids)})]


''' COMMAND FUNCTION '''


def run_killing_process_action(endpoint_id: str = None,
                               process_id: str = None,
                               process_name: str = None) -> CommandResults:
    """
    Given arguments to the process kill command, returns a list of results to return.

    Args:
        endpoint_id: The Endpoint ID of the process.
        process_id: The ID of the process to kill.
        process_name: The name of the process to kill.

    Returns: A list of the kill process command results.
    """
    commands = create_commands(device_ids, action)
    return CommandRunner.run_commands_with_summary(commands)


''' MAIN FUNCTION '''


def main():
    args = demisto.args()
    endpoint_id = args.get('endpoint_id')
    process_id = args.get('process_id')
    process_name = args.get('process_name')
    approve_action = args.get('approve_action')

    if approve_action == 'YES':
        try:
            # Handle missing arguments:
            if not endpoint_id:
                raise Exception('Endpoint ID was not specified.')
            if not (process_id or process_name):
                raise Exception('Process information was not specified - '
                                'You should provide the process ID or the process name.')
            return_results(basescript_dummy_command(demisto.args()))
        except Exception as ex:
            return_error(f'Failed to execute KillProcessWrapper. Error: {str(ex)}')

    else:  # killing process was not confirmed
        result = CommandResults(
            outputs_prefix='KillProcessWrapper',
            outputs_key_field='',
            readable_output='The process was not killed because no approval was given.'
        )
        return_results(result)


''' ENTRY POINT '''


if __name__ in ('__main__', '__builtin__', 'builtins'):
    main()
