commonfields:
  id: SCADAfence CNM
  version: -1
name: SCADAfence CNM
display: SCADAfence CNM
category: Network Security
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAAAlCAYAAAAHgqbCAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTUgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NjRCNzg0N0Q3NjYyMTFFNjg3NjM5QUVCQTAzMzY4NTkiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NjRCNzg0N0U3NjYyMTFFNjg3NjM5QUVCQTAzMzY4NTkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo2NEI3ODQ3Qjc2NjIxMUU2ODc2MzlBRUJBMDMzNjg1OSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo2NEI3ODQ3Qzc2NjIxMUU2ODc2MzlBRUJBMDMzNjg1OSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PpyArOsAAA3/SURBVHja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
description: fetching data from CNM
configuration:
- display: API auth secret
  name: APISecret
  defaultvalue: ""
  type: 4
  required: true
- display: API auth key
  name: APIKey
  defaultvalue: ""
  type: 4
  required: true
- display: API url
  name: APIUrl
  defaultvalue: ""
  type: 0
  required: true
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
- display: Trust any certificate (not secure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Fetch incidents
  name: isFetch
  type: 8
  required: false
- display: Incident type
  name: incidentType
  type: 13
  required: false
- display: 'Required severity levels for alerts separated by comma, from [Information,Warning,Threat,Severe,Critical]. For ex.: Warning, Threat'
  name: AlertSeverity
  defaultvalue: Information,Warning,Threat,Severe,Critical
  type: 12
  required: true
script:
  script: >+
    ''' IMPORTS '''

    import requests

    import json

    import sys

    from datetime import datetime, timedelta

    # disable insecure warnings

    requests.packages.urllib3.disable_warnings()


    ''' GLOBAL VARS '''

    API_URL= demisto.params()['APIUrl'].rstrip('/') + '/externalApi'

    API_KEY=demisto.params()['APIKey']

    API_SECRET=demisto.params()['APISecret']

    ALERT_SEVERITY = demisto.params()['AlertSeverity']


    USE_SSL = not demisto.params().get('insecure', False)


    if not demisto.params().get('proxy', False):
        del os.environ['HTTP_PROXY']
        del os.environ['HTTPS_PROXY']
        del os.environ['http_proxy']
        del os.environ['https_proxy']

    DEFAULT_HEADERS = {
        "x-api-key": API_KEY,
        "x-api-secret": API_SECRET,
        "Accept": "application/json",
        "Content-Type": "application/x-www-form-urlencoded"
    }



    SCADAFENCE_ALERT_SEVERITY_LEVEL = {
        'Information': 0,
        'Warning': 1,
        'Threat': 2,
        'Severe': 3,
        'Critical': 4
    }


    ''' HELPER FUNCTIONS '''


    INCIDENT_TYPES = {
        "IP conflict detected": "SCADAfence IP conlict"
    }


    def get_alert_severity():
        """
        validate severity values provided as parameter
        :return: set: valid severity values
        """
        s = ALERT_SEVERITY.replace(" ","")
        s_arr = s.split(",")
        if sum(map(lambda x: x in ['Information','Warning','Threat','Severe','Critical'], s_arr)) == len(s_arr):
            return set(s_arr)
        LOG("Invalid alert severity values")
        raise Exception("Invalid alert severity values")

    def http_request(method, url_suffix, params_dict, headers):
        """

        :param method: string: https method
        :param url_suffix: string: API route
        :param params_dict: dict: request parameters
        :param headers: dict: optional http headers
        :return: dict: response data
        """
        req_params = {
        }
        if params_dict is not None:
            req_params.update(params_dict)

        url = API_URL + url_suffix

        LOG('running %s request with url=%s\theaders=%s\nparams=%s' % (method, url, headers, json.dumps(req_params)))
        res_msg = ""
        try:

            if method in ['PATCH', 'POST']:
                data = req_params
                params = None
            else:
                params = req_params
                data = None
            res = requests.request(method,
                url,
                verify=USE_SSL,
                data=data,
                params=params,
                headers=headers
            )
            if res.text:
                res_msg = res.text
            res.raise_for_status()

            if not res.text:
                return None
            return json.loads(res.text)

        except Exception, e:
            LOG("{}\n{}".format(e, res_msg))
            raise Exception("{}\n{}".format(e, res_msg))


    def call_api(method, api_suffix, params):
        """
        Call the requested API path and return its result
        :param api_path: A string beginning with '/' followed by the desired service
        :rtype: dict
        :raises Exception: If the response code is not 200
        :return the response as a dict if possible, otherwise None
        """
        return http_request(method, api_suffix, params, DEFAULT_HEADERS)

    def get_alerts(severity, ip, from_date):
        """
        API caller
        :param severity: string: required severity level
        :param from_date: string: lower time limit
        :return: call_api.http_request.data
        """
        api_suffix = "/alerts"
        return call_api('GET', api_suffix, {'severity': severity, 'ip': ip, 'from': from_date})

    def fetch_incidents():
        """
        method for polling alerts from SCADAfence alerts API
        :return: list: demisto.incidents
        """
        last_run = demisto.getLastRun()

        last_updated = (datetime(1999, 1, 1, 0, 0, 0, 0), '1999-01-01T00:00:00.0Z')
        if last_run and last_run.has_key('createdOn'):
            ts_str = last_run.get('createdOn')
            last_updated = (datetime.strptime(ts_str, '%Y-%m-%dT%H:%M:%S.%fZ'), ts_str)

        severities = get_alert_severity()

        events = []
        incidents = []
        tmp_time = last_updated

        for severity in severities:
            events = get_alerts(severity, None, last_updated[1])

            for event in events:
                event_ts = datetime.strptime(event['createdOn'], '%Y-%m-%dT%H:%M:%S.%fZ')
                if event_ts > tmp_time[0]:
                    tmp_time = (event_ts, event['createdOn'])

                incident = {
                    'name': event['type'],
                    'occurred': event['createdOn'],
                    'severity': SCADAFENCE_ALERT_SEVERITY_LEVEL[event['severity']],
                    'rawJSON': json.dumps(event)
                }
                incidents.append(incident)
        if tmp_time[0] > last_updated[0]:

            demisto.setLastRun({
                'createdOn': tmp_time[1]
            })

        demisto.incidents(incidents)

    def map_optional_params(keys, api_keys):
        """
        mapping Demisto parameters to SCADAfence API parameters
        :param keys: list: expected demisto parameters
        :param api_keys: valid scadafence parameters
        :return: dict: mapped current function call parameters
        """
        params = {}
        param_keys = demisto.args().keys()
        for i, key in enumerate(keys):
            if key in param_keys:
                params[api_keys[i]] = demisto.args()[key]
        return params


    def get_assets(asset_data):
        """
        getter for assets data by one or more parameters:
        IP, hostame, type (plc, hmi, IO, Telnel server etc)
        :param asset_data: dict
        :return: call_api.http_request.res.text
        """
        if asset_data:
            api_suffix = "/assets"
            return call_api('GET', api_suffix, asset_data)
        return_error("Invalid call for assets data (missing parameters)")

    def get_asset_map(asset_details):
        """
        fetches asset connection data by one or more (combined) parameters
        :param asset_details: disct :{'ip': ip, 'host': hostname, 'mac': mac}
        :return: call_api.http_request.res.text
        """
        if asset_details:
            api_suffix = "/asset/map"
            return call_api('GET', api_suffix, asset_details)
        return_error("Invalid call for asset map (missing parameters)")

    def get_assets_map():
        """
        fetches asset connection data by one or more (combined) parameters
        :param asset_details: disct :{'ip': ip, 'host': hostname, 'mac': mac}
        :return: call_api.http_request.res.text
        """
        api_suffix = "/asset/map"
        return call_api('GET', api_suffix, None)

    def get_asset_traffic(asset_details):
        """
        fetches asset connection data by one or more (combined) parameters
        :param asset_details: disct :{'ip': ip, 'host': hostname, 'mac': mac}
        :return: call_api.http_request.res.text
        """
        if asset_details:
            api_suffix = "/asset/traffic"
            return call_api('GET', api_suffix, asset_details)
        return_error("Invalid call for asset traffic (missing parameters)")

    def dest_endpoint(ep):
        return {
                'ip': ep['dest_ip'],
                'mac': ep['dest_mac'],
                'hostname': ep['dest_hostname'],
                'port': ep['dest_port'],
                'proto': ep['proto'],
                'traffic': ep['traffic']
            }

    def src_endpoint(ep):
        return {
                'ip': ep['src_ip'],
                'mac': ep['src_mac'],
                'hostname': ep['src_hostname'],
                'port': ep['src_port'],
                'proto': ep['proto'],
                'traffic': ep['traffic']
            }

    def get_endpoint_data(data):
        ret = []
        for ep in data:
            if 'ipAddress' in demisto.args().keys():
                if demisto.args()['ipAddress'] == ep['src_ip']:
                    ret.append(dest_endpoint(ep))
                else:
                    ret.append(src_endpoint(ep))

            elif 'macAddress' in demisto.args().keys():
                if demisto.args()['macAddress'] == ep['src_mac']:
                    ret.append(dest_endpoint(ep))
                else:
                    ret.append(src_endpoint(ep))

            else:
                if demisto.args()['hostName'] == ep['src_hostname']:
                    ret.append(dest_endpoint(ep))
                else:
                    ret.append(src_endpoint(ep))
        return ret

    # The command demisto.command() holds the command sent from the user.

    if demisto.command() == 'test-module':
        # This is the call made when pressing the integration test button.
        get_alerts('Critical', None, None)
        demisto.results('ok')
        sys.exit(0)

    elif demisto.command() == 'scadafence-createAlert':

        ip = demisto.args()['ipAddress']
        severity = demisto.args()['severity']
        description = demisto.args()['description']
        active = demisto.args()['alertIsActive']
        remediation = demisto.args()['remediationText']

        api_suffix = "/alert"
        alert_data = {
            'ip': ip,
            'severity': severity,
            'details': description,
            'active': active,
            'remediation': remediation
        }
        data = call_api('POST', api_suffix, alert_data)
        
        demisto.results({
            'Type': entryTypes['note'],
            'Contents': data,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Create alert:', data),
            'EntryContext': {
                'SCADAfence.Alert': data
            }
        })

    elif demisto.command() == 'scadafence-getAlerts':
        ip = None
        severity = None
        if 'ipAddress' in demisto.args():
            ip = demisto.args()['ipAddress']
        if 'severity' in demisto.args():
            severity = demisto.args()['severity']
        data = get_alerts(severity, ip, None)
        output = []
        for alert in data:
            output.append({
                        'status': alert['status'],
                        'severity': alert['severity'],
                        'ip': alert['ip'],
                        'details': alert['details'],
                        'id': alert['id'],
                        'remediation': alert['remediation']
                    })
        md = tableToMarkdown('SCADAfence alerts', output)
        demisto.results({
            'Type': entryTypes['note'],
            'Contents': data,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': md,
            'EntryContext': {
                'SCADAfence.Alert(val.id==obj.id)': output
            }
        })

    elif demisto.command() == 'scadafence-setAlertStatus':
        api_suffix = "/alerts/" + demisto.args()['alertId']
        alert_status = demisto.args()['alertStatus']
        call_api('PATCH', api_suffix, {'status': alert_status})
        md = tableToMarkdown("Setting status for alert " + demisto.args()['alertId'] + " to '" + alert_status + "':",{"success": True})
        demisto.results({
            'Type': entryTypes['note'],
            'Contents': {"status": alert_status},
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': md,
            'EntryContext': {
                'SCADAfence.Alert.status': alert_status
            }
        })


    elif demisto.command() == 'scadafence-getAsset':
        params = map_optional_params(['ipAddress', 'hostName', 'assetType'], ['ip', 'host', 'type'])
        data = get_assets(params)
        md = tableToMarkdown('Asset details: ', data)

        demisto.results({
            'Type': entryTypes['note'],
            'Contents': data,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': md,
            'EntryContext': {
                'SCADAfence.Asset(val.ip==obj.ip)': data
            }
        })

    elif demisto.command() == 'scadafence-getAssetConnections':
        params = map_optional_params(['ipAddress', 'macAddress', 'hostName'], ['ip', 'mac', 'host'])
        data = get_asset_map(params)
        result = get_endpoint_data(data)
        md = tableToMarkdown('Asset connections: ', result)
        demisto.results({
            'Type': entryTypes['note'],
            'Contents': result,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': md,
            'EntryContext': {
                'SCADAfence.Asset.Conn(val.ip==obj.ip)':result
            }
        })

    elif demisto.command() == 'scadafence-getAllConnections':
        data = get_assets_map()
        md = tableToMarkdown('Asset connections: ', data)

        demisto.results({
            'Type': entryTypes['note'],
            'Contents': data,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': md,
            'EntryContext': {
                'SCADAfence.Connection': data
            }
        })

    elif demisto.command() == 'scadafence-getAssetTraffic':

        params = map_optional_params(['ipAddress', 'macAddress', 'hostName'], ['ip', 'mac', 'host'])
        data = get_asset_traffic(params)
        data_x = {
                    'TCP_tx_bytes': data['TCP']['Bytes sent'],
                    'TCP_rx_bytes': data['TCP']['Bytes received'],
                    'UDP_tx_bytes': data['UDP']['Bytes sent'],
                    'UDP_rx_bytes': data['UDP']['Bytes received']
                }
        md = tableToMarkdown('Asset network activity: ', data_x)
        demisto.results({
            'Type': entryTypes['note'],
            'Contents': data,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': md,
            'EntryContext': {
                'SCADAfence.AssetTraffic': data_x
            }
        })

    elif demisto.command() == 'fetch-incidents':
        demisto.incidents(fetch_incidents())

  type: python
  subtype: python2
  commands:
  - name: scadafence-getAlerts
    arguments:
    - name: severity
      auto: PREDEFINED
      predefined:
      - Information
      - Warning
      - Threat
      - Critical
      - Severe
      description: Required severity level of alert
    - name: ipAddress
      description: get alerts for specified IP
    outputs:
    - contextPath: SCADAfence.Alert.id
      description: alert ID
      type: string
    - contextPath: SCADAfence.Alert.ip
      description: asset IP
      type: string
    - contextPath: SCADAfence.Alert.severity
      description: alert severity level
      type: string
    - contextPath: SCADAfence.Alert.type
      description: short alert description
      type: string
    - contextPath: SCADAfence.Alert.details
      description: extended alert description
      type: string
    description: query alerts data from SCADAfence CNM
  - name: scadafence-getAsset
    arguments:
    - name: ipAddress
      description: asset IP address
    - name: hostName
      description: Hostname
    - name: assetType
      auto: PREDEFINED
      predefined:
      - server
      - dns
      - sql
      - print
      - domain
      - domain
      - workstation
      - plc
      - hmi
      - IO
      - terminal
      - ftp
      - Telnet
      description: type of the asset (one from list of options)
    outputs:
    - contextPath: SCADAfence.Asset.ip
      description: IP address of the asset
      type: string
    - contextPath: SCADAfence.Asset.assetTypes
      description: types of the asset (if detected)
      type: string
    - contextPath: operatingSystem
      description: OS of the asset (if available)
      type: string
    - contextPath: vendor
      description: asset vendor
      type: string
    description: fetch asset data from SCADAfence CNM
  - name: scadafence-setAlertStatus
    arguments:
    - name: alertId
      required: true
      description: Alert ID
    - name: alertStatus
      required: true
      auto: PREDEFINED
      predefined:
      - InProgress
      - Resolved
      description: Alert status
    outputs:
    - contextPath: SCADAfence.Alert.status
      description: new status for the alert
      type: string
    description: setting alert status
  - name: scadafence-getAssetConnections
    arguments:
    - name: ipAddress
      description: optional - ip address of the asset
    - name: hostName
      description: hostname  that corresponds to the asset of interest
    - name: macAddress
      description: MAC address of the asset
    outputs:
    - contextPath: SCADAfence.Asset.Conn.ip
      description: another endpoint's IP address
      type: string
    - contextPath: SCADAfence.Asset.Conn.port
      description: another endpoint's port
      type: number
    - contextPath: SCADAfence.Asset.Conn.proto
      description: L4 protocol used for the connection
      type: string
    - contextPath: SCADAfence.Asset.Conn.traffic
      description: total bytes sent (both directions)
      type: number
    - contextPath: SCADAfence.Asset.Conn.hostname
      description: another endpoint's hostname
      type: string
    - contextPath: SCADAfence.Asset.Conn.mac
      description: another endpoint's MAC address
      type: string
    description: fetches asset connections data by one or more (combined) parameters
  - name: scadafence-getAssetTraffic
    arguments:
    - name: ipAddress
      description: optional - ip address of the asset
    - name: macAddress
      description: optional - MAC address of the asset
    - name: hostName
      description: optional - hostname of the asset
    outputs:
    - contextPath: SCADAfence.AssetTraffic.TCP_tx_bytes
      description: bytes sent by the asset via TCP
      type: number
    - contextPath: SCADAfence.AssetTraffic.TCP_rx_bytes
      description: bytes received by the asset via TCP
      type: number
    - contextPath: SCADAfence.AssetTraffic.UDP_tx_bytes
      description: bytes sent by the asset via UDP
      type: number
    - contextPath: SCADAfence.AssetTraffic.UDP_rx_bytes
      description: bytes received by the asset via UDP
      type: number
    description: fetch asset network activity data  by one or more (combined) parameters
  - name: scadafence-createAlert
    arguments:
    - name: ipAddress
      required: true
      description: IP address of the asset that alert's related to
    - name: severity
      required: true
      auto: PREDEFINED
      predefined:
      - Information
      - Warning
      - Threat
      - Severe
      - Critical
      description: desired alert severity level
      defaultValue: Information
    - name: description
      required: true
      description: human readable alert description
    - name: remediationText
      description: instructions on issue remediation
      defaultValue: not provided
    - name: alertIsActive
      required: true
      auto: PREDEFINED
      predefined:
      - "True"
      - "False"
      description: set active=True to make the alert appear on SCADAfence UI
      defaultValue: "True"
    outputs:
    - contextPath: SCADAfence.Alert.alertCreated
      description: flag defining alert creation status
      type: boolean
    - contextPath: SCADAfence.Alert.id
      description: unique ID set to a new alert
      type: string
    description: create alert in SCADAfence CNM
  - name: scadafence-getAllConnections
    arguments: []
    outputs:
    - contextPath: SCADAfence.Connection.src_ip
      description: IP address of endpoint A
      type: string
    - contextPath: SCADAfence.Connection.dest_ip
      description: IP address of endpoint B
      type: string
    - contextPath: SCADAfence.Connection.src_port
      description: port of endpoint A
      type: number
    - contextPath: SCADAfence.Connection.dest_port
      description: port of endpoint B
      type: number
    - contextPath: SCADAfence.Connection.src_mac
      description: endpoint A MAC address
      type: string
    - contextPath: SCADAfence.Connection.dest_mac
      description: endpoint B MAC address
      type: string
    - contextPath: SCADAfence.Connection.src_cname
      description: endpoint A hostname
      type: string
    - contextPath: SCADAfence.Connection.dest_cname
      description: endpoint B hostname
      type: string
    - contextPath: SCADAfence.Connection.proto
      description: L4 protocol
      type: string
    - contextPath: SCADAfence.Connection.traffic
      description: total number of bytes sent in both directions
      type: number
    description: Fetches all connections from the CNM
  isfetch: true
  runonce: false
tests:
- SCADAfence_test
fromversion: 5.0.0
