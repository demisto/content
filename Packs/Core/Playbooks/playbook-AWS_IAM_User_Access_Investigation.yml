id: AWS IAM User Access Investigation
version: -1
name: AWS IAM User Access Investigation
description: "Investigate and respond to Cortex XSIAM alerts where an AWS IAM user`s access key is used suspiciously to access the cloud environment. \nThe following alerts are supported for AWS environments.\n- Penetration testing tool attempt\n- Penetration testing tool activity\n- Suspicious API call from a Tor exit node\n This is a beta playbook, which lets you implement and test pre-release software. Although AWS is supported, we are working towards multi-cloud support. As the playbook is beta, it might contain bugs. Updates to the playbook during the beta phase might include non-backward compatible features. We encourage feedback on the quality and usability of the content to help us identify and fix issues, so we can continually improve the content.\n"
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: fe12887f-be44-4444-8b90-274c9ace9599
    type: start
    task:
      id: fe12887f-be44-4444-8b90-274c9ace9599
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "48"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 550,
          "y": -50
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "8":
    id: "8"
    taskid: 205529a3-a67d-43ce-833a-86239226e1f8
    type: title
    task:
      id: 205529a3-a67d-43ce-833a-86239226e1f8
      version: -1
      name: 'Remediation '
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "54"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 550,
          "y": 1090
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "19":
    id: "19"
    taskid: 4e7774d4-b1ac-44cb-8942-0aa0ae510dd1
    type: title
    task:
      id: 4e7774d4-b1ac-44cb-8942-0aa0ae510dd1
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 510,
          "y": 1750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "21":
    id: "21"
    taskid: 35d49e03-be6a-4b97-8fec-3a7c7aadd71f
    type: condition
    task:
      id: 35d49e03-be6a-4b97-8fec-3a7c7aadd71f
      version: -1
      name: Manual decision making - true/false-positive alert
      description: Based on the collected data investigation and the verdict established by the "Enrichment for Verdict" playbook, is this a true positive event?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      False Positive:
      - "64"
      True positive:
      - "8"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -350,
          "y": 920
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "22":
    id: "22"
    taskid: 8031af0e-14cf-4c83-88c8-18a17d5c97a5
    type: title
    task:
      id: 8031af0e-14cf-4c83-88c8-18a17d5c97a5
      version: -1
      name: False Positive - Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -350,
          "y": 1610
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "48":
    id: "48"
    taskid: e1d7c2be-0ba1-43a9-891b-523d8d0959d1
    type: title
    task:
      id: e1d7c2be-0ba1-43a9-891b-523d8d0959d1
      version: -1
      name: Enrichment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "61"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 550,
          "y": 100
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "50":
    id: "50"
    taskid: 4b022aff-bc8e-4514-8ace-cc5e2c7ce1ac
    type: title
    task:
      id: 4b022aff-bc8e-4514-8ace-cc5e2c7ce1ac
      version: -1
      name: Verdict
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "67"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 550,
          "y": 620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "54":
    id: "54"
    taskid: 14d50e12-2fb5-4a49-8da5-f8468ef4cf91
    type: playbook
    task:
      id: 14d50e12-2fb5-4a49-8da5-f8468ef4cf91
      version: -1
      name: AWS IAM User Access Investigation - Remediation
      description: "Investigate and respond to Cortex XSIAM alerts where an AWS IAM user`s access key is used suspiciously to access the cloud environment. \nThe following alerts are supported for AWS environments.\n- Penetration testing tool attempt\n- Penetration testing tool activity\n- Suspicious API call from a Tor exit node\n This is a beta playbook, which lets you implement and test pre-release software. Although AWS is supported, we are working towards multi-cloud support. As the playbook is beta, it might contain bugs. Updates to the playbook during the beta phase might include non-backward compatible features. We encourage feedback on the quality and usability of the content to help us identify and fix issues, sp we can continually improve content.\n"
      playbookName: AWS IAM User Access Investigation - Remediation
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "57"
    scriptarguments:
      AutoBlockIP:
        complex:
          root: inputs.AutoBlockIP
      AutoDeleteProfile:
        complex:
          root: inputs.AutoDeleteProfile
      DAG:
        complex:
          root: inputs.DAG
      IP:
        complex:
          root: alert
          accessor: hostip
      IndicatorTag:
        complex:
          root: inputs.IndicatorTag
      accessKeyId:
        complex:
          root: Core.OriginalAlert.event.identity_orig
          accessor: accessKeyId
      userName:
        complex:
          root: alert
          accessor: username
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 550,
          "y": 1240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "57":
    id: "57"
    taskid: 1a9b407c-4fa2-4a00-84de-aa764ea699d7
    type: condition
    task:
      id: 1a9b407c-4fa2-4a00-84de-aa764ea699d7
      version: -1
      name: Close the alert and finish the investigation?
      description: "Close the alert and finish the investigation?"
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "65"
      "yes":
      - "58"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 550,
          "y": 1410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "58":
    id: "58"
    taskid: d5e91e1f-17c2-4b36-8335-f08b5379211d
    type: regular
    task:
      id: d5e91e1f-17c2-4b36-8335-f08b5379211d
      version: -1
      name: Close alert after remediation
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 780,
          "y": 1580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "60":
    id: "60"
    taskid: a613691f-6072-4259-863b-7f97173c35e2
    type: playbook
    task:
      id: a613691f-6072-4259-863b-7f97173c35e2
      version: -1
      name: Enrichment for Verdict
      playbookName: Enrichment for Verdict
      type: playbook
      iscommand: false
      brand: ""
      description: 'This playbook checks prior alert closing reasons and performs enrichment and prevalence checks on different IOC types. It then returns the information needed to establish the alert''s verdict.'
    nexttasks:
      '#none#':
      - "50"
    scriptarguments:
      CloseReason:
        simple: Resolved - False Positive,Resolved - Duplicate Incident,Resolved - Known Issue
      Domain:
        complex:
          root: alert
          accessor: domainname
      FileSHA256:
        complex:
          root: alert
          accessor: initiatorsha256
      IP:
        complex:
          root: alert
          accessor: hostip
      URL:
        complex:
          root: alert
          accessor: url
      User:
        complex:
          root: alert
          accessor: username
      awsUser:
        complex:
          root: alert
          accessor: username
      query:
        simple: (hostip:${alert.hostip}) and alertsource:${alert.sourceBrand} and alertname:${alert.name}
      threshold:
        simple: "5"
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 550,
          "y": 440
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "61":
    id: "61"
    taskid: d94dbcca-ca35-4be0-8773-cd9273f86af8
    type: regular
    task:
      id: d94dbcca-ca35-4be0-8773-cd9273f86af8
      version: -1
      name: Get cloud original alert
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "60"
    scriptarguments:
      alert_ids:
        complex:
          root: alert
          accessor: id
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 550,
          "y": 240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "64":
    id: "64"
    taskid: 5307f38e-4308-4c8c-89f3-703efd440297
    type: playbook
    task:
      id: 5307f38e-4308-4c8c-89f3-703efd440297
      version: -1
      name: Handle False Positive Alerts
      description: |
        This playbook handles false positive alerts.
      playbookName: Handle False Positive Alerts
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      ShouldCloseAutomatically:
        complex:
          root: inputs.ShouldCloseAutomatically
      alertName:
        complex:
          root: alert
          accessor: name
      sourceIP:
        complex:
          root: alert
          accessor: hostip
      username:
        complex:
          root: alert
          accessor: username
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -350,
          "y": 1240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "65":
    id: "65"
    taskid: aaf66074-bd14-41c8-8c20-a5b7a3ddb21f
    type: regular
    task:
      id: aaf66074-bd14-41c8-8c20-a5b7a3ddb21f
      version: -1
      name: Continue the investigation
      description: Continue the investigation.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 320,
          "y": 1580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "67":
    id: "67"
    taskid: 9e21c9b5-f536-4a60-8828-b9f46e86ab11
    type: condition
    task:
      id: 9e21c9b5-f536-4a60-8828-b9f46e86ab11
      version: -1
      name: Is it a suspicious or Tor IP?
      description: Check if the IP address is found suspicious or from Tor exit node
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "21"
      Suspicious and not prevalent:
      - "69"
      Tor Exit Node:
      - "68"
      Yes by DBot Score:
      - "70"
    separatecontext: false
    conditions:
    - label: Yes by DBot Score
      condition:
      - - operator: containsGeneral
          left:
            value:
              complex:
                root: DBotScore
            iscontext: true
          right:
            value:
              simple: "3"
    - label: Tor Exit Node
      condition:
      - - operator: containsGeneral
          left:
            value:
              complex:
                root: alert
                accessor: alertname
            iscontext: true
          right:
            value:
              simple: Suspicious API call from a Tor exit node
          ignorecase: true
    - label: Suspicious and not prevalent
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: IPVerdict
            iscontext: true
          right:
            value:
              simple: Suspicious
          ignorecase: true
      - - operator: isEqualString
          left:
            value:
              complex:
                root: Core.AnalyticsPrevalence.Ip
                accessor: value
            iscontext: true
          right:
            value:
              simple: "false"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 550,
          "y": 750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "68":
    id: "68"
    taskid: 62ee048c-48e9-42f4-855e-34a5ba07f320
    type: title
    task:
      id: 62ee048c-48e9-42f4-855e-34a5ba07f320
      version: -1
      name: Tor Exit Node
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "8"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 550,
          "y": 920
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "69":
    id: "69"
    taskid: b4c8a874-b9be-40d0-84ab-4207fae1d2e4
    type: title
    task:
      id: b4c8a874-b9be-40d0-84ab-4207fae1d2e4
      version: -1
      name: Suspicious not prevalent
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "8"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 990,
          "y": 920
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "70":
    id: "70"
    taskid: 90c262f0-1f29-472e-8b24-25f58d616d97
    type: title
    task:
      id: 90c262f0-1f29-472e-8b24-25f58d616d97
      version: -1
      name: Malicious by DbotScore
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "8"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 120,
          "y": 920
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "21_64_False Positive": 0.54,
      "21_8_True positive": 0.48,
      "57_58_yes": 0.82
    },
    "paper": {
      "dimensions": {
        "height": 1865,
        "width": 1720,
        "x": -350,
        "y": -50
      }
    }
  }
inputs:
- key: AutoDeleteProfile
  value:
    simple: "False"
  required: false
  description: Whether to automatically delete the user login profile if it exists (True/False).
  playbookInputQuery:
- key: AutoBlockIP
  value:
    simple: "False"
  required: false
  description: 'Whether to initiate block IP playbook automatically (True/False). '
  playbookInputQuery:
- key: IndicatorTag
  value: {}
  required: false
  description: |-
    The tag name for bad reputation IP addresses investigated in the incident.
    Use this when the EDL service is configured to add indicators to block in PANW PAN-OS.
    If the indicator verdict (Malicious/Bad) is used to add indicators to Cortex XSIAM EDL you don't need to use the tag. Indicators are set as malicious, automatically in the incident.
  playbookInputQuery:
- key: DAG
  value: {}
  required: false
  description: |-
    This input determines whether Palo Alto Networks Panorama or Firewall Dynamic Address Groups are used.
    Specify the Dynamic Address Group tag name for IP handling.
  playbookInputQuery:
- key: ShouldCloseAutomatically
  value: {}
  required: false
  description: Whether to close alerts automatically as a false positive (True/False).
  playbookInputQuery:
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.6.0
