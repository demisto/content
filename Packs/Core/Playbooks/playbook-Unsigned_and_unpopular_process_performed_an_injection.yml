id: Unsigned and unpopular process performed an injection
version: -1
name: Unsigned and unpopular process performed an injection
description: "Overview\n\nThis playbook is designed to handle process injection alerts by analyzing preceding events, checking for agent prevention rules, and determining remediation actions. The playbook follows a logical flow to assess the risk, suggest improvements, and remediate potential threats.\n\n### This playbook handles the following alerts:\n \n- Unsigned and unpopular process performed injection into a commonly abused process\n\n- Unsigned and unpopular process performed process hollowing injection\n\n- Unsigned and unpopular process performed queue APC injection\n\n- Unsigned and unpopular process performed injection into a sensitive process\n\n- Unsigned and unpopular process performed injection into svchost.exe\n\n### Logical Flow\n\n#### 1. Retrieve Alerts from Case\n- Retrieve all alerts associated with the case.\n\n#### 2. Check for Agent Prevention Rule\n- Check if an agent prevention rule was triggered during the alert.\n  \n  ##### 2a. Block Mode\n  - If the agent rule was triggered and set to **block mode**, proceed directly to endpoint isolation.\n\n  ##### 2b. Report Mode\n  - If the agent rule was triggered and set to **report mode**, display a message suggesting the customer change the rule to **prevent mode** for future alerts.\n\n  ##### 2c. No Agent Rule Triggered\n  - If no agent prevention rule was triggered, continue to the following checks.\n\n#### 3. Check for Commonly Triggered Alerts Before Injection\n- Check if any commonly triggered alerts that typically precede process injection (as seen in previous cases) are present.\n\n  ##### 3a. Common Alerts Found\n  - If such alerts are found, initiate remediation actions.\n\n  ##### 3b. No Common Alerts Found\n  - If no such alerts are found, continue to the next step.\n\n#### 4. Analyze for MITRE Tactics TA0004 (Privilege Escalation) and TA0005 (Defense Evasion)\n- Check if there are any alerts or events that match the MITRE ATT&CK tactics for **Privilege Escalation (TA0004)** and **Defense Evasion (TA0005)**.\n\n  ##### 4a. Alerts Matching MITRE Tactics Found\n  - If alerts related to these tactics are found, initiate remediation actions.\n\n  ##### 4b. No MITRE Tactics Found\n  - If no relevant tactics are found, continue to the next step.\n\n#### 5. Check if Causality Process is Signed\n- Investigate if the causality (parent) process is signed with a legitimate certificate.\n\n  ##### 5a. Process is Signed\n  - If the process is signed by a trusted authority, close the alert.\n\n  ##### 5b. Process is Not Signed\n  - If the process is not signed, escalate for manual approval to proceed with remediation actions.\n\n## Remediation Actions\nWhen remediation is triggered:\n\n- **Terminate Malicious Processes**: Terminate the CGO.\n- **Endpoint Isolation**: Isolate the endpoint in specific high-risk cases to prevent further compromise."
tags:
- T1055 - Process Injection
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 59a33321-30c5-4810-8ed1-754dd374851e
    type: start
    task:
      id: 59a33321-30c5-4810-8ed1-754dd374851e
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -300,
          "y": 30
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 9f8b5e4e-ec32-44ae-85ed-1211ce9107e8
    type: title
    task:
      id: 9f8b5e4e-ec32-44ae-85ed-1211ce9107e8
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -300,
          "y": 170
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 28112aa4-5c02-4bd9-8a2a-6f10174c7771
    type: regular
    task:
      id: 28112aa4-5c02-4bd9-8a2a-6f10174c7771
      version: -1
      name: Search for alerts that blocked the causality
      description: This task searches for Cortex XSIAM alerts related to the current incident.
      scriptName: SearchIncidentsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      query:
        complex:
          root: alert
          accessor: parentXDRIncident
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '-'
              fields:
                value:
                  simple: "2"
          - operator: concat
            args:
              prefix:
                value:
                  simple: 'caseid:'
              suffix: {}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -300,
          "y": 305
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: 698f092a-758e-4028-84b8-25bbb7d4c626
    type: condition
    task:
      id: 698f092a-758e-4028-84b8-25bbb7d4c626
      version: -1
      name: Was the causality blocked by another alert?
      description: Check the incident's alerts for an alert that blocked the causality using the agent.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "7"
      Blocked:
      - "12"
      Reported:
      - "15"
    separatecontext: false
    conditions:
    - label: Blocked
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: foundIncidents.CustomFields
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: foundIncidents.CustomFields.cid
                      iscontext: true
                    right:
                      value:
                        simple: alert.cid
                    ignorecase: true
                accessor: action
            iscontext: true
          right:
            value:
              simple: BLOCKED
          ignorecase: true
    - label: Reported
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: foundIncidents.CustomFields
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: foundIncidents.CustomFields.cid
                      iscontext: true
                    right:
                      value:
                        simple: alert.cid
                    ignorecase: true
                accessor: action
            iscontext: true
          right:
            value:
              simple: Reported
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -300,
          "y": 470
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 7c09ff5c-2f1e-4c55-85f1-557891e3e8f7
    type: condition
    task:
      id: 7c09ff5c-2f1e-4c55-85f1-557891e3e8f7
      version: -1
      name: Check if the causality process is signed
      description: Check if the causality process image is signed.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "14"
      Signed:
      - "20"
    separatecontext: false
    conditions:
    - label: Signed
      condition:
      - - operator: isNotEqualString
          left:
            value:
              simple: alert.cgosignature
            iscontext: true
          right:
            value:
              simple: SIGNATURE_SIGNED
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 980,
          "y": 1150
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: 3e3d733d-1317-44cf-8178-e0015cc3b874
    type: condition
    task:
      id: 3e3d733d-1317-44cf-8178-e0015cc3b874
      version: -1
      name: Were known preceding alerts detected?
      description: Search for commonly triggered alert names preceding the injection alert.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "17"
      "yes":
      - "10"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: startWith
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Powershell Activity
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Unsigned process injecting into a Windows system binary with no command line
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 560,
          "y": 790
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 81db7e8a-cc03-44e9-86a5-70d784b286ee
    type: regular
    task:
      id: 81db7e8a-cc03-44e9-86a5-70d784b286ee
      version: -1
      name: Close the Alert as True Positive
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      closeReason:
        simple: Resolved - Handled by the playbook "Unsigned and unpopular process performed an injection" as True Positive
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 560,
          "y": 2580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: 3214ade0-7bba-484f-8945-3bc4367178a9
    type: title
    task:
      id: 3214ade0-7bba-484f-8945-3bc4367178a9
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 770,
          "y": 2750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: 358ad811-3ae6-4e1d-826e-ba15c09f050c
    type: title
    task:
      id: 358ad811-3ae6-4e1d-826e-ba15c09f050c
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 90,
          "y": 1490
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: a4e84519-ae9c-4cde-86db-4210bd57a617
    type: condition
    task:
      id: a4e84519-ae9c-4cde-86db-4210bd57a617
      version: -1
      name: Approve the endpoint isolation
      description: |-
        Endpoint Isolation is recommended since the following verdicts have been confirmed:

         - In addition to the analytics rule, an agent rule has blocked the same causality process.

        OR

         - The case includes additional rules protecting from PowerShell protection module or the 'Unsigned process injecting into a Windows system binary with no command line'.

        OR

         - The case includes at least two additional rules tagged as 'TA0004 - Privilege Escalation' and 'TA0005 - Defense Evasion'
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "8"
      Isolate:
      - "13"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -300,
          "y": 2210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 324312f8-a792-4ff6-8046-848f554bdf15
    type: regular
    task:
      id: 324312f8-a792-4ff6-8046-848f554bdf15
      version: -1
      name: Isolate endpoint
      description: Isolates the specified endpoint.
      script: '|||core-isolate-endpoint'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "8"
    scriptarguments:
      endpoint_id:
        simple: ${alert.agentid}
      incident_id:
        simple: ${parentIncidentFields.incident_id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -300,
          "y": 2400
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 5e10c74a-e684-4d52-8131-45f0d93e265e
    type: condition
    task:
      id: 5e10c74a-e684-4d52-8131-45f0d93e265e
      version: -1
      name: Should terminate the causality (CGO)?
      description: |-
        Our only verdict is an unsigned causality process, we need the analyst's approval to continue the remediation phase.

        Unmatched verdicts:
        - No BTP rule found for the same causality ID
        - No known preceding alerts found in the same case

        Matched verdicts:
        - The causality process is not signed
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "20"
      "Yes":
      - "10"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 560,
          "y": 1320
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 000b6c70-38b6-404f-86db-45f3d9426d26
    type: regular
    task:
      id: 000b6c70-38b6-404f-86db-45f3d9426d26
      version: -1
      name: Suggest activate prevention mode for Process Injection module
      description: Prints text to war room (Markdown supported)
      scriptName: Print
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      value:
        simple: |-
          We have successfully identified a potential security threat involving process injection on your system. While the detection rule  correctly flagged the suspicious activity, it was operating in **report** mode at the time. This means that although we detected the activity, no automatic preventive action was taken to block the threat.

          If this rule had been set to **prevent** mode, the malicious action could have been stopped immediately, reducing the risk of compromise. We strongly recommend switching the rule to prevent mode to proactively block such threats in the future.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 90,
          "y": 790
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: cd3ec521-6d66-44e7-8fef-c27e3a4edf94
    type: condition
    task:
      id: cd3ec521-6d66-44e7-8fef-c27e3a4edf94
      version: -1
      name: Were known preceding MITRE tactics alerts detected?
      description: Search for commonly triggered MITRE tactics preceding the injection alert.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      "yes":
      - "10"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.CustomFields.mitreattcktactic
            iscontext: true
          right:
            value:
              simple: TA0004 - Privilege Escalation
          ignorecase: true
      - - operator: containsGeneral
          left:
            value:
              simple: foundIncidents.CustomFields.mitreattcktactic
            iscontext: true
          right:
            value:
              simple: TA0005 - Defense Evasion
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 560,
          "y": 980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: f3da08e0-1190-40a3-82de-72068e560176
    type: regular
    task:
      id: f3da08e0-1190-40a3-82de-72068e560176
      version: -1
      name: Terminate Causality (CGO)
      description: Terminate a process tree by its causality ID. Available only for XSIAM 2.4.
      script: '|||core-terminate-causality'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "19"
      '#none#':
      - "12"
    scriptarguments:
      agent_id:
        simple: ${alert.agentid}
      causality_id:
        simple: ${alert.cid}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": 90,
          "y": 1620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: 2c05918a-ebe2-4d61-8d7a-2e9f237ebf15
    type: regular
    task:
      id: 2c05918a-ebe2-4d61-8d7a-2e9f237ebf15
      version: -1
      name: Terminate Process Manually
      description: |-
        Dear Analyst,

        During the remediation process, the playbook couldn’t terminate the process: ${alert.cgoname}

        Please terminate the process manually if possible.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 90,
          "y": 1850
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: 00471e39-8234-45c7-8764-b5c711e53ab7
    type: regular
    task:
      id: 00471e39-8234-45c7-8764-b5c711e53ab7
      version: -1
      name: Close the Alert as False Positive
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      closeReason:
        simple: Resolved - Handled by the playbook "Unsigned and unpopular process performed an injection" as False Positive
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 980,
          "y": 2580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: da0b7884-3a34-4348-8e2a-11c868bb4bbb
    type: condition
    task:
      id: da0b7884-3a34-4348-8e2a-11c868bb4bbb
      version: -1
      name: Weak verdict - Check if only final check is satisfied
      description: If only the last check is matched, the verdict is marked as 'weak' to indicate reduced confidence.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "12"
      Weak:
      - "8"
    separatecontext: false
    conditions:
    - label: Weak
      condition:
      - - operator: notStartWith
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Powershell Activity
          ignorecase: true
      - - operator: isNotEqualString
          left:
            value:
              simple: foundIncidents.name
            iscontext: true
          right:
            value:
              simple: Unsigned process injecting into a Windows system binary with no command line
          ignorecase: true
      - - operator: notIn
          left:
            value:
              complex:
                root: foundIncidents.CustomFields
                filters:
                - - operator: isNotEqualString
                    left:
                      value:
                        simple: foundIncidents.CustomFields.cid
                      iscontext: true
                    right:
                      value:
                        simple: alert.cid
                      iscontext: true
                accessor: action
            iscontext: true
          right:
            value:
              simple: Reported, BLOCKED
          ignorecase: true
      - - operator: notContainsGeneral
          left:
            value:
              simple: foundIncidents.CustomFields.mitreattcktactic
            iscontext: true
          right:
            value:
              simple: TA0004 - Privilege Escalation
          ignorecase: true
      - - operator: notContainsGeneral
          left:
            value:
              simple: foundIncidents.CustomFields.mitreattcktactic
            iscontext: true
          right:
            value:
              simple: TA0005 - Defense Evasion
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 300,
          "y": 2030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "12_13_Isolate": 0.42,
      "12_8_#default#": 0.44,
      "14_10_Yes": 0.37,
      "17_10_yes": 0.22,
      "17_5_#default#": 0.4,
      "18_19_#error#": 0.65,
      "21_12_#default#": 0.3,
      "21_8_Weak": 0.32,
      "4_12_Blocked": 0.32,
      "4_15_Reported": 0.66,
      "4_7_#default#": 0.81,
      "5_14_#default#": 0.4,
      "5_20_Signed": 0.12,
      "7_10_yes": 0.2,
      "7_17_#default#": 0.5
    },
    "paper": {
      "dimensions": {
        "height": 2785,
        "width": 1660,
        "x": -300,
        "y": 30
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.10.0
