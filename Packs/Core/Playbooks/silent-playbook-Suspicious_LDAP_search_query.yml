description: "This playbook is designed to handle the following alerts:  \n- Possible\
  \ LDAP enumeration by unsigned process.\n- Suspicious LDAP search query executed.\n\
  \nThe playbook executes the following stages:\n\nInvestigation:\nCheck the following\
  \ parameters to determine if remediation actions are needed:\n- Cortex XSIAM alerts\
  \ related to the hostname by MITRE tactics indicating malicious activity.\n- Whether\
  \ the Actor Process Command line contains suspicious arguments.\n- Checks for prevalence\
  \ of the Actor Process Name and Actor Process CMD.\n- Host risk score is \"Medium\"\
  \ or \"High\".\n- User risk score is \"High\".\n\nRemediation:\n- Handles malicious\
  \ alerts by terminating the causality process.\n- Handles non-malicious alerts identified\
  \ during the investigation."
fromversion: 8.8.0
id: silent-Suspicious LDAP search query
inputs: []
issilent: true
name: silent-Suspicious LDAP search query
outputs: []
starttaskid: '0'
tags:
- T1087 - Account Discovery
tasks:
  '0':
    continueonerrortype: ''
    id: '0'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '13'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 17b5c19a-972a-4991-8d3d-bf1f7d836a19
      iscommand: false
      name: ''
      version: -1
    taskid: 17b5c19a-972a-4991-8d3d-bf1f7d836a19
    timertriggers: []
    type: start
    view: "{\n  \"position\": {\n    \"x\": 530,\n    \"y\": -360\n  }\n}"
  '1':
    continueonerror: true
    continueonerrortype: errorPath
    id: '1'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '24'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Terminate a process tree by its causality ID. Available only for
        XSIAM 2.4.
      id: 9154ab99-2606-4cfe-8697-bcb7b8be1045
      iscommand: false
      name: Remediation
      type: title
      version: -1
    taskid: 9154ab99-2606-4cfe-8697-bcb7b8be1045
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 530,\n    \"y\": 1670\n  }\n}"
  '11':
    continueonerrortype: ''
    id: '11'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 89c45220-5692-4e8a-8a7c-3a304bfb6335
      iscommand: false
      name: Done
      type: title
      version: -1
    taskid: 89c45220-5692-4e8a-8a7c-3a304bfb6335
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 530,\n    \"y\": 2370\n  }\n}"
  '13':
    continueonerrortype: ''
    id: '13'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ''
      forEach: true
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - '14'
    note: false
    quietmode: 0
    scriptarguments:
      Commandline:
        complex:
          accessor: cgocmd
          root: alert
          transformers:
          - args:
              item:
                iscontext: true
                value:
                  simple: alert.osparentcmd
            operator: append
          - operator: uniq
      StringSimilarityThreshold:
        simple: '0.5'
    separatecontext: true
    skipunavailable: false
    task:
      brand: ''
      description: "This playbook takes a command line from the alert and performs\
        \ the following actions:\n- Checks for base64 string and decodes if exists\n\
        - Extracts and enriches indicators from the command line\n- Checks specific\
        \ arguments for malicious usage \n\nAt the end of the playbook, it sets a\
        \ possible verdict for the command line, based on the finding:\n1. Indicators\
        \ found in the command line\n2. Found AMSI techniques\n3. Found suspicious\
        \ parameters\n4. Usage of malicious tools\n5. Indication of network activity\n\
        6. Indication of suspicious LOLBIN execution\n\nNote: To run this playbook\
        \ with a list of command lines, set this playbook to run in a loop. To do\
        \ so, navigate to 'Loop'  and check \"For Each Input\"."
      id: 6d3d3bc7-066c-4bdb-8b1b-0c5af1400d33
      iscommand: false
      name: Command-Line Analysis
      playbookName: Command-Line Analysis
      type: playbook
      version: -1
    taskid: 6d3d3bc7-066c-4bdb-8b1b-0c5af1400d33
    timertriggers: []
    type: playbook
    view: "{\n  \"position\": {\n    \"x\": 530,\n    \"y\": -230\n  }\n}"
  '14':
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: CommandlineVerdict
          operator: isNotEmpty
          right:
            value: {}
      label: 'yes'
    continueonerrortype: ''
    id: '14'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '26'
      'yes':
      - '1'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Check if any suspicious arguments were found in the Actor Process
        Command Line.
      id: 42bfe23f-9f3c-46b1-804b-0950f8197bbe
      iscommand: false
      name: Are There Any Suspicious Findings?
      type: condition
      version: -1
    taskid: 42bfe23f-9f3c-46b1-804b-0950f8197bbe
    timertriggers: []
    type: condition
    view: "{\n  \"position\": {\n    \"x\": 530,\n    \"y\": -70\n  }\n}"
  '15':
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: foundIncidents
          operator: isNotEmpty
          right:
            value: {}
      label: 'yes'
    continueonerrortype: ''
    id: '15'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '23'
      'yes':
      - '1'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: 'Check if any alerts are found that match the condition:

        - Any Agent alert within the incident

        - T1509 - Command And Scripting '
      id: 97ff710f-62a7-43ff-88a9-5db0e249c5ba
      iscommand: false
      name: Are any related alerts found?
      type: condition
      version: -1
    taskid: 97ff710f-62a7-43ff-88a9-5db0e249c5ba
    timertriggers: []
    type: condition
    view: "{\n  \"position\": {\n    \"x\": 960,\n    \"y\": 1450\n  }\n}"
  '16':
    continueonerrortype: ''
    id: '16'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '27'
    note: false
    quietmode: 0
    scriptarguments:
      process_command_line:
        complex:
          accessor: osparentcmd
          root: alert
          transformers:
          - operator: uniq
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Get the prevalence of a process_command_line, identified by process_command_line.
      id: 6c690921-6102-49f0-8b02-dfaeaa146641
      iscommand: true
      name: Run Prevalence Check On the Actor Process Command line
      script: '|||core-get-cmd-analytics-prevalence'
      type: regular
      version: -1
    taskid: 6c690921-6102-49f0-8b02-dfaeaa146641
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 1150,\n    \"y\": 240\n  }\n}"
  '17':
    continueonerror: true
    continueonerrortype: ''
    id: '17'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '5'
    note: false
    quietmode: 0
    scriptarguments:
      host_id:
        complex:
          accessor: hostname
          root: alert
          transformers:
          - operator: uniq
    separatecontext: false
    skipunavailable: true
    task:
      brand: ''
      description: Retrieve the risk score of a specific host or list of hosts with
        the highest risk score in the environment along with the reason affecting
        each score.
      id: 9ef73b4e-9fdb-4830-8d96-22951636dc3a
      iscommand: true
      name: Get Host Risk level
      script: '|||core-list-risky-hosts'
      type: regular
      version: -1
    taskid: 9ef73b4e-9fdb-4830-8d96-22951636dc3a
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 750,\n    \"y\": 770\n  }\n}"
  '2':
    continueonerrortype: ''
    id: '2'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '11'
    note: false
    quietmode: 0
    scriptarguments:
      closeNotes:
        simple: Suspicious activity detected
      closeReason:
        simple: Resolved - Handled by the playbook "Suspicious LDAP search query"
      id:
        complex:
          accessor: id
          root: alert
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Close the current alert as True Positive.
      id: f33eda55-1ee4-47ba-8c97-78e184242ed2
      iscommand: true
      name: Close Alert
      script: Builtin|||closeInvestigation
      type: regular
      version: -1
    taskid: f33eda55-1ee4-47ba-8c97-78e184242ed2
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 530,\n    \"y\": 2200\n  }\n}"
  '21':
    continueonerrortype: ''
    id: '21'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '2'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: "Dear Analyst,\n\nDuring the remediation process, the playbook\
        \ couldn\u2019t terminate the process: ${alert.cgoname}\n\nPlease terminate\
        \ the process manually if possible."
      id: b7fc67d2-52c1-4fe8-812c-78a66dec7df4
      iscommand: false
      name: Terminate Process Manually
      type: regular
      version: -1
    taskid: b7fc67d2-52c1-4fe8-812c-78a66dec7df4
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 300,\n    \"y\": 2000\n  }\n}"
  '22':
    continueonerrortype: ''
    id: '22'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '11'
    note: false
    quietmode: 0
    scriptarguments:
      closeNotes:
        simple: No Results Found
      closeReason:
        simple: Resolved - Handled by the playbook "Suspicious LDAP search query"
      id:
        simple: ${alert.id}
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Close the current alert as False Positive.
      id: c6396ab6-fae7-449f-8183-371e76961aa3
      iscommand: true
      name: Close Alert - No results returned
      script: Builtin|||closeInvestigation
      type: regular
      version: -1
    taskid: c6396ab6-fae7-449f-8183-371e76961aa3
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 960,\n    \"y\": 2200\n  }\n}"
  '23':
    continueonerrortype: ''
    id: '23'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '22'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 5c7832fc-9b3e-48b8-8c18-bf26c2ae7d79
      iscommand: false
      name: No Results Found
      type: title
      version: -1
    taskid: 5c7832fc-9b3e-48b8-8c18-bf26c2ae7d79
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 960,\n    \"y\": 1670\n  }\n}"
  '24':
    continueonerror: true
    continueonerrortype: errorPath
    id: '24'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#error#':
      - '21'
      '#none#':
      - '2'
    note: false
    quietmode: 0
    scriptarguments:
      agent_id:
        simple: ${alert.agentid}
      causality_id:
        simple: ${alert.cid}
      timeout_in_seconds:
        simple: '180'
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Terminate a process tree by its causality ID. Available only for
        XSIAM 2.4.
      id: 9759ea77-61ea-44ae-874e-9ed7424d93e5
      iscommand: true
      name: Terminate Causality (CGO)
      script: '|||core-terminate-causality'
      type: regular
      version: -1
    taskid: 9759ea77-61ea-44ae-874e-9ed7424d93e5
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 530,\n    \"y\": 1820\n  }\n}"
  '25':
    continueonerror: true
    continueonerrortype: ''
    id: '25'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '5'
    note: false
    quietmode: 0
    scriptarguments:
      user_id:
        complex:
          accessor: username
          root: alert
          transformers:
          - operator: uniq
    separatecontext: false
    skipunavailable: true
    task:
      brand: ''
      description: Retrieve the risk score of a specific user or list of users with
        the highest risk score in the environment along with the reason affecting
        each score.
      id: 6d5b8263-3c32-4a1d-84c5-4149ba5965a4
      iscommand: true
      name: Get User Risk level
      script: '|||core-list-risky-users'
      type: regular
      version: -1
    taskid: 6d5b8263-3c32-4a1d-84c5-4149ba5965a4
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 1150,\n    \"y\": 770\n  }\n}"
  '26':
    continueonerrortype: ''
    id: '26'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '16'
      - '3'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: d497e680-73d9-4034-864f-9aa9f8b24c50
      iscommand: false
      name: Continue Analysis - Prevalence
      type: title
      version: -1
    taskid: d497e680-73d9-4034-864f-9aa9f8b24c50
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 950,\n    \"y\": 100\n  }\n}"
  '27':
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: Core.AnalyticsPrevalence.Process.value
          operator: isEqualString
          right:
            value:
              simple: 'False'
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: Core.AnalyticsPrevalence.Cmd.value
          operator: isEqualString
          right:
            value:
              simple: 'False'
      label: 'Yes'
    continueonerrortype: ''
    id: '27'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '28'
      'Yes':
      - '1'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Check if the Actor Process Name and the Actor Process CMD are non-prevalent.
      id: 0de49009-967f-4bc9-898e-f3f6f7c914de
      iscommand: false
      name: Is this a non-prevalent Process Name and Process CMD?
      type: condition
      version: -1
    taskid: 0de49009-967f-4bc9-898e-f3f6f7c914de
    timertriggers: []
    type: condition
    view: "{\n  \"position\": {\n    \"x\": 950,\n    \"y\": 410\n  }\n}"
  '28':
    continueonerrortype: ''
    id: '28'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '17'
      - '25'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 026091ad-0d50-4890-8c6e-f19e7ba9f185
      iscommand: false
      name: Continue Analysis - Risk Score Level
      type: title
      version: -1
    taskid: 026091ad-0d50-4890-8c6e-f19e7ba9f185
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 950,\n    \"y\": 630\n  }\n}"
  '29':
    continueonerrortype: ''
    id: '29'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '4'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: ''
      id: 51393371-cf72-4158-8205-8af347bac7e1
      iscommand: false
      name: Continue Analysis - Related Alerts
      type: title
      version: -1
    taskid: 51393371-cf72-4158-8205-8af347bac7e1
    timertriggers: []
    type: title
    view: "{\n  \"position\": {\n    \"x\": 960,\n    \"y\": 1150\n  }\n}"
  '3':
    continueonerrortype: ''
    id: '3'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '27'
    note: false
    quietmode: 0
    scriptarguments:
      process_name:
        complex:
          accessor: osparentname
          root: alert
          transformers:
          - operator: uniq
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Get the prevalence of a process, identified by process_name.
      id: efbb43c2-6320-4c3d-8c3f-6e716e4b8c8d
      iscommand: true
      name: Run Prevalence Check On the Actor Process
      script: '|||core-get-process-analytics-prevalence'
      type: regular
      version: -1
    taskid: efbb43c2-6320-4c3d-8c3f-6e716e4b8c8d
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 750,\n    \"y\": 240\n  }\n}"
  '4':
    continueonerrortype: ''
    id: '4'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '15'
    note: false
    quietmode: 0
    scriptarguments:
      query:
        complex:
          accessor: parentXDRIncident
          root: alert
          transformers:
          - args:
              delimiter:
                value:
                  simple: '-'
              fields:
                value:
                  simple: '2'
            operator: Cut
          - args:
              prefix:
                value:
                  simple: '((mitreattcktechnique:*T1509* or (sourceBrand:TRAPS and
                    categoryname:Malware)) and caseid:'
              suffix:
                value:
                  simple: )
            operator: concat
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: 'This task searches for Cortex XSIAM suspicious alerts related
        to the current incident by Mitre Technique, indicating that the alert is part
        of an attack pattern.


        Focus on identifying alerts associated with the following MITRE techniques:

        - Any Agent Alerts within this incident.

        - T1059 - Command and Scripting Interpreter.'
      id: aa11e09b-0a87-4a3e-8ffc-a40b503527d9
      iscommand: false
      name: Search for suspicious-related alerts by MITRE Technique
      scriptName: SearchIncidentsV2
      type: regular
      version: -1
    taskid: aa11e09b-0a87-4a3e-8ffc-a40b503527d9
    timertriggers: []
    type: regular
    view: "{\n  \"position\": {\n    \"x\": 960,\n    \"y\": 1290\n  }\n}"
  '5':
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: Core.AnalyticsPrevalence.Process.value
          operator: isEqualString
          right:
            value:
              simple: 'False'
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: Core.AnalyticsPrevalence.Process.value
          operator: isEqualString
          right:
            value:
              simple: 'False'
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: Core.RiskyHost.risk_level
          operator: isEqualString
          right:
            value:
              simple: High
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: Core.RiskyHost.risk_level
          operator: isEqualString
          right:
            value:
              simple: Medium
        - ignorecase: true
          left:
            iscontext: true
            value:
              simple: Core.RiskyUser.risk_level
          operator: isEqualString
          right:
            value:
              simple: High
      label: 'Yes'
    continueonerrortype: ''
    id: '5'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '29'
      'Yes':
      - '1'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: "#### Determines if the LDAP operation was suspicious by the following\
        \ conditions:\n\nActor Process name is not Prevalent *OR*\nActor Process Command\
        \ Line is not Prevalent \n\n*AND*\n\nThe Host Risk Score is Medium or High\
        \ or the User Risk Score is High."
      id: b9bbfbad-b31e-4141-820d-447ae8cbb61a
      iscommand: false
      name: Any risky asset involved with at least one non-prevalent action?
      type: condition
      version: -1
    taskid: b9bbfbad-b31e-4141-820d-447ae8cbb61a
    timertriggers: []
    type: condition
    view: "{\n  \"position\": {\n    \"x\": 960,\n    \"y\": 940\n  }\n}"
tests:
- No tests (auto formatted)
version: -1
view: "{\n  \"linkLabelsPosition\": {\n    \"14_1_yes\": 0.15,\n    \"14_26_#default#\"\
  : 0.39,\n    \"15_1_yes\": 0.22,\n    \"15_23_#default#\": 0.61,\n    \"24_21_#error#\"\
  : 0.5\n  },\n  \"paper\": {\n    \"dimensions\": {\n      \"height\": 2795,\n  \
  \    \"width\": 1230,\n      \"x\": 300,\n      \"y\": -360\n    }\n  }\n}"
