id: Compromise Accounts - User rejected numerous SSO MFA attempts
version: -1
name: Compromise Accounts - User rejected numerous SSO MFA attempts
description: |-
  This playbook addresses the following alerts:

  - User rejected numerous SSO MFA attempts
  - Multiple SSO MFA attempts were rejected by a user with suspicious characteristics

  Playbook Stages:

  Triage:
  - The playbook checks the IP address reputation associated with the MFA attempts and gathers related login events.

  Early Containment:
  - If the IP address is identified as malicious, the playbook blocks the IP. The investigation continues in parallel to this phase.

  Investigation:
  - The playbook performs an in-depth analysis, including:
    - Assessing the user's risk score to identify potentially compromised accounts.
    - Checking for an unusually high number of invalid credential attempts, which may indicate brute-force or credential-stuffing activity.
    - Verifying whether Okta logs indicate a malicious source IP based on Okta's threat intelligence.
    - Reviewing whether there have been an excessive number of MFA rejections from the user, suggesting potentially compromised behavior.
    - Looking for abnormal user agent patterns that may indicate suspicious or compromised access methods.
    - Investigating previous failed Okta login attempts within a specified timeframe to identify patterns.

  Containment:
  - If suspicious activity is confirmed, the playbook initiates the following containment actions:
    - Clears the user's active sessions and expires their password to prevent further unauthorized access.
    - If a successful login attempt was also detected, the playbook prompts a manual task for an analyst to review and decide on further action.

  Requirements:
  For any response actions, the following integration is required:
  - Okta v2

  For early containment actions, the following integration is required:
  - Palo Alto Networks PAN-OS.
tags:
- T1586 - Compromise Accounts
- T1621 - Multi-Factor Authentication Request Generation
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 3c1c16fa-1ef0-45e5-884c-ab0b666b5bd5
    type: start
    task:
      id: 3c1c16fa-1ef0-45e5-884c-ab0b666b5bd5
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 50
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 40837361-1189-4780-8e01-5a3ffbed66e7
    type: regular
    task:
      id: 40837361-1189-4780-8e01-5a3ffbed66e7
      version: -1
      name: Check source IP reputation
      description: Enriches the external source IP of the attack to check if it's known as malicious. Skips on errors for cases where the IP address or the !ip command is empty.
      script: '|||ip'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      ip:
        simple: ${alert.localip}
    reputationcalc: 2
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 205
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 9b4ff489-973d-4783-8280-7d66e59e4a78
    type: condition
    task:
      id: 9b4ff489-973d-4783-8280-7d66e59e4a78
      version: -1
      name: Is the IP malicious?
      description: Checks if the external Source IP is malicious (DBotScore above 2).
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "24"
      "Yes":
      - "3"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                - - operator: greaterThan
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "2"
                - - operator: inList
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: alert.localip
                      iscontext: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: alert.localip
                accessor: Indicator
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 365
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 8b177482-e4ac-4eeb-8563-b66d104e53c0
    type: title
    task:
      id: 8b177482-e4ac-4eeb-8563-b66d104e53c0
      version: -1
      name: Early Containment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "37"
      - "6"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 930,
          "y": 550
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: fc4cb507-de78-46ea-846f-763a27e62066
    type: playbook
    task:
      id: fc4cb507-de78-46ea-846f-763a27e62066
      version: -1
      name: PAN-OS - Block IP
      description: |-
        This playbook blocks IP addresses with 2 optional actions:

        - Block IP addresses using Static Address Groups in Palo Alto Networks Panorama or Firewall. The playbook receives malicious IP addresses and an address group name as inputs, verifies that the addresses are not already a part of the address group, adds them and commits the configuration.


        - Utilize the Dynamic Address Group (DAG) capability of PAN-OS. DAG enables analysts to create a rule one time, where the group is the source/destination, and adds IP addresses dynamically without the need to commit the configuration every time.
        The playbook checks if the given tag already exists. If the tag exists, then the IP address is added to the tag.
        If the tag does not exist, a new address group is created with the given tag and a matching rule, and the configuration is committed.
      playbookName: PAN-OS - Block IP
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "28"
    scriptarguments:
      MaliciousIPs:
        simple: ${MaliciousIPs}
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
      forEach: true
    view: |-
      {
        "position": {
          "x": 930,
          "y": 905
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 46b37454-1c80-48d8-8daf-fa93c12bfd31
    type: playbook
    task:
      id: 46b37454-1c80-48d8-8daf-fa93c12bfd31
      version: -1
      name: Containment Plan - Clear User Sessions
      description: |-
        ## Containment Plan - Clear User Sessions

        This playbook is a sub-playbook within the containment plan playbook.
        The playbook uses the 'Okta v2' and 'MSGraph User' integrations to clear user sessions.
      playbookName: Containment Plan - Clear User Sessions
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      ClearUserSessions:
        simple: "True"
      Username:
        simple: ${UserEmail}
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2370
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: 658cf37d-0923-4faa-8312-ae89c4126a9b
    type: regular
    task:
      id: 658cf37d-0923-4faa-8312-ae89c4126a9b
      version: -1
      name: Collect login information
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "7"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 710
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: 67ef6ccd-768f-42f2-8232-2e5564e82ea6
    type: title
    task:
      id: 67ef6ccd-768f-42f2-8232-2e5564e82ea6
      version: -1
      name: Analyze Alert Data
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "15"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 920
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 98d94edd-6356-4e64-890f-615b45329be0
    type: condition
    task:
      id: 98d94edd-6356-4e64-890f-615b45329be0
      description: Checks whether the alert indicates that there was a successful login or not.
      version: -1
      name: Check for successful login
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "9"
      "yes":
      - "17"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: notContainsGeneral
          left:
            value:
              simple: alert.details
            iscontext: true
          right:
            value:
              simple: . 0 successful
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2745
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: f3c46c59-796e-4785-8d2f-d345efa31b3e
    type: title
    task:
      id: f3c46c59-796e-4785-8d2f-d345efa31b3e
      version: -1
      name: Close Alert
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "10"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 3940
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: 05b84a54-2847-4e2d-8689-02344f5e62af
    type: regular
    task:
      id: 05b84a54-2847-4e2d-8689-02344f5e62af
      version: -1
      name: Close Alert
      description: commands.local.cmd.close.inv
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 4080
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: e8ef5fca-3bae-4fd9-8786-7d781faa967b
    type: regular
    task:
      id: e8ef5fca-3bae-4fd9-8786-7d781faa967b
      version: -1
      name: Expire Okta User's Password
      description: Expires a password for an existing Okta user.
      script: '|||okta-expire-password'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "8"
    scriptarguments:
      username:
        simple: ${UserEmail}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2560
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: dc13989a-aa91-4d48-829b-7f6a2a6ae43d
    type: collection
    task:
      id: dc13989a-aa91-4d48-829b-7f6a2a6ae43d
      description: ""
      version: -1
      name: Manual task - Suspend user in Okta
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 3120
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: Do you want to suspend the user ${Core.OriginalAlert.raw_abioc.event.auth_normalized_user.upn} in Okta?
        required: false
        gridcolumns: []
        defaultrows: []
        type: singleSelect
        options: []
        optionsarg:
        - simple: "Yes"
        - simple: "No"
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Okta - Suspend User
      description: Please choose whether to suspend the user in Okta.
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 270ad864-dbaa-4d8b-841b-b481d7e637c3
    type: condition
    task:
      id: 270ad864-dbaa-4d8b-841b-b481d7e637c3
      description: ""
      version: -1
      name: Evaluate Analyst Response for Next Action
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "9"
      "yes":
      - "14"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Okta - suspend user.Answers.0
            iscontext: true
          right:
            value:
              simple: "Yes"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 3300
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: d167e7f7-097d-4b88-8ab6-ea93935532d2
    type: regular
    task:
      id: d167e7f7-097d-4b88-8ab6-ea93935532d2
      version: -1
      name: Suspend user in Okta
      description: Suspends a single user. This operation can only be performed on users with an ACTIVE status. After the porcess is completed, the user's status is SUSPENDED.
      script: '|||okta-suspend-user'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      username:
        simple: ${UserEmail}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 3565
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 86ba06cd-663e-43af-81ce-018752dc81b0
    type: regular
    task:
      id: 86ba06cd-663e-43af-81ce-018752dc81b0
      version: -1
      name: Get user email
      description: Save the user email from the alert data to a dedicated context field.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "23"
    scriptarguments:
      key:
        simple: UserEmail
      value:
        complex:
          root: Core.OriginalAlert.raw_abioc.event.auth_normalized_user
          accessor: upn
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1090
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: 2ef41483-3df0-45f2-8e26-60396e063894
    type: title
    task:
      id: 2ef41483-3df0-45f2-8e26-60396e063894
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "5"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: e1031c82-be46-499f-8421-e7b88fce8d09
    type: title
    task:
      id: e1031c82-be46-499f-8421-e7b88fce8d09
      version: -1
      name: Successful Login Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "12"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2950
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 8a27ccef-05a6-4e17-89a3-fda8d389290c
    type: title
    task:
      id: 8a27ccef-05a6-4e17-89a3-fda8d389290c
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 4290
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: b350e54c-6a7a-41ae-88b6-edbfac3a5893
    type: condition
    task:
      id: b350e54c-6a7a-41ae-88b6-edbfac3a5893
      description: This task analyzes Okta SSO debug logs for suspicious activity. It checks for anomalous behavior, high-risk levels, and unusual geographic patterns in user actions. The task evaluates various risk indicators including new locations, devices, IPs, and velocity anomalies. It also considers the diversity and rarity of countries involved in user actions. Based on these checks, the playbook determines whether to proceed with remediation or continue to the Close Alert section.
      version: -1
      name: Check Okta logs for suspicious activity
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "28"
      REMEDIATION:
      - "16"
    separatecontext: false
    conditions:
    - label: REMEDIATION
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: OktaSSODebugLogs
                filters:
                - - operator: containsString
                    left:
                      value:
                        simple: OktaSSODebugLogs.risk
                      iscontext: true
                    right:
                      value:
                        simple: reasons=Anomalous
                    ignorecase: true
                - - operator: containsString
                    left:
                      value:
                        simple: OktaSSODebugLogs.risk
                      iscontext: true
                    right:
                      value:
                        simple: ', Anomalous'
                    ignorecase: true
                - - operator: containsString
                    left:
                      value:
                        simple: OktaSSODebugLogs.risk
                      iscontext: true
                    right:
                      value:
                        simple: level=HIGH
                    ignorecase: true
                - - operator: containsString
                    left:
                      value:
                        simple: OktaSSODebugLogs.behaviors
                      iscontext: true
                    right:
                      value:
                        simple: New Geo-Location=POSITIVE, New Device=POSITIVE, New IP=POSITIVE, New State=POSITIVE, New Country=POSITIVE, Velocity=POSITIVE, New City=POSITIVE
                    ignorecase: true
            iscontext: true
          right:
            value: {}
      - - operator: greaterThanOrEqual
          left:
            value:
              simple: Core.OriginalAlert.stateful_raw_data.count_distinct_action_country
            iscontext: true
          right:
            value:
              simple: "3"
        - operator: greaterThanOrEqual
          left:
            value:
              simple: Core.OriginalAlert.stateful_raw_data.count_distinct_action_country_is_rare_for_tenant
            iscontext: true
          right:
            value:
              simple: "1"
        - operator: greaterThanOrEqual
          left:
            value:
              simple: Core.OriginalAlert.stateful_raw_data.count_distinct_action_country_first_seen
            iscontext: true
          right:
            value:
              simple: "1"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -550,
          "y": 1660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: faf7c203-7af2-49dd-8318-64696ba0fd66
    type: title
    task:
      id: faf7c203-7af2-49dd-8318-64696ba0fd66
      version: -1
      name: Check Okta Debug Logs
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -550,
          "y": 1510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: 2cadb30a-b596-43aa-8202-4d1bb2f3f534
    type: title
    task:
      id: 2cadb30a-b596-43aa-8202-4d1bb2f3f534
      version: -1
      name: Check Alert Data
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "22"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -50,
          "y": 1510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 58d4c789-4f97-4a54-8c27-6b1192b5dad6
    type: condition
    task:
      id: 58d4c789-4f97-4a54-8c27-6b1192b5dad6
      description: This task evaluates potential security threats by examining multiple factors. It checks for at least 6 instances of invalid credentials, verifies if Okta's threat intelligence has flagged a potentially malicious IP involved in the authentication attempt, and confirms if there have been 5 or more distinct Okta push denials. If these conditions are met, the task initiates remediation steps; if not, it proceeds to the Close Alert section.
      version: -1
      name: Verify High-Risk Alert with Rare Country Indicators
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "28"
      REMEDIATION:
      - "16"
    separatecontext: false
    conditions:
    - label: REMEDIATION
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Core.OriginalAlert._all_events.auth_outcome_reason
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: Core.OriginalAlert._all_events.auth_outcome_reason
                      iscontext: true
                    right:
                      value:
                        simple: INVALID_CREDENTIALS
                    ignorecase: true
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "6"
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: OktaSSODebugLogs.threatSuspected
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: OktaSSODebugLogs.threatSuspected
                      iscontext: true
                    right:
                      value:
                        simple: "true"
                    ignorecase: true
                transformers:
                - operator: uniq
            iscontext: true
          ignorecase: true
        - operator: greaterThanOrEqual
          left:
            value:
              simple: OktaSSODebugLogs.count_distinct_story_id_okta_push_denied
            iscontext: true
          right:
            value:
              simple: "5"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -50,
          "y": 1660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: 943219e8-cd9a-4a91-835b-7567d0048d93
    type: regular
    task:
      id: 943219e8-cd9a-4a91-835b-7567d0048d93
      version: -1
      name: Parse Okta SSO logs
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "25"
      - "20"
      - "21"
      - "29"
      - "31"
    scriptarguments:
      key:
        simple: OktaSSODebugLogs
      value:
        complex:
          root: Core.OriginalAlert._all_events
          accessor: sso_debug_data
          transformers:
          - operator: ParseJSON
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1270
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 4211b24a-e010-46e9-80e4-bf1d1e26b75a
    type: title
    task:
      id: 4211b24a-e010-46e9-80e4-bf1d1e26b75a
      version: -1
      name: Get Additional Data
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "6"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 550
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: d52f741c-18d8-45e9-82e1-74e084d04264
    type: title
    task:
      id: d52f741c-18d8-45e9-82e1-74e084d04264
      version: -1
      name: Check If User Is Risky
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "26"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: 3944cbb0-fe81-4369-8471-687290537bd8
    type: regular
    task:
      id: 3944cbb0-fe81-4369-8471-687290537bd8
      version: -1
      name: Get user risk score
      description: Retrieve the risk score of a specific user or list of users with the highest risk score in the environment along with the reason affecting each score.
      script: '|||core-list-risky-users'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "27"
    scriptarguments:
      user_id:
        complex:
          root: alert
          accessor: username
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: 7833a18c-58f0-4863-8b52-94156396f9f0
    type: condition
    task:
      id: 7833a18c-58f0-4863-8b52-94156396f9f0
      description: This task evaluates if the user's risk level is HIGH. If so, it initiates remediation steps; otherwise, it moves to the Close Alert section.
      version: -1
      name: Check risk score
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "28"
      REMEDIATION:
      - "16"
    separatecontext: false
    conditions:
    - label: REMEDIATION
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.RiskyUser.risk_level
            iscontext: true
          right:
            value:
              simple: HIGH
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1820
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: cc9fa8ce-96ef-4665-8fc2-78c771bb8faf
    type: title
    task:
      id: cc9fa8ce-96ef-4665-8fc2-78c771bb8faf
      version: -1
      name: Close Alert
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "9"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 960,
          "y": 2230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 03472527-de67-4e03-8491-e06a0bd3bc16
    type: title
    task:
      id: 03472527-de67-4e03-8491-e06a0bd3bc16
      version: -1
      name: Check Previous Okta Failed Logins
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "33"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 960,
          "y": 1510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: f0183f8d-52ca-4cb7-86fd-d536840c8481
    type: title
    task:
      id: f0183f8d-52ca-4cb7-86fd-d536840c8481
      version: -1
      name: Check for Suspicious User-Agent
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "32"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1470,
          "y": 1510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: 58c0faed-8796-4564-88c6-6ba4df658748
    type: condition
    task:
      id: 58c0faed-8796-4564-88c6-6ba4df658748
      description: This task examines the user agent strings in the alert for known suspicious patterns. It checks for specific tools often used in automated attacks or scraping. Additionally, it verifies if there's at least one new user agent for this user. If both conditions are met, it triggers remediation; otherwise, it proceeds to close the alert.
      version: -1
      name: Check for a suspicious user agent
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "28"
      REMEDIATION:
      - "16"
    separatecontext: false
    conditions:
    - label: REMEDIATION
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: Core.OriginalAlert._all_events.action_user_agent
                filters:
                - - operator: match
                    left:
                      value:
                        simple: Core.OriginalAlert._all_events.action_user_agent
                      iscontext: true
                    right:
                      value:
                        simple: \b(Python-urllib|libwww-perl|Scrapy|curl|Wget|sqlmap|Nikto|Xrumer|Hydra|JohnTheRipper|LOIC|HOIC|MJ12bot|Baiduspider|BlackWidow|HeadlessChrome|PhantomJS|Selenium|python-requests|node-fetch|PostmanRuntime|GuzzleHttp)\b
            iscontext: true
          right:
            value: {}
      - - operator: greaterThanOrEqual
          left:
            value:
              simple: Core.OriginalAlert.stateful_raw_data.count_distinct_user_agent_first_seen_for_user
            iscontext: true
          right:
            value:
              simple: "1"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1470,
          "y": 1640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 998bf172-5600-4306-8d9c-cc9eea95baa5
    type: regular
    task:
      id: 998bf172-5600-4306-8d9c-cc9eea95baa5
      version: -1
      name: Retrieve timestamp for 12 hours window
      description: |
        Retrieves the current date and time.
      scriptName: GetTime
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    scriptarguments:
      hoursAgo:
        simple: "12"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 960,
          "y": 1640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 6d6aef9e-f910-4a1f-8f04-af703601cdcd
    type: regular
    task:
      id: 6d6aef9e-f910-4a1f-8f04-af703601cdcd
      version: -1
      name: Get Okta failed logins
      description: Returns failed login events.
      script: '|||okta-get-failed-logins'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "35"
    scriptarguments:
      since:
        complex:
          root: TimeNow
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: in 0 hours
      until:
        complex:
          root: TimeNow
          transformers:
          - operator: ModifyDateTime
            args:
              variation:
                value:
                  simple: in 12 hours
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 960,
          "y": 1800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: 1cad129b-ca77-442c-88e1-0545426e7a7a
    type: condition
    task:
      id: 1cad129b-ca77-442c-88e1-0545426e7a7a
      description: This task checks Okta logs for 5 or more failed login attempts by the user within the past 12 hours. If threshold is met, it triggers remediation; otherwise, it closes the alert.
      version: -1
      name: Check for 5 failed logins
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "28"
      REMEDIATION:
      - "16"
    separatecontext: false
    conditions:
    - label: REMEDIATION
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              complex:
                root: Okta.Logs.Events.actor.alternateId
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: Okta.Logs.Events.actor.alternateId
                      iscontext: true
                    right:
                      value:
                        simple: UserEmail
                      iscontext: true
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "5"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 960,
          "y": 1960
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: c6b2f1f5-c7f2-49c5-8d6d-ffab80c6205e
    type: regular
    task:
      id: c6b2f1f5-c7f2-49c5-8d6d-ffab80c6205e
      version: -1
      name: Save malicious IPs to be blocked
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      key:
        simple: MaliciousIPs
      value:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          - - operator: inList
              left:
                value:
                  simple: DBotScore.Indicator
                iscontext: true
              right:
                value:
                  simple: alert.localip
                iscontext: true
            - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Indicator
                iscontext: true
              right:
                value:
                  simple: alert.localip
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: ip
              ignorecase: true
          accessor: Indicator
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 930,
          "y": 710
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "13_14_yes": 0.55,
      "13_9_#default#": 0.14,
      "19_16_REMEDIATION": 0.1,
      "19_28_#default#": 0.15,
      "22_16_REMEDIATION": 0.17,
      "22_28_#default#": 0.22,
      "27_16_REMEDIATION": 0.35,
      "27_28_#default#": 0.1,
      "32_16_REMEDIATION": 0.13,
      "32_28_#default#": 0.34,
      "35_16_REMEDIATION": 0.19,
      "35_28_#default#": 0.26,
      "8_9_#default#": 0.16
    },
    "paper": {
      "dimensions": {
        "height": 4305,
        "width": 2400,
        "x": -550,
        "y": 50
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 8.8.0
marketplaces:
- marketplacev2
