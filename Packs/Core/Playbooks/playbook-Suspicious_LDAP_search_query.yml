id: Suspicious LDAP search query
version: -1
name: Suspicious LDAP search query
description: "This playbook is designed to handle the following alerts:  \n- Possible LDAP enumeration by unsigned process (medium severity)\n- Suspicious LDAP search query executed (High severity)\n\nThe playbook executes the following stages:\n\nInvestigation:\nCheck the following parameters to determine if remediation actions are needed:\n- Cortex XSIAM alerts related to the hostname by MITRE tactics indicating malicious activity.\n- Whether the Actor Process Command line contains suspicious arguments.\n- Checks for prevalence of the Actor Process Name and Actor Process CMD.\n- Host risk score is \"Medium\" or \"High\".\n- User risk score is \"High\".\n\nRemediation:\n- Handles malicious alerts by terminating the relevant processes.\n- Handles non-malicious alerts identified during the investigation."
tags:
- T1087 - Account Discovery
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 9d906ae4-3dc3-471a-8c5f-23910a85b763
    type: start
    task:
      id: 9d906ae4-3dc3-471a-8c5f-23910a85b763
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "13"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 530,
          "y": -370
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 009f925e-5dd8-41cf-8880-f8fd6ca82fc5
    type: title
    task:
      id: 009f925e-5dd8-41cf-8880-f8fd6ca82fc5
      version: -1
      name: Remediation
      description: Terminate a process tree by its causality ID. Available only for XSIAM 2.4.
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "24"
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": 530,
          "y": 1000
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 744e8ceb-9803-49e8-8383-ec003eaa4c89
    type: regular
    task:
      id: 744e8ceb-9803-49e8-8383-ec003eaa4c89
      version: -1
      name: Close Alert
      description: Close the current alert as True Positive.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      closeNotes:
        simple: Suspicious activity detected
      closeReason:
        simple: Resolved - Handled by the playbook "Suspicious LDAP search query"
      id:
        complex:
          root: alert
          accessor: id
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 530,
          "y": 1470
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 9cd3a2cd-8887-45d7-85b9-3b1f59b4cf40
    type: regular
    task:
      id: 9cd3a2cd-8887-45d7-85b9-3b1f59b4cf40
      version: -1
      name: Run Prevalence Check On the Actor Process
      description: Get the prevalence of a process, identified by process_name.
      script: '|||core-get-process-analytics-prevalence'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      process_name:
        complex:
          root: alert
          accessor: osparentname
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 750,
          "y": 260
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: 81ca3384-2d21-427b-800b-cf5afc21d27f
    type: regular
    task:
      id: 81ca3384-2d21-427b-800b-cf5afc21d27f
      version: -1
      name: Search for suspicious-related alerts by MITRE Technique
      description: |-
        This task searches for Cortex XSIAM suspicious alerts related to the current incident by Mitre Technique, indicating that the alert is part of an attack pattern.

        Focus on identifying alerts associated with the following MITRE techniques:
        - Any Agent Alerts within this incident.
        - T1059 - Command and Scripting Interpreter.
      scriptName: SearchAlertsV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      query:
        complex:
          root: alert
          accessor: parentXDRIncident
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: '-'
              fields:
                value:
                  simple: "2"
          - operator: concat
            args:
              prefix:
                value:
                  simple: '((mitreattcktechnique:*T1509* or (sourceBrand:TRAPS and categoryname:Malware)) and caseid:'
              suffix:
                value:
                  simple: )
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1570,
          "y": 600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 337f923f-d491-41ec-8d15-4034943b5796
    type: condition
    task:
      id: 337f923f-d491-41ec-8d15-4034943b5796
      version: -1
      name: Is this a non-legit operation?
      description: "## Determines if the LDAP operation was suspicious by the following conditions:\n\n- *Without Host Risk Score:*  \nActor Process name is not Prevalent *AND*\nActor Process Command Line is not Prevalent *AND*\nNo Risk Asset Score.\n\n- *With Host Risk Score:*  \n[Actor Process name is not Prevalent *OR*\nActor Process Command Line is not Prevalent] *AND*\nThe Host Risk Score is Medium or High or the User Risk Score is High."
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "4"
      Yes - With Risky Asset Score:
      - "19"
      yes - without Risky Asset Score:
      - "18"
    separatecontext: false
    conditions:
    - label: yes - without Risky Asset Score
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.AnalyticsPrevalence.Process.value
            iscontext: true
          right:
            value:
              simple: "False"
          ignorecase: true
      - - operator: isEqualString
          left:
            value:
              simple: Core.AnalyticsPrevalence.Cmd.value
            iscontext: true
          right:
            value:
              simple: "False"
          ignorecase: true
      - - operator: isEmpty
          left:
            value:
              simple: Core.RiskyHost.risk_level
            iscontext: true
          ignorecase: true
      - - operator: isEmpty
          left:
            value:
              simple: Core.RiskyUser.risk_level
            iscontext: true
    - label: Yes - With Risky Asset Score
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: Core.AnalyticsPrevalence.Process.value
            iscontext: true
          right:
            value:
              simple: "False"
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: Core.AnalyticsPrevalence.Process.value
            iscontext: true
          right:
            value:
              simple: "False"
          ignorecase: true
      - - operator: isEqualString
          left:
            value:
              simple: Core.RiskyHost.risk_level
            iscontext: true
          right:
            value:
              simple: High
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: Core.RiskyHost.risk_level
            iscontext: true
          right:
            value:
              simple: Medium
          ignorecase: true
        - operator: isEqualString
          left:
            value:
              simple: Core.RiskyUser.risk_level
            iscontext: true
          right:
            value:
              simple: High
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1370,
          "y": 430
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: 1b894c70-4c9c-4850-877d-386ee765f658
    type: title
    task:
      id: 1b894c70-4c9c-4850-877d-386ee765f658
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 530,
          "y": 1640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 1b85eb9d-cfe6-4c8c-89bf-dfb10f63657e
    type: playbook
    task:
      id: 1b85eb9d-cfe6-4c8c-89bf-dfb10f63657e
      version: -1
      name: Command-Line Analysis
      description: "This playbook takes a command line from the alert and performs the following actions:\n- Checks for base64 string and decodes if exists\n- Extracts and enriches indicators from the command line\n- Checks specific arguments for malicious usage \n\nAt the end of the playbook, it sets a possible verdict for the command line, based on the finding:\n1. Indicators found in the command line\n2. Found AMSI techniques\n3. Found suspicious parameters\n4. Usage of malicious tools\n5. Indication of network activity\n6. Indication of suspicious LOLBIN execution\n\nNote: To run this playbook with a list of command lines, set this playbook to run in a loop. To do so, navigate to 'Loop'  and check \"For Each Input\"."
      playbookName: Command-Line Analysis
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      Commandline:
        complex:
          root: alert
          accessor: cgocmd
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: alert.osparentcmd
                iscontext: true
          - operator: uniq
      StringSimilarityThreshold:
        simple: "0.5"
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
      forEach: true
    view: |-
      {
        "position": {
          "x": 530,
          "y": -240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 44803b1b-175d-4859-8386-b28771927669
    type: condition
    task:
      id: 44803b1b-175d-4859-8386-b28771927669
      version: -1
      name: Are There Any Suspicious Findings?
      description: Check if any suspicious arguments were found in the Actor Process Command Line.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "26"
      "yes":
      - "1"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: CommandlineVerdict
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 530,
          "y": -70
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 4613d710-21d0-4064-8075-83de01c1dc29
    type: condition
    task:
      id: 4613d710-21d0-4064-8075-83de01c1dc29
      version: -1
      name: Are any related alerts found?
      description: "Check if any alerts are found that match the condition:\n- Any Agent alert within the incident\n- T1509 - Command And Scripting "
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "23"
      "yes":
      - "1"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: foundIncidents
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1570,
          "y": 785
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: b1ec4bb7-674f-4a8e-843a-25fb5d485d2c
    type: regular
    task:
      id: b1ec4bb7-674f-4a8e-843a-25fb5d485d2c
      version: -1
      name: Run Prevalence Check On the Actor Process Command line
      description: Get the prevalence of a process_command_line, identified by process_command_line.
      script: '|||core-get-cmd-analytics-prevalence'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      process_command_line:
        complex:
          root: alert
          accessor: osparentcmd
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1150,
          "y": 260
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 793ca822-0c1c-45b6-8a09-436a10eb645c
    type: regular
    task:
      id: 793ca822-0c1c-45b6-8a09-436a10eb645c
      version: -1
      name: Get Host Risk level
      description: Retrieve the risk score of a specific host or list of hosts with the highest risk score in the environment along with the reason affecting each score.
      script: '|||core-list-risky-hosts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      host_id:
        complex:
          root: alert
          accessor: hostname
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1550,
          "y": 260
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 4102fe2a-d84e-496e-8d33-41c47532501f
    type: title
    task:
      id: 4102fe2a-d84e-496e-8d33-41c47532501f
      version: -1
      name: Without the Risky Asset Score
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 750,
          "y": 600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: 9ae41752-a97c-4709-8d1e-80cae1547a18
    type: title
    task:
      id: 9ae41752-a97c-4709-8d1e-80cae1547a18
      version: -1
      name: With the Risky Asset Score
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 890,
          "y": 780
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: 5a63451a-6fd1-4420-82e9-fc7fdfdc9478
    type: regular
    task:
      id: 5a63451a-6fd1-4420-82e9-fc7fdfdc9478
      version: -1
      name: Terminate Process Manually
      description: |-
        Dear Analyst,

        During the remediation process, the playbook couldn’t terminate the process: ${alert.cgoname}

        Please terminate the process manually if possible.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 780,
          "y": 1300
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: ba2362bc-345e-417c-8658-9eed09038d85
    type: regular
    task:
      id: ba2362bc-345e-417c-8658-9eed09038d85
      version: -1
      name: Close Alert - No results returned
      description: Close the current alert as False Positive.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      closeNotes:
        simple: No Results Found
      closeReason:
        simple: Resolved - Handled by the playbook "Suspicious LDAP search query"
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1570,
          "y": 1470
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: e8adea73-1369-4e84-8968-baef42ca9b0c
    type: title
    task:
      id: e8adea73-1369-4e84-8968-baef42ca9b0c
      version: -1
      name: No Results Found
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "22"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1570,
          "y": 1000
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 38298117-7339-4604-84c7-214c3b92d254
    type: regular
    task:
      id: 38298117-7339-4604-84c7-214c3b92d254
      version: -1
      name: Terminate Causality (CGO)
      description: Terminate a process tree by its causality ID. Available only for XSIAM 2.4.
      script: '|||core-terminate-causality'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#error#':
      - "21"
      '#none#':
      - "2"
    scriptarguments:
      agent_id:
        simple: ${alert.agentid}
      causality_id:
        simple: ${alert.cid}
    separatecontext: false
    continueonerror: true
    continueonerrortype: errorPath
    view: |-
      {
        "position": {
          "x": 530,
          "y": 1130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 20c0facd-6b56-4301-8c5b-0d3e465ef742
    type: regular
    task:
      id: 20c0facd-6b56-4301-8c5b-0d3e465ef742
      version: -1
      name: Get User Risk level
      description: Retrieve the risk score of a specific user or list of users with the highest risk score in the environment along with the reason affecting each score.
      script: '|||core-list-risky-users'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      user_id:
        complex:
          root: alert
          accessor: username
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1950,
          "y": 260
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: 9c09f54e-0bf2-4440-8354-eb0c545192ac
    type: title
    task:
      id: 9c09f54e-0bf2-4440-8354-eb0c545192ac
      version: -1
      name: Continue Analysis
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "25"
      - "17"
      - "16"
      - "3"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1350,
          "y": 110
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "14_1_yes": 0.15,
      "14_26_#default#": 0.39,
      "15_1_yes": 0.22,
      "15_23_#default#": 0.61,
      "24_21_#error#": 0.5,
      "5_18_yes - without Risky Asset Score": 0.66,
      "5_19_Yes - With Risky Asset Score": 0.72,
      "5_4_#default#": 0.51
    },
    "paper": {
      "dimensions": {
        "height": 2075,
        "width": 1800,
        "x": 530,
        "y": -370
      }
    }
  }
inputs: []
outputs: []
tests:
- No tests (auto formatted)
fromversion: 8.8.0
