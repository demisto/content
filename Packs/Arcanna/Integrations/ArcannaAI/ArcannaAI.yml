commonfields:
  id: Arcanna.AI
  version: -1
vcShouldKeepItemLegacyProdMachine: false
name: Arcanna.AI
display: Arcanna.AI
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: Arcanna integration for using the power of AI in SOC
detaileddescription: "## API Key\nAn API Key from your Arcanna instance is required.
  \nIf you do not have a key, you can obtain one by going to your **Arcanna instance
  > Profile > API Keys > Add new User Key**\n\n## Create Arcanna integration and adding
  key\nNavigate to  your **Arcanna instance > Integrations > Add new Integration >
  Create a new integration with the API key created above** \n\n## Default Job ID\nFor
  the configuration, you can configure the Arcanna *default job Id* either as parameters
  or as command argument.\n\nIf the job Id was configured both as parameter and as
  command argument, the commands argument will be used.\n\n\n\n## Contact\nEmail at
  dev@siscale.com\n\nMore information is available at\n[View  Documentation](https://arcanna.ai)"
configuration:
- display: Server URL (e.g. https://<your arcanna ai api>/ )
  name: url
  defaultvalue: https://arcanna.ai/
  type: 0
  required: true
  additionalinfo: URL for Arcanna REST API
- displayPassword: API Key
  name: credentials
  type: 9
  required: false
  hiddenusername: true
  additionalinfo: Api Key for Arcanna API
- display: SSL Certificate verification
  name: ssl_verification
  defaultvalue: "false"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  type: 8
  required: false
- display: Default Arcanna Job Id
  name: default_job_id
  defaultvalue: "1201"
  type: 0
  required: false
script:
  script: |-
    # noqa: F401
      # noqa: F401
      # noqa: F401
    import json
    import urllib3
    import traceback
    import requests
    import time
    from typing import Any, Dict

    # Disable insecure warnings
    urllib3.disable_warnings()

    ''' CLIENT CLASS '''




class Client(BaseClient):
    """
    Implements Arcanna API
    """

    def test_arcanna(self) -> Dict[str, Any]:
        return self._http_request(
            method="GET",
            url_suffix="/api/v1/health/"
        )

    def list_jobs(self):
        return self._http_request(
            method="GET",
            url_suffix="/api/v1/jobs/",
            ok_codes=(200,201,422)
        )

    def export_event(self, job_id: int, event_id: str) -> Dict[str, Any]:
        return self._http_request(
            method="GET",
            url_suffix=f"/api/v1/events/{job_id}/{event_id}/export",
            ok_codes=(200,201,422)
        )

    def trigger_training(self, job_id: int, username: str) -> Dict[str, Any]:
        return self._http_request(
            method="POST",
            url_suffix=f"/api/v1/jobs/{job_id}/train?username={username}",
            ok_codes=(200,201,422)
        )
    
    def get_decision_set(self, job_id: int) -> Dict[str, Any]:
        return self._http_request(
            method="GET",
            url_suffix=f"/api/v1/jobs/{job_id}/labels",
            ok_codes=(200,201,422)
        )

    # Add valid codes ok_codes param tupple ( 200,201,422) 
    def send_raw_event(self, job_id: int, payload: Dict[str, Any], id_value="") -> Dict[str, Any]:
        return self._http_request(
            method="POST",
            url_suffix=f"/api/v1/events/{id_value}",
            json_data = payload,
            ok_codes=(200,201,422)
        )

    def get_event_status(self, job_id: int, event_id: str, retries=10, seconds_per_retry=3) -> Dict[str, Any]:
        return self._http_request(
            method="GET",
            url_suffix=f"/api/v1/events/{job_id}/{event_id}",
            ok_codes=(200,201,422)
        )

    def send_feedback(self, job_id: int, event_id: str, payload: Dict[str, Any]) -> Dict[str, Any]:
        return self._http_request(
            method="PUT",
            url_suffix=f"/api/v1/events/{job_id}/{event_id}/feedback",
            json_data=payload,
            ok_codes=(200,201,422)
        )



    ''' COMMAND FUNCTIONS '''


def test_module(client: Client) -> str:
    try:
        response = client.test_arcanna()
        demisto.info(f'test_module response={response}')
        if "connected" not in response:
            return "Authentication Error. Please check the API Key you provided."
        else:
            return "ok"
    except DemistoException as e:
        raise e

def get_jobs(client: Client) -> CommandResults:
    result = client.list_jobs()

    headers = ["job_id", "title", "status", "last_processed_timestamp"]

    readable_output = tableToMarkdown(name="Arcanna Jobs", headers=headers, t=result)

    outputs = {
        'Arcanna.Jobs(val.job_id && val.job_id === obj.job_id)': createContext(result)
    }
    return CommandResults(
        readable_output=readable_output,
        outputs=outputs,
        raw_response=result
    )

def export_event(client: Client, default_job_id: int, args: Dict[str, Any]) -> CommandResults:
    job_id = args.get("job_id", default_job_id)
    event_id = args.get("event_id")

    result = client.export_event(job_id=job_id, event_id=event_id)
    headers = ["arcanna_event", "status", "ingest_timestamp","event_id", "error_message"]
    readable_output = tableToMarkdown(name="Arcanna Event", headers=headers, t=result)

    outputs = {
        'Arcanna.Event(val.job_id && val.job_id === obj.job_id)': createContext(result)
    }

    return CommandResults(
        readable_output=readable_output,
        outputs=outputs,
        raw_response=result
    )


def trigger_training(client: Client, default_job_id: int, args: Dict[str, Any]) -> CommandResults:
    job_id = args.get("job_id", default_job_id)
    username = args.get("username", None)
    result = client.trigger_training(job_id=job_id, username=username)
    headers = ["result", "error_message"]
    readable_output = tableToMarkdown(name="Arcanna Training", headers=headers, t=result)

    outputs = {
        'Arcanna.Training(val.job_id && val.job_id === obj.job_id)': createContext(result)
    }

    return CommandResults(
        readable_output=readable_output,
        outputs=outputs,
        raw_response=result
    )

def get_decision_set(client: Client, default_job_id: int, args: Dict[str, Any]) -> CommandResults:
    job_id = args.get("job_id", default_job_id)
    result = client.get_decision_set(job_id=job_id)
    headers = ["decision_set", "error_message"]
    readable_output = tableToMarkdown(name="Arcanna Event", headers=headers, t=result)
    outcome = {
        "decision_set": result
    }
    outputs = {
        'Arcanna.Event(val.job_id && val.job_id === obj.job_id)': createContext(outcome)
    }

    return CommandResults(
        readable_output=readable_output,
        outputs=outputs,
        raw_response=result
    )

def map_to_arcanna_raw_event(job_id, raw, severity, title):
        body = {
            "job_id": int(job_id),
            "title": title,
            "raw_body": json.loads(raw)
        }
        if severity:
            severity = int(float(severity))
            body["severity"] = severity
        return body
        
def post_event(client: Client, default_job_id: int, args: Dict[str, Any]) -> CommandResults:
    job_id = args.get("job_id", default_job_id)
    title = args.get("title")
    raw_payload = args.get("event_json", {})
    severity = args.get("severity", 0)
    id_value = args.get("id_value", "")

    payload = map_to_arcanna_raw_event(job_id, raw_payload, severity, title)
    result = client.send_raw_event(job_id=job_id, payload=payload, id_value=id_value)

    
    headers = ["event_id", "ingest_timestamp", "status", "error_message","job_id"]
    readable_output = tableToMarkdown(name="Arcanna Event", headers=headers, t=result)

    outputs = {
        'Arcanna.Event(val.job_id && val.job_id === obj.job_id)': createContext(result)
    }

    return CommandResults(
        readable_output=readable_output,
        outputs=outputs,
        raw_response=result
    )

def get_event_status(client: Client, default_job_id: int, args: Dict[str, Any]) -> CommandResults:
    job_id = args.get("job_id", default_job_id)
    event_id = args.get("event_id")
    result = client.get_event_status(job_id, event_id)
    
    headers = ["event_id", "ingest_timestamp", "status", "error_message","bucket_state", "result", "confidence_score", "outlier", "arcanna_label"]
    
    readable_output = tableToMarkdown(name="Arcanna Event Status", headers=headers, t=result)

    outputs = {
        'Arcanna.Event(val.job_id && val.job_id === obj.job_id)': createContext(result)
    }

    return CommandResults(
        readable_output=readable_output,
        outputs=outputs,
        raw_response=result
    )

def map_to_arcanna_label(arcanna_label, username):
    body = {
        "cortex_user": username,
        "feedback": arcanna_label
    }
    return body

def send_event_feedback(client: Client, default_job_id: int, args: Dict[str, Any]) -> CommandResults:
    job_id = args.get("job_id", default_job_id)
    event_id = args.get("event_id")
    username = args.get("username")
    feedback = args.get("feedback", "<empty>")
    decision_set = args.get("valid_decisions", [])
    
    if feedback in decision_set is False:
        raise Exception(f"Error in arcanna-send-event-feedback.Unknown decision - {arcanna_label} ; Valid options: {decision_set} ")

    payload = map_to_arcanna_label(feedback, username)
    
    result = client.send_feedback(job_id, event_id, payload)
    
    headers = ["feedback_status", "status", "details"]
    readable_output = tableToMarkdown(name="Arcanna Event", headers=headers, t=result)

    outputs = {
        'Arcanna.Event(val.job_id && val.job_id === obj.job_id)': createContext(result)
    }

    return CommandResults(
        readable_output=readable_output,
        outputs=outputs,
        raw_response=result
    )
''' MAIN FUNCTION '''

def main() -> None:
    """main function, parses params and runs command functions

    :return:
    :rtype:
    """

    api_key = demisto.params().get('credentials', {}).get('password')

    # get the service API url
    base_url = urljoin(demisto.params()['url'])
    verify_certificate = demisto.params().get('ssl_verification', False)
    proxy = demisto.params().get('proxy', False)

    default_job_id = demisto.params().get('default_job_id', 1201)
    demisto.debug(f'Command being called is {demisto.command()}')
    headers = {
                    'accept': 'application/json',
                    'x-arcanna-api-key': api_key
            }
    try:

        client = Client(
            base_url=base_url,
            verify=verify_certificate,
            proxy=proxy,
            headers=headers    
        )

        if demisto.command() == 'test-module':
            # This is the call made when pressing the integration Test button.
            result_test = test_module(client)
            return_results(result_test)
        elif demisto.command() == "arcanna-get-jobs":
            result_get_jobs = get_jobs(client)
            return_results(result_get_jobs)
        elif demisto.command() == "arcanna-send-event":
            result_send_event = post_event(client, default_job_id, demisto.args())
            return_results(result_send_event)
        elif demisto.command() == "arcanna-export-event":
            result_export_event = export_event(client, default_job_id, demisto.args())
            return_results(result_export_event)
        elif demisto.command() == "arcanna-trigger-train":
            result_trigger_train = trigger_training(client, default_job_id, demisto.args())
            return_results(result_trigger_train)
        elif demisto.command() == "arcanna-get-decision-set":
            result_decision_set = get_decision_set(client, default_job_id, demisto.args())
            return_results(result_decision_set)
        elif demisto.command() == "arcanna-get-event-status":
            result_get_event = get_event_status(client, default_job_id, demisto.args())
            return_results(result_get_event)
        elif demisto.command() == "arcanna-send-event-feedback":
            result_send_feedback = send_event_feedback(client, default_job_id, demisto.args())
            return_results(result_send_feedback)
    # Log exceptions and return errors
    except Exception as e:
        demisto.error(traceback.format_exc())  # print the traceback
        return_error(f'Failed to execute {demisto.command()} command.\nError:\n{str(e)}')


    ''' ENTRY POINT '''

    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()
  type: python
  commands:
  - name: arcanna-get-jobs
    arguments: []
    outputs:
    - contextPath: Arcanna.Jobs.job_id
      description: Arcanna Job id
      type: Number
    - contextPath: Arcanna.Jobs.title
      description: Arcanna Job title
      type: String
    - contextPath: Arcanna.Jobs.status
      description: Arcanna job status
      type: String
    - contextPath: Arcanna.Jobs.last_processed_timestamp
      description: Last time an event was processed by current Job
      type: Date
    description: Get jobs list
  - name: arcanna-export-event
    arguments:
    - name: job_id
      required: true
      description: Job ID to use for exporting event
    - name: event_id
      required: true
      description: Event ID to use for exporting event
    outputs:
    - contextPath: Arcanna.Event.arcanna_event
      description: Full export for specified event
  - name: arcanna-trigger-train
    arguments:
    - name: job_id
      required: true
      description: Job ID for which training will be triggered
    - name: username
      required: true
      description: Username that will be assigned for train
    outputs:
    - contextPath: Arcanna.Train.status
      description: Status of request ( OK if successful )
      type: String
    - contextPath: Arcanna.Train.error_message
      description: Details if error on request
      type: String
    description: Trigger AI Train for specified Arcanna.ai Job
  - name: arcanna-get-decision-set
    arguments:
    - name: job_id
      required: true
      description: Job ID for which to get decision labels set
    outputs:
    - contextPath: Arcanna.Event.decision_set
      description: List of available labels for specified AI Job
      type: List
  - name: arcanna-send-event
    arguments:
    - name: job_id
      description: An Arcanna running job_id
    - name: event_json
      required: true
      description: json event for arcanna to inference.
    - name: title
      required: true
      description: event title
    - name: severity
      description: event severity
    - name: id_value
      description: Value to use for ID Reference
    outputs:
    - contextPath: Arcanna.Event.event_id
      description: Arcanna event id
      type: Number
    - contextPath: Arcanna.Event.status
      description: Arcanna ingestion status
      type: String
    - contextPath: Arcanna.Event.ingest_timestamp
      description: Arcanna ingestion timestamp
      type: date
    - contextPath: Arcanna.Event.error_message
      description: Arcanna error message if any
      type: String
    - contextPath: Arcanna.Event.job_id
      description: An Arcanna Job id used for sending.
      type: Number
    description: Sends a raw event to Arcanna
  - name: arcanna-get-event-status
    arguments:
    - name: job_id
      description: Arcanna Job Id
    - name: event_id
      required: true
      description: Arcanna generated unique event id.
    - name: retry_count
      required: true
      description: How many times command should be re-run in case of failure
    - name: seconds_per_retry
      required: true
      description: Seconds to wait between retries
    outputs:
    - contextPath: Arcanna.Event.event_id
      description: Arcanna event id
      type: String
    - contextPath: Arcanna.Event.ingest_timestamp
      description: Arcanna ingestion timestamp.
      type: String
    - contextPath: Arcanna.Event.confidence_score
      description: Arcanna ML confidence_score.
      type: Number
    - contextPath: Arcanna.Event.result
      description: Arcanna event  result
      type: String
    - contextPath: Arcanna.Event.outlier
      description: Arcanna signalling if event is an outlier based on historical data
      type: boolean
    - contextPath: Arcanna.Event.error_message
      description: Arcanna error message if any.
      type: String
    - contextPath: Arcanna.Event.status
      description: Arcanna event status.
      type: String
    - contextPath: Arcanna.Event.result_label
      description: Arcanna event result label
      type: String
    - contextPath: Arcanna.Event.bucket_state
      description: Flag to indicate the current event's state in the AI Model
      type: String
    description: Retrieves Arcanna Inference result.
  - name: arcanna-send-event-feedback
    arguments:
    - name: job_id
      description: An Arcanna job id.
    - name: event_id
      required: true
      description: An Arcanna event id.
    - name: feedback
      required: true
      description: Provided feedback from analyst
    - name: decision_set
      required: true
      description: Valid candidates for feedback based on Arcanna.ai job configuration
    - name: username
      required: true
      description: A username providing the feedback.
    - name: indicators
      description: Cortex Indicator if any as a dict containing 3 keys (type, value,
        source) as mandatory.
    outputs:
    - contextPath: Arcanna.Event.feedback_status
      description: An Arcanna feedback status response.
      type: String
    description: Send Arcanna feedback for a previous inferred event.
  dockerimage: demisto/python3:3.10.14.95956
  runonce: false
  script: '-'
  subtype: python3
  type: python
tests:
- No tests (auto formatted)
defaultclassifier: 'null'
fromversion: 5.5.0

