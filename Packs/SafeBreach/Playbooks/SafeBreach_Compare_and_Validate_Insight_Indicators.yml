id: SafeBreach - Compare and Validate Insight Indicators
version: -1
name: SafeBreach - Compare and Validate Insight Indicators
description: This playbook compares Insight indicators before and after being processed.
  It receives an Insight and it's indicators before validation, fetches updated indicators
  after rerunning the Insight, and then compares the results to validate mitigation.
  Indicators are classified as Remediated or Not Remediated based on their validated
  status and the appropriate field (SafeBreach Remediation Status) is updated.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 89e3fa5b-8365-4fe1-839e-1582e2bf8d10
    type: start
    task:
      id: 89e3fa5b-8365-4fe1-839e-1582e2bf8d10
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "12"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 450,
          "y": -510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "4":
    id: "4"
    taskid: b4d9deb2-20a0-41c6-8468-28a787ee6576
    type: title
    task:
      id: b4d9deb2-20a0-41c6-8468-28a787ee6576
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "5":
    id: "5"
    taskid: 008fe8bb-93c2-4d8a-803b-76b01b27be7c
    type: regular
    task:
      id: 008fe8bb-93c2-4d8a-803b-76b01b27be7c
      version: -1
      name: Set Indicators After Validation
      description: Checks if the specified value exists in context. If the value exists,
        it will be set in context, otherwise no value will be set in context.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    scriptarguments:
      append: {}
      key:
        simple: IndicatorsAfterValidation
      stringify: {}
      value:
        complex:
          root: SafeBreach
          accessor: Insight.RawRemediationData
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 450,
          "y": 200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "6":
    id: "6"
    taskid: f4f0abbb-2b90-4c85-8758-01e154a6cf79
    type: regular
    task:
      id: f4f0abbb-2b90-4c85-8758-01e154a6cf79
      version: -1
      name: Filter for the Remediation Indicators
      description: Sets a value into the context with the given context key
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "14"
    scriptarguments:
      append: {}
      key:
        simple: IndicatorsAfterValidationFiltered
      stringify: {}
      value:
        complex:
          root: IndicatorsAfterValidation
          accessor: value
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 450,
          "y": 390
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "7":
    id: "7"
    taskid: e713d385-5f75-4871-8e47-f34d9c75cd7e
    type: regular
    task:
      id: e713d385-5f75-4871-8e47-f34d9c75cd7e
      version: -1
      name: Extract the Remediated Indicators
      description: Sets a value into the context with the given context key
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      append: {}
      key:
        simple: RemediatedIndicators
      stringify: {}
      value:
        complex:
          root: IndicatorsBeforeValidationFiltered
          filters:
          - - operator: notIn
              left:
                value:
                  simple: IndicatorsBeforeValidationFiltered
                iscontext: true
              right:
                value:
                  simple: IndicatorsAfterValidationFiltered
                iscontext: true
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 150,
          "y": 830
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "8":
    id: "8"
    taskid: 82588205-5aee-4ab8-8ebc-21cdb735ac61
    type: regular
    task:
      id: 82588205-5aee-4ab8-8ebc-21cdb735ac61
      version: -1
      name: Extract the Not Remediated Indicators
      description: Sets a value into the context with the given context key
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      append: {}
      key:
        simple: NotRemediatedIndicators
      stringify: {}
      value:
        complex:
          root: IndicatorsBeforeValidationFiltered
          filters:
          - - operator: in
              left:
                value:
                  simple: IndicatorsBeforeValidationFiltered
                iscontext: true
              right:
                value:
                  simple: IndicatorsAfterValidationFiltered
                iscontext: true
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 710,
          "y": 830
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "9":
    id: "9"
    taskid: 1c0d89fc-e7cd-4e6e-84f2-681b7a61e68f
    type: regular
    task:
      id: 1c0d89fc-e7cd-4e6e-84f2-681b7a61e68f
      version: -1
      name: Set Indicator Remediation Status as Remediated
      description: commands.local.cmd.set.indicator
      script: Builtin|||setIndicator
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      accounttype: {}
      actor: {}
      admincountry: {}
      adminemail: {}
      adminname: {}
      adminphone: {}
      asn: {}
      associatedfilenames: {}
      associations: {}
      biosversion: {}
      creationdate: {}
      customFields: {}
      cvedescription: {}
      cvemodified: {}
      cvss: {}
      description: {}
      detectionengines: {}
      devicemodel: {}
      dhcpserver: {}
      displayname: {}
      dns: {}
      domainname: {}
      domainstatus: {}
      emailaddress: {}
      employeehealthstatus: {}
      employeeresponsestatus: {}
      entryid: {}
      expirationdate: {}
      fileextension: {}
      filetype: {}
      firstname: {}
      firstseenbysource: {}
      geocountry: {}
      geolocation: {}
      groups: {}
      hostname: {}
      id: {}
      imphash: {}
      indicatoridentification: {}
      internal: {}
      ipaddress: {}
      jobtitle: {}
      lastname: {}
      lastseenbysource: {}
      macaddress: {}
      malwarefamily: {}
      md5: {}
      memory: {}
      mitrealiases: {}
      mitrecontributors: {}
      mitredatasources: {}
      mitredefensebypassed: {}
      mitredescription: {}
      mitredetection: {}
      mitreextendedaliases: {}
      mitreexternalreferences: {}
      mitreid: {}
      mitreimpacttype: {}
      mitrekillchainphases: {}
      mitrelabels: {}
      mitrename: {}
      mitrepermissionsrequired: {}
      mitreplatforms: {}
      mitresystemrequirements: {}
      mitretype: {}
      mitreversion: {}
      name: {}
      namefield: {}
      nameservers: {}
      office365category: {}
      office365expressroute: {}
      office365required: {}
      operatingsystem: {}
      operatingsystemversion: {}
      organization: {}
      organizationalunitou: {}
      osversion: {}
      path: {}
      port: {}
      positivedetections: {}
      processor: {}
      processors: {}
      published: {}
      quarantined: {}
      recordedfutureevidencedetails: {}
      region: {}
      registrantcountry: {}
      registrantemail: {}
      registrantname: {}
      registrantphone: {}
      registrarabuseemail: {}
      registrarabusephone: {}
      registrarname: {}
      reportedby: {}
      reputation: {}
      safebreachattackids: {}
      safebreachinsightids: {}
      safebreachisbehavioral: {}
      safebreachremediationstatus:
        simple: Remediated
      safebreachseverity: {}
      safebreachseverityscore: {}
      service: {}
      sha1: {}
      sha256: {}
      sha512: {}
      signatureauthentihash: {}
      signaturecopyright: {}
      signaturedescription: {}
      signaturefileversion: {}
      signatureinternalname: {}
      signed: {}
      size: {}
      sourceoriginalseverity: {}
      ssdeep: {}
      subdomains: {}
      tags: {}
      threattypes: {}
      trafficlightprotocol: {}
      type: {}
      updateddate: {}
      username: {}
      value:
        complex:
          root: RemediatedIndicators
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 150,
          "y": 1000
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "10":
    id: "10"
    taskid: 43dc6ce5-7ed1-4198-8cb5-1ed903b3e0f6
    type: regular
    task:
      id: 43dc6ce5-7ed1-4198-8cb5-1ed903b3e0f6
      version: -1
      name: Set Indicator Remediation Status as Not Remediated
      description: commands.local.cmd.set.indicator
      script: Builtin|||setIndicator
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "4"
    scriptarguments:
      accounttype: {}
      actor: {}
      admincountry: {}
      adminemail: {}
      adminname: {}
      adminphone: {}
      asn: {}
      associatedfilenames: {}
      associations: {}
      biosversion: {}
      creationdate: {}
      customFields: {}
      cvedescription: {}
      cvemodified: {}
      cvss: {}
      description: {}
      detectionengines: {}
      devicemodel: {}
      dhcpserver: {}
      displayname: {}
      dns: {}
      domainname: {}
      domainstatus: {}
      emailaddress: {}
      employeehealthstatus: {}
      employeeresponsestatus: {}
      entryid: {}
      expirationdate: {}
      fileextension: {}
      filetype: {}
      firstname: {}
      firstseenbysource: {}
      geocountry: {}
      geolocation: {}
      groups: {}
      hostname: {}
      id: {}
      imphash: {}
      indicatoridentification: {}
      internal: {}
      ipaddress: {}
      jobtitle: {}
      lastname: {}
      lastseenbysource: {}
      macaddress: {}
      malwarefamily: {}
      md5: {}
      memory: {}
      mitrealiases: {}
      mitrecontributors: {}
      mitredatasources: {}
      mitredefensebypassed: {}
      mitredescription: {}
      mitredetection: {}
      mitreextendedaliases: {}
      mitreexternalreferences: {}
      mitreid: {}
      mitreimpacttype: {}
      mitrekillchainphases: {}
      mitrelabels: {}
      mitrename: {}
      mitrepermissionsrequired: {}
      mitreplatforms: {}
      mitresystemrequirements: {}
      mitretype: {}
      mitreversion: {}
      name: {}
      namefield: {}
      nameservers: {}
      office365category: {}
      office365expressroute: {}
      office365required: {}
      operatingsystem: {}
      operatingsystemversion: {}
      organization: {}
      organizationalunitou: {}
      osversion: {}
      path: {}
      port: {}
      positivedetections: {}
      processor: {}
      processors: {}
      published: {}
      quarantined: {}
      recordedfutureevidencedetails: {}
      region: {}
      registrantcountry: {}
      registrantemail: {}
      registrantname: {}
      registrantphone: {}
      registrarabuseemail: {}
      registrarabusephone: {}
      registrarname: {}
      reportedby: {}
      reputation: {}
      safebreachattackids: {}
      safebreachinsightids: {}
      safebreachisbehavioral: {}
      safebreachremediationstatus:
        simple: Not Remediated
      safebreachseverity: {}
      safebreachseverityscore: {}
      service: {}
      sha1: {}
      sha256: {}
      sha512: {}
      signatureauthentihash: {}
      signaturecopyright: {}
      signaturedescription: {}
      signaturefileversion: {}
      signatureinternalname: {}
      signed: {}
      size: {}
      sourceoriginalseverity: {}
      ssdeep: {}
      subdomains: {}
      tags: {}
      threattypes: {}
      trafficlightprotocol: {}
      type: {}
      updateddate: {}
      username: {}
      value:
        complex:
          root: NotRemediatedIndicators
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1000
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "11":
    id: "11"
    taskid: 66f9c4d1-33af-4f19-8680-81b91ec88844
    type: regular
    task:
      id: 66f9c4d1-33af-4f19-8680-81b91ec88844
      version: -1
      name: Get Insight Remediation Data
      description: Gets remediation data for a specific SafeBreach Insight.
      script: '|||safebreach-get-remediation-data'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      insightId:
        complex:
          root: SafeBreach
          accessor: Insight.Id
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 450,
          "y": 20
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "12":
    id: "12"
    taskid: 993d9910-6e55-4e9b-8fab-147b9db63678
    type: regular
    task:
      id: 993d9910-6e55-4e9b-8fab-147b9db63678
      version: -1
      name: 'Map Input Insight to Context '
      description: 'Enables changing context in two ways. The first is to capitalize
        the first letter of each key in following level of the context key entered.
        The second is to change context keys to new values. '
      scriptName: ChangeContext
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      capitalize: {}
      inplace: {}
      input:
        complex:
          root: inputs.Insight
      output_key:
        simple: SafeBreach.Insight
      replace_dict: {}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 450,
          "y": -350
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "13":
    id: "13"
    taskid: f734e7ef-7033-4032-8faa-a4c2e46e6707
    type: regular
    task:
      id: f734e7ef-7033-4032-8faa-a4c2e46e6707
      version: -1
      name: Filter for the Before Indicators
      description: Sets a value into the context with the given context key
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      append: {}
      key:
        simple: IndicatorsBeforeValidationFiltered
      stringify: {}
      value:
        complex:
          root: inputs.IndicatorsBefore
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 450,
          "y": -160
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "14":
    id: "14"
    taskid: 9cc51531-beb9-40b9-81c3-2102edb95768
    type: condition
    task:
      id: 9cc51531-beb9-40b9-81c3-2102edb95768
      version: -1
      name: Were Indicators Remediated?
      description: Were Indicators Remediated?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      Not Remediated Indicators Exist:
      - "8"
      Remediated Indicators Exist:
      - "7"
    separatecontext: false
    conditions:
    - label: Remediated Indicators Exist
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: IndicatorsBeforeValidationFiltered
                filters:
                - - operator: notIn
                    left:
                      value:
                        simple: IndicatorsBeforeValidationFiltered
                      iscontext: true
                    right:
                      value:
                        simple: IndicatorsAfterValidationFiltered
                      iscontext: true
            iscontext: true
    - label: Not Remediated Indicators Exist
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: IndicatorsBeforeValidationFiltered
                filters:
                - - operator: in
                    left:
                      value:
                        simple: IndicatorsBeforeValidationFiltered
                      iscontext: true
                    right:
                      value:
                        simple: IndicatorsAfterValidationFiltered
                      iscontext: true
            iscontext: true
    view: |-
      {
        "position": {
          "x": 450,
          "y": 590
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
view: |-
  {
    "linkLabelsPosition": {},
    "paper": {
      "dimensions": {
        "height": 1785,
        "width": 940,
        "x": 150,
        "y": -510
      }
    }
  }
inputs:
- key: IndicatorsBefore
  value: {}
  required: true
  description: Indicators extracted before remediation
  playbookInputQuery:
- key: Insight
  value: {}
  required: true
  description: Insight to verify remediation for
  playbookInputQuery:
outputs:
- contextPath: RemediatedIndicators
  description: List of indicators that were remediated
  type: unknown
- contextPath: NotRemediatedIndicators
  description: List of indicators that were not remediated
  type: unknown
quiet: true
fromversion: 5.0.0
tests:
- No tests (auto formatted)
