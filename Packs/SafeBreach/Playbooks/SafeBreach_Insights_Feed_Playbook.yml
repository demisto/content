id: SafeBreach Insights Feed Playbook
version: -1
name: SafeBreach Insights Feed Playbook
description: This playbook triggers automated remediation for all SafeBreach generated
  indicators generated by insights. Then it reruns related insights and tags remaining
  indicators as not remediated ("NotRemediated" tag).
starttaskid: '0'
tasks:
  '0':
    id: '0'
    taskid: 15e139ef-24e4-494e-8fba-e37824cb11da
    type: start
    task:
      id: 15e139ef-24e4-494e-8fba-e37824cb11da
      version: -1
      name: ''
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '15'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 490,\n    \"y\": -310\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  '3':
    id: '3'
    taskid: 9cb0dfd8-0b07-4ab3-899c-c7b29fd8c17c
    type: title
    task:
      id: 9cb0dfd8-0b07-4ab3-899c-c7b29fd8c17c
      version: -1
      name: End
      type: title
      iscommand: false
      brand: ''
      description: ''
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 490,\n    \"y\": 1700\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  '5':
    id: '5'
    taskid: a6a3b7de-e7dc-495e-8fd5-e4f6199f7572
    type: regular
    task:
      id: a6a3b7de-e7dc-495e-8fd5-e4f6199f7572
      version: -1
      name: Extract List of Tags from Indicators
      description: Sets a value into the context with the given context key
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '8'
    scriptarguments:
      append: {}
      key:
        simple: IndicatorTags
      stringify: {}
      value:
        complex:
          root: TaggedIndicators
          filters:
          - - operator: startWith
              left:
                value:
                  simple: TaggedIndicators.CustomFields.tags
                iscontext: true
              right:
                value:
                  simple: SafeBreachInsightId
          accessor: CustomFields.tags
          transformers:
          - operator: uniq
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 490,\n    \"y\": 410\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  '6':
    id: '6'
    taskid: ea5c8d88-fe69-4bfd-8dc5-a0fc9042a64d
    type: playbook
    task:
      id: ea5c8d88-fe69-4bfd-8dc5-a0fc9042a64d
      version: -1
      name: SafeBreach Rerun Insights
      description: Rerun an Insight based on Insight Id and wait until it completes.
      playbookName: SafeBreach Rerun Insights
      type: playbook
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '7'
    scriptarguments:
      InsightId:
        simple: ${InsightIDs}
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
      max: 100
    view: "{\n  \"position\": {\n    \"x\": 490,\n    \"y\": 760\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  '7':
    id: '7'
    taskid: 4e943e9b-5cd3-41e0-8e5e-784dbc2cb1f3
    type: regular
    task:
      id: 4e943e9b-5cd3-41e0-8e5e-784dbc2cb1f3
      version: -1
      name: Get Remediation Data for Insight Id
      description: Get remediation data for a specific SafeBreach Insight
      script: '|||safebreach-get-remediation-data'
      type: regular
      iscommand: true
      brand: ''
    nexttasks:
      '#none#':
      - '9'
    scriptarguments:
      insightId:
        simple: ${SafeBreach.Insight.Id}
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 490,\n    \"y\": 930\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  '8':
    id: '8'
    taskid: 26122ef1-75b4-4ed5-825f-a83ec3f9e0d1
    type: regular
    task:
      id: 26122ef1-75b4-4ed5-825f-a83ec3f9e0d1
      version: -1
      name: Extract List of Insight Ids
      description: Sets a value into the context with the given context key
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '6'
    scriptarguments:
      append: {}
      key:
        simple: InsightIDs
      stringify: {}
      value:
        complex:
          root: IndicatorTags
          filters:
          - - operator: startWith
              left:
                value:
                  simple: IndicatorTags
                iscontext: true
              right:
                value:
                  simple: SafeBreachInsightId
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: ':'
              fields:
                value:
                  simple: '2'
          - operator: uniq
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 490,\n    \"y\": 585\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  '9':
    id: '9'
    taskid: 13589b9f-d085-4610-84db-23e71d019bba
    type: regular
    task:
      id: 13589b9f-d085-4610-84db-23e71d019bba
      version: -1
      name: Extract Indicators from the Rerun
      description: Sets a value into the context with the given context key
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '10'
    scriptarguments:
      append: {}
      key:
        simple: RerunIndicators
      stringify: {}
      value:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Vendor
                iscontext: true
              right:
                value:
                  simple: SafeBreach
          - - operator: inList
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: url,other,file
              ignorecase: true
          accessor: Indicator
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 490,\n    \"y\": 1110\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  '10':
    id: '10'
    taskid: 2a96d54c-df4e-4150-8cfb-ff9d0f20a360
    type: regular
    task:
      id: 2a96d54c-df4e-4150-8cfb-ff9d0f20a360
      version: -1
      name: 'Compare and Set the Remaining Indicators '
      description: Sets a value into the context with the given context key
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '13'
    scriptarguments:
      append: {}
      key:
        simple: RemainingIndicators
      stringify: {}
      value:
        complex:
          root: TaggedIndicators
          filters:
          - - operator: in
              left:
                value:
                  simple: TaggedIndicators.value
                iscontext: true
              right:
                value:
                  simple: RerunIndicators
                iscontext: true
          accessor: value
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 490,\n    \"y\": 1290\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  '11':
    id: '11'
    taskid: 7a698334-8d36-461f-8eba-ddf789a7f867
    type: regular
    task:
      id: 7a698334-8d36-461f-8eba-ddf789a7f867
      version: -1
      name: Extract All SafeBreach Tagged Indicators
      description: Sets a value into the context with the given context key
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '5'
    scriptarguments:
      append: {}
      key:
        simple: TaggedIndicators
      stringify: {}
      value:
        complex:
          root: playbookQuery
          filters:
          - - operator: startWith
              left:
                value:
                  simple: playbookQuery.CustomFields.tags
                iscontext: true
              right:
                value:
                  simple: SafeBreachInsightId
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 490,\n    \"y\": 235\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 2
  '13':
    id: '13'
    taskid: a051ad83-565d-4cae-8dc9-6607ef98e518
    type: regular
    task:
      id: a051ad83-565d-4cae-8dc9-6607ef98e518
      version: -1
      name: Tag Remaining Indicators NotRemediated
      description: commands.local.cmd.add.values.to.indicator.multi.select.field
      script: Builtin|||appendIndicatorField
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - '3'
    scriptarguments:
      field:
        simple: tags
      fieldValue:
        simple: NotRemediated
      indicatorsValues:
        simple: ${RemainingIndicators}
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 490,\n    \"y\": 1470\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  '15':
    id: '15'
    taskid: 610a5781-84c5-4108-83f9-0e6619079c5c
    type: playbook
    task:
      id: 610a5781-84c5-4108-83f9-0e6619079c5c
      version: -1
      name: Block Indicators - Generic v2
      description: "This playbook blocks malicious Indicators using all integrations\
        \ that are enabled, using the following sub-playbooks:\n\n- Block URL - Generic\n\
        - Block Account - Generic\n- Block IP - Generic v2\n- Block File - Generic\
        \ v2\n\n"
      playbookName: Block Indicators - Generic v2
      type: playbook
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '17'
    scriptarguments:
      AutoCommit:
        simple: true
      CustomBlockRule:
        simple: 'True'
      CustomURLCategory:
        simple: SafeBreach Domains and URIs
      DAG: {}
      EDLServerIP: {}
      IP:
        complex:
          root: playbookQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: playbookQuery.score
                iscontext: true
              right:
                value:
                  simple: '3'
          - - operator: isEqualString
              left:
                value:
                  simple: playbookQuery.indicator_type
                iscontext: true
              right:
                value:
                  simple: IP
              ignorecase: true
          accessor: value
          transformers:
          - operator: uniq
      IPBlacklistMiner: {}
      IPListName:
        simple: SafeBreachIpBlockList
      LogForwarding: {}
      MD5: {}
      SHA256:
        complex:
          root: playbookQuery
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: playbookQuery.indicator_type
                iscontext: true
              right:
                value:
                  simple: file
              ignorecase: true
          - - operator: isNotEmpty
              left:
                value:
                  simple: playbookQuery.CustomFields.sha256
                iscontext: true
          accessor: CustomFields.sha256
          transformers:
          - operator: uniq
      StaticAddressGroup: {}
      URL:
        complex:
          root: playbookQuery
          filters:
          - - operator: inList
              left:
                value:
                  simple: playbookQuery.indicator_type
                iscontext: true
              right:
                value:
                  simple: Domain,URL
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: playbookQuery.score
                iscontext: true
              right:
                value:
                  simple: '3'
          accessor: value
          transformers:
          - operator: uniq
      URLBlacklistMiner: {}
      URLListName:
        simple: SafeBreach List
      Username: {}
      categories: {}
      device-group: {}
      type:
        simple: '"URL List"'
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
      max: 100
    view: "{\n  \"position\": {\n    \"x\": 490,\n    \"y\": -115\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  '17':
    id: '17'
    taskid: f02ad2fe-bf5e-4415-8b37-49dc20ee660e
    type: regular
    task:
      id: f02ad2fe-bf5e-4415-8b37-49dc20ee660e
      version: -1
      name: Sleep for the remediation to work
      description: Sleep for X seconds
      scriptName: Sleep
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '11'
    scriptarguments:
      seconds:
        simple: '60'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 490,\n    \"y\": 60\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
view: "{\n  \"linkLabelsPosition\": {},\n  \"paper\": {\n    \"dimensions\": {\n \
  \     \"height\": 2075,\n      \"width\": 380,\n      \"x\": 490,\n      \"y\":\
  \ -310\n    }\n  }\n}"
inputs:
- key: ''
  value: {}
  required: false
  description: ''
  playbookInputQuery:
    query: type:[File,Domain,IP,URL] and sourceBrands:"SafeBreach v2"
    queryEntity: indicators
    results:
    daterange:
      fromdate: 0001-01-01T00:00:00Z
      todate: 0001-01-01T00:00:00Z
      period:
        by: ''
        byto: ''
        byfrom: ''
        tovalue: null
        fromvalue: null
        field: ''
      fromdatelicenseval: 0001-01-01T00:00:00Z
    runFromLastJobTime: true
outputs: []
quiet: true
fromversion: 5.5.0
tests:
  - No Test
