id: Expanse Attribution Subplaybook
version: -1
name: Expanse Attribution Subplaybook
description: "Given an Expanse Asset, Issue IP, Issue Provider, Issue Domain, Issue\
  \ Port and Issue Protocol hunts for internal activity on the detected service. \n\
  Returns a list of potential owner BUs, owner Users, Device and Notes"
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: cef3ae52-74fb-4534-8be5-976b4e61264a
    type: start
    task:
      id: cef3ae52-74fb-4534-8be5-976b4e61264a
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
      - "10"
      - "17"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 490,
          "y": 50
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "2":
    id: "2"
    taskid: 934e2c63-b53e-4788-81fb-b6d0df0de6cd
    type: title
    task:
      id: 934e2c63-b53e-4788-81fb-b6d0df0de6cd
      version: -1
      name: Splunk
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "6"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -460,
          "y": 195
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "3":
    id: "3"
    taskid: 9c139393-f893-4511-878b-52c743a8a04c
    type: title
    task:
      id: 9c139393-f893-4511-878b-52c743a8a04c
      version: -1
      name: User Enrichment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "31"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 580,
          "y": 1660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "4":
    id: "4"
    taskid: e67201d6-678b-4909-868d-63102f2b599a
    type: regular
    task:
      id: e67201d6-678b-4909-868d-63102f2b599a
      version: -1
      name: Splunk Hunt For Users To IP
      description: Searches Splunk for events.
      script: '|||splunk-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "46"
    scriptarguments:
      app: {}
      batch_limit: {}
      earliest_time:
        complex:
          root: inputs.NumberOfDaysInThePast
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: '-'
              suffix:
                value:
                  simple: d
      event_limit:
        simple: "100"
      latest_time: {}
      query:
        complex:
          root: inputs.IP
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: dest_ip=
              suffix: {}
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' dest_port='
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Port
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' transport='
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Protocol
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' action=allowed user!="unknown" | top limit=5 user by serial_number,
                    vsys'
      update_context: {}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -230,
          "y": 530
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "5":
    id: "5"
    taskid: 2cb37411-0164-4129-8f38-78d686eab1ff
    type: regular
    task:
      id: 2cb37411-0164-4129-8f38-78d686eab1ff
      version: -1
      name: Splunk Hunt For Unknown Users To IP
      description: Searches Splunk for events.
      script: '|||splunk-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "46"
    scriptarguments:
      app: {}
      batch_limit: {}
      earliest_time:
        complex:
          root: inputs.NumberOfDaysInThePast
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: '-'
              suffix:
                value:
                  simple: d
      event_limit:
        simple: "100"
      latest_time: {}
      query:
        complex:
          root: inputs.IP
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: dest_ip=
              suffix: {}
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' dest_port='
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Port
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' transport='
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Protocol
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' action=allowed user="unknown" | top limit=5 src_ip by
                    serial_number, vsys'
      update_context: {}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 180,
          "y": 530
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "6":
    id: "6"
    taskid: d7a32f40-f1cb-4e12-8dd1-2a0ba78b2012
    type: condition
    task:
      id: d7a32f40-f1cb-4e12-8dd1-2a0ba78b2012
      version: -1
      name: Is Splunk Enabled?
      description: Check if Splunk integration is enabled
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "34"
      "yes":
      - "5"
      - "4"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: SplunkPy
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
    view: |-
      {
        "position": {
          "x": -460,
          "y": 350
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "10":
    id: "10"
    taskid: b5c227ac-0618-4bf8-8782-a8c83aa9c6cf
    type: title
    task:
      id: b5c227ac-0618-4bf8-8782-a8c83aa9c6cf
      version: -1
      name: Cortex Data Lake
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "11"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 930,
          "y": 195
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "11":
    id: "11"
    taskid: 00484cea-bd5a-49bb-8c98-ad457c79f380
    type: condition
    task:
      id: 00484cea-bd5a-49bb-8c98-ad457c79f380
      version: -1
      name: Is Cortex Data Lake Enabled?
      description: Check if Cortex Data Lake is enabled
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "35"
      "yes":
      - "13"
      - "12"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: Cortex Data Lake
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
    view: |-
      {
        "position": {
          "x": 930,
          "y": 340
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "12":
    id: "12"
    taskid: 92be78c3-8009-4946-89d9-e41416236165
    type: regular
    task:
      id: 92be78c3-8009-4946-89d9-e41416236165
      version: -1
      name: Cortex Data Lake Hunt for Unknown Users To IP
      description: Runs a query on  any table or field.
      script: '|||cdl-query-logs'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "45"
    scriptarguments:
      ignore-outputs:
        simple: "false"
      limit:
        simple: "100"
      query:
        complex:
          root: inputs.IP
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: SELECT source_ip.value AS src_ip,log_source_id,vsys,COUNT(*)
                    AS count FROM `firewall.traffic` WHERE dest_ip.value="
              suffix:
                value:
                  simple: '" AND source_user is NULL AND action.id=0 AND log_time
                    > TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.NumberOfDaysInThePast
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' DAY) AND protocol.value=LOWER("'
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Protocol
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: '") AND dest_port='
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Port
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' GROUP BY log_source_id, vsys, src_ip'
      transform_results:
        simple: "No"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1410,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "13":
    id: "13"
    taskid: 17da2748-742f-4759-868c-929cfa8e6a09
    type: regular
    task:
      id: 17da2748-742f-4759-868c-929cfa8e6a09
      version: -1
      name: Cortex Data Lake Hunt for Users To IP
      description: Runs a query on  any table or field.
      script: '|||cdl-query-logs'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "45"
    scriptarguments:
      ignore-outputs:
        simple: "false"
      limit:
        simple: "100"
      query:
        complex:
          root: inputs.IP
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: SELECT source_user,log_source_id,vsys,COUNT(*) AS count
                    FROM `firewall.traffic` WHERE dest_ip.value="
              suffix:
                value:
                  simple: '" AND action.id=0 AND source_user is NOT NULL AND log_time
                    > TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.NumberOfDaysInThePast
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: '  DAY) AND protocol.value=LOWER("'
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Protocol
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: '") AND dest_port='
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Port
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ' GROUP BY log_source_id,vsys,source_user'
      transform_results:
        simple: "No"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 905,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "17":
    id: "17"
    taskid: d2bc0870-caa6-454b-821e-6d32739d5b8c
    type: title
    task:
      id: d2bc0870-caa6-454b-821e-6d32739d5b8c
      version: -1
      name: Panorama
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1900,
          "y": 195
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "18":
    id: "18"
    taskid: 873cf6d8-9d64-4249-85a5-f827154229f2
    type: condition
    task:
      id: 873cf6d8-9d64-4249-85a5-f827154229f2
      version: -1
      name: Is Panorama Enabled?
      description: Check if Panorama/PAN-OS is enabled
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "36"
      "yes":
      - "25"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: Panorama
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
    view: |-
      {
        "position": {
          "x": 1900,
          "y": 340
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "21":
    id: "21"
    taskid: 51b562e8-4853-4f33-889d-6cd35af92f87
    type: playbook
    task:
      id: 51b562e8-4853-4f33-889d-6cd35af92f87
      version: -1
      name: Panorama Query Logs
      description: 'Query Panorama Logs of types: traffic, threat, url, data-filtering
        and wildfire.'
      playbookName: Panorama Query Logs
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "47"
    scriptarguments:
      action: {}
      addr-dst: {}
      addr-src: {}
      filedigest: {}
      ip: {}
      log_type:
        simple: traffic
      port-dst: {}
      query:
        complex:
          root: inputs.Protocol
          transformers:
          - operator: toLowerCase
          - operator: concat
            args:
              prefix:
                value:
                  simple: '(proto eq '
              suffix:
                value:
                  simple: ') and (addr.dst in '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.IP
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ') and (action eq allow) and (user.src eq '''') and (port.dst
                    eq '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Port
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: )
      rule: {}
      time-generated: {}
      url: {}
      using: {}
      zone-dst: {}
      zone-src: {}
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 1900,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "25":
    id: "25"
    taskid: 55ab8ad0-a957-48bb-8223-549ab6fa29b6
    type: playbook
    task:
      id: 55ab8ad0-a957-48bb-8223-549ab6fa29b6
      version: -1
      name: Panorama Query Logs
      description: 'Query Panorama Logs of types: traffic, threat, url, data-filtering
        and wildfire.'
      playbookName: Panorama Query Logs
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      action: {}
      addr-dst: {}
      addr-src: {}
      filedigest: {}
      ip: {}
      log_type:
        simple: traffic
      port-dst: {}
      query:
        complex:
          root: inputs.Protocol
          transformers:
          - operator: toLowerCase
          - operator: concat
            args:
              prefix:
                value:
                  simple: '(proto eq '
              suffix:
                value:
                  simple: ') and (addr.dst in '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.IP
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: ') and (action eq allow) and (user.src neq '''') and (port.dst
                    eq '
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: inputs.Port
                iscontext: true
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: )
      rule: {}
      time-generated: {}
      url: {}
      zone-dst: {}
      zone-src: {}
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 1900,
          "y": 530
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "30":
    id: "30"
    taskid: bed21409-50ea-4507-8273-1c945c981e9e
    type: title
    task:
      id: bed21409-50ea-4507-8273-1c945c981e9e
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 580,
          "y": 3150
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "31":
    id: "31"
    taskid: 4c29bb80-150b-4b91-8ecd-4c7bb6c50aba
    type: condition
    task:
      id: 4c29bb80-150b-4b91-8ecd-4c7bb6c50aba
      version: -1
      name: Is AD Enabled And We Have Users?
      description: Check if AD is enabled & we have users to enrich
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "38"
      "yes":
      - "32"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              simple: modules.brand
            iscontext: true
      - - operator: isEqualString
          left:
            value:
              simple: modules.brand
            iscontext: true
          right:
            value:
              simple: Active Directory Query v2
      - - operator: isEqualString
          left:
            value:
              simple: modules.state
            iscontext: true
          right:
            value:
              simple: active
      - - operator: greaterThan
          left:
            value:
              complex:
                root: Expanse.AttributionUser
                accessor: username
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "0"
    view: |-
      {
        "position": {
          "x": 580,
          "y": 1780
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "32":
    id: "32"
    taskid: bdc6f7d9-f8d6-4b20-8a3d-f0cc274a0c31
    type: regular
    task:
      id: bdc6f7d9-f8d6-4b20-8a3d-f0cc274a0c31
      version: -1
      name: Retrieve Details From AD
      description: Retrieves detailed information about a user account. The user can
        be specified by name, email address, or as an Active Directory Distinguished
        Name (DN). If no filter is specified, all users are returned.
      script: '|||ad-get-user'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      attributes:
        simple: department,division,description,displayName,manager
      custom-field-data: {}
      custom-field-type: {}
      dn: {}
      email: {}
      limit: {}
      name: {}
      user-account-control-out: {}
      username:
        complex:
          root: Expanse.AttributionUser
          accessor: username
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1010,
          "y": 1980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "33":
    id: "33"
    taskid: 2ad37863-8384-4adb-8e77-4a393327d337
    type: regular
    task:
      id: 2ad37863-8384-4adb-8e77-4a393327d337
      version: -1
      name: Export Enriched Users
      description: Expanse Enrich Attribution Data Structure with additional details
      scriptName: ExpanseEnrichAttribution
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "38"
    scriptarguments:
      current:
        simple: ${Expanse.AttributionUser}
      enrich:
        simple: ${ActiveDirectory.Users}
      enrich_fields:
        simple: mExpanseOf=groups,description,manager,mail
      enrich_key:
        simple: sAMAccountName
      type:
        simple: User
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1010,
          "y": 2160
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "34":
    id: "34"
    taskid: 90762ee5-e646-4851-8a86-0238c020cbb2
    type: title
    task:
      id: 90762ee5-e646-4851-8a86-0238c020cbb2
      version: -1
      name: Splunk Not Enabled
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -820,
          "y": 545
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "35":
    id: "35"
    taskid: a67d69b0-d8a9-4d0d-802e-3011fadb14e1
    type: title
    task:
      id: a67d69b0-d8a9-4d0d-802e-3011fadb14e1
      version: -1
      name: Cortex Data Lake Not Enabled
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 740,
          "y": 545
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "36":
    id: "36"
    taskid: 5113b5db-ee10-4449-87e5-e11bfc1cf3c2
    type: title
    task:
      id: 5113b5db-ee10-4449-87e5-e11bfc1cf3c2
      version: -1
      name: Panorama Not Enabled
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2390,
          "y": 545
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "38":
    id: "38"
    taskid: 953825de-2185-473b-8a77-d44f225afff0
    type: title
    task:
      id: 953825de-2185-473b-8a77-d44f225afff0
      version: -1
      name: Device Enrichmnent
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "39"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 580,
          "y": 2400
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "39":
    id: "39"
    taskid: eebf5429-e3c8-46e2-851e-7edb9b78eac6
    type: condition
    task:
      id: eebf5429-e3c8-46e2-851e-7edb9b78eac6
      version: -1
      name: Is Panorama Enabled And We Have Devices?
      description: Check if Panorama/PAN-OS is enabled & we have device to enrich
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "30"
      "yes":
      - "40"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              simple: modules.brand
            iscontext: true
      - - operator: isEqualString
          left:
            value:
              simple: modules.brand
            iscontext: true
          right:
            value:
              simple: Panorama
      - - operator: isEqualString
          left:
            value:
              simple: modules.state
            iscontext: true
          right:
            value:
              simple: active
      - - operator: greaterThan
          left:
            value:
              complex:
                root: Expanse.AttributionDevice
                accessor: serial
                transformers:
                - operator: count
            iscontext: true
          right:
            value:
              simple: "0"
    view: |-
      {
        "position": {
          "x": 580,
          "y": 2550
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "40":
    id: "40"
    taskid: e9dc3760-510e-4d43-8db5-d1b1256f5adf
    type: regular
    task:
      id: e9dc3760-510e-4d43-8db5-d1b1256f5adf
      version: -1
      name: Retrieve Device Groups
      description: Run any command supported in the API.
      script: '|||panorama'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "41"
    scriptarguments:
      action: {}
      category: {}
      cmd:
        simple: <show><devicegroups></devicegroups></show>
      command: {}
      dst: {}
      element: {}
      extend-context:
        simple: PanoramaDeviceGroup=response.result.devicegroups.entry
      from: {}
      ignore-outputs:
        simple: "true"
      job-id: {}
      key: {}
      log-type: {}
      pcap-id: {}
      period: {}
      query: {}
      reportname: {}
      reporttype: {}
      search-time: {}
      serialno: {}
      target: {}
      to: {}
      type:
        simple: op
      where: {}
      xpath: {}
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1060,
          "y": 2740
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "41":
    id: "41"
    taskid: d6342a57-c6f3-424f-8081-46036bcddad0
    type: regular
    task:
      id: d6342a57-c6f3-424f-8081-46036bcddad0
      version: -1
      name: Enrich Attribution Device
      description: Expanse Enrich Attribution Data Structure with additional details
      scriptName: ExpanseEnrichAttribution
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "30"
    scriptarguments:
      current:
        simple: ${Expanse.AttributionDevice}
      enrich:
        complex:
          root: PanoramaDeviceGroup
          transformers:
          - operator: jmespath
            args:
              expression:
                value:
                  simple: '{deviceGroup: "@name", serial: to_array(devices.entry)[].serial}'
      enrich_fields:
        simple: deviceGroup=device-group
      enrich_key:
        simple: serial
      type:
        simple: Device
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1060,
          "y": 2920
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "45":
    id: "45"
    taskid: ee832525-161f-4468-85bf-446638713f42
    type: title
    task:
      id: ee832525-161f-4468-85bf-446638713f42
      version: -1
      name: Cortex Data Lake Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "48"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1185,
          "y": 925
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "46":
    id: "46"
    taskid: 41733d10-c018-431d-88a6-4e88669df278
    type: title
    task:
      id: 41733d10-c018-431d-88a6-4e88669df278
      version: -1
      name: Splunk Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "48"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -45,
          "y": 735
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "47":
    id: "47"
    taskid: af061842-fdc4-4295-8e12-e37b9df9ab55
    type: title
    task:
      id: af061842-fdc4-4295-8e12-e37b9df9ab55
      version: -1
      name: Panorama Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "48"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1900,
          "y": 925
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "48":
    id: "48"
    taskid: 6d0d754f-9a39-4451-8062-fd36eaa9cb2f
    type: title
    task:
      id: 6d0d754f-9a39-4451-8062-fd36eaa9cb2f
      version: -1
      name: Aggregation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "49"
      - "50"
      - "51"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 580,
          "y": 1295
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "49":
    id: "49"
    taskid: ec6ebd75-e0b5-4706-8314-fd225f78c543
    type: regular
    task:
      id: ec6ebd75-e0b5-4706-8314-fd225f78c543
      version: -1
      name: Aggregate Attribution Device Result
      description: Aggregate entries from multiple sources into AttributionDevice
      scriptName: ExpanseAggregateAttributionDevice
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      current:
        complex:
          root: Expanse
          accessor: AttributionDevice
      input:
        complex:
          root: Splunk
          accessor: Result
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: CDL.Logging
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: Panorama.Monitor.Logs
                iscontext: true
      internal_ip_networks: {}
      serial_fields:
        simple: serial_number,serial,log_source_id,DeviceSN
      sightings_fields: {}
      source_ip_fields: {}
      vsys_fields:
        simple: vsys,Vsys
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 170,
          "y": 1475
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "50":
    id: "50"
    taskid: 394bd3fa-8590-417e-8204-9551c50b121b
    type: regular
    task:
      id: 394bd3fa-8590-417e-8204-9551c50b121b
      version: -1
      name: Aggregate Attribution IP Result
      description: Aggregate entries from multiple sources into AttributionIP
      scriptName: ExpanseAggregateAttributionIP
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      current:
        complex:
          root: Expanse
          accessor: AttributionIP
      input:
        complex:
          root: Splunk
          accessor: Result
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: CDL.Logging
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: Panorama.Monitor.Logs
                iscontext: true
      internal_ip_networks: {}
      sightings_fields: {}
      source_ip_fields:
        simple: src,src_ip,SourceAddress
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 580,
          "y": 1475
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
  "51":
    id: "51"
    taskid: fd633ddf-f4ef-4823-8d20-28f91ee8bd35
    type: regular
    task:
      id: fd633ddf-f4ef-4823-8d20-28f91ee8bd35
      version: -1
      name: Aggregate Attribution User Result
      description: Aggregate entries from multiple sources into AttributionUser
      scriptName: ExpanseAggregateAttributionUser
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      current:
        complex:
          root: Expanse
          accessor: AttributionUser
      input:
        complex:
          root: Splunk
          accessor: Result
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: CDL.Logging
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: Panorama.Monitor.Logs
                iscontext: true
      sightings_fields: {}
      username_fields:
        simple: source_user,srcuser,user,SourceUser
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 985,
          "y": 1475
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
view: |-
  {
    "linkLabelsPosition": {},
    "paper": {
      "dimensions": {
        "height": 3165,
        "width": 3590,
        "x": -820,
        "y": 50
      }
    }
  }
inputs:
- key: Asset
  value:
    simple: ${incident.expanseasset[0]}
  required: false
  description: Expanse Asset
  playbookInputQuery:
- key: IP
  value:
    simple: ${incident.expanseip}
  required: true
  description: Expanse Issue IP
  playbookInputQuery:
- key: Domain
  value:
    simple: ${incident.expansedomain}
  required: false
  description: Expanse Issue Domain
  playbookInputQuery:
- key: Provider
  value:
    simple: ${incident.expanseprovider}
  required: false
  description: Expanse Issue Provider
  playbookInputQuery:
- key: Port
  value:
    simple: ${incident.expanseport}
  required: true
  description: Expanse Issue Port
  playbookInputQuery:
- key: Protocol
  value:
    simple: ${incident.expanseprotocol}
  required: true
  description: Expanse Issue Protocol
  playbookInputQuery:
- key: InternalIPRange
  value: {}
  required: false
  description: 'A list of internal IP ranges to check IP addresses against. The list
    should be provided in CIDR format, separated by commas. An example of a list of
    ranges could be: 172.16.0.0/12,10.0.0.0/8,192.168.0.0/16. If a list of IP ranges
    is not provided, the list provided in the IsIPInRanges script (the known IPv4
    private address ranges) is used by default.'
  playbookInputQuery:
- key: NumberOfDaysInThePast
  value:
    simple: "7"
  required: false
  description: Number of days to look back to for logs.
  playbookInputQuery:
outputs:
- contextPath: Expanse.AttributionIP
  description: IP addresses
  type: unknown
- contextPath: Expanse.AttributionDevice
  description: Devices
  type: unknown
- contextPath: Expanse.AttributionUser
  description: Users
  type: Unknown
tests:
- No tests (auto formatted)
fromversion: 5.0.0
