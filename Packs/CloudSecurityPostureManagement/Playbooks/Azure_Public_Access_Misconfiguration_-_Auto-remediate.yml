adopted: true
description: |-
  Automatically remediates 3 Azure public access misconfigurations: 
  1. Azure storage account has a blob container with public access
  2. Azure VM disk configured with overly permissive network access
  3. Azure Storage Account default network access is set to 'Allow'
  
  The playbook disables public access by setting allowBlobPublicAccess to false, configuring VM disk publicNetworkAccess to Disabled with a DenyAll policy, and updating the storage account default network access action to Deny.
  
  Optional stakeholder notification is available via the "Notify Stakeholders" sub-playbook by setting enableNotifications input to 'yes' (default: 'no'). When enabled, configure at least one recipient (email, Slack channel, or Teams channel) in the Notify Stakeholders playbook inputs. The playbook automatically updates the issue status to "Resolved - Fixed" upon successful remediation.
id: Azure Public Access Misconfiguration - Auto-remediate
inputSections:
- description: Generic group for inputs
  inputs:
  - enableNotifications
  name: General (Inputs group)
inputs:
- description: |-
    Options: yes/no
    Choose if you wish to notify stakeholders about the remediation actions taken. The recipients need to be configured in the Playbook Triggered header of the "Notify Stakeholders" sub-playbook. If no recipients are provided, the playbook will pause to ask for an input.
  key: enableNotifications
  playbookInputQuery: null
  required: true
  value:
    simple: "no"
name: Azure Public Access Misconfiguration - Auto-remediate
outputSections:
- description: Generic group for outputs
  name: General (Outputs group)
  outputs: []
outputs: []
sourceplaybookid: AWS EC2 Instance Misconfiguration - Remediate and Notify
starttaskid: "0"
tasks:
  "0":
    continueonerrortype: ""
    id: "0"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "48"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: "Playbook Triggered header"
      id: 6024ecbf-ae4c-4b64-8ced-2b89cde8fb18
      iscommand: false
      name: ""
      version: -1
    taskid: 6024ecbf-ae4c-4b64-8ced-2b89cde8fb18
    timertriggers: []
    type: start
    view: |-
      {
        "position": {
          "x": 807.5,
          "y": 50
        }
      }
  "5":
    continueonerrortype: ""
    id: "5"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "49"
    note: false
    quietmode: 0
    scriptarguments:
      asset_id:
        simple: ${issue.asset_ids}
    separatecontext: false
    skipunavailable: false
    task:
      brand: Cortex Core - Platform
      description: Get asset information.
      id: 076acded-c500-4703-8c72-aad63c1ce288
      iscommand: true
      name: Get Asset details
      script: Cortex Core - Platform|||core-get-asset-details
      type: regular
      version: -1
    taskid: 076acded-c500-4703-8c72-aad63c1ce288
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 807.5,
          "y": 420
        }
      }
  "10":
    continueonerrortype: ""
    id: "10"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: dbedc2c9-fdfb-43e5-8452-75ef06ca3933
      iscommand: false
      name: Done
      type: title
      version: -1
    taskid: dbedc2c9-fdfb-43e5-8452-75ef06ca3933
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 1022.5,
          "y": 2190
        }
      }
  "15":
    continueonerror: true
    continueonerrortype: ""
    id: "15"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "60"
    note: true
    quietmode: 0
    scriptarguments:
      value:
        simple: |-
          # Remediation Action taken
          **${remediation_action}**
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Save note to issue war room about the remediation action taken.
      id: e72c5e83-7fd4-4f2b-8a99-ad64f200c16d
      iscommand: false
      name: Print remediation action taken
      script: Print
      type: regular
      version: -1
    taskid: e72c5e83-7fd4-4f2b-8a99-ad64f200c16d
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 265,
          "y": 1470
        }
      }
  "20":
    continueonerrortype: ""
    id: "20"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "10"
    note: false
    quietmode: 0
    scriptarguments:
      status:
        simple: Resolved - Fixed
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Sets the status of the issue to Resolved - Fixed
      id: d38ad57b-ea78-4fc6-8780-ce0f848734b4
      iscommand: true
      name: Update Issue status to Resolved - Fixed
      script: Builtin|||setIssueStatus
      type: regular
      version: -1
    taskid: d38ad57b-ea78-4fc6-8780-ce0f848734b4
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 265,
          "y": 2010
        }
      }
  "23":
    continueonerrortype: ""
    id: "23"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "37"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Section header to launch remediation steps.
      id: 7c550129-ff50-4fac-8a08-4d361eea1527
      iscommand: false
      name: Launch Remediation Steps
      type: title
      version: -1
    taskid: 7c550129-ff50-4fac-8a08-4d361eea1527
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 265,
          "y": 760
        }
      }
  "31":
    continueonerrortype: ""
    id: "31"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "10"
    note: false
    quietmode: 0
    scriptarguments:
      value:
        simple: 'Please configure and enable an instance of the Azure integration
          and re-run this playbook. '
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Prints message to war room to indicate Azure integration instance
        is not active.
      id: 09fcb1fe-0245-49e7-8b27-04c70ffa1b95
      iscommand: false
      name: Print - enable Azure and re-run this playbook
      script: Print
      type: regular
      version: -1
    taskid: 09fcb1fe-0245-49e7-8b27-04c70ffa1b95
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1360,
          "y": 2010
        }
      }
  "34":
    continueonerrortype: ""
    id: "34"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "10"
    note: false
    quietmode: 0
    scriptarguments:
      value:
        simple: The chosen playbook is not applicable to the selected issue. The issue was not remediated and remains unresolved.
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Prints message to war room that this playbook is not applicable.
      id: bb241136-96ea-4bdb-8a58-c6fcc3cc77bc
      iscommand: false
      name: Print - playbook not applicable
      script: Print
      type: regular
      version: -1
    taskid: bb241136-96ea-4bdb-8a58-c6fcc3cc77bc
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1920,
          "y": 2010
        }
      }
  "37":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: issue.ruleid
          operator: isEqualString
          right:
            value:
              simple: c085d057-d5a4-4118-afdf-f653e6b47995
        - left:
            iscontext: true
            value:
              simple: issue.matching_service_rule_id
          operator: isEqualString
          right:
            value:
              simple: c085d057-d5a4-4118-afdf-f653e6b47995
      label: Storage Account with blob container
    - condition:
      - - left:
            iscontext: true
            value:
              simple: issue.ruleid
          operator: isEqualString
          right:
            value:
              simple: 6a3ba52c-1a0e-4359-aba5-e417ca280270
        - left:
            iscontext: true
            value:
              simple: issue.matching_service_rule_id
          operator: isEqualString
          right:
            value:
              simple: 6a3ba52c-1a0e-4359-aba5-e417ca280270
      label: VM Disk with overly permissive network access
    - condition:
      - - left:
            iscontext: true
            value:
              simple: issue.ruleid
          operator: isEqualString
          right:
            value:
              simple: 0c8ba0ca-2414-4d62-897c-4b57a291ae2b
        - left:
            iscontext: true
            value:
              simple: issue.matching_service_rule_id
          operator: isEqualString
          right:
            value:
              simple: 0c8ba0ca-2414-4d62-897c-4b57a291ae2b
      label: Storage Account default network access is set to 'Allow'
    continueonerrortype: ""
    id: "37"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      Storage Account default network access is set to 'Allow':
      - "64"
      Storage Account with blob container:
      - "54"
      VM Disk with overly permissive network access:
      - "61"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Check if remediation is available for the issue ruleid.
      id: e2e14ba5-9ea0-4bed-8d7e-0edcd21b5459
      iscommand: false
      name: Check the type of remediation
      type: condition
      version: -1
    taskid: e2e14ba5-9ea0-4bed-8d7e-0edcd21b5459
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 265,
          "y": 930
        }
      }
  "48":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: issue.ruleid
          operator: inList
          right:
            value:
              simple: c085d057-d5a4-4118-afdf-f653e6b47995, 6a3ba52c-1a0e-4359-aba5-e417ca280270,
                0c8ba0ca-2414-4d62-897c-4b57a291ae2b
        - left:
            iscontext: true
            value:
              simple: issue.matching_service_rule_id
          operator: inList
          right:
            value:
              simple: c085d057-d5a4-4118-afdf-f653e6b47995, 6a3ba52c-1a0e-4359-aba5-e417ca280270,
                0c8ba0ca-2414-4d62-897c-4b57a291ae2b
      label: "yes"
    continueonerrortype: ""
    id: "48"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "34"
      "yes":
      - "5"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Check if remediation is available for the issue ruleid.
      id: 83d906d8-4037-46cc-9c0d-fe8787146d11
      iscommand: false
      name: Is playbook applicable?
      type: condition
      version: -1
    taskid: 83d906d8-4037-46cc-9c0d-fe8787146d11
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 807.5,
          "y": 220
        }
      }
  "49":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              complex:
                accessor: state
                filters:
                - - left:
                      iscontext: true
                      value:
                        simple: modules.brand
                    operator: isEqualString
                    right:
                      value:
                        simple: Azure
                root: modules
          operator: isEqualString
          right:
            value:
              simple: active
      label: "yes"
    continueonerrortype: ""
    id: "49"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "31"
      "yes":
      - "23"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Returns 'yes' if integration brand is available. Otherwise returns
        'no'.
      id: f65b5536-845f-4f17-8d1e-ee1ab45c2ea2
      iscommand: false
      name: Is Azure integration available?
      type: condition
      version: -1
    taskid: f65b5536-845f-4f17-8d1e-ee1ab45c2ea2
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 807.5,
          "y": 600
        }
      }
  "54":
    continueonerrortype: ""
    id: "54"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "55"
    note: false
    quietmode: 0
    scriptarguments:
      account_name:
        simple: ${Core.CoreAsset.xdm__asset__name}
      allow_blob_public_access:
        simple: "false"
      resource_group_name:
        simple: ${Core.CoreAsset.xdm__asset__raw_fields.Platform Discovery.resourceGroup}
      subscription_id:
        simple: ${Core.CoreAsset.xdm__asset__realm}
    separatecontext: false
    skipunavailable: false
    task:
      brand: Azure
      description: Updates a specific account storage.
      id: fe73ed6c-03a3-4a59-a5c9-e4dda732f958
      iscommand: true
      name: 'Blob Container: Disable public access'
      script: Azure|||azure-storage-account-update
      type: regular
      version: -1
    taskid: fe73ed6c-03a3-4a59-a5c9-e4dda732f958
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -365,
          "y": 1140
        }
      }
  "55":
    continueonerrortype: ""
    id: "55"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "15"
    note: false
    quietmode: 0
    scriptarguments:
      append:
        simple: "false"
      key:
        simple: remediation_action
      value:
        simple: |-
          The allowBlobPublicAccess property was set to false for storage account - ${Core.CoreAsset.xdm__asset__name}
          Equivalent Azure CLI Command:
          az resource update --ids ${Core.CoreAsset.xdm__asset__name} --set properties.allowBlobPublicAccess=false
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Set a value in context under the key you entered.
      id: da1b5926-9960-44f0-8c41-bf6b6b81eb3f
      iscommand: false
      name: Set remediation action
      script: Set
      type: regular
      version: -1
    taskid: da1b5926-9960-44f0-8c41-bf6b6b81eb3f
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": -365,
          "y": 1300
        }
      }
  "60":
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: inputs.enableNotifications
          operator: isEqualString
          right:
            value:
              simple: "yes"
      label: "yes"
    continueonerrortype: ""
    id: "60"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - "20"
      "yes":
      - "63"
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      id: b7e91c15-c188-4b0f-887e-080c07db1ef8
      iscommand: false
      name: Is notification enabled?
      type: condition
      version: -1
    taskid: b7e91c15-c188-4b0f-887e-080c07db1ef8
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 265,
          "y": 1650
        }
      }
  "61":
    continueonerrortype: ""
    id: "61"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "62"
    note: false
    quietmode: 0
    scriptarguments:
      disk_name:
        simple: ${Core.CoreAsset.xdm__asset__name}
      network_access_policy:
        simple: DenyAll
      public_network_access:
        simple: Disabled
      resource_group_name:
        simple: ${Core.CoreAsset.xdm__asset__raw_fields.Platform Discovery.resourceGroup}
      subscription_id:
        simple: ${Core.CoreAsset.xdm__asset__realm}
    separatecontext: false
    skipunavailable: false
    task:
      brand: Azure
      description: Updates a disk.
      id: 53cf5c69-5f37-430c-bf52-b56d4d8d199e
      iscommand: true
      name: 'VM Disk: Disable public access'
      script: Azure|||azure-disk-update
      type: regular
      version: -1
    taskid: 53cf5c69-5f37-430c-bf52-b56d4d8d199e
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 265,
          "y": 1140
        }
      }
  "62":
    continueonerrortype: ""
    id: "62"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "15"
    note: false
    quietmode: 0
    scriptarguments:
      append:
        simple: "false"
      key:
        simple: remediation_action
      value:
        simple: |-
          The publicNetworkAccess property was set to Disabled and networkAccessPolicy property was set to DenyAll for VM Disk - ${Core.CoreAsset.xdm__asset__name}
          Equivalent Azure CLI Command:
          az disk update --name ${Core.CoreAsset.xdm__asset__name} --resource-group ${Core.CoreAsset.xdm__asset__raw_fields.Platform Discovery.resourceGroup} --public-network-access Disabled --network-access-policy DenyAll
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Set a value in context under the key you entered.
      id: dd011461-99c2-4e8b-8249-8c61a235007d
      iscommand: false
      name: Set remediation action
      script: Set
      type: regular
      version: -1
    taskid: dd011461-99c2-4e8b-8249-8c61a235007d
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 265,
          "y": 1310
        }
      }
  "63":
    continueonerrortype: ""
    id: "63"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    loop:
      exitCondition: ""
      iscommand: false
      max: 100
      wait: 1
    nexttasks:
      '#none#':
      - "20"
    note: false
    quietmode: 0
    scriptarguments:
      Subject:
        simple: Issue ${issue.name} has been resolved
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: This playbook automates notifying stakeholders via Slack v3, Microsoft
        Teams, or email. You have the flexibility to notify other teams via Slack,
        Microsoft Teams or Email by configuring the necessary integration. This playbook
        requires existing integrations with Slack, Microsoft Teams, Mail Sender or
        Gmail to perform these actions. If none of these integrations are found in
        your account, the playbook will exit with no action.
      id: d84d9d6f-03a0-4d1f-8fab-ef0db76de9ad
      iscommand: false
      name: Notify Stakeholders
      playbookId: Notify Stakeholders
      type: playbook
      version: -1
    taskid: d84d9d6f-03a0-4d1f-8fab-ef0db76de9ad
    timertriggers: []
    type: playbook
    view: |-
      {
        "position": {
          "x": 480,
          "y": 1830
        }
      }
  "64":
    continueonerrortype: ""
    id: "64"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "65"
    note: false
    quietmode: 0
    scriptarguments:
      account_name:
        simple: ${Core.CoreAsset.xdm__asset__name}
      network_ruleset_default_action:
        simple: Deny
      resource_group_name:
        simple: ${Core.CoreAsset.xdm__asset__raw_fields.Platform Discovery.resourceGroup}
      subscription_id:
        simple: ${Core.CoreAsset.xdm__asset__realm}
    separatecontext: false
    skipunavailable: false
    task:
      brand: Azure
      description: Updates a specific account storage.
      id: 94357669-45e2-46ca-b7b0-cdead9ee9d2c
      iscommand: true
      name: 'Storage Account: Set Default network access to Deny'
      script: Azure|||azure-storage-account-update
      type: regular
      version: -1
    taskid: 94357669-45e2-46ca-b7b0-cdead9ee9d2c
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 920,
          "y": 1140
        }
      }
  "65":
    continueonerrortype: ""
    id: "65"
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - "15"
    note: false
    quietmode: 0
    scriptarguments:
      append:
        simple: "false"
      key:
        simple: remediation_action
      value:
        simple: |-
          The default network access was set to 'Deny' for - ${Core.CoreAsset.xdm__asset__name}
          Equivalent Azure CLI Command:
          az storage account update --name ${resourceName} --resource-group ${resourceGroup} --default-action Deny
    separatecontext: false
    skipunavailable: false
    task:
      brand: ""
      description: Set a value in context under the key you entered.
      id: 3839098f-6d7d-40f6-ae36-efd29029c35e
      iscommand: false
      name: Set remediation action
      script: Set
      type: regular
      version: -1
    taskid: 3839098f-6d7d-40f6-ae36-efd29029c35e
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 920,
          "y": 1310
        }
      }
version: -1
view: |-
  {
    "linkLabelsPosition": {
      "37_54_Storage Account with blob container": 0.65,
      "37_61_VM Disk with overly permissive network access": 0.47,
      "48_5_yes": 0.51
    },
    "paper": {
      "dimensions": {
        "height": 2200,
        "width": 2665,
        "x": -365,
        "y": 50
      }
    }
  }
fromversion: 8.11.0