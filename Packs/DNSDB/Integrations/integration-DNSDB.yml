commonfields:
  id: Farsight DNSDB
  version: -1
name: Farsight DNSDB
display: Farsight DNSDB
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: Query Farsight DNSDB service
configuration:
- display: API Key
  name: apiKey
  defaultvalue: ""
  type: 0
  required: true
- display: DNSDB Service URL
  name: url
  defaultvalue: https://api.dnsdb.info/
  type: 0
  required: true
- display: Use system proxy settings
  name: useproxy
  defaultvalue: "true"
  type: 8
  required: false
script:
  script: |
    var serverUrl = params.url;
    if (serverUrl[serverUrl.length - 1] !== '/') {
        serverUrl += '/';
    }

    var dict = {
        rdata: {
            url: 'lookup/rdata/',
            defaultLimit:100,
            tableColumns: {
                rrname:'',
                rrtype:'',
                rdata:'',
                count:'',
                time_first:'ts',
                time_last:'ts',
                zone_time_first:'ts',
                zone_time_last:'ts'
            }
        },
        rrset: {
            url: 'lookup/rrset/name/',
            defaultLimit:100,
            tableColumns: {
                rrname:'',
                rrtype:'',
                rdata:'',
                bailiwick:'',
                count:'',
                time_first:'ts',
                time_last:'ts',
                zone_time_first:'ts',
                zone_time_last:'ts'
            }
        },
        limit: {
            url: 'lookup/rate_limit/'
        }
    }
    var valueExist = function(data,key) {
        var array = (Array.isArray(data)) ? data : [data];

        for (var i=0;i<array.length;i++) {
            if (array[i][key]) {
                return true;
            }
        }
        return false;

    }

    var tsToTime = function(ts) {
        if (ts) {
            var date = new Date(ts*1000);
            var hours = date.getHours();
            var minutes = "0" + date.getMinutes();
            var seconds = "0" + date.getSeconds();
            var formattedTime = date + ' ' + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
            return formattedTime;
        } else {
            return '';
        }
    }

    var arrToNewLines = function (data) {
        var md='';
        if (Array.isArray(data)) {
            for (var i=0;i<data.length;i++) {
                md += data[i] + '<br>';
            }

        } else {
            md=data;
        }
        return md;
    }

    var dataToMd = function (api,data) {
        var keys={};
        for (key in dict[api].tableColumns) {
            if (valueExist(data,key)) {
                keys[key]=dict[api].tableColumns[key];
            }
        }
        var head='|';
        var line='-';
        for (key in keys) {
            head+=key+'|';
            line+='-|';
        }
        var md = '### Farsight DNSDB\n';
        md+=head+'\n'+line+'\n';
        for (var i = 0; i<data.length; i++) {
            md += '|';
            for (key in keys) {
                if (keys[key] == 'ts') {
                    md += tsToTime(data[i][key])+'|';
                } else {
                    md += arrToNewLines(data[i][key]) + '|';
                }
            }
            md += '\n';
        }
        return md;
    }

    var sendRequest = function(requestUrl,parameters) {
        var url = serverUrl + requestUrl + encodeToURLQuery(parameters);
        var res = http(
            url,
            {
                Method: 'GET', // Can be POST, PUT, DELETE, HEAD, OPTIONS or CONNECT
                Headers: {
                    'Accept': ['application/json'],
                    'X-API-Key': [params.apiKey]
                }
            },
            false,
            params.useproxy

        );
        if (res.StatusCode == 404 || res.StatusCode == 400) {
            //null is returned while 404 returns error that stops playbook
            return null;
        }
        if (res.StatusCode < 200 || res.StatusCode>299) {
            throw 'Error ' + res.StatusCode + '. ' + res.Status;
        }
        var obj={};
        obj.entries=[];
        var array = res.Body.split('\n');
        for (var i=0;i<array.length;i++) {
            if (array[i] && array[i].length > 0) {
                try {
                    obj.entries.push(JSON.parse(array[i]));
                } catch (err) {
                    // doing nothing when JSON fails to parse a specific line.
                    // due to illegal structure the service may return.
                    // Simply ignoring those lines and keep parsing other lines
                }
            }
        }
        return obj;
    };

    var lookupRequest = function(api,requestUrl) {
        var parameters={};
        parameters.limit = (args.limit) ? args.limit : dict[api].defaultLimit;

        if (args.time_first_before) {
            parameters.time_first_before = args.time_first_before*-1;
        }
        if (args.time_first_after) {
            parameters.time_first_after = args.time_first_after*-1;
        }
        if (args.time_last_before) {
            parameters.time_last_before = args.time_last_before*-1;
        }
        if (args.time_last_after) {
            parameters.time_last_after = args.time_last_after*-1;
        }
        var res= sendRequest(requestUrl,parameters);
        if (res === null) {
            md = '### Farsight DNSDB: No information found on ' + args.value;
            return { ContentsFormat: formats.markdown, Type: entryTypes.note, Contents: md } ;
        }
        var md = dataToMd(api,res.entries);
        return {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json, HumanReadable: md};
    }

    // The command input arg holds the command sent from the user.
    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            res = sendRequest(dict.limit.url);
            return 'ok';
        case 'dnsdb-rdata':
            // /lookup/rdata/TYPE/VALUE/RRTYPE
            var requestUrl = dict.rdata.url + args.type + '/' + args.value;
            requestUrl += (args.rrtype) ? '/' + args.rrtype : '';
            return lookupRequest('rdata',requestUrl);
        case 'dnsdb-rrset':
            // /lookup/rrset/name/OWNER_NAME/RRTYPE/BAILIWICK
            var requestUrl = dict.rrset.url + args.owner;
            requestUrl += (args.rrtype) ? '/' + args.rrtype : '';
            requestUrl += (args.bailiwick) ? '/' + args.bailiwick : '';
            return lookupRequest('rrset',requestUrl);
        default:
            throw 'Unknown command ' + command;
    }
  type: javascript
  commands:
  - name: dnsdb-rdata
    arguments:
    - name: type
      required: true
      auto: PREDEFINED
      predefined:
      - name
      - ip
      - raw
      description: query type
    - name: value
      required: true
      description: query value
    - name: limit
      description: Limit the number of returned records
      defaultValue: "100"
    - name: time_first_before
      description: Filter results for entries seen for first time before (seconds)
    - name: time_last_before
      description: Filter results for entries seen last time before (seconds)
    - name: time_first_after
      description: filter results for entries seen first time after (seconds)
    - name: time_last_after
      description: filter results for entries seen last time after (seconds)
    - name: rrtype
      description: query rrtype
    description: Lookup rdata records
  - name: dnsdb-rrset
    arguments:
    - name: owner
      required: true
      description: Owner name to query
    - name: rrtype
      description: rrtype value to query
    - name: bailiwick
      description: Bailiwick value to query
    - name: limit
      description: Limit the number of returned records
      defaultValue: "100"
    - name: time_first_before
      description: Filter results for entries seen for first time before (seconds)
    - name: time_first_after
      description: Filter results for entries seen for first time after (seconds)
    - name: time_last_before
      description: Filter results for entries seen for last time before (seconds)
    - name: time_last_after
      description: Filter results for entries seen for last time after (seconds)
    description: Lookup rrser records
  runonce: false
