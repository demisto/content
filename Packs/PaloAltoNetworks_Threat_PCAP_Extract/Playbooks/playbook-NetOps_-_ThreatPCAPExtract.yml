contentitemexportablefields:
  contentitemfields:
    propagationLabels:
    - all
description: Auto Retrieve PCAP from firewall threat logs
id: NetOps - ThreatPCAPExtract
fromversion: 6.5.0
inputs:
- description: clear context?
  key: debug
  playbookInputQuery:
  required: false
  value:
    simple: '1'
- description: shoudl we use pcapminerv2 to extract
  key: mine_pcap
  playbookInputQuery:
  required: false
  value:
    simple: '1'
- description: Incident default severity
  key: inc_severity
  playbookInputQuery:
  required: false
  value:
    simple: '0.5'
- description: Default incident details
  key: inc_details
  playbookInputQuery:
  required: false
  value:
    simple: Threat Log PCAP extraction operation
- description: |-
    Incident Labels

    format
     [\{"labelName": "labelValue"\}, \{"labelName1": "labelValue1"\}]
  key: inc_labels
  playbookInputQuery:
  required: false
  value: {}
- description: how to get the PCAP, via firewall connection directly or via Panorama as Proxy?
  key: proxy_via_panorama
  playbookInputQuery:
  required: false
  value:
    simple: '1'
- description: name of the instance for ngfw connection
  key: pan_os_ngfw_instance
  playbookInputQuery:
  required: false
  value:
    simple: vm50-local
- description: name of the instance for panorama connection
  key: pan_os_pra_instance
  playbookInputQuery:
  required: false
  value:
    simple: Panorama_esxi_panorama
name: NetOps - ThreatPCAPExtract
outputs: []
starttaskid: '0'
tags:
- custom
- ep
tasks:
  '0':
    id: '0'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '2'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      id: 34199dfd-4efe-40ac-83e6-8e89dde1b77b
      iscommand: false
      name: ''
      version: -1
      description: ''
    taskid: 34199dfd-4efe-40ac-83e6-8e89dde1b77b
    timertriggers: []
    type: start
    view: |-
      {
        "position": {
          "x": 820,
          "y": -240
        }
      }
  '1':
    id: '1'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '15'
    note: true
    quietmode: 0
    scriptarguments:
      deviceName:
        simple: ${incident.devicename}
      localName:
        simple: threatlog-${incident.devicename}-${incident.sessionid}-${incident.pcapid}
      pcapID:
        simple: ${incident.pcapid}
      pcapType:
        simple: threat-pcap
      searchTime:
        simple: ${incident.receivedtime}
      serialNumber:
        simple: ${incident.deviceid}
      sessionID:
        simple: ${incident.sessionid}
      using:
        simple: ${inputs.pan_os_pra_instance}
    separatecontext: false
    skipunavailable: false
    task:
      brand: Panorama
      description: Returns information for a Panorama PCAP file. The recommended maximum file size is 5 MB. If the limit is exceeded, you may need to SSH the firewall and run the scp export command to export the PCAP file. See the Palo Alto Networks documentation.
      id: 827a15f0-7d62-4202-863b-58294249eca3
      iscommand: true
      name: pan-os-get-pcap
      script: Panorama|||pan-os-get-pcap
      type: regular
      version: -1
    taskid: 827a15f0-7d62-4202-863b-58294249eca3
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 890,
          "y": 860
        }
      }
  '2':
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: inputs.debug
          operator: isEqualString
          right:
            value:
              simple: '1'
      label: yes
    id: '2'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '11'
      yes:
      - '3'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      id: 1042d843-0aff-4b65-8bb2-b0c4c15acd43
      iscommand: false
      name: Debug Enabled
      type: condition
      version: -1
    taskid: 1042d843-0aff-4b65-8bb2-b0c4c15acd43
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 820,
          "y": -120
        }
      }
  '3':
    id: '3'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '11'
    note: false
    quietmode: 0
    scriptarguments:
      all:
        simple: no
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: |-
        Delete field from context.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs.paloaltonetworks.com/cortex/cortex-xsoar/6-2/cortex-xsoar-admin/playbooks/automations.html
      id: 76480a83-5184-437c-8d2b-7497da4a4adc
      iscommand: false
      name: DeleteContext
      scriptName: DeleteContext
      type: regular
      version: -1
    taskid: 76480a83-5184-437c-8d2b-7497da4a4adc
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1260,
          "y": -80
        }
      }
  '4':
    id: '4'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '6'
    note: true
    quietmode: 0
    scriptarguments:
      entry_id:
        simple: ${File.EntryID}
      extract_strings:
        simple: 'True'
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: |-
        PcapMIner V2 allows to parse PCAP files by displaying the all of the relevant data within including ip addresses, ports, flows, specific protocol breakdown, searching by regex, decrypting encrypted  traffic and more.
        This automation takes about a minute to process 20,000 packets (which is approximately 10MB). If you want to mine large files you can either:
        a) Use the `pcap_filter` parameter to filter your PCAP file and thus make is smaller.
        b) Copy the automation and change the `default timeout` parameter to match your needs.
      id: 34416cbb-a50a-4259-85b0-e6d94cdd023a
      iscommand: false
      name: PcapMinerV2
      scriptName: PcapMinerV2
      type: regular
      version: -1
    taskid: 34416cbb-a50a-4259-85b0-e6d94cdd023a
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 910,
          "y": 1850
        }
      }
  '5':
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: inputs.mine_pcap
          operator: isEqualString
          right:
            value:
              simple: '1'
      label: yes
    id: '5'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '6'
      yes:
      - '4'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      id: 891ceb64-329c-4252-8e92-89c56eb166a8
      iscommand: false
      name: should we mine PCAP for flows?
      type: condition
      version: -1
      description: ''
    taskid: 891ceb64-329c-4252-8e92-89c56eb166a8
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 1090,
          "y": 1670
        }
      }
  '6':
    id: '6'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '16'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      id: acf2487c-3331-45b7-88de-32736e079e49
      iscommand: false
      name: end
      type: title
      version: -1
      description: ''
    taskid: acf2487c-3331-45b7-88de-32736e079e49
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 1530,
          "y": 2030
        }
      }
  '9':
    id: '9'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      no:
      - '6'
      yes:
      - '13'
    note: false
    quietmode: 0
    results:
    - brandInstances
    scriptarguments:
      brandname:
        simple: Panorama
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'
      id: 6d7d55f3-272e-4fd2-87c5-27a2597c7fe3
      iscommand: false
      name: IsIntegrationAvailable - PAN-OS
      scriptName: IsIntegrationAvailable
      type: condition
      version: -1
    taskid: 6d7d55f3-272e-4fd2-87c5-27a2597c7fe3
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 1110,
          "y": 500
        }
      }
  '10':
    id: '10'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '12'
    note: false
    quietmode: 0
    scriptarguments:
      details:
        simple: ${inputs.inc_details}
      severity:
        simple: ${inputs.inc_severity}
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Change the properties of an incident
      id: c60975b3-41e0-4efa-8286-2313be34a18c
      iscommand: true
      name: setIncident
      script: Builtin|||setIncident
      type: regular
      version: -1
    taskid: c60975b3-41e0-4efa-8286-2313be34a18c
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1110,
          "y": 240
        }
      }
  '11':
    id: '11'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '10'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      id: 49e76f35-9f28-4ca3-81a7-8e9f0f13eb2b
      iscommand: false
      name: Set Incident Properties
      type: title
      version: -1
      description: ''
    taskid: 49e76f35-9f28-4ca3-81a7-8e9f0f13eb2b
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 1110,
          "y": 120
        }
      }
  '12':
    id: '12'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '9'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      id: a03c3dc4-4782-4624-86ae-51a32305ee98
      iscommand: false
      name: Get PCAP
      type: title
      version: -1
      description: ''
    taskid: a03c3dc4-4782-4624-86ae-51a32305ee98
    timertriggers: []
    type: title
    view: |-
      {
        "position": {
          "x": 1110,
          "y": 390
        }
      }
  '13':
    conditions:
    - condition:
      - - left:
            iscontext: true
            value:
              simple: inputs.proxy_via_panorama
          operator: isEqualString
          right:
            value:
              simple: '1'
      label: Panorama
    id: '13'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#default#':
      - '14'
      Panorama:
      - '1'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      id: d6347fd2-b7bf-4e8a-85d8-48f93ddb57c3
      iscommand: false
      name: Connect Via Panorama or Firewall Direct for PCAP
      type: condition
      version: -1
      description: ''
    taskid: d6347fd2-b7bf-4e8a-85d8-48f93ddb57c3
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 1110,
          "y": 670
        }
      }
  '14':
    id: '14'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '15'
    note: true
    quietmode: 0
    scriptarguments:
      deviceName:
        simple: ${incident.devicename}
      localName:
        simple: threatlog-${incident.devicename}-${incident.sessionid}-${incident.pcapid}
      pcapID:
        simple: ${incident.pcapid}
      pcapType:
        simple: threat-pcap
      searchTime:
        simple: ${incident.receivedtime}
      serialNumber:
        simple: ${incident.deviceid}
      sessionID:
        simple: ${incident.sessionid}
      using:
        simple: ${inputs.pan_os_ngfw_instance}
    separatecontext: false
    skipunavailable: false
    task:
      brand: Panorama
      description: Returns information for a Panorama PCAP file. The recommended maximum file size is 5 MB. If the limit is exceeded, you may need to SSH the firewall and run the scp export command to export the PCAP file. See the Palo Alto Networks documentation.
      id: caf011c3-8bb5-4392-85b8-3e557d3aa59f
      iscommand: true
      name: pan-os-get-pcap
      script: Panorama|||pan-os-get-pcap
      type: regular
      version: -1
    taskid: caf011c3-8bb5-4392-85b8-3e557d3aa59f
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1330,
          "y": 860
        }
      }
  '15':
    id: '15'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '18'
    note: false
    quietmode: 0
    scriptarguments:
      pcapfilename:
        simple: ${File.Name}
      pcapfilesize:
        simple: ${File.Size}
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Change the properties of an incident
      id: b1ae1c73-5878-4372-828a-10c5fea5c462
      iscommand: true
      name: setIncident
      script: Builtin|||setIncident
      type: regular
      version: -1
    taskid: b1ae1c73-5878-4372-828a-10c5fea5c462
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1090,
          "y": 1050
        }
      }
  '16':
    id: '16'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    note: false
    quietmode: 0
    scriptarguments:
      closeNotes:
        simple: PCAP Extracted
      closeReason:
        simple: Resolved
      id:
        complex:
          accessor: id
          root: incident
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Close the current incident
      id: d0ec611c-9588-465e-8698-7b9f7311f088
      iscommand: true
      name: closeInvestigation
      script: Builtin|||closeInvestigation
      type: regular
      version: -1
    taskid: d0ec611c-9588-465e-8698-7b9f7311f088
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1530,
          "y": 2170
        }
      }
  '17':
    id: '17'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '5'
    note: false
    quietmode: 0
    scriptarguments:
      severity:
        simple: '0.5'
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Change the properties of an incident
      id: 971b294d-35c5-4fb3-86ab-5ccab9771084
      iscommand: true
      name: setIncident - Info
      script: Builtin|||setIncident
      type: regular
      version: -1
    taskid: 971b294d-35c5-4fb3-86ab-5ccab9771084
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 290,
          "y": 1400
        }
      }
  '18':
    conditions:
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: incident.classification
          operator: isEqualString
          right:
            value:
              simple: Informational
      label: Info
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: incident.classification
          operator: isEqualString
          right:
            value:
              simple: Low
      label: Low
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: incident.classification
          operator: isEqualString
          right:
            value:
              simple: Medium
      label: Medium
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: incident.classification
          operator: isEqualString
          right:
            value:
              simple: High
      label: High
    - condition:
      - - ignorecase: true
          left:
            iscontext: true
            value:
              simple: incident.classification
          operator: isEqualString
          right:
            value:
              simple: Critical
      label: Critical
    id: '18'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      Critical:
      - '22'
      High:
      - '21'
      Info:
      - '17'
      Low:
      - '19'
      Medium:
      - '20'
    note: false
    quietmode: 0
    separatecontext: false
    skipunavailable: false
    task:
      brand: ''
      id: 382c26bd-853f-4166-8791-9159be76c8e6
      iscommand: false
      name: Set Severity from Log
      type: condition
      version: -1
    taskid: 382c26bd-853f-4166-8791-9159be76c8e6
    timertriggers: []
    type: condition
    view: |-
      {
        "position": {
          "x": 1090,
          "y": 1220
        }
      }
  '19':
    id: '19'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '5'
    note: false
    quietmode: 0
    scriptarguments:
      classification:
        simple: '1'
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Change the properties of an incident
      id: 16e69c9a-9ff3-4da3-8edf-e784fb2857d1
      iscommand: true
      name: setIncident - Low
      script: Builtin|||setIncident
      type: regular
      version: -1
    taskid: 16e69c9a-9ff3-4da3-8edf-e784fb2857d1
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 690,
          "y": 1400
        }
      }
  '20':
    id: '20'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '5'
    note: false
    quietmode: 0
    scriptarguments:
      classification:
        simple: '2'
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Change the properties of an incident
      id: 3b978861-596e-49fe-815b-8447e0d86052
      iscommand: true
      name: setIncident - Medium
      script: Builtin|||setIncident
      type: regular
      version: -1
    taskid: 3b978861-596e-49fe-815b-8447e0d86052
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1090,
          "y": 1400
        }
      }
  '21':
    id: '21'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '5'
    note: false
    quietmode: 0
    scriptarguments:
      classification:
        simple: '3'
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Change the properties of an incident
      id: 4c896da3-16b9-4855-8e53-a1fc415bfbd9
      iscommand: true
      name: setIncident - HIgh
      script: Builtin|||setIncident
      type: regular
      version: -1
    taskid: 4c896da3-16b9-4855-8e53-a1fc415bfbd9
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1490,
          "y": 1400
        }
      }
  '22':
    id: '22'
    ignoreworker: false
    isautoswitchedtoquietmode: false
    isoversize: false
    nexttasks:
      '#none#':
      - '5'
    note: false
    quietmode: 0
    scriptarguments:
      classification:
        simple: '4'
    separatecontext: false
    skipunavailable: false
    task:
      brand: Builtin
      description: Change the properties of an incident
      id: 9e66eb70-889b-49c7-83b9-17b28862a5f2
      iscommand: true
      name: setIncident - Critical
      script: Builtin|||setIncident
      type: regular
      version: -1
    taskid: 9e66eb70-889b-49c7-83b9-17b28862a5f2
    timertriggers: []
    type: regular
    view: |-
      {
        "position": {
          "x": 1900,
          "y": 1400
        }
      }
version: -1
view: |-
  {
    "linkLabelsPosition": {},
    "paper": {
      "dimensions": {
        "height": 2505,
        "width": 1990,
        "x": 290,
        "y": -240
      }
    }
  }
tests:
- No tests (auto formatted)
