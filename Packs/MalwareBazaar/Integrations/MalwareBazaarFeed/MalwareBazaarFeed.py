from typing import Dict
from CommonServerPython import *
from CommonServerUserPython import *
import CSVFeedApiModule as CSVFeed
import JSONFeedApiModule as JSONFeed

INTEGRATION_NAME = "MalwareBazaar Feed"


def custom_build_relationships(feed_config: Dict, _mapping: Dict, indicator_data: Dict) -> List[dict]:
    if indicator_data.get(feed_config.get('relation_entity_b')):
        relationships_lst = EntityRelationship(
            name=feed_config.get('relation_name'),
            entity_a=indicator_data.get('value'),
            entity_a_type=indicator_data.get('type'),
            entity_b=indicator_data.get(feed_config.get('relation_entity_b')),
            entity_b_type=feed_config.get('relation_entity_b_type'),
            reverse_name=feed_config.get('reverse_relationship_name')
        )
        return [relationships_lst.to_indicator()]
    return []


def indicator_mapping(mapping: Dict, indicator: Dict, attributes: Dict):
    for map_key in mapping:
        if map_key in attributes:
            fields = mapping[map_key].split(".")
            if len(fields) > 1:
                if indicator['fields'].get(fields[0]):
                    indicator['fields'][fields[0]][0].update({fields[1]: attributes.get(map_key)})
                else:
                    indicator['fields'][fields[0]] = [{fields[1]: attributes.get(map_key)}]
            else:
                indicator['fields'][mapping[map_key]] = attributes.get(map_key)  # type: ignore
        if map_key == 'url_download':
            indicator['fields']['url_download'] = f"{mapping[map_key]}{indicator['value']}/"


def build_params_for_first_fetch(params: Dict) -> Dict:
    feed_url_to_config = {
        'https://bazaar.abuse.ch/export/txt/sha256/full/': {
            'fieldnames': [
                'first_seen_utc', 'sha256_hash', 'md5_hash', 'sha1_hash', 'reporter', 'file_name',
                'file_type_guess', 'imphash', 'ssdeep'
            ],
            'indicator_type': FeedIndicatorType.File,
            'relation_name': EntityRelationship.Relationships.INDICATOR_OF,
            'reverse_relationship_name': EntityRelationship.Relationships.INDICATED_BY,
            'relation_entity_b': 'signature',
            'relation_entity_b_type': 'Malware',
            'mapping': {
                'sha256_hash': 'sha256',
                'sha1_hash': 'sha1',
                'md5_hash': 'md5',
                'first_seen_utc': 'first_seen_by_source',
                'file_name': 'Associated File Names',
                'file_size': 'size',
                'file_type_guess': 'filetype',
                'reporter': 'reported_by',
                'imphash': 'imphash',
                'ssdeep': 'ssdeep',
                'url_download': 'https://bazaar.abuse.ch/sample/'
            }
        }
    }
    params['url'] = 'https://bazaar.abuse.ch/export/txt/sha256/full/'
    params['feed_url_to_config'] = feed_url_to_config
    params['delimiter'] = ','
    return params


def build_params_for_other_fetches(params: Dict) -> Dict:
    params['feed_name_to_config'] = {
        'File': {
            'url': f'{params.get("url")}/api/v1/',  # for jason
            'extractor': "data",
            'indicator': 'sha256_hash',
            'indicator_type': FeedIndicatorType.File,
            'relation_name': EntityRelationship.Relationships.INDICATOR_OF,
            'reverse_relationship_name': EntityRelationship.Relationships.INDICATED_BY,
            'relation_entity_b': 'signature',
            'relation_entity_b_type': 'Malware',
            'create_relations_function': custom_build_relationships,
            'mapping_function': indicator_mapping,
            'mapping': {
                'sha256_hash': 'sha256',
                'sha1_hash': 'sha1',
                'md5_hash': 'md5',
                'first_seen': 'first_seen_by_source',
                'last_seen': 'last_seen_by_source',
                'file_name': 'Associated File Names',
                'file_size': 'size',
                'file_type': 'filetype',
                'reporter': 'reported_by',
                'imphash': 'imphash',
                'ssdeep': 'ssdeep',
                'tags': 'tags',
                'url_download': 'https://bazaar.abuse.ch/sample/'
            }
        }
    }
    params['data'] = {'query': 'get_recent',
                      'selector': 'time'}  # query params to get only the recent changes for the incremental feed

    return params


def build_params(is_first_fetch: bool, params: Dict) -> Dict:
    params['indicator_type'] = FeedIndicatorType.File
    build_params_for_first_fetch(params) if is_first_fetch else build_params_for_other_fetches(params)
    return params


def main() -> None:
    params = {k: v for k, v in demisto.params().items() if v is not None}
    is_first_fetch = True if not get_feed_last_run() else get_feed_last_run()['is_first_fetch']
    params = build_params(is_first_fetch, params)
    if is_first_fetch:
        CSVFeed.feed_main(params, 'MalwareBazaar Feed', 'malwarebazzar')
        set_feed_last_run({'is_first_fetch': False})
    else:  # not first fetch
        JSONFeed.feed_main(params, 'MalwareBazaar Feed', 'malwarebazzar')


if __name__ in ('__main__', '__builtin__', 'builtins'):
    main()
