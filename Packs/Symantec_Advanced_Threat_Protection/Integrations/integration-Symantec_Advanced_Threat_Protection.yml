commonfields:
  id: Symantec Advanced Threat Protection
  version: -1
name: Symantec Advanced Threat Protection
display: Symantec Advanced Threat Protection
category: Endpoint
image: data:image/png;base64,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
description: Advanced protection capabilities from Symantec
detaileddescription: You can generate the client ID and secret by logging into the ATP console and generating a token under Settings->Data Sharing
configuration:
- display: Server URL (i.e. https://host:port)
  name: url
  defaultvalue: ""
  type: 0
  required: true
- display: Client ID as generated in the ATP console
  name: client
  defaultvalue: ""
  type: 9
  required: true
- display: Trust any certificate (not secure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
- display: Incident data source
  name: fetch_incidents_type
  defaultvalue: incidents
  type: 15
  required: false
  options:
  - incidents
  - events
  - incidentevents
- display: Maximum number of events per fetch.
  name: max_fetch
  defaultvalue: "50"
  type: 0
  required: false
- display: Fetch incidents
  defaultvalue: ""
  name: isFetch
  type: 8
  required: false
- display: Incident type
  defaultvalue: ""
  name: incidentType
  type: 13
  required: false
- display: First fetch timestamp (<number> <time unit>, e.g., 12 hours, 7 days). Maximum is 30 days.
  name: first_fetch
  defaultvalue: 7 days
  type: 0
  required: false
- display: Query string for fetch incidents. For example - "updated>='2020-06-06T15:39:55.616Z' and updated<'2020-08-07T00:00:00.000Z' "
  defaultvalue: ""
  name: fetch_incidents_query
  type: 0
  required: false
script:
  script: >
    var serverUrl = params.url.replace(/[\/]+$/, '') + '/';

    var MD5_REGEX = /\b[a-fA-F\d]{32}\b/m;

    var SHA256_REGEX = /\b[a-fA-F\d]{64}\b/m;


    var getAccessToken = function(clientID, secret) {
        var res = http(serverUrl + 'atpapi/oauth2/tokens', {
            Method: 'POST',
            Headers: {
                Accept: ['application/json'],
                'Content-Type': ['application/x-www-form-urlencoded']
            },
            Username: clientID,
            Password: secret,
            Body: 'grant_type=client_credentials&scope=customer'
        }, params.insecure, params.proxy);
        if (res.StatusCode < 200 || res.StatusCode > 299) {
            throw 'Failed to retrieve access token. Request status code: ' + res.StatusCode + ', body: ' + res.Body + ' - ' + JSON.stringify(res);
        }
        try {
            var body = JSON.parse(res.Body);
            return body.access_token;
        } catch (ex) {
            throw 'Error parsing access token body - ' + res.Body + ' - ' + ex;
        }
    };


    var token = getAccessToken(params.client.identifier, params.client.password);


    var doReq = function(method, path, parameters) {
        if (!parameters) {
            parameters = {};
        }
        var result = http(
            serverUrl + 'atpapi/v1/' + path + (method === 'GET' ? encodeToURLQuery(parameters) : ''),
            {
                Headers: {'Content-Type': ['application/json'], 'Accept': ['application/json'], 'Authorization': ['Bearer ' + token]},
                Method: method,
                Body: method == 'POST' ? JSON.stringify(parameters) : ''
            },
            params.insecure,
            params.proxy
        );

        if (result.StatusCode < 200 || result.StatusCode > 299) {
            throw 'Failed to perform request ' + path + ', request status code: ' + result.StatusCode + ', body: ' + result.Body;
        }
        if (result.Body === '') {
            throw 'No content received from path ' + path;
        }
        var obj;
        try {
            obj = JSON.parse(result.Body);
        } catch (ex) {
            throw 'Error parsing reply - ' + result.Body + ' - ' + ex;
        }
        return {body: result.Body, obj: obj, statusCode: result.StatusCode};
    };



    var getAppliances = function() {
        var res = doReq('GET', 'appliances');
        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json,
            HumanReadable: tableToMarkdown('Symantec ATP Appliances', res.obj.appliance_list, ['appliance_id', 'appliance_name', 'software_version',
                'appliance_time', 'role']),
            EntryContext: {ATPAppliance: res.obj.appliance_list}
        };
    };


    var doCommand = function(action, targets) {
        if (action === 'delete_endpoint_file') {
            targets = targets.map(function(t) {
                if (typeof t === 'string') {
                    var parts = t.split(':');
                    if (parts.length !== 2) {
                        throw 'Targets format needs to be hash:endpoint_uid, hash:device_uid';
                    }
                    return {hash: parts[0].trim(), device_uid: parts[1].trim()};
                } else {
                    return t;
                }
            });
        }
        var res = doReq('POST', 'commands', {action: action, targets: targets});
        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json,
            HumanReadable: '## Symantec ATP Command\nID: ' + res.obj.command_id,
            EntryContext: {'ATPCommand(val.ID == obj.ID)': {ID: res.obj.command_id, Action: action}}
        };
    };


    var getCommandState = function(command) {
        var res = doReq('GET', 'commands/' + command);
        var md = '## Symantec ATP Command State\n';
        md += 'Command ID: ' + command + '\n';
        md += 'Action: ' + res.obj.action + '\n\n';
        md += tableToMarkdown('State for target', res.obj.status, ['target', 'state', 'error_code', 'message']);
        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json, HumanReadable: md,
            EntryContext: {'ATPCommand(val.ID == obj.ID)': {ID: res.obj.command_id, Action: res.obj.action, Status: res.obj.status}}
        };
    };


    var doCommandCancel = function(command) {
        var res = doReq('PATCH', 'commands/' + command, [{op: 'replace', path: '/state', value: 3}]);
        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json,
            HumanReadable: tableToMarkdown('Symantec ATP Command Cancel', res.obj),
            EntryContext: {'ATPCommand(val.ID == obj.ID)': {ID: res.obj.command_id, ErrorCode: res.obj.error_code, Message: res.obj.message}}
        };
    };


    var add = function(p, name, val) {
        if (val) {
            p[name] = val;
        }
    };


    var addTime = function(p, name, val) {
        if (val) {
            // This is string time
            if (val.indexOf('-') > 0) {
                p[name] = val;
            } else { // this is milliseonds
                p[name] = new Date(val).toISOString();
            }
        }
    };


    var getEvents = function(query, startTime, endTime, limit, next) {
        var p = {verb: 'query'};
        add(p, 'where', query);
        add(p, 'next', next);
        addTime(p, 'start_time', startTime);
        addTime(p, 'end_time', endTime);
        if (limit) {
            p.limit = parseInt(limit);
        }
        var res = doReq('POST', 'events', p);
        if (!res.obj.result || res.obj.result.length === 0) {
            return 'No events match your criteria';
        }
        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json,
            HumanReadable: tableToMarkdown('Symantec ATP Events', res.obj.result) + '\nTotal: ' + res.obj.total + (res.obj.next ? '\nNext: ' + res.obj.next : ''),
            EntryContext: {'ATPEvents(true)': {Result: res.obj.result, Total: res.obj.total, Next: res.obj.next}}
        };
    };


    var getIncidentEvents = function(query, startTime, endTime, limit, next) {
        var p = {verb: 'query'};
        add(p, 'where', query);
        add(p, 'next', next);
        addTime(p, 'start_time', startTime);
        addTime(p, 'end_time', endTime);
        if (limit) {
            p.limit = parseInt(limit);
        }
        var res = doReq('POST', 'incidentevents', p);
        if (!res.obj.result || res.obj.result.length === 0) {
            return 'No events match your criteria';
        }
        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json,
            HumanReadable: tableToMarkdown('Symantec ATP Incident Events', res.obj.result) + '\nTotal: ' + res.obj.total + (res.obj.next ? '\nNext: ' + res.obj.next : ''),
            EntryContext: {'ATPIncidentEvents(true)': {Result: res.obj.result, Total: res.obj.total, Next: res.obj.next}}
        };
    };


    var getIncidents = function(query, startTime, endTime, limit, next) {
        var p = {verb: 'query'};
        add(p, 'where', query);
        add(p, 'next', next);
        addTime(p, 'start_time', startTime);
        addTime(p, 'end_time', endTime);
        if (limit) {
            p.limit = parseInt(limit);
        }
        var res = doReq('POST', 'incidents', p);
        if (!res.obj.result || res.obj.result.length === 0) {
            return 'No events match your criteria';
        }
        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json,
            HumanReadable: tableToMarkdown('Symantec ATP Incidents', res.obj.result) + '\nTotal: ' + res.obj.total + (res.obj.next ? '\nNext: ' + res.obj.next : ''),
            EntryContext: {'ATPIncidents(true)': {Result: res.obj.result, Total: res.obj.total, Next: res.obj.next}}
        };
    };


    var getFiles = function(hash) {

        if (!MD5_REGEX.test(hash) && !SHA256_REGEX.test(hash)){
            throw 'Invalid hash. Only SHA256 and MD5 are supported.';
        }

        var p = {};
        if (hash.length === 32) { // MD5 hash
            p.hash_type = 'md5';
        }
        var res = doReq('GET', 'files/' + hash, p);

        // If ATP has not seen the file hash before, then the API will return a blank response with HTTP 200 code.
        if(res.body === '{}'){
            return 'ATP has not seen the file ' + hash + ' before';

        }

        return {Type: entryTypes.note, Contents: res.body, ContentsFormat: formats.json,
            HumanReadable: tableToMarkdown('Symantec ATP Files', res.obj.file_list) + '\nTotal: ' + res.obj.total,
            EntryContext: {'File(val.MD5 == obj.MD5 || val.SHA256 == obj.SHA256)': res.obj.file_list.map(function(f) {
                var file = {MD5: f.md5, SHA256: f.sha2, Instances: f.file_instances, Type: f.mime_type, Size: f.size, SignatureCompany: f.signature_company_name,
                    SignatureIssuer: f.signature_issuer, Age: f.file_age, Threat: f.threat_name, Cynic: f.cynic_verdict, TargetedAttack: f.targeted_attack,
                    ReputationBand: f.reputation_band, PrevalenceBand: f.prevalence_band, Health: f.file_health};
                if (f.file_health === 3) {
                    file.properties_to_append = ['Malicious'];
                    file.Malicious = {Vendor: 'Symantec', Description: 'File health: ' + f.file_health};
                }
                return file;
            })}
        };

    };


    var parseOffsetDate = function(offset_str) {
        var range_split = offset_str.trim().split(' ');
        if (range_split.length != 2){
            throw 'date_range must be "number date_range_unit", examples: (2 hours, 4 minutes,6 months, 1 day, etc.)';
        }
        var number = parseInt(range_split[0]);
        var unit = range_split[1].toLowerCase();
        var d = new Date();
        if (unit.indexOf('minute') >= 0) {
            d.setTime(d.getTime() - (number * 60 * 1000));
        } else if (unit.indexOf('hour') >= 0) {
            d.setTime(d.getTime() - (number * 60 * 60 * 1000));
        } else if (unit.indexOf('day') >= 0) {
            d.setTime(d.getTime() - (number * 24 * 60 * 60 * 1000));
        } else if (unit.indexOf('month') >= 0) {
            d.setTime(d.getTime() - (number * 30 * 24 * 60 * 60 * 1000));
        } else if (unit.indexOf('year') >= 0) {
            d.setTime(d.getTime() - (number * 365 * 24 * 60 * 60 * 1000));
        } else {
            throw 'The unit of date_range is invalid. Must be minutes, hours, days, months or years.';
        }
        return d;
    };


    var getIncidentsFromIncidentsResult = function(res, lastRun) {
        var max_timestamp = lastRun;
        incidents = res.map(function(r){
            max_timestamp = Date.parse(r.time) > Date.parse(max_timestamp) ? r.time : max_timestamp;
            return {
                name: r.summary,
                occurred: r.time,
                rawJSON: JSON.stringify(r)
            };
        });
        // Adding a millisecond to the timestamp to avoid conflicts when fetching.
        max_timestamp = new Date(Date.parse(max_timestamp) + 1).toISOString()
        return [max_timestamp, incidents]
    };


    var getIncidentsFromEventsResult = function(res, lastRun) {
        var max_timestamp = lastRun;
        incidents = res.map(function(r){
            max_timestamp = Date.parse(r.device_time) > Date.parse(max_timestamp) ? r.device_time : max_timestamp;
            var name;
            if ('message' in r){
                name = r.message;
            } else if ('uuid' in r){
                name = r.uuid;
            } else {
                name = r.type_id;
            }
            return {
                name: name,
                occurred: r.device_time,
                rawJSON: JSON.stringify(r)
            };
        });
        // Adding a millisecond to the timestamp to avoid conflicts when fetching.
        max_timestamp = new Date(Date.parse(max_timestamp) + 1).toISOString()
        return [max_timestamp, incidents]

    };


    var fetchIncidents = function(type, query, limit, first_fetch_time) {

        if (type != 'incidents' && type != 'incidentevents' && type != 'events'){
            throw 'Unknown incident type.';
        }
        var DAY_IN_MILLIS = 24*60*60*1000;

        var lastRun = getLastRun();
        var now = new Date();
        var endTime = now.toISOString();
        var startTime, currentFetch;
        var next = null;

        if (lastRun && lastRun.time && lastRun.time !== '') {
            startTime = lastRun.time;
            if (lastRun.next && lastRun.next !== '') {
                next = lastRun.next;

                if (lastRun.end_time && lastRun.end_time !== '') {
                    endTime = lastRun.end_time;
                }
            }
        } else if (first_fetch_time) {
            startTime = parseOffsetDate(first_fetch_time).toISOString();
        } else {
            var n = now;
            n.setTime(now.getTime() - 1 * DAY_IN_MILLIS);
            startTime = n.toISOString();
        }
        var p = {verb: 'query'};
        add(p, 'where', query);
        addTime(p, 'start_time', startTime);
        addTime(p, 'end_time', endTime);
        add(p, 'next', next);

        if (limit) {
            p.limit = parseInt(limit);
        }
        var incidents = [];
        var res = doReq('POST', type, p);
        if (res.obj.result && res.obj.result.length !== 0) {
            if (type == 'incidents') {
                var result = getIncidentsFromIncidentsResult(res.obj.result, startTime);
                currentFetch = result[0];
                incidents = incidents.concat(result[1]);
            } else {
                var result = getIncidentsFromEventsResult(res.obj.result, startTime);
                currentFetch = result[0];
                incidents = incidents.concat(result[1]);
            }
        }
        next = 'next' in res.obj ? res.obj.next : null;

        if (next) {
            setLastRun({ time: startTime, next: next, end_time: endTime });
        } else {
            setLastRun({ time: currentFetch ? currentFetch : startTime});
        }
        return JSON.stringify(incidents);
    };


    // The command input arg holds the command sent from the user.

    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            getAppliances();
            return 'ok';
        case 'fetch-incidents':
            return fetchIncidents(params.fetch_incidents_type, params.fetch_incidents_query, params.max_fetch, params.first_fetch);
        case 'satp-appliances':
            return getAppliances();
        case 'satp-command':
            return doCommand(args.action, argToList(args.targets));
        case 'satp-command-state':
            return getCommandState(args.command);
        case 'satp-command-cancel':
            return doCommandCancel(args.command);
        case 'satp-events':
            return getEvents(args.query, args.start_time, args.end_time, args.limit, args.next);
        case 'satp-files':
            return getFiles(args.hash);
        case 'satp-incident-events':
            return getIncidentEvents(args.query, args.start_time, args.end_time, args.limit, args.next);
        case 'satp-incidents':
            return getIncidents(args.query, args.start_time, args.end_time, args.limit, args.next);
        default:
            // Should never come here
            throw 'Unknown command: ' + command;
    }
  type: javascript
  commands:
  - name: satp-appliances
    arguments: []
    outputs:
    - contextPath: ATPAppliance.appliance_id
      description: ID of the ATP appliance
    - contextPath: ATPAppliance.appliance_name
      description: Name of the ATP appliance
    - contextPath: ATPAppliance.software_version
      description: Version of the ATP appliance
    - contextPath: ATPAppliance.appliance_time
      description: Current time on the appliance in UTC
    - contextPath: ATPAppliance.role
      description: The roles of the appliance
    description: Retrieve the appliances configured with the versions
  - name: satp-command
    arguments:
    - name: action
      required: true
      auto: PREDEFINED
      predefined:
      - isolate_endpoint
      - rejoin_endpoint
      - delete_endpoint_file
      description: The action to perform on the endpoints
    - name: targets
      required: true
      description: For isolate and rejoin a list of endpoint ids (array or comma-separated). For delete, array of objects, each with hash and device_uid attributes (supports comma-delimited hash:uid,hash:uid as well).
    outputs:
    - contextPath: ATPCommand.ID
      description: The ID of the executing command
    - contextPath: ATPCommand.Action
      description: The requested action for the command
    description: Issue commands to endpoints managed by Symantec Endpoint Protection
    execution: true
  - name: satp-command-state
    arguments:
    - name: command
      required: true
      default: true
      description: The command ID to retrieve state for
    outputs:
    - contextPath: ATPCommand.ID
      description: The ID of the executing command
    - contextPath: ATPCommand.Action
      description: The requested action for the command
    - contextPath: ATPCommand.Status.target
      description: The target for the state
    - contextPath: ATPCommand.Status.state
      description: The state of the command
    - contextPath: ATPCommand.Status.error_code
      description: Error code for the target
    - contextPath: ATPCommand.Status.message
      description: Message for the target
    description: Retrieve the command state
  - name: satp-command-cancel
    arguments:
    - name: command
      required: true
      default: true
      description: The command ID to cancel
    outputs:
    - contextPath: ATPCommand.ID
      description: The ID of the executing command
    - contextPath: ATPCommand.ErrorCode
      description: Error code for cancelling - 0 if successful
    - contextPath: ATPCommand.Message
      description: Message for the cancellation
    description: Cancel the given command
    execution: true
  - name: satp-events
    arguments:
    - name: query
      description: Specifies a search condition. See full details at https://help.symantec.com/api-doc/atp_2.2/EN_US/#_eventqueryrequest
    - name: start_time
      description: ISO8601 date format - 2017-01-01T00:00:00.000Z. Also accepts milliseconds since epoch.
    - name: end_time
      description: ISO8601 date format - 2017-01-01T00:00:00.000Z. Also accepts milliseconds since epoch.
    - name: limit
      description: Maximum number of events to return. Default is 100 and max is 1000.
      defaultValue: "100"
    - name: next
      description: Used for events cursoring. Retrieve the next batch of events.
    outputs:
    - contextPath: ATPEvents.Total
      description: Total number of results
    - contextPath: ATPEvents.Next
      description: Next batch ID
    - contextPath: ATPEvents.Result.type_id
      description: The unique identifier for an event type.
    - contextPath: ATPEvents.Result.uuid
      description: The unique id for this event
    - contextPath: ATPEvents.Result.message
      description: Human-readable event message or description of the event
    - contextPath: ATPEvents.Result.severity_id
      description: Severity between 1 (info) and 6 (fatal).
    - contextPath: ATPEvents.Result.device_time
      description: The timestamp (in ISO 8601 format) that specifies the time at which the event occurred.
    - contextPath: ATPEvents.Result.device_uid
      description: Unique ID of the device that originated the event.
    - contextPath: ATPEvents.Result.device_name
      description: The device name (i.e., the name of the endpoint or appliance associated with an event).
    - contextPath: ATPEvents.Result.device_ip
      description: The IPv6 or IPv4 address of the device that originated the event.
    - contextPath: ATPEvents.Result.device_type
      description: The type of the device that originated the event.
    - contextPath: ATPEvents.Result.device_os_name
      description: The operating system running on the device_type that originated the event.
    - contextPath: ATPEvents.Result.device_os_ver
      description: The version of the operating system that is running on the device_type that originated the event.
    - contextPath: ATPEvents.Result.user_uid
      description: Unique ID of the user that originated the event or the user on whose behalf the event occurred.
    - contextPath: ATPEvents.Result.user_name
      description: The user name or ID that originated or caused the event.
    - contextPath: ATPEvents.Result.action_id
      description: 'Action taken with respect to the underlying cause of the event. Possible values are: 0 = BLOCK 1 = MONITOR'
    - contextPath: ATPEvents.Result.internal_hostname
      description: The host name of the internal device/machine for the connection
    - contextPath: ATPEvents.Result.scanner_name
      description: The name of the ATP scanner that generated this event
    - contextPath: ATPEvents.Result.internal_ip
      description: The IP address of the internal device/machine for the connection
    - contextPath: ATPEvents.Result.internal_port
      description: The port number identified as the source port in traffic sent to the target device
    - contextPath: ATPEvents.Result.external_ip
      description: The IP address of the device/machine that accepted the connection
    - contextPath: ATPEvents.Result.external_port
      description: The port number identified as the target port in traffic sent to the target device
    - contextPath: ATPEvents.Result.data_source_url
      description: The URL that the traffic came from
    - contextPath: ATPEvents.Result.data_source_url_domain
      description: The domain from which the file was downloaded. The domain is extracted from the URL for the query performance.
    - contextPath: ATPEvents.Result.data_source_url_referer
      description: The referer URL used in the download
    - contextPath: ATPEvents.Result.sep_installed
      description: Indicates whether SEP was installed when the event was generated
    - contextPath: ATPEvents.Result.data_direction
      description: 'The direction of the data source. Possible values are: 1 = Inbound. Traffic flow from WAN to LAN. 2 = Outbound. Traffic flow from LAN to WAN.'
    - contextPath: ATPEvents.Result.network_scanner_type
      description: 'The type of network scanner that detected the event. Possible values are: 0 = ATP-N Scanner (default) 1 = WSS .cloud Scanner'
    - contextPath: ATPEvents.Result.vlan_id
      description: Indicates the VLAN ID (between 0 and 4095) on which the endpoint is deployed. If the value is 0 or missing, the endpoint is deployed in a non-VLAN setup
    - contextPath: ATPEvents.Result.device_end_time
      description: The end time of an event (in format yyyy-MM-dd’T’HH:mm:ss.SSSZ). This is used with the aggregation count field.
    - contextPath: ATPEvents.Result.host_name
      description: The host name of the client computer
    - contextPath: ATPEvents.Result.domain_name
      description: The domain name of the client computer
    - contextPath: ATPEvents.Result.data_source_ip
      description: The source IP address that the file came from (either IPv4 or IPv6).
    - contextPath: ATPEvents.Result.target_ip
      description: The local (victim) IP address (IPv4 or IPv6)
    - contextPath: ATPEvents.Result.target_port
      description: The local (victim) port number
    - contextPath: ATPEvents.Result.source_ip
      description: The remote IP address (IPv4 or IPv6).
    - contextPath: ATPEvents.Result.source_port
      description: The remote port number
    - contextPath: ATPEvents.Result.parent_file_sha2
      description: The SHA256 of the parent file
    - contextPath: ATPEvents.Result.reason
      description: 'This field is overloaded and has following possible interpretations (depending on the corresponding type_id).  For type_id 4118, it specifies the Blacklist hash function that was used to identify the file. This field has following possible values: 0 = BY_FILE_BLACKLIST_SHA2 1 = BY_FILE_BLACKLIST_MD5  For type_id 4112, it specifies the Blacklist criteria that identify the traffic. This field has following possible values: 0 = BY_SOURCE_IP 1 = BY_DEST_IP 2 = BY_DEST_URL'
    - contextPath: ATPEvents.Result.manual_submit
      description: Indicates whether the file was manually submitted for analysis
    - contextPath: ATPEvents.Result.signature_id
      description: The NDC signature ID.
    - contextPath: ATPEvents.Result.signature_name
      description: The name of the signature
    - contextPath: ATPEvents.Result.categories
      description: A list of categories an intrusion event may belong to
    - contextPath: ATPEvents.Result.intrusion_url
      description: The URL from where a malicious script was loaded
    - contextPath: ATPEvents.Result.infected
      description: Indicates whether the customer machine is infected
    - contextPath: ATPEvents.Result.count
      description: Event aggregation count
    - contextPath: ATPEvents.Result.severity
      description: The seriousness of the event. 0 indicates most serious.
    - contextPath: ATPEvents.Result.local_host_mac
      description: The MAC address of the local computer
    - contextPath: ATPEvents.Result.remote_host_mac
      description: The MAC address of the remote computer
    - contextPath: ATPEvents.Result.app_name
      description: The full path of the application involved
    - contextPath: ATPEvents.Result.event_desc
      description: A description of the event. Usually, the first line of the description is treated as summary
    - contextPath: ATPEvents.Result.network_protocol
      description: 'Network protocol as reported by SEP. Possible values are: 1 = Other 2 = TCP 3 = UDP 4 = ICMP'
    - contextPath: ATPEvents.Result.source
      description: This field is overloaded and has possible interpretations (depending on the corresponding type_id).
    - contextPath: ATPEvents.Result.no_of_viruses
      description: The number of events for the aggregated event record. This number can be due to client-side aggregation, server-side compression, or both
    - contextPath: ATPEvents.Result.actual_action_idx
      description: This is the ID of action taken on the risk
    - contextPath: ATPEvents.Result.actual_action
      description: This is the string version of the action taken on the risk (in actual_action_idx).
    - contextPath: ATPEvents.Result.virus_name
      description: Name of the virus
    - contextPath: ATPEvents.Result.virus_def
      description: The virus definition version number
    - contextPath: ATPEvents.Result.agent_version
      description: The version of the client software
    - contextPath: ATPEvents.Result.MessageId
      description: The unique ID of the email message
    - contextPath: ATPEvents.Result.OrigMessageHeaderId
      description: The message header ID
    - contextPath: ATPEvents.Result.EmailReceivedDate
      description: 'The time when the mail transfer agent received the email. The format is: yyyy-MM-dd’T’HH:mm:ss.SSSZ'
    - contextPath: ATPEvents.Result.EmailSubject
      description: Email subject
    - contextPath: ATPEvents.Result.EmailAction
      description: 'The action executed on the email. Possible values are: - blocked - delivered - released'
    - contextPath: ATPEvents.Result.Direction
      description: 'Indication direction of the email. Possible values are: 0 = Outbound 1 = Inbound'
    - contextPath: ATPEvents.Result.incident
      description: The unique ID of the incident that is related to this event
    - contextPath: ATPEvents.Result.event_id
      description: The event ID as reported by Symantec Endpoint Protection security log
    - contextPath: ATPEvents.Result.file
      description: The file object
    - contextPath: ATPEvents.Result.threat
      description: The threat object
    - contextPath: ATPEvents.Result.av
      description: The AV object
    - contextPath: ATPEvents.Result.cynic
      description: Cynic object
    - contextPath: ATPEvents.Result.scan
      description: Scan object
    - contextPath: ATPEvents.Result.bash
      description: Bash object
    - contextPath: ATPEvents.Result.Sender
      description: Email sender object
    - contextPath: ATPEvents.Result.Receivers
      description: Email receivers array of objects
    - contextPath: ATPEvents.Result.intrusion
      description: Intrusion object
    description: Accepts search requests over a specified time range and returns events that match the search condition. You must specify the time range using the start_time parameter and the end_time parameter (the maximum time range is 7 days). The time in the result schema and is typically the event creation time. This API supports search conditions (such as logical operators and special characters) to narrow the events to be retrieved. See examples at https://help.symantec.com/api-doc/atp_2.2/EN_US/#_events_query_api_example.
  - name: satp-files
    description: Retrieve details about file based on given hash
    arguments:
    - name: hash
      required: true
      description: Hash of the file. Supports either SHA256 or MD5.
    outputs:
    - contextPath: File.MD5
      description: File MD5
    - contextPath: File.SHA256
      description: File SHA256
    - contextPath: File.Instances.name
      description: Name of file
    - contextPath: File.Instances.path
      description: Path of file
    - contextPath: File.Type
      description: MIME type of the file
    - contextPath: File.Size
      description: Size of file in bytes
    - contextPath: File.SignatureCompany
      description: The company that signed the file
    - contextPath: File.SignatureIssuer
      description: The signature issuer
    - contextPath: File.Age
      description: 'A code between 1 and 4 representing the file’s global age defined by the time the file was first reported to Symantec. This data is collected from telemetry sent to Symantec by in-field endpoint clients like Symantec Endpoint Protection and Norton. Possible values are: 1 = Years ago 2 = Months ago 3 = Weeks ago 4 = Days ago'
    - contextPath: File.Threat
      description: Name of the threat if the file is determined to be a malware
    - contextPath: File.Cynic
      description: 'A code between 0 and 2 representing the verdict given by Symantec’s Cynic sandbox analysis. Possible values are: 0 = Malware 1 = Good 2 = Unknown'
    - contextPath: File.TargetedAttack
      description: A flag that indicates whether this file is a part of targeted attack launched against an organization
    - contextPath: File.ReputationBand
      description: 'A code between 1 and 6 representing the file’s reputation. This data is generated by Symantec’s analysis engines based on the telemetry sent to Symantec by in-field endpoint clients like Symantec Endpoint Protection and Norton. Possible values are: 1 = Symantec-trusted 2 = Good 3 = Trending Good 4 = Unproven 5 = Poor 6 = Untrusted'
    - contextPath: File.PrevalenceBand
      description: 'A code between 1 and 8 representing the file’s prevalence. This data is collected from telemetry sent to Symantec by in-field endpoint clients like Symantec Endpoint Protection and Norton. Possible values are: 1 = Fewer than 5 users 2 = Fewer than 50 users 3 = Fewer than 100 users 4 = Hundreds of users 5 = Thousands of users 6 = Tens of thousands of users 7 = Hundreds of thousands of users 8 = Millions of users'
    - contextPath: File.Health
      description: 'A code between 0 and 3 representing the file’s health. Possible values are: 0 = Good 1 = Neutral 2 = Suspicious 3 = Bad 4 = Analyzing'
  - name: satp-incident-events
    arguments:
    - name: query
      description: Specifies a search condition.
    - name: start_time
      description: ISO8601 date format - 2017-01-01T00:00:00.000Z. Also accepts milliseconds since epoch.
    - name: end_time
      description: ISO8601 date format - 2017-01-01T00:00:00.000Z. Also accepts milliseconds since epoch.
    - name: limit
      description: Maximum number of events to return. Default is 20 and max is 1000.
      defaultValue: "20"
    - name: next
      description: Used for events cursoring. Retrieve the next batch of events.
    outputs:
    - contextPath: ATPIncidentEvents.Total
      description: Total number of results
    - contextPath: ATPIncidentEvents.Next
      description: Next batch ID
    - contextPath: ATPIncidentEvents.Result.type_id
      description: The unique identifier for an event type.
    - contextPath: ATPIncidentEvents.Result.uuid
      description: The unique id for this event
    - contextPath: ATPIncidentEvents.Result.message
      description: Human-readable event message or description of the event
    - contextPath: ATPIncidentEvents.Result.severity_id
      description: Severity between 1 (info) and 6 (fatal).
    - contextPath: ATPIncidentEvents.Result.device_time
      description: The timestamp (in ISO 8601 format) that specifies the time at which the event occurred.
    - contextPath: ATPIncidentEvents.Result.device_uid
      description: Unique ID of the device that originated the event.
    - contextPath: ATPIncidentEvents.Result.device_name
      description: The device name (i.e., the name of the endpoint or appliance associated with an event).
    - contextPath: ATPIncidentEvents.Result.device_ip
      description: The IPv6 or IPv4 address of the device that originated the event.
    - contextPath: ATPIncidentEvents.Result.device_type
      description: The type of the device that originated the event.
    - contextPath: ATPIncidentEvents.Result.device_os_name
      description: The operating system running on the device_type that originated the event.
    - contextPath: ATPIncidentEvents.Result.device_os_ver
      description: The version of the operating system that is running on the device_type that originated the event.
    - contextPath: ATPIncidentEvents.Result.user_uid
      description: Unique ID of the user that originated the event or the user on whose behalf the event occurred.
    - contextPath: ATPIncidentEvents.Result.user_name
      description: The user name or ID that originated or caused the event.
    - contextPath: ATPIncidentEvents.Result.action_id
      description: 'Action taken with respect to the underlying cause of the event. Possible values are: 0 = BLOCK 1 = MONITOR'
    - contextPath: ATPIncidentEvents.Result.internal_hostname
      description: The host name of the internal device/machine for the connection
    - contextPath: ATPIncidentEvents.Result.scanner_name
      description: The name of the ATP scanner that generated this event
    - contextPath: ATPIncidentEvents.Result.internal_ip
      description: The IP address of the internal device/machine for the connection
    - contextPath: ATPIncidentEvents.Result.internal_port
      description: The port number identified as the source port in traffic sent to the target device
    - contextPath: ATPIncidentEvents.Result.external_ip
      description: The IP address of the device/machine that accepted the connection
    - contextPath: ATPIncidentEvents.Result.external_port
      description: The port number identified as the target port in traffic sent to the target device
    - contextPath: ATPIncidentEvents.Result.data_source_url
      description: The URL that the traffic came from
    - contextPath: ATPIncidentEvents.Result.data_source_url_domain
      description: The domain from which the file was downloaded. The domain is extracted from the URL for the query performance.
    - contextPath: ATPIncidentEvents.Result.data_source_url_referer
      description: The referer URL used in the download
    - contextPath: ATPIncidentEvents.Result.sep_installed
      description: Indicates whether SEP was installed when the event was generated
    - contextPath: ATPIncidentEvents.Result.data_direction
      description: 'The direction of the data source. Possible values are: 1 = Inbound. Traffic flow from WAN to LAN. 2 = Outbound. Traffic flow from LAN to WAN.'
    - contextPath: ATPIncidentEvents.Result.network_scanner_type
      description: 'The type of network scanner that detected the event. Possible values are: 0 = ATP-N Scanner (default) 1 = WSS .cloud Scanner'
    - contextPath: ATPIncidentEvents.Result.vlan_id
      description: Indicates the VLAN ID (between 0 and 4095) on which the endpoint is deployed. If the value is 0 or missing, the endpoint is deployed in a non-VLAN setup
    - contextPath: ATPIncidentEvents.Result.device_end_time
      description: The end time of an event (in format yyyy-MM-dd’T’HH:mm:ss.SSSZ). This is used with the aggregation count field.
    - contextPath: ATPIncidentEvents.Result.host_name
      description: The host name of the client computer
    - contextPath: ATPIncidentEvents.Result.domain_name
      description: The domain name of the client computer
    - contextPath: ATPIncidentEvents.Result.data_source_ip
      description: The source IP address that the file came from (either IPv4 or IPv6).
    - contextPath: ATPIncidentEvents.Result.target_ip
      description: The local (victim) IP address (IPv4 or IPv6)
    - contextPath: ATPIncidentEvents.Result.target_port
      description: The local (victim) port number
    - contextPath: ATPIncidentEvents.Result.source_ip
      description: The remote IP address (IPv4 or IPv6).
    - contextPath: ATPIncidentEvents.Result.source_port
      description: The remote port number
    - contextPath: ATPIncidentEvents.Result.parent_file_sha2
      description: The SHA256 of the parent file
    - contextPath: ATPIncidentEvents.Result.reason
      description: 'This field is overloaded and has following possible interpretations (depending on the corresponding type_id).  For type_id 4118, it specifies the Blacklist hash function that was used to identify the file. This field has following possible values: 0 = BY_FILE_BLACKLIST_SHA2 1 = BY_FILE_BLACKLIST_MD5  For type_id 4112, it specifies the Blacklist criteria that identify the traffic. This field has following possible values: 0 = BY_SOURCE_IP 1 = BY_DEST_IP 2 = BY_DEST_URL'
    - contextPath: ATPIncidentEvents.Result.manual_submit
      description: Indicates whether the file was manually submitted for analysis
    - contextPath: ATPIncidentEvents.Result.signature_id
      description: The NDC signature ID.
    - contextPath: ATPIncidentEvents.Result.signature_name
      description: The name of the signature
    - contextPath: ATPIncidentEvents.Result.categories
      description: A list of categories an intrusion event may belong to
    - contextPath: ATPIncidentEvents.Result.intrusion_url
      description: The URL from where a malicious script was loaded
    - contextPath: ATPIncidentEvents.Result.infected
      description: Indicates whether the customer machine is infected
    - contextPath: ATPIncidentEvents.Result.count
      description: Event aggregation count
    - contextPath: ATPIncidentEvents.Result.severity
      description: The seriousness of the event. 0 indicates most serious.
    - contextPath: ATPIncidentEvents.Result.local_host_mac
      description: The MAC address of the local computer
    - contextPath: ATPIncidentEvents.Result.remote_host_mac
      description: The MAC address of the remote computer
    - contextPath: ATPIncidentEvents.Result.app_name
      description: The full path of the application involved
    - contextPath: ATPIncidentEvents.Result.event_desc
      description: A description of the event. Usually, the first line of the description is treated as summary
    - contextPath: ATPIncidentEvents.Result.network_protocol
      description: 'Network protocol as reported by SEP. Possible values are: 1 = Other 2 = TCP 3 = UDP 4 = ICMP'
    - contextPath: ATPIncidentEvents.Result.source
      description: This field is overloaded and has possible interpretations (depending on the corresponding type_id).
    - contextPath: ATPIncidentEvents.Result.no_of_viruses
      description: The number of events for the aggregated event record. This number can be due to client-side aggregation, server-side compression, or both
    - contextPath: ATPIncidentEvents.Result.actual_action_idx
      description: This is the ID of action taken on the risk
    - contextPath: ATPIncidentEvents.Result.actual_action
      description: This is the string version of the action taken on the risk (in actual_action_idx).
    - contextPath: ATPIncidentEvents.Result.virus_name
      description: Name of the virus
    - contextPath: ATPIncidentEvents.Result.virus_def
      description: The virus definition version number
    - contextPath: ATPIncidentEvents.Result.agent_version
      description: The version of the client software
    - contextPath: ATPIncidentEvents.Result.MessageId
      description: The unique ID of the email message
    - contextPath: ATPIncidentEvents.Result.OrigMessageHeaderId
      description: The message header ID
    - contextPath: ATPIncidentEvents.Result.EmailReceivedDate
      description: 'The time when the mail transfer agent received the email. The format is: yyyy-MM-dd’T’HH:mm:ss.SSSZ'
    - contextPath: ATPIncidentEvents.Result.EmailSubject
      description: Email subject
    - contextPath: ATPIncidentEvents.Result.EmailAction
      description: 'The action executed on the email. Possible values are: - blocked - delivered - released'
    - contextPath: ATPIncidentEvents.Result.Direction
      description: 'Indication direction of the email. Possible values are: 0 = Outbound 1 = Inbound'
    - contextPath: ATPIncidentEvents.Result.incident
      description: The unique ID of the incident that is related to this event
    - contextPath: ATPIncidentEvents.Result.event_id
      description: The event ID as reported by Symantec Endpoint Protection security log
    - contextPath: ATPIncidentEvents.Result.file
      description: The file object
    - contextPath: ATPIncidentEvents.Result.threat
      description: The threat object
    - contextPath: ATPIncidentEvents.Result.av
      description: The AV object
    - contextPath: ATPIncidentEvents.Result.cynic
      description: Cynic object
    - contextPath: ATPIncidentEvents.Result.scan
      description: Scan object
    - contextPath: ATPIncidentEvents.Result.bash
      description: Bash object
    - contextPath: ATPIncidentEvents.Result.Sender
      description: Email sender object
    - contextPath: ATPIncidentEvents.Result.Receivers
      description: Email receivers array of objects
    - contextPath: ATPIncidentEvents.Result.intrusion
      description: Intrusion object
    description: Get events that are related to incidents
  - name: satp-incidents
    arguments:
    - name: query
      description: Specifies a search condition.
    - name: start_time
      description: ISO8601 date format - 2017-01-01T00:00:00.000Z. Also accepts milliseconds since epoch.
    - name: end_time
      description: ISO8601 date format - 2017-01-01T00:00:00.000Z. Also accepts milliseconds since epoch.
    - name: limit
      description: Maximum number of events to return. Default is 20 and max is 1000.
      defaultValue: "20"
    - name: next
      description: Used for events cursoring. Retrieve the next batch of events.
    outputs:
    - contextPath: ATPIncidents.Result.atp_incident_id
      description: A unique identifier for this incident
    - contextPath: ATPIncidents.Result.priority_level
      description: Priority level of the incident. 1 = LOW, 2 = MED, 3 = HIGH
    - contextPath: ATPIncidents.Result.state
      description: The state of the incident. 1 = OPEN,2 = WAITING,3 = IN_WORK,4 = CLOSED
    - contextPath: ATPIncidents.Result.recommended_action
      description: Recommended action for this incident
    - contextPath: ATPIncidents.Result.first_event_seen
      description: When the first event associated with the incident was created
    - contextPath: ATPIncidents.Result.last_event_seen
      description: When the last event associated with the incident was created
    - contextPath: ATPIncidents.Result.event_count
      description: The number of events associated with the incident
    - contextPath: ATPIncidents.Result.device_time
      description: The timestamp that specifies the time at which the event occurred
    - contextPath: ATPIncidents.Result.deviceUid
      description: A list of ATP endpoint devices UID on which the events occurred
    - contextPath: ATPIncidents.Result.scanners
      description: A list of ATP scanners that discovered the threat
    - contextPath: ATPIncidents.Result.filehash
      description: A list of SHA256 hashes associated with this incident
    - contextPath: ATPIncidents.Result.domainid
      description: A list of domains associated with this incident
    - contextPath: ATPIncidents.Result.summary
      description: Summary information about the incident
    - contextPath: ATPIncidents.Result.time
      description: The creation time (in ISO 8601 format) of the incident
    - contextPath: ATPIncidents.Result.updated
      description: The time (in ISO 8601 format) of last modification
    - contextPath: ATPIncidents.Result.log_name
      description: The index/type of the originating event
    - contextPath: ATPIncidents.Result.uuid
      description: The GUID assigned for this incident
    description: Query incidents from ATP
  isfetch: true
  runonce: false
  isFetchSamples: true
fromversion: 5.0.0
