import demistomock as demisto
from CommonServerPython import *  # noqa # pylint: disable=unused-wildcard-import
from CommonServerUserPython import *  # noqa

import requests
import traceback
from typing import Dict, Any, Tuple, Callable

requests.packages.urllib3.disable_warnings()  # pylint: disable=no-member


''' CONSTANTS '''

DATE_FORMAT = '%Y-%m-%dT%H:%M:%SZ'  # ISO8601 format with UTC, default in XSOAR

API_SUFFIX = '/api/2.0/fo/'

commands_data: Dict[str, Dict[Any, Any]] = {
    'qualys-report-list': {'collection_name': 'REPORT_LIST',
                           'context_prefix': 'Qualys.Report', 'context_key': 'ID', 'table_name': 'Report List',
                           'args': ['id', 'state', 'user_login', 'expires_before_datetime', 'client_id',
                                    'client_name'],
                           'api_route': API_SUFFIX + '/report/?action=list', 'call_method': 'GET', 'resp_type': 'text',
                           'json_path': "REPORT_LIST_OUTPUT.RESPONSE"},
    'qualys-ip-list': {'collection_name': 'IP_SET',
                       'context_prefix': 'Qualys.IP', 'context_key': 'IP',
                       'table_name': 'IP List',
                       'args': ['ips', 'network_id', 'tracking_method', 'compliance_enabled'],
                       'api_route': API_SUFFIX + '/asset/ip/?action=list', 'call_method': 'GET', 'resp_type': 'text',
                       'json_path': "IP_LIST_OUTPUT.RESPONSE", 'new_names_dict': {'IP': 'Address',
                                                                                  'IP_RANGE': 'Range'}},
    'qualys-vm-scan-list': {'collection_name': 'SCAN_LIST',
                            'context_prefix': 'Qualys.Scan', 'context_key': 'REF', 'table_name': 'Scan List',
                            'args': ['scan_ref', 'state', 'processed', 'type', 'target', 'user_login',
                                     'launched_after_datetime', 'launched_before_datetime', 'show_ags', 'show_op',
                                     'show_status', 'show_last', 'scan_id', 'client_id', 'client_name', 'pci_only',
                                     'ignore_target'], 'api_route': API_SUFFIX + '/scan/?action=list',
                            'call_method': 'GET', 'resp_type': 'text', 'json_path': "SCAN_LIST_OUTPUT.RESPONSE"},
    'qualys-scap-scan-list': {'collection_name': 'SCAN_LIST',
                              'context_prefix': 'Qualys.SCAP.Scan', 'context_key': 'ID',
                              'table_name': 'Scap Scan List', 'args': ['scan_id', 'scan_ref', 'state', 'processed',
                                                                       'type', 'target', 'user_login',
                                                                       'launched_after_datetime',
                                                                       'launched_before_datetime', 'show_ags',
                                                                       'show_op', 'show_status', 'show_last'],
                              'api_route': API_SUFFIX + '/scan/scap/?action=list', 'call_method': 'GET',
                              'resp_type': 'text', 'json_path': "SCAN_LIST_OUTPUT.RESPONSE"},
    'qualys-pc-scan-list': {'collection_name': 'SCAN_LIST',
                            'context_prefix': 'Qualys.Scan', 'context_key': 'ID',
                            'table_name': 'PC Scan List', 'args': ['scan_id', 'scan_ref', 'state', 'processed',
                                                                   'type', 'target', 'user_login',
                                                                   'launched_after_datetime',
                                                                   'launched_before_datetime', 'show_ags', 'show_op',
                                                                   'show_status', 'show_last', 'client_id',
                                                                   'client_name'],
                            'api_route': API_SUFFIX + '/scan/compliance/?action=list', 'call_method': 'POST',
                            'resp_type': 'text', 'json_path': "SCAN_LIST_OUTPUT.RESPONSE"},
    'qualys-schedule-scan-list': {'collection_name': 'SCHEDULE_SCAN_LIST',
                                  'context_prefix': 'Qualys.Scan', 'context_key': 'ID',
                                  'table_name': 'Schedule Scan List', 'args': ['id', 'active', 'show_notifications',
                                                                               'scan_type', 'fqdn',
                                                                               'show_cloud_details', 'client_id',
                                                                               'client_name', 'show_cloud_details'],
                                  'api_route': API_SUFFIX + '/schedule/scan/?action=list', 'call_method': 'GET',
                                  'resp_type': 'text', 'json_path': "SCHEDULE_SCAN_LIST_OUTPUT.RESPONSE"},
    'qualys-ip-restricted-list': {'collection_name': '',
                                  'context_prefix': 'Qualys.Restricted', 'context_key': 'DATETIME',
                                  'table_name': 'Restricted IPs', 'args': [],
                                  'api_route': API_SUFFIX + '/setup/restricted_ips/?action=list&output_format=xml',
                                  'call_method': 'GET', 'resp_type': 'text',
                                  'json_path': "RESTRICTED_IPS_OUTPUT.RESPONSE"},
    'qualys-ip-restricted-manage': {'collection_name': '', 'context_prefix': 'Qualys.Restricted.Manage',
                                    'context_key': 'DATETIME', 'table_name': 'Restricted IPs',
                                    'args': ['action', 'enable', 'ips'],
                                    'api_route': API_SUFFIX + '/setup/restricted_ips/', 'call_method': 'POST',
                                    'resp_type': 'text', 'json_path': "SIMPLE_RETURN.RESPONSE"},
    'qualys-host-list': {'collection_name': 'HOST_LIST',
                         'context_prefix': 'Qualys.Endpoint', 'context_key': 'ID', 'table_name': 'Host List',
                         'args': ['os_pattern', 'truncation_limit', 'ips', 'ag_titles', 'ids',
                                  'network_ids', 'no_vm_scan_since', 'vm_scan_since', 'no_compliance_scan_since',
                                  'use_tags', 'tag_set_by', 'tag_include_selector', 'tag_exclude_selector',
                                  'tag_set_include', 'tag_set_exclude', 'show_tags', 'host_metadata',
                                  'host_metadata_fields', 'show_cloud_tags', 'cloud_tag_fields'],
                         'api_route': API_SUFFIX + '/asset/host/?action=list',
                         'call_method': 'POST', 'resp_type': 'text', 'json_path': "HOST_LIST_OUTPUT.RESPONSE"},
    'qualys-virtual-host-list': {'collection_name': 'VIRTUAL_HOST_LIST',
                                 'context_prefix': 'Qualys.VirtualEndpoint', 'context_key': 'IP',
                                 'table_name': 'Virtual Host List', 'args': ['port', 'ip'],
                                 'api_route': API_SUFFIX + '/asset/vhost/?action=list', 'call_method': 'GET',
                                 'resp_type': 'text', 'json_path': "VIRTUAL_HOST_LIST_OUTPUT.RESPONSE"},
    'qualys-host-excluded-list': {'collection_name': 'IP_SET',
                                  'context_prefix': 'Qualys.Excluded.Host', 'context_key': 'Host',
                                  'table_name': 'Excluded Host List', 'args': ['ips', 'network_id', 'ag_ids',
                                                                               'ag_titles', 'use_tags',
                                                                               'tag_include_selector',
                                                                               'tag_exclude_selector', 'tag_set_by',
                                                                               'tag_set_include', 'tag_set_exclude'],
                                  'api_route': API_SUFFIX + '/asset/excluded_ip/?action=list', 'call_method': 'GET',
                                  'resp_type': 'text', 'json_path': "IP_LIST_OUTPUT.RESPONSE",
                                  'new_names_dict': {'IP': 'Address', 'IP_RANGE': 'Range'}},
    'qualys-scheduled-report-list': {'collection_name': 'SCHEDULE_REPORT_LIST',
                                     'context_prefix': 'Qualys.Report', 'context_key': 'ID',
                                     'table_name': 'Scheduled Report List', 'args': ['id', 'is_active'],
                                     'api_route': API_SUFFIX + '/schedule/report/?action=list', 'call_method': 'GET',
                                     'resp_type': 'text', 'json_path': "SCHEDULE_REPORT_LIST_OUTPUT.RESPONSE"},
    'qualys-report-template-list': {'collection_name': 'REPORT_TEMPLATE',
                                    'context_prefix': 'Qualys.ReportTemplate',
                                    'context_key': 'ID', 'table_name': 'Template Report List', 'args': [],
                                    'api_route': '/msp/report_template_list.php', 'call_method': 'GET',
                                    'resp_type': 'text', 'json_path': "REPORT_TEMPLATE_LIST.REPORT_TEMPLATE"},
    'qualys-vulnerability-list': {'collection_name': 'VULN_LIST',
                                  'context_prefix': 'Qualys.Vulnerability.List', 'context_key': 'QID',
                                  'table_name': 'Scheduled Report List', 'args': ['details', 'ids', 'id_min', 'id_max',
                                                                                  'is_patchable', 'last_modified_after',
                                                                                  'last_modified_before',
                                                                                  'last_modified_by_user_after',
                                                                                  'last_modified_by_user_before',
                                                                                  'last_modified_by_service_after',
                                                                                  'last_modified_by_service_before',
                                                                                  'published_after', 'published_before',
                                                                                  'discovery_method',
                                                                                  'discovery_auth_types',
                                                                                  'show_pci_reasons',
                                                                                  'show_supported_modules_info',
                                                                                  'show_disabled_flag',
                                                                                  'show_qid_change_log'],
                                  'api_route': API_SUFFIX + '/knowledge_base/vuln/?action=list', 'call_method': 'POST',
                                  'resp_type': 'text', 'json_path': "KNOWLEDGE_BASE_VULN_LIST_OUTPUT.RESPONSE"},
    'qualys-group-list': {'collection_name': 'ASSET_GROUP_LIST',
                          'context_prefix': 'Qualys.AssetGroup', 'context_key': 'ID', 'table_name': 'Group List',
                          'args': ['output_format', 'ids', 'id_min', 'id_max', 'truncation_limit', 'network_ids',
                                   'unit_id', 'user_id', 'title', 'show_attributes'],
                          'api_route': API_SUFFIX + '/asset/group/?action=list',
                          'call_method': 'POST', 'resp_type': 'text', 'table_headers':
                              ['APPLIANCE_IDS', 'DEFAULT_APPLIANCE_ID', 'ID', 'IP_SET', 'TITLE'],
                          'json_path': "ASSET_GROUP_LIST_OUTPUT.RESPONSE"},
    'qualys-report-fetch': {'args': ['id'], 'api_route': API_SUFFIX + '/report/?action=fetch', 'call_method': 'POST',
                            'resp_type': 'content', 'file_prefix': 'report',
                            'file_id': 'id'},
    'qualys-vm-scan-fetch': {'context_prefix': 'Qualys.VM', 'context_key': 'QID',
                             'args': ['scan_ref', 'ips', 'mode', 'client_id', 'client_name'],
                             'api_route': API_SUFFIX + 'scan/?action=fetch&output_format=json',
                             'call_method': 'GET', 'resp_type': 'text', 'file_prefix': 'vm_scan', 'file_id': 'scan_ref',
                             'json_path': '', 'table_name': 'VM Scan Fetch',
                             'new_names_dict': {'dns': 'Dns', 'instance': 'Instance', 'ip': 'IP', 'netbios': 'Netbios',
                                                'qid': 'QID', 'result': 'Result'}},
    'qualys-pc-scan-fetch': {'args': ['scan_ref'], 'api_route': API_SUFFIX + 'scan/compliance/?action=fetch',
                             'call_method': 'GET', 'resp_type': 'text',
                             'json_path': "COMPLIANCE_SCAN_RESULT_OUTPUT.RESPONSE.COMPLIANCE_SCAN.HEADER.KEY",
                             'table_name': 'Policy Compliance Scan', 'context_prefix': 'Qualys.PC',
                             'context_key': 'TITLE'},
    'qualys-report-cancel': {'args': ['id'], 'context_prefix': 'Qualys.Report',
                             'context_key': 'ID', 'api_route': API_SUFFIX + 'report/?action=cancel',
                             'call_method': 'POST', 'resp_type': 'text',
                             'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST.ITEM", 'table_name': 'Canceled report'},
    'qualys-report-delete': {'context_prefix': 'Qualys.Report', 'context_key': 'ID',
                             'args': ['id'], 'api_route': API_SUFFIX + 'report/?action=delete',
                             'call_method': 'POST', 'resp_type': 'text',
                             'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST.ITEM", 'table_name': 'Deleted report',
                             'table_headers': ['Deleted', 'ID']},
    'qualys-scorecard-launch': {'context_prefix': 'Qualys.Report',
                                'context_key': 'ID',
                                'args': ['name', 'report_title', 'output_format', 'hide_header', 'pdf_password',
                                         'recipient_group', 'recipient_group_id', 'source', 'asset_groups',
                                         'all_asset_groups', 'business_unit', 'division', 'function', 'location',
                                         'patch_qids', 'missing_qids'],
                                'api_route': API_SUFFIX + '/report/scorecard/?action=launch', 'call_method': 'POST',
                                'resp_type': 'text', 'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST.ITEM",
                                'table_name': 'New scorecard launched'},
    'qualys-vm-scan-launch': {'collection_name': 'ITEM_LIST', 'context_prefix': 'Qualys.Report.VM.Launched',
                              'context_key': 'KEY', 'args': ['scan_title', 'target_from', 'ip', 'asset_groups',
                                                             'asset_group_ids', 'exclude_ip_per_scan',
                                                             'tag_include_selector', 'tag_exclude_selector',
                                                             'tag_set_by', 'tag_set_include', 'tag_set_exclude',
                                                             'use_ip_nt_range_tags_include',
                                                             'use_ip_nt_range_tags_exclude', 'use_ip_nt_range_tags',
                                                             'iscanner_id', 'iscanner_name', 'default_scanner',
                                                             'scanners_in_ag', 'scanners_in_tagset',
                                                             'scanners_in_network', 'option_title', 'option_id',
                                                             'priority', 'connector_name', 'ec2_endpoint',
                                                             'ec2_instance_ids', 'ip_network_id', 'runtime_http_header',
                                                             'scan_type', 'fqdn', 'client_id', 'client_name',
                                                             'include_agent_targets'],
                              'api_route': API_SUFFIX + '/scan/?action=launch', 'call_method': 'POST',
                              'resp_type': 'text', 'json_path': "SIMPLE_RETURN.RESPONSE",
                              'table_name': 'New Vulnerability Scan launched'},
    'qualys-vm-scan-action': {'context_prefix': '', 'context_key': 'ID', 'args': ['action', 'scan_ref'],
                              'api_route': API_SUFFIX + '/scan/', 'call_method': 'POST', 'resp_type': 'text',
                              'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST.ITEM",
                              'output_texts': {'delete': 'Deleting scan', 'pause': 'Pausing scan',
                                               'resume': 'Resuming scan', 'cancel': 'Canceling scan'}},
    'qualys-pc-scan-launch': {'collection_name': 'ITEM', 'context_prefix': 'Qualys.Scan', 'context_key': 'ID',
                              'args': ['scan_title', 'option_id', 'option_title', 'ip', 'asset_group_ids',
                                       'asset_groups', 'runtime_http_header', 'exclude_ip_per_scan',
                                       'default_scanner', 'scanners_in_ag', 'target_from', 'tag_include_selector',
                                       'tag_exclude_selector', 'tag_set_by', 'tag_set_include', 'tag_set_exclude',
                                       'use_ip_nt_range_tags', 'ip_network_id', 'iscanner_name'],
                              'api_route': API_SUFFIX + '/scan/compliance/?action=launch', 'call_method': 'POST',
                              'resp_type': 'text', 'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST",
                              'table_name': 'New PC Scan launched'},
    'qualys-pc-scan-manage': {'context_prefix': 'Qualys.Scan', 'context_key': 'scan_ref',
                              'args': ['action', 'scan_ref'],
                              'api_route': API_SUFFIX + '/scan/compliance/?action=launch', 'call_method': 'POST',
                              'resp_type': 'text', 'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST.ITEM",
                              'table_name': 'PC Scan'},
    'qualys-ip-add': {'context_prefix': 'Qualys.IP.Add', 'context_key': 'IP', 'args': ['ips', 'tracking_method',
                                                                                       'enable_vm', 'enable_pc',
                                                                                       'owner', 'ud1', 'ud2', 'ud3',
                                                                                       'comment', 'ag_title'],
                      'api_route': API_SUFFIX + '/asset/ip/?action=add', 'call_method': 'POST', 'resp_type': 'text',
                      'json_path': "SIMPLE_RETURN.RESPONSE", 'table_name': 'IP Added'},
    'qualys-ip-update': {'context_prefix': 'Qualys.IP.Update', 'context_key': 'IP', 'args': ['ips', 'network_id',
                                                                                             'tracking_method',
                                                                                             'host_dns',
                                                                                             'host_netbios', 'owner',
                                                                                             'ud1', 'ud2', 'ud3',
                                                                                             'comment'],
                         'api_route': API_SUFFIX + '/asset/ip/?action=update', 'call_method': 'POST',
                         'resp_type': 'text', 'json_path': "SIMPLE_RETURN.RESPONSE", 'table_name': 'IP updated'},
    'qualys-host-excluded-manage': {'context_prefix': 'Qualys.Endpoint',
                                    'context_key': 'KEY', 'args': ['action', 'ips', 'expiry_days', 'dg_names',
                                                                   'comment', 'network_id'],
                                    'api_route': API_SUFFIX + '/asset/excluded_ip/',
                                    'call_method': 'POST', 'resp_type': 'text',
                                    'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST.ITEM",
                                    'table_name': 'Manage Excluded Hosts'},
    'qualys-scheduled-report-launch': {'context_prefix': 'Qualys.Report', 'context_key': 'ID', 'args': ['id'],
                                       'api_route': API_SUFFIX + '/schedule/report/?action=launch_now',
                                       'call_method': 'POST', 'resp_type': 'text',
                                       'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST.ITEM",
                                       'table_name': 'Launch Scheduled Report'},
    'qualys-report-launch-map': {'context_prefix': 'Qualys.Report', 'context_key': 'ID',
                                 'args': ['domain', 'ip_restriction', 'report_refs', 'template_id', 'report_title',
                                          'output_format', 'hide_header', 'pdf_password', 'recipient_group',
                                          'recipient_group_id'],
                                 'api_route': API_SUFFIX + '/report/?action=launch&report_type=Map',
                                 'call_method': 'POST', 'resp_type': 'text',
                                 'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST.ITEM",
                                 'table_name': ' New report launched'},
    'qualys-report-launch-scan-based-findings': {'context_prefix': 'Qualys.Report', 'context_key': 'ID',
                                                 'args': ['template_id', 'report_title', 'output_format',
                                                          'hide_header', 'recipient_group_id', 'pdf_password',
                                                          'recipient_group', 'ip_restriction', 'report_refs'],
                                                 'api_route': API_SUFFIX + '/report/?action=launch&report_type=Scan',
                                                 'call_method': 'POST', 'resp_type': 'text',
                                                 'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST.ITEM",
                                                 'table_name': 'Scan Based Findings Report Launch'},
    'qualys-report-launch-host-based-findings': {'context_prefix': 'Qualys.Report', 'context_key': 'ID',
                                                 'args': ['template_id', 'report_title', 'output_format',
                                                          'hide_header', 'recipient_group_id', 'pdf_password',
                                                          'recipient_group', 'ips', 'asset_group_ids',
                                                          'ips_network_id'],

                                                 'api_route': API_SUFFIX + '/report/?action=launch&report_type=Scan',
                                                 'call_method': 'POST', 'resp_type': 'text',
                                                 'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST.ITEM",
                                                 'table_name': 'Host Based Findings Report Launch'},
    'qualys-report-launch-patch': {'context_prefix': 'Qualys.Report', 'context_key': 'ID',
                                   'args': ['template_id', 'report_title', 'output_format',
                                            'hide_header', 'recipient_group_id', 'pdf_password',
                                            'recipient_group', 'ips', 'asset_group_ids'],
                                   'api_route': API_SUFFIX + '/report/?action=launch&report_type=Patch',
                                   'call_method': 'POST', 'resp_type': 'text',
                                   'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST.ITEM",
                                   'table_name': 'Patch Report Launch'},
    'qualys-report-launch-remediation': {'context_prefix': 'Qualys.Report', 'context_key': 'ID',
                                         'args': ['template_id', 'report_title', 'output_format',
                                                  'hide_header', 'recipient_group_id', 'pdf_password',
                                                  'recipient_group', 'ips', 'asset_group_ids', 'asignee_type'],
                                         'api_route': API_SUFFIX + '/report/?action=launch&report_type=Remediation',
                                         'call_method': 'POST', 'resp_type': 'text',
                                         'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST.ITEM",
                                         'table_name': 'Remediation Report Launch'},
    'qualys-report-launch-compliance': {'context_prefix': 'Qualys.Report', 'context_key': 'ID',
                                        'args': ['template_id', 'report_title', 'output_format',
                                                 'hide_header', 'recipient_group_id', 'pdf_password',
                                                 'recipient_group', 'ips', 'asset_group_ids', 'report_refs'],
                                        'api_route': API_SUFFIX + 'report/?action=launch&report_type=Compliance',
                                        'call_method': 'POST', 'resp_type': 'text',
                                        'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST.ITEM",
                                        'table_name': 'Compliance Report Launch'},
    'qualys-report-launch-compliance-policy': {'context_prefix': 'Qualys.Report', 'context_key': 'ID',
                                               'args': ['template_id', 'report_title', 'output_format',
                                                        'hide_header', 'recipient_group_id', 'pdf_password',
                                                        'recipient_group', 'ips', 'asset_group_ids', 'policy_id',
                                                        'host_id', 'instance_string'],
                                               'api_route': API_SUFFIX + '/report/?action=launch&report_type=Policy',
                                               'call_method': 'POST', 'resp_type': 'text',
                                               'json_path': "SIMPLE_RETURN.RESPONSE.ITEM_LIST.ITEM",
                                               'table_name': 'Policy Report Launch'},
    'qualys-virtual-host-manage': {'context_prefix': 'Qualys.VirtualEndpoint', 'context_key': 'DATETIME',
                                   'args': ['action', 'ip', 'network_id', 'port', 'fqdn'],
                                   'api_route': API_SUFFIX + 'asset/vhost/', 'call_method': 'POST', 'resp_type': 'text',
                                   'json_path': "SIMPLE_RETURN.RESPONSE", 'table_name': ''},
    'test-module': {'api_route': API_SUFFIX + '/scan/?action=list', 'call_method': 'POST', 'resp_type': 'text'},
    'args_values': {}
}


''' CLIENT CLASS '''


class Client(BaseClient):

    def __init__(self, base_url, username, password, verify=True, proxy=False,
                 ok_codes=tuple(), headers=None):
        super().__init__(base_url, verify, proxy, ok_codes, headers, auth=(username, password))

    def command_http_request(self, command_data: Dict) -> requests.Response:
        """
        Make a http request to Qualys API
        Args:
            command_data: Dictionary with information about the command requested
        Returns:
            response from Qualys API
        Raises:
            DemistoException: can be raised by the _http_requeset function
        """
        return self._http_request(
            method=command_data['call_method'],
            url_suffix=command_data['api_route'],
            params=commands_data['args_values'],
            resp_type=command_data['resp_type'],
            timeout=60)


''' HELPER FUNCTIONS '''


def json_get_path(json_obj: Dict[str, Any], path_str: str) -> Dict[str, Any]:
    """
    This function takes a path and gets the object at the specified path in the dictionary
    Args:
        json_obj: Dictionary
        path_str: String of nested keys '.' separated, making a path
    Returns:
            Dict: dictionary nested inside the original dictionary or the original dict
    Raises:
        KeyError: raised if a bad or incorrect path was provided or bad json object
        TypeError: raised if json_obj is not a dictionary
    """
    if len(path_str) == 0:
        return json_obj
    path_keys_list_path = path_str.split(".")
    current_json_obj = json_obj
    for key in path_keys_list_path:
        current_json_obj = current_json_obj[key]
    return current_json_obj


def create_ip_list_dicts(res_json: Dict[str, Any]) -> List[Dict[str, str]]:
    """
    Creates separate dictionaries of addresses and ranges
    Args:
        res_json: Dictionary received from ip list command with 'Address' and 'Range' keys
    Returns:
        List with address dictionary and ranges of addresses dictionary
    Raises:
        DemistoException: dictionary doesn't have any of the expected keys
        TypeError: res_json is not a dictionary
    """
    address_dict = {}
    range_dict = {}
    output_list = []

    if 'Address' in res_json:
        addresses = res_json['Address']
        if isinstance(addresses, str):
            address_dict = {'0': addresses}
        else:
            for index, address in enumerate(addresses):
                address_dict[str(index)] = address
        output_list.append(address_dict)

    if 'Range' in res_json:
        ranges = res_json['Range']
        if isinstance(ranges, str):
            range_dict = {'0': ranges}
        else:
            for index, ip_range in enumerate(ranges):
                range_dict[str(index)] = ip_range
        output_list.append(range_dict)

    if len(output_list) == 0:
        raise DemistoException("IP list command is missing keys")

    return output_list


def generate_list_dicts(asset_dict: Dict[str, Any]) -> List[Any]:
    """
        This function takes a dictionary with a specific structure of a single key containing
        a list of dictionaries and returns the list of dictionaries
    Args:
        asset_dict: Dictionary that contains a single asset type returned from the API
    Returns:
        A list of assets of the asset type requested
    """
    return asset_dict[list(asset_dict.keys())[0]]


def build_args_dict(args: Dict[str, str], command_name: str) -> None:
    """
    Takes the arguments needed by the command that were received by the user
    and stores them in the general commands data dictionary
    Args:
        args: Dictionary of arguments received by the user
        command_name: The name of the command requested
    Returns:
        None
    """
    args_dict = {}
    command_args = commands_data[command_name]['args']

    for arg in command_args:
        args_dict[arg] = args.get(arg)
    commands_data['args_values'] = args_dict


def is_empty_result(json_response: Dict[str, Any]) -> bool:
    """
    Checking whether the response object contains no object or only timestamp object,
    both are considered an empty result, otherwise it's not empty
    Args:
        json_response: Dictionary received by the request to the API

    Returns: True if the dictionary is empty, otherwise return False
    """
    if not json_response or \
            len(json_response) == 0 or\
            len(json_response) == 1 and json_response.get('DATETIME'):
        return True
    return False


''' PARSERS '''


def change_dict_keys(new_names_dict: Dict[str, str], output_dict: Dict[str, Any]) -> Dict[str, Any]:
    """
    Takes a dictionary and changes the names of the keys
    Args:
        new_names_dict: a dictionary with the old names as keys and their new names as their values
        output_dict: Dictionary with string keys
    Returns:
        Same dictionary but with keys with the new names or the same dictionary if the old keys don't exist
    Raises:
        TypeError: output_dict is not a dictionary
    """
    for key in new_names_dict:
        new_name = new_names_dict[key]
        if key in output_dict:
            output_dict[new_name] = output_dict[key]
            del output_dict[key]
    return output_dict


def change_list_dicts_names(command_data: Dict[str, Any], output: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """
    Changing keys names of a list of dicts
    Args:
        command_data: data about the command
        output: list of dictionaries. all the dictionaries must have the same keys
    Returns:
        Same list but with dicts that have keys with the new names
    Raises:
        KeyError: can be raised by change_dict_keys
        TypeError: can be raised by change_dict_keys
    """
    new_names_dict = command_data['new_names_dict']

    for item in output:
        change_dict_keys(new_names_dict, item)
    return output


def parse_two_keys_dict(json_res: Dict[str, Any]) -> Dict[str, Any]:
    """
    Takes a dictionary in a specific format creates a new dictionary
    Args:
        json_res: Dictionary with two keys 'VALUE' and 'KEY'

    Returns: new dictionary with the 'KEY' value being the key and the value of the
             new key being the value of the key 'VALUE'
    Raises:
            KeyError: json_res doesn't have the expected keys
            TypeError: json_res is not a dictionary
    """
    res = {json_res['KEY']: json_res['VALUE']}
    return res


def parse_key_value_pairs_list(multiple_key_list: List[Dict[str, Any]]) -> Dict[str, Any]:
    """
    Creates a single dictionary from a list of dictionaries
    Args:
        multiple_key_list: List of dictionaries where each dictionary has the keys @value and #text
    Returns:
        A single dictionary where the keys are the '@value's and the values are the '#text's
    """
    parsed_dict = {}
    for obj in multiple_key_list:
        parsed_dict[obj['@value']] = obj['#text']
    return parsed_dict


def parse_and_validate_response(response: requests.Response) -> Dict[str, Any]:
    """
    first tries to load the response as json if possible, if not will
    try to convert from xml to json, then it validates the response
    Args:
        response: Response received from Qualys API
    Returns:
        Dict: if response can be parsed and valid will return the parsed dictionary
        None: If response cant be parsed to json it will return None
    Raises:
        DemistoException: if the response has an error code
    """
    try:
        raw_response = json.loads(str(response))
    except Exception:
        try:
            raw_response = json.loads(xml2json(response))
        except Exception:
            return {}
    simple_response = None
    if raw_response and isinstance(raw_response, dict):
        simple_response = raw_response.get('SIMPLE_RETURN', {}).get('RESPONSE', None)
    if simple_response and simple_response.get('CODE'):
        raise DemistoException("\n" + simple_response.get('TEXT') + "\nCode: " + simple_response.get('CODE'))
    return raw_response


''' HANDLERS '''


def handle_general_result(**kwargs) -> CommandResults:
    """
    Handles commands that don't return files, parses, validates and finally returns a commandResults.
    Args:
        **kwargs:
                result (requests.Response): the raw result received from Qualys API command
                output_builder (Callable): a function that creates output in a specific format
                command_name (str): name of the command to handle
    Returns:
        CommandResults with data generated for the result given
    Raises:
        DemistoException: can be raised by parse_and_validate_response for bad input
    """
    raw_response = kwargs['result']
    output_builder = kwargs['output_builder']
    command_name = kwargs['command_name']

    command_data = commands_data[command_name]
    json_response = json_get_path(parse_and_validate_response(raw_response), command_data['json_path'])
    if is_empty_result(json_response):
        return CommandResults(raw_response=raw_response, readable_output="No items found")

    outputs, readable_output = output_builder(json_response=json_response,
                                              command_data=command_data,
                                              command_name=command_name)
    return CommandResults(
        outputs_prefix=command_data['context_prefix'],
        outputs_key_field=command_data['context_key'],
        outputs=outputs,
        raw_response=raw_response,
        readable_output=readable_output)


def handle_fetch_result(**kwargs) -> dict:
    """
    Handles fetch file commands
    Args:
        **kwargs:
                result (requests.Response): response received from qualys
    Returns:
        A Demisto war room entry
    """
    result = kwargs['result']
    command_name = kwargs['command_name']
    command_data = commands_data[command_name]

    parse_and_validate_response(result)
    file_id = commands_data['args_values'][command_data['file_id']]
    file_name = command_data['file_prefix'] + "_" + file_id + ".pdf"
    file_type = entryTypes['entryInfoFile']
    entry = fileResult(file_name, result, file_type)

    return entry


''' OUTPUT BUILDERS '''


def build_one_value_parsed_output(**kwargs) -> Tuple[Dict[str, Any], str]:
    """
    creates a dictionary with a single key for command_results outputs field
    and a markdown table with a single value
    Args:
        **kwargs:
                command_data (Dict): contains information about the command that was executed
                json_response (Dict): response received from Qualys API
    Returns:
        Tuple containing a dictionary with a single key and a markdown table string
    Raises:
        KeyError: will be raised by parse_two_keys_dict if response has unexpected keys
        TypeError: will be raised by  parse_two_keys_dict response is not a dictionary
    """
    command_data = kwargs['command_data']
    response = kwargs['json_response']
    single_val_dict = parse_two_keys_dict(response)
    readable_output = tableToMarkdown(name=command_data['table_name'], t=single_val_dict)
    return single_val_dict, readable_output


def build_single_text_output(**kwargs) -> Tuple[Dict[str, Any], str]:
    """
    creates output with the dictionary returned from the request and the text attached to it
    Args:
        **kwargs:
                json_response (Dict): response received from Qualys API
    Returns:
            Tuple containing a dictionary and the text returned in the response
    """
    output = kwargs['json_response']
    readable_output = output['TEXT']
    return output, readable_output


def build_unparsed_output(**kwargs) -> Tuple[Dict[str, Any], str]:
    """
    creates output with the dictionary returned from the request and a markdown table generated
    from the unparsed response received
    Args:
        **kwargs:
                json_response (Dict): response received from Qualys API
                command_data (Dict): data about a specific command from the general commands_data dict
    Returns:
            Tuple containing a dictionary and a markdown table generated from the response
    """
    command_data = kwargs['command_data']
    unparsed_output = kwargs['json_response']
    readable_output = tableToMarkdown(name=command_data['table_name'], t=unparsed_output)
    return unparsed_output, readable_output


def build_ip_list_output(**kwargs) -> Tuple[Dict[str, List[str]], str]:
    """
    creates output with a new dictionary parsed from the original response and two markdown tables generated
    for the ip-list command
    Args:
        **kwargs:
                json_response (Dict): response received from Qualys API
                command_data (Dict): data about a specific command from the general commands_data dict
    Returns:
            Tuple containing a dictionary created and a markdown table generated from the response
    Raises:
            KeyError: can be raised by either change_dict_keys or create_ip_list_dicts
            TypeError: can be raised by either change_dict_keys or create_ip_list_dicts
    """
    command_data = kwargs['command_data']
    json_response = kwargs['json_response']
    asset_collection = json_response[command_data['collection_name']]

    parsed_output = change_dict_keys(command_data['new_names_dict'], asset_collection)
    list_of_fields = create_ip_list_dicts(parsed_output)
    readable_output = ""
    for field in list_of_fields:
        readable_output += tableToMarkdown(name=command_data['table_name'], t=field)

    return parsed_output, readable_output


def build_multiple_values_parsed_output(**kwargs) -> Tuple[List[Any], str]:
    """
    When the response from Qualys has a list of dictionaries this function will get this list and
    will generate a markdown table from it
    Args:
        **kwargs:
                json_response (Dict): response received from Qualys API
                command_data (Dict): data about a specific command from the general commands_data dict
    Returns:
            Tuple containing a List of dictionaries parsed from the original response and a markdown table
            generated from the parsed response
    """
    command_data = kwargs['command_data']
    json_response = kwargs['json_response']
    asset_collection = json_response[command_data['collection_name']]

    headers = command_data.get('table_headers') if command_data.get('table_headers') else None
    parsed_output = generate_list_dicts(asset_collection)
    readable_output = tableToMarkdown(name=command_data['table_name'], t=parsed_output,
                                      headers=headers)
    return parsed_output, readable_output


def build_output_and_change_names(**kwargs) -> Tuple[List[Any], str]:
    """
    Takes the output and changes the output fields names as described in the command data
    Args:
        **kwargs:
                json_response (Dict): response received from Qualys API
                command_data (Dict): data about a specific command from the general commands_data dict
    Returns:
            Tuple containing a dictionary and a markdown table generated from the response
    """
    command_data = kwargs['command_data']
    output = kwargs['json_response']

    output = change_list_dicts_names(command_data, output)
    readable_output = tableToMarkdown(name=command_data['table_name'], t=output)

    return output, readable_output


def build_multiple_text_options_output(**kwargs) -> Tuple[None, str]:
    """
    When there's no need to build output from the response but output text is based on command's action requsted
    this function will take the text based on the action and will return it
    Args:
        **kwargs:
                command_data (Dict): data about a specific command from the general commands_data dict
    Returns:
            Tuple containing a List of dictionaries parsed from the original response and a markdown table
            generated from the parsed response
    """
    command_data = kwargs['command_data']
    action = commands_data['args_values']['action']

    readable_output = command_data['output_texts'][action]

    return None, readable_output


def build_key_value_pairs_parsed_output(**kwargs) -> Tuple[Dict[str, Any], str]:
    """
    A command might have multiple key value pairs, where the name of the key is an attribute of <KEY> element
    this builder will create an output of those keys
    Args:
        **kwargs:
                json_response (Dict): response received from Qualys API
                command_data (Dict): data about a specific command from the general commands_data dict
    Returns:
        Tuple containing a dictionary created from those key-value pairs and a markdown table as a string
    """
    command_data = kwargs['command_data']
    output = kwargs['json_response']

    parsed_output = parse_key_value_pairs_list(output)
    readable_output = tableToMarkdown(name=command_data['table_name'], t=parsed_output)

    return parsed_output, readable_output


''' COMMAND FUNCTIONS '''


def test_module(client: Client) -> str:
    """
    This function makes a http request to qualys API in order to test the connection
    Args:
        client: Client object for making a http request
    Returns:
        'ok' message if the connection test was successful
    Raises:
        DemistoException: will be raised when connection was not successful by command_http_request
    """
    commands_data['args_values'] = {}
    client.command_http_request(commands_data['test-module'])
    return 'ok'


def qualys_command(client: Client,
                   args: Dict[str, str],
                   command_name: str,
                   command_methods: Dict[str, Callable]) -> Optional[CommandResults]:
    """
    A general function to run any qualys command
    Args:
        client: Client object for making a http request
        args: Dictionary of the arguments entered by the user for the command
        command_name: string of the command name
        command_methods: Dictionary of handler and output builder of the specific command
    Returns:
        Results received by the command or None if it's a file download
    Raises:
        DemistoException: will be raised when request to Qualys API failed
    """
    build_args_dict(args, command_name)
    result = client.command_http_request(commands_data[command_name])
    return command_methods['result_handler'](result=result,
                                             command_name=command_name,
                                             output_builder=command_methods['output_builder'])


''' MAIN FUNCTION '''


def main():
    params = demisto.params()

    base_url = params['url']
    verify_certificate = not params.get('insecure', False)
    proxy = params.get('proxy', False)
    username = params.get('credentials').get('identifier')
    password = params.get('credentials').get('password')

    commands_methods: Dict[Dict[str, Callable]] = {
        'qualys-report-list': {'result_handler': handle_general_result,
                               'output_builder': build_multiple_values_parsed_output},
        'qualys-report-cancel': {'result_handler': handle_general_result,
                                 'output_builder': build_one_value_parsed_output},
        'qualys-report-delete': {'result_handler': handle_general_result,
                                 'output_builder': build_one_value_parsed_output},
        'qualys-scorecard-launch': {'result_handler': handle_general_result,
                                    'output_builder': build_one_value_parsed_output},
        'qualys-report-fetch': {'result_handler': handle_fetch_result,
                                'output_builder': None},
        'qualys-vm-scan-list': {'result_handler': handle_general_result,
                                'output_builder': build_multiple_values_parsed_output},
        'qualys-vm-scan-launch': {'result_handler': handle_general_result,
                                  'output_builder': build_multiple_values_parsed_output},
        'qualys-vm-scan-action': {'result_handler': handle_general_result,
                                  'output_builder': build_multiple_text_options_output},
        'qualys-vm-scan-fetch': {'result_handler': handle_general_result,
                                 'output_builder': build_output_and_change_names},
        'qualys-scap-scan-list': {'result_handler': handle_general_result,
                                  'output_builder': build_multiple_values_parsed_output},
        'qualys-pc-scan-list': {'result_handler': handle_general_result,
                                'output_builder': build_multiple_values_parsed_output},
        'qualys-pc-scan-launch': {'result_handler': handle_general_result,
                                  'output_builder': build_unparsed_output},
        'qualys-pc-scan-manage': {'result_handler': handle_general_result,
                                  'output_builder': build_one_value_parsed_output},
        'qualys-pc-scan-fetch': {'result_handler': handle_general_result,
                                 'output_builder': build_key_value_pairs_parsed_output},
        'qualys-schedule-scan-list': {'result_handler': handle_general_result,
                                      'output_builder': build_multiple_values_parsed_output},
        'qualys-ip-restricted-list': {'result_handler': handle_general_result,
                                      'output_builder': build_unparsed_output},
        'qualys-ip-restricted-manage': {'result_handler': handle_general_result,
                                        'output_builder': build_single_text_output},
        'qualys-ip-list': {'result_handler': handle_general_result,
                           'output_builder': build_ip_list_output},
        'qualys-ip-add': {'result_handler': handle_general_result,
                          'output_builder': build_single_text_output},
        'qualys-ip-update': {'result_handler': handle_general_result,
                             'output_builder': build_single_text_output},
        'qualys-host-list': {'result_handler': handle_general_result,
                             'output_builder': build_multiple_values_parsed_output},
        'qualys-virtual-host-list': {'result_handler': handle_general_result,
                                     'output_builder': build_multiple_values_parsed_output},
        'qualys-virtual-host-manage': {'result_handler': handle_general_result,
                                       'output_builder': build_unparsed_output},
        'qualys-host-excluded-list': {'result_handler': handle_general_result,
                                      'output_builder': build_ip_list_output},
        'qualys-host-excluded-manage': {'result_handler': handle_general_result,
                                        'output_builder': build_unparsed_output},
        'qualys-scheduled-report-list': {'result_handler': handle_general_result,
                                         'output_builder': build_multiple_values_parsed_output},
        'qualys-scheduled-report-launch': {'result_handler': handle_general_result,
                                           'output_builder': build_one_value_parsed_output},
        'qualys-report-template-list': {'result_handler': handle_general_result,
                                        'output_builder': build_unparsed_output},
        'qualys-report-launch-map': {'result_handler': handle_general_result,
                                     'output_builder': build_one_value_parsed_output},
        'qualys-report-launch-scan-based-findings': {'result_handler': handle_general_result,
                                                     'output_builder': build_one_value_parsed_output},
        'qualys-report-launch-host-based-findings': {'result_handler': handle_general_result,
                                                     'output_builder': build_one_value_parsed_output},
        'qualys-report-launch-patch': {'result_handler': handle_general_result,
                                       'output_builder': build_one_value_parsed_output},
        'qualys-report-launch-remediation': {'result_handler': handle_general_result,
                                             'output_builder': build_one_value_parsed_output},
        'qualys-report-launch-compliance': {'result_handler': handle_general_result,
                                            'output_builder': build_one_value_parsed_output},
        'qualys-report-launch-compliance-policy': {'result_handler': handle_general_result,
                                                   'output_builder': build_one_value_parsed_output},
        'qualys-vulnerability-list': {'result_handler': handle_general_result,
                                      'output_builder': build_multiple_values_parsed_output},
        'qualys-group-list': {'result_handler': handle_general_result,
                              'output_builder': build_multiple_values_parsed_output},
    }

    requested_command = demisto.command()

    demisto.debug(f'Command being called is {demisto.command()}')
    try:
        headers: Dict = {"X-Requested-With": "Demisto"}

        client = Client(
            base_url=base_url,
            username=username,
            password=password,
            verify=verify_certificate,
            headers=headers,
            proxy=proxy)

        if requested_command == 'test-module':
            text_res = test_module(client)
            return_results(text_res)
        else:
            return_results(qualys_command(client,
                                          demisto.args(),
                                          requested_command,
                                          commands_methods[requested_command]))

    except Exception as e:
        demisto.error(traceback.format_exc())  # print the traceback
        return_error(f'Failed to execute {demisto.command()} command.\nError:\n{str(e)}')


if __name__ in ('__main__', '__builtin__', 'builtins'):
    main()
