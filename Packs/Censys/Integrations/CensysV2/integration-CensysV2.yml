category: Data Enrichment & Threat Intelligence
commonfields:
  id: CensysV2
  version: -1
configuration:
- display: App ID
  name: credentials
  required: true
  type: 9
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
description: Censys is a search engine that allows computer scientists to ask questions about the devices and networks that compose the Internet. Driven by Internet-wide scanning, Censys lets researchers find specific hosts and create aggregate reports on how devices, websites, and certificates are configured and deployed.
display: CensysV2
name: CensysV2
script:
  commands:
  - arguments:
    - auto: PREDEFINED
      default: false
      description: The index from which to retrieve data.
      isArray: false
      name: index
      predefined:
      - Ipv4
      - certificates
      required: true
      secret: false
    - default: false
      description: The IP Address of the requested host or the SHA-256 fingerprint of the requested certificate.
      isArray: false
      name: query
      required: true
      secret: false
    deprecated: false
    description: Returns host information for the specified IP address or structured certificate data for the specified SHA-256
    execution: false
    name: censys-view
    outputs:
    - contextPath: BaseIntegration.Output
      description: '[Enter a description of the data returned in this output.]'
      type: String
  - arguments:
    - default: false
      description: Query used to search for hosts with matching attributes. Uses the Censys Search Language.
      isArray: false
      name: query
      required: true
      secret: false
    - default: false
      defaultValue: '50'
      description: The maximum number of hits to return in each response (minimum of 0, maximum of 100). Default is 50.
      isArray: false
      name: page_size
      required: false
      secret: false
    - default: false
      defaultValue: '50'
      description: The number of results to return. Default is 50.
      isArray: false
      name: limit
      required: false
      secret: false
    deprecated: false
    description: Returns previews of hosts matching a specified search query.
    execution: false
    name: censys-hosts-search
  - arguments:
    - default: false
      description: Query used to search for certificates with matching attributes. Uses the Censys Search Language.
      isArray: false
      name: query
      required: true
      secret: false
    - default: false
      defaultValue: '1'
      description: The page tp return, Default is 1
      isArray: false
      name: page
      required: false
      secret: false
    - default: false
      description: The fields to return.
      isArray: true
      name: Fields
      required: false
      secret: false
    - default: false
      defaultValue: '50'
      description: The number of results to return. Default is 50.
      isArray: false
      name: limit
      required: false
      secret: false
    deprecated: false
    description: Retruns a list of certificates that match the given query.
    execution: false
    name: censys-certificates-search
  dockerimage: demisto/python3:3.9.7.24076
  feed: false
  isfetch: false
  longRunning: false
  longRunningPort: false
  runonce: false
  script: >2




    import requests

    import traceback

    from typing import Dict, Any


    # Disable insecure warnings

    requests.packages.urllib3.disable_warnings()  # pylint: disable=no-member



    ''' CLIENT CLASS '''



    class Client(BaseClient):

        def censys_view_request(self, index: str, query: str):
            if index == 'Ipv4':
                url_suffix = f'v2/hosts/{query}'
            else:
                url_suffix = f'v1/view/certificates/{query}'
            res = self._http_request('GET', url_suffix)
            return res

        def censys_search_ip_request(self, query: Dict, page_size: int):
            url_suffix = f'v2/hosts/search'
            params = {
                'q': query,
                'per_page': page_size
            }

            res = self._http_request('GET', url_suffix, params=params)
            return res

        def search_pagination(self, query, page_size, cursor):
            url_suffix = f'v2/hosts/search'
            params = {
                'q': query,
                'per_page': page_size,
                'cursor': cursor
            }

            res = self._http_request('GET', url_suffix, params=params)
            return res

        def censys_search_certs_request(self, data):
            url_suffix = 'v1/search/certificates'
            res = self._http_request('POST', url_suffix, json_data=data)
            return res


    ''' COMMAND FUNCTIONS '''



    def test_module(client: Client) -> str:
        res = client.censys_view_request('Ipv4', '8.8.8.8')
        if res:
            return 'ok'


    def censys_view_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """
        Returns host information for the specified IP address or structured certificate data for the specified SHA-256
        """

        index = args.get('index')
        query = args.get('query')

        res = client.censys_view_request(index, query)
        if index == 'Ipv4':
            result = res.get('result', {})
            content = {
                'Name': result.get('autonomous_system', {}).get('name'),
                'Bgp Prefix': result.get('autonomous_system', {}).get('bgp_prefix'),
                'ASN': result.get('autonomous_system', {}).get('asn'),
                'Service': [{
                    'Port': service.get('port'),
                    'Service Name': service.get('service_name')
                } for service in result.get('services', [])],
                'Last Updated': result.get('last_updated_at')
            }

            human_readable = tableToMarkdown(f'Information for IP {query}', content)
            return CommandResults(
                readable_output=human_readable,
                outputs_prefix='Censys.View',
                outputs_key_field='ip',
                outputs=result,
                raw_response=res
            )

        else:
            metadata = res.get('metadata')
            content = {
                'SHA 256': res.get('fingerprint_sha256'),
                'Tags': res.get('tags'),
                'Source': metadata.get('source'),
                'Added': metadata.get('added_at'),
                'Updated': metadata.get('updated_at')
            }

            human_readable = tableToMarkdown(f'Information for certificate ', content)
            return CommandResults(
                readable_output=human_readable,
                outputs_prefix='Censys.View',
                outputs_key_field='fingerprint_sha256',
                outputs=res
            )


    def censys_search_hosts_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        query = args.get('query')
        page_size = args.get('page_size', 50)
        limit = int(args.get('limit'))
        contents = []

        res = client.censys_search_ip_request(query, page_size)
        hits = res.get('result', {}).get('hits', [])
        while len(hits) < limit:
            next_page = res.get('links', {}).get('next')
            response = client.search_pagination(query, page_size, next_page)
            response_hits = response.get('result', {}).get('hits', [])
            hits.extend(response_hits)

        for hit in hits[:limit]:
            contents.append({
                'IP': hit.get('ip'),
                'Services': hit.get('services'),
                'Location Country code': hit.get('location', {}).get('country_code'),
                'Registered Country Code': hit.get('location', {}).get('registered_country_code'),
                'ASN': hit.get('autonomous_system', {}).get('asn'),
                'Description': hit.get('autonomous_system', {}).get('description'),
                'Name': hit.get('autonomous_system', {}).get('name')
            })
        headers = ['IP', 'Name', 'Description', 'ASN', 'Location Country code', 'Registered Country Code', 'Services']
        human_readable = tableToMarkdown(f'Search results for query "{query}"', contents, headers)
        return CommandResults(
            readable_output=human_readable,
            outputs_prefix='Censys.HostSearch',
            outputs_key_field='ip',
            outputs=hits[:limit],
            raw_response=res
        )


    def censys_search_certs_command(client: Client, args: Dict[str, Any]):
        limit = int(args.get('limit', 50))
        query = args.get('query')
        fields = ["parsed.fingerprint_sha256", "parsed.subject_dn", "parsed.issuer_dn", "parsed.issuer.organization",
                  "parsed.validity.start", "parsed.validity.end", "parsed.names"]
        search_fields = argToList(args.get('fields'))
        if search_fields:
            fields.append(search_fields)
        contents = []
        data = {
            'query': query,
            'page': int(args.get('page', 1)),
            'fields': fields,
            'flatten': False
        }

        res = client.censys_search_certs_request(data)
        results = res.get('results')[:limit]
        for result in results:
            contents.append({
                'SHA256': result.get('parsed').get('fingerprint_sha256'),
                'Issuer dn': result.get('parsed').get('issuer_dn'),
                'Subject dn': result.get('parsed').get('subject_dn'),
                'Names': result.get('parsed').get('names'),
                'Validity': result.get('parsed').get('validity'),
                'Issuer': result.get('parsed').get('issuer'),
            })

        human_readable = tableToMarkdown(f'Search results for query "{query}"', contents)
        return CommandResults(
            readable_output=human_readable,
            outputs_prefix='Censys.CertificateSearch',
            outputs_key_field='fingerprint_sha256',
            outputs=results,
            raw_response=res
        )


    ''' MAIN FUNCTION '''



    def main() -> None:
        params = demisto.params()
        username = params.get('credentials', {}).get('identifier')
        password = params.get('credentials', {}).get('password')
        verify_certificate = not demisto.params().get('insecure', False)
        proxy = demisto.params().get('proxy', False)

        base_url = 'https://search.censys.io/api/'

        demisto.debug(f'Command being called is {demisto.command()}')
        try:
            headers: Dict = {'Content-Type': 'application/json'}

            client = Client(
                base_url=base_url,
                auth=(username, password),
                verify=verify_certificate,
                headers=headers,
                proxy=proxy)

            if demisto.command() == 'test-module':
                # This is the call made when pressing the integration Test button.
                result = test_module(client)
                return_results(result)

            elif demisto.command() == 'censys-view':
                return_results(censys_view_command(client, demisto.args()))
            elif demisto.command() == 'censys-hosts-search':
                return_results(censys_search_hosts_command(client, demisto.args()))
            elif demisto.command() == 'censys-certificates-search':
                return_results(censys_search_certs_command(client, demisto.args()))

        # Log exceptions and return errors
        except Exception as e:
            demisto.error(traceback.format_exc())  # print the traceback
            return_error(f'Failed to execute {demisto.command()} command.\nError:\n{str(e)}')


    ''' ENTRY POINT '''



    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()
  subtype: python3
  type: python
tests:
- No tests (auto formatted)
fromversion: 6.0.0
image: data:image/png;base64,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
detaileddescription: '[View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/censys-v2)'
