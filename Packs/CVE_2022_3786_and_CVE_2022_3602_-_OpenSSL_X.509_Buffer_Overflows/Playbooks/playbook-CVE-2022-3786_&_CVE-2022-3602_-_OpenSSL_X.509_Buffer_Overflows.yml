id: CVE-2022-3786 & CVE-2022-3602 - OpenSSL X.509 Buffer Overflows
version: -1
name: CVE-2022-3786 & CVE-2022-3602 - OpenSSL X.509 Buffer Overflows
description: "On November 1, OpenSSL released a [security advisory](https://www.openssl.org/news/secadv/20221101.txt) describing two high severity vulnerabilities within the OpenSSL library, CVE-2022-3786 and CVE-2022-3602. OpenSSL versions from 3.0.0 - 3.0.6 are vulnerable, with 3.0.7 containing the patch for both vulnerabilities. OpenSSL 1.1.1 and 1.0.2 are not affected by this issue.\n\nThe vulnerability described in CVE-2022-3602 allows an attacker to obtain a 4-byte overflow on the stack by crafting a malicious email address within the attacker-controlled certificate. The overflow will result in a crash (most likely scenario) or potentially remote code execution (much less likely). In CVE-2022-3786, an attacker can achieve a stack overflow of arbitrary length by crafting a malicious email address within the attacker-controlled certificate.\n\nBoth vulnerabilities are “triggered through X.509 certificate verification, specifically, name constraint checking. Note that this occurs after certificate chain signature verification and requires either a CA to have signed the malicious certificate or for the application to continue certificate verification despite failure to construct a path to a trusted issuer.” \n\n**The playbook includes the following tasks:**\n* Hunting for active processes running OpenSSL vulnerable versions using:\n    * Cortex XDR\n    * Splunk\n    * Azure Sentinel\n\n**Mitigations:**\n* OpenSSL official patch\n\nMore information:\n[MALWARETECH - Everything you need to know about the OpenSSL 3.0.7 Patch - CVE-2022-3602 & CVE-2022-3786](https://www.malwaretech.com/2022/11/everything-you-need-to-know-about-the-openssl-3-0-7-patch.html)\n[Randori - OpenSSL 3.x Vulnerabilities: What You Need To Know](https://www.randori.com/blog/openssl-vulnerability-what-you-need-to-know/)\n[NCSC-NL - OpenSSL overview Scanning software](https://github.com/NCSC-NL/OpenSSL-2022/tree/main/scanning)\n\nNote: This is a beta playbook that lets you implement and test pre-release software. Since the playbook is beta, it might contain bugs. Updates to the pack during the beta phase might include non-backward compatible features. We appreciate your feedback on the quality and usability of the pack to help us identify issues, fix them, and continually improve."
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: e3f78c2d-6116-4d7e-8173-eba4c6006b02
    type: start
    task:
      id: e3f78c2d-6116-4d7e-8173-eba4c6006b02
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -730
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 2ac17b29-b556-484d-8388-89f3fb024211
    type: title
    task:
      id: 2ac17b29-b556-484d-8388-89f3fb024211
      version: -1
      name: Tag and Link Indicators
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "5"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 472a82a2-fd54-496d-8405-813a06d9805a
    type: regular
    task:
      id: 472a82a2-fd54-496d-8405-813a06d9805a
      version: -1
      name: Tag CVE indicators
      description: commands.local.cmd.new.indicator
      script: Builtin|||createNewIndicator
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "24"
    scriptarguments:
      retry-count:
        simple: "3"
      retry-interval:
        simple: "2"
      tags:
        simple: OpenSSL
      type:
        simple: CVE
      value:
        complex:
          root: inputs.RelatedCVEs
          transformers:
          - operator: split
            args:
              delimiter:
                value:
                  simple: ','
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -470
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: a453e538-b130-407a-8904-dc602f272d1a
    type: condition
    task:
      id: a453e538-b130-407a-8904-dc602f272d1a
      version: -1
      name: Check if Cortex XDR - IR is Enabled
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'
      scriptName: IsIntegrationAvailable
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "no":
      - "25"
      "yes":
      - "21"
      - "22"
      - "23"
    scriptarguments:
      brandname:
        simple: Cortex XDR - IR
    results:
    - brandInstances
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 290
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: f6cb5ad1-06ba-43c2-876b-7673ea6400a2
    type: regular
    task:
      id: f6cb5ad1-06ba-43c2-876b-7673ea6400a2
      version: -1
      name: Retrieve All Linux OS Endpoint IDs
      description: Gets a list of endpoints, according to the passed filters. If there are no filters, all endpoints are returned. Filtering by multiple fields will be concatenated using AND condition (OR is not supported). Maximum result set size is 100. Offset is the zero-based number of endpoint from the start of the result set (start by counting from 0).
      script: '|||xdr-get-endpoints'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      platform:
        simple: linux
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: 86cc1b5e-6f85-4e4e-88de-4a6da433c2f2
    type: playbook
    task:
      id: 86cc1b5e-6f85-4e4e-88de-4a6da433c2f2
      version: -1
      name: Cortex XDR - Execute commands
      description: Initiates a new script execution of shell commands.
      playbookName: Cortex XDR - Execute commands
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "25"
    scriptarguments:
      commands:
        simple: 'sudo lsof -n | grep libssl.so.3 '
      endpoint_ids:
        complex:
          root: PaloAltoNetworksXDR.Endpoint
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
                iscontext: true
              right:
                value:
                  simple: CONNECTED
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Endpoint.os_type
                iscontext: true
              right:
                value:
                  simple: AGENT_OS_LINUX
              ignorecase: true
          accessor: endpoint_id
      polling_timeout:
        simple: "5"
    separatecontext: false
    continueonerrortype: ""
    loop:
      iscommand: false
      scriptArguments:
        commands:
          simple: pwd
        endpoint_ids:
          complex:
            root: PaloAltoNetworksXDR.Endpoint
            filters:
            - - operator: isEqualString
                left:
                  value:
                    simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
                  iscontext: true
                right:
                  value:
                    simple: CONNECTED
                ignorecase: true
            accessor: endpoint_id
        polling_timeout:
          simple: "10"
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 450,
          "y": 960
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: f1c3f5ca-b1ea-47ce-81ef-680d6e0afcdb
    type: title
    task:
      id: f1c3f5ca-b1ea-47ce-81ef-680d6e0afcdb
      version: -1
      name: Cortex XDR Hunting
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "8"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 160
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 74d1e6a9-991a-4d34-805a-6781d7636e52
    type: regular
    task:
      id: 74d1e6a9-991a-4d34-805a-6781d7636e52
      version: -1
      name: Retrieve All Windows OS Endpoint IDs
      description: Gets a list of endpoints, according to the passed filters. If there are no filters, all endpoints are returned. Filtering by multiple fields will be concatenated using AND condition (OR is not supported). Maximum result set size is 100. Offset is the zero-based number of endpoint from the start of the result set (start by counting from 0).
      script: '|||xdr-get-endpoints'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      platform:
        simple: windows
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -30,
          "y": 795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: ad49172f-4737-4f45-8a91-e75042ce2b7b
    type: playbook
    task:
      id: ad49172f-4737-4f45-8a91-e75042ce2b7b
      version: -1
      name: Cortex XDR - Execute commands
      description: Initiates a new script execution of shell commands.
      playbookName: Cortex XDR - Execute commands
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "25"
    scriptarguments:
      commands:
        simple: Get-ChildItem -Recurse -File -ErrorAction SilentlyContinue -Path "C:\" -Filter "libssl*"
      endpoint_ids:
        complex:
          root: PaloAltoNetworksXDR.Endpoint
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
                iscontext: true
              right:
                value:
                  simple: CONNECTED
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Endpoint.os_type
                iscontext: true
              right:
                value:
                  simple: AGENT_OS_WINDOWS
              ignorecase: true
          accessor: endpoint_id
      polling_timeout:
        simple: "5"
    separatecontext: false
    continueonerrortype: ""
    loop:
      iscommand: false
      scriptArguments:
        commands:
          simple: pwd
        endpoint_ids:
          complex:
            root: PaloAltoNetworksXDR.Endpoint
            filters:
            - - operator: isEqualString
                left:
                  value:
                    simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
                  iscontext: true
                right:
                  value:
                    simple: CONNECTED
                ignorecase: true
            accessor: endpoint_id
        polling_timeout:
          simple: "10"
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -30,
          "y": 960
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: e9c242b5-3f27-47e4-808b-330f5562cd0d
    type: title
    task:
      id: e9c242b5-3f27-47e4-808b-330f5562cd0d
      version: -1
      name: Linux OS
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "9"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 9a42e597-9782-4a59-8738-53b2e9bd3482
    type: title
    task:
      id: 9a42e597-9782-4a59-8738-53b2e9bd3482
      version: -1
      name: Windows OS
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "14"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -30,
          "y": 660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: afb31071-9259-4e63-808a-337642081bd4
    type: regular
    task:
      id: afb31071-9259-4e63-808a-337642081bd4
      version: -1
      name: Retrieve All Mac OS Endpoint IDs
      description: Gets a list of endpoints, according to the passed filters. If there are no filters, all endpoints are returned. Filtering by multiple fields will be concatenated using AND condition (OR is not supported). Maximum result set size is 100. Offset is the zero-based number of endpoint from the start of the result set (start by counting from 0).
      script: '|||xdr-get-endpoints'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "19"
    scriptarguments:
      platform:
        simple: macos
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 930,
          "y": 795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: 077c8b40-d583-477d-8775-07caa1addaa0
    type: playbook
    task:
      id: 077c8b40-d583-477d-8775-07caa1addaa0
      version: -1
      name: Cortex XDR - Execute commands
      description: Initiates a new script execution of shell commands.
      playbookName: Cortex XDR - Execute commands
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "25"
    scriptarguments:
      commands:
        simple: 'sudo lsof -n | grep libssl.so.3 '
      endpoint_ids:
        complex:
          root: PaloAltoNetworksXDR.Endpoint
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
                iscontext: true
              right:
                value:
                  simple: CONNECTED
              ignorecase: true
          - - operator: containsGeneral
              left:
                value:
                  simple: PaloAltoNetworksXDR.Endpoint.os_type
                iscontext: true
              right:
                value:
                  simple: Mac
              ignorecase: true
          accessor: endpoint_id
      polling_timeout:
        simple: "5"
    separatecontext: false
    continueonerrortype: ""
    loop:
      iscommand: false
      scriptArguments:
        commands:
          simple: pwd
        endpoint_ids:
          complex:
            root: PaloAltoNetworksXDR.Endpoint
            filters:
            - - operator: isEqualString
                left:
                  value:
                    simple: PaloAltoNetworksXDR.Endpoint.endpoint_status
                  iscontext: true
                right:
                  value:
                    simple: CONNECTED
                ignorecase: true
            accessor: endpoint_id
        polling_timeout:
          simple: "10"
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 930,
          "y": 960
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: ef894089-d9ec-4c31-858c-26ee7e5162fa
    type: title
    task:
      id: ef894089-d9ec-4c31-858c-26ee7e5162fa
      version: -1
      name: MacOS
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 930,
          "y": 660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: e124b740-fdd8-4db3-8dbb-c0e7db9f9e74
    type: condition
    task:
      id: e124b740-fdd8-4db3-8dbb-c0e7db9f9e74
      version: -1
      name: Should hunt for Windows endpoints?
      description: Whether to search for relevant OpenSSL 3.x processes on Windows endpoints.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "25"
      "yes":
      - "17"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.HuntWindowsOS
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -30,
          "y": 480
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: a6987fce-307c-489e-8222-5ed2a3222f41
    type: condition
    task:
      id: a6987fce-307c-489e-8222-5ed2a3222f41
      version: -1
      name: Should hunt for Linux endpoints?
      description: Whether to search for relevant OpenSSL 3.x processes on Linux endpoints.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "25"
      "yes":
      - "16"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.HuntLinuxOS
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 480
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: cf410c15-5593-4596-8a2f-f4b040df21c3
    type: condition
    task:
      id: cf410c15-5593-4596-8a2f-f4b040df21c3
      version: -1
      name: Should hunt for Mac endpoints?
      description: Whether to search for relevant OpenSSL 3.x processes on MacOS endpoints.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "25"
      "yes":
      - "20"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.HuntMacOS
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 930,
          "y": 480
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 3e50fb4d-e5dd-476a-888d-3aea4a078c2a
    type: regular
    task:
      id: 3e50fb4d-e5dd-476a-888d-3aea4a078c2a
      version: -1
      name: Link Indicators To Incident
      description: commands.local.cmd.associate.indicators
      script: Builtin|||associateIndicatorsToIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "41"
    scriptarguments:
      incidentId:
        complex:
          root: incident
          accessor: id
      indicatorsValues:
        complex:
          root: inputs.RelatedCVEs
          transformers:
          - operator: split
            args:
              delimiter:
                value:
                  simple: ','
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -310
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: acf06403-8ff1-4189-89cb-a7eb53cdcfed
    type: title
    task:
      id: acf06403-8ff1-4189-89cb-a7eb53cdcfed
      version: -1
      name: SIEM Advanced Hunting
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "30"
      - "31"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: 64d3aad5-3150-41cd-86d2-832eeceeaad4
    type: condition
    task:
      id: 64d3aad5-3150-41cd-86d2-832eeceeaad4
      version: -1
      name: Is Azure Log Analytics Enabled?
      description: Returns 'yes' if integration brand is available. Otherwise returns 'no'
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "34"
      "yes":
      - "32"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: Azure Log Analytics
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
                    ignorecase: true
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 210,
          "y": 1400
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: a61362d1-1119-4e9d-8032-d60b65693c99
    type: regular
    task:
      id: a61362d1-1119-4e9d-8032-d60b65693c99
      version: -1
      name: Hunt for active processes running OpenSSL 3.x
      description: |-
        Detects patterns in process executions caused by China Chopper-like tiny (ASPX) webshells.

        **Author:** Florian Roth (rule), MSTI (query)

        **Status:** experimental

        **References:**
            - https://www.microsoft.com/security/blog/2022/09/30/analyzing-attacks-using-the-exchange-vulnerabilities-cve-2022-41040-and-cve-2022-41082/
      tags:
      - SIEMResults
      script: '|||splunk-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    scriptarguments:
      earliest_time:
        complex:
          root: inputs.SplunkEarliestTime
      latest_time:
        complex:
          root: inputs.SplunkLatestTime
      query:
        simple: |-
          ${inputs.SplunkIndex} TERM(openssl) OR TERM(libcrypto-3) OR TERM(libssl-3) OR term(libssl) NOT TERM(tls1.2) NOT sourcetype IN (splunkd_ui_access, audittrail, splunkd_remote_searches)
          | rex field=_raw "(OpenSSL\/|libssl\.so\.|openssl\.so\.|openssl-|openssl-libs-)(?<SSLversion>[0-6]{1}\.[0-9]{1}\.[0-9]{1}[a-z]{1}|[0-6]{1})"
          | where isnotnull(SSLversion)
          | stats values(SSLversion) AS SSLVersions by host, sourcetype
          | sort -SSLVersions
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 700,
          "y": 1580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 5dc63bd8-98f0-4680-84aa-764e8145056c
    type: condition
    task:
      id: 5dc63bd8-98f0-4680-84aa-764e8145056c
      version: -1
      name: Is Splunk Enabled?
      description: Check whether the values provided in arguments are equal. If either of the arguments are missing, no is returned.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "34"
      "Yes":
      - "28"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: containsGeneral
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: Splunkpy
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 700,
          "y": 1400
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: acfa296e-0878-475b-8174-c9e1c4858d52
    type: title
    task:
      id: acfa296e-0878-475b-8174-c9e1c4858d52
      version: -1
      name: Azure Sentinel
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "26"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 210,
          "y": 1270
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: 8851049d-fa0c-45a7-8ccf-9b3e0494287d
    type: title
    task:
      id: 8851049d-fa0c-45a7-8ccf-9b3e0494287d
      version: -1
      name: Splunk
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "29"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 700,
          "y": 1270
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: 46675c82-014c-4480-81e9-9891b86bcf9e
    type: regular
    task:
      id: 46675c82-014c-4480-81e9-9891b86bcf9e
      version: -1
      name: Hunt for active processes running OpenSSL 3.x
      description: |-
        Detects suspicious file types dropped by an Exchange component in IIS into a suspicious folder.

        **Author:** Florian Roth (rule), MSTI (query, idea)

        **Status:** experimental

        **References:**
           - https://www.microsoft.com/security/blog/2022/09/30/analyzing-attacks-using-the-exchange-vulnerabilities-cve-2022-41040-and-cve-2022-41082/
           - https://www.gteltsc.vn/blog/canh-bao-chien-dich-tan-cong-su-dung-lo-hong-zero-day-tren-microsoft-exchange-server-12714.html
           - https://en.gteltsc.vn/blog/cap-nhat-nhe-ve-lo-hong-bao-mat-0day-microsoft-exchange-dang-duoc-su-dung-de-tan-cong-cac-to-chuc-tai-viet-nam-9685.html
      tags:
      - SIEMResults
      script: '|||azure-log-analytics-execute-query'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    scriptarguments:
      query:
        simple: |-
          DeviceTvmSoftwareInventory
          | where SoftwareName contains "openssl"
          | where SoftwareName contains "3.0" or SoftwareVersion contains "3.0"
          | project DeviceName, SoftwareName, SoftwareVersion
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 210,
          "y": 1580
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 53f89d1c-3f30-446f-884d-585fe00484d3
    type: regular
    task:
      id: 53f89d1c-3f30-446f-884d-585fe00484d3
      version: -1
      name: Install OpenSSL 3.0.7
      description: |-
        For **CVE-2022-3602** and **CVE-2022-3786**, please patch with the following versions:

        [openssl-3.0.7.tar.gz](https://github.com/openssl/openssl/archive/refs/tags/openssl-3.0.7.tar.gz)
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "39"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2050
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 93a024d4-83f3-4e24-8f10-208db5ad203c
    type: title
    task:
      id: 93a024d4-83f3-4e24-8f10-208db5ad203c
      version: -1
      name: Mitigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "40"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: 9054397d-eaba-4aa8-8415-e239334571a2
    type: condition
    task:
      id: 9054397d-eaba-4aa8-8415-e239334571a2
      version: -1
      name: Analysis resolution - Should continue with the investigation?
      description: Check with the analyst whether to continue with the investigation.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "No":
      - "38"
      "Yes":
      - "37"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2350
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
        simple: Do you need to continue with the investigation?
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: false
        completeaftersla: false
      replyOptions:
      - "Yes"
      - "No"
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: 5714d06c-4708-44c6-8758-d4a9269f8011
    type: title
    task:
      id: 5714d06c-4708-44c6-8758-d4a9269f8011
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2710
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: fe32ecf5-59cd-47cd-803b-9b665b9c6927
    type: regular
    task:
      id: fe32ecf5-59cd-47cd-803b-9b665b9c6927
      version: -1
      name: Investigate Further
      description: Manual step for further incident investigation. CISA released an open-source detection and scanning tool for discovering and fuzzing for Log4J RCE CVE-2021-44228 vulnerability. For more information , [CISA GitHub](https://github.com/cisagov/log4j-scanner/tree/master/log4-scanner)
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "36"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 0,
          "y": 2540
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: c1b87637-ddd0-4b36-83b0-811ea4e68537
    type: regular
    task:
      id: c1b87637-ddd0-4b36-83b0-811ea4e68537
      version: -1
      name: Close Investigation
      description: Close the current incident
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "36"
    scriptarguments:
      closeReason:
        simple: No further actions are required.
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2540
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: b232418e-ed5e-449c-8b37-168dd186bfb2
    type: title
    task:
      id: b232418e-ed5e-449c-8b37-168dd186bfb2
      version: -1
      name: Resolution
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "35"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 2220
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: 647e0734-b1e6-441f-825b-9c2f31207272
    type: regular
    task:
      id: 647e0734-b1e6-441f-825b-9c2f31207272
      version: -1
      name: Download OpenSSL 3.0.7
      description: Sends a HTTP request with advanced capabilities
      scriptName: HttpV2
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      method:
        simple: GET
      url:
        simple: https://github.com/openssl/openssl/archive/refs/tags/openssl-3.0.7.tar.gz
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1880
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: 9976660f-17ab-46da-8f74-de894a5ed737
    type: title
    task:
      id: 9976660f-17ab-46da-8f74-de894a5ed737
      version: -1
      name: Handle Rapid Breach Response Layout
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "42"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -150
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "42":
    id: "42"
    taskid: 95f29e44-a37c-4130-8db6-d6523446e4ed
    type: playbook
    task:
      id: 95f29e44-a37c-4130-8db6-d6523446e4ed
      version: -1
      name: Rapid Breach Response - Set Incident Info
      description: This playbook is responsible for setting up the Rapid Breach Response Incident Info tab in the layout.
      playbookName: Rapid Breach Response - Set Incident Info
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      playbookDescription:
        complex:
          root: inputs.PlaybookDescription
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      scriptArguments:
        SourceOfIndicators:
          complex:
            root: http.parsedBlog
            accessor: sourceLink
        countTotalIndicators:
          complex:
            root: ExtractedIndicators
            accessor: Domain
            transformers:
            - operator: append
              args:
                item:
                  value:
                    simple: ExtractedIndicators.IP
                  iscontext: true
            - operator: append
              args:
                item:
                  value:
                    simple: ExtractedIndicators.URL
                  iscontext: true
            - operator: append
              args:
                item:
                  value:
                    simple: ExtractedIndicators.File
                  iscontext: true
            - operator: append
              args:
                item:
                  value:
                    simple: ExtractedIndicators.CVE
                  iscontext: true
            - operator: uniq
            - operator: count
        playbookDescription:
          complex:
            root: inputs.Description
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 450,
          "y": -10
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "21_17_yes": 0.41,
      "21_25_#default#": 0.21,
      "22_16_yes": 0.46,
      "22_25_#default#": 0.22,
      "23_20_yes": 0.41,
      "23_25_#default#": 0.21,
      "26_32_yes": 0.4,
      "26_34_#default#": 0.56,
      "29_28_Yes": 0.4,
      "29_34_#default#": 0.55,
      "35_37_Yes": 0.62,
      "35_38_No": 0.39,
      "8_21_yes": 0.65,
      "8_22_yes": 0.46,
      "8_23_yes": 0.64,
      "8_25_no": 0.29
    },
    "paper": {
      "dimensions": {
        "height": 3505,
        "width": 1340,
        "x": -30,
        "y": -730
      }
    }
  }
inputs:
- key: HuntLinuxOS
  value:
    simple: "False"
  required: false
  description: Whether to search for relevant OpenSSL 3.x processes on Linux endpoints.
  playbookInputQuery:
- key: HuntWindowsOS
  value:
    simple: "False"
  required: false
  description: Whether to search for relevant OpenSSL 3.x processes on Windows endpoints.
  playbookInputQuery:
- key: HuntMacOS
  value:
    simple: "False"
  required: false
  description: Whether to search for relevant OpenSSL 3.x processes on Mac endpoints.
  playbookInputQuery:
- key: SplunkIndex
  value:
    simple: index=* OR index=_*
  required: false
  description: |-
    Splunk index to search.
    Note that the input value should include the field name as well. e.g. "index=*"
  playbookInputQuery:
- key: SplunkEarliestTime
  value:
    simple: -1d@d
  required: false
  description: Splunk earliest time to search.
  playbookInputQuery:
- key: SplunkLatestTime
  value:
    simple: now
  required: false
  description: Splunk latest time to search.
  playbookInputQuery:
- key: PlaybookDescription
  value:
    simple: "On November 1, OpenSSL released a [security advisory](https://www.openssl.org/news/secadv/20221101.txt) describing two high severity vulnerabilities within the OpenSSL library, CVE-2022-3786 and CVE-2022-3602. OpenSSL versions from 3.0.0 - 3.0.6 are vulnerable, with 3.0.7 containing the patch for both vulnerabilities. OpenSSL 1.1.1 and 1.0.2 are not affected by this issue.\n\nThe vulnerability described in CVE-2022-3602 allows an attacker to obtain a 4-byte overflow on the stack by crafting a malicious email address within the attacker-controlled certificate. The overflow will result in a crash (most likely scenario) or potentially remote code execution (much less likely). In CVE-2022-3786, an attacker can achieve a stack overflow of arbitrary length by crafting a malicious email address within the attacker-controlled certificate.\n\nBoth vulnerabilities are “triggered through X.509 certificate verification, specifically, name constraint checking. Note that this occurs after certificate chain signature verification and requires either a CA to have signed the malicious certificate or for the application to continue certificate verification despite failure to construct a path to a trusted issuer.” \n\n**The playbook includes the following tasks:**\n* Hunting for active processes running OpenSSL vulnerable versions using:\n    * Cortex XDR\n    * Splunk\n    * Azure Sentinel\n\n**Mitigations:**\n* OpenSSL official patch\n\nMore information:\n[MALWARETECH - Everything you need to know about the OpenSSL 3.0.7 Patch - CVE-2022-3602 & CVE-2022-3786](https://www.malwaretech.com/2022/11/everything-you-need-to-know-about-the-openssl-3-0-7-patch.html)\n[Randori - OpenSSL 3.x Vulnerabilities: What You Need To Know](https://www.randori.com/blog/openssl-vulnerability-what-you-need-to-know/)\n[NCSC-NL - OpenSSL overview Scanning software](https://github.com/NCSC-NL/OpenSSL-2022/tree/main/scanning)\n\nNote: This is a beta playbook that lets you implement and test pre-release software. Since the playbook is beta, it might contain bugs. Updates to the pack during the beta phase might include non-backward compatible features. We appreciate your feedback on the quality and usability of the pack to help us identify issues, fix them, and continually improve."
  required: false
  description: The playbook's description.
  playbookInputQuery:
- key: RelatedCVEs
  value:
    simple: CVE-2022-3786,CVE-2022-3602
  required: false
  description: CVE indicators.
  playbookInputQuery:
outputs: []
tests:
- No tests (auto formatted)
fromversion: 6.5.0
