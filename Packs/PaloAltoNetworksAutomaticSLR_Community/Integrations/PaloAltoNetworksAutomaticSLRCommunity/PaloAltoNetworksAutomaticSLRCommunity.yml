commonfields:
  id: Palo Alto Networks Automatic SLR (Community)
  version: -1
vcShouldKeepItemLegacyProdMachine: false
name: Palo Alto Networks Automatic SLR (Community)
display: Palo Alto Networks Automatic SLR (Community)
category: Utilities
image: data:image/png;base64,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
description: A community supported integration to allow XSOAR to automatically generate
  Security Lifecycle Review's (SLR's)
detaileddescription: Add an instance, fill out the required parameters as needed to
  customise the SLR output
configuration:
- display: Firewall Management FQDN or IP Address
  name: ngfw_fqdn_ip
  defaultvalue: my-firewall.example.tld
  type: 0
  required: true
  additionalinfo: Do not include http:// or https:// or any trailing slash (/) on
    the end
- display: Firewall Management TCP Port
  name: ngfw_port
  defaultvalue: "443"
  type: 0
  required: true
- display: Firewall Management API Key
  name: ngfw_api_key
  defaultvalue: default-ngfw-api-key
  type: 4
  required: true
- display: Firewall Timeout
  name: ngfw_timeout
  defaultvalue: "300"
  type: 0
  required: true
  additionalinfo: Timeout (in seconds) to perform firewall API operations
- display: Verify Firewall TLS Certificate
  name: ngfw_tls_verify
  defaultvalue: "true"
  type: 8
  required: false
- display: Customer Support Portal (CSP) API Key
  name: csp_api_key
  defaultvalue: default-csp-api-key
  type: 4
  required: true
  additionalinfo: 'How-to: https://docs.paloaltonetworks.com/vm-series/10-0/vm-series-deployment/license-the-vm-series-firewall/licensing-api/manage-the-licensing-api-key.html'
- display: CSP Timeout
  name: csp_timeout
  defaultvalue: "300"
  type: 0
  required: true
  additionalinfo: Timeout (in seconds) to perform Palo Alto Networks Customer
- display: Verify CSP TLS Certificate
  name: csp_tls_verify
  defaultvalue: "true"
  type: 8
  required: false
  additionalinfo: Verify Palo Alto Networks Customer Support Portal (CSP) TLS Certificate
- display: XSOAR System Proxy
  name: system_proxy
  defaultvalue: "false"
  type: 8
  required: false
  additionalinfo: Use the configured system proxy for XSOAR to route requests
- display: Enable Verbose Output
  name: system_debug
  defaultvalue: "false"
  type: 8
  required: false
  additionalinfo: Enable Verbose (Debug) Output - Do NOT enable unless needed!
- display: Customer Account Name
  name: slr_account_name
  defaultvalue: ACME Inc
  type: 0
  required: true
  additionalinfo: Customer Account Name to appear on the report
- display: Firewall Deployment Location
  name: slr_deployment_location
  defaultvalue: Perimeter/Internet Gateway
  type: 15
  required: true
  options:
  - Datacenter/Internal Segmentation
  - Hybrid (Perimeter and Datacenter)
  - Perimeter/Internet Gateway
- display: Deployment Country
  name: slr_geographic_country
  defaultvalue: United States
  type: 0
  required: true
- display: Deployment Geographic Region
  name: slr_geographic_region
  defaultvalue: Americas
  type: 15
  required: true
  options:
  - Americas
  - APAC
  - EMEA
  - Japan
- display: Customer Industry
  name: slr_industry
  defaultvalue: High Technology
  type: 15
  required: true
  options:
  - Aerospace & Defense
  - Agriculture
  - Automotive
  - Construction
  - Energy
  - Financial Services
  - Government - County
  - Government - Federal
  - Government - International
  - Government - Municipal
  - Government - State
  - Healthcare
  - Higher Education
  - High Technology
  - Hospitality
  - Insurance
  - Lower Education
  - Manufacturing
  - Media & Entertainment
  - Mining
  - Non-Profit
  - Other
  - Pharma & Life Sciences
  - Professional & Legal Services
  - Real Estate
  - Service Provider
  - Telecommunications
  - Transportation & Logistics
  - Utilities
  - Waste Management
  - Wholesale & Retail
  additionalinfo: Tailors certain portions of the output to the relevant industry
    chosen
- display: Language
  name: slr_language
  defaultvalue: English
  type: 15
  required: true
  options:
  - Chinese (s)
  - Chinese (t)
  - English
  - French
  - German
  - Italian
  - Japanese
  - Korean
  - Polish
  - Portugese
  - Russian
  - Spanish
  - Spanish (Latino)
- display: Prepared By
  name: slr_prepared_by
  defaultvalue: XSOAR Integration
  type: 0
  required: true
  additionalinfo: Name to appear on the front page of the report (e.g. Jane Doe)
- display: Requested By
  name: slr_requested_by
  defaultvalue: xsoar@example.tld
  type: 0
  required: true
  additionalinfo: Email address to appear on the front page of the report (e.g. jane.doe@example.tld)
- display: Send To
  name: slr_send_to
  defaultvalue: customer@example.tld
  type: 0
  required: true
  additionalinfo: Email address to send the report to
script:
  script: |
    # Copyright (c) 2020
    # Author: Matt Smith <https://github.com/Mediab0t/>

    # Permission is hereby granted, free of charge, to any person obtaining a copy
    # of this software and associated documentation files (the "Software"), to deal
    # in the Software without restriction, including without limitation the rights
    # to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    # copies of the Software, and to permit persons to whom the Software is
    # furnished to do so, subject to the following conditions:

    # The above copyright notice and this permission notice shall be included in all
    # copies or substantial portions of the Software.

    # THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    # IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    # FITNESS FOR A PARTICULAR PURPOSE AND NONINFINGEMENT. IN NO EVENT SHALL THE
    # AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    # LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    # OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    # SOFTWARE.

    import requests

    __author__ = "Matt Smith <https://github.com/Mediab0t/>"
    __copyright__ = "Copyright 2020, Palo Alto Networks, Inc."
    __license__ = "GPLv3"
    __version__ = "1.0.0"
    __status__ = "Production"
    __repository__ = "https://github.com/Mediab0t/xsoar-automatic-slr"

    ''' CONSTANTS '''
    DATE_FORMAT = '%Y-%m-%d-%H-%M-%S'


    class PanOSXMLAPI(BaseClient):

        def __init__(self, host, port, api_key, verify, timeout, proxy, verbose):

            # Map class parameters for the target firewall
            self.params = {
                'ngfw_host': 'https://' + host,
                'ngfw_port': port,
                'ngfw_tls_verify': verify,
                'ngfw_timeout': int(timeout),
                'ngfw_proxy': proxy,
                'ngfw_verbose': verbose
            }

            self.api_key = api_key

            # If using a custom port (e.g. when GlobalProtect Clientless and management are enabled on the same interface)
            if self.params['ngfw_port'] == '443':
                super().__init__(self.params['ngfw_host'] + '/api/', self.params['ngfw_tls_verify'])
            else:
                super().__init__(self.params['ngfw_host'].rstrip('/:') + ':' + self.params['ngfw_port'] + '/api/', self.params['ngfw_tls_verify'])

            # Use the XSOAR system proxy to route requests
            if proxy is True:
                self.proxies = handle_proxy()
            else:
                self.proxies = {}

        def get_system_info(self):
            return self.xmlapi_request_op('<show><system><info></info></system></show>')

        def xmlapi_request_op(self, cmd, xml_object=False):

            # Map and construct query
            params = {
                'type': 'op',
                'cmd': cmd,
                'key': self.api_key
            }

            # Execute query
            response = self._http_request(
                'POST',
                'api',
                params=params,
                resp_type='text',
                proxies=self.proxies,
                timeout=self.params['ngfw_timeout']
            )

            # Validate response from the API
            result = self.xmlapi_request_validate(response)

            if result is True:
                if xml_object is True:
                    xml = ET.fromstring(response)
                    return xml
                else:
                    return response
            else:
                raise Exception(
                    'Could not validate API response! [panos_xmlapi_request_op() -> panos_xmlapi_request_validate()]')

        def xmlapi_request_validate(self, response):

            # Load result into an XML object
            xml = ET.fromstring(response)

            # Get API response status
            status = xml.attrib['status']

            if self.params['ngfw_verbose'] is True:
                demisto.log('Got execution status back from API: ' + str(status))
                demisto.log(str(response))

            if "success" in status:
                return True
            else:
                message = xml.find('./msg/line').text
                raise Exception('API call encountered an error, received "' + str(
                    status) + '" as status code with error message: ' + str(message))

        def get_stats_init_job_id(self):

            params = {
                'type': 'export',
                'category': 'stats-dump',
                'key': self.api_key
            }

            response = self._http_request(
                'POST',
                'api',
                params=params,
                resp_type='text',
                proxies=self.proxies,
                timeout=self.params['ngfw_timeout']
            )

            result = self.xmlapi_request_validate(response)

            if result is True:
                xml = ET.fromstring(response)
                job = xml.find('./result/job').text
                return job
            else:
                raise Exception('Could not validate API response! [get_stats_init_job_id() -> xmlapi_request_validate()]')

        def get_stats_job_id_status(self, job_id):

            params = {
                'type': 'export',
                'category': 'stats-dump',
                'action': 'status',
                'job-id': job_id,
                'key': self.api_key
            }

            response = self._http_request(
                'POST',
                'api',
                params=params,
                resp_type='text',
                proxies=self.proxies,
                timeout=self.params['ngfw_timeout']
            )

            result = self.xmlapi_request_validate(response)

            if result is True:
                xml = ET.fromstring(response)
                status = xml.find('./result/job/status').text
                progress = xml.find('./result/job/progress').text

                result = {
                    'status': status,
                    'progress': progress
                }

                return result
            else:
                raise Exception('Could not validate API response! [get_stats_job_id_status() -> xmlapi_request_validate()]')

        def get_stats_archive(self, job_id):

            # Get firewall system name, serial number
            system_info = self.get_system_info()
            xml = ET.fromstring(str(system_info))
            system_name = xml.find('./result/system/devicename').text
            system_serial = xml.find('./result/system/serial').text

            time_stamp = time.strftime(DATE_FORMAT)
            output_file = system_name + '-' + system_serial + '-' + time_stamp + '-stats_dump.tar.gz'

            if self.params['ngfw_verbose'] is True:
                demisto.log('Constructed archive name as: [`' + output_file + '`]')

            params = {
                'type': 'export',
                'category': 'stats-dump',
                'action': 'get',
                'job-id': job_id,
                'key': self.api_key
            }

            response = self._http_request(
                'GET',
                'api',
                params=params,
                resp_type='content',
                proxies=self.proxies,
                timeout=self.params['ngfw_timeout']
            )

            result = {
                'file_name': output_file,
                'file_contents': response
            }

            return result

        def dump_ngfw_params(self):
            return self.params


    class PanwCSP(BaseClient):

        def __init__(self, host, csp_key, verify, timeout, proxy, verbose, account_name=None, deployment_location=None, geographic_country=None, geographic_region=None, industry=None, language=None, prepared_by=None, requested_by=None, send_to=None):

            self.params = {
                'csp_host': host,
                'csp_tls_verify': verify,
                'csp_timeout': int(timeout),
                'csp_proxy': proxy,
                'csp_verbose': verbose
            }

            self.slr_params = {}

            self.api_key = csp_key

            if proxy is True:
                self.proxies = handle_proxy()
            else:
                self.proxies = {}

            # The "Prepared By" name to appear on the front page of the report
            if prepared_by is not None:
                self.slr_params.update({'slr_prepared_by': prepared_by})
            else:
                raise Exception('slr_prepared_by cannot be None!')

            # The email address to appear on the front page of the report
            if requested_by is not None:
                self.slr_params.update({'slr_requested_by': requested_by})
            else:
                raise Exception('slr_requested_by cannot be None!')

            # The email address to send the completed report to
            if send_to is not None:
                self.slr_params.update({'slr_send_to': send_to})
            else:
                raise Exception('slr_send_to cannot be None!')

            # Override the SFDC details on record for the account
            if account_name is not None:
                self.slr_params.update({'slr_account_name': account_name})
            else:
                raise Exception('slr_account_name cannot be None!')

            # Override the SFDC details on record for the account
            if industry is not None:
                self.slr_params.update({'slr_industry': industry})
            else:
                raise Exception('slr_industry cannot be None!')

            # Override the SFDC details on record for the account
            if geographic_country is not None:
                self.slr_params.update({'slr_country': geographic_country})
            else:
                raise Exception('slr_country cannot be None!')

            # Override the SFDC details on record for the account
            if 'Americas' in geographic_region:
                self.slr_params.update({'slr_geographic_region': 'North America, Latin America, Canada'})
            elif 'APAC' in geographic_region:
                self.slr_params.update({'slr_geographic_region': 'Asia Pacific'})
            elif 'EMEA' in geographic_region:
                self.slr_params.update({'slr_geographic_region': 'Europe'})
            elif 'Japan' in geographic_region:
                self.slr_params.update({'slr_geographic_region': 'Japan'})
            else:
                raise Exception('Invalid parameter specified for slr_geographic_region!')

            # Override the SFDC details on record for the account
            if deployment_location is not None:
                self.slr_params.update({'slr_deployment_location': deployment_location})
            else:
                raise Exception('slr_deployment_location cannot be None!')

            # Override the SFDC details on record for the account
            if language is not None:
                self.slr_params.update({'slr_language': language})
            else:
                raise Exception('slr_language cannot be None!')

            headers = {
                'apikey': self.api_key
            }

            # Initiate the BaseClient
            super().__init__(base_url=self.params['csp_host'], verify=self.params['csp_tls_verify'], headers=headers)

        def upload_to_panw(self, file_data):
            file_handler = open(file_data['file_actual_name'], 'rb')

            file = {"files": (file_data['file_friendly_name'], file_handler, 'application/gzip')}

            payload = {
                "EmailIdList": self.slr_params['slr_send_to'],
                "RequestedBy": self.slr_params['slr_requested_by'],
                "PreparedBy": self.slr_params['slr_prepared_by'],
                "AccountName": self.slr_params['slr_account_name'],
                "Industry": self.slr_params['slr_industry'],
                "Country": self.slr_params['slr_country'],
                "GeographicRegion": self.slr_params['slr_geographic_region'],
                "DeploymentLocation": self.slr_params['slr_deployment_location'],
                "Language": self.slr_params['slr_language']
            }

            if self.params['csp_verbose'] is True:
                demisto.log('Upload -> Parameters -> [' + str(payload) + ']')
                demisto.log('Upload -> Files -> [' + str(file) + ']')

            demisto.log('Uploading ' + file_data['file_friendly_name'] + ' to Palo Alto Networks...')

            response = self._http_request(
                'POST',
                '/API/v1/Create/',
                data=payload,
                files=file,
                resp_type='json',
                proxies=self.proxies,
                timeout=self.params['csp_timeout']
            )

            return response

        def dump_csp_params(self, type='init'):

            if 'init' in type:
                return self.params
            elif 'slr' in type:
                return self.slr_params
            else:
                raise Exception('Invalid type passed to function, valid types are: init, slr')


    def test_module(xmlapi):
        # TODO: Rewrite test-module to be more relevant
        response = xmlapi.get_system_info()
        xml = ET.fromstring(response)

        system_name = xml.find('./result/system/hostname').text
        system_serial = xml.find('./result/system/serial').text

        if system_name is not None and system_serial is not None:
            return demisto.results('ok')
        else:
            raise Exception('test_module() failed!')


    def ngfw_get_system_info(xmlapi):
        # response = json.loads(xml2json(xmlapi.get_system_info()))

        response = xmlapi.get_system_info()
        xml = ET.fromstring(response)

        system_name = xml.find('./result/system/hostname').text
        system_serial = xml.find('./result/system/serial').text
        sw_version = xml.find('./result/system/sw-version').text

        result = {
            'hostname': system_name,
            'serial': system_serial,
            'software': sw_version
        }

        readable_output = tableToMarkdown('Firewall Information', result)

        return CommandResults(
            readable_output=readable_output,
            outputs_prefix='AutoSLR.ngfw_system_info',
            outputs_key_field='ngfw_system_info',
            outputs=result
        )


    def get_integration_params(csp, xmlapi):
        csp_params = csp.dump_csp_params('init')
        slr_params = csp.dump_csp_params('slr')
        ngfw_params = xmlapi.dump_ngfw_params()

        raw_result = {**csp_params, **ngfw_params, **slr_params, 'system_proxy': demisto.params().get('proxy'), 'system_verbose': demisto.params().get('system_debug')}

        readable_output = tableToMarkdown('Integration Parameters', raw_result)

        return CommandResults(
            readable_output=readable_output,
            outputs_prefix='AutoSLR.params',
            outputs_key_field='params',
            outputs=raw_result
        )


    def ngfw_generate_stats_dump(xmlapi):
        result = xmlapi.get_stats_init_job_id()

        readable_output = 'Successfully created stats-generate job! [ID: `' + result + '`]'

        return CommandResults(
            readable_output=readable_output,
            outputs_prefix='AutoSLR.generate.job_id',
            outputs_key_field='job_id',
            outputs=result
        )


    def ngfw_get_stats_dump_status(xmlapi, job_id):
        state = False
        result = None

        while not state:
            demisto.log('Checking status for job ID: `' + str(job_id) + '`')

            result = xmlapi.get_stats_job_id_status(job_id)

            if 'FIN' in result['status']:
                state = True
            elif 'ACT' in result['status']:
                demisto.log(
                    'Job `' + str(job_id) + '` is currently executing, current progress: `' + result['progress'] + '%`')
            elif 'PEND' in result['status']:
                demisto.log('Another job is currently executing, this job is currently in the queue')
            else:
                raise Exception('Unexpected value returned from API, expected [`ACT/FIN/PEND`] got: `' + str(result) + '`')

            time.sleep(1)

        if state is True:
            readable_output = 'Successfully finished executing stats_dump generation job for job ID: `' + str(job_id) + '`'

            return CommandResults(
                readable_output=readable_output,
                outputs_prefix='AutoSLR.generate.job_status',
                outputs_key_field='job_status',
                outputs=state
            )

        else:
            raise Exception('Could not check stats_dump generation task [ID: `' + str(job_id) + '`]')


    def ngfw_download_stats_dump(xmlapi, job_id):
        result = xmlapi.get_stats_archive(job_id)
        # demisto.results(fileResult(result['file_name'], result['file_contents'], entryTypes['entryInfoFile']))

        file_entry = fileResult(result['file_name'], result['file_contents'], entryTypes['entryInfoFile'])
        return file_entry


    def upload_stats_to_panw(csp, input_file):
        get_path = demisto.getFilePath(input_file)

        file_data = {
            'file_friendly_name': get_path.get('name'),
            'file_actual_name': get_path.get('path')
        }

        demisto.log('Got file name [' + file_data['file_friendly_name'] + '] as path [' + file_data['file_actual_name'] + ']')

        result = csp.upload_to_panw(file_data)

        send_to = demisto.params().get('slr_send_to')
        slr_id = result['Id']
        readable_output = 'Successfully uploaded "' + str(file_data['file_friendly_name']) + '" to Palo Alto Networks! The SLR Report will be emailed to ' + str(send_to) + ' (SLR Reference ID: `' + str(slr_id) + '`)'

        context = {
            'id': slr_id,
            'send_to': send_to
        }

        return CommandResults(
            readable_output=readable_output,
            outputs_prefix='AutoSLR.upload',
            outputs_key_field=['id', 'send_to'],
            outputs=context
        )


    def main():
        # Parse the XSOAR Integrations Parameters
        ngfw_host = demisto.params().get('ngfw_fqdn_ip')
        ngfw_port = demisto.params().get('ngfw_port')
        ngfw_api_key = demisto.params().get('ngfw_api_key')
        ngfw_timeout = demisto.params().get('ngfw_timeout')
        ngfw_tls_verify = demisto.params().get('ngfw_tls_verify')

        csp_host = 'https://riskreport.paloaltonetworks.com/'
        csp_api_key = demisto.params().get('csp_api_key')
        csp_timeout = demisto.params().get('csp_timeout')
        csp_tls_verify = demisto.params().get('csp_tls_verify')

        system_proxy = demisto.params().get('proxy')
        system_verbose = demisto.params().get('system_debug')

        account_name = demisto.params().get('slr_account_name')
        deployment_location = demisto.params().get('slr_deployment_location')
        geographic_country = demisto.params().get('slr_geographic_country')
        geographic_region = demisto.params().get('slr_geographic_region')
        industry = demisto.params().get('slr_industry')
        language = demisto.params().get('slr_language')
        prepared_by = demisto.params().get('slr_prepared_by')
        requested_by = demisto.params().get('slr_requested_by')
        send_to = demisto.params().get('slr_send_to')

        try:

            if ngfw_tls_verify is False or csp_tls_verify is False:
                requests.packages.urllib3.disable_warnings()

            # Establish PANOS XMLAPI Class Connector
            xmlapi = PanOSXMLAPI(ngfw_host, ngfw_port, ngfw_api_key, ngfw_tls_verify, ngfw_timeout, system_proxy, system_verbose)

            # Establish Palo Alto Networks Customer Support Portal (CSP) Class Connector
            csp = PanwCSP(csp_host, csp_api_key, csp_tls_verify, csp_timeout, system_proxy, system_verbose, account_name, deployment_location, geographic_country, geographic_region, industry, language, prepared_by, requested_by, send_to)

            # Map XSOAR Commands to caller functions
            if demisto.command() == 'test-module':
                return_results(test_module(xmlapi))
            elif demisto.command() == 'autoslr-ngfw-system-info':
                return_results(ngfw_get_system_info(xmlapi))
            elif demisto.command() == 'autoslr-dump-params':
                return_results(get_integration_params(csp, xmlapi))
            elif demisto.command() == 'autoslr-ngfw-generate':
                return_results(ngfw_generate_stats_dump(xmlapi))
            elif demisto.command() == 'autoslr-ngfw-check':
                return_results(ngfw_get_stats_dump_status(xmlapi, demisto.args().get('job_id')))
            elif demisto.command() == 'autoslr-ngfw-download':
                return_results(ngfw_download_stats_dump(xmlapi, demisto.args().get('job_id')))
            elif demisto.command() == 'autoslr-csp-upload':
                return_results(upload_stats_to_panw(csp, demisto.args().get('input_file')))
            else:
                raise NotImplementedError('Command "' + str(demisto.command()) + '" is not implemented.')
        except Exception as e:
            return_error('Failed to execute: [' + str(demisto.command()) + '] Received Error: [' + str(e) + '] Traceback: [' + traceback.format_exc() + ']')


    if __name__ in ['__main__', 'builtin', 'builtins']:
        main()
  type: python
  commands:
  - name: autoslr-ngfw-generate
    arguments: []
    outputs:
    - contextPath: AutoSLR.generate.job_id
      description: Job ID of stats_dump.tar.gz generation job
      type: string
    description: Initiates the stats_dump.tar.gz generation job on the target firewall
  - name: autoslr-ngfw-check
    arguments:
    - name: job_id
      required: true
      description: Job ID to check
    outputs:
    - contextPath: AutoSLR.generate.job_status
      description: Returns true when completed, false is an error occured
      type: boolean
    description: Checks the status of the stats_dump.tar.gz generation job, returns
      true when completed
  - name: autoslr-ngfw-download
    arguments:
    - name: job_id
      required: true
      description: Job ID of stats_dump.tar.gz generation task
    outputs:
    - contextPath: AutoSLR.generate.file_name
      description: Filename of downloaded file
      type: string
    - contextPath: InfoFile.EntryID
      description: EntryID of Downloaded File
      type: string
    description: Downloads the stats_dump.tar.gz from the target firewall
  - name: autoslr-csp-upload
    arguments:
    - name: input_file
      description: EntryID of the file to upload
    outputs:
    - contextPath: AutoSLR.upload.id
      description: SLR Reference ID
      type: string
    - contextPath: AutoSLR.upload.send_to
      description: Email address where the report is being sent to
      type: string
    description: Uploads the stats_dump.tar.gz to Palo Alto Networks
  - name: autoslr-ngfw-system-info
    arguments: []
    outputs:
    - contextPath: AutoSLR.ngfw_system_info.hostname
      description: Firewall Hostname
      type: string
    - contextPath: AutoSLR.ngfw_system_info.serial
      description: Firewall Serial Number
      type: string
    - contextPath: AutoSLR.ngfw_system_info.software
      description: Firewall PANOS Version
      type: string
    description: Retrieve information about the target firewall
  - name: autoslr-dump-params
    arguments: []
    outputs:
    - contextPath: AutoSLR.params.csp_host
      description: CSP URL
      type: string
    - contextPath: AutoSLR.params.csp_proxy
      description: Use XSOAR Proxy
      type: boolean
    - contextPath: AutoSLR.params.csp_timeout
      description: Timeout for API Operation
      type: number
    - contextPath: AutoSLR.params.csp_tls_verify
      description: Enable/Disable TLS Certificate Verification
      type: boolean
    - contextPath: AutoSLR.params.csp_verbose
      description: Enable/Disable Verbose Log Output
      type: boolean
    - contextPath: AutoSLR.params.ngfw_host
      description: Firewall Management FQDN/IP Address
      type: string
    - contextPath: AutoSLR.params.ngfw_port
      description: Firewall Management TCP Port
      type: number
    - contextPath: AutoSLR.params.ngfw_proxy
      description: Use XSOAR Proxy
      type: boolean
    - contextPath: AutoSLR.params.ngfw_timeout
      description: Timeout for API Operation
      type: number
    - contextPath: AutoSLR.params.ngfw_tls_verify
      description: Enable/Disable TLS Certificate Verification
      type: boolean
    - contextPath: AutoSLR.params.ngfw_verbose
      description: Enable/Disable Verbose Log Output
      type: boolean
    - contextPath: AutoSLR.params.slr_account_name
      description: Customer Name
      type: string
    - contextPath: AutoSLR.params.slr_country
      description: Customer Deployment Country
      type: string
    - contextPath: AutoSLR.params.slr_deployment_location
      description: Customer Deployment Logical Location
      type: string
    - contextPath: AutoSLR.params.slr_geographic_region
      description: Customer Deployment Geographic Region
      type: string
    - contextPath: AutoSLR.params.slr_industry
      description: Customer Industry
      type: string
    - contextPath: AutoSLR.params.slr_language
      description: 'Customer Langugage '
      type: string
    - contextPath: AutoSLR.params.slr_prepared_by
      description: Person who generated the report (name)
      type: string
    - contextPath: AutoSLR.params.slr_requested_by
      description: Person who generated the report (email)
      type: string
    - contextPath: AutoSLR.params.slr_send_to
      description: Email address to send the completed report to
      type: string
    - contextPath: AutoSLR.params.system_proxy
      description: Use XSOAR Proxy
      type: boolean
    - contextPath: AutoSLR.params.system_verbose
      description: Enable/Disable Verbose Log Output
      type: boolean
    description: This command will dump all the non-sensitive parameters to the context,
      useful for debugging purposes
    execution: true
  dockerimage: demisto/python3:3.8.3.9324
  runonce: false
  subtype: python3
