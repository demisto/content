commonfields:
  id: McAfee NSM
  version: -1
name: McAfee NSM
display: McAfee NSM
category: Network Security
image: data:image/png;base64,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
description: McAfee Network Security Manager
configuration:
- display: 'URL (for example: https://192.168.0.1:5000)'
  name: url
  defaultvalue: ""
  type: 0
  required: true
- display: Username
  name: credentials
  defaultvalue: ""
  type: 9
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |-
    var session_credentials = '';
    var insecure = params.insecure;
    // handle '/' at the end of the url
    var base_url = params.url.slice(0, params.url.length - params.url.match('/*$')[0].length) + '/sdkapi/';
    var proxy = params.proxy;

    function sendRequest(method, url_suffix, headers, body, params) {
        // add default headers
        if (!("Accept" in headers)) {
            headers["Accept"] = ['application/vnd.nsm.v1.0+json', 'application/vnd.nsm.v2.0+json'];
        }
        if (!("Content-Type" in headers)) {
            headers['Content-Type'] = ['application/json'];
        }
        if (session_credentials !== '') {
            headers['NSM-SDK-API'] = [session_credentials];
        }

        var path = base_url + url_suffix;

        if(params){
            path += encodeToURLQuery(params);
        }

        var res = http(
            path,
            {
                Method: method,
                Headers: headers,
                Body: body,
            },
            insecure,
            proxy
        );

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }

        return JSON.parse(res.Body);
    }

    function validateTimeArgs(time_period, start_time, end_time) {
        if (time_period === 'CUSTOM') {
            if ((start_time === undefined) || (end_time === undefined)) {
                return false;
            }
        }
        return true;
    }

    function attacks_to_entry(title, attacks) {
        return createEntry(attacks, {
            contextPath : 'NSM.Attacks(val.ID && val.ID === obj.ID)',
            title : title,
            data : [
                {to : 'ID', from : 'attackId'},
                {to : 'Name', from : 'name'},
                {to : 'Direction', from : 'DosDirection'},
                {to : 'Severity', from : 'Severity'},
                {to : 'Category', from : 'UiCategory'},
            ],
        },
        undefined, pascalToSpace);
    }

    function IPS_policies_to_entry(title, ips_policies) {
        return createEntry(ips_policies, {
            contextPath : 'NSM.IPSPolicies(val.ID && val.ID === obj.ID)',
            title : title,
            data : [
                {to : 'ID', from : 'policyId'},
                {to : 'Name', from : 'name'},
                {to : 'DomainID', from : 'DomainId'},
                {to : 'IsEditable', from : 'IsEditable'},
                {to : 'VisibleToChildren', from : 'VisibleToChild'},
            ],
        },
        undefined, pascalToSpace);
    }

    function IPS_policy_to_entry(title, ips_policy, policy_id) {
        ips_policy.ID = policy_id;
        return createEntry([ips_policy], {
            contextPath : 'NSM.IPSPolicies(val.ID && val.ID === obj.ID)',
            title : title,
            data : [
                {to : 'ID', from : 'ID'},
                {to : 'Name', from : 'PolicyName'},
                {to : 'Description', from : 'Description'},
                {to : 'CreatedTime', from : 'Timestamp'},
                {to : 'IsEditable', from : 'IsEditable'},
                {to : 'VisibleToChildren', from : 'IsVisibleToChildren'},
                {to : 'Version', from : 'VersionNum'},
                {to : 'InboundRuleSet', from : 'InboundRuleSet'},
                {to : 'OutboundRuleSet', from : 'OutboundRuleSet'},

                {to : 'ExploitAttacks', from : 'AttackCategory.ExpolitAttackList', humanReadable : false},
            ],
        },
        undefined, pascalToSpace);
    }

    function alerts_to_entry(title, alerts) {
        return createEntry(alerts, {
            contextPath : 'NSM.Alerts(val.ID && val.ID === obj.ID)',
            title : title,
            data : [
                {to : 'ID', from : 'event.alertId'},
                {to : 'Name', from : 'name'},
                {to : 'State', from : 'alertState'},
                {to : 'CreatedTime', from : 'event.time'},
                {to : 'Assignee', from : 'assignTo'},
                {to : 'AttackSeverity', from : 'attackSeverity'},
                {to : 'Application', from : 'application'},
                {to : 'EventResult', from : 'event.result'},
                {to : 'SensorID', from : 'detection.deviceId'},

                {to : 'Event', from : 'event', humanReadable : false},
                {to : 'Event.domain', from : 'detection.domain', humanReadable : false},
                {to : 'Event.interface', from : 'detection.interface', humanReadable : false},
                {to : 'Event.device', from : 'detection.device', humanReadable : false},
                {to : 'Attack', from : 'attack', humanReadable : false},
                {to : 'Attacker', from : 'attacker', humanReadable : false},
                {to : 'Target', from : 'target', humanReadable : false},
                {to : 'MalwareFile', from : 'malwareFile', humanReadable : false},

            ],
        },
        undefined, pascalToSpace);
    }

    function alert_to_entry(title, alert) {
        /// single alert object has different structure than the alerts of alerts_to_entry.
        var context = {
            ID : alert.summary.event.alertId,
            Name : alert.name,
            State : alert.alertState,
            CreatedTime : alert.summary.event.time,
            Assignee : alert.assignTo,
            Description : alert.description.definition,
            EventResult : alert.summary.event.result,
            Attack : {
                attackCategory : alert.description.attackCategory,
                attackSubCategory : alert.description.attackSubCategory,
                nspId : alert.description.reference.nspId, // no human readable
            },
            Protocols : alert.description.protocals,

            // no human readable
            SensorID : alert.summary.event.deviceId,
            Event : alert.summary.event,
            Attacker : alert.summary.attacker,
            Target : alert.summary.target,
            MalwareFile : alert.details.malwareFile,
            Details : alert.details,
        };

        var headers = ['ID', 'Name', 'Attack Category', 'Attack SubCategory', 'Description', 'State', 'Assignee', 'CreatedTime', 'EventResult', 'Comments'];
        var md = {
            ID : alert.summary.event.alertId,
            Name : alert.name,
            State : alert.alertState,
            CreatedTime : alert.summary.event.time,
            Assignee : alert.assignTo,
            Description : alert.description.definition,
            EventResult : alert.summary.event.result,
            'Attack Category' : alert.description.attackCategory,
            'Attack SubCategory' : alert.description.attackSubCategory,
            Comments : alert.description.comments.comments,
        };
        var links = alert.description.reference.additionInfo.split('<BR>');
        for (var i in links) {
            links[i] = '[{0}]({0})'.format(links[i]);
        }

        var reference = {
            CVE : alert.description.reference.cveId,
            Microsoft : alert.description.reference.microsoftId,
            'Intruvert ID' : alert.description.reference.nspId,
            'Additional Info' : links.join('<br>'),
        };

        var entry = {
            Type: entryTypes.note,
            Contents: alert,
            ContentsFormat: formats.json,
            ReadableContentsFormat: formats.markdown,
            HumanReadable : (tableToMarkdown(title, md, headers) +
                tableToMarkdown('Reference', reference) +
                tableToMarkdown('Platform Affected', {Protocols : alert.description.protocals})
            ),
            EntryContext : {
            'NSM.Alerts(val.ID && val.ID === obj.ID)' : createContext(context),
            },
        };
        return entry;
    }

    function domains_to_entry(title, domains) {
        return createEntry(domains, {
            contextPath : 'NSM.Domains(val.ID && val.ID === obj.ID)',
            title : title,
            data : [
                {to : 'ID', from : 'DomainDescriptor.id'},
                {to : 'Name', from : 'DomainDescriptor.name'},
            ],
        },
        undefined, pascalToSpace);
    }

    function sensors_to_entry(title, sensors) {
        return createEntry(sensors, {
            contextPath : 'NSM.Sensors(val.ID && val.ID === obj.ID)',
            title : title,
            data : [
                {to : 'ID', from : 'sensorId'},
                {to : 'Name', from : 'name'},
                {to : 'Description', from : 'Description'},
                {to : 'DomainID', from : 'DomainID'},
                {to : 'IPSPolicyID', from : 'IPSPolicyID'},
                {to : 'IP Address', from : 'sensorIPAddress'},
            ],
        },
        undefined, pascalToSpace);
    }

    function login() {
        var cmd_url = "session";
        var credentials = btoa(params.credentials.identifier + ':' + params.credentials.password);
        var headers = {'NSM-SDK-API' : [credentials]};
        var res = sendRequest("GET", cmd_url, headers, '');

        // store current credentials
        session_credentials = btoa(res.session + ':' + res.userId);
        return res;
    }

    function get_attacks(attack_id) {
        var cmd_url, res;
        if (attack_id) {
            if (attack_id.match('^0x[0-9A-Fa-f]{8}$') === null) {
                throw 'Error! Attack ID must be formated as 32-bit hexadecimal number. for example: 0x1234BEEF';
            }

            cmd_url = 'attack/' + attack_id;
        } else {
            cmd_url = 'attacks';
        }

        res = sendRequest('GET', cmd_url, {}, '');
        if (attack_id) {
            return attacks_to_entry('Attack ' + attack_id, [res.AttackDescriptor]);
        } else {
            return attacks_to_entry(res.AttackDescriptorDetailsList.length + ' Attacks', res.AttackDescriptorDetailsList);
        }
    }

    function get_IPS_policies(domain_id) {
        var cmd_url = 'domain/' + domain_id + '/ipspolicies';
        var res = sendRequest('GET', cmd_url, {}, '');

        return IPS_policies_to_entry(res.PolicyDescriptorDetailsList.length + ' IPS Policies', res.PolicyDescriptorDetailsList);
    }

    function get_IPS_policy_details(policy_id) {
        var cmd_url = 'ipspolicy/' + policy_id;
        var res = sendRequest('GET', cmd_url, {}, '');

        return IPS_policy_to_entry('IPS Policy ' + policy_id, res.PolicyDescriptor, policy_id);
    }

    function get_sensors(domain_id) {
        var cmd_url = 'sensors';
        if (domain_id !== undefined) {
            cmd_url += '?domain=' + domain_id;
        }
        var res = sendRequest('GET', cmd_url, {}, '');

        return sensors_to_entry('Sensors', res.SensorDescriptor);
    }

    function get_domains(domain_id) {
        var cmd_url = 'domain';
        if (domain_id) {
            cmd_url += '/' + domain_id;
        }
        var res = sendRequest('GET', cmd_url, {}, '');

        if (domain_id) {
            return domains_to_entry('Domain ' + domain_id, [res]);
        } else {
            return domains_to_entry((res.length || '') + ' Domains', [res]);
        }
    }

    function all_alerts_url(state, time_period, start_time, end_time, search, filter) {
        var cmd_url = 'alerts';
        var cmd_args = {};

        if (state) {
            cmd_args.alertstate = state;
        }

        if (time_period) {
            cmd_args.timeperiod = time_period;
            if (time_period === 'CUSTOM') {
                cmd_args.starttime = start_time;
                cmd_args.endtime = end_time;
            }
        }

        if (search) {
            cmd_args.search = search;
        }

        if (filter) {
            cmd_args.filter = filter;
        }

        return cmd_url + encodeToURLQuery(cmd_args);
    }

    function get_alerts(state, time_period, start_time, end_time, search, filter) {
        var cmd_url = all_alerts_url(state, time_period, start_time, end_time, search, filter);
        var res = sendRequest('GET', cmd_url, {}, '');

        return alerts_to_entry('Showing ' + res.retrievedAlertsCount + '/' + res.totalAlertsCount + ' Alerts', res.alertsList);
    }

    function update_alerts(state, time_period, start_time, end_time, search, filter, new_state, new_assignee) {
        var cmd_url = all_alerts_url(state, time_period, start_time, end_time, search, filter);
        if ((new_state === undefined) && (new_assignee === undefined)) {
            throw 'Error! You must specify a new alert state or a new assignee';
        }

        var query = {};
        if (new_state) {
            query.alertState = new_state;
        }
        if (new_assignee) {
            query.assignTo = new_assignee;
        }
        query = JSON.stringify(query);

        var res = sendRequest('PUT', cmd_url, {}, query);
        if (res.status === -1) {
            throw 'Error! Failed to update alerts.';
        }

        return get_alerts(state, time_period, start_time, end_time);
    }

    function get_alert_details(alert_id, sensor_id) {
        var cmd_url = 'alerts/' + alert_id;
        var query_params = {
            'sensorId': sensor_id
        };
        var res = sendRequest('GET', cmd_url, {}, '', query_params);
        return alert_to_entry('Alert ' + res.name, res);
    }

    function get_ntba_monitors() {
        var cmd_url = 'ntbamonitors';
        var res = sendRequest('GET', cmd_url, {}, '');

        return res;
    }

    function get_events(nba_id, hash, duration) {
        var cmd_url = nba_id + '/endpointintelligence/' + hash + '/events?duration=' + duration;
        var res = sendRequest('GET', cmd_url, {}, '');

        return res.eventList;
    }

    login();
    switch (command) {
        case 'nsm-get-sensors':
            return get_sensors(args.domainID);

        case 'nsm-get-domains':
            return get_domains(args.domain);

        case 'nsm-get-alerts':
            if (!validateTimeArgs(args.time_period, args.start_time, args.end_time)) {
                throw 'Error! In CUSTOM mode, You must specify both start time and end time';
            }
            return get_alerts(args.state, args.time_period, args.start_time, args.end_time, args.search, args.filter);
        case 'nsm-get-alert-details':
            return get_alert_details(args.alert_id, args.sensor_id);
        case 'nsm-update-alerts':
            if (!validateTimeArgs(args.time_period, args.start_time, args.end_time)) {
                throw 'Error! In CUSTOM mode, You must specify both start time and end time';
            }
            return update_alerts(args.state, args.time_period, args.start_time, args.end_time, args.search, args.filter, args.new_state, args.new_assignee);

        case 'nsm-get-attacks':
            return get_attacks(args.attack_id);

        case 'nsm-get-ips-policies':
            return get_IPS_policies(args.domain_id);
        case 'nsm-get-ips-policy-details':
            return get_IPS_policy_details(args.policy_id);

        case 'test-module':
            return 'ok';
        default:
            break;
    }
  type: javascript
  commands:
  - name: nsm-get-sensors
    arguments:
    - name: domainID
      default: true
      description: The domain of the sensors. If blank, returns all sensors.
    outputs:
    - contextPath: NSM.Sensors.ID
      description: Sensor ID
      type: string
    - contextPath: NSM.Sensors.Description
      description: Sensor Description
      type: string
    - contextPath: NSM.Sensors.DomainID
      description: Sensor's Domain ID
      type: string
    description: get a sensor list of a given domain
  - name: nsm-get-domains
    arguments:
    - name: domain
      default: true
      description: Specific domain details. Leave blank for all domains.
    outputs:
    - contextPath: NSM.Domains.ID
      description: Domain ID
      type: number
    - contextPath: NSM.Domains.Name
      description: Domain Name
      type: string
    description: Get all domains
  - name: nsm-get-alerts
    arguments:
    - name: time_period
      auto: PREDEFINED
      predefined:
      - LAST_5_MINUTES
      - LAST_1_HOUR
      - LAST_6_HOURS
      - LAST_12_HOURS
      - LAST_24_HOURS
      - LAST_7_DAYS
      - LAST_14_DAYS
      - CUSTOM
      description: Time Period
    - name: start_time
      description: Start Time in "mm/dd/yyyy HH:MM" format only. used for custom time
        only
    - name: end_time
      description: End Time in "mm/dd/yyyy HH:MM" format only. used for custom time
        only
    - name: state
      auto: PREDEFINED
      predefined:
      - ANY
      - Acknowledged
      - Unacknowledged
      description: Alert State
      defaultValue: ANY
    - name: search
      description: Search string in alert details
    - name: filter
      description: 'Filter alert by fields. example: "name:hello;direction:Inbound,Outbound;attackcount:>3,<4".'
    outputs:
    - contextPath: NSM.Alerts.ID
      description: Alert ID
      type: number
    - contextPath: NSM.Alerts.Name
      description: Alert Name
      type: string
    - contextPath: NSM.Alerts.State
      description: Alert State (Acknowledged,Unacknowledged)
      type: string
    - contextPath: NSM.Alerts.CreatedTime
      description: Alert Creation Time
      type: string
    - contextPath: NSM.Alerts.Assignee
      description: Alert Assignee
      type: string
    - contextPath: NSM.Alerts.AttackSeverity
      description: Alert Severity
      type: string
    - contextPath: NSM.Alerts.Application
      description: The Application assosiated to the alert
      type: string
    - contextPath: NSM.Alerts.EventResult
      description: Event Result
    - contextPath: NSM.Alerts.Event
      description: The Event who triggered the alert
    - contextPath: NSM.Alerts.Attack
      description: Alert's Attack
    - contextPath: NSM.Alerts.Attacker
      description: The Attacker who committed the attack
    - contextPath: NSM.Alerts.Target
      description: The Attack's Target
    - contextPath: NSM.Alerts.MalwareFile
      description: Malware File used in the attack
    description: Get alerts
  - name: nsm-update-alerts
    arguments:
    - name: state
      auto: PREDEFINED
      predefined:
      - ANY
      - Acknowledged
      - Unacknowledged
      description: Alert State
      defaultValue: ANY
    - name: time_period
      auto: PREDEFINED
      predefined:
      - LAST_5_MINUTES
      - LAST_1_HOUR
      - LAST_6_HOURS
      - LAST_12_HOURS
      - LAST_24_HOURS
      - LAST_7_DAYS
      - LAST_14_DAYS
      - CUSTOM
      description: Time Period
    - name: start_time
      description: Start Time in "mm/dd/yyyy HH:MM" format only. used for custom time
        only
    - name: end_time
      description: End Time in "mm/dd/yyyy HH:MM" format only. used for custom time
        only
    - name: new_state
      auto: PREDEFINED
      predefined:
      - Acknowledged
      - Unacknowledged
      description: The new alert state
    - name: new_assignee
      description: The new assignee
    - name: search
      description: Search string in alert details
    - name: filter
      description: 'Filter alert by fields. example: "name:hello;direction:Inbound,Outbound;attackcount:>3,<4"'
    outputs:
    - contextPath: NSM.Alerts.ID
      description: Alert ID
      type: number
    - contextPath: NSM.Alerts.Name
      description: Alert Name
      type: string
    - contextPath: NSM.Alerts.State
      description: Alert State (Acknowledged,Unacknowledged)
      type: string
    - contextPath: NSM.Alerts.CreatedTime
      description: Alert Creation Time
      type: string
    - contextPath: NSM.Alerts.Assignee
      description: Alert Assignee
      type: string
    - contextPath: NSM.Alerts.AttackSeverity
      description: Alert Severity
      type: string
    - contextPath: NSM.Alerts.Application
      description: The Application assosiated to the alert
      type: string
    - contextPath: NSM.Alerts.EventResult
      description: Event Result
    - contextPath: NSM.Alerts.Event
      description: The Event who triggered the alert
    - contextPath: NSM.Alerts.Attack
      description: Alert's Attack
    - contextPath: NSM.Alerts.Attacker
      description: The Attacker who committed the attack
    - contextPath: NSM.Alerts.Target
      description: The Attack's Target
    - contextPath: NSM.Alerts.MalwareFile
      description: Malware File used in the attack
    description: Update state or assignee of alerts
  - name: nsm-get-alert-details
    arguments:
    - name: alert_id
      required: true
      default: true
      description: Alert ID
    - name: sensor_id
      description: Sensor ID
    outputs:
    - contextPath: NSM.Alerts.ID
      description: Alert ID
      type: string
    - contextPath: NSM.Alerts.Name
      description: Alert Name
      type: string
    - contextPath: NSM.Alerts.State
      description: Alert State (Acknowledged,Unacknowledged)
      type: string
    - contextPath: NSM.Alerts.CreatedTime
      description: Alert Creation Time
      type: date
    - contextPath: NSM.Alerts.Assignee
      description: Alert assignee
      type: string
    - contextPath: NSM.Alerts.Description
      description: Alert Description
      type: string
    - contextPath: NSM.Alerts.EventResult
      description: Event Result
      type: string
    - contextPath: NSM.Alerts.Event
      description: Alert Event
    - contextPath: NSM.Alerts.Attack
      description: Alert's Attack
    - contextPath: NSM.Alerts.Attacker
      description: The Attacker who committed the attack
    - contextPath: NSM.Alerts.Target
      description: The Attack's target
    - contextPath: NSM.Alerts.MalwareFile
      description: Malware File used in the attack
      type: string
    - contextPath: NSM.Alerts.Details
      description: Extra details
    description: Get a single alert details
  - name: nsm-get-ips-policies
    arguments:
    - name: domain_id
      required: true
      default: true
      description: Domain ID
    outputs:
    - contextPath: NSM.IPSPolicies.ID
      description: IPS Policy ID
      type: number
    - contextPath: NSM.IPSPolicies.Name
      description: IPS Policy Name
      type: string
    - contextPath: NSM.IPSPolicies.DomainID
      description: IPS Policy Domain ID
      type: number
    - contextPath: NSM.IPSPolicies.IsEditable
      description: Whether the IPS policy is editable
      type: boolean
    - contextPath: NSM.IPSPolicies.VisibleToChildren
      description: Whether the IPS Policy is visible to domain's children
      type: boolean
    description: Get IPS Policies in a domain
  - name: nsm-get-ips-policy-details
    arguments:
    - name: policy_id
      required: true
      default: true
      description: IPS Policy ID
    outputs:
    - contextPath: NSM.IPSPolicies.ID
      description: IPS Policy ID
      type: number
    - contextPath: NSM.IPSPolicies.Name
      description: IPS Policy Name
      type: string
    - contextPath: NSM.IPSPolicies.Description
      description: IPS Policy information
      type: string
    - contextPath: NSM.IPSPolicies.CreatedTime
      description: Policy creation time
      type: string
    - contextPath: NSM.IPSPolicies.IsEditable
      description: Whether the IPS policy is editable
      type: boolean
    - contextPath: NSM.IPSPolicies.VisibleToChildren
      description: Whether the IPS Policy is visible to domain's children
      type: boolean
    - contextPath: NSM.IPSPolicies.Version
      description: IPS Policy Version
      type: number
    - contextPath: NSM.IPSPolicies.InboundRuleSet
      description: Inbound Rule Set
    - contextPath: NSM.IPSPolicies.OutboundRuleSet
      description: Outbound Rule Set
    - contextPath: NSM.IPSPolicies.ExploitAttacks
      description: A list of exploit attacks related to the IPS Policy
    description: Get the policy details for the specific IPS policy
  - name: nsm-get-attacks
    arguments:
    - name: attack_id
      default: true
      description: Particular Attack ID
    outputs:
    - contextPath: NSM.Attacks.ID
      description: Attack ID
      type: string
    - contextPath: NSM.Attacks.Name
      description: Attack Name
      type: string
    - contextPath: NSM.Attacks.Severity
      description: Attack Severity
      type: number
    - contextPath: NSM.Attacks.Direction
      description: Attack Direction
      type: string
    - contextPath: NSM.Attacks.Category
      description: Attack Category
      type: string
    description: Get all available attack definitions in NSM
  runonce: false
