commonfields:
  id: icebrg
  version: -1
name: icebrg
display: Icebrg
category: Network Security
image: data:image/png;base64,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
description: Reduces risk by accelerating threat detection, triage, and response to
  rapidly-evolving breaches across global networks.
configuration:
- display: Server URL for the search API (e.g. https://192.168.0.1)
  name: url_search
  defaultvalue: https://events.icebrg.io/v2/query
  type: 0
  required: false
- display: Server URL for the reports API (e.g. https://192.168.0.1)
  name: url_reports
  defaultvalue: https://report.icebrg.io/v1/reports
  type: 0
  required: false
- display: ICEBRG token
  name: token
  defaultvalue: ""
  type: 0
  required: true
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: "true"
  type: 8
  required: false
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: "false"
  type: 8
  required: false
script:
  script: |
    var auth = 'IBToken ' + params.token;
    var sendRequest = function(method, api, endpoint, body) {
        if (api == 'Search') {
            var url = params.url_search;
        } else {
            var url = params.url_reports;
        }
        endpoint = endpoint ? endpoint : '';
        var requestUrl = url.replace(/[\/]+$/, '') + '/' + endpoint;
        if (api === 'Reports' && !endpoint) {
            requestUrl = requestUrl + body;
            var res = http(
                requestUrl,
                {
                    Method: method,
                    Headers: {
                        'Authorization': [auth],
                        'Content-Type': ['application/json']
                    }
                },
                params.insecure,
                params.proxy
            );
        } else {
            var res = http(
                requestUrl,
                {
                    Method: method,
                    Headers: {
                        'Authorization': [auth],
                        'Content-Type': ['application/json']
                    },
                    Body: body ? JSON.stringify(body) : undefined
                },
                params.insecure,
                params.proxy
            );
        }

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }
        return JSON.parse(res.Body);
    };

    var responseToEntry = function (response, path, title) {
        var data=[];
        if (Array.isArray(response)) {
            resKeys = Object.keys(response[0]);
        } else {
            resKeys = Object.keys(response);
        }
        for (i = 0; i < resKeys.length; i++) {
            data.push({
                to : underscoreToCamelCase(resKeys[i]),
                from: resKeys[i]
            });
        }
        var translator = {
            contextPath: 'Icebrg.' + path,
            title: title,
            data: data
        };
        return createEntry(response, translator);
    };

    var uppercaseKeys = function(obj) {
        return {
            UserUuid: obj.user_uuid,
            Published: obj.published
        };
    };

    var fetchCommandIncidents = function(urlArgs) {

        incidents = [];
        var res = sendRequest('GET', 'Reports', undefined, urlArgs);
        if (res.reports) {
            res.reports.forEach(function(inc){
                if (inc.asset_count > 0) {
                    inc['origin'] = 'Reports';
                    var ind = reportIndicators(inc.uuid);
                    var asset = reportAssets(inc.uuid);
                    if (asset.EntryContext) {
                        inc['Assets'] = asset.EntryContext['Icebrg.ReportAssets'];
                    }
                    if (ind.EntryContext) {
                        inc['Indicators'] = ind.EntryContext['Icebrg.ReportIndicators'];
                    }
                    incidents.push({
                      name: 'Reports', 
                      rawJSON: JSON.stringify(inc)
                    });
                }
            });
        }
        return incidents;
    };

    var fetchIncidents = function() {

        var lastRun = getLastRun();
        nowDate = new Date();
        var now = nowDate.toISOString();
        if (!lastRun || !lastRun.value) {
            lastRun = {value: (new Date(nowDate.getTime() - 1*60*1000)).toISOString()};
        }

        var urlArgs = encodeToURLQuery({published_start : now});
        var incidents = fetchCommandIncidents(urlArgs);

        setLastRun({value: now});
        return JSON.stringify(incidents);
    };

    var reportAssets = function(uuid) {
        var endpt = uuid + '/assets';
        var response = sendRequest('GET', 'Assets', endpt);
        if (!response.assets || response.assets.length === 0) {
            return 'No assets'
        }
        return responseToEntry(response.assets, 'ReportAssets', 'Report Assets');
    };

    var reportIndicators = function(uuid) {
        var endpt = uuid + '/indicators';
        var response = sendRequest('GET', 'Reports', endpt);
        if (!response.indicators || response.indicators.length === 0) {
            return 'No indicators'
        }
        return responseToEntry(response.indicators, 'ReportIndicators', 'Report Indicators');
    };

    switch (command) {
        case 'test-module':
            sendRequest('GET', 'Reports', '', '');
            return 'ok';
        case 'fetch-incidents':
            return fetchIncidents();
        case 'icebrg-search-events':
            var response = sendRequest('POST', 'Search', undefined, args);
            delete response.aggregations;
            if (!args.query) {
                return 'No query given'
            }
            return responseToEntry(response, 'Events', 'Events');
        case 'icebrg-get-history':
            var response = sendRequest('GET', 'Search', 'history');
            for(i=0; i<response.history.length; i++) {
                response.history[i].UserId=response.user_id;
            }
            return responseToEntry(response.history, 'UserQueryHistory', 'History');
        case 'icebrg-saved-searches':
            var response = sendRequest('GET', 'Search', 'saved');
            if (response.saved_queries) {
                return 'No saved searches'
            }
            return responseToEntry(response, 'SavedSearches', 'Saved Searches');
        case 'icebrg-get-reports':
            var queryArgs = {};
            var argKeys = Object.keys(args);
            for(i=0; i<argKeys.length; i++) {
                queryArgs[argKeys[i]] = args[argKeys[i]];
            }
            var response = sendRequest('GET', 'Reports', undefined, encodeToURLQuery(queryArgs));
            for(i=0; i<response.reports.length; i++) {
                response.reports[i].publishes = easyDQ(response.reports[i], 'publishes', undefined, uppercaseKeys);
            }
            return responseToEntry(response.reports, 'Reports', 'Reports');
        case 'icebrg-get-report-indicators':
            return reportIndicators(args.report_uuid);
        case 'icebrg-get-report-assets':
            return reportAssets(args.report_uuid);
        default:
    }
  type: javascript
  commands:
  - name: icebrg-search-events
    arguments:
    - name: query
      required: true
      default: true
      description: The query string or entity for which to search.
    - name: start_date
      description: The beginning of the temporal extent by which to restrict filter
        results, inclusive.
    - name: end_date
      description: The end of the temporal extent by which to restrict filter results,
        exclusive.
    - name: limit
      description: A limit on the number of events returned in filter results. Default
        is 100. Max is 10000
    - name: order_by
      description: The event property by which to order results. Default is timestamp.
    - name: order
      description: The order of results, either asc or desc. Default is desc.
    - name: customer_id
      description: The customer ID by which to restrict filter results. Default is
        user account.
    - name: history
      description: When true, save this query in user Query History and include up
        to the last 50 queries from users Query History. Default is false.
    - name: service_traffic
      description: When true, the service will include the service_traffic aggregation.
        Default is false.
    outputs:
    - contextPath: Icebrg.Events.QueryType
      description: Query type
    - contextPath: Icebrg.Events.Total
      description: Total events
    - contextPath: Icebrg.Events.OrderBy
      description: Key to order events by
    - contextPath: Icebrg.Events.Order
      description: Order of the events
    - contextPath: Icebrg.Events.Offset
      description: Events offset
    - contextPath: Icebrg.Events.History
      description: History of events
    - contextPath: Icebrg.Events.Limit
      description: Limit number of events to show
    description: Perform an ICEBRG datastore event search
  - name: icebrg-get-history
    arguments: []
    outputs:
    - contextPath: Icebrg.UserQueryHistory.Total
      description: Total user queries
    - contextPath: Icebrg.UserQueryHistory.Timestamp
      description: Timestamp of user query
    - contextPath: Icebrg.UserQueryHistory.Query
      description: Called query
    - contextPath: Icebrg.UserQueryHistory.QueryId
      description: ID of query
    - contextPath: Icebrg.UserQueryHistory.UserId
      description: User ID
    description: Gets history of the events
  - name: icebrg-saved-searches
    arguments: []
    outputs:
    - contextPath: Icebrg.SavedSearches.Tags
      description: Query tags
    - contextPath: Icebrg.SavedSearches.Description
      description: Query description
    - contextPath: Icebrg.SavedSearches.Title
      description: Query title
    - contextPath: Icebrg.SavedSearches.Timestamp
      description: Query timestamp
    - contextPath: Icebrg.SavedSearches.Query
      description: Called query
    - contextPath: Icebrg.SavedSearches.Id
      description: Query ID
    description: Gets user saved searches
  - name: icebrg-get-reports
    arguments:
    - name: limit
      description: The maximum number of records to return. The default is no limit.
    - name: offset
      description: The number of records to skip past. The default is none.
    - name: sort_by
      description: The field to sort by created, updated, or published. The default
        is unsorted.
    - name: sort_order
      description: The sort order asc or desc. The default is asc if sort_by is provided.
    - name: account_uuid
      description: UUID of account to filter by.
    - name: archived
      description: Archived status to filter by.
    - name: confidence
      auto: PREDEFINED
      predefined:
      - low
      - moderate
      - high
      description: Confidence to filter by (low, moderate, high).
    - name: risk
      auto: PREDEFINED
      predefined:
      - low
      - moderate
      - high
      description: Risk to filter by (low, moderate, high).
    - name: search
      description: Text string to search on title and summary.
    - name: status
      description: Status to filter by.
    - name: published_start
      description: Published start date to filter by (inclusive). RFC3339 format,
        i.e. 2017-01-24T10:13:13.418Z
    - name: published_end
      description: Published end date to filter by (exclusive). RFC3339 format, i.e.
        2017-01-24T10:13:13.418Z
    outputs:
    - contextPath: Icebrg.Reports.Publishes.UserUuid
      description: User UUID that published the report
    - contextPath: Icebrg.Reports.Publishes.Published
      description: Timestamp of published report
    - contextPath: Icebrg.Reports.AssetCount
      description: Asset count of report
    - contextPath: Icebrg.Reports.IndicatorCount
      description: Indicator count of report
    - contextPath: Icebrg.Reports.Archived
      description: True if archived, else false
    - contextPath: Icebrg.Reports.Details
      description: Report details
    - contextPath: Icebrg.Reports.Summary
      description: Report summary
    - contextPath: Icebrg.Reports.Category
      description: Category of the report
    - contextPath: Icebrg.Reports.Confidence
      description: Confidence of report
    - contextPath: Icebrg.Reports.Risk
      description: Risk of report
    - contextPath: Icebrg.Reports.Title
      description: Report title
    - contextPath: Icebrg.Reports.Status
      description: Status of report
    - contextPath: Icebrg.Reports.AccountUuid
      description: Account UUID of report
    - contextPath: Icebrg.Reports.UpdatedUserUuid
      description: User UUID that updated the report
    - contextPath: Icebrg.Reports.CreatedUserUuid
      description: User UUID that created the report
    - contextPath: Icebrg.Reports.Updated
      description: Timestamp of report update
    - contextPath: Icebrg.Reports.Created
      description: Timestamp of report creation
    - contextPath: Icebrg.Reports.Uuid
      description: Report UUID
    description: Gets a list of reports
  - name: icebrg-get-report-indicators
    arguments:
    - name: report_uuid
      required: true
      default: true
      description: Report UUID to get indicator of
    outputs:
    - contextPath: Icebrg.ReportIndicators.Type
      description: Type of indicator
    - contextPath: Icebrg.ReportIndicators.Indicators.Observable
      description: Observable of Indicator
    description: Gets indicators for a reports
  - name: icebrg-get-report-assets
    arguments:
    - name: report_uuid
      required: true
      default: true
      description: Report UUID to get asset of
    outputs:
    - contextPath: Icebrg.ReportAssets.Asset
      description: Assets of Report UUID
    description: Gets impacted assets for a report
  isfetch: true
tests:
- Icebrg Test