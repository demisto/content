commonfields:
  id: McAfee Advanced Threat Defense
  version: -1
name: McAfee Advanced Threat Defense
fromversion: 2.0.4
toversion: 3.1.0
display: McAfee Advanced Threat Defense
category: Forensics & Malware Analysis
image: data:image/png;base64,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
description: 'Integrated advanced threat detection: Enhancing protection from network
  edge to endpoint'
detaileddescription: |
  When entering a is a user to use the API with, please make sure the user has capability of "Allow Multiple Logins".
configuration:
- display: Server URL (e.g. https://192.168.0.1)
  name: baseUrl
  defaultvalue: ""
  type: 0
  required: true
- display: username
  name: username
  defaultvalue: ""
  type: 0
  required: true
- display: password
  name: password
  defaultvalue: ""
  type: 4
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: "true"
  type: 8
  required: false
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |2-

    var base = params.baseUrl;

    var getSession = function() {
        res = sendRequest('/php/session.php','GET', loginHeaders);
        if (res) {
            return res.results;
        }
    };


    // handle '/' at the end of the url
    if (base[base.length - 1] === '/') {
        base = base.substring(0, base.length - 1);
    }

    var username = params.username;
    var password = params.password;
    var insecure = params.insecure;
    var proxy = params.proxy;

    var loginHeaders = {'Accept': ['application/vnd.ve.v1.0+json'], 'Content-Type': ['application/json'], 'VE-SDK-API':[Base64.encode(username + ':' + password)]};

    var heartbeatHeaders = {'Accept': ['application/vnd.ve.v1.0+json'], 'Content-Type': ['application/json']};

    var verifyHash = function() {
        var body = {};
        holder = {};
        holder.md5 = args.hash;
        body.data = JSON.stringify(holder);
        return sendRequest('/php/atdHashLookup.php','POST', getHeaders(), body);
    };

    var listUsers = function() {
        var userType = 'STAND_ALONE';
        if (args.userType) {
            userType = args.userType;
        }
        var result = sendRequest('/php/briefUserList.php?userType='+userType,'GET', getHeaders());

        var md = tableToMarkdown('ATD User List',result.results);
        return {Type: entryTypes.note,
              Contents: JSON.stringify(result),
              ContentsFormat: formats.json,
              HumanReadable: md
        };
    };

    var listProfiles = function() {
        var result =  sendRequest('/php/vmprofiles.php','GET', getHeaders());
        var md = tableToMarkdown('ATD VM Profile List',result.results,['name','vmProfileid','vmDesc','sandbox','summary','internet','locBlackList']);
        return {Type: entryTypes.note,
              Contents: JSON.stringify(result),
              ContentsFormat: formats.json,
              HumanReadable: md
        };
    };

    var heartBeat = function() {
        return sendRequest('/php/heartbeat.php','GET', getHeaders(), heartbeatHeaders);
    };

    var getTaskIDs = function() {
        return sendRequest('/php/getTaskIdList.php?jobId='+args.jobId,'GET', getHeaders());
    };

    var buildReportContext = function(reportSummary) {
        var context = {};
        if ((reportSummary) && (reportSummary.Subject)) {
            var subject = reportSummary.Subject;
            context = { DBotScore: {Vendor: 'McAfee-Advanced-Threat-Defense', Score: 0 }};
            if ( subject.FileType ) {//file
                context.DBotScore.Indicator = subject.md5;
                context.DBotScore.Type = 'hash';
                if (reportSummary.Verdict.Severity > 3) {
                    context.DBotScore.Score = 3;
                    addMalicious(context, outputPaths.file, {
                        Type : subject.Type,
                        MD5 : subject.md5,
                        SHA1 : subject['sha-1'],
                        SHA256 : subject['sha-256'],
                        Size : subject.size,
                        Name : subject.Name,
                        Malicious: {Vendor: 'McAfee-Advanced-Threat-Defense',
                            Description: 'Severity: ' + reportSummary.Verdict.Severity}
                    });
                } else {
                    context.DBotScore.Score = 1;
                }
            }
        }

        return context;
    };

    var getReport = function() {
        uriSuffix = jobOrTaskId();
        if ((args.type) && ( (args.type === 'table') || (args.type === 'json') )) {
            var res = sendRequest('/php/showreport.php?'+uriSuffix+'&iType=json', 'GET', getHeaders());
            var resString = JSON.stringify(res);

            var summary = res.Summary;
            summary.VerdictDescription = summary.Verdict.Description;
            summary.VerdictSeverity = summary.Verdict.Severity ;
            var context = buildReportContext(summary);
            summary = formatTableValues(summary);
            var md = resToMD(summary,'ATD Sandbox Report');

            return {
                Type: entryTypes.note,
                Contents: resString,
                ContentsFormat: formats.json,
                HumanReadable: md,
                EntryContext: context
            };
        }
        if (args.type === 'pdf') {
            if (!getSession().isAdmin) {
                return 'No permission to download PDF'
            }
            var filename = args.jobId;
            if ((!filename) || (filename.length === 0)) {
                filename = args.taskId;
            }
            filename = filename + '.pdf';
            return downloadReport('/php/showreport.php?'+uriSuffix+'&iType='+args.type, 'GET', getHeaders(), filename);
        }
        if (args.type === 'sample') {
            var permissionCheck = sendRequestRaw('/php/showreport.php?'+uriSuffix+'&iType='+args.type, 'GET', getHeaders());
            if (permissionCheck.substring(11,16) === 'false') {
                return 'No permission to download sample'
            }
            var filename = args.jobId;
            if ((!filename) || (filename.length === 0)) {
                filename = args.taskId;
            }
            filename = filename + '.zip';
            return downloadReport('/php/showreport.php?'+uriSuffix+'&iType='+args.type, 'GET', getHeaders(), filename);
        }
        return sendRequestRaw('/php/showreport.php?'+uriSuffix+'&iType='+args.type, 'GET', getHeaders());
    };


    var getTaskStatus = function() {
        uriSuffix = jobOrTaskId();

        var res = sendRequest('/php/samplestatus.php?'+uriSuffix,'GET', getHeaders());

        var status = res.status;
        resForMd = res;
        if ((res) && (res.results)) { // when you use TaskID, you get results in res.results
            resForMd = res.results;
            status = res.results.status;
        }
        var md = resToMD(resForMd,'ATD Sandbox Task Status');
        return {Type: entryTypes.note,
              Contents: JSON.stringify(res),
              ContentsFormat: formats.json,
              HumanReadable: md,
              EntryContext: {"ATD.status": status}
        };
    };

    var jobOrTaskId = function() {
        uriSuffix = '';
        if ((args.jobId) && (args.jobId.length > 0)) {
            uriSuffix = 'jobId='+ args.jobId;
        }
        if (args.taskId) {
            uriSuffix = 'iTaskId='+ args.taskId;
        }

        return uriSuffix;
    };

    var getBulkStatus = function() {
        var body = {};
        var data = {};

        data.data = {};
        data.data.bulkrequest = {};
        var total = 0;
        if (args.jobIDs) {
            data.data.bulkrequest.jobIDs = stringArrToIntArr(args.jobIDs.split(","));
            total = data.data.bulkrequest.jobIDs.length;
        }
        if (args.taskIDs) {
            data.data.bulkrequest.taskIDs = stringArrToIntArr(args.taskIDs.split(","));
            total = total + data.data.bulkrequest.taskIDs.length;
        }
        data.data.bulkrequest.numRequest = total;
        body.data = JSON.stringify(data);
        return sendRequest('/php/getBulkStatus.php','POST', getHeaders(), body.data);
    };

    var stringArrToIntArr = function(stringArr){
        var intArr = [];
        for (index = 0; index < stringArr.length; ++index) {
            intArr.push(parseInt(stringArr[index]));
        }
        return intArr;
    }

    var resToMD = function(body, title) {
        return tblToMd(title, body, Object.keys(body));
    };

    var castToInt = function(val) {
        if (typeof val === 'string') {
            return parseInt(val);
        } else {
            return val;
        }
    };

    var fileUpload = function() {
        var body = {};
        body.data = {};

        data = {};
        data.data = {};
        data.data.vmProfileList = castToInt(args.vmProfileList);
        data.data.submitType = castToInt(args.submitType);

        data.data.url = args.url;
        data.data.messageId = args.messageId;
        data.data.srcIp = args.srcIp;
        data.data.destIp = args.destIp;
        if (args.skipTaskId) {
            data.data.skipTaskId = castToInt(args.skipTaskId);
        }
        if (args.analyzeAgain) {
            data.data.analyzeAgain = castToInt(args.analyzeAgain);
        }
        if (args.xMode) {
            data.data.xMode = castToInt(args.xMode);
        }
        data.filePriorityQ = args.filePriorityQ;
        if (!data.filePriorityQ) {
            data.filePriorityQ = 'run_now';
        }
        body.data = JSON.stringify(data);
        var result =  uploadFile(body,args.entryID);

        var resultObj = JSON.parse(result);
        var results = resultObj.results;
        var taskId = '';
        if ((results) && (results.length > 0)) {
            var subId = resultObj.subId;
            resultObj = results[0];
            taskId = resultObj.taskId;
            resultObj.subId = subId;// need subId too sometimes
            if (taskId === -1) {
                taskId = subId;
            }
        }
        var md = resToMD(resultObj,'ATD sandbox file upload');
        return {Type: entryTypes.note,
              Contents: result,
              ContentsFormat: formats.json,
              HumanReadable: md,
              EntryContext: {"ATD.taskId": taskId}
        };
    };

    var uploadFile = function(body,fileParam) {
        uri = '/php/fileupload.php'
        filenameDq = dq(invContext, 'File(val=val.EntryID==="' + fileParam +'")=val.Name')
        filename = undefined
        if (filenameDq && filenameDq[0]) {
            filename = filenameDq[0]
        }
        res = httpMultipart(
            base+uri,
            fileParam,
            {
                Method: 'POST',
                Headers: getHeaders(),
            },
            body,
            insecure,
            proxy,
            false,
            'amas_filename',
            filename
        );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Failed to use uri ' + base+uri + ', request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }
        var b = res.Body;
        var uriStr = String(uri);
        if (uriStr.indexOf("session") === -1) {
            logout();
        }
        return b;
    };

    var logout = function() {
        res = sendRequest('/php/session.php','DELETE', getHeaders());
        if (res) {
            return res.results;
        }
    };

    var getHeaders = function() {
        var sess = getSession();
        return {'Accept': ['application/vnd.ve.v1.0+json'],'VE-SDK-API':[Base64.encode(sess.session + ':' + sess.userId)]};
    };

    var sendRequestRaw = function(uri, method, headers, body) {
        var res = http(
                base+uri,
                {
                    Method: method,
                    Headers: headers,
                    Body: body
                },
                insecure,
                proxy
            );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Failed to use uri ' + base+uri + ', request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
        }
        var uriStr = String(uri);
        if (uriStr.indexOf("session") === -1) {
            logout();
        }
        return res.Body;
    };

    var downloadReport = function(uri,method, headers, filename) {
        var res = sendRequestRaw(uri, method, headers);
        return {
            Type: 9,
            FileID: saveFile(res),
            File: filename,
            Contents: filename
        };
    }

    var sendRequest = function(uri, method, headers, body) {
        var body = sendRequestRaw(uri,method, headers, body);
        var res = JSON.parse(body);
        if (res.success) {
            if (res.success === 'false') {
                throw 'ATD Api call to '+uri+' failed with body: '+body;
            }
        }
        return res;
    };

    // The command input arg holds the command sent from the user.
    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            getSession();
            return 'ok';
        case 'atd-login':
            return getSession();
        case 'atd-file-upload':
            return fileUpload();
        case 'atd-get-task-ids':
            return getTaskIDs();
        case 'atd-get-bulk-status':
            return getBulkStatus();
        case 'atd-check-status':
            return getTaskStatus();
        case 'atd-get-report':
            return getReport();
        case 'atd-list-analyzer-profiles':
            return listProfiles();
        case 'atd-list-user':
            return listUsers();
        case 'atd-verify-blacklisted-whitelisted-hashs':
            return verifyHash();
        default:
    }
  type: javascript
  commands:
  - name: atd-file-upload
    arguments:
    - name: vmProfileList
      description: Analyzer profile ID. The profile ID number can be found in the
        UI Policy/Analyzer Profile page, OR using command atd-list-analyzer-profiles,
        under vmProfileid key result
    - name: submitType
      required: true
      auto: PREDEFINED
      predefined:
      - "0"
      - "1"
      - "2"
      - "3"
      description: This parameter accepts four values — '0', '1', '2' and '3'. • 0
        — Regular file upload • 1 — URL submission — URL link is processed inside
        analyzer VM • 2 — Submit file with URL • 3 — URL Download — File from URL
        is firstly downloaded and then analyzed
    - name: url
      description: Any valid web URL.
    - name: messageId
      description: Maximum 128-character string.
    - name: srcIp
      description: ' IPv4 address of the source system or gateway from where the file
        is downloaded.'
    - name: dstIp
      description: ' IPv4 address of the target endpoint.'
    - name: skipTaskId
      auto: PREDEFINED
      predefined:
      - "0"
      - "1"
      description: Value '0' indicates corresponding taskid in API response. Value
        '1' indicates -1 as taskid in API response.
    - name: analyzeAgain
      auto: PREDEFINED
      predefined:
      - "0"
      - "1"
      description: Value '0' indicates skip sample analysis if it is analyzed previously
        . Value '1' indicates do not skip sample analysis if it is not analyzed previously.
    - name: xMode
      auto: PREDEFINED
      predefined:
      - "0"
      - "1"
      description: Value '0' indicates no user interaction is needed during sample
        analysis. Value '1' indicates user interaction is needed during sample analysis.
    - name: filePriorityQ
      auto: PREDEFINED
      predefined:
      - run_now
      - add_to_q
      description: ' This parameter indicates priority of sample analysis. run_now
        assigns highest priority (i.e., sample is analyzed right away), add_to_q puts
        sample in waiting state if there is a waiting queue of samples, default is
        run_now'
    - name: entryID
      description: entry ID
    outputs:
    - contextPath: ATD.taskId
      description: The task ID of the file upload
    description: upload a file/web URL for dynamic analysis by using the provided
      Analyzer Profile. Only single file/web URL can be submitted at a time.
  - name: atd-get-task-ids
    arguments:
    - name: jobId
      required: true
      default: true
      description: Serves as an identifier for the previously submitted file.
    description: fetches the list of task id's associated with a job id
  - name: atd-check-status
    arguments:
    - name: taskId
      description: This is the returned TaskId value in the submission step, previously
        returned value in the File/URL submission step
    - name: jobId
      description: Job id
    outputs:
    - contextPath: ATD.status
      description: The task ID statues (Completed or Analyzing)
    description: checks the analysis status
  - name: atd-get-report
    arguments:
    - name: taskId
      description: This is the returned TaskId value in the submission step, previously
        returned value in the File/URL submission step
    - name: jobId
      description: Job id
    - name: type
      required: true
      auto: PREDEFINED
      predefined:
      - html
      - txt
      - xml
      - zip
      - table
      - ioc
      - stix
      - pdf
      - sample
      description: 'iType can be one of the following types: • html — HTML report
        • txt — Text report • xml — XML report • zip — All files packaged in a single
        zip file • json — Same as xml but in the JSON format • ioc - Indicators of
        Compromise format • stix - Structured Threat Information expression. Stix
        generation is disabled, by default. Use set stixreportstatus enable to enable
        it. • pdf - Portable Document Format • sample - Download sample from McAfee
        Advanced Threat Defense'
    outputs:
    - contextPath: File.Name
      description: Filename (only in case of report type=json)
    - contextPath: File.Type
      description: File type e.g. "PE" (only in case of report type=json)
    - contextPath: File.Size
      description: File size (only in case of report type=json)
    - contextPath: File.MD5
      description: MD5 hash of the file (only in case of report type=json)
    - contextPath: File.SHA1
      description: SHA1 hash of the file (only in case of report type=json)
    - contextPath: File.SHA256
      description: SHA256 hash of the file (only in case of report type=json)
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision
    - contextPath: File.Malicious.Description
      description: For malicious files, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested (only in case of report type=json)
    - contextPath: DBotScore.Type
      description: The type of the indicator (only in case of report type=json)
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score (only in case of report type=json)
    - contextPath: DBotScore.Score
      description: The actual score (only in case of report type=json)
    description: ' download the analysis report files'
  - name: atd-list-analyzer-profiles
    arguments: []
    description: ' display the analyzer profiles. Only the analyzer profiles to which
      the user has access are displayed.'
  - name: atd-list-user
    arguments:
    - name: userType
      default: true
      description: This is the user type associated with a user profile. For example
        NSP, MWG, STAND_ALONE (default) and so on.
    description: ' displays the user profile information present on the McAfee Advanced
      Threat Defense.'
  - name: atd-login
    arguments: []
    description: Returns a logon result for ATD
hidden: false
