commonfields:
  id: jira
  version: -1
name: jira
display: Atlassian Jira
category: Case Management
toversion: 2.5.0
image: data:image/png;base64,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
description: Issue tracking product, developed by Atlassian
detaileddescription: "For fetching incidents, please update the query param according
  to JQL: https://confluence.atlassian.com/jirasoftwarecloud/advanced-searching-764478330.html\nUpdate
  there the project you want to fetch from like:  \"project = soc AND  status=open\".\nThis
  will fetch for first time all tickets in your system (include past) that are in
  open status and in project soc, after first run, it will create incident only for
  new tickets,\nIf you wish to start in first time from a specific position, use \"Issue
  index to start fetching incidents from\" param.\n\nyou can also fetch incidents
  by time (by issues created field) by turning on the  \"Use created field to fetch
  incidents\" field, instead of using id's.  \n"
configuration:
- display: Jira URL, in the format https://demisto.atlassian.net/
  name: url
  defaultvalue: ""
  type: 0
  required: true
- display: Username
  name: username
  defaultvalue: ""
  type: 0
  required: true
- display: Password
  name: password
  defaultvalue: ""
  type: 4
  required: true
- display: Allow insecure HTTP
  name: insecure
  defaultvalue: "true"
  type: 8
  required: false
- display: Query for fetching incident in JQL
  name: query
  defaultvalue: status=open
  type: 0
  required: false
- display: Issue index to start fetching incidents from
  name: idOffset
  defaultvalue: "10000"
  type: 0
  required: false
- display: Fetch incidents
  name: isFetch
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  defaultvalue: ""
  type: 13
  required: false
- display: Use created field to fetch incidents
  name: fetchByCreated
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |-
    // handle '/' at the end of the url
    if (params.url[params.url.length - 1] != '/') {
        params.url = params.url + '/';
    }
    var getCookies = function() {
        var result = http(
            params.url+'rest/auth/1/session',
            {
                Headers: {'Content-Type': ['application/json']},
                Method: 'POST',
                Username: params.username,
                Password: params.password,
                Body: JSON.stringify({'username':params.username,'password':params.password}),
            },
            params.insecure
        );
        if (result.StatusCode !== 200 && result.StatusCode !== 201) {
            throw 'Failed to create auth cookie, request status code: ' + result.StatusCode + ', check that username/password are correct';
        }
        return result.Cookies;
    };

    var addQueryParam = function(urlSuffix, paramName, value){
        if (value && value.length > 0){
            urlSuffix = urlSuffix + '&' + paramName + '=' + value;
        }
        return urlSuffix;
    };

    var uploadFile = function(entryId, issueId) {
        var cookies = getCookies();
        var res = httpMultipart(
            params.url+'rest/api/2/issue/' + issueId + '/attachments',
            entryId,
            {
                Method: 'POST',
                Cookies: cookies,
                Username: params.username,
                Password: params.password,
                Headers: {'X-Atlassian-Token': ['no-check']},
            },
            {
            },
            params.insecure
        );
        if (res.StatusCode !== 200) {
            return 'Failed to execute request:' + res.StatusCode + ', body: ' + res.Body;
        }
        return JSON.parse(res.Body);
    };
    var runQuery = function(query, startAt, maxResults) {
        var cookies = getCookies();
        var url = params.url+'rest/api/2/search?jql='+encodeURIComponent(query);
        url = addQueryParam(url,'startAt',startAt);
        url = addQueryParam(url,'maxResults',maxResults);
        var result = http(
            url,
            {
                Headers: {'Content-Type': ['application/json']},
                Method: 'GET',
                Username: params.username,
                Password: params.password,
                Cookies: cookies,
            },
            params.insecure
        );
        if (result.StatusCode !== 200) {
            throw 'Failed to jira-issue-query, request status code: ' + result.StatusCode + ', body: ' + result.Body;
        }
        return JSON.parse(result.Body);
    };


    var cleanNullFields = function(obj) {
        for(prop in obj){
            if(obj[prop] === null || obj[prop] === undefined || obj[prop] ==="" )
            delete obj[prop];
        }
        return obj;
    }


    var generateMDContextGetIssue = function(data) {
        var getIssueObj = {md: [] , context: {Ticket: []}};
        if(!Array.isArray(data)) {
            data = [data];
        }
        data.forEach(function (element) {
            mdObj ={};
            contextObj = {};

            var id = dq(element, 'id');
            mdObj['id'] = id;
            contextObj['Id'] = id;

            var key = dq(element, 'key');
            mdObj['key'] = key;
            contextObj['Key'] = key;

            var assignee = dq(element, 'fields.assignee.displayName') + "(" + dq(element, 'fields.assignee.emailAddress') + ")";
            mdObj['assignee'] = assignee;
            contextObj['Assignee'] = assignee;

            mdObj['reporter'] = dq(element, 'fields.reporter.displayName') + "(" + dq(element, 'fields.reporter.emailAddress') + ")";

            var creator = dq(element, 'fields.creator.displayName') + "(" + dq(element, 'fields.creator.emailAddress') + ")";
            mdObj['creator'] = creator;
            contextObj['Creator'] = creator;

            var summary = dq(element, 'fields.summary');
            mdObj['summary'] = summary;
            contextObj['Summary'] = summary;

            var status = dq(element, 'fields.status.name')
            mdObj['status'] = status;
            contextObj['Status'] = status;

            mdObj['issueType'] = dq(element, 'fields.issuetype.description');
            mdObj['priority'] = dq(element, 'fields.priority.name');
            mdObj['project'] = dq(element, 'fields.project.name');
            mdObj['labels'] = dq(element, 'fields.labels');
            mdObj['description'] = dq(element, 'fields.description');
            mdObj['duedate'] = dq(element, 'fields.duedate');
            mdObj['ticket_link'] = dq(element, 'self');
            mdObj['creted'] = dq(element, 'fields.created');
            var attachments = dq(element, 'fields.attachment');
            if(Array.isArray(attachments) && attachments.length > 0) {
                var attachmentNames = [];
                attachments.forEach(function (attach) {
                    attachmentNames.push(attach['filename']);
                });
                mdObj['attachment'] = attachmentNames.join();
            }
            getIssueObj['md'].push(mdObj);
            getIssueObj['context'].Ticket.push(contextObj);
        });
        return getIssueObj;
    }

    var generateMdContextCreateIssue = function(data) {
        var createIssueObj = {md: [] , context: {Ticket: []}};
        if (args.projectName && args.projectName.length > 0 ){
            data.projectName = args.projectName;
        }
        if (args.projectKey && args.projectKey.length > 0 ){
            data.projectKey = args.projectKey;
        }
        createIssueObj['md'].push(data);
        var id = dq(data, 'id');
        createIssueObj['context'].Ticket.push({Id: id});
        return createIssueObj;
    }


    var generateMdCommentOrLinkIssue = function(data) {
        var commentOrLinkMd = [];
        if(!Array.isArray(data)) {
            data = [data];
        }
        data.forEach(function (element) {
            mdObj ={};
            mdObj['id'] = dq(element, 'id');
            mdObj['key'] = dq(element, 'updateAuthor.key');
            mdObj['commnet'] = dq(element, 'body');
            mdObj['ticket_link'] = dq(element, 'self');
            commentOrLinkMd.push(mdObj);
        });
        return commentOrLinkMd;
    }

    var generateMdUplosdIssue = function(data) {
        var uploadMd = [];
        if(!Array.isArray(data)) {
            data = [data];
        }
        data.forEach(function (element) {
            mdObj ={};
            mdObj['id'] = dq(element, 'id');
            mdObj['issueId'] = args.issueId;
            mdObj['attachment_name'] = dq(element, 'filename');
            mdObj['attachment_link'] = dq(element, 'self');
            uploadMd.push(mdObj);
        });
        return uploadMd;
    }


    var createIncidentFromTicket = function(issue) {
        var keys = Object.keys(issue);
        var labels = [];

        labels.push({'type': 'issue', 'value': JSON.stringify(issue)});
        //Send specific issue information only
        //log ('id = ' + String(issue.id));
        labels.push({'type': 'id', 'value': String(issue.id)});

        //log ('lastViewed = ' + String(issue.fields.lastViewed));
        labels.push({'type': 'lastViewed', 'value': String(issue.fields.lastViewed)});

        //log ('Priority = ' + String(issue.fields.priority.name));
        labels.push({'type': 'priority', 'value': String(issue.fields.priority.name)});

        //log ('status = ' + String(issue.fields.status.name));
        labels.push({'type': 'status', 'value': String(issue.fields.status.name)});

        //log ('project = ' + String(issue.fields.project.name));
        labels.push({'type': 'project', 'value': String(issue.fields.project.name)});

        //log ('updated = ' + String(issue.fields.updated));
        labels.push({'type': 'updated', 'value': String(issue.fields.updated)});

        //log ('reporter name = ' + String(issue.fields.reporter.displayName));
        labels.push({'type': 'reportername', 'value': String(issue.fields.reporter.displayName)});

        //log ('reporter email =  = ' + String(issue.fields.reporter.emailAddress));
        labels.push({'type': 'reporteremail', 'value': String(issue.fields.reporter.emailAddress)});

        //log ('created = ' + String(issue.fields.created));
        labels.push({'type': 'created', 'value': String(issue.fields.created)});

        //log ('summary = ' + String(issue.fields.summary));
        labels.push({'type': 'summary', 'value': String(issue.fields.summary)});

        //log ('description = ' + String(issue.fields.description));
        labels.push({'type': 'description', 'value': String(issue.fields.description)});

        var name = issue.fields.summary;
        if (name.length === 0) {
            name = "Jira issue: "+String(issue.id);
        }
        var severity = 0;
        if (issue.fields.priority && issue.fields.priority.name && issue.fields.priority.name.length > 0 ){
            if (issue.fields.priority.name === 'Highest') {
                severity = 4;
            }
            if (issue.fields.priority.name === 'High') {
                severity = 3;
            }
            if (issue.fields.priority.name === 'Medium') {
                severity = 2;
            }
            if (issue.fields.priority.name === 'Low') {
                severity = 1;
            }
        }
        return {
            "name": name,
            "labels": labels,
            "details": issue.fields.description,
            "severity": severity
        };
    };


    // The command input arg holds the command sent from the user.
    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            var cookies = getCookies();
            return  (typeof cookies !== undefined);
        case 'jira-get-issue':
            var cookies = getCookies();
            var result = http(
                params.url+'rest/api/2/issue/'+args.issueId,
                {
                    Headers: {'Content-Type': ['application/json']},
                    Method: 'GET',
                    Username: params.username,
                    Password: params.password,
                    Cookies: cookies,
                },
                params.insecure
            );
            if (result.StatusCode !== 200) {
                throw 'Failed to jira-get-issue, request status code: ' + result.StatusCode + ', body: ' + result.Body;
            }
            var jRes = JSON.parse(result.Body);
            var mdAndContext = generateMDContextGetIssue(jRes);
            md = tblToMd(command, mdAndContext['md'],argToList(args.headers));
            return {Type: entryTypes.note, Contents: jRes, ContentsFormat: formats.json, HumanReadable: md, ReadableContentsFormat: formats.markdown, EntryContext: mdAndContext['context']};
        case 'jira-issue-query':
            var jRes = runQuery(args.query,args.startAt,args.maxResults);
            var issues = dq(jRes,'issues');
            var mdAndContext = generateMDContextGetIssue(issues);
            md = tblToMd(command, mdAndContext['md'], argToList(args.headers));
            return {Type: entryTypes.note, Contents: jRes, ContentsFormat: formats.json, HumanReadable: md, ReadableContentsFormat: formats.markdown, EntryContext:  mdAndContext['context']};
        case 'jira-create-issue':
            var cookies = getCookies();
            var url = params.url+'rest/api/2/issue/';
            var issue = {};
            if (args.issueJson){
                issue = JSON.parse(args.issueJson);
            }
            if (!issue.fields) {
                issue.fields= {};
            }
            if (!issue.fields.project) {
                issue.fields.project= {};
            }
            if (!issue.fields.issuetype) {
                issue.fields.issuetype = {};
            }
            if (args.summary && args.summary.length >0 ){
                issue.fields.summary = args.summary;
            }
            if (args.projectKey && args.projectKey.length > 0 ){
                issue.fields.project.key = args.projectKey;
            }
            if (args.projectName && args.projectName.length > 0 ){
                issue.fields.project.name = args.projectName;
            }
            if (args.issueTypeName && args.issueTypeName.length > 0 ){
                issue.fields.issuetype.name = args.issueTypeName;
            }
            if (args.issueTypeId && args.issueTypeId.length > 0 ){
                issue.fields.issuetype.id = args.issueTypeId;
            }
            if (args.description && args.description.length > 0 ){
                issue.fields.description = args.description;
            }
            if (args.labels && args.labels.length > 0 ){
                issue.fields.labels = args.labels.split(",");
            }
            if (args.priorityName && args.priorityName.length > 0 ){
                if (!issue.fields.priority) {
                    issue.fields.priority = {};
                }
                issue.fields.priority.name = args.priorityName;
            }
            if (args.dueDate && args.dueDate.length > 0 ){
                issue.fields.duedate = args.dueDate;
            }
            if (args.assignee && args.assignee.length > 0 ){
                if (!issue.fields.assignee) {
                    issue.fields.assignee = {};
                }
                issue.fields.assignee.name = args.assignee;
            }
            if (args.reporter && args.reporter.length > 0 ){
                if (!issue.fields.reporter) {
                    issue.fields.reporter = {};
                }
                issue.fields.reporter.name = args.reporter;
            }
            var result = http(
                url,
                {
                    Headers: {'Content-Type': ['application/json']},
                    Method: 'POST',
                    Username: params.username,
                    Password: params.password,
                    Cookies: cookies,
                    Body: JSON.stringify(issue),
                },
                params.insecure
            );
            if (result.StatusCode !== 201) {
                throw 'Failed to jira-create-issue, request status code: ' + result.StatusCode + ', body: ' + result.Body;
            }
            var jRes = JSON.parse(result.Body);
            var mdAndContext = generateMdContextCreateIssue(jRes);
            var md = tblToMd(command, mdAndContext['md'], "");
            return {Type: entryTypes.note, Contents: jRes, ContentsFormat: formats.json, HumanReadable: md, ReadableContentsFormat: formats.markdown, EntryContext: mdAndContext['context']};
        case 'jira-issue-upload-file':

            var jRes = uploadFile(args.upload, args.issueId);
            var md = generateMdUplosdIssue(jRes);
            md = tblToMd(command, md, "");
            return {Type: entryTypes.note, Contents: jRes, ContentsFormat: formats.json, HumanReadable: md, ReadableContentsFormat: formats.markdown};
        case 'jira-issue-add-comment':
            var cookies = getCookies();
            var url = params.url+'rest/api/2/issue/'+ args.issueId + '/comment';
            var comment = {};
            comment.body = args.comment;
            if (args.visibility && args.visibility.length > 0 ){
                comment.visibility = {};
                comment.visibility.type = 'role';
                comment.visibility.value = args.visibility;
            }
            var result = http(
                url,
                {
                    Headers: {'Content-Type': ['application/json']},
                    Method: 'POST',
                    Username: params.username,
                    Password: params.password,
                    Cookies: cookies,
                    Body: JSON.stringify(comment),
                },
                params.insecure
            );
            if (result.StatusCode !== 201) {
                throw 'Failed to jira-issue-add-comment, request status code: ' + result.StatusCode + ', body: ' + result.Body;
            }
            var jRes = JSON.parse(result.Body);
            var md = generateMdCommentOrLinkIssue(jRes)
            md = tblToMd(command, md, "");
            return {Type: entryTypes.note, Contents: jRes, ContentsFormat: formats.json, HumanReadable: md, ReadableContentsFormat: formats.markdown};
        case 'jira-issue-add-link':
            var cookies = getCookies();
            var url = params.url+'rest/api/2/issue/'+ args.issueId + '/remotelink';
            var link = {};
            link.object = {};
            link.object.url = args.url;
            link.object.title = args.title;
            if (args.summary && args.summary.length > 0 ){
                link.summary = args.summary;
            }
            if (args.globalId && args.globalId.length > 0 ){
                link.globalId = args.globalId;
            }
            if (args.relationship && args.relationship.length > 0 ){
                link.relationship = args.relationship;
            }
            if (args.relationship && args.relationship.length > 0 ){
                link.relationship = args.relationship;
            }
            var result = http(
                url,
                {
                    Headers: {'Content-Type': ['application/json']},
                    Method: 'POST',
                    Username: params.username,
                    Password: params.password,
                    Cookies: cookies,
                    Body: JSON.stringify(link),
                },
                params.insecure
            );
            if (result.StatusCode !== 201) {
                throw 'Failed to jira-issue-add-comment, request status code: ' + result.StatusCode + ', body: ' + result.Body;
            }
            var jRes = JSON.parse(result.Body);
            var md = generateMdCommentOrLinkIssue(jRes)
            md = tblToMd(command, jRes, "");
            return {Type: entryTypes.note, Contents: jRes, ContentsFormat: formats.json, HumanReadable: md, ReadableContentsFormat: formats.markdown};
        case 'fetch-incidents':
            var lastRun = getLastRun();
            var idOffset = lastRun && lastRun.idOffset ? lastRun.idOffset : params.idOffset;
            var incidents = [];
            var maxResults = 50;
            var query = params.query + ' and id > ' + String(idOffset)
            if (params.fetchByCreated) {
              query = params.query + ' and created>-1m'
            }
            var res = runQuery(query,'',maxResults)
            for (var i = 0; i < res.issues.length; i++) {
                var ticket = res.issues[i];
                idOffset = Math.max(idOffset, ticket.id);
                incidents.push(createIncidentFromTicket(ticket));
            }
            setLastRun({idOffset: idOffset});
            return JSON.stringify(incidents);
        default:
    }
  type: javascript
  commands:
  - name: jira-issue-query
    arguments:
    - name: query
      required: true
      default: true
      description: JQL query string
    - name: startAt
      description: The index of the first issue to return (0-based) - format int
    - name: maxResults
      description: the maximum number of issues to return (defaults to 50). The maximum
        allowable value is dictated by the JIRA property 'jira.search.views.default.max'.
        If you specify a value that is higher than this number, your search results
        will be truncated.
    - name: headers
      description: Headers to display in Human readable format
    outputs:
    - contextPath: Ticket.Id
      description: Id of ticket
    - contextPath: Ticket.Key
      description: Key of ticket
    - contextPath: Ticket.Assignee
      description: User assigned to ticket
    - contextPath: Ticket.Creator
      description: User who created the ticket
    - contextPath: Ticket.Summary
      description: Summary of ticket
    - contextPath: Ticket.Status
      description: Status of ticket
    description: Query Jira issues
  - name: jira-get-issue
    arguments:
    - name: issueId
      required: true
      default: true
      description: Issue id
    - name: headers
      description: Headers to display in Human readable format
    outputs:
    - contextPath: Ticket.Id
      description: Id of ticket
    - contextPath: Ticket.Key
      description: Key of ticket
    - contextPath: Ticket.Assignee
      description: User assigned to ticket
    - contextPath: Ticket.Creator
      description: User who created the ticket
    - contextPath: Ticket.Summary
      description: Summary of ticket
    - contextPath: Ticket.Status
      description: Status of ticket
    description: Fetch issue from Jira
  - name: jira-create-issue
    arguments:
    - name: issueJson
      description: Issue object in json format
    - name: summary
      required: true
      description: Summary of the issue, a mandatory field
    - name: projectKey
      description: Project key to associate the issue
    - name: issueTypeName
      description: Choose issue type by name - e.g. Problem
    - name: issueTypeId
      description: Choose issue type by its numeric ID
    - name: projectName
      description: Project name to associate the issue
    - name: description
      description: Issue description
    - name: labels
      description: 'comma separated list of label '
    - name: priority
      description: priorty name , like High/Medium
    - name: dueDate
      description: DueDate for the issue, in format of 2018-03-11
    - name: assignee
      description: assignee name
    - name: reporter
      description: reporter name
    outputs:
    - contextPath: Ticket.Id
      description: Id of ticket
    description: Create a new issue on Jira
  - name: jira-issue-upload-file
    arguments:
    - name: issueId
      required: true
      description: Issue id
    - name: upload
      description: Entry id to upload
    description: Upload a file attachments to an issue
  - name: jira-issue-add-comment
    arguments:
    - name: issueId
      required: true
      default: true
      description: Issue id
    - name: comment
      required: true
      description: Comment - the actual comment body
    - name: visibility
      description: Make comment visible ONLy to a certain role - like Administrators
    description: Add new comment to existing Jira issue
  - name: jira-issue-add-link
    arguments:
    - name: globalId
      description: If a globalId is provided and a remote issue link exists with that
        globalId, the remote issue link is updated
    - name: relationship
      description: object relationship to issue , like - causes
    - name: url
      required: true
      description: link url
    - name: title
      required: true
      description: link title
    - name: summary
      description: link summary
    - name: issueId
      required: true
      description: Issue Id
    description: Creates (or updates) issue link
  isfetch: true
system: true
