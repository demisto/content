id: CrowdStrike Falcon Malware - Incident Enrichment
version: -1
fromversion: 6.5.0
name: CrowdStrike Falcon Malware - Incident Enrichment
description: This playbook enables enriching CrowdStrike Falcon incidents by pivoting to their detections as well as mapping all the relevant data to the Cortex XSOAR incident fields.
starttaskid: '0'
tasks:
  '0':
    id: '0'
    taskid: c2bead67-50cb-4869-879b-0bdb2a5a250b
    type: start
    task:
      id: c2bead67-50cb-4869-879b-0bdb2a5a250b
      version: -1
      name: ''
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '1'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1090,
          "y": -1050
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '1':
    id: '1'
    taskid: 2157cc1f-d365-42ae-8672-9db5f8c22c07
    type: condition
    task:
      id: 2157cc1f-d365-42ae-8672-9db5f8c22c07
      version: -1
      name: Is Crowdstrike the alert source?
      type: condition
      iscommand: false
      brand: ''
      description: Is Crowdstrike the alert source?
    nexttasks:
      '#default#':
      - '11'
      yes:
      - '5'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: incident.sourceBrand
            iscontext: true
          right:
            value:
              simple: CrowdstrikeFalcon
    view: |-
      {
        "position": {
          "x": 1090,
          "y": -930
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '2':
    id: '2'
    taskid: af0c7571-95d7-43bc-84cf-2b2816ed6dfb
    type: regular
    task:
      id: af0c7571-95d7-43bc-84cf-2b2816ed6dfb
      version: -1
      name: Enrich endpoint details
      description: Returns information about an endpoint.
      script: '|||endpoint'
      type: regular
      iscommand: true
      brand: ''
    nexttasks:
      '#none#':
      - '12'
    scriptarguments:
      id:
        simple: ${incident.agentsid}
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 870,
          "y": 300
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: Device Status
      output:
        simple: ${Endpoint.IsIsolated}
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '5':
    id: '5'
    taskid: e67316e2-eb10-4c73-8315-8245c6399075
    type: condition
    task:
      id: e67316e2-eb10-4c73-8315-8245c6399075
      version: -1
      name: Is this an incident or detection?
      type: condition
      iscommand: false
      brand: ''
      description: Is this an incident or detection?
    nexttasks:
      detection:
      - '8'
      incident:
      - '6'
    separatecontext: false
    conditions:
    - label: incident
      condition:
      - - operator: startWith
          left:
            value:
              simple: incident.externalsystemid
            iscontext: true
          right:
            value:
              simple: inc
          ignorecase: true
    - label: detection
      condition:
      - - operator: startWith
          left:
            value:
              simple: incident.externalsystemid
            iscontext: true
          right:
            value:
              simple: ldt
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 670,
          "y": -740
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '6':
    id: '6'
    taskid: 78cf4344-2c76-4853-8aae-ddc0aa71e47e
    type: title
    task:
      id: 78cf4344-2c76-4853-8aae-ddc0aa71e47e
      version: -1
      name: Incident
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '7'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 470,
          "y": -520
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '7':
    id: '7'
    taskid: 47da239e-6de2-4021-8afd-300d2e6c8765
    type: playbook
    task:
      id: 47da239e-6de2-4021-8afd-300d2e6c8765
      version: -1
      name: CrowdStrike Falcon - Get Detections by Incident
      playbookName: CrowdStrike Falcon - Get Detections by Incident
      type: playbook
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '18'
    scriptarguments:
      IncidentID:
        simple: ${inputs.DetectionOrIncidentID}
    separatecontext: true
    loop:
      iscommand: false
      scriptArguments:
        IncidentID:
          simple: ${incident.externalid}
      exitCondition: ''
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 470,
          "y": -355
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '8':
    id: '8'
    taskid: dfd0c2b3-0170-4ef0-8273-ff75fe4127e8
    type: title
    task:
      id: dfd0c2b3-0170-4ef0-8273-ff75fe4127e8
      version: -1
      name: Detection
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '9'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 870,
          "y": -520
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '9':
    id: '9'
    taskid: 8332b249-c325-4196-8073-1c334a9edec4
    type: regular
    task:
      id: 8332b249-c325-4196-8073-1c334a9edec4
      version: -1
      name: Map behavior data to context
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs.paloaltonetworks.com/cortex/cortex-xsoar/6-2/cortex-xsoar-admin/playbooks/automations.html
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '15'
    scriptarguments:
      append:
        simple: 'true'
      key:
        simple: CrowdStrike.Detection
      value:
        complex:
          root: incident
          accessor: additionaldata
          transformers:
          - operator: join
            args:
              separator:
                value:
                  simple: ','
          - operator: Stringify
          - operator: concat
            args:
              prefix:
                value:
                  simple: '{"Behavior":['
              suffix:
                value:
                  simple: ']}'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 870,
          "y": -355
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '11':
    id: '11'
    taskid: 74e5f7c5-c113-46dc-8e14-34195b5a2435
    type: title
    task:
      id: 74e5f7c5-c113-46dc-8e14-34195b5a2435
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ''
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1090,
          "y": 1030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '12':
    id: '12'
    taskid: 11cfadb7-199a-43d8-8c23-621628785b58
    type: regular
    task:
      id: 11cfadb7-199a-43d8-8c23-621628785b58
      version: -1
      name: Set Endpoint information to layout
      description: Set Endpoint information to layout
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - '13'
    scriptarguments:
      deviceid:
        simple: ${Endpoint.[0].ID}
      devicelocalip:
        simple: ${Endpoint.[0].IPAddress}
      devicemacaddress:
        simple: ${Endpoint.[0].MACAddress}
      devicename:
        simple: ${Endpoint.[0].Hostname}
      deviceosname:
        simple: ${Endpoint.[0].OS}
      deviceosversion:
        simple: ${Endpoint.[0].OSVersion}
      devicestatus:
        simple: ${Endpoint.[0].Status}
      isolated:
        simple: ${Endpoint.[0].IsIsolated}
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 870,
          "y": 470
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '13':
    id: '13'
    taskid: 76cc6bfa-107f-4440-85c0-066f67bede92
    type: condition
    task:
      id: 76cc6bfa-107f-4440-85c0-066f67bede92
      version: -1
      name: Check if we have more than 1 item
      description: Checks whether given entries returned an error. Use ${lastCompletedTaskEntries} to check the previous task entries. If an array is provided, will return 'yes' if one of the entries returns an error.
      scriptName: isError
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '11'
      yes:
      - '14'
    scriptarguments:
      entryId:
        simple: ${lastCompletedTaskEntries}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 870,
          "y": 670
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '14':
    id: '14'
    taskid: 6f692222-7df0-4ec3-8a76-4a5557ef2599
    type: regular
    task:
      id: 6f692222-7df0-4ec3-8a76-4a5557ef2599
      version: -1
      name: Set Endpoint information to layout
      description: Set Endpoint information to layout
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - '11'
    scriptarguments:
      deviceid:
        simple: ${Endpoint.ID}
      devicelocalip:
        simple: ${Endpoint.IPAddress}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 710,
          "y": 850
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '15':
    id: '15'
    taskid: 569109c7-222c-402b-8b8c-7532954238da
    type: regular
    task:
      id: 569109c7-222c-402b-8b8c-7532954238da
      version: -1
      name: Set Process Details To Layout
      description: Set Process Details To Layout
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - '23'
    scriptarguments:
      filesha256:
        simple: ${CrowdStrike.Detection.Behavior.sha256}
      md5:
        simple: ${CrowdStrike.Detection.Behavior.md5}
      parentprocessfilepath:
        simple: ${CrowdStrike.Detection.Behavior.filepath}
      processname:
        simple: ${CrowdStrike.Detection.Behavior.filename}
      sha256:
        simple: ${CrowdStrike.Detection.Behavior.sha256}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 870,
          "y": -195
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '17':
    id: '17'
    taskid: a39a16ee-a9f1-4a0a-8099-6faa2c744529
    type: title
    task:
      id: a39a16ee-a9f1-4a0a-8099-6faa2c744529
      version: -1
      name: Additional details settings
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '2'
      - '22'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 870,
          "y": 170
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '18':
    id: '18'
    taskid: 03bdd77b-e9dc-47c9-8e55-5722b226ffff
    type: regular
    task:
      id: 03bdd77b-e9dc-47c9-8e55-5722b226ffff
      version: -1
      name: Set Process Details To Layout
      description: Set Process Details To Layout
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - '23'
    scriptarguments:
      filesha256:
        simple: ${CrowdStrike.Detection.Behavior.sha256}
      md5:
        simple: ${CrowdStrike.Detection.Behavior.md5}
      parentprocessfilepath:
        simple: ${CrowdStrike.Detection.Behavior.filepath}
      processname:
        simple: ${CrowdStrike.Detection.Behavior.filename}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 470,
          "y": -195
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '22':
    id: '22'
    taskid: 5cac0939-42d0-4676-8a58-9ddceadfce50
    type: regular
    task:
      id: 5cac0939-42d0-4676-8a58-9ddceadfce50
      version: -1
      name: Set alert details to grid
      description: Creates a Grid table from items or key-value pairs.
      scriptName: SetGridField
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '11'
    scriptarguments:
      columns:
        simple: Alert Name,Hostname,File Name,Process ID,SHA256,Command Line
      context_path:
        simple: CrowdStrike.Detection.Behavior
      grid_id:
        simple: alertsandrelatedinfo
      keys:
        simple: display_name,device_id,filename,,sha256,cmdline
      overwrite:
        simple: 'true'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 270,
          "y": 850
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  '23':
    id: '23'
    taskid: 75c236f8-059c-4914-86d2-2e9c217722f5
    type: regular
    task:
      id: 75c236f8-059c-4914-86d2-2e9c217722f5
      version: -1
      name: Extract Indicators
      description: Extract Indicators from retrieved Detection info.
      script: Builtin|||extractIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - '17'
    scriptarguments:
      text:
        simple: ${CrowdStrike.Detection}
    reputationcalc: 2
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 870,
          "y": 10
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {},
    "paper": {
      "dimensions": {
        "height": 2145,
        "width": 1200,
        "x": 270,
        "y": -1050
      }
    }
  }
inputs:
- key: DetectionOrIncidentID
  value:
    simple: ${incident.externalsystemid}
  required: false
  description: The ID of the CrowdStrike detection or incident.
  playbookInputQuery:
outputs:
- contextPath: CrowdStrike
  type: unknown
  description: CrowdStrike Detection or Incident details.
- contextPath: Endpoint
  type: unknown
  description: Endpoint details.
tests:
- No tests (auto formatted)
contentitemexportablefields:
  contentitemfields: {}
system: true
