id: Process Email - Generic v2
version: -1
name: Process Email - Generic v2
description: |-
  This playbook adds email details to the relevant context entities and handles original email attachments.

  The v2 playbook enables parsing email artifacts more efficiently, including:
  - Using incident fields and not incident labels.
  - Providing separate paths to "Phishing Alerts".
  - Using the new "Get Original Email - Generic v2" playbook to retrieve original emails as EML files from the following integrations:
    * EWS v2
    * Microsoft Graph Mail integration
    * Gmail
    * FireEye EX and FireEye CM
    * Proofpoint Protection Server
    * Agari Phishing Defense (EWS v2, MSGraph Mail, Gmail)
    * Mimecast.
starttaskid: '0'
tasks:
  '0':
    id: '0'
    taskid: 492b4771-41d3-4060-8c63-483ac8be7662
    type: start
    task:
      id: 492b4771-41d3-4060-8c63-483ac8be7662
      version: -1
      name: ''
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '23'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 367.5,
          "y": -510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '1':
    id: '1'
    taskid: 4f530c80-a9da-44e2-8a89-2175c83156e7
    type: condition
    task:
      id: 4f530c80-a9da-44e2-8a89-2175c83156e7
      version: -1
      name: Do we have original emails attached?
      description: Identifies whether the incident includes an email message attached as an EML or MSG file and returns the answer to playbook. Also saves the identified entry ID to context for use for later. Commonly used in automated playbooks that handle phishing reports sent to a special phishing mailbox set up by the security team.
      scriptName: IdentifyAttachedEmail
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      no:
      - '16'
      yes:
      - '44'
    scriptarguments:
      entryid:
        simple: ${inputs.File.EntryID}
    reputationcalc: 1
    results:
    - reportedemailentryid
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 367.5,
          "y": 15
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '3':
    id: '3'
    taskid: e1063dd5-7d1c-4846-85c3-e1c485fef6e9
    type: regular
    task:
      id: e1063dd5-7d1c-4846-85c3-e1c485fef6e9
      version: -1
      name: Extract email artifacts and attachments
      description: Parse an email from an eml or msg file and populate all relevant context data to investigate the email. Also extracts inner attachments and returns them to the war room. The incident labels themselves are preserved and not modified - only the "Label/x" context items that originated from the labels, and the best practice is to rely on these for the remainder of the playbook.
      scriptName: ParseEmailFilesV2
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '39'
    scriptarguments:
      entryid:
        simple: ${reportedemailentryid}
      nesting_level_to_return:
        complex:
          root: inputs.EmailFileToExtract
    reputationcalc: 2
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 820,
          "y": 2005
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '4':
    id: '4'
    taskid: f19eab00-582b-4c29-888f-ffa259732459
    type: condition
    task:
      id: f19eab00-582b-4c29-888f-ffa259732459
      version: -1
      name: Can an image of the email be rendered?
      description: Checks whether the email is HTML-formatted, and whether the Rasterize integration is enabled.
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '6'
      yes:
      - '5'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: Email
                accessor: HTML
            iscontext: true
          right:
            value: {}
        - operator: isExists
          left:
            value:
              complex:
                root: Email
                accessor: Text
            iscontext: true
      - - operator: isNotEmpty
          left:
            value:
              simple: Email.HTML
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: Email.Text
            iscontext: true
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: brand
                      iscontext: true
                    right:
                      value:
                        simple: Rasterize
                - - operator: isEqualString
                    left:
                      value:
                        simple: state
                      iscontext: true
                    right:
                      value:
                        simple: active
            iscontext: true
    view: |-
      {
        "position": {
          "x": 350,
          "y": 3970
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '5':
    id: '5'
    taskid: 2e20603f-c129-457a-81dd-7ce6922ea0cf
    type: regular
    task:
      id: 2e20603f-c129-457a-81dd-7ce6922ea0cf
      version: -1
      name: Render HTML to an image
      description: Rasterizes an email body into an image.
      tags:
      - email_html_image
      script: '|||rasterize-email'
      type: regular
      iscommand: true
      brand: ''
    nexttasks:
      '#none#':
      - "74"
    scriptarguments:
      htmlBody:
        complex:
          root: Email
          accessor: HTML
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: ${Email.Text="<html><body>"+val +"</body></html>"}
      offline:
        simple: 'true'
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 110,
          "y": 4190
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '6':
    id: '6'
    taskid: 47b51502-cedb-42ba-82dd-1ddbbd56dd80
    type: title
    task:
      id: 47b51502-cedb-42ba-82dd-1ddbbd56dd80
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ''
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 350,
          "y": 4560
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '11':
    id: '11'
    taskid: f625a6f3-8ab6-4a61-8411-9be05203a91c
    type: title
    task:
      id: f625a6f3-8ab6-4a61-8411-9be05203a91c
      version: -1
      name: Email Screenshot
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '4'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 350,
          "y": 3840
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '16':
    id: '16'
    taskid: b98a8375-8a3a-4870-8b87-cfdb81b0109e
    type: condition
    task:
      id: b98a8375-8a3a-4870-8b87-cfdb81b0109e
      version: -1
      name: Should the original email be retrieved?
      description: Determines whether to retrieve the original email in the thread.
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '50'
      Yes-Alerts:
      - '49'
      Yes-Forwarded:
      - '48'
    separatecontext: false
    conditions:
    - label: Yes-Forwarded
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.GetOriginalEmail
            iscontext: true
          right:
            value:
              simple: 'True'
          ignorecase: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: phishingreporteremailheaders
            iscontext: true
    - label: Yes-Alerts
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.GetOriginalEmail
            iscontext: true
          right:
            value:
              simple: 'True'
    view: |-
      {
        "position": {
          "x": -50,
          "y": 190
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '18':
    id: '18'
    taskid: 2e6ba773-95c8-4c53-8363-95b071414426
    type: condition
    task:
      id: 2e6ba773-95c8-4c53-8363-95b071414426
      version: -1
      name: Was the original email retrieved?
      description: Determines whether there is an email object in the context.
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '45'
      Email Exist:
      - '47'
    separatecontext: false
    conditions:
    - label: Email Exist
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: Email
            iscontext: true
    view: |-
      {
        "position": {
          "x": 0,
          "y": 2005
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '19':
    id: '19'
    taskid: a006e983-6be6-4379-8c49-28d9c746b998
    type: condition
    task:
      id: a006e983-6be6-4379-8c49-28d9c746b998
      version: -1
      name: Keep backward-compatibility?
      description: Whether to keep this sub-playbook backward-compatible in terms of the incident fields being set. Opting out will result in the Rendered HTML and Email Body HTML not being set, and the Email HTML field will be used instead.
      type: condition
      iscommand: false
      brand: Builtin
    nexttasks:
      '#default#':
      - "68"
      "yes":
      - "66"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 920,
          "y": 3200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.UseOldHTMLFields
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    continueonerrortype: ""
  '20':
    id: '20'
    taskid: 2e975837-433f-44b1-84cf-d8a0fbd751a2
    type: regular
    task:
      id: 2e975837-433f-44b1-84cf-d8a0fbd751a2
      version: -1
      name: Display email headers in layout - Email.Headers
      description: Fills the "Email Headers" field in the incident layout with the retrieved email headers.
      scriptName: SetGridField
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '19'
    scriptarguments:
      columns:
        simple: headername,headervalue
      context_path:
        simple: Email.Headers
      grid_id:
        simple: emailheaders
      overwrite:
        simple: 'true'
      sort_by:
        simple: headername
      unpack_nested_elements:
        simple: 'false'
    reputationcalc: 2
    separatecontext: false
    continueonerror: true
    view: |-
      {
        "position": {
          "x": -20,
          "y": 2960
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '21':
    id: '21'
    taskid: 4d018abb-e6bd-4ed6-8c17-0abbcbfb71d9
    type: condition
    task:
      id: 4d018abb-e6bd-4ed6-8c17-0abbcbfb71d9
      version: -1
      name: Were email headers extracted successfully?
      description: Checks whether the email headers were extracted from the original email that was either attached or retrieved using available email integrations.
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - "63"
      Headers:
      - '20'
      HeadersMap:
      - '40'
    separatecontext: false
    conditions:
    - label: HeadersMap
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: Email
                accessor: HeadersMap
            iscontext: true
    - label: Headers
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: Email.Headers
            iscontext: true
    view: |-
      {
        "position": {
          "x": 300,
          "y": 2600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '22':
    id: '22'
    taskid: edd5037f-27d6-4497-8984-134884080753
    type: title
    task:
      id: edd5037f-27d6-4497-8984-134884080753
      version: -1
      name: Incident Layout Display
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '21'
      - '25'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1030,
          "y": 2420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '23':
    id: '23'
    taskid: 969fe14e-474b-479f-8112-a6e543fb692d
    type: condition
    task:
      id: 969fe14e-474b-479f-8112-a6e543fb692d
      version: -1
      name: Are there any files in the incident?
      description: Checks whether the incident contains any kind of file.
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '16'
      yes:
      - '24'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.File
                accessor: EntryID
            iscontext: true
          right:
            value: {}
    view: |-
      {
        "position": {
          "x": 367.5,
          "y": -360
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '24':
    id: '24'
    taskid: 473759cd-1d1f-4101-86a3-a48c72a988fd
    type: regular
    task:
      id: 473759cd-1d1f-4101-86a3-a48c72a988fd
      version: -1
      name: Save incident files separately from email attachments
      description: Saves the files that were initially involved with the incident in a separate context key so they are available separate from email attachment files.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '1'
    scriptarguments:
      key:
        simple: IncidentFiles
      value:
        complex:
          root: inputs.File
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 367.5,
          "y": -170
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '25':
    id: '25'
    taskid: 702f5c0a-2a33-4ddf-8516-e57413795092
    type: title
    task:
      id: 702f5c0a-2a33-4ddf-8516-e57413795092
      version: -1
      name: Attachment Information
      description: Set multiple keys/values to the context.
      type: title
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '26'
      - '27'
      - '28'
      - '29'
      - '30'
      - '31'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2010,
          "y": 2600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '26':
    id: '26'
    taskid: d5391acd-b65a-4f6d-8f9f-7a7483e67dee
    type: regular
    task:
      id: d5391acd-b65a-4f6d-8f9f-7a7483e67dee
      version: -1
      name: Save number of attachments
      description: Saves the number of attachments in the email.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '19'
    scriptarguments:
      key:
        simple: Email.Attachment.Count
      value:
        complex:
          root: File
          filters:
          - - operator: notIn
              left:
                value:
                  simple: File.EntryID
                iscontext: true
              right:
                value:
                  simple: IncidentFiles.EntryID
                iscontext: true
          - - operator: isNotEmpty
              left:
                value:
                  simple: File.EntryID
                iscontext: true
          transformers:
          - operator: count
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1320,
          "y": 2800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '27':
    id: '27'
    taskid: 22736a29-ca1f-45fa-88fc-7fe675007163
    type: regular
    task:
      id: 22736a29-ca1f-45fa-88fc-7fe675007163
      version: -1
      name: Save attachment extensions
      description: Saves the email attachment extensions.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '19'
    scriptarguments:
      key:
        simple: Email.Attachment.Extension
      value:
        complex:
          root: File
          filters:
          - - operator: notIn
              left:
                value:
                  simple: File.EntryID
                iscontext: true
              right:
                value:
                  simple: IncidentFiles.EntryID
                iscontext: true
          - - operator: isNotEmpty
              left:
                value:
                  simple: File.EntryID
                iscontext: true
          accessor: Extension
          transformers:
          - operator: join
            args:
              separator:
                value:
                  simple: ', '
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 920,
          "y": 2800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '28':
    id: '28'
    taskid: d3faa962-d949-4632-8927-a52ea719d97e
    type: regular
    task:
      id: d3faa962-d949-4632-8927-a52ea719d97e
      version: -1
      name: Save attachment MD5 hashes
      description: Saves the email attachment MD5 hashes.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '19'
    scriptarguments:
      key:
        simple: Email.Attachment.Hash
      value:
        complex:
          root: File
          filters:
          - - operator: notIn
              left:
                value:
                  simple: File.EntryID
                iscontext: true
              right:
                value:
                  simple: IncidentFiles.EntryID
                iscontext: true
          - - operator: isNotEmpty
              left:
                value:
                  simple: File.EntryID
                iscontext: true
          accessor: MD5
          transformers:
          - operator: join
            args:
              separator:
                value:
                  simple: ', '
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1727.5,
          "y": 2800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '29':
    id: '29'
    taskid: fba26366-94b5-43cd-8dbf-9f347c1e795f
    type: regular
    task:
      id: fba26366-94b5-43cd-8dbf-9f347c1e795f
      version: -1
      name: Save attachment names
      description: Saves the email attachment names.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '19'
    scriptarguments:
      key:
        simple: Email.Attachment.Name
      value:
        complex:
          root: File
          filters:
          - - operator: notIn
              left:
                value:
                  simple: File.EntryID
                iscontext: true
              right:
                value:
                  simple: IncidentFiles.EntryID
                iscontext: true
          - - operator: isNotEmpty
              left:
                value:
                  simple: File.EntryID
                iscontext: true
          accessor: Name
          transformers:
          - operator: join
            args:
              separator:
                value:
                  simple: ', '
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2540,
          "y": 2800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '30':
    id: '30'
    taskid: c2894b70-9f8c-4bac-8288-f1b794b4bb1e
    type: regular
    task:
      id: c2894b70-9f8c-4bac-8288-f1b794b4bb1e
      version: -1
      name: Save attachment sizes
      description: Saves the email attachment sizes.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '19'
    scriptarguments:
      key:
        simple: Email.Attachment.Size
      value:
        complex:
          root: File
          filters:
          - - operator: notIn
              left:
                value:
                  simple: File.EntryID
                iscontext: true
              right:
                value:
                  simple: IncidentFiles.EntryID
                iscontext: true
          - - operator: isNotEmpty
              left:
                value:
                  simple: File.EntryID
                iscontext: true
          accessor: Size
          transformers:
          - operator: join
            args:
              separator:
                value:
                  simple: ', '
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2140,
          "y": 2800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '31':
    id: '31'
    taskid: 1a73c3a0-c772-4b0e-8d7b-9a8a2709860b
    type: regular
    task:
      id: 1a73c3a0-c772-4b0e-8d7b-9a8a2709860b
      version: -1
      name: Save attachment types
      description: Saves the email attachment types.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '19'
    scriptarguments:
      key:
        simple: Email.Attachment.Type
      value:
        complex:
          root: File
          filters:
          - - operator: notIn
              left:
                value:
                  simple: File.EntryID
                iscontext: true
              right:
                value:
                  simple: IncidentFiles.EntryID
                iscontext: true
          - - operator: isNotEmpty
              left:
                value:
                  simple: File.EntryID
                iscontext: true
          accessor: Type
          transformers:
          - operator: join
            args:
              separator:
                value:
                  simple: ', '
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2950,
          "y": 2800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '32':
    id: '32'
    taskid: e6e05945-1651-41a3-89b3-8fe99ed93544
    type: regular
    task:
      id: e6e05945-1651-41a3-89b3-8fe99ed93544
      version: -1
      name: Normalize Reporter Email Headers
      description: Normalizes the keys names of the headers, which are different with each client. This facilitates extracting the relevant values for the next tasks.
      scriptName: SetGridField
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '38'
    scriptarguments:
      columns:
        simple: headername,headervalue
      context_path:
        simple: headers
      grid_id:
        simple: phishingreporteremailheaders
      overwrite:
        simple: 'true'
      sort_by:
        simple: headername
      unpack_nested_elements:
        simple: 'false'
    separatecontext: false
    continueonerror: true
    view: |-
      {
        "position": {
          "x": 367.5,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '33':
    id: '33'
    taskid: f429ab03-5f81-4e9f-8a92-7b4276b9c85c
    type: regular
    task:
      id: f429ab03-5f81-4e9f-8a92-7b4276b9c85c
      version: -1
      name: Extract Reporter Email Headers
      description: Preserves the original state of the reporter's email headers, which are stored in the context.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '32'
    scriptarguments:
      key:
        simple: headers
      value:
        complex:
          root: incident
          accessor: phishingreporteremailheaders
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 367.5,
          "y": 555
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '34':
    id: '34'
    taskid: 44ffdb47-3af2-4727-80ca-0132a118ce69
    type: playbook
    task:
      id: 44ffdb47-3af2-4727-80ca-0132a118ce69
      version: -1
      name: Get Original Email - Generic v2
      description: |-
        This v2 playbook is used inside the phishing flow. The inputs in this version do not use labels and also allow the user to supply an email brand.
        Note: You must have the necessary permissions in your email service to execute a global search.

        To retrieve the email files directly from the email service providers, use one of the provided inputs (Agari Phishing Defense customers should also use the following):
        - EWS: eDiscovery
        - Gmail: Google Apps Domain-Wide Delegation of Authority
        - MSGraph: As described in the [message-get API](https://docs.microsoft.com/en-us/graph/api/message-get) and the [user-list-messages API](https://docs.microsoft.com/en-us/graph/api/user-list-messages).</li></ul>
        - EmailSecurityGateway retrieves eml files from:
            * FireEye EX
            * FireEye CM
            * Proofpoint Protection Server
            * Mimecast
      playbookName: Get Original Email - Generic v2
      type: playbook
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '36'
    scriptarguments:
      EmailBrand:
        complex:
          root: inputs.EmailBrand
      EmailSubject:
        complex:
          root: inputs.Thread-Topic
      MessageID:
        complex:
          root: inputs.MessageID
      UserID:
        complex:
          root: inputs.UserID
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -50,
          "y": 885
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '36':
    id: '36'
    taskid: 2e60e29b-6f11-4a3a-8b73-5d7e73075275
    type: condition
    task:
      id: 2e60e29b-6f11-4a3a-8b73-5d7e73075275
      version: -1
      name: Do we have original emails attached?
      description: Identifies whether the incident includes an email message attached as an EML or MSG file and returns the answer to playbook. Also saves the identified entry ID to context for later use. Commonly used in automated playbooks that handle phishing reports sent to a special phishing mailbox set up by the security team.
      scriptName: IdentifyAttachedEmail
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      no:
      - '18'
      yes:
      - '46'
    scriptarguments:
      entryid:
        simple: ${File.EntryID}
    reputationcalc: 1
    results:
    - reportedemailentryid
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 170,
          "y": 1075
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '37':
    id: '37'
    taskid: 252362bf-7e7b-4958-8f59-def449725c52
    type: regular
    task:
      id: 252362bf-7e7b-4958-8f59-def449725c52
      version: -1
      name: Display email headers in layout - Email.HeadersMap
      description: Fills the "Email Headers" field in the incident layout with the retrieved email headers.
      scriptName: SetGridField
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '19'
    scriptarguments:
      columns:
        simple: headername,headervalue
      context_path:
        simple: ExtractedHeadersMap
      grid_id:
        simple: emailheaders
      overwrite:
        simple: 'true'
      sort_by:
        simple: headername
      unpack_nested_elements:
        simple: 'true'
    reputationcalc: 2
    separatecontext: false
    continueonerror: true
    view: |-
      {
        "position": {
          "x": 430,
          "y": 2960
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '38':
    id: '38'
    taskid: 725925e1-7c0a-4ccb-8231-69f1262c1f5b
    type: playbook
    task:
      id: 725925e1-7c0a-4ccb-8231-69f1262c1f5b
      version: -1
      name: Get Original Email - Generic v2
      description: |-
        This playbook retrieves the original email in the thread including headers and attachments, when the reporting user forwarded the original email not as an attachment.

        Note: You must have the necessary permissions in your email service to execute a global search.

        - EWS: eDiscovery
        - Gmail: Google Apps Domain-Wide Delegation of Authority
        - MSGraph: As described in the [message-get API](https://docs.microsoft.com/en-us/graph/api/message-get) and the [user-list-messages API](https://docs.microsoft.com/en-us/graph/api/user-list-messages).</li></ul>
        - EmailSecurityGateway retrieves eml files from:
            * FireEye EX
            * FireEye CM
            * Proofpoint Protection Server
            * Mimecast
      playbookName: Get Original Email - Generic v2
      type: playbook
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '36'
    scriptarguments:
      EmailBrand:
        complex:
          root: incident
          accessor: sourceBrand
      EmailSubject:
        complex:
          root: incident.phishingreporteremailheaders
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: incident.phishingreporteremailheaders.headername
                iscontext: true
              right:
                value:
                  simple: Thread-Topic
          accessor: headervalue
      MessageID:
        complex:
          root: incident.phishingreporteremailheaders
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: incident.phishingreporteremailheaders.headername
                iscontext: true
              right:
                value:
                  simple: In-Reply-To
          accessor: headervalue
      UserID:
        complex:
          root: inputs.UserID
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 367.5,
          "y": 885
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '39':
    id: '39'
    taskid: 6d8dc2b2-4471-4b47-820d-8b6045619c70
    type: condition
    task:
      id: 6d8dc2b2-4471-4b47-820d-8b6045619c70
      version: -1
      name: Check if attachments were found in eml file
      description: Checks if attachments were found in an EML file to display their details in the layout.
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '21'
      yes:
      - '22'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: Email
                accessor: AttachmentNames
            iscontext: true
    view: |-
      {
        "position": {
          "x": 820,
          "y": 2170
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '40':
    id: '40'
    taskid: 6cd70b6a-5190-48dc-8d71-e089736e7cbf
    type: regular
    task:
      id: 6cd70b6a-5190-48dc-8d71-e089736e7cbf
      version: -1
      name: Set ExtractedHeadersMap
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '37'
    scriptarguments:
      key:
        simple: ExtractedHeadersMap
      value:
        complex:
          root: Email.HeadersMap
          filters:
          - - operator: isNotEmpty
              left:
                value:
                  simple: Email.HeadersMap
                iscontext: true
          transformers:
            - operator: FirstArrayElement
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 430,
          "y": 2800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '41':
    id: '41'
    taskid: 528fb8ce-5b17-4929-8b9e-b81af86740ef
    type: condition
    task:
      id: 528fb8ce-5b17-4929-8b9e-b81af86740ef
      version: -1
      name: Did the automation find more than one email?
      description: Checks if the Get Original Email - Generic v2 playbook found more than one EML file.
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '3'
      yes:
      - '42'
    separatecontext: false
    conditions:
    - label: yes
      condition:
      - - operator: greaterThan
          left:
            value:
              complex:
                root: File
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: File.Extension
                      iscontext: true
                    right:
                      value:
                        simple: eml
                    ignorecase: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: File.Extension
                      iscontext: true
                    right:
                      value:
                        simple: msg
                    ignorecase: true
                accessor: EntryID
                transformers:
                - operator: uniq
                - operator: count
            iscontext: true
          right:
            value:
              simple: '1'
    view: |-
      {
        "position": {
          "x": 400,
          "y": 1450
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '42':
    id: '42'
    taskid: c2ad8bf7-e3d7-4823-853e-00951b0ccf5e
    type: collection
    task:
      id: c2ad8bf7-e3d7-4823-853e-00951b0ccf5e
      version: -1
      name: Handling multiple email files
      description: Asks the user to provide the EntryID of one of the EML files found.
      type: collection
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '43'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 400,
          "y": 1650
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
        simple: Several email files were found, please pick the relevant one
      methods: []
      format: ''
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: false
        completeaftersla: false
    form:
      questions:
      - id: '0'
        label: ''
        labelarg:
          simple: Which EntryID should the playbook process?
        required: false
        gridcolumns: []
        defaultrows: []
        type: shortText
        options: []
        optionsarg:
        - complex:
            root: File
            filters:
            - - operator: isEqualString
                left:
                  value:
                    simple: File.Extension
                  iscontext: true
                right:
                  value:
                    simple: eml
                ignorecase: true
              - operator: isEqualString
                left:
                  value:
                    simple: File.Extension
                  iscontext: true
                right:
                  value:
                    simple: msg
                ignorecase: true
            accessor: Name
        - {}
        fieldassociated: ''
        placeholder: ''
        tooltip: ''
        readonly: false
      title: Handling multiple email files
      description: Please review the email files retrieved using the Get Original Email - Generic v2 playbook and insert the relevant entry ID to process.
      sender: Your SOC team
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '43':
    id: '43'
    taskid: 3707c638-cc0e-4c79-8d93-e05164bbe80b
    type: regular
    task:
      id: 3707c638-cc0e-4c79-8d93-e05164bbe80b
      version: -1
      name: Set the relevant file entry id
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '3'
    scriptarguments:
      append:
        simple: 'false'
      key:
        simple: reportedemailentryid
      value:
        complex:
          root: Handling multiple email files.Answers
          accessor: '0'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 400,
          "y": 1820
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '44':
    id: '44'
    taskid: ccc5caa4-591f-4613-87a5-18a890712f15
    type: regular
    task:
      id: ccc5caa4-591f-4613-87a5-18a890712f15
      version: -1
      name: Set reported email origin (attached)
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '3'
    scriptarguments:
      key:
        simple: ReportedEmailOrigin
      value:
        simple: Attached
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 820,
          "y": 190
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '45':
    id: '45'
    taskid: adfffa13-d525-4cab-8f6f-58d5fb00730d
    type: regular
    task:
      id: adfffa13-d525-4cab-8f6f-58d5fb00730d
      version: -1
      name: Set reported email origin (none)
      description: Set "reportedemailorigin" incident field value to "None".
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "63"
    scriptarguments:
      reportedemailorigin:
        simple: None
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -470,
          "y": 2325
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '46':
    id: '46'
    taskid: 7c681e4a-5639-4bab-86be-552484683ae5
    type: regular
    task:
      id: 7c681e4a-5639-4bab-86be-552484683ae5
      version: -1
      name: Set reported email origin (retrieved)
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '41'
    scriptarguments:
      key:
        simple: ReportedEmailOrigin
      value:
        simple: Retrieved
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 400,
          "y": 1260
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '47':
    id: '47'
    taskid: a9e6d53e-3e10-4331-84d0-1c7d25952253
    type: regular
    task:
      id: a9e6d53e-3e10-4331-84d0-1c7d25952253
      version: -1
      name: Set reported email origin (retrieved)
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '22'
    scriptarguments:
      key:
        simple: ReportedEmailOrigin
      value:
        simple: Retrieved
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 260,
          "y": 2250
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '48':
    id: '48'
    taskid: d8221c36-a37d-4cff-896a-b0173f1f1083
    type: title
    task:
      id: d8221c36-a37d-4cff-896a-b0173f1f1083
      version: -1
      name: Phishing - Forwarded Email
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '33'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 367.5,
          "y": 410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '49':
    id: '49'
    taskid: 396ae521-8f00-4ce9-8f79-db3d3ffad1b9
    type: title
    task:
      id: 396ae521-8f00-4ce9-8f79-db3d3ffad1b9
      version: -1
      name: Phishing Alerts
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '34'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -50,
          "y": 410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  '50':
    id: '50'
    taskid: c207987c-b954-4273-8a10-d2e22ec2e897
    type: title
    task:
      id: c207987c-b954-4273-8a10-d2e22ec2e897
      version: -1
      name: Do Not Retrieve Email
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '45'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -470,
          "y": 410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    continueonerrortype: ""
  "59":
    id: "59"
    taskid: 03c4c40f-c925-40ef-8307-e870397db0b4
    type: title
    task:
      id: 03c4c40f-c925-40ef-8307-e870397db0b4
      version: -1
      name: Keep Old Field Mapping
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "60"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -940,
          "y": 3020
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "60":
    id: "60"
    taskid: 341c9f9f-fbc0-494f-8a0f-5f8f5ecc16a3
    type: regular
    task:
      id: 341c9f9f-fbc0-494f-8a0f-5f8f5ecc16a3
      version: -1
      name: Add original email details to context
      description: Sets the details of the email that was forwarded under the email context key. Also saves the HTML or email text to the email body section in the layout.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      key:
        simple: Email
      value:
        simple: '${inputs={To: val[''Email''], CC: val[''EmailCC''], From: val[''EmailFrom''], Subject: val[''EmailSubject''], Text: val[''EmailText''], HTML: val[''EmailHtml''], Headers: val[''EmailHeaders''], Format: val[''EmailFormat'']}}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -940,
          "y": 3160
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: Rendered HTML
      output:
        complex:
          root: inputs.EmailHtml
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: inputs.EmailText
                iscontext: true
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "61":
    id: "61"
    taskid: e68dfd63-21c9-4c5d-833b-fb2813e99ea8
    type: title
    task:
      id: e68dfd63-21c9-4c5d-833b-fb2813e99ea8
      version: -1
      name: No Field Mapping
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "62"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -500,
          "y": 3025
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "62":
    id: "62"
    taskid: b5d653af-6c5a-4962-8867-8cfb599eda1e
    type: regular
    task:
      id: b5d653af-6c5a-4962-8867-8cfb599eda1e
      version: -1
      name: Add original email details to context
      description: Sets the details of the email that was forwarded under the email context key. Also saves the HTML or email text to the email body section in the layout.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      key:
        simple: Email
      value:
        simple: '${inputs={To: val[''Email''], CC: val[''EmailCC''], From: val[''EmailFrom''], Subject: val[''EmailSubject''], Text: val[''EmailText''], HTML: val[''EmailHtml''], Headers: val[''EmailHeaders''], Format: val[''EmailFormat'']}}'
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -500,
          "y": 3160
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "63":
    id: "63"
    taskid: 2881472f-e67d-488b-8d3d-fc0ba85d5466
    type: condition
    task:
      id: 2881472f-e67d-488b-8d3d-fc0ba85d5466
      version: -1
      name: Keep backward-compatibility?
      description: Whether to keep this sub-playbook backward-compatible in terms of the incident fields being set. Opting out will result in the Rendered HTML and Email Body HTML not being set, and the Email HTML field will be used instead.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "61"
      "yes":
      - "59"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.UseOldHTMLFields
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -710,
          "y": 2840
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "65":
    id: "65"
    taskid: 3a730220-ead6-4c35-86b4-ebdf91a30a52
    type: regular
    task:
      id: 3a730220-ead6-4c35-86b4-ebdf91a30a52
      version: -1
      name: Display email information in layout
      description: Updates Cortex XSOAR incident fields using data from the email object.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "69"
    scriptarguments:
      attachmentcount:
        complex:
          root: Email
          accessor: |
            Attachment.Count
      attachmentextension:
        complex:
          root: Email
          accessor: Attachment.Extension
      attachmenthash:
        complex:
          root: Email
          accessor: Attachment.Hash
      attachmentid:
        complex:
          root: Email
          accessor: Attachment.ID
      attachmentname:
        complex:
          root: Email
          accessor: Attachment.Name
      attachmentsize:
        complex:
          root: Email
          accessor: Attachment.Size
      attachmenttype:
        complex:
          root: Email
          accessor: Attachment.Type
      deleteEmptyField:
        simple: "True"
      emailbcc:
        complex:
          root: Email
          accessor: HeadersMap.BCC
          transformers:
          - operator: uniq
          - operator: Stringify
      emailbody:
        complex:
          root: Email
          accessor: Text
          transformers:
          - operator: Stringify
      emailbodyformat:
        complex:
          root: Email
          accessor: BodyFormat
      emailcc:
        complex:
          root: Email
          accessor: CC
          transformers:
          - operator: uniq
          - operator: Stringify
      emailclientname:
        complex:
          root: Email
          accessor: ClientName
      emailfrom:
        complex:
          root: Email
          accessor: From
          transformers:
          - operator: uniq
          - operator: Stringify
      emailhtml:
        complex:
          root: Email
          accessor: HTML
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: Email.Text
                iscontext: true
          - operator: uniq
          - operator: Stringify
      emailinreplyto:
        complex:
          root: Email
          accessor: InReplyTo
      emailkeywords:
        complex:
          root: Email
          accessor: Keywords
      emailmessageid:
        complex:
          root: incident.emailheaders
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: incident.emailheaders.headername
                iscontext: true
              right:
                value:
                  simple: Message-ID
          accessor: headervalue
          transformers:
          - operator: uniq
      emailrecipientscount:
        complex:
          root: Email
          accessor: To
          transformers:
          - operator: uniq
          - operator: split
            args:
              delimiter:
                value:
                  simple: ','
          - operator: count
      emailreplyto:
        complex:
          root: incident.emailheaders
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: incident.emailheaders.headername
                iscontext: true
              right:
                value:
                  simple: Reply-To
          accessor: headervalue
          transformers:
          - operator: uniq
      emailreturnpath:
        complex:
          root: incident.emailheaders
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: incident.emailheaders.headername
                iscontext: true
              right:
                value:
                  simple: Return-Path
          accessor: headervalue
          transformers:
          - operator: uniq
      emailsenderip:
        complex:
          root: Email
          accessor: SenderIP
          transformers:
          - operator: uniq
      emailsize:
        complex:
          root: Email
          accessor: Size
          transformers:
          - operator: uniq
      emailsource:
        complex:
          root: Email
          accessor: Source
          transformers:
          - operator: uniq
      emailsubject:
        complex:
          root: Email
          accessor: Subject
          transformers:
          - operator: uniq
          - operator: Stringify
      emailto:
        complex:
          root: Email
          accessor: To
          transformers:
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: ','
      emailtocount:
        complex:
          root: Email
          accessor: To
          transformers:
          - operator: uniq
          - operator: split
            args:
              delimiter:
                value: {}
          - operator: count
      emailurlclicked:
        complex:
          root: EmailUrlClicked
      reportedemailcc:
        complex:
          root: Email
          accessor: CC
          transformers:
          - operator: uniq
          - operator: Stringify
      reportedemailfrom:
        complex:
          root: Email
          accessor: From
          transformers:
          - operator: uniq
          - operator: Stringify
      reportedemailmessageid:
        complex:
          root: incident.emailheaders
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: incident.emailheaders.headername
                iscontext: true
              right:
                value:
                  simple: Message-ID
          accessor: headervalue
          transformers:
          - operator: uniq
      reportedemailorigin:
        complex:
          root: ReportedEmailOrigin
      reportedemailsubject:
        complex:
          root: Email
          accessor: Subject
          transformers:
          - operator: uniq
          - operator: Stringify
      reportedemailto:
        complex:
          root: Email
          accessor: To
          transformers:
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: ','
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1150,
          "y": 3510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "66":
    id: "66"
    taskid: c48f2998-f24a-4055-8b09-39c41d0e42fb
    type: title
    task:
      id: c48f2998-f24a-4055-8b09-39c41d0e42fb
      version: -1
      name: Keep Old Fields
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "67"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": 3380
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "67":
    id: "67"
    taskid: 4339d439-3f36-4519-8683-a7062f38adc5
    type: regular
    task:
      id: 4339d439-3f36-4519-8683-a7062f38adc5
      version: -1
      name: Display email information in layout
      description: Updates Cortex XSOAR incident fields using data from the email object.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "69"
    scriptarguments:
      attachmentcount:
        complex:
          root: Email
          accessor: |
            Attachment.Count
      attachmentextension:
        complex:
          root: Email
          accessor: Attachment.Extension
      attachmenthash:
        complex:
          root: Email
          accessor: Attachment.Hash
      attachmentid:
        complex:
          root: Email
          accessor: Attachment.ID
      attachmentname:
        complex:
          root: Email
          accessor: Attachment.Name
      attachmentsize:
        complex:
          root: Email
          accessor: Attachment.Size
      attachmenttype:
        complex:
          root: Email
          accessor: Attachment.Type
      deleteEmptyField:
        simple: "True"
      emailbcc:
        complex:
          root: Email
          accessor: HeadersMap.BCC
          transformers:
          - operator: uniq
          - operator: Stringify
      emailbody:
        complex:
          root: Email
          accessor: Text
          transformers:
          - operator: Stringify
      emailbodyformat:
        complex:
          root: Email
          accessor: BodyFormat
      emailbodyhtml:
        complex:
          root: Email
          accessor: HTML
          transformers:
          - operator: Stringify
      emailcc:
        complex:
          root: Email
          accessor: CC
          transformers:
          - operator: uniq
          - operator: Stringify
      emailclientname:
        complex:
          root: Email
          accessor: ClientName
      emailfrom:
        complex:
          root: Email
          accessor: From
          transformers:
          - operator: uniq
          - operator: Stringify
      emailhtml:
        complex:
          root: Email
          accessor: HTML
          transformers:
          - operator: uniq
      emailinreplyto:
        complex:
          root: Email
          accessor: InReplyTo
      emailkeywords:
        complex:
          root: Email
          accessor: Keywords
      emailmessageid:
        complex:
          root: incident.emailheaders
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: incident.emailheaders.headername
                iscontext: true
              right:
                value:
                  simple: Message-ID
          accessor: headervalue
          transformers:
          - operator: uniq
      emailrecipientscount:
        complex:
          root: Email
          accessor: To
          transformers:
          - operator: uniq
          - operator: split
            args:
              delimiter:
                value:
                  simple: ','
          - operator: count
      emailreplyto:
        complex:
          root: incident.emailheaders
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: incident.emailheaders.headername
                iscontext: true
              right:
                value:
                  simple: Reply-To
          accessor: headervalue
          transformers:
          - operator: uniq
      emailreturnpath:
        complex:
          root: incident.emailheaders
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: incident.emailheaders.headername
                iscontext: true
              right:
                value:
                  simple: Return-Path
          accessor: headervalue
          transformers:
          - operator: uniq
      emailsenderip:
        complex:
          root: Email
          accessor: SenderIP
          transformers:
          - operator: uniq
      emailsize:
        complex:
          root: Email
          accessor: Size
          transformers:
          - operator: uniq
      emailsource:
        complex:
          root: Email
          accessor: Source
          transformers:
          - operator: uniq
      emailsubject:
        complex:
          root: Email
          accessor: Subject
          transformers:
          - operator: uniq
          - operator: Stringify
      emailto:
        complex:
          root: Email
          accessor: To
          transformers:
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: ','
      emailtocount:
        complex:
          root: Email
          accessor: To
          transformers:
          - operator: uniq
          - operator: split
            args:
              delimiter:
                value: {}
          - operator: count
      emailurlclicked:
        complex:
          root: EmailUrlClicked
      renderedhtml:
        complex:
          root: Email
          accessor: HTML
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: Email.Text
                iscontext: true
      reportedemailcc:
        complex:
          root: Email
          accessor: CC
          transformers:
          - operator: uniq
          - operator: Stringify
      reportedemailfrom:
        complex:
          root: Email
          accessor: From
          transformers:
          - operator: uniq
          - operator: Stringify
      reportedemailmessageid:
        complex:
          root: incident.emailheaders
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: incident.emailheaders.headername
                iscontext: true
              right:
                value:
                  simple: Message-ID
          accessor: headervalue
          transformers:
          - operator: uniq
      reportedemailorigin:
        complex:
          root: ReportedEmailOrigin
      reportedemailsubject:
        complex:
          root: Email
          accessor: Subject
          transformers:
          - operator: uniq
          - operator: Stringify
      reportedemailto:
        complex:
          root: Email
          accessor: To
          transformers:
          - operator: uniq
          - operator: join
            args:
              separator:
                value:
                  simple: ','
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 670,
          "y": 3510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "68":
    id: "68"
    taskid: 07f81286-ed9e-48e3-8ff9-d8b850014dc8
    type: title
    task:
      id: 07f81286-ed9e-48e3-8ff9-d8b850014dc8
      version: -1
      name: Don't Keep Old Fields
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "65"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1150,
          "y": 3390
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "69":
    id: "69"
    taskid: 53b51aa2-db8c-4243-86fa-5c1016a679bd
    type: title
    task:
      id: 53b51aa2-db8c-4243-86fa-5c1016a679bd
      version: -1
      name: Continue
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "11"
      - "72"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 920,
          "y": 3690
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "70":
    id: "70"
    taskid: 487c420b-7dbf-4105-8510-3bfa84c03595
    type: regular
    task:
      id: 487c420b-7dbf-4105-8510-3bfa84c03595
      version: -1
      name: Upload email attachments to layout
      description: Copies a file from this incident to the specified incident. The file is recorded as an entry in the specified incidents War Room.
      scriptName: UploadFile
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    scriptarguments:
      entryID:
        complex:
          root: File
          filters:
          - - operator: notIn
              left:
                value:
                  simple: File.MD5
                iscontext: true
              right:
                value:
                  simple: IncidentFiles.MD5
                iscontext: true
          - - operator: isNotEmpty
              left:
                value:
                  simple: File.MD5
                iscontext: true
          accessor: EntryID
          transformers:
          - operator: uniq
      incID:
        simple: ${incident.id}
      target:
        simple: incident attachment
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1520,
          "y": 4190
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "71":
    id: "71"
    taskid: a5aff04e-a6db-4625-8ce0-9eeee0d33152
    type: condition
    task:
      id: a5aff04e-a6db-4625-8ce0-9eeee0d33152
      version: -1
      name: Can email attachments be uploaded?
      description: Checks whether the Core REST API integration is enabled, and whether any file attachments were extracted from the email.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "6"
      "yes":
      - "70"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: File
                filters:
                - - operator: notIn
                    left:
                      value:
                        simple: File.MD5
                      iscontext: true
                    right:
                      value:
                        simple: IncidentFiles.MD5
                      iscontext: true
                - - operator: isNotEmpty
                    left:
                      value:
                        simple: File.MD5
                      iscontext: true
                accessor: EntryID
            iscontext: true
          right:
            value: {}
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: Core REST API
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
                    ignorecase: true
                accessor: brand
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1520,
          "y": 3970
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "72":
    id: "72"
    taskid: 6fcc70b0-6abb-44d6-876f-bf20f56143e3
    type: title
    task:
      id: 6fcc70b0-6abb-44d6-876f-bf20f56143e3
      version: -1
      name: Add email files and attachments to the layout
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "71"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1520,
          "y": 3840
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "74":
    id: "74"
    taskid: e8aecf09-e057-48c2-8fcb-d67de5afbc91
    type: regular
    task:
      id: e8aecf09-e057-48c2-8fcb-d67de5afbc91
      version: -1
      name: Read QR code from image files
      description: Extracts the text from a QR code. The output of this script includes the output of the script "extractIndicators" run on the text extracted from the QR code.
      scriptName: ReadQRCode
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    scriptarguments:
      entry_id:
        complex:
          root: InfoFile
          accessor: EntryID
          transformers:
          - operator: uniq
    reputationcalc: 2
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 110,
          "y": 4380
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
system: true
view: |-
  {
    "linkLabelsPosition": {
      "19_66_yes": 0.52,
      "19_68_#default#": 0.53,
      "23_24_yes": 0.49,
      "39_22_yes": 0.31,
      "41_3_#default#": 0.35,
      "41_42_yes": 0.5,
      "4_5_yes": 0.59,
      "4_6_#default#": 0.18,
      "63_59_yes": 0.6,
      "63_61_#default#": 0.58,
      "71_6_#default#": 0.43
    },
    "paper": {
      "dimensions": {
        "height": 5135,
        "width": 4270,
        "x": -940,
        "y": -510
      }
    }
  }
inputs:
- key: File
  value:
    complex:
      root: File
  required: false
  description: An EML or MSG file.
  playbookInputQuery:
- key: Email
  value:
    complex:
      root: incident
      accessor: emailto
  required: false
  description: The receiver email address.
  playbookInputQuery:
- key: EmailCC
  value:
    complex:
      root: incident
      accessor: emailcc
  required: false
  description: The email CC addresses.
  playbookInputQuery:
- key: EmailFrom
  value:
    complex:
      root: incident
      accessor: emailfrom
  required: false
  description: The sender email address.
  playbookInputQuery:
- key: EmailSubject
  value:
    complex:
      root: incident
      accessor: emailsubject
  required: false
  description: The email subject.
  playbookInputQuery:
- key: EmailText
  value:
    complex:
      root: incident
      accessor: emailbody
  required: false
  description: The email text.
  playbookInputQuery:
- key: EmailHtml
  value:
    complex:
      root: incident
      accessor: emailhtml
  required: false
  description: The email HTML.
  playbookInputQuery:
- key: EmailHeaders
  value:
    complex:
      root: incident
      accessor: phishingreporteremailheaders
  required: false
  description: The email headers.
  playbookInputQuery:
- key: EmailFormat
  value:
    complex:
      root: incident
      accessor: emailformat
  required: false
  description: The email format.
  playbookInputQuery:
- key: GetOriginalEmail
  value:
    simple: 'False'
  required: false
  description: |-
    Retrieves the original email in the thread.

    You must have the necessary permissions in your email service to execute global search.

    - For EWS: eDiscovery
    - For Gmail: Google Apps Domain-Wide Delegation of Authority
    - For MSGraph: As described in the [message-get API](https://docs.microsoft.com/en-us/graph/api/message-get) and the [user-list-messages API](https://docs.microsoft.com/en-us/graph/api/user-list-messages)
  playbookInputQuery:
- key: MessageID
  value:
    complex:
      root: incident
      accessor: emailmessageid
  required: false
  description: The original email message ID to retrieve. Holds the value of the "Message-ID" header of the original email. This value is passed as an input to the "Get Original Email - Generic v2" playbook.
  playbookInputQuery:
- key: UserID
  value:
    complex:
      root: incident
      accessor: emailto
      transformers:
      - operator: replaceMatch
        args:
          regex:
            value:
              simple: (?i).*<([A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,})>
          replaceWith:
            value:
              simple: $1
  required: false
  description: The user's email address to retrieve the original email. This value is passed as an input to the "Get Original Email - Generic v2" playbook.
  playbookInputQuery:
- key: Thread-Topic
  value:
    complex:
      root: incident
      accessor: emailsubject
  required: false
  description: The value of the "Thread-Topic" header which holds the original email subject, needed for forwarded email scenarios. It is passed as an input to the "Get Original Email - Generic v2" playbook to use in the relevant sub-playbooks.
  playbookInputQuery:
- key: EmailBrand
  value: {}
  required: false
  description: |-
    If this value is provided, only the relevant playbook runs. If no value is provided, all sub-playbooks are run.
    Possible values:
    - Gmail
    - EWS v2
    - MicrosoftGraphMail
    - EmailSecurityGateway
    Choosing the EmailSecurityGateway executes the following if enabled: - FireEye EX (Email Security) - Proofpoint TAP - Mimecast.
  playbookInputQuery:
- key: EmailFileToExtract
  value:
    simple: Inner file
  required: false
  description: |-
    Reported emails and emails retrieved during playbook execution can contain multiple nested email files. For example, an EML nested inside another EML file.
    If multiple level files are detected, this field determines which file represents the phishing email.

    For example:
    User1 receives an email from Attacker. User1 attaches the email as an EML file and sends the email to User2.
    User2 also attaches that email as a file, and reports it as phishing. In this case, the phishing email would be the "inner file" (as opposed to "outer file").

    Possible values are: Inner file, Outer file, All files.
    Inner file: The file at the deepest level is parsed. If there is only one file, that file is parsed.
    Outer file: The file at the first level is parsed.
    All files: All files are parsed. Do not use this option in the phishing playbook, as there should only be one phishing email per playbook run.
  playbookInputQuery:
- key: UseOldHTMLFields
  value:
    simple: "True"
  required: false
  description: |-
    This input is used to preserve backward-compatibility. It determines whether the playbook should set email fields that are no longer being used in the out-of-the-box content.
    If set to True, the playbook will save data into the the "Email Body HTML" and "Rendered HTML" incident fields as it did before.
    If set to False, the playbook will not save data into those fields, and will simply be using the Email HTML field instead.
    If you are ingesting large emails which are causing issues with large amounts of data being saved into incident fields, you should set the value to False.
    We recommend setting the value to False unless you are certain that you need the "Email Body HTML" and "Rendered HTML" incident fields.
  playbookInputQuery:
outputs:
- contextPath: Email.HTML
  description: The email HTML body if it exists.
  type: string
- contextPath: Email
  description: The email object.
  type: string
- contextPath: Email.CC
  description: The email CC addresses.
  type: string
- contextPath: Email.From
  description: The email sender address.
  type: string
- contextPath: Email.Subject
  description: The email subject.
  type: string
- contextPath: Email.To
  description: The email receiver addresses.
  type: string
- contextPath: Email.Text
  description: The email text body if it exists.
  type: string
- contextPath: Email.Headers
  description: The full email headers as a single string.
  type: string
- contextPath: Email.Attachments
  description: The list of attachment names in the email.
  type: string
- contextPath: Email.Format
  description: The format of the email if available.
  type: string
- contextPath: File
  description: The file object.
  type: string
- contextPath: QRCodeReader
  type: unknown
  description: The QR code reader primary key object.
- contextPath: QRCodeReader.Text
  description: The raw text extracted from the QR code image.
  type: String
- contextPath: QRCodeReader.Domain
  description: The domains extracted from the QR code image if they are present.
  type: String
- contextPath: QRCodeReader.URL
  description: The URLs extracted from the QR code image if they are present.
  type: String
- contextPath: QRCodeReader.IP
  description: The IPs extracted from the QR code image if they are present.
  type: String
tests:
- Phishing v3 - DomainSquatting+EML+MaliciousIndicators - Test
- Phishing v3 - Get Original Email + Search & Delete - Test
fromversion: 6.0.0
contentitemexportablefields:
  contentitemfields: {}
inputSections:
- inputs:
  - File
  - Email
  - EmailCC
  - EmailFrom
  - EmailSubject
  - EmailText
  - EmailHtml
  - EmailHeaders
  - EmailFormat
  - GetOriginalEmail
  - MessageID
  - UserID
  - Thread-Topic
  - EmailBrand
  - EmailFileToExtract
  - UseOldHTMLFields
  name: General (Inputs group)
  description: Generic group for inputs
outputSections:
- outputs:
  - Email.HTML
  - Email
  - Email.CC
  - Email.From
  - Email.Subject
  - Email.To
  - Email.Text
  - Email.Headers
  - Email.Attachments
  - Email.Format
  - File
  - QRCodeReader
  - QRCodeReader.Text
  - QRCodeReader.Domain
  - QRCodeReader.URL
  - QRCodeReader.IP
  name: General (Outputs group)
  description: Generic group for outputs
