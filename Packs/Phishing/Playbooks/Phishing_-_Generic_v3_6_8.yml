id: Phishing - Generic v3
version: -1
name: Phishing - Generic v3
description: "This playbook investigates and remediates a potential phishing incident. It engages with the user who triggered the incident while investigating the incident itself.\n\nNote:\n- Final remediation tasks are manual by default. can be managed by \"SearchAndDelete\" and \"BlockIndicators\" inputs. \n- Do not rerun this playbook inside a phishing incident since it can produce an unexpected result. Create a new incident instead if needed."
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 764e2a0a-d743-4ceb-8b0f-2a406e160a03
    type: start
    task:
      id: 764e2a0a-d743-4ceb-8b0f-2a406e160a03
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "39"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": -510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 1c773a80-5bc6-490d-8ea2-453a1246fde3
    type: regular
    task:
      id: 1c773a80-5bc6-490d-8ea2-453a1246fde3
      version: -1
      name: Assign to analyst
      description: Assigns the incident to an analyst based on the analyst's organizational role.
      scriptName: AssignAnalystToIncident
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      assignBy:
        simple: less-busy-user
      onCall:
        complex:
          root: inputs.OnCall
          transformers:
          - operator: toLowerCase
      roles:
        complex:
          root: inputs.Role
    reputationcalc: 1
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -260,
          "y": 2520
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: 1800c9e1-3969-4b8b-8437-4e35e28d0f7d
    type: regular
    task:
      id: 1800c9e1-3969-4b8b-8437-4e35e28d0f7d
      version: -1
      name: Manually review the incident
      description: Reviews the incident to determine if the email that the user reported is malicious.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -590,
          "y": 3200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 2a21c636-89fc-4a5d-88b0-7a96f3c59120
    type: regular
    task:
      id: 2a21c636-89fc-4a5d-88b0-7a96f3c59120
      version: -1
      name: Close investigation
      description: Closes the investigation.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "29"
    reputationcalc: 1
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -410,
          "y": 5040
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: 950f6a22-863a-42f4-8270-6b40536859d9
    type: title
    task:
      id: 950f6a22-863a-42f4-8270-6b40536859d9
      version: -1
      name: Triage
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "26"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": 300
        }
      }
    note: false
    timertriggers:
    - fieldname: triagesla
      action: start
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 891c54bd-a5f3-4320-8251-5bc15f196066
    type: regular
    task:
      id: 891c54bd-a5f3-4320-8251-5bc15f196066
      version: -1
      name: Acknowledge incident was received
      description: |
        Sends an auto-response to the user reporting the incident that the incident was received and is being handled.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "56"
    scriptarguments:
      body:
        simple: "Hi ${.=function(val) { if(!(val.Account.length > 1)) return val.incident.reporteremailaddress; var reporter = val.incident.reporteremailaddress; var account = val.Account && val.Account.filter(function(acc) { return acc.DisplayName && (acc.Email  === reporter || Array.isArray(acc.Email) && acc.Email.indexOf(reporter) > -1) }); return account && account[0] && account[0].DisplayName[0] || reporter || ''; }(val)},\nWe've received your email and are investigating.\n Do not touch the email until further notice.\n\nCordially, \n  Your friendly neighborhood security team"
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        complex:
          root: incident
          accessor: reporteremailaddress
      using:
        simple: ${inputs.SendMailInstance}
    reputationcalc: 1
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 770,
          "y": 800
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: a1e022e3-a588-4edf-8b65-d83f5f920fb4
    type: condition
    task:
      id: a1e022e3-a588-4edf-8b65-d83f5f920fb4
      version: -1
      name: Is the email malicious?
      description: Determines if the email is malicious based on the calculated severity.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "31"
      Malicious:
      - "30"
    separatecontext: false
    conditions:
    - label: Malicious
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              simple: incident.severity
            iscontext: true
          right:
            value:
              simple: "3"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -260,
          "y": 2685
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: b280bb2a-9064-4ce2-8eac-1d6917dc0a1f
    type: regular
    task:
      id: b280bb2a-9064-4ce2-8eac-1d6917dc0a1f
      version: -1
      name: Update the user that the reported email is safe
      description: Sends an email to the user explaining that the email they reported is safe.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "223"
    scriptarguments:
      body:
        simple: |-
          Hi ${.=function(val) { if(!(val.Account.length > 1)) return val.incident.reporteremailaddress; var reporter = val.incident.reporteremailaddress; var account = val.Account && val.Account.filter(function(acc) { return acc.DisplayName && (acc.Email  === reporter || Array.isArray(acc.Email) && acc.Email.indexOf(reporter) > -1) }); return account && account[0] && account[0].DisplayName[0] || reporter || ''; }(val)},
          We've concluded that the email you forwarded to us is safe. In case you think the verdict is not accurate and the email is suspicious, please contact our SOC team.
          Thank you for your alertness and your participation in keeping our organization secure.

          Cordially,
            Your security team
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        complex:
          root: incident
          accessor: reporteremailaddress
      using:
        simple: ${inputs.SendMailInstance}
    reputationcalc: 1
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -920,
          "y": 3945
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 6729d0e4-2557-4ff5-8d18-df51494a1279
    type: title
    task:
      id: 6729d0e4-2557-4ff5-8d18-df51494a1279
      version: -1
      name: Engage with User
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "222"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 770,
          "y": 300
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 2cd5a4a8-c413-4a02-8c06-56dd744698fb
    type: playbook
    task:
      id: 2cd5a4a8-c413-4a02-8c06-56dd744698fb
      version: -1
      name: Detonate File - Generic
      playbookName: Detonate File - Generic
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "52"
    separatecontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 200,
          "y": 600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: 0efc3de6-8781-4e24-8c03-9770b02ba313
    type: playbook
    task:
      id: 0efc3de6-8781-4e24-8c03-9770b02ba313
      version: -1
      name: Process Email - Generic v2
      description: |
        This playbook adds email details to the relevant context entities and handles original email attachments.

        The v2 playbook enables parsing email artifacts more efficiently, including:
        - Using incident fields and not incident labels.
        - Providing separate paths to "Phishing Alerts".
        - Using the new "Get Original Email - Generic v2" playbook to retrieve original emails as EML files from the following integrations:
          * EWS v2
          * Microsoft Graph Mail integration
          * Gmail
          * FireEye EX and FireEye CM
          * Proofpoint Protection Server
          * Agari Phishing Defense (EWS v2, MSGraph Mail, Gmail)
          * Mimecast
      playbookName: Process Email - Generic v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "55"
      - "22"
      - "88"
      - "137"
    scriptarguments:
      Email:
        complex:
          root: incident
          accessor: emailto
      EmailCC:
        complex:
          root: incident
          accessor: emailcc
      EmailFileToExtract:
        complex:
          root: inputs.EmailFileToExtract
      EmailFormat:
        complex:
          root: incident
          accessor: emailformat
      EmailFrom:
        complex:
          root: incident
          accessor: emailfrom
      EmailHeaders:
        complex:
          root: incident
          accessor: phishingreporteremailheaders
      EmailHtml:
        complex:
          root: incident
          accessor: emailhtml
      EmailSubject:
        complex:
          root: incident
          accessor: emailsubject
      EmailText:
        complex:
          root: incident
          accessor: emailbody
      File:
        complex:
          root: File
      GetOriginalEmail:
        complex:
          root: inputs.GetOriginalEmail
      MessageID:
        complex:
          root: incident
          accessor: emailmessageid
      Thread-Topic:
        complex:
          root: incident
          accessor: emailsubject
      UserID:
        complex:
          root: incident
          accessor: reporteremailaddress
    separatecontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": 430
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: b44cab0b-0179-42c4-8744-3ec614beeae8
    type: title
    task:
      id: b44cab0b-0179-42c4-8744-3ec614beeae8
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "97"
      - "98"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432.5,
          "y": 3740
        }
      }
    note: false
    timertriggers:
    - fieldname: remediationsla
      action: start
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: 2fe24e82-55b2-4e1c-8c44-b488f5370067
    type: playbook
    task:
      id: 2fe24e82-55b2-4e1c-8c44-b488f5370067
      version: -1
      name: Search And Delete Emails - Generic v2
      description: 'This playbook searches and deletes emails with similar attributes of a malicious email using one of the following integrations: * EWS * Office 365 * Gmail * Agari Phishing Defense'
      playbookName: Search And Delete Emails - Generic v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      AttachmentName:
        complex:
          root: incident
          accessor: attachmentname
      From:
        complex:
          root: incident
          accessor: reportedemailfrom
          transformers:
          - operator: ExtractEmailTransformer
      O365AllowNotFoundExchangeLocations:
        complex:
          root: inputs.O365AllowNotFoundSearchLocations
      O365DeleteType:
        complex:
          root: inputs.O365DeleteType
      O365ExchangeLocation:
        complex:
          root: .
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs==rhs
              else:
                value:
                  simple: incident.reportedemailto
                iscontext: true
              equals: {}
              lhs:
                value:
                  simple: inputs.O365ExchangeLocation
                iscontext: true
              options: {}
              rhs:
                value:
                  simple: All
              then:
                value:
                  simple: All
      O365ExchangeLocationExclusion:
        complex:
          root: inputs.O365ExchangeLocationExclusion
      O365KQL:
        simple: from:${incident.reportedemailfrom} AND subject:"${incident.reportedemailsubject}"
      SearchAndDeleteIntegration:
        complex:
          root: inputs.SearchAndDeleteIntegration
      SearchThisWeek:
        simple: "true"
      Subject:
        complex:
          root: incident
          accessor: emailsubject
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 212.5,
          "y": 4360
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: e2dd08fa-2206-4c6f-856c-efce77c2c6c1
    type: title
    task:
      id: e2dd08fa-2206-4c6f-856c-efce77c2c6c1
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -410,
          "y": 5205
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: aff35810-1604-4c11-81a3-8dbe2b5e4575
    type: title
    task:
      id: aff35810-1604-4c11-81a3-8dbe2b5e4575
      version: -1
      name: Email Is Malicious
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "214"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432.5,
          "y": 2880
        }
      }
    note: false
    timertriggers:
    - fieldname: detectionsla
      action: stop
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: b8cb22cf-f2cf-4e64-83c7-e82633cfaba8
    type: title
    task:
      id: b8cb22cf-f2cf-4e64-83c7-e82633cfaba8
      version: -1
      name: Undetermined
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "228"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -920,
          "y": 2880
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 56c53834-8bba-4824-84b9-1390d2d23c45
    type: condition
    task:
      id: 56c53834-8bba-4824-84b9-1390d2d23c45
      version: -1
      name: Is the email malicious?
      description: Is the email that the user reported malicious?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "No":
      - "226"
      "yes":
      - "30"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -590,
          "y": 3370
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: 8a4980a2-ca3a-4d68-807d-3e5b0a3a5484
    type: regular
    task:
      id: 8a4980a2-ca3a-4d68-807d-3e5b0a3a5484
      version: -1
      name: Manually search & delete emails
      description: Search for and delete emails with similar attributes of the malicious email using your existing email platfrom. for example - EWS, Office 365, Gmail etc.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -200,
          "y": 4360
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: 8ed9b501-0518-4cac-8fcf-c2051bf8291d
    type: condition
    task:
      id: 8ed9b501-0518-4cac-8fcf-c2051bf8291d
      version: -1
      name: Should emails be searched and deleted?
      description: Checks whether the **SearchAndDelete** playbook input is set to True.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "34"
      "Yes":
      - "152"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.SearchAndDelete
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 212.5,
          "y": 4010
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: b49669ab-6164-435a-837b-19ce60656301
    type: title
    task:
      id: b49669ab-6164-435a-837b-19ce60656301
      version: -1
      name: Start Detection Timer
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "161"
      - "212"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": -370
        }
      }
    note: false
    timertriggers:
    - fieldname: detectionsla
      action: start
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 52fdc875-fdb6-4d2c-8b09-9d2250cba38f
    type: title
    task:
      id: 52fdc875-fdb6-4d2c-8b09-9d2250cba38f
      version: -1
      name: Stop Remediation Timer
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "223"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432.5,
          "y": 4530
        }
      }
    note: false
    timertriggers:
    - fieldname: remediationsla
      action: stop
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: acd876d8-f2c1-4f90-80de-390f862c441c
    type: title
    task:
      id: acd876d8-f2c1-4f90-80de-390f862c441c
      version: -1
      name: Indicator Enrichment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "92"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -260,
          "y": 1150
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "53":
    id: "53"
    taskid: 2230a227-79e0-43fa-81c9-a2eb7239bb3b
    type: playbook
    task:
      id: 2230a227-79e0-43fa-81c9-a2eb7239bb3b
      version: -1
      name: Email Address Enrichment - Generic v2.1
      description: |-
        Enrich email addresses.
        - Get information from Active Directory for internal addresses
        - Get the domain-squatting reputation for external addresses
      playbookName: Email Address Enrichment - Generic v2.1
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      Email:
        complex:
          root: incident
          accessor: reporteremailaddress
          transformers:
          - operator: uniq
      InternalDomains:
        complex:
          root: inputs.InternalDomains
          transformers:
          - operator: uniq
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 770,
          "y": 620
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "55":
    id: "55"
    taskid: 4e6a8cf6-941a-40c9-8f07-51860654c6ce
    type: playbook
    task:
      id: 4e6a8cf6-941a-40c9-8f07-51860654c6ce
      version: -1
      name: Extract Indicators From File - Generic v2
      description: |-
        This playbook extracts indicators from a file.
        Supported file types:
        - CSV
        - PDF
        - TXT
        - HTM, HTML
        - DOC, DOCX
        - PPT
        - PPTX
        - RTF
        - XLS
        - XLSX
        - XML
      playbookName: Extract Indicators From File - Generic v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "160"
      - "162"
    separatecontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -720,
          "y": 600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "56":
    id: "56"
    taskid: 7a00dd55-8279-43e6-88ca-757ec3b09c56
    type: title
    task:
      id: 7a00dd55-8279-43e6-88ca-757ec3b09c56
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "101"
      - "80"
      - "131"
      - "154"
      - "170"
      - "216"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -260,
          "y": 1500
        }
      }
    note: false
    timertriggers:
    - fieldname: triagesla
      action: stop
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "79":
    id: "79"
    taskid: 0c9841bf-400e-41ff-82fc-3fab6fd6cb04
    type: condition
    task:
      id: 0c9841bf-400e-41ff-82fc-3fab6fd6cb04
      version: -1
      name: Should the email be authenticated?
      description: Checks whether the email should be authenticated using DKIM, SPF, and DMARC. This checks if "AuthenticateEmail" output is set to "True" and if there are headers from an email to authenticate.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "84"
      "yes":
      - "82"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.AuthenticateEmail
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
      - - operator: isExists
          left:
            value:
              complex:
                root: Email
                accessor: HeadersMap
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 20,
          "y": 1775
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "80":
    id: "80"
    taskid: c3eda292-86f1-4353-83ba-203ad2f4352f
    type: title
    task:
      id: c3eda292-86f1-4353-83ba-203ad2f4352f
      version: -1
      name: Email Authenticity Check
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "79"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 20,
          "y": 1640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "82":
    id: "82"
    taskid: 4d850f1c-5cb9-4b41-8fb3-bf1276359b25
    type: regular
    task:
      id: 4d850f1c-5cb9-4b41-8fb3-bf1276359b25
      version: -1
      name: Authenticate email
      description: Checks the authenticity of an email based on the email's SPF, DMARC, and DKIM.
      type: regular
      iscommand: false
      brand: ""
      scriptName: CheckEmailAuthenticity
    nexttasks:
      '#none#':
      - "83"
    scriptarguments:
      headers:
        complex:
          root: Email
          accessor: Headers
          transformers:
          - operator: uniq
      original_authentication_header:
        complex:
          root: inputs.OriginalAuthenticationHeader
    reputationcalc: 1
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 20,
          "y": 2000
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "83":
    id: "83"
    taskid: fb718623-96a1-4c7c-8acd-b6283ae10835
    type: regular
    task:
      id: fb718623-96a1-4c7c-8acd-b6283ae10835
      version: -1
      name: Save authenticity check result to incident field
      description: Saves the email authenticity verdict in an incident field.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "84"
    scriptarguments:
      emailauthenticitycheck:
        complex:
          root: Email
          accessor: AuthenticityCheck
          transformers:
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Undetermined
              toReplace:
                value:
                  simple: undetermined
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Pass
              toReplace:
                value:
                  simple: pass
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Fail
              toReplace:
                value:
                  simple: fail
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Suspicious
              toReplace:
                value:
                  simple: suspicious
    reputationcalc: 1
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 20,
          "y": 2175
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "84":
    id: "84"
    taskid: 5bb34c10-a58e-480a-8c9a-af220dac1b71
    type: playbook
    task:
      id: 5bb34c10-a58e-480a-8c9a-af220dac1b71
      version: -1
      name: Calculate Severity - Generic v2
      playbookName: Calculate Severity - Generic v2
      type: playbook
      iscommand: false
      brand: ""
      description: |-
        Calculate and assign the incident severity based on the highest returned severity level from the following calculations:

        - DBotScores of indicators
        - Critical assets
        - Email authenticity
        - Current incident severity
        - Microsoft Headers
        - Risky users (XDR)
        - Risky hosts (XDR)
    nexttasks:
      '#none#':
      - "2"
    separatecontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -260,
          "y": 2360
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
    scriptarguments:
      Account:
        complex:
          root: Account
          transformers:
          - operator: uniq
      DBotScoreIndicators:
        complex:
          root: DBotScore
          accessor: Indicator
          transformers:
          - operator: uniq
      DBotScoreMaxScore:
        complex:
          root: DBotScore
          accessor: Score
          transformers:
          - operator: sort
            args:
              descending:
                value:
                  simple: "true"
          - operator: uniq
          - operator: FirstArrayElement
      EmailAuthenticityCheck:
        complex:
          root: Email
          accessor: AuthenticityCheck
          transformers:
          - operator: uniq
      Endpoint:
        complex:
          root: Endpoint
          transformers:
          - operator: uniq
      MicrosoftHeadersSeverityCheck:
        complex:
          root: Email
          accessor: MicrosoftHeadersSeverityCheck
      XDRRiskyHosts:
        complex:
          root: PaloAltoNetworksXDR
          accessor: RiskyHost
          transformers:
          - operator: uniq
      XDRRiskyUsers:
        complex:
          root: PaloAltoNetworksXDR
          accessor: RiskyUser
          transformers:
          - operator: uniq
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
  "85":
    id: "85"
    taskid: 2eecb8e9-8b1d-4ba5-87d3-dbfbb10baf6e
    type: regular
    task:
      id: 2eecb8e9-8b1d-4ba5-87d3-dbfbb10baf6e
      version: -1
      name: Save reporter email address in field
      description: Saves the email address of the email reporter in an incident field.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "18"
      - "11"
    scriptarguments:
      reporteremailaddress:
        complex:
          root: incident
          accessor: emailfrom
          transformers:
          - operator: ExtractEmailTransformer
    reputationcalc: 1
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -250,
          "y": 80
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "88":
    id: "88"
    taskid: 93515270-79c3-4aa6-8368-c42e56a9d884
    type: title
    task:
      id: 93515270-79c3-4aa6-8368-c42e56a9d884
      version: -1
      name: Machine Learning
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "160"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1782.5,
          "y": 600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "92":
    id: "92"
    taskid: 4e6286b1-ec5b-46ea-8cbd-00769a2e7156
    type: playbook
    task:
      id: 4e6286b1-ec5b-46ea-8cbd-00769a2e7156
      version: -1
      name: Entity Enrichment - Phishing v2
      description: Enrich entities using one or more integrations
      playbookName: Entity Enrichment - Phishing v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "56"
    scriptarguments:
      Domain:
        complex:
          root: Domain
          accessor: Name
          transformers:
          - operator: uniq
      Email:
        complex:
          root: Account.Email.Address
          filters:
          - - operator: isNotEqualString
              left:
                value:
                  simple: Account.Email.Address
                iscontext: true
              right:
                value:
                  simple: incident.reporteremailaddress
                iscontext: true
          - - operator: isNotEqualString
              left:
                value:
                  simple: Account.Email.Address
                iscontext: true
              right:
                value:
                  simple: ListenerMailbox
                iscontext: true
          transformers:
          - operator: uniq
      Hostname:
        complex:
          root: Endpoint
          accessor: Hostname
          transformers:
          - operator: uniq
      IP:
        complex:
          root: IP
          accessor: Address
          transformers:
          - operator: uniq
      InternalDomains:
        complex:
          root: inputs.InternalDomains
      InternalRange:
        complex:
          root: inputs.InternalRange
      MD5:
        complex:
          root: File
          accessor: MD5
          transformers:
          - operator: uniq
      ResolveIP:
        simple: "False"
      SHA1:
        complex:
          root: File
          accessor: SHA1
          transformers:
          - operator: uniq
      SHA256:
        complex:
          root: File
          accessor: SHA256
          transformers:
          - operator: uniq
      URL:
        complex:
          root: URL
          accessor: Data
          transformers:
          - operator: uniq
      Username:
        complex:
          root: Account
          accessor: Username
          transformers:
          - operator: uniq
    separatecontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -260,
          "y": 1290
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "97":
    id: "97"
    taskid: a7b4bb19-9c0b-40c8-890d-5a5da0cf7972
    type: title
    task:
      id: a7b4bb19-9c0b-40c8-890d-5a5da0cf7972
      version: -1
      name: Block Indicators
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "220"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 640,
          "y": 3880
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "98":
    id: "98"
    taskid: 71986de1-6dbe-4cbd-8d04-40c0c3e19002
    type: title
    task:
      id: 71986de1-6dbe-4cbd-8d04-40c0c3e19002
      version: -1
      name: Search & Delete Email
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "36"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 212.5,
          "y": 3880
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "101":
    id: "101"
    taskid: 537c8613-599f-4d14-8f71-740bb8aab754
    type: title
    task:
      id: 537c8613-599f-4d14-8f71-740bb8aab754
      version: -1
      name: Email Campaign Search
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "126"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1050,
          "y": 1640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "126":
    id: "126"
    taskid: 7e6770b8-3b05-4b18-85b4-3c74c96e9e16
    type: playbook
    task:
      id: 7e6770b8-3b05-4b18-85b4-3c74c96e9e16
      version: -1
      name: Detect & Manage Phishing Campaigns
      description: |-
        This playbook is part of the Phishing Campaign content pack, available only on Cortex XSOAR.
        It is used to find, create, and manage phishing campaigns. When a number of similar phishing incidents exist in the system, the playbook can be used to do the following:
        1. Find and link related incidents to the same phishing attack (a phishing campaign).
        2. Search for an existing Phishing Campaign incident, or create a new incident for the linked Phishing incidents.
        3. Link all detected phishing incidents to the Phishing Campaign incident that was found or that was created previously.
        4. Update the Phishing Campaign incident with the latest data about the campaign, and update all related phishing incidents to indicate that they are part of the campaign.
      playbookName: Detect & Manage Phishing Campaigns
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "84"
    scriptarguments:
      AutomaticallyLinkIncidents:
        simple: "True"
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -1050,
          "y": 1775
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "131":
    id: "131"
    taskid: 81471c48-09d7-4705-8324-6f192b98302c
    type: title
    task:
      id: 81471c48-09d7-4705-8324-6f192b98302c
      version: -1
      name: Microsoft's Headers Check
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "132"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1507.5,
          "y": 1640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "132":
    id: "132"
    taskid: 2f517fae-46e2-493e-8239-5c8d2cf47a83
    type: condition
    task:
      id: 2f517fae-46e2-493e-8239-5c8d2cf47a83
      version: -1
      name: Check Microsoft's Headers?
      description: Whether to check Microsoft's proprietary email headers.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "84"
      "yes":
      - "133"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.CheckMicrosoftHeaders
            iscontext: true
          right:
            value:
              simple: "True"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1507.5,
          "y": 1775
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "133":
    id: "133"
    taskid: 4434d6bb-eff2-4d7b-826c-bbb67c815a26
    type: playbook
    task:
      id: 4434d6bb-eff2-4d7b-826c-bbb67c815a26
      version: -1
      name: Process Microsoft's Anti-Spam Headers
      description: "This playbook stores the SCL, BCL, and PCL scores if they exist to the associated incident fields (Phishing SCL Score, Phishing PCL Score, and Phishing BCL Score).\nIt also does the following:\n1) Sets the email classification to \"spam\" if the SCL score is equal to or greater than 5.\n2) Sets the incident severity according to the playbook inputs (default is: PCL/BCL - Medium, SCL - Low). The severity of the incident is set only when one (or more) of the following occurs:\n  - PCL (Phishing Confidence Level) score between and including 4-8: The message content is likely to be phishing.\n  - [BCL](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/bulk-complaint-level-values?view=o365-worldwide) (Bulk Complaint Level) score between and including 4-7: The message is from a bulk sender that generates a mixed number of complaints. \n    For a score between and including 8-9: The message is from a bulk sender that generates a high number of complaints.\n  - [SCL](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/spam-confidence-levels?view=o365-worldwide) (Spam Confidence Level) score between and including 5-6: Spam filtering marks the message as spam. \n    For a score of 9: Spam filtering marks the message as high confidence spam. See [anti-spam stamps](https://docs.microsoft.com/en-us/exchange/antispam-and-antimalware/antispam-protection/antispam-stamps?view=exchserver-2019)."
      playbookName: Process Microsoft's Anti-Spam Headers
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "84"
    separatecontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1507.5,
          "y": 2160
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "137":
    id: "137"
    taskid: 22621cb0-9084-4814-84f8-506ecfa3da75
    type: condition
    task:
      id: 22621cb0-9084-4814-84f8-506ecfa3da75
      version: -1
      name: Detonate URL?
      description: Whether to detonate URLs in supported sandboxes.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "52"
      "yes":
      - "227"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.DetonateURL
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -260,
          "y": 600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "148":
    id: "148"
    taskid: f85cd17f-8468-4877-8cad-4b86e2cdd822
    type: regular
    task:
      id: f85cd17f-8468-4877-8cad-4b86e2cdd822
      version: -1
      name: Update the user that the reported email is malicious
      description: Sends an email to the user explaining that the email they reported is malicious.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "27"
    scriptarguments:
      body:
        simple: |-
          Hi ${.=function(val) { if(!(val.Account.length > 1)) return val.incident.reporteremailaddress; var reporter = val.incident.reporteremailaddress; var account = val.Account && val.Account.filter(function(acc) { return acc.DisplayName && (acc.Email  === reporter || Array.isArray(acc.Email) && acc.Email.indexOf(reporter) > -1) }); return account && account[0] && account[0].DisplayName[0] || reporter || ''; }(val)},
          We've concluded that the email you forwarded to us is malicious. No further action is required on your part. Good job on detecting and forwarding it to us!

          All the best,
            Your security team
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        complex:
          root: incident
          accessor: reporteremailaddress
      using:
        simple: ${inputs.SendMailInstance}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 190,
          "y": 3570
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "149":
    id: "149"
    taskid: ff55d5c6-09f3-4387-87fb-2489117f7827
    type: condition
    task:
      id: ff55d5c6-09f3-4387-87fb-2489117f7827
      version: -1
      name: Can the user be informed about the verdict?
      description: Checks whether the user can be informed about the verdict of the incident.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "27"
      yes - phishing:
      - "148"
      yes - phishing campaign:
      - "150"
    separatecontext: false
    conditions:
    - label: yes - phishing campaign
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: PartOfCampaign
            iscontext: true
          right:
            value: {}
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: reporteremailaddress
            iscontext: true
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.UserEngagement
            iscontext: true
          right:
            value:
              simple: "true"
          ignorecase: true
    - label: yes - phishing
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: reporteremailaddress
            iscontext: true
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.UserEngagement
            iscontext: true
          right:
            value:
              simple: "true"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432.5,
          "y": 3360
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "150":
    id: "150"
    taskid: e8456a5c-f63e-4779-86ef-886fccf74b6f
    type: regular
    task:
      id: e8456a5c-f63e-4779-86ef-886fccf74b6f
      version: -1
      name: Update the user that the email is a malicious campaign
      description: Sends an email to the user explaining that the email they reported is malicious.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "27"
    scriptarguments:
      body:
        simple: |-
          Hi ${.=function(val) { if(!(val.Account.length > 1)) return val.incident.reporteremailaddress; var reporter = val.incident.reporteremailaddress; var account = val.Account && val.Account.filter(function(acc) { return acc.DisplayName && (acc.Email  === reporter || Array.isArray(acc.Email) && acc.Email.indexOf(reporter) > -1) }); return account && account[0] && account[0].DisplayName[0] || reporter || ''; }(val)},
          We've concluded that the email you forwarded to us is part of a bigger phishing campaign that targeted our company. No further action is required on your part. Good job on detecting and forwarding it to us!

          All the best,
            Your security team
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        complex:
          root: incident
          accessor: reporteremailaddress
      using:
        simple: ${inputs.SendMailInstance}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 660,
          "y": 3570
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "151":
    id: "151"
    taskid: 780ad337-732b-4fed-87ed-b5c8518ad157
    type: condition
    task:
      id: 780ad337-732b-4fed-87ed-b5c8518ad157
      version: -1
      name: Can the user be informed about the verdict?
      description: Checks whether the user can be informed about the verdict of the incident.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "223"
      "Yes":
      - "16"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: reporteremailaddress
            iscontext: true
          right:
            value: {}
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.UserEngagement
            iscontext: true
          right:
            value:
              simple: "true"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -920,
          "y": 3750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "152":
    id: "152"
    taskid: 4cc63191-62db-40cd-8ad9-7989263c0218
    type: condition
    task:
      id: 4cc63191-62db-40cd-8ad9-7989263c0218
      version: -1
      name: Check if original email was retrieved
      description: Checks if the original email was retrieved using the email listener integration.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "34"
      "yes":
      - "28"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: reportedemailfrom
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 212.5,
          "y": 4185
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "154":
    id: "154"
    taskid: f743bd3c-e770-4c95-842e-3c756d517f3e
    type: title
    task:
      id: f743bd3c-e770-4c95-842e-3c756d517f3e
      version: -1
      name: Spear Phishing
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "225"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 970,
          "y": 1640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "157":
    id: "157"
    taskid: 5114d521-be2e-4124-8bc8-f27b26e2ea41
    type: title
    task:
      id: 5114d521-be2e-4124-8bc8-f27b26e2ea41
      version: -1
      name: Reporter Address specified
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "11"
      - "18"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 300,
          "y": 80
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "160":
    id: "160"
    taskid: 9ff4d990-f0b2-4085-8352-137c92a77882
    type: playbook
    task:
      id: 9ff4d990-f0b2-4085-8352-137c92a77882
      version: -1
      name: Phishing - Machine Learning Analysis
      description: Predicts phishing emails and URLs using machine-learning, available on Cortex XSOAR.
      playbookName: Phishing - Machine Learning Analysis
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "84"
    scriptarguments:
      DBotPredictURLPhishingURLsNumber:
        complex:
          root: inputs.DBotPredictURLPhishingURLsNumber
      EmailHTML:
        complex:
          root: Email
          accessor: HTML
      EmailSubject:
        complex:
          root: Email
          accessor: Subject
      EmailText:
        complex:
          root: Email
          accessor: Text
      ExtractedURLsFromFiles:
        complex:
          root: ExtractedURLsFromFiles
          transformers:
          - operator: uniq
      PhishingModelName:
        complex:
          root: inputs.PhishingModelName
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -1782.5,
          "y": 795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "161":
    id: "161"
    taskid: 025dd64c-3af8-45db-8b66-7f52b7336c3d
    type: condition
    task:
      id: 025dd64c-3af8-45db-8b66-7f52b7336c3d
      version: -1
      name: Was the reporter of the phishing email specified?
      description: Checks whether the email address of the phishing email reporter was specified on incident creation, so that an acknowledgement email can be sent to them.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "No":
      - "85"
      No - Manual:
      - "11"
      "Yes":
      - "157"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: reporteremailaddress
            iscontext: true
          right:
            value: {}
    - label: No - Manual
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: incident.sourceBrand
            iscontext: true
          right:
            value:
              simple: Manual
        - operator: isEmpty
          left:
            value:
              simple: incident.sourceBrand
            iscontext: true
    - label: "No"
      condition:
      - - operator: isNotEqualString
          left:
            value:
              simple: incident.sourceBrand
            iscontext: true
          right:
            value:
              simple: Manual
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": -190
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "162":
    id: "162"
    taskid: 9825e00a-0f24-4f95-8c7c-2ea4051fcb18
    type: condition
    task:
      id: 9825e00a-0f24-4f95-8c7c-2ea4051fcb18
      version: -1
      name: Was a file with macro found?
      description: Check if a file with macro was found
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "52"
      "yes":
      - "163"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: Oletools.Olevba.ole_command_result
                accessor: macro_src_code
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -720,
          "y": 790
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "163":
    id: "163"
    taskid: b94fdcdc-3521-4667-80b3-e4b4e11d093c
    type: regular
    task:
      id: b94fdcdc-3521-4667-80b3-e4b4e11d093c
      version: -1
      name: Set Macro Source Code field
      description: commands.local.cmd.set.incident
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "52"
    scriptarguments:
      macrosourcecode:
        complex:
          root: Oletools.Olevba.ole_command_result
          accessor: macro_src_code
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -720,
          "y": 975
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "170":
    id: "170"
    taskid: 09cbe399-8ea4-4b75-8d7f-6775ef29d9da
    type: title
    task:
      id: 09cbe399-8ea4-4b75-8d7f-6775ef29d9da
      version: -1
      name: Email Indicators Hunting
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "179"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 500,
          "y": 1640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "179":
    id: "179"
    taskid: b58807d2-f9bc-4fff-8dad-359cb6102638
    type: condition
    task:
      id: b58807d2-f9bc-4fff-8dad-359cb6102638
      version: -1
      name: Hunt email indicators?
      description: Check if playbook should hunt for email indicators
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "84"
      "yes":
      - "211"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.HuntEmailIndicators
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: url
                    ignorecase: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                    ignorecase: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: domain
                    ignorecase: true
                - - operator: greaterThanOrEqual
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                accessor: Indicator
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore.Indicator
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: file
                    ignorecase: true
                  - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: hash
                    ignorecase: true
                - - operator: greaterThanOrEqual
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "3"
                - - operator: stringHasLength
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: "64"
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 500,
          "y": 1775
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "211":
    id: "211"
    taskid: 03795aae-9d34-4d4d-8aef-93484f758fd3
    type: playbook
    task:
      id: 03795aae-9d34-4d4d-8aef-93484f758fd3
      version: -1
      name: Phishing - Indicators Hunting
      description: |
        Hunt indicators related to phishing with available integrations and handle the results. Handling the results will include setting relevant incident fields which will be displayed in the layout and optionally, opening new incidents according to the findings.
        Current integration in this playbook:
        - Microsoft 365 Defender (using "Advanced Hunting")

        Note that this playbook should be used as a sub-playbook inside a phishing incident and not as a main playbook.
      playbookName: Phishing - Indicators Hunting
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "84"
    scriptarguments:
      DBotScore:
        complex:
          root: DBotScore
          filters:
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
      EmailHuntingCreateNewIncidents:
        complex:
          root: inputs.EmailHuntingCreateNewIncidents
      ListenerMailbox:
        complex:
          root: ListenerMailbox
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 500,
          "y": 2000
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "212":
    id: "212"
    taskid: 1a970299-8476-4bd3-8e34-20893a042217
    type: regular
    task:
      id: 1a970299-8476-4bd3-8e34-20893a042217
      version: -1
      name: Set Listener Mailbox
      description: In order to exclude the listener mailbox from hunting actions, it is needed to save it (before it changes) in a dedicated field.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      key:
        simple: ListenerMailbox
      value:
        complex:
          root: .
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs!=rhs
              else:
                value:
                  simple: incident.emailto
                iscontext: true
              equals: {}
              lhs:
                value:
                  simple: inputs.ListenerMailbox
                iscontext: true
              options: {}
              rhs: {}
              then:
                value:
                  simple: inputs.ListenerMailbox
                iscontext: true
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -757.5,
          "y": -15
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "213":
    id: "213"
    taskid: 89011925-aa02-4eaf-8f0b-a50ef84f128a
    type: playbook
    task:
      id: 89011925-aa02-4eaf-8f0b-a50ef84f128a
      version: -1
      name: Block Indicators - Generic v3
      description: |+
        This playbook blocks malicious indicators using all integrations that are enabled, using the following sub-playbooks:

        - Block URL - Generic v2
        - Block Account - Generic v2
        - Block IP - Generic v3
        - Block File - Generic v2
        - Block Email - Generic v2
        - Block Domain - Generic v2

      playbookName: Block Indicators - Generic v3
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      AutoBlockIndicators:
        complex:
          root: inputs.BlockIndicators
      DomainToBlock:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: domain
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: SemiAutomatedBlockOptions.Name
                iscontext: true
          - operator: uniq
      EmailToBlock:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: email
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: SemiAutomatedBlockOptions.Email.Address
                iscontext: true
          - operator: uniq
      FilesToBlock:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: file
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: SemiAutomatedBlockOptions.SHA256
                iscontext: true
          - operator: uniq
      IP:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: ip
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: SemiAutomatedBlockOptions.Address
                iscontext: true
          - operator: uniq
      InputEnrichment:
        simple: "False"
      RuleDirection:
        simple: outbound
      RuleName:
        simple: XSOAR - Block Indicators playbook - ${incident.id}
      URL:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: url
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: SemiAutomatedBlockOptions.Data
                iscontext: true
          - operator: uniq
      UserVerification:
        simple: "False"
      Username:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: username
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: uniq
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 640,
          "y": 4360
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "214":
    id: "214"
    taskid: 37a8f648-75c8-464a-855e-ff5eff82239f
    type: condition
    task:
      id: 37a8f648-75c8-464a-855e-ff5eff82239f
      version: -1
      name: Phishing email sender address exist?
      description: Check if the sender email address of the phishing email exist
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "149"
      "yes":
      - "215"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: reportedemailfrom
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 432.5,
          "y": 3010
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "215":
    id: "215"
    taskid: f40e5582-fe2d-46c6-861b-8a39f1fadd56
    type: regular
    task:
      id: f40e5582-fe2d-46c6-861b-8a39f1fadd56
      version: -1
      name: Set phishing email sender address verdict as malicious
      description: commands.local.cmd.set.indicator
      script: Builtin|||setIndicator
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "149"
    scriptarguments:
      value:
        complex:
          root: incident
          accessor: reportedemailfrom
      verdict:
        simple: Malicious
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 660,
          "y": 3190
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "216":
    id: "216"
    taskid: d9b3d162-f9a4-456d-8152-8886145f1a76
    type: title
    task:
      id: d9b3d162-f9a4-456d-8152-8886145f1a76
      version: -1
      name: Threat Intelligence Analysis
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "217"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -600,
          "y": 1640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "217":
    id: "217"
    taskid: f36a1fb4-aab4-4a3d-8203-138e42b0c453
    type: playbook
    task:
      id: f36a1fb4-aab4-4a3d-8203-138e42b0c453
      version: -1
      name: TIM - Indicator Relationships Analysis
      playbookName: TIM - Indicator Relationships Analysis
      type: playbook
      iscommand: false
      brand: ""
      description: |-
        This playbook is designed to assist with a security investigation by providing an analysis of indicator relationships. The following information is included:
        - Indicators of compromise (IOCs) related to the investigation.
        - Attack patterns related to the investigation.
        - Campaigns related to the investigation.
        - IOCs associated with the identified campaigns.
        - Reports containing details on the identified campaigns.
    nexttasks:
      '#none#':
      - "218"
    scriptarguments:
      Indicator:
        complex:
          root: IP
          accessor: Address
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: URL.Data
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: Domain.Name
                iscontext: true
          - operator: uniq
      LimitResults:
        simple: "150"
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -600,
          "y": 1775
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "218":
    id: "218"
    taskid: 61ccb9e9-c5de-4f90-81a3-19df033fcc89
    type: condition
    task:
      id: 61ccb9e9-c5de-4f90-81a3-19df033fcc89
      version: -1
      name: Incident indicators related to campaign/report from TIM?
      description: Check if there are indicators related to any campaign or report in TIM
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "84"
      "yes":
      - "219"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: RelatedCampaign
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: RelatedReport
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -600,
          "y": 1950
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "219":
    id: "219"
    taskid: 5dc7d6b7-460a-43ec-82ae-ff5b93931446
    type: regular
    task:
      id: 5dc7d6b7-460a-43ec-82ae-ff5b93931446
      version: -1
      name: Set Threat Intel findings to layout
      description: commands.local.cmd.set.incident
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "84"
    scriptarguments:
      relatedcampaign:
        complex:
          root: RelatedCampaign
      relatedreport:
        complex:
          root: RelatedReport
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -600,
          "y": 2150
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "220":
    id: "220"
    taskid: 0707c61d-fcf9-4ba1-83ad-ac7c7101cee5
    type: condition
    task:
      id: 0707c61d-fcf9-4ba1-83ad-ac7c7101cee5
      version: -1
      name: Automatically block indicators?
      description: Check if playbook should block indicators automatically
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "221"
      "yes":
      - "213"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.BlockIndicators
            iscontext: true
          right:
            value:
              simple: "true"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 640,
          "y": 4010
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "221":
    id: "221"
    taskid: c1ae6a31-e4c6-49d7-8499-233b81f24523
    type: regular
    task:
      id: c1ae6a31-e4c6-49d7-8499-233b81f24523
      version: -1
      name: Set all indicators to semi-automated block options
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "213"
    scriptarguments:
      key:
        simple: SemiAutomatedBlockOptions
      value:
        complex:
          root: File
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: Domain
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: Account
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: URL
                iscontext: true
          - operator: append
            args:
              item:
                value:
                  simple: IP
                iscontext: true
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 890,
          "y": 4180
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "222":
    id: "222"
    taskid: 4739097c-4b92-4d2e-8518-f2d94930acc0
    type: condition
    task:
      id: 4739097c-4b92-4d2e-8518-f2d94930acc0
      version: -1
      name: Engage with the user?
      description: Checks whether to inform the user about the verdict of the incident.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "56"
      "yes":
      - "53"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.UserEngagement
            iscontext: true
          right:
            value:
              simple: "true"
          ignorecase: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: reporteremailaddress
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 770,
          "y": 430
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "223":
    id: "223"
    taskid: d83ef1c7-1367-42d7-8898-3d815a577fcf
    type: condition
    task:
      id: d83ef1c7-1367-42d7-8898-3d815a577fcf
      version: -1
      name: Pause to manually perform additional actions?
      description: Check if playbook needs to pause and wait for manual actions by the analyst
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "8"
      "yes":
      - "224"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.TakeManualActions
            iscontext: true
          right:
            value:
              simple: "true"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -410,
          "y": 4700
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "224":
    id: "224"
    taskid: d7918e94-ac89-4fa0-8251-87a2c970221e
    type: regular
    task:
      id: d7918e94-ac89-4fa0-8251-87a2c970221e
      version: -1
      name: Take manual actions
      description: Take notes and additional necessary manual actions before continuing. Once this task will be completed, the incident will be closed.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "8"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -640,
          "y": 4870
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "225":
    id: "225"
    taskid: 51fa619e-4216-461a-8f18-b763d7ab915a
    type: playbook
    task:
      id: 51fa619e-4216-461a-8f18-b763d7ab915a
      version: -1
      name: Spear Phishing Investigation
      playbookName: Spear Phishing Investigation
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "84"
    scriptarguments:
      DomainSquattingResults:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Vendor
                iscontext: true
              right:
                value:
                  simple: DomainSquatting
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Indicator
                iscontext: true
              right:
                value:
                  simple: incident.reportedemailfrom
                iscontext: true
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "2"
          accessor: Indicator
      KeywordsToSearch:
        complex:
          root: inputs.KeyWordsToSearch
      MailBody:
        complex:
          root: incident
          accessor: emailbody
          transformers:
          - operator: SetIfEmpty
            args:
              applyIfEmpty: {}
              defaultValue:
                value:
                  simple: incident.emailbodyhtml
                iscontext: true
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 970,
          "y": 1775
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "226":
    id: "226"
    taskid: 2af006cd-a5df-49ea-844e-ba49ab664b6e
    type: title
    task:
      id: 2af006cd-a5df-49ea-844e-ba49ab664b6e
      version: -1
      name: Email Is Benign
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "151"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -920,
          "y": 3580
        }
      }
    note: false
    timertriggers:
    - fieldname: detectionsla
      action: stop
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "227":
    id: "227"
    taskid: b7d56405-d0e0-4421-8d2a-54bdb5104285
    type: playbook
    task:
      id: b7d56405-d0e0-4421-8d2a-54bdb5104285
      version: -1
      name: Detonate URL - Generic v1.5
      playbookName: Detonate URL - Generic v1.5
      type: playbook
      iscommand: false
      brand: ""
      description: |-
        Detonate a URL through one or more active integrations that support URL detonation.
        Supported integrations:
        - SecneurX Analysis
        - ANY.RUN
        - McAfee Advanced Threat Defense
        - WildFire
        - Lastline
        - Cuckoo Sandbox
        - Cisco Secure Malware Analytics (ThreatGrid)
        - JoeSecurity
        - CrowdStrike Falcon Sandbox
        - FireEye AX
        - VMRay Analyzer
        - Polygon
        - CrowdStrike Falcon Intelligence Sandbox
        - OPSWAT Filescan
        - ANYRUN
        -  VirusTotal
        - Anomali ThreatStream
        - Hatching Triage
    nexttasks:
      '#none#':
      - "52"
    scriptarguments:
      URL:
        complex:
          root: URL
          accessor: Data
          transformers:
          - operator: uniq
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -260,
          "y": 790
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "228":
    id: "228"
    taskid: 95ec8c6f-527e-49dc-83fc-03fe573e46ab
    type: condition
    task:
      id: 95ec8c6f-527e-49dc-83fc-03fe573e46ab
      version: -1
      name: Should be reviewed by analyst?
      type: condition
      iscommand: false
      brand: ""
      description: "Should be reviewed by analyst?"
    nexttasks:
      '#default#':
      - "226"
      "yes":
      - "7"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.NonMaliciousEmailReview
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -920,
          "y": 3010
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "132_133_yes": 0.7,
      "132_84_#default#": 0.33,
      "137_227_yes": 0.41,
      "137_52_#default#": 0.16,
      "149_148_yes - phishing": 0.66,
      "149_27_#default#": 0.21,
      "151_16_Yes": 0.72,
      "151_223_#default#": 0.19,
      "152_28_yes": 0.38,
      "15_30_Malicious": 0.48,
      "15_31_#default#": 0.52,
      "162_163_yes": 0.41,
      "162_52_#default#": 0.22,
      "179_211_yes": 0.5,
      "179_84_#default#": 0.1,
      "214_215_yes": 0.37,
      "218_84_#default#": 0.48,
      "222_53_yes": 0.42,
      "222_56_#default#": 0.17,
      "223_224_yes": 0.47,
      "228_7_yes": 0.65,
      "33_226_No": 0.55,
      "33_30_yes": 0.34,
      "36_152_Yes": 0.49,
      "79_82_yes": 0.46,
      "79_84_#default#": 0.17
    },
    "paper": {
      "dimensions": {
        "height": 5780,
        "width": 3132.5,
        "x": -1782.5,
        "y": -510
      }
    }
  }
inputs:
- key: Role
  value: {}
  required: true
  description: The default role to assign the incident to.
  playbookInputQuery:
- key: SearchAndDelete
  value:
    simple: "False"
  required: false
  description: |-
    Enables the Search and Delete capability.
    For a malicious email, the "Search and Delete" sub-playbook looks for other instances of the email and deletes them pending analyst approval.
  playbookInputQuery:
- key: BlockIndicators
  value:
    simple: "False"
  required: false
  description: |-
    This input manages the automated block indicators capability.
    Set to "True" for automatically block all malicious indicators.
    Set to "False" to manually choose which indicators to block, if any.
  playbookInputQuery:
- key: AuthenticateEmail
  value:
    simple: "True"
  required: false
  description: Determines whether the authenticity of the email should be verified using SPF, DKIM, and DMARC.
  playbookInputQuery:
- key: OnCall
  value:
    simple: "False"
  required: false
  description: Set to True to assign only the user that is currently on shift.
  playbookInputQuery:
- key: SearchAndDeleteIntegration
  value:
    simple: EWS
  required: false
  description: |-
    Determines which product and playbook is used to search and delete the phishing email from user inboxes.
      - Set this to "O365" to use the "O365 - Security And Compliance - Search And Delete" playbook.
      - Set this to "EWS" to use the "Search And Delete Emails - EWS" playbook.
      - Set this to "Gmail" to use the "Search And Delete - Gmail" playbook.
  playbookInputQuery:
- key: O365DeleteType
  value:
    simple: Soft
  required: false
  description: |-
    Sets the method to delete emails in the "O365 - Security And Compliance - Search And Delete" playbook. Can be "Soft" (recoverable), or "Hard" (unrecoverable). Leave empty to decide manually for each email incident.
    This is only applicable if the SearchAndDeleteIntegration input is set to "O365".
  playbookInputQuery:
- key: O365ExchangeLocation
  value: {}
  required: false
  description: The exchange location. Determines from where to search and delete emails using O365 playbooks. Use the value "All" to search all mailboxes. If no input provided, it will search and delete the email only from the recipient's mailboxes. Note - Searching all mailboxes may take a significant amount of time. This input is used only when searching and deleting emails in O365 and only applies if the SearchAndDeleteIntegration input is set to O365.
  playbookInputQuery:
- key: O365AllowNotFoundSearchLocations
  value:
    simple: "False"
  required: false
  description: Used only when searching and deleting emails in O365. Determines whether to include mailboxes other than regular user mailboxes in the compliance search.
  playbookInputQuery:
- key: O365ExchangeLocationExclusion
  value: {}
  required: false
  description: Used only when searching and deleting emails in O365. A comma-separated list of mailboxes/distribution groups to exclude when you use the value "All" for the O365ExchangeLocation input.
  playbookInputQuery:
- key: CheckMicrosoftHeaders
  value:
    simple: "True"
  required: false
  description: Whether to check Microsoft headers for BCL/PCL/SCL scores and set the "Severity" and "Email Classification" accordingly.
  playbookInputQuery:
- key: InternalDomains
  value: {}
  required: false
  description: A CSV list of internal domains. The list is used to determine whether an email address is internal or external.
  playbookInputQuery:
- key: DetonateURL
  value:
    simple: "False"
  required: false
  description: Determines whether to use the "URL Detonation" playbook. Detonating a URL may take a few minutes.
  playbookInputQuery:
- key: InternalRange
  value:
    complex:
      root: lists
      accessor: PrivateIPs
      transformers:
      - operator: RegexExtractAll
        args:
          error_if_no_match: {}
          ignore_case: {}
          multi_line: {}
          period_matches_newline: {}
          regex:
            value:
              simple: (\b(?:\d{1,3}\.){3}\d{1,3}\b/\d{1,2})
          unpack_matches: {}
      - operator: join
        args:
          separator:
            value:
              simple: ','
  required: false
  description: |-
    This input is used in the "Entity Enrichment - Phishing v2" playbook.
    A list of internal IP ranges to check IP addresses against. The comma-separated list should be provided in CIDR notation. For example, a list of ranges is: "172.16.0.0/12,10.0.0.0/8,192.168.0.0/16" (without quotes).
  playbookInputQuery:
- key: PhishingModelName
  value: {}
  required: false
  description: Optional - the name of a pre-trained phishing model to predict phishing type using machine learning.
  playbookInputQuery:
- key: GetOriginalEmail
  value:
    simple: "False"
  required: false
  description: |-
    For forwarded emails. When "True", retrieves the original email in the thread.

    You must have the necessary permissions in your email service to execute global search.

    - For EWS: eDiscovery
    - For Gmail: Google Apps Domain-Wide Delegation of Authority
    - For MSGraph: As described in these links
    https://docs.microsoft.com/en-us/graph/api/message-get
    https://docs.microsoft.com/en-us/graph/api/user-list-messages
  playbookInputQuery:
- key: DBotPredictURLPhishingURLsNumber
  value:
    simple: "3"
  required: false
  description: |-
    The number of URLs to extract from the email HTML and analyze in the "DBotPredictURLPhishing" automation.
    This automation runs several checks to determine the score of the URLs found in the email, sets a verdict for URLs found as "Suspicious" or "Malicious", and adds these URLs as indicators. Based on the verdict, the incident severity is set (Medium for "Suspicious" and High for "Malicious").
    Note:
    - You need to install the "Phishing URL" pack to use this automation.
    - False/True positives are possible.
    - This automation may take a few minutes to run.
    - To increase result accuracy, it is recommended to install and enable the "Whois" pack (optional).
  playbookInputQuery:
- key: EmailFileToExtract
  value:
    simple: Inner file
  required: false
  description: |-
    Reported emails and emails retrieved during playbook execution can contain multiple nested email files. For example, an EML nested inside another EML file.
    If multiple level files are detected, this field determines which file represents the phishing email.

    For example:
    User1 receives an email from Attacker. User1 attaches the email as an EML file and sends the email to User2.
    User2 also attaches that email as a file, and reports it as phishing. In this case, the phishing email would be the "inner file" (as opposed to "outer file").

    Possible values are: Inner file, Outer file, All files.
    Inner file: The file at the deepest level is parsed. If there is only one file, that file is parsed.
    Outer file: The file at the first level is parsed.
    All files: All files are parsed. Do not use this option in the phishing playbook, as there should only be one phishing email per playbook run.
  playbookInputQuery:
- key: HuntEmailIndicators
  value:
    simple: "True"
  required: false
  description: Whether to enter the "Email Indicators Hunting" branch in the playbook. Under this branch, sub-playbooks would be triggered in order to hunt malicious indicators found in other emails and optionally, automatically create new incidents for each found email (configurable through next playbook inputs). Default is "True".
  playbookInputQuery:
- key: EmailHuntingCreateNewIncidents
  value:
    simple: "False"
  required: false
  description: When "True", the "Phishing - Handle Microsoft 365 Defender Results" sub-playbook will open new phishing incidents for each email that contains one of the malicious indicators. Default is "False".
  playbookInputQuery:
- key: ListenerMailbox
  value: {}
  required: false
  description: |-
    The mailbox which is being used to fetch phishing incidents. This mailbox would be excluded in the "Phishing - Indicators Hunting" playbook.
    In case the value of this input is empty, the value of the "Email To" incident field will be automatically used as the listener mailbox.
  playbookInputQuery:
- key: SendMailInstance
  value: {}
  required: false
  description: The name of the instance to be used when executing the "send-mail" command in the playbook. In case it will be empty, all available instances will be used (default).
  playbookInputQuery:
- key: OriginalAuthenticationHeader
  value: {}
  required: false
  description: |-
    This input will be used as the "original_authentication_header" argument in the "CheckEmailAuthenticity" script under the "Authenticate email" task.
    The header that holds the original Authentication-Results header value. This can be used when an intermediate server changes the original email and holds the original header value in a different header. Note - Use this only if you trust the server creating this header.
  playbookInputQuery:
- key: UserEngagement
  value:
    simple: "True"
  required: false
  description: |-
    Specify whether to engage with the user via email for investigation updates.
    Set the value to 'True' to allow user engagement, or 'False' to avoid user engagement.
  playbookInputQuery:
- key: TakeManualActions
  value:
    simple: "False"
  required: false
  description: |-
    Specify whether to stop the playbook to take additional action before closing the incident.
    Set the value to 'True' to stop the playbook before closing the incidents, or "False" to close the incident once the playbook flow is done.
  playbookInputQuery:
- key: KeyWordsToSearch
  value: {}
  required: false
  description: |-
    A comma-separated list of keywords to search in the email body.
    For example: name of the organization finance app that the attacker might impersonate.
    This input is used in the "Spear Phishing Investigation" sub-playbook.
  playbookInputQuery:
- key: NonMaliciousEmailReview
  value:
    simple: "True"
  required: false
  description: |-
    In case of an incident with a non-malicious email, it is possible either to close the incident or to review and approve it by an analyst.
    Set the value "True" for a review of the incident by an analyst. Set the value "False" to close the incident.
  playbookInputQuery:
inputSections:
- inputs:
  - Role
  - OnCall
  - EmailHuntingCreateNewIncidents
  - ListenerMailbox
  - SendMailInstance
  - UserEngagement
  - TakeManualActions
  - NonMaliciousEmailReview
  name: Incident Management
  description: Incident management settings and data, including escalation processes, and user engagements.
- inputs:
  - DetonateURL
  - InternalRange
  - InternalDomains
  name: Enrichment
  description: Enrichment settings and data, including assets and indicators enrichment using third-party enrichers.
- inputs:
  - AuthenticateEmail
  - CheckMicrosoftHeaders
  - GetOriginalEmail
  - OriginalAuthenticationHeader
  - PhishingModelName
  - DBotPredictURLPhishingURLsNumber
  - EmailFileToExtract
  - HuntEmailIndicators
  - KeyWordsToSearch
  name: Investigation
  description: Investigation settings and data, including any deep dive incident investigation and verdict determination.
- inputs:
  - BlockIndicators
  - SearchAndDelete
  - SearchAndDeleteIntegration
  - O365DeleteType
  - O365ExchangeLocation
  - O365AllowNotFoundSearchLocations
  - O365ExchangeLocationExclusion
  name: Remediation
  description: Remediation settings and data, including containment, eradication, and recovery.
outputs: []
tests:
- Phishing v3 - DomainSquatting+EML+MaliciousIndicators - Test
- Phishing v3 - Get Original Email + Search & Delete - Test
fromversion: 6.8.0
tags: ["phishing", "security"]