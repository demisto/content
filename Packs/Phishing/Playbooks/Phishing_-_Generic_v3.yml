id: Phishing - Generic v3
version: -1
name: Phishing - Generic v3
description: "This playbook investigates and remediates a potential phishing incident.\
  \ It engages with the user that triggered the incident while investigating the incident\
  \ itself.\nNote: Final remediation tasks are always decided by a human analyst. "
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: a70c1df8-6bfa-48bc-8f84-d4d09e9f8269
    type: start
    task:
      id: a70c1df8-6bfa-48bc-8f84-d4d09e9f8269
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "39"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": -690
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: a36686c3-1276-4d0c-8e47-e74257c22a6f
    type: regular
    task:
      id: a36686c3-1276-4d0c-8e47-e74257c22a6f
      version: -1
      name: Assign to analyst
      description: Assigns the incident to an analyst based on the analyst's organizational
        role.
      scriptName: AssignAnalystToIncident
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      onCall:
        complex:
          root: inputs.OnCall
          transformers:
          - operator: toLowerCase
      roles:
        complex:
          root: inputs.Role
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -260,
          "y": 2600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: 64d8264b-f05d-4948-88c6-adaa66e1661d
    type: regular
    task:
      id: 64d8264b-f05d-4948-88c6-adaa66e1661d
      version: -1
      name: Manually review the incident
      description: Reviews the incident to determine if the email that the user reported
        is malicious.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -770,
          "y": 3095
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: de9f1568-e9d8-40cb-8c6e-9abf36c956e0
    type: regular
    task:
      id: de9f1568-e9d8-40cb-8c6e-9abf36c956e0
      version: -1
      name: Close investigation
      description: Closes the investigation.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "29"
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -897.5,
          "y": 5210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: 5be69ea3-0064-4e6c-8c3f-9674fddb0fb5
    type: title
    task:
      id: 5be69ea3-0064-4e6c-8c3f-9674fddb0fb5
      version: -1
      name: Triage
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "26"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": 340
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: e074c159-80a7-47cc-855a-02044194961a
    type: regular
    task:
      id: e074c159-80a7-47cc-855a-02044194961a
      version: -1
      name: Store the email address of the reporting user
      description: Stores the email address of the user that reported the incident.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "85"
    scriptarguments:
      key:
        simple: ReporterAddress
      value:
        complex:
          root: ExtractedIndicators.Email
          accessor: '[0]'
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": -55
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 6b52054d-1763-4931-8cd3-add9d46b6d79
    type: regular
    task:
      id: 6b52054d-1763-4931-8cd3-add9d46b6d79
      version: -1
      name: Acknowledge incident was received
      description: |
        Sends an auto-response to the user reporting the incident that the incident was received and is being handled.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "56"
    scriptarguments:
      body:
        simple: "Hi ${.=function(val) { if(!(val.Account.length > 1)) return val.ReporterAddress;\
          \ var reporter = val.ReporterAddress; var account = val.Account && val.Account.filter(function(acc)\
          \ { return acc.DisplayName && (acc.Email  === reporter || Array.isArray(acc.Email)\
          \ && acc.Email.indexOf(reporter) > -1) }); return account && account[0]\
          \ && account[0].DisplayName[0] || reporter || ''; }(val)},\nWe've received\
          \ your email and are investigating.\nPlease do not touch the email until\
          \ further notice.\n\nCordially, \n  Your friendly neighborhood security\
          \ team"
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        complex:
          root: ReporterAddress
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 940,
          "y": 655
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: ec705d2c-4d4b-4b90-8ba9-d76df1154619
    type: condition
    task:
      id: ec705d2c-4d4b-4b90-8ba9-d76df1154619
      version: -1
      name: Is the email malicious?
      description: Determines if the email is malicious based on the calculated severity.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "31"
      Malicious:
      - "30"
    separatecontext: false
    conditions:
    - label: Malicious
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              simple: incident.severity
            iscontext: true
          right:
            value:
              simple: "2"
    view: |-
      {
        "position": {
          "x": -260,
          "y": 2775
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: d9e3e48a-d1a1-4193-81a0-e7c964a530cc
    type: regular
    task:
      id: d9e3e48a-d1a1-4193-81a0-e7c964a530cc
      version: -1
      name: Update the user that the reported email is safe
      description: Sends an email to the user explaining that the email they reported
        is safe.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "8"
    scriptarguments:
      body:
        simple: |-
          Hi ${.=function(val) { if(!(val.Account.length > 1)) return val.ReporterAddress; var reporter = val.ReporterAddress; var account = val.Account && val.Account.filter(function(acc) { return acc.DisplayName && (acc.Email  === reporter || Array.isArray(acc.Email) && acc.Email.indexOf(reporter) > -1) }); return account && account[0] && account[0].DisplayName[0] || reporter || ''; }(val)},
          We've concluded that the email you forwarded to us is safe. In case you think the verdict is not accurate and the email is suspicious, please contact our SOC team.
          Thank you for your alertness and your participation in keeping our organization secure.

          Cordially,
            Your security team
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        simple: ${ReporterAddress}
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -1500,
          "y": 3680
        }
      }
    note: false
    timertriggers:
    - fieldname: detectionsla
      action: stop
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: c4931abb-6391-4977-8a70-13afcf0ced41
    type: regular
    task:
      id: c4931abb-6391-4977-8a70-13afcf0ced41
      version: -1
      name: Update the user that the reported email is malicious
      description: Sends an email to the user explaining that the email they reported
        is malicious.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "27"
    scriptarguments:
      body:
        simple: |-
          Hi ${.=function(val) { if(!(val.Account.length > 1)) return val.ReporterAddress; var reporter = val.ReporterAddress; var account = val.Account && val.Account.filter(function(acc) { return acc.DisplayName && (acc.Email  === reporter || Array.isArray(acc.Email) && acc.Email.indexOf(reporter) > -1) }); return account && account[0] && account[0].DisplayName[0] || reporter || ''; }(val)},
          We've concluded that the email you forwarded to us is malicious. No further action is required on your part. Good job on detecting and forwarding it to us!

          All the best,
            Your security team
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        simple: ${ReporterAddress}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 120,
          "y": 3640
        }
      }
    note: false
    timertriggers:
    - fieldname: detectionsla
      action: stop
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: f07ccf78-84d1-4097-855d-a996c5f9bca0
    type: title
    task:
      id: f07ccf78-84d1-4097-855d-a996c5f9bca0
      version: -1
      name: Engage with User
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "53"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 940,
          "y": 340
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: 59f1e6b1-c19d-4e16-857f-3ea53582d1cd
    type: playbook
    task:
      id: 59f1e6b1-c19d-4e16-857f-3ea53582d1cd
      version: -1
      name: Detonate File - Generic
      playbookName: Detonate File - Generic
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "52"
    separatecontext: true
    view: |-
      {
        "position": {
          "x": 197.5,
          "y": 655
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: c48f3016-5b91-4803-8880-85aff3608451
    type: playbook
    task:
      id: c48f3016-5b91-4803-8880-85aff3608451
      version: -1
      name: Process Email - Generic v2
      description: |
        This playbook adds email details to the relevant context entities and handles the case where original emails are attached.

        This v2 playbook:
        - Uses incident fields and not incident labels.
        - Provides separate paths to "Phishing Alerts".
        - Uses the new **Get Original Email - Generic v2** playbook to retrieve original emails as EML files from the following integrations:
            * EWS v2
            * Microsoft Graph Mail integration
            * Gmail
            * FireEye EX and FireEye CM
            * Proofpoint Protection Server
            * Agari Phishing Defense
            * Mimecast
          This helps parse the email artifacts more efficiently.
      playbookName: Process Email - Generic v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "55"
      - "22"
      - "88"
      - "137"
    scriptarguments:
      Email:
        complex:
          root: incident
          accessor: emailto
      EmailCC:
        complex:
          root: incident
          accessor: emailcc
      EmailFormat:
        complex:
          root: incident
          accessor: emailformat
      EmailFrom:
        complex:
          root: incident
          accessor: emailfrom
      EmailHeaders:
        complex:
          root: incident
          accessor: phishingreporteremailheaders
      EmailHtml:
        complex:
          root: incident
          accessor: emailhtml
      EmailSubject:
        complex:
          root: incident
          accessor: emailsubject
      EmailText:
        complex:
          root: incident
          accessor: emailbody
      File:
        complex:
          root: File
      GetOriginalEmail:
        complex:
          root: inputs.GetOriginalEmail
      UserID:
        complex:
          root: ReporterAddress
    separatecontext: true
    loop:
      iscommand: false
      scriptArguments:
        UserID:
          complex:
            root: incident
            accessor: emaifrom
            transformers:
            - operator: replaceMatch
              args:
                regex:
                  value:
                    simple: (?i).*<([A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,})>
                replaceWith:
                  value:
                    simple: $1
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": 480
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: 01efb4e6-9edd-4166-89f7-d94c45d0d071
    type: title
    task:
      id: 01efb4e6-9edd-4166-89f7-d94c45d0d071
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "97"
      - "98"
      - "99"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 352.5,
          "y": 3890
        }
      }
    note: false
    timertriggers:
    - fieldname: remediationsla
      action: start
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: 91be962a-0c26-4e2d-8d87-cea8ea112fe5
    type: playbook
    task:
      id: 91be962a-0c26-4e2d-8d87-cea8ea112fe5
      version: -1
      name: Search And Delete Emails - Generic v2
      description: 'This playbook searches and deletes emails with similar attributes
        of a malicious email using one of the following integrations: * EWS * Office
        365 * Gmail * Agari Phishing Defense'
      playbookName: Search And Delete Emails - Generic v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      AttachmentName:
        complex:
          root: incident
          accessor: attachmentname
      From:
        complex:
          root: PhishingSender
      ? |
        O365AllowNotFoundExchangeLocations
      : simple: "false"
      O365DeleteType:
        complex:
          root: inputs.O365DeleteType
      O365Description:
        simple: Search for potential phishing
      O365ExchangeLocation:
        simple: All
      O365ExchangeLocationExclusion:
        complex:
          root: inputs.O365ExchangeLocationExclusion
      O365KQL:
        simple: from:${incident.emailfrom} AND subject:${incident.emailsubject}
      SearchAndDeleteIntegration:
        complex:
          root: inputs.SearchAndDeleteIntegration
      Subject:
        complex:
          root: incident
          accessor: emailsubject
      To:
        complex:
          root: incident
          accessor: emailto
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 352.5,
          "y": 4795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 0b3095c3-7aa2-4510-8268-5927468890e2
    type: title
    task:
      id: 0b3095c3-7aa2-4510-8268-5927468890e2
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -897.5,
          "y": 5395
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: ecc49aaf-814c-48b0-8da2-7a0e60221383
    type: title
    task:
      id: ecc49aaf-814c-48b0-8da2-7a0e60221383
      version: -1
      name: Email Is Malicious
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "123"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 162.5,
          "y": 2950
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: b30710fc-88df-40b6-86eb-69fe596e706d
    type: title
    task:
      id: b30710fc-88df-40b6-86eb-69fe596e706d
      version: -1
      name: Undetermined
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "7"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -770,
          "y": 2950
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 11726688-1fa3-4785-8698-639c597a99a2
    type: condition
    task:
      id: 11726688-1fa3-4785-8698-639c597a99a2
      version: -1
      name: Is the email malicious?
      description: Is the email that the user reported malicious?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "No":
      - "148"
      "Yes":
      - "123"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -770,
          "y": 3260
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: e1e7047e-9698-4ad8-8541-be3a344b8be9
    type: regular
    task:
      id: e1e7047e-9698-4ad8-8541-be3a344b8be9
      version: -1
      name: Manually remediate  the incident
      description: "To manually remediate a phishing incident you need to:\n1. Search\
        \ for and delete similar emails.\n2. Inform the organization about the threat.\n\
        3. Hunt relevant IOCs.\n4. Update proxies and firewalls as necessary.\n5.\
        \ Block the malicious sender/domain in the mail-gateway. "
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -657.5,
          "y": 4220
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: 4a4b5bad-e941-4d00-8ab2-c0596360366a
    type: condition
    task:
      id: 4a4b5bad-e941-4d00-8ab2-c0596360366a
      version: -1
      name: Should emails be searched and deleted?
      description: Checks whether the **SearchAndDelete** playbook input is set to
        True.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "43"
      "Yes":
      - "138"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.SearchAndDelete
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 352.5,
          "y": 4230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: 34850e72-bfd6-4d32-8b1b-8c6c85dcb1b5
    type: condition
    task:
      id: 34850e72-bfd6-4d32-8b1b-8c6c85dcb1b5
      version: -1
      name: Should indicators be blocked automatically?
      description: Checks whether the **BlockIndicators** playbook input is set to
        True.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "43"
      "yes":
      - "91"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: inputs.BlockIndicators
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: inputs.BlockIndicators
                      iscontext: true
                    right:
                      value:
                        simple: "True"
                    ignorecase: true
            iscontext: true
    view: |-
      {
        "position": {
          "x": 1000,
          "y": 4230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 6990d3e8-aa0f-406d-88ba-30014e03d335
    type: title
    task:
      id: 6990d3e8-aa0f-406d-88ba-30014e03d335
      version: -1
      name: Start Detection Timer
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "144"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": -550
        }
      }
    note: false
    timertriggers:
    - fieldname: detectionsla
      action: start
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: e9daca87-c7b6-4d42-8b1f-d733cb64fbd7
    type: title
    task:
      id: e9daca87-c7b6-4d42-8b1f-d733cb64fbd7
      version: -1
      name: Stop Remediation Timer
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "8"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 690,
          "y": 5060
        }
      }
    note: false
    timertriggers:
    - fieldname: remediationsla
      action: stop
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: c9d0d8c2-15f1-4585-8beb-fd3e84606820
    type: title
    task:
      id: c9d0d8c2-15f1-4585-8beb-fd3e84606820
      version: -1
      name: Indicator Enrichment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "92"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -260,
          "y": 1170
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "53":
    id: "53"
    taskid: 8ce29c59-8ce9-4f00-885e-4f93d08e4ed3
    type: playbook
    task:
      id: 8ce29c59-8ce9-4f00-885e-4f93d08e4ed3
      version: -1
      name: Email Address Enrichment - Generic v2.1
      description: |-
        Enrich email addresses.
        - Get information from Active Directory for internal addresses
        - Get the domain-squatting reputation for external addresses
      playbookName: Email Address Enrichment - Generic v2.1
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      Domain:
        simple: ' '
      Email:
        complex:
          root: ReporterAddress
          transformers:
          - operator: uniq
      InternalDomains:
        complex:
          root: inputs.InternalDomains
          transformers:
          - operator: uniq
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 940,
          "y": 480
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "55":
    id: "55"
    taskid: 7bb3e533-2565-4246-8b0e-a1d8f6b06ad2
    type: playbook
    task:
      id: 7bb3e533-2565-4246-8b0e-a1d8f6b06ad2
      version: -1
      name: Extract Indicators From File - Generic v2
      description: |-
        This playbook extracts indicators from a file.
        Supported file types:
        - CSV
        - PDF
        - TXT
        - HTM, HTML
        - DOC, DOCX
        - PPT
        - PPTX
        - RTF
        - XLS
        - XLSX
        - XML
      playbookName: Extract Indicators From File - Generic v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "52"
      - "143"
    separatecontext: true
    view: |-
      {
        "position": {
          "x": -727.5,
          "y": 655
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "56":
    id: "56"
    taskid: 54d00270-dd5a-414f-8291-c530f58d5908
    type: title
    task:
      id: 54d00270-dd5a-414f-8291-c530f58d5908
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "101"
      - "80"
      - "131"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -260,
          "y": 1520
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "79":
    id: "79"
    taskid: 99c85f2b-c9d6-4edb-857f-65eb866aee20
    type: condition
    task:
      id: 99c85f2b-c9d6-4edb-857f-65eb866aee20
      version: -1
      name: Should the email be authenticated?
      description: Checks whether the email should be authenticated using DKIM, SPF,
        and DMARC. This checks if "AuthenticateEmail" output is set to "True" and
        if there are headers from an email to authenticate.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "84"
      "yes":
      - "82"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.AuthenticateEmail
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
      - - operator: isExists
          left:
            value:
              complex:
                root: Email
                accessor: HeadersMap
            iscontext: true
    view: |-
      {
        "position": {
          "x": 390,
          "y": 1805
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "80":
    id: "80"
    taskid: bca6481e-1d50-4481-8767-12c337991705
    type: title
    task:
      id: bca6481e-1d50-4481-8767-12c337991705
      version: -1
      name: Email Authenticity Check
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "79"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 390,
          "y": 1660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "82":
    id: "82"
    taskid: 200116f1-f803-4710-8311-07d2e6fc7eab
    type: regular
    task:
      id: 200116f1-f803-4710-8311-07d2e6fc7eab
      version: -1
      name: Authenticate email
      description: Checks the authenticity of an email based on the email's SPF, DMARC,
        and DKIM.
      scriptName: CheckEmailAuthenticity
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "83"
    scriptarguments:
      headers:
        complex:
          root: Email
          accessor: Headers
          transformers:
          - operator: uniq
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 392.5,
          "y": 1990
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "83":
    id: "83"
    taskid: 26e76dd0-126a-42b4-8175-badf3154d5f7
    type: regular
    task:
      id: 26e76dd0-126a-42b4-8175-badf3154d5f7
      version: -1
      name: Save authenticity check result to incident field
      description: Saves the email authenticity verdict in an incident field.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "84"
    scriptarguments:
      emailauthenticitycheck:
        complex:
          root: Email
          accessor: AuthenticityCheck
          transformers:
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Undetermined
              toReplace:
                value:
                  simple: undetermined
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Pass
              toReplace:
                value:
                  simple: pass
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Fail
              toReplace:
                value:
                  simple: fail
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Suspicious
              toReplace:
                value:
                  simple: suspicious
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 392.5,
          "y": 2185
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "84":
    id: "84"
    taskid: 93da4e9f-706e-4c0e-8899-1c3adaee2891
    type: playbook
    task:
      id: 93da4e9f-706e-4c0e-8899-1c3adaee2891
      version: -1
      name: Calculate Severity - Generic v2
      playbookName: Calculate Severity - Generic v2
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "2"
    separatecontext: true
    view: |-
      {
        "position": {
          "x": -260,
          "y": 2390
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "85":
    id: "85"
    taskid: 2e14da29-ccaa-4cca-8f3e-4cadab9373a2
    type: regular
    task:
      id: 2e14da29-ccaa-4cca-8f3e-4cadab9373a2
      version: -1
      name: Save reporter email address in field
      description: Saves the email address of the email reporter in an incident field.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "11"
      - "18"
    scriptarguments:
      reporteremailaddress:
        complex:
          root: ReporterAddress
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": 100
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "87":
    id: "87"
    taskid: 13839cf6-83e6-4398-81b5-3cc41ef8600b
    type: regular
    task:
      id: 13839cf6-83e6-4398-81b5-3cc41ef8600b
      version: -1
      name: Predict phishing type using pre-trained phishing model
      description: Predicts the specific phishing mail type using a pre-trained machine
        learning model, and highlights the most important words used in the classification
        decision.
      scriptName: DBotPredictPhishingWords
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "90"
    scriptarguments:
      emailBody:
        complex:
          root: Email
          accessor: Text
          transformers:
          - operator: uniq
      emailBodyHTML:
        complex:
          root: Email
          accessor: HTML
          transformers:
          - operator: uniq
      emailSubject:
        complex:
          root: Email
          accessor: Subject
          transformers:
          - operator: uniq
      modelName:
        complex:
          root: inputs.PhishingModelName
      returnError:
        simple: "false"
    reputationcalc: 1
    continueonerror: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -1832.5,
          "y": 1045
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "88":
    id: "88"
    taskid: 2fecf9bb-535d-424a-8fd3-922200dc98ac
    type: title
    task:
      id: 2fecf9bb-535d-424a-8fd3-922200dc98ac
      version: -1
      name: Machine Learning
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "142"
      - "143"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -1522.5,
          "y": 655
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "89":
    id: "89"
    taskid: 83338111-c0e3-4b83-868e-f48213f06a62
    type: regular
    task:
      id: 83338111-c0e3-4b83-868e-f48213f06a62
      version: -1
      name: Update incident with predictions
      description: Updates incident fields with the machine learning phishing model
        predictions.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "84"
    scriptarguments:
      dbotprediction:
        complex:
          root: DBotPredictPhishingWords
          accessor: Label
          transformers:
          - operator: uniq
      dbotpredictionprobability:
        complex:
          root: DBotPredictPhishingWords
          accessor: Probability
          transformers:
          - operator: uniq
      dbottextsuggestionhighlighted:
        complex:
          root: DBotPredictPhishingWords
          accessor: TextTokensHighlighted
          transformers:
          - operator: uniq
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -1572.5,
          "y": 1505
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "90":
    id: "90"
    taskid: 448f0260-28c4-421e-82ca-2bd62e476191
    type: condition
    task:
      id: 448f0260-28c4-421e-82ca-2bd62e476191
      version: -1
      name: Did the model predict the phishing type?
      description: Checks whether the model predicted the phishing type.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "84"
      "yes":
      - "89"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotPredictPhishingWords
                accessor: Label
            iscontext: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotPredictPhishingWords
                accessor: Probability
            iscontext: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotPredictPhishingWords
                accessor: TextTokensHighlighted
            iscontext: true
    view: |-
      {
        "position": {
          "x": -1832.5,
          "y": 1275
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "91":
    id: "91"
    taskid: 42179db5-71bf-46f7-885f-0f8ec41df558
    type: playbook
    task:
      id: 42179db5-71bf-46f7-885f-0f8ec41df558
      version: -1
      name: Block Indicators - Generic v2
      description: |+
        This playbook blocks malicious indicators using all enabled integrations, with the following sub-playbooks:

        - Block URL - Generic
        - Block Account - Generic
        - Block IP - Generic v2
        - Block File - Generic v2

      playbookName: Block Indicators - Generic v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "43"
    scriptarguments:
      AutoCommit:
        simple: "No"
      CustomBlockRule:
        simple: "True"
      EmailToBlock:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: email
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: uniq
      IP:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: ip
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: uniq
      MD5:
        complex:
          root: DBotScore
          filters:
          - - operator: stringHasLength
              left:
                value:
                  simple: DBotScore.Indicator
                iscontext: true
              right:
                value:
                  simple: "32"
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: file
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: hash
              ignorecase: true
          accessor: Indicator
          transformers:
          - operator: uniq
      SHA256:
        complex:
          root: DBotScore
          filters:
          - - operator: stringHasLength
              left:
                value:
                  simple: DBotScore.Indicator
                iscontext: true
              right:
                value:
                  simple: "64"
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: file
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: hash
              ignorecase: true
          accessor: Indicator
          transformers:
          - operator: uniq
      URL:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: url
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: uniq
      Username:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: username
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: uniq
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 1000,
          "y": 4795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "92":
    id: "92"
    taskid: 0728891f-ea9c-4ecd-8c15-cbeb01aa9f4d
    type: playbook
    task:
      id: 0728891f-ea9c-4ecd-8c15-cbeb01aa9f4d
      version: -1
      name: Entity Enrichment - Phishing v2
      description: Enrich entities using one or more integrations
      playbookName: Entity Enrichment - Phishing v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "56"
    scriptarguments:
      Domain:
        complex:
          root: Domain
          accessor: Name
          transformers:
          - operator: uniq
      Email:
        complex:
          root: Account.Email.Address
          filters:
          - - operator: isNotEqualString
              left:
                value:
                  simple: Account.Email.Address
                iscontext: true
              right:
                value:
                  simple: incident.reporteremailaddress
                iscontext: true
          transformers:
          - operator: uniq
      Hostname:
        complex:
          root: Endpoint
          accessor: Hostname
          transformers:
          - operator: uniq
      IP:
        complex:
          root: IP
          accessor: Address
          transformers:
          - operator: uniq
      InternalDomains:
        complex:
          root: inputs.InternalDomains
      InternalRange:
        complex:
          root: inputs.InternalRange
      MD5:
        complex:
          root: File
          accessor: MD5
          transformers:
          - operator: uniq
      ResolveIP:
        simple: "False"
      SHA1:
        complex:
          root: File
          accessor: SHA1
          transformers:
          - operator: uniq
      SHA256:
        complex:
          root: File
          accessor: SHA256
          transformers:
          - operator: uniq
      URL:
        complex:
          root: URL
          accessor: Data
          transformers:
          - operator: uniq
      Username:
        complex:
          root: Account
          accessor: Username
          transformers:
          - operator: uniq
    separatecontext: false
    loop:
      iscommand: false
      scriptArguments:
        Email:
          complex:
            root: Account.Email.Address
            filters:
            - - operator: isNotEqualString
                left:
                  value:
                    simple: Account.Email.Address
                  iscontext: true
                right:
                  value:
                    simple: ReporterAddress
                  iscontext: true
            transformers:
            - operator: uniq
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": -260,
          "y": 1310
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "97":
    id: "97"
    taskid: c925530b-b6b7-4d89-87b2-42d66b208389
    type: title
    task:
      id: c925530b-b6b7-4d89-87b2-42d66b208389
      version: -1
      name: Block Indicators
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "37"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1000,
          "y": 4080
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "98":
    id: "98"
    taskid: 318c1377-b1a4-4f85-8a2a-04dcc7835a75
    type: title
    task:
      id: 318c1377-b1a4-4f85-8a2a-04dcc7835a75
      version: -1
      name: Search & Delete Email
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "36"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 352.5,
          "y": 4080
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "99":
    id: "99"
    taskid: 88842d87-dccb-4153-87f0-fc086ec6344e
    type: title
    task:
      id: 88842d87-dccb-4153-87f0-fc086ec6344e
      version: -1
      name: Manual Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "34"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -657.5,
          "y": 4080
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "101":
    id: "101"
    taskid: 5643c531-4771-4f7f-8e50-05b2bb2beea8
    type: title
    task:
      id: 5643c531-4771-4f7f-8e50-05b2bb2beea8
      version: -1
      name: Email Campaign Search
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "126"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -260,
          "y": 1660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "123":
    id: "123"
    taskid: 2bd7ca25-d887-4dfb-8a8d-0637d0cd920b
    type: condition
    task:
      id: 2bd7ca25-d887-4dfb-8a8d-0637d0cd920b
      version: -1
      name: Can the user be informed about the verdict?
      description: Checks whether the user can be informed about the verdict of the
        incident.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "27"
      yes - phishing campaign:
      - "130"
      yes - single phishing:
      - "17"
    separatecontext: false
    conditions:
    - label: "yes - phishing campaign"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: PartOfCampaign
            iscontext: true
      - - operator: isNotEmpty
          left:
            value:
              simple: ReporterAddress
            iscontext: true
    - label: yes - single phishing
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: ReporterAddress
            iscontext: true
    view: |-
      {
        "position": {
          "x": 352.5,
          "y": 3470
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "126":
    id: "126"
    taskid: d89f3c21-845d-4bbc-8bdd-c56a75c952b2
    type: playbook
    task:
      id: d89f3c21-845d-4bbc-8bdd-c56a75c952b2
      version: -1
      name: Detect & Manage Phishing Campaigns
      description: |-
        This playbook is used to find, create, and manage phishing campaigns. When a number of similar phishing incidents exist in the system, the playbook can be used to:
        1. Find and tie together incidents that are related to the same phishing attack (a phishing campaign).
        2. Search for an existing Phishing Campaign incident or create a new one for the tied phishing incidents.
        3. Link all detected phishing incidents to the Phishing Campaign incident that was found or created previously.
        4. Update the Phishing Campaign incident with the latest data about the campaign, and update all related phishing incidents to indicate that they are part of the campaign.
      playbookName: Detect & Manage Phishing Campaigns
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "84"
    scriptarguments:
      AutomaticallyLinkIncidents:
        simple: "True"
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -260,
          "y": 1795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "130":
    id: "130"
    taskid: 7af72125-97eb-4bb0-84d5-783fbb6d69da
    type: regular
    task:
      id: 7af72125-97eb-4bb0-84d5-783fbb6d69da
      version: -1
      name: Update the user that the email is a malicious campaign
      description: Sends an email to the user explaining that the email they reported
        is malicious.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "27"
    scriptarguments:
      body:
        simple: |-
          Hi ${.=function(val) { if(!(val.Account.length > 1)) return val.ReporterAddress; var reporter = val.ReporterAddress; var account = val.Account && val.Account.filter(function(acc) { return acc.DisplayName && (acc.Email  === reporter || Array.isArray(acc.Email) && acc.Email.indexOf(reporter) > -1) }); return account && account[0] && account[0].DisplayName[0] || reporter || ''; }(val)},
          We've concluded that the email you forwarded to us is part of a bigger phishing campaign that targeted our company. No further action is required on your part. Good job on detecting and forwarding it to us!

          All the best,
            Your security team
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        simple: ${ReporterAddress}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 590,
          "y": 3640
        }
      }
    note: false
    timertriggers:
    - fieldname: detectionsla
      action: stop
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "131":
    id: "131"
    taskid: 420f40ed-b1f8-4ead-86c9-267eb88d0090
    type: title
    task:
      id: 420f40ed-b1f8-4ead-86c9-267eb88d0090
      version: -1
      name: Microsoft's Headers Check
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "132"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -907.5,
          "y": 1660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "132":
    id: "132"
    taskid: bfb9994d-f653-4d40-85f4-85cbca2b05fa
    type: condition
    task:
      id: bfb9994d-f653-4d40-85f4-85cbca2b05fa
      version: -1
      name: Check Microsoft's Headers?
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "84"
      "yes":
      - "133"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.CheckMicrosoftHeaders
            iscontext: true
          right:
            value:
              simple: "True"
    view: |-
      {
        "position": {
          "x": -907.5,
          "y": 1795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "133":
    id: "133"
    taskid: 338615ab-5c29-4a54-8917-0959d3bcc939
    type: playbook
    task:
      id: 338615ab-5c29-4a54-8917-0959d3bcc939
      version: -1
      name: Process Microsoft's Anti-Spam Headers
      description: "This playbook stores the SCL, BCL, and PCL scores if they exist\
        \ to the associated incident fields (Phishing SCL Score, Phishing PCL Score,\
        \ and Phishing BCL Score).\nIt also does the following:\n1) Sets the email\
        \ classification to \"spam\" if the SCL score is equal to or greater than\
        \ 5.\n2) Sets the incident severity according to the playbook inputs (default\
        \ is: PCL/BCL - Medium, SCL - Low). The severity of the incident is set only\
        \ when one (or more) of the following occurs:\n  - PCL (Phishing Confidence\
        \ Level) score between and including 4-8: The message content is likely to\
        \ be phishing.\n  - [BCL](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/bulk-complaint-level-values?view=o365-worldwide)\
        \ (Bulk Complaint Level) score between and including 4-7: The message is from\
        \ a bulk sender that generates a mixed number of complaints. \n    For a score\
        \ between and including 8-9: The message is from a bulk sender that generates\
        \ a high number of complaints.\n  - [SCL](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/spam-confidence-levels?view=o365-worldwide)\
        \ (Spam Confidence Level) score between and including 5-6: Spam filtering\
        \ marks the message as spam. \n    For a score of 9: Spam filtering marks\
        \ the message as high confidence spam. See [anti-spam stamps](https://docs.microsoft.com/en-us/exchange/antispam-and-antimalware/antispam-protection/antispam-stamps?view=exchserver-2019)."
      playbookName: Process Microsoft's Anti-Spam Headers
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "84"
    separatecontext: true
    view: |-
      {
        "position": {
          "x": -907.5,
          "y": 1990
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "134":
    id: "134"
    taskid: c2c4d82d-2cbb-44c2-83b1-81dd3dd56d56
    type: regular
    task:
      id: c2c4d82d-2cbb-44c2-83b1-81dd3dd56d56
      version: -1
      name: Extract the email address of the reporting user
      description: commands.local.cmd.extract.indicators
      script: Builtin|||extractIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "12"
    scriptarguments:
      text:
        complex:
          root: incident
          accessor: emailfrom
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": -225
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "135":
    id: "135"
    taskid: 00a75ea0-03fe-4ff0-8ea5-4c82b695a7dd
    type: playbook
    task:
      id: 00a75ea0-03fe-4ff0-8ea5-4c82b695a7dd
      version: -1
      name: Detonate URL - Generic
      description: This playbook detonates URLs using active integrations that support
        URL detonation.
      playbookName: Detonate URL - Generic
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "52"
    scriptarguments:
      URL:
        complex:
          root: URL
          transformers:
          - operator: uniq
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": -260,
          "y": 950
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "137":
    id: "137"
    taskid: b2ceea6a-6ce3-4364-8e55-5764e9a90455
    type: condition
    task:
      id: b2ceea6a-6ce3-4364-8e55-5764e9a90455
      version: -1
      name: Detonate URL?
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "52"
      "yes":
      - "135"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.DetonateURL
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    view: |-
      {
        "position": {
          "x": -260,
          "y": 655
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "138":
    id: "138"
    taskid: 39f2d077-dd70-4ebe-81bf-467325511a2f
    type: regular
    task:
      id: 39f2d077-dd70-4ebe-81bf-467325511a2f
      version: -1
      name: Extract the original email sender address
      description: commands.local.cmd.extract.indicators
      script: Builtin|||extractIndicators
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "139"
    scriptarguments:
      text:
        complex:
          root: incident
          accessor: emailfrom
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 352.5,
          "y": 4420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "139":
    id: "139"
    taskid: 2580fd8a-6207-44a7-80b1-6e409247029e
    type: regular
    task:
      id: 2580fd8a-6207-44a7-80b1-6e409247029e
      version: -1
      name: Store the email address of the reporting user
      description: Stores the email address of the user that reported the incident.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "28"
    scriptarguments:
      key:
        simple: PhishingSender
      value:
        complex:
          root: ExtractedIndicators.Email
          accessor: '[1]'
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 352.5,
          "y": 4610
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "140":
    id: "140"
    taskid: 01c48d99-ff6d-4c75-86e3-7603062ce2b4
    type: regular
    task:
      id: 01c48d99-ff6d-4c75-86e3-7603062ce2b4
      version: -1
      name: Predict Phishing URLs
      description: Predicts phishing URLs using a pre-trained model.
      type: regular
      iscommand: false
      brand: ""
      script: DBotPredictURLPhishing
    nexttasks:
      '#none#':
      - "84"
    scriptarguments:
      emailHTML:
        complex:
          root: incident
          accessor: emailhtml
      maxNumberOfURL:
        complex:
          root: inputs.DBotPredictURLPhishingURLsNumber
      urls:
        complex:
          root: ExtractedURLsFromFiles
    reputationcalc: 2
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -1230,
          "y": 1045
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "142":
    id: "142"
    taskid: ddbe9bc8-1d68-4809-8aca-e2735889bac2
    type: title
    task:
      id: ddbe9bc8-1d68-4809-8aca-e2735889bac2
      version: -1
      name: Predict Phishing Type
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "87"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -1832.5,
          "y": 835
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "143":
    id: "143"
    taskid: a7a43b45-0825-4b8d-80ac-e70e021b2455
    type: title
    task:
      id: a7a43b45-0825-4b8d-80ac-e70e021b2455
      version: -1
      name: Predict Phishing URLs
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "140"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -1230,
          "y": 835
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "144":
    id: "144"
    taskid: 25836643-ff4b-4e49-8c4d-d7d9c8420946
    type: condition
    task:
      id: 25836643-ff4b-4e49-8c4d-d7d9c8420946
      version: -1
      name: How was the incident created?
      description: Checks whether the incident came from a mail listener integration,
        or was created manually by the user.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "134"
      Manually:
      - "145"
    separatecontext: false
    conditions:
    - label: Manually
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: incident
                accessor: sourceBrand
            iscontext: true
          right:
            value:
              simple: Manual
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": -410
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "145":
    id: "145"
    taskid: 228be529-945c-4c18-8982-576d97179757
    type: title
    task:
      id: 228be529-945c-4c18-8982-576d97179757
      version: -1
      name: Incident Created Manually
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "146"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 212.5,
          "y": -205
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "146":
    id: "146"
    taskid: 64ff8c26-c78a-4553-829e-d0661ae895d4
    type: condition
    task:
      id: 64ff8c26-c78a-4553-829e-d0661ae895d4
      version: -1
      name: Was the reporter of the phishing email specified?
      description: Checks whether the email address of the phishing email reporter
        was specified on incident creation, so that an acknowledgement email can be
        sent to them.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "11"
      "yes":
      - "147"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: reporteremailaddress
            iscontext: true
    view: |-
      {
        "position": {
          "x": 212.5,
          "y": -65
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "147":
    id: "147"
    taskid: 39b3b24c-177b-400f-81f2-ee09a0f96d73
    type: regular
    task:
      id: 39b3b24c-177b-400f-81f2-ee09a0f96d73
      version: -1
      name: Store the email address of the reporting user
      description: Stores the email address of the user that reported the incident.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "18"
      - "11"
    scriptarguments:
      key:
        simple: ReporterAddress
      value:
        complex:
          root: incident
          accessor: reporteremailaddress
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 440,
          "y": 120
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "148":
    id: "148"
    taskid: 906b39f7-657b-43d1-882c-ec1e7e1eaa3f
    type: condition
    task:
      id: 906b39f7-657b-43d1-882c-ec1e7e1eaa3f
      version: -1
      name: Can the user be informed about the verdict?
      description: Checks whether the user can be informed about the verdict of the
        incident.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "8"
      "Yes":
      - "16"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: ReporterAddress
            iscontext: true
    view: |-
      {
        "position": {
          "x": -1160,
          "y": 3470
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "123_27_#default#": 0.25,
      "137_135_yes": 0.54,
      "144_134_#default#": 0.59,
      "144_145_Manually": 0.44,
      "146_11_#default#": 0.13,
      "148_8_#default#": 0.15,
      "15_31_#default#": 0.6,
      "36_43_#default#": 0.57,
      "37_43_#default#": 0.5,
      "37_91_yes": 0.57,
      "79_84_#default#": 0.3,
      "90_84_#default#": 0.39,
      "90_89_yes": 0.48
    },
    "paper": {
      "dimensions": {
        "height": 6150,
        "width": 3212.5,
        "x": -1832.5,
        "y": -690
      }
    }
  }
inputs:
- key: Role
  value:
    simple: Administrator
  required: true
  description: The default role to assign the incident to.
  playbookInputQuery:
- key: SearchAndDelete
  value:
    simple: "False"
  required: false
  description: |-
    Enables the Search and Delete capability.
    For a malicious email, the "Search and Delete" sub-playbook looks for other instances of the email and deletes them pending analyst approval.
  playbookInputQuery:
- key: BlockIndicators
  value:
    simple: "False"
  required: false
  description: |-
    Enables the Block Indicators capability.
    For a malicious email, the "Block Indicators" sub-playbook blocks all malicious indicators in the relevant integrations.
  playbookInputQuery:
- key: AuthenticateEmail
  value:
    simple: "True"
  required: false
  description: Determines whether the authenticity of the email should be verified
    using SPF, DKIM, and DMARC.
  playbookInputQuery:
- key: OnCall
  value:
    simple: "False"
  required: false
  description: Set to True to assign only the user that is currently on shift.
  playbookInputQuery:
- key: SearchAndDeleteIntegration
  value:
    simple: EWS
  required: false
  description: |-
    Determines which product and playbook is used to search and delete the phishing email from user inboxes.
      - Set this to "O365" to use the "O365 - Security And Compliance - Search And Delete" playbook.
      - Set this to "EWS" to use the "Search And Delete Emails - EWS" playbook.
      - Set this to "Gmail" to use the "Search And Delete - Gmail" playbook.
  playbookInputQuery:
- key: O365DeleteType
  value:
    simple: Soft
  required: false
  description: |-
    Sets the method to delete emails in the "O365 - Security And Compliance - Search And Delete" playbook. Can be "Soft" (recoverable), or "Hard" (unrecoverable). Leave empty to decide manually for each email incident.
    This is only applicable if the SearchAndDeleteIntegration input is set to "O365".
  playbookInputQuery:
- key: O365ExchangeLocation
  value:
    complex:
      root: incident
      accessor: emailto
  required: false
  description: The exchange location. Determines from where to search and delete emails
    using O365 playbooks. Use the value "All" to search all mailboxes, or use ${incident.emailto}
    to search and delete the email only from the recipient's inbox. Note - Searching
    all mailboxes may take a significant amount of time. - This input is used only
    when searching and deleting emails in O365 and only applies if the SearchAndDeleteIntegration
    input is set to O365.
  playbookInputQuery:
- key: O365AllowNotFoundSearchLocations
  value:
    simple: "False"
  required: false
  description: Used only when searching and deleting emails in O365. Determines whether
    to include mailboxes other than regular user mailboxes in the compliance search.
  playbookInputQuery:
- key: O365ExchangeLocationExclusion
  value: {}
  required: false
  description: Used only when searching and deleting emails in O365. A comma-separated
    list of mailboxes/distribution groups to exclude when you use the value "All"
    for the O365ExchangeLocation input.
  playbookInputQuery:
- key: CheckMicrosoftHeaders
  value:
    simple: "True"
  required: false
  description: Whether to check Microsoft headers for BCL/PCL/SCL scores and set the
    "Severity" and "Email Classification" accordingly.
  playbookInputQuery:
- key: InternalDomains
  value: {}
  required: false
  description: A CSV list of internal domains. The list is used to determine whether
    an email address is internal or external.
  playbookInputQuery:
- key: DetonateURL
  value:
    simple: "False"
  required: false
  description: Determines whether to use the "URL Detonation" playbook. Detonating
    a URL may take a few minutes.
  playbookInputQuery:
- key: InternalRange
  value: {}
  required: false
  description: |-
    This input is used in the "Entity Enrichment - Phishing v2" playbook.
    A list of internal IP ranges to check IP addresses against. The list should be provided in CIDR notation, separated by commas. An example of a list of ranges is: "172.16.0.0/12,10.0.0.0/8,192.168.0.0/16" (without quotes). If a list is not provided, uses the default list provided in the IsIPInRanges script (the known IPv4 private address ranges).
  playbookInputQuery:
- key: PhishingModelName
  value:
    simple: phishing_model
  required: false
  description: Optional - the name of a pre-trained phishing model to predict phishing
    type using machine learning.
  playbookInputQuery:
- key: GetOriginalEmail
  value:
    simple: "False"
  required: false
  description: |-
    For forwarded emails. When "True", retrieves the original email in the thread.

    You must have the necessary permissions in your email service to execute global search.

    - For EWS: eDiscovery
    - For Gmail: Google Apps Domain-Wide Delegation of Authority
    - For MSGraph: As described in these links
    https://docs.microsoft.com/en-us/graph/api/message-get
    https://docs.microsoft.com/en-us/graph/api/user-list-messages
  playbookInputQuery:
- key: DBotPredictURLPhishingURLsNumber
  value:
    simple: "3"
  required: false
  description: |-
    The number of URLs to extract from the email HTML and analyze in the "DBotPredictURLPhishing" automation.
    This automation runs several checks to determine the score of the URLs found in the email, sets a verdict for URLs found as "Suspicious" or "Malicious", and adds these URLs as indicators. Based on the verdict, the incident severity is set (Medium for "Suspicious" and High for "Malicious").
    Note:
    - You need to install the "Phishing URL" pack to use this automation.
    - False/True positives are possible.
    - This automation may take a few minutes to run.
    - To increase result accuracy, it is recommended to install and enable the "Whois" pack (optional).
  playbookInputQuery:
outputs: []
tests:
- Phishing v2 - Test - Incident Starter
fromversion: 6.1.0