id: O365-SecurityAndComplianceV2-Test
version: -1
vcShouldKeepItemLegacyProdMachine: false
name: O365-SecurityAndComplianceV2-Test
description: This playbook test SecurityAndCompliance integration
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: f12f63f0-d9c7-4d8e-8c9d-4e54893b0410
    type: start
    task:
      id: f12f63f0-d9c7-4d8e-8c9d-4e54893b0410
      version: -1
      name: ""
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "30"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 152.5,
          "y": 50
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 85f2e3f5-2b32-4bf5-8a16-2c54276702f0
    type: condition
    task:
      id: 85f2e3f5-2b32-4bf5-8a16-2c54276702f0
      version: -1
      name: Validate compliance search created
      description: 'Validate compliance search creation with all additional arguments. '
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "10"
      "yes":
      - "25"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: O365.SecurityAndCompliance.ContentSearch.Search.AllowNotFoundExchangeLocationsEnabled
            iscontext: true
          right:
            value:
              simple: "true"
      - - operator: isEqualString
          left:
            value:
              simple: O365.SecurityAndCompliance.ContentSearch.Search.Description
            iscontext: true
          right:
            value:
              simple: Demisto description
      - - operator: containsGeneral
          left:
            value:
              simple: O365.SecurityAndCompliance.ContentSearch.Search.ExchangeLocation
            iscontext: true
          right:
            value:
              simple: avishai@demistodev.onmicrosoft.com
      - - operator: isEqualString
          left:
            value:
              simple: O365.SecurityAndCompliance.ContentSearch.Search.ContentMatchQuery
            iscontext: true
          right:
            value:
              simple: Rodrigo
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 152.5,
          "y": 380
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: d5abcd41-3219-4bf1-8da2-d2fc77a9a34a
    type: regular
    task:
      id: d5abcd41-3219-4bf1-8da2-d2fc77a9a34a
      version: -1
      name: Remove search
      description: Remove compliance search by name from the Security & Compliance
        Center.
      script: '|||o365-sc-remove-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      retry-count:
        simple: "10"
      search_name:
        complex:
          root: O365.SecurityAndCompliance.ContentSearch.Search
          accessor: Name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 480,
          "y": 2250
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 12047823-c4de-4a49-86f1-85ab526911eb
    type: regular
    task:
      id: 12047823-c4de-4a49-86f1-85ab526911eb
      version: -1
      name: Get search
      description: Get compliance search from the Security & Compliance Center.
      script: '|||o365-sc-get-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    scriptarguments:
      retry-count:
        simple: "10"
      search_name:
        complex:
          root: O365.SecurityAndCompliance.ContentSearch.Search
          accessor: Name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 357.5,
          "y": 890
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: e4e35bb4-9cb7-4b31-8e31-8a8813d66a20
    type: condition
    task:
      id: e4e35bb4-9cb7-4b31-8e31-8a8813d66a20
      version: -1
      name: Validate !o365-sc-get-search and !o365-sc-set-search commands
      description: 'Validate compliance search modified with all additional arguments. '
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "10"
      "yes":
      - "31"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: notContainsGeneral
          left:
            value:
              simple: O365.SecurityAndCompliance.ContentSearch.Search.ExchangeLocation
            iscontext: true
          right:
            value:
              simple: notexists@demistodev.onmicrosoft.com
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 357.5,
          "y": 1230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: 96d5ae99-85b3-4563-81dd-0b7f1287c3ad
    type: regular
    task:
      id: 96d5ae99-85b3-4563-81dd-0b7f1287c3ad
      version: -1
      name: Remove search
      description: Remove compliance search by name from the Security & Compliance
        Center.
      script: '|||o365-sc-remove-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "26"
    scriptarguments:
      retry-count:
        simple: "10"
      search_name:
        complex:
          root: O365.SecurityAndCompliance.ContentSearch.Search
          accessor: Name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": 1910
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: b2a652aa-87e9-435f-88a8-f031c11d836c
    type: regular
    task:
      id: b2a652aa-87e9-435f-88a8-f031c11d836c
      version: -1
      name: PrintErrorEntry
      description: Prints an error entry with a given message
      scriptName: PrintErrorEntry
      type: regular
      iscommand: false
      brand: ""
    scriptarguments:
      message:
        simple: Fail executing test playbook
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": 2420
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 81de47bf-2eb9-413a-8f59-6ba43ff6359f
    type: condition
    task:
      id: 81de47bf-2eb9-413a-8f59-6ba43ff6359f
      version: -1
      name: Validate !o365-sc-new-search-action (Generic polling playbook) and !o365-sc-get-search-action
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "10"
      "yes":
      - "23"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: O365.SecurityAndCompliance.ContentSearch.SearchAction.Results
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 480,
          "y": 1740
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: ca665ffa-199e-4176-80ce-93ebc42401f4
    type: regular
    task:
      id: ca665ffa-199e-4176-80ce-93ebc42401f4
      version: -1
      name: Get search action
      description: Get compliance search action from the Security & Compliance Center.
        This command must come after executing the command o365-sc-start-search.
      script: '|||o365-sc-get-search-action'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "18"
    scriptarguments:
      results:
        simple: "true"
      retry-count:
        simple: "10"
      search_action_name:
        complex:
          root: O365.SecurityAndCompliance.ContentSearch.SearchAction
          accessor: Name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 480,
          "y": 1570
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: 263f9981-9848-4eb8-8756-d4ef3ba2d1be
    type: regular
    task:
      id: 263f9981-9848-4eb8-8756-d4ef3ba2d1be
      version: -1
      name: Remove search action
      description: Remove compliance search action by search action name from the
        Security & Compliance Center.
      script: '|||o365-sc-remove-search-action'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "24"
    scriptarguments:
      retry-count:
        simple: "10"
      search_action_name:
        complex:
          root: O365.SecurityAndCompliance.ContentSearch.SearchAction
          accessor: Name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 480,
          "y": 1910
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 544cfabe-e6cf-47bb-8395-9464ba7d8b6c
    type: regular
    task:
      id: 544cfabe-e6cf-47bb-8395-9464ba7d8b6c
      version: -1
      name: Stop search
      description: Stop running compliance search in the Security & Compliance Center.
      script: '|||o365-sc-stop-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      retry-count:
        simple: "10"
      search_name:
        complex:
          root: O365.SecurityAndCompliance.ContentSearch.Search
          accessor: Name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 480,
          "y": 2080
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 2b9a7c9f-193f-4c8b-8219-259d2e5fd229
    type: regular
    task:
      id: 2b9a7c9f-193f-4c8b-8219-259d2e5fd229
      version: -1
      name: Set search
      description: Modify non-running compliance search in the Security & Compliance
        Center.
      script: '|||o365-sc-set-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "32"
    scriptarguments:
      allow_not_found_exchange_locations:
        simple: "false"
      remove_exchange_location:
        simple: notexists@demistodev.onmicrosoft.com
      retry-count:
        simple: "10"
      search_name:
        complex:
          root: O365.SecurityAndCompliance.ContentSearch.Search.Name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 357.5,
          "y": 550
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: 6f0595c7-fc89-422c-8f36-17000890fded
    type: condition
    task:
      id: 6f0595c7-fc89-422c-8f36-17000890fded
      version: -1
      name: Check if search action created
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "16"
      "yes":
      - "27"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: O365.SecurityAndCompliance.ContentSearch.SearchAction.Name
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": 2080
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: 050746d3-7e6e-4477-846b-b8e02fb82e81
    type: regular
    task:
      id: 050746d3-7e6e-4477-846b-b8e02fb82e81
      version: -1
      name: Remove search action
      description: Remove compliance search action by search action name from the
        Security & Compliance Center.
      script: '|||o365-sc-remove-search-action'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "16"
    scriptarguments:
      retry-count:
        simple: "10"
      search_action_name:
        complex:
          root: O365.SecurityAndCompliance.ContentSearch.SearchAction
          accessor: Name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 50,
          "y": 2250
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: dbf1c16b-a826-4d84-8dbb-d4fa17149f23
    type: title
    task:
      id: dbf1c16b-a826-4d84-8dbb-d4fa17149f23
      version: -1
      name: Test playbook finished successfully
      type: title
      iscommand: false
      brand: ""
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 480,
          "y": 2425
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: ba3f1d35-b914-458d-8c46-e12a1fa21fc3
    type: playbook
    task:
      id: ba3f1d35-b914-458d-8c46-e12a1fa21fc3
      version: -1
      name: O365 - Security And Compliance - Search
      description: |-
        This playbook performs the following steps:
        1. Creates a compliance search.
        2. Starts a compliance search.
        3. Waits for the compliance search to complete.
        4. Gets the results of the compliance search as an output.
        5. Gets the preview results, if specified.
      playbookName: O365 - Security And Compliance - Search
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      allow_not_found_exchange_locations:
        complex:
          root: inputs.allow_not_found_exchange_locations
      description:
        complex:
          root: inputs.description
      exchange_location:
        complex:
          root: inputs.exchange_location
      force:
        simple: "true"
      kql:
        complex:
          root: inputs.kql
      polling_interval:
        simple: "1"
      polling_timeout:
        simple: "10"
      preview:
        simple: "false"
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 152.5,
          "y": 210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: 3b117491-af54-4253-8aef-d42e33366c88
    type: playbook
    task:
      id: 3b117491-af54-4253-8aef-d42e33366c88
      version: -1
      name: O365 - Security And Compliance - Search Action - Preview
      description: |-
        This playbook perform:
        1. Creates a new compliance search action - Preview (Base on created compliance search).
        2. Waits for the preview action to complete.
        3. Retrieves the preview results.
      playbookName: O365 - Security And Compliance - Search Action - Preview
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "19"
    scriptarguments:
      polling_interval:
        simple: "1"
      polling_timeout:
        simple: "10"
      search_name:
        complex:
          root: O365.SecurityAndCompliance.ContentSearch.Search
          accessor: Name
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 480,
          "y": 1400
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: f1346837-b4c6-431a-8d69-5b2f495639cd
    type: regular
    task:
      id: f1346837-b4c6-431a-8d69-5b2f495639cd
      version: -1
      name: Start search
      description: Starts stopped, completed, or not started compliance search in
        the Security & Compliance Center.
      script: '|||o365-sc-start-search'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      search_name:
        complex:
          root: O365.SecurityAndCompliance.ContentSearch.Search
          accessor: Name
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 357.5,
          "y": 720
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: baf4b36d-6143-4d5e-90cf-925c1c1629e9
    type: playbook
    task:
      id: baf4b36d-6143-4d5e-90cf-925c1c1629e9
      version: -1
      name: Waiting for search to complete
      description: |-
        Use this playbook as a sub-playbook to block execution of the master playbook until a remote action is complete.
        This playbook implements polling by continuously running the command in Step \#2 until the operation completes.
        The remote action should have the following structure:

        1. Initiate the operation.
        2. Poll to check if the operation completed.
        3. (optional) Get the results of the operation.

        NOTE: This playbook should be run only when the playbook's context is using the "Private to sub-playbook" option.
      playbookName: GenericPolling
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    scriptarguments:
      Ids:
        simple: ${O365.SecurityAndCompliance.ContentSearch.Search.Name}
      Interval:
        simple: "1"
      PollingCommandArgName:
        simple: search_name
      PollingCommandName:
        simple: o365-sc-get-search
      Timeout:
        simple: "10"
      dt:
        simple: O365.SecurityAndCompliance.ContentSearch.Search(val.Status && val.Status
          == "InProgress" || val.Status == "Starting" || val.Status == "NotStarted")
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 357.5,
          "y": 1060
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {},
    "paper": {
      "dimensions": {
        "height": 2440,
        "width": 810,
        "x": 50,
        "y": 50
      }
    }
  }
inputs:
- key: search_name
  value:
    simple: Demisto-Test
  required: true
  description: The name of the compliance search.
  playbookInputQuery: null
- key: kql
  value:
    simple: Rodrigo
  required: true
  description: Text search string or a query that's formatted by using the Keyword
    Query Language (KQL).
  playbookInputQuery: null
- key: description
  value:
    simple: Demisto description
  required: true
  description: Description for the compliance search.
  playbookInputQuery: null
- key: allow_not_found_exchange_locations
  value:
    simple: "true"
  required: true
  description: Whether to include mailboxes other than regular user mailboxes in the
    compliance search.
  playbookInputQuery: null
- key: exchange_location
  value:
    simple: avishai@demistodev.onmicrosoft.com,notexists@demistodev.onmicrosoft.com
  required: true
  description: Mailboxes/distribution group to include, or you can use the value "All"
    to include all. (Comma separated)
  playbookInputQuery: null
fromversion: 5.5.0
