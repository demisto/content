id: Dedup - Generic v4
version: -1
name: Dedup - Generic v4
description: "This playbook identifies duplicate incidents using the XSOAR machine\
  \ learning method (script).\nIn this playbook, you can choose how to find similar\
  \ incidents by using fields and/or indicators to be compared against other incidents\
  \ in the XSOAR DB.\n\nRemember that the identification of similar incidents is *must*\
  \ be defined properly in the playbook's inputs. "
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 22f878be-bfc2-427b-8b5b-91007d4a900e
    type: start
    task:
      id: 22f878be-bfc2-427b-8b5b-91007d4a900e
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "42"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 460,
          "y": -440
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: e9020a3c-3576-4970-8733-4ade2184dc25
    type: regular
    task:
      id: e9020a3c-3576-4970-8733-4ade2184dc25
      version: -1
      name: Find Similar Incidents By Fields
      description: Find past similar incidents based on incident fields' similarity.
        Includes an option to also display indicators similarity.
      scriptName: DBotFindSimilarIncidents
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "45"
    scriptarguments:
      fieldExactMatch:
        simple: ${inputs.fieldExactMatch}
      fieldsToDisplay:
        simple: ${inputs.fieldsToDisplay}
      fromDate:
        simple: ${inputs.fromDate}
      limit:
        simple: ${inputs.limit}
      maxIncidentsToDisplay:
        simple: ${inputs.limit}
      minimunIncidentSimilarity:
        simple: ${inputs.minimunIncidentSimilarity}
      query:
        simple: ${inputs.query}
      showIncidentSimilarityForAllFields:
        simple: ${inputs.showIncidentSimilarityForAllFields}
      similarTextField:
        simple: ${inputs.similarTextField}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1050,
          "y": -150
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 0cde2f9d-a843-4c67-86c4-6c042f4ccc38
    type: condition
    task:
      id: 0cde2f9d-a843-4c67-86c4-6c042f4ccc38
      version: -1
      name: Are There Any Similar Incidents?
      description: Checking if the DBotFindSimilarIncidents tasks returned any output.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      "yes":
      - "15"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isTrue
          left:
            value:
              complex:
                root: DBotFindSimilarIncidents
                accessor: isSimilarIncidentFound
                transformers:
                - operator: toLowerCase
            iscontext: true
        - operator: isTrue
          left:
            value:
              complex:
                root: DBotFindSimilarIncidentsByIndicators
                accessor: isSimilarIncidentFound
            iscontext: true
    view: |-
      {
        "position": {
          "x": 680,
          "y": 370
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 39686d08-69d9-4ad6-8cf2-3321238e2593
    type: title
    task:
      id: 39686d08-69d9-4ad6-8cf2-3321238e2593
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 460,
          "y": 1770
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: a58c04dc-bed0-47ed-8256-cfd360343866
    type: regular
    task:
      id: a58c04dc-bed0-47ed-8256-cfd360343866
      version: -1
      name: Link similar incident
      description: commands.local.cmd.linkIncidents
      script: Builtin|||linkIncidents
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "26"
    scriptarguments:
      action:
        simple: link
      incidentId:
        complex:
          root: incident
          accessor: id
      linkedIncidentIDs:
        complex:
          root: DBotFindSimilarIncidents.similarIncident
          accessor: id
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: DBotFindSimilarIncidentsByIndicators.similarIncident.id
                iscontext: true
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 680,
          "y": 890
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 5949e8c1-88b2-4e34-828c-9a0851e7e9dd
    type: title
    task:
      id: 5949e8c1-88b2-4e34-828c-9a0851e7e9dd
      version: -1
      name: Similar Incident Found
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "22"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 680,
          "y": 570
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 2101ab53-30b4-498e-8ff3-0d5921eba909
    type: regular
    task:
      id: 2101ab53-30b4-498e-8ff3-0d5921eba909
      version: -1
      name: 'Close incident by a similarity percentage '
      description: 'Close the similar incident using the CloseSimilar input number '
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      closeNotes:
        simple: |-
          Closed due to a similarity percentage.
          ${inputs.closeReason}
      closeReason:
        simple: Duplicate
      id:
        complex:
          root: DBotFindSimilarIncidents.similarIncident
          filters:
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotFindSimilarIncidents.similarIncident.similarity incident
                iscontext: true
              right:
                value:
                  simple: inputs.CloseSimilar
                iscontext: true
          accessor: id
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1260,
          "y": 1600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: c2f95783-d177-4e43-86f5-ef60a7412109
    type: condition
    task:
      id: c2f95783-d177-4e43-86f5-ef60a7412109
      version: -1
      name: Handle Similar Incident
      description: Define how to handle a similar incident.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      Close:
      - "46"
      link:
      - "11"
    separatecontext: false
    conditions:
    - label: Close
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.handleSimilar
            iscontext: true
          right:
            value:
              simple: Close
          ignorecase: true
    - label: link
      condition:
      - - operator: containsString
          left:
            value:
              simple: inputs.handleSimilar
            iscontext: true
          right:
            value:
              simple: Link
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 680,
          "y": 690
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: e6642713-ad4f-4089-89e7-1430c3450afc
    type: condition
    task:
      id: e6642713-ad4f-4089-89e7-1430c3450afc
      version: -1
      name: Close Incident?
      description: After Link should I close the incident?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      "yes":
      - "46"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: containsString
          left:
            value:
              simple: inputs.handleSimilar
            iscontext: true
          right:
            value:
              simple: Close
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 680,
          "y": 1060
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: 2cb0faca-df3f-473a-8c9b-f126bcd45b85
    type: regular
    task:
      id: 2cb0faca-df3f-473a-8c9b-f126bcd45b85
      version: -1
      name: Find Similar Incidents by Indicators
      description: Finds similar incidents based on indicators' similarity. Indicators'
        contribution to the final score is based on their scarcity.
      scriptName: DBotFindSimilarIncidentsByIndicators
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      fieldsIncidentToDisplay:
        simple: ${inputs.fieldsToDisplay}
      fromDate:
        simple: ${inputs.fromDate}
      maxIncidentsToDisplay:
        simple: ${inputs.limit}
      query:
        simple: ${inputs.query}
      threshold:
        simple: ${inputs.minimunIncidentSimilarity}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 680,
          "y": 190
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "42":
    id: "42"
    taskid: 67647b8c-70f0-4eee-89d1-0cfc14d2c985
    type: condition
    task:
      id: 67647b8c-70f0-4eee-89d1-0cfc14d2c985
      version: -1
      name: Find Similar Incidents By?
      description: Define how you prefer to identify similarity using playbook input
        - 'method'
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      Indicators:
      - "27"
      fields:
      - "1"
    separatecontext: false
    conditions:
    - label: Indicators
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: inputs.method
                transformers:
                - operator: toLowerCase
            iscontext: true
          right:
            value:
              simple: indicators
          ignorecase: true
    - label: fields
      condition:
      - - operator: containsString
          left:
            value:
              complex:
                root: inputs.method
                transformers:
                - operator: toLowerCase
            iscontext: true
          right:
            value:
              simple: fields
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 460,
          "y": -320
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: a5db15cf-8ac5-4e5c-8ea7-c4a340ef3197
    type: condition
    task:
      id: a5db15cf-8ac5-4e5c-8ea7-c4a340ef3197
      version: -1
      name: Also Find Similarity By Indicators?
      description: Define how you prefer to identify similarity using playbook input
        - 'method'
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "2"
      "Yes":
      - "27"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: containsString
          left:
            value:
              complex:
                root: inputs.method
                transformers:
                - operator: toLowerCase
            iscontext: true
          right:
            value:
              simple: indicators
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 1050,
          "y": 20
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: 50a2dc19-01be-4dbb-8e7a-fa096904c324
    type: condition
    task:
      id: 50a2dc19-01be-4dbb-8e7a-fa096904c324
      version: -1
      name: A closer percentage was provided?
      description: Check if a closer percentage was provided.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      "yes":
      - "47"
      - "49"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: inputs.CloseSimilar
            iscontext: true
    view: |-
      {
        "position": {
          "x": 1050,
          "y": 1230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: 33bde82d-168b-47f8-89b8-918bbf714342
    type: condition
    task:
      id: 33bde82d-168b-47f8-89b8-918bbf714342
      version: -1
      name: Is there Similar Incidents by fields
      description: check if there are similar Incidents by fields
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      "yes":
      - "18"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotFindSimilarIncidents.similarIncident
                filters:
                - - operator: greaterThanOrEqual
                    left:
                      value:
                        simple: DBotFindSimilarIncidents.similarIncident.similarity
                          incident
                      iscontext: true
                    right:
                      value:
                        simple: inputs.CloseSimilar
                      iscontext: true
                accessor: id
            iscontext: true
          right:
            value: {}
    view: |-
      {
        "position": {
          "x": 1260,
          "y": 1400
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: a21a51a9-645a-41e5-8362-2dee5b0721c0
    type: regular
    task:
      id: a21a51a9-645a-41e5-8362-2dee5b0721c0
      version: -1
      name: 'Close incident by a similarity percentage '
      description: 'Close the similar incident using the CloseSimilar input number '
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      closeNotes:
        simple: |-
          Closed due to a similarity percentage.
          ${inputs.closeReason}
      closeReason:
        simple: Duplicate
      id:
        complex:
          root: DBotFindSimilarIncidentsByIndicators.similarIncident
          filters:
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotFindSimilarIncidentsByIndicators.similarIncident.similarity
                    indicators
                iscontext: true
              right:
                value:
                  simple: inputs.CloseSimilar
                iscontext: true
          accessor: id
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 860,
          "y": 1600
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "49":
    id: "49"
    taskid: 42901ef1-18d5-49d4-8ee2-68f1b1f13420
    type: condition
    task:
      id: 42901ef1-18d5-49d4-8ee2-68f1b1f13420
      version: -1
      name: Is there Similar Incidents by Indicators
      description: Check if there are similar Incidents by Indicators
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      "yes":
      - "48"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotFindSimilarIncidentsByIndicators.similarIncident
                filters:
                - - operator: greaterThanOrEqual
                    left:
                      value:
                        simple: DBotFindSimilarIncidentsByIndicators.similarIncident.similarity
                          indicators
                      iscontext: true
                    right:
                      value:
                        simple: inputs.CloseSimilar
                      iscontext: true
                accessor: id
            iscontext: true
          right:
            value: {}
    view: |-
      {
        "position": {
          "x": 860,
          "y": 1400
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "22_5_#default#": 0.16,
      "2_15_yes": 0.37,
      "2_5_#default#": 0.17,
      "42_27_Indicators": 0.49
    },
    "paper": {
      "dimensions": {
        "height": 2275,
        "width": 1180,
        "x": 460,
        "y": -440
      }
    }
  }
inputs:
- key: method
  value:
    simple: Fields and Indicators
  required: true
  description: Choose the way you want to identify similar incidents. Choose between
    "Indicators" / "Fields" / "Fields and Indicators"  .
  playbookInputQuery:
- key: handleSimilar
  value:
    simple: Link
  required: true
  description: "This input defines how to handle Similar incidents. \nYou may choose\
    \ between: \"Link\", \"Close\", \"Link and Close\".\nNote: that closing incidents\
    \ will require you to define \"CloseSimilar\" input as well.\nAlso, note that\
    \ the closer will apply on at least one of the options (indicators or fields)\
    \ which will match the \"closer percentage\" criteria.\nDefault: Link "
  playbookInputQuery:
- key: fieldExactMatch
  value: {}
  required: false
  description: "Please select those incident types which you would like to be *equal*\
    \ on queried incidents. \nFor example - if you put <Type>, the PB will query against\
    \ the DB for all the incidents with the same type as your current incident.\n\
    If you are using comma-separated values - please remember that the operator between\
    \ them will be *AND*."
  playbookInputQuery:
- key: fieldsToDisplay
  value: {}
  required: false
  description: |-
    Comma-separated list of additional incident fields to display in the context output. Those fields can be used later on for Layouts or other states if needed.
    (Those which will not be taken into account when computing similarity)
  playbookInputQuery:
- key: fromDate
  value:
    simple: 1 months ago
  required: false
  description: The start date by which to filter incidents. Date format will be the
    same as in the incidents query page, for example, "3 days ago", "1 months ago",
    "2019-01-01T00:00:00 +0200").
  playbookInputQuery:
- key: limit
  value:
    simple: "200"
  required: false
  description: |-
    The maximum number of incidents to query and set to context data.
    Default is: 200
  playbookInputQuery:
- key: minimunIncidentSimilarity
  value:
    simple: "0.2"
  required: true
  description: |-
    Retain incidents with a similarity score that's higher than the MinimunIncidentSimilarity.
    Default: 0.2
    Value should be between 0 to 1 [0=low similarity, 1=identical]
  playbookInputQuery:
- key: similarTextField
  value: {}
  required: true
  description: Comma-separated list of incident text fields to take into account when
    computing similarity. For example commandline, URL
  playbookInputQuery:
- key: CloseSimilar
  value: {}
  required: false
  description: |-
    Define if you would like to close incidents by a similarity percentage. The percentage will be the bottom border for closing inc.
    This option will close also exact matches as well ( if there are).
    Value should be between 0 to 1 [0=low similarity , 1=identical]
  playbookInputQuery:
- key: showIncidentSimilarityForAllFields
  value:
    simple: "True"
  required: false
  description: |-
    Whether to display the similarity score for each of the incident fields that was entered in the "similarTextField".
    Default: True
  playbookInputQuery:
- key: query
  value:
    simple: -status:closed -category:job
  required: false
  description: |-
    The argument for dedicated query on incidents. This helps reduce the query size.
    Default (same is in the Incident tab): "-status:closed -category:job "
  playbookInputQuery:
- key: closeReason
  value:
    simple: Closed by Dedup Playbook within inc ${incident.id}
  required: false
  description: Please specify the reason for closing an incident. This information
    will be added as a note/comment to the closed incident.
  playbookInputQuery:
outputs:
- contextPath: DBotFindSimilarIncidents
  description: Return all the results from the "DBotFindSimilarIncidents" script
  type: string
tests:
- Field polling test
- test-domain-indicator
- Calculate Severity - Generic v2 - Test
- Wait Until Datetime - Test
- Calculate Severity - Standard - Test
- Extract Indicators From File - Generic v2 - Test
- URL Enrichment - Generic v2 - Test
- File Enrichment - Generic v2 - Test
- Domain Enrichment - Generic v2 - Test
- Account Enrichment - Generic v2.1 - Test
- IP Enrichment - Generic v2 - Test
- Get endpoint details - Generic - test
- Detonate URL - Generic Test
- Email Address Enrichment - Generic v2.1 - Test
- Generic Polling Test
- Send Investigation Summary Reports - Test
- Detonate File - No Files test
- Test Convert file hash to corresponding hashes
- Detonate File - Generic Test
- Endpoint Enrichment - Generic v2.1 - Test
- Retrieve File from Endpoint - Generic V2 Test
- Isolate and unisolate endpoint - test
- Block IP - Generic V3_Test
fromversion: 6.0.0
