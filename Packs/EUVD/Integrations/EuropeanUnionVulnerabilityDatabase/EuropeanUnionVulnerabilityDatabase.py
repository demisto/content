import demistomock as demisto
from CommonServerPython import *


class Client(BaseClient):
    def __init__(self, server_url, verify, proxy, headers=None, auth=None):
        super().__init__(base_url=server_url, verify=verify, proxy=proxy, headers=headers, auth=auth)

    def get_advisory_by_id_request(self, id_):
        params = assign_params(id=id_)
        headers = self._headers

        response = self._http_request("get", "/advisory", params=params, headers=headers)

        return response

    def get_by_enisa_id_request(self, id_):
        params = assign_params(id=id_)
        headers = self._headers

        response = self._http_request("get", "/enisaid", params=params, headers=headers)

        return response

    def get_critical_vulnerabilities_request(self):
        headers = self._headers

        response = self._http_request("get", "/criticalvulnerabilities", headers=headers)

        return response

    def get_exploited_vulnerabilities_request(self):
        headers = self._headers

        response = self._http_request("get", "/exploitedvulnerabilities", headers=headers)

        return response

    def get_last_vulnerabilities_request(self):
        headers = self._headers

        response = self._http_request("get", "/lastvulnerabilities", headers=headers)

        return response

    def get_vulnerability_by_id_request(self, id_):
        params = assign_params(id=id_)
        headers = self._headers

        response = self._http_request("get", "/vulnerability", params=params, headers=headers)

        return response

    def query_vulnerabilities_request(
        self, from_score, to_score, from_epss, to_epss, from_date, to_date, product, vendor, assigner, exploited, page, text, size
    ):
        params = assign_params(
            from_score=from_score,
            to_score=to_score,
            from_epss=from_epss,
            to_epss=to_epss,
            from_date=from_date,
            to_date=to_date,
            product=product,
            vendor=vendor,
            assigner=assigner,
            exploited=exploited,
            page=page,
            text=text,
            size=size,
        )
        headers = self._headers

        response = self._http_request("get", "/vulnerabilities", params=params, headers=headers)

        return response


def get_advisory_by_id_command(client: Client, args: Dict[str, Any]) -> CommandResults:
    advisory_id = str(args.get("advisory_id", ""))

    response = client.get_advisory_by_id_request(advisory_id)
    command_results = CommandResults(
        outputs_prefix="EUVD.Advisory", outputs_key_field="id", outputs=response, raw_response=response
    )

    return command_results


def get_vulnerability_by_enisa_id_command(client: Client, args: Dict[str, Any]) -> CommandResults:
    enisa_id = str(args.get("enisa_id", ""))

    response = client.get_by_enisa_id_request(enisa_id)
    command_results = CommandResults(
        outputs_prefix="EUVD.Vulnerability", outputs_key_field="id", outputs=response, raw_response=response
    )

    return command_results


def get_latest_critical_vulnerabilities_command(client: Client, args: Dict[str, Any]) -> CommandResults:
    response = client.get_critical_vulnerabilities_request()
    command_results = CommandResults(
        outputs_prefix="EUVD.Vulnerability", outputs_key_field="id", outputs=response, raw_response=response
    )

    return command_results


def get_latest_exploited_vulnerabilities_command(client: Client, args: Dict[str, Any]) -> CommandResults:
    response = client.get_exploited_vulnerabilities_request()
    command_results = CommandResults(
        outputs_prefix="EUVD.Vulnerability", outputs_key_field="id", outputs=response, raw_response=response
    )

    return command_results


def get_latest_vulnerabilities_command(client: Client, args: Dict[str, Any]) -> CommandResults:
    response = client.get_last_vulnerabilities_request()
    command_results = CommandResults(
        outputs_prefix="EUVD.Vulnerability", outputs_key_field="id", outputs=response, raw_response=response
    )

    return command_results


def get_vulnerability_by_id_command(client: Client, args: Dict[str, Any]) -> CommandResults:
    vulnerability_id = str(args.get("vulnerability_id", ""))

    response = client.get_vulnerability_by_id_request(vulnerability_id)
    command_results = CommandResults(
        outputs_prefix="EUVD.Vulnerability", outputs_key_field="id", outputs=response, raw_response=response
    )

    return command_results


def query_vulnerabilities_command(client: Client, args: Dict[str, Any]) -> CommandResults:
    from_score = str(args.get("from_score", ""))
    to_score = str(args.get("to_score", ""))
    from_epss = str(args.get("from_epss", ""))
    to_epss = str(args.get("to_epss", ""))
    from_date = str(args.get("from_date", ""))
    to_date = str(args.get("to_date", ""))
    product = str(args.get("product", ""))
    vendor = str(args.get("vendor", ""))
    assigner = str(args.get("assigner", ""))
    exploited = argToBoolean(args.get("exploited", False))
    page = args.get("page", None)
    text = str(args.get("text", ""))
    size = args.get("size", None)

    response = client.query_vulnerabilities_request(
        from_score, to_score, from_epss, to_epss, from_date, to_date, product, vendor, assigner, exploited, page, text, size
    )
    command_results = CommandResults(
        outputs_prefix="EUVD.Vulnerability", outputs_key_field="id", outputs=response.get("items"), raw_response=response
    )

    return command_results


def test_module(client: Client) -> None:
    try:
        client.get_critical_vulnerabilities_request()
    except Exception as e:
        if "401" in str(e):
            raise DemistoException("Authorization failed. Please check your API key.")
        elif "403" in str(e):
            raise DemistoException("Access denied. Please check your permissions.")
        elif "404" in str(e):
            raise DemistoException("Resource not found. Please check the URL.")
        else:
            raise DemistoException(f"An error occurred: {str(e)}")
    # If the request was successful, return ok
    return_results("ok")


def main() -> None:
    params: Dict[str, Any] = demisto.params()
    args: Dict[str, Any] = demisto.args()
    url = urljoin(params.get("url"), "/api")
    verify_certificate: bool = not params.get("insecure", False)
    proxy = params.get("proxy", False)

    command = demisto.command()
    demisto.debug(f"Command being called is {command}")

    try:
        disable_warnings()
        client: Client = Client(urljoin(url, ""), verify_certificate, proxy)

        commands = {
            "euvd-get-advisory-by-id": get_advisory_by_id_command,
            "euvd-get-vulnerability-by-enisa-id": get_vulnerability_by_enisa_id_command,
            "euvd-get-latest-critical-vulnerabilities": get_latest_critical_vulnerabilities_command,
            "euvd-get-latest-exploited-vulnerabilities": get_latest_exploited_vulnerabilities_command,
            "euvd-get-latest-vulnerabilities": get_latest_vulnerabilities_command,
            "euvd-get-vulnerability-by-id": get_vulnerability_by_id_command,
            "euvd-query-vulnerabilities": query_vulnerabilities_command,
        }

        if command == "test-module":
            test_module(client)
        elif command in commands:
            return_results(commands[command](client, args))
        else:
            raise NotImplementedError(f"{command} command is not implemented.")

    except Exception as e:
        return_error(str(e))


if __name__ in ["__main__", "builtin", "builtins"]:
    main()
