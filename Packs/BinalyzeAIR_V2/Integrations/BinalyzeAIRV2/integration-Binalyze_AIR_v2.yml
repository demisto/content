category: Forensics & Malware Analysis
commonfields:
  id: Binalyze AIR_v2
  version: -1
configuration:
- additionalinfo: Binalyze AIR Server URL
  display: Binalyze AIR Server URL
  name: server
  required: true
  type: 0
- additionalinfo: 'e.g.: api_1234567890abcdef1234567890abcdef'
  display: API Key
  name: api_key
  required: true
  type: 4
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
description: Collect your forensics data under 10 minutes.
detaileddescription: "### Partner Contributed Integration\n#### Integration Author: Binalyze Integration Team\nSupport and maintenance for this integration are provided by the author. Please use the following contact details:\n- **Email**: [support@binalyze.com](mailto:support@binalyze.com)\n- **URL**: [https://kb.binalyze.com/air/integrations/cortex-xsoar-integration](https://kb.binalyze.com/air/integrations/cortex-xsoar-integration)\n***\n## Binalyze AIR Integration SETUP\n\n- Give a name to your instance,\n- Type AIR server's URL,\n- Copy and paste the API key that you created in AIR Server,\n- Test connection beforehand for the health check,\n- Click Save & Exit on the right bottom corner.\n---\n## USAGE \nYou can use the integration in Automation, Playbooks, or Playground.\n\n**Isolation**\n- !air-isolate *hostname*=\\<HOSTNAMEofENDPOINT\\> *organization_id*=\\<ORGANIZATION ID\\> *isolation*=\\<ENABLE or DISABLE\\>\n\n**Acquisition**\n- !air-acquire *hostname*=\\<HOSTNAMEofENDPOINT\\> *profile*=\\<DEFINED PROFILE\\> *caseid*=\\<The Case ID\\>\n\n*You can use custom acquisition profiles you created in the AIR.*\n\n**Pre-defined Profiles:**\n- browsing-history\n- compromise-assessment\n- event-logs\n- full\n- memory-ram-pagefile\n- quick\n\n ---\nFor more information, please refer to [View integration documentation](https://kb.binalyze.com/air/integrations/cortex-xsoar-integration).\n \nFor support, please e-mail us: support@binalyze.com \n\n\n---\n[View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/binalyze-air)"
display: Binalyze AIR_v2
image: data:image/png;base64,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
name: Binalyze AIR_v2
script:
  commands:
  - arguments:
    - description: Hostname of endpoint.
      name: hostname
      required: true
    - auto: PREDEFINED
      description: Organization ID of the endpoint. For a custom organization ID, you can specify a custom value outside the predefined set.
      name: organization_id
      predefined:
      - "0"
      - "1"
      - "2"
      required: true
    - auto: PREDEFINED
      description: To isolate use enable.
      name: isolation
      predefined:
      - enable
      - disable
      required: true
    description: Isolate an endpoint.
    name: binalyze-air-isolate
    outputs:
    - contextPath: BinalyzeAIR.Isolate.result._id
      description: Isolation unique task ID.
      type: string
    - contextPath: BinalyzeAIR.Isolate.result.name
      description: Isolation task name.
      type: string
    - contextPath: BinalyzeAIR.Isolate.result.organizationId
      description: Organization Id of endpoint.
      type: number
  - arguments:
    - description: Hostname of endpoint.
      name: hostname
      required: true
    - auto: PREDEFINED
      description: Acquisition profile. To use a custom acquisition profile, you can specify a custom profile outside the predefined set.
      name: profile
      predefined:
      - compromise-assessment
      - browsing-history
      - event-logs
      - memory-ram-pagefile
      - quick
      - full
      required: true
    - description: ID for the case,e.g. C-2022-0001.
      name: case_id
      required: true
    - auto: PREDEFINED
      description: Organization ID of the endpoint. For a custom organization ID, you can specify a custom value outside the predefined set.
      name: organization_id
      predefined:
      - "0"
      - "1"
      - "2"
      required: true
    description: Acquire evidence from an endpoint.
    name: binalyze-air-acquire
    outputs:
    - contextPath: BinalyzeAIR.Acquire.result._id
      description: Acquisition unique task ID.
      type: string
    - contextPath: BinalyzeAIR.Acquire.result.name
      description: Acquisition task name.
      type: string
    - contextPath: BinalyzeAIR.Acquire.result.organizationId
      description: Organization Id of endpoint.
      type: number
  - arguments:
    - name: description
    - name: rule
    - auto: PREDEFINED
      name: engine
      predefined:
      - yara
      - sigma
      - osquery
    - auto: PREDEFINED
      name: searchIn
      predefined:
      - system
      - memory
      - both
      - event-records
    - description: comma-seperated values.
      name: organizationIds
    name: binalyze-air-create-triage-rule
  - arguments:
    - name: rule
    - auto: PREDEFINED
      name: engine
      predefined:
      - yara
      - sigma
      - osquery
    name: binalyze-air-validate-triage-rule
  - arguments:
    - name: name
    - name: organizationId
      required: true
    - name: ownerUserId
      required: true
    - auto: PREDEFINED
      name: visibility
      predefined:
      - Public to Organization
      - Private to Users
      required: true
    - name: assignedUserIds
    name: binalyze-air-create-case
  - arguments:
    - name: description
    - name: rule
    - auto: PREDEFINED
      name: searchIn
      predefined:
      - system
      - memory
      - both
      - event-records
    - name: organizationIds
    name: binalyze-air-update-triage-rule
  - arguments:
    - name: file_name
    name: binalyze-air-download-file
  - arguments:
    - name: caseId
    - description: comma separeted values.
      name: triageRuleIds
    - auto: PREDEFINED
      defaultValue: use-policy
      name: task_config_choice
      predefined:
      - use-policy
      - use-custom-options
    - defaultValue: "8"
      description: min:1 max:100.
      name: task_config_cpu_limit
    - description: device name probably.
      name: hostname
    - auto: PREDEFINED
      name: mitreAttack
      predefined:
      - "True"
      - "False"
    - description: comma separated values.
      name: excludedEndpointIds
    - description: comma separated values.
      name: includedEndpointIds
    name: binalyze-air-assign-triage-task
  dockerimage: demisto/python3:3.12.12.7090913
  runonce: false
  script: |
    register_module_line('Binalyze AIR', 'start', __line__())
    demisto.debug('pack name = Binalyze AIR, pack version = 1.1.9')


    from typing import Any
    import re
    import urllib3
    import json

    urllib3.disable_warnings()


    class Client(BaseClient):
        def test_api(self):
            return self._http_request(method="GET", url_suffix="/api/public/endpoints?filter[organizationIds]=0")

        def get_profile_id(self, profile: str, organization_id: int | None) -> str:
            """Gets the profile ID based on the profile name and organization ID by making a GET request to the
            '/api/public/acquisitions/profiles' endpoint.
            Args:
            profile (str): The name of the profile to query.
            organization_id (int): The organization ID associated with the profile.
            Returns:
            str: The profile ID obtained from the API response.
            Raises:
            DemistoException: If there is an error making the HTTP request or processing the API response.
            """
            preset_profiles = ["browsing-history", "compromise-assessment", "event-logs", "full", "memory-ram-pagefile", "quick"]
            if profile in preset_profiles:
                return profile
            else:
                result = (
                    self._http_request(
                        method="GET",
                        url_suffix=f"/api/public/acquisitions/profiles?filter[name]={profile}&filter[organizationIds]="
                        f"{organization_id}",
                    )
                    .get("result", {})
                    .get("entities", [])
                )
                profile_id = ""
                for entity in result:
                    if entity.get("name") == profile:
                        profile_id = entity.get("_id")
                        if profile_id:
                            return profile_id
                # There is no match with profile_id.
                if not profile_id:
                    return_error(
                        f'The acquisition profile "{profile}" cannot be found. Please ensure that you enter a valid profile name.'
                    )
                return ""

        def air_acquire(self, hostname: str, profile: str, case_id: str, organization_id: int | None) -> dict[str, Any]:
            """Makes a POST request /api/public/acquisitions/acquire endpoint to verify acquire evidence

            :param hostname str: endpoint hostname to start acquisition.
            :param profile str: get the profile string makes a query, and uses profile_id for mapping correct profile.

            :param case_id str: The Case ID to associate with in AIR Server.
            :param organization_id int: Organizsation ID of the endpoint.

            Create a payload with the parameters
            :return JSON response from /api/app/info endpoint
            :rtype Dict[str, Any]
            """

            payload: dict[str, Any] = {
                "caseId": case_id,
                "droneConfig": {"autoPilot": False, "enabled": False},
                "taskConfig": {"choice": "use-policy"},
                "acquisitionProfileId": self.get_profile_id(profile, organization_id),
                "filter": {"name": hostname, "organizationIds": [organization_id]},
            }
            return self._http_request(method="POST", url_suffix="/api/public/acquisitions/acquire", json_data=payload)

        def air_isolate(self, hostname: str, organization_id: int | None, isolation: str) -> dict[str, Any]:
            """Makes a POST request /api/public/acquisitions/acquire endpoint to verify acquire evidence
            :param hostname str: endpoint hostname to start acquisition.
            :param isolation str: To isolate enable, to disable isolate use disable
            :param organization_id int: Organization ID of the endpoint.

            Create a payload with the parameters
            :return JSON response from /api/public/endpoints/tasks/isolation endpoint
            :rtype Dict[str, Any]
            """

            payload: dict[Any, Any] = {"enabled": True, "filter": {"name": hostname, "organizationIds": [organization_id]}}

            if isolation == "disable":
                disable = {"enabled": False}
                payload.update(disable)

            return self._http_request(method="POST", url_suffix="/api/public/endpoints/tasks/isolation", json_data=payload)

        def create_triage_rule(self, description, rule, searchIn, engine, organizationIds) -> dict[str, Any]:

            payload: dict[Any, Any] = {"description": description,"rule": rule, "searchIn": searchIn, "engine": engine, "organizationIds": [organizationIds]}

            return self._http_request(method="POST", url_suffix="api/public/triages/rules", json_data=payload)

        def assign_triage_task(self,body) -> dict[str, Any]:

            return self._http_request(method="POST", url_suffix="api/public/triages/triage", json_data=body)

        def download_file(self,file_name):

            params: dict[Any, Any] = {"filename": file_name}
            return self._http_request(method="GET", url_suffix="api/public/interact/library/download", params=params,resp_type="response",)

        def update_triage_rule(self, description, rule, searchIn, rule_id, organizationIds) -> dict[str, Any]:

            payload: dict[Any, Any] = {"description": description,"rule": rule, "searchIn": searchIn,"organizationIds": [organizationIds]}

            return self._http_request(method="PUT", url_suffix=f"api/public/triages/rules/:{rule_id}", json_data=payload)

        def validate_triage_rule(self,rule,engine) -> dict[str, Any]:

            payload: dict[Any, Any] = {"rule": rule,"engine": engine}

            return self._http_request(method="POST", url_suffix="api/public/triages/rules/validate", json_data=payload)

        def create_case(self, organizationId, name, ownerUserId, visibility, assignedUserIds) -> dict[str, Any]:

            payload: dict[Any, Any] = {"organizationId": [organizationId], "name": name, "ownerUserId": ownerUserId, "visibility": visibility, "assignedUserIds": assignedUserIds}

            return self._http_request(method="POST", url_suffix="api/public/cases", json_data=payload)

    def test_connection(client: Client) -> str:
        """Command for test-connection"""
        try:
            client.test_api()
        except DemistoException as ex:
            if "Unauthorized" in str(ex):
                return demisto.results(f"Authorization Error: Make sure API Key is correctly set.{str(ex)}")
            if "ConnectionError" in str(ex):
                return demisto.results(f"Connection Error: Test connection failed. {str(ex)}")
            else:
                raise ex
        return demisto.results("ok")


    def air_acquire_command(client: Client, args: dict[str, Any]) -> CommandResults:
        """Command handler for acquire command"""
        hostname = args.get("hostname", "")
        profile = args.get("profile", "")
        case_id = args.get("case_id", "")
        organization_id = args.get("organization_id", "")

        result: dict[str, Any] = client.air_acquire(hostname, profile, case_id, arg_to_number(organization_id))
        readable_output = tableToMarkdown(
            "Binalyze AIR Acquisition Results",
            result,
            headers=("success", "result", "statusCode", "errors"),
            headerTransform=string_to_table_header,
        )

        if result.get("statusCode") == 404:
            return CommandResults(readable_output="No contex for queried hostname.")

        return CommandResults(
            outputs_prefix="BinalyzeAIR.Acquisition",
            outputs_key_field="hostname",
            outputs={"Result": result["result"], "Success": result["success"]},
            readable_output=readable_output,
        )


    def air_isolate_command(client: Client, args: dict[str, Any]) -> CommandResults:
        """Command handler isolate"""

        hostname = args.get("hostname", "")
        organization_id = args.get("organization_id", "")
        isolation = args.get("isolation", "")

        result: dict[Any, Any] = client.air_isolate(hostname, arg_to_number(organization_id), isolation)
        readable_output = tableToMarkdown(
            "Binalyze AIR Isolate Results",
            result,
            headers=("success", "result", "statusCode", "errors"),
            headerTransform=string_to_table_header,
        )
        if result.get("statusCode") == 404:
            return CommandResults(readable_output="No contex for queried hostname.")

        return CommandResults(
            outputs_prefix="BinalyzeAIR.Isolate",
            outputs_key_field="hostname",
            outputs={"Result": result["result"], "Success": result["success"]},
            readable_output=readable_output,
        )

    def binalyze_air_download_file_command(client: Client, args: dict[str, Any]) -> CommandResults:
        """Command handler isolate"""

        file_name = args.get("file_name", "")

        result = client.download_file(file_name)
        return_results(fileResult(file_name, result.content))
        if result.status_code == 200:
            readable_output = "Binalyze AIR Download File commandı basarı ile calıstı"
        else:
            readable_output = "Binalyze AIR Download File commandı hata aldı, hata kodu:{result.status_code}"

        return CommandResults(readable_output=readable_output)


    def binalyze_air_assign_triage_task_command(client: Client, args: dict[str, Any]) -> CommandResults:

        caseId = args.get("caseId")
        triageRuleIds = argToList(args.get("triageRuleIds"))
        task_config_choice = args.get("task_config_choice")
        task_config_cpu_limit = int(args.get("task_config_cpu_limit"))
        hostname = args.get("hostname","")
        mitreAttack = bool(args.get("mitreAttack",False))
        includedEndpointIds = argToList(args.get("includedEndpointIds"))
        excludedEndpointIds = argToList(args.get("excludedEndpointIds"))

        body = {
        "caseId": caseId,
        "triageRuleIds": triageRuleIds,
        "taskConfig": {
            "choice": task_config_choice,
            "cpu":{
                "limit":task_config_cpu_limit
                }
            },
        "mitreAttack": {
            "enabled": mitreAttack
            },
        "filter": {
            "name": hostname,
            "groupId": "",
            "groupFullPath": "",
            "isolationStatus": [],
            "platform": [],
            "issue": "",
            "onlineStatus": [],
            "tags": [],
            "version": "",
            "policy": "",
            "includedEndpointIds": includedEndpointIds,
            "excludedEndpointIds": excludedEndpointIds,
            "organizationIds": [0]
            },
        "schedulerConfig": {
            "when": "now"
            }
        }

        result = client.assign_triage_task(body=body)
        return CommandResults(
            outputs_prefix="BinalyzeAIR.Assign.Triage.Task",
            outputs_key_field="hostname",
            outputs=result,
            readable_output=result,
        )
        """
        readable_output = tableToMarkdown(
            "Binalyze AIR Create Triage Rule Results",
            result,
            headers=("success", "result", "statusCode", "errors"),
            headerTransform=string_to_table_header,
        )


        if result.get("statusCode") == 404:
            return CommandResults(readable_output="Status kod 404.")

        return CommandResults(
            outputs_prefix="BinalyzeAIR.Assign.Triage.Task",
            outputs_key_field="hostname",
            outputs={"Result": result["result"], "Success": result["success"], "Errors": result["errors"], "StatusCode": result["statusCode"]},
            readable_output=readable_output,
        )
        """

    def binalyze_air_create_triage_rule_command(client: Client, args: dict[str, Any]) -> CommandResults:
        """Command handler isolate"""

        description = args.get("description", "")
        rule = args.get("rule", "")
        searchIn = args.get("searchIn", "")
        engine = args.get("engine", "")
        organizationIds = args.get("organizationIds", "")

        result: dict[Any, Any] = client.create_triage_rule(description, rule, searchIn, engine, [organizationIds])
        """
        rule_res = ""
        try:
            match = re.search(r'rule([\s\S]*?)type:',result["result"])
            if match:
                rule_res = match.group(1).strip()
        except Exception as e:
            return_results(result["result"])
        result["rule"] = rule_res
        """
        result["rule"] = result["result"]["rule"]
        readable_output = tableToMarkdown(
            "Binalyze AIR Create Triage Rule Results",
            result,
            headers=("success", "result", "statusCode", "errors","rule"),
            headerTransform=string_to_table_header,
        )


        if result.get("statusCode") == 404:
            return CommandResults(readable_output="Status kod 404.")

        return CommandResults(
            outputs_prefix="BinalyzeAIR.Create.Triage.Rule",
            outputs_key_field="hostname",
            outputs={"Result": result["result"], "Success": result["success"], "Rule": result["rule"]},
            readable_output=readable_output,
        )

    def binalyze_air_update_triage_rule_command(client: Client, args: dict[str, Any]) -> CommandResults:
        """Command handler isolate"""

        description = args.get("description", "")
        rule = args.get("rule", "")
        searchIn = args.get("searchIn", "")
        organizationIds = args.get("organizationIds", "")
        rule_id = args.get("rule", "")
        result: dict[Any, Any] = client.update_triage_rule(description, rule, searchIn, rule_id, [organizationIds])

        result["rule"] = result["result"]["rule"]
        readable_output = tableToMarkdown(
            "Binalyze AIR Update Triage Rule Results",
            result,
            headers=("success", "result", "statusCode", "errors","rule"),
            headerTransform=string_to_table_header,
        )

        if result.get("statusCode") == 404:
            return CommandResults(readable_output="Status kod 404.")

        return CommandResults(
            outputs_prefix="BinalyzeAIR.Update.Triage.Rule",
            outputs_key_field="hostname",
            outputs={"Result": result["result"], "Success": result["success"], "Rule": result["rule"]},
            readable_output=readable_output,
        )

    def binalyze_air_validate_triage_rule_command(client: Client, args: dict[str, Any]) -> CommandResults:
        """Command handler isolate"""

        rule = args.get("rule", "")
        engine = args.get("engine", "")

        result: dict[Any, Any] = client.validate_triage_rule(rule,engine)

        readable_output = tableToMarkdown(
            "Binalyze AIR Validate Triage Rule Results",
            result,
            headers=("success", "result", "statusCode", "errors"),
            headerTransform=string_to_table_header,
        )

        if result.get("statusCode") == 660:
            return CommandResults(readable_output=" Validation FAİLED!!!")

        return CommandResults(
            outputs_prefix="BinalyzeAIR.Validate.Triage.Rule",
            outputs_key_field="hostname",
            outputs={"Result": result["result"], "Success": result["success"]},
            readable_output=readable_output,
        )

    # <<< CREATE-CASE ADDED
    def binalyze_air_create_case_command(client: Client, args: dict[str, Any]) -> CommandResults:
        """
        Command handler for `binalyze-air-create-case`.
        """
        organizationId = args.get("organizationId", "")
        name = args.get("name", "")
        ownerUserId = args.get("ownerUserId", "")
        visibility = args.get("visibility", "public-to-organization")
        assignedUserIds = args.get("assignedUserIds", [])          # can be a list or a CSV string

        # If the user passed a CSV string, convert it to a list
        if isinstance(assignedUserIds, str):
            assignedUserIds = [uid.strip() for uid in assignedUserIds.split(",") if uid.strip()]

        result: dict[str, Any] = client.create_case(
            organizationId=organizationId,
            name=name,
            ownerUserId=ownerUserId,
            visibility=visibility,
            assignedUserIds=assignedUserIds,
        )

        if result is None:
            # _http_request döndüğü None, yani 201 kodu ok_codes’da yoktu.
            # Bu durumun tekrar ortaya çıkmaması için (örnek) bir hata fırlatıyoruz.
            return_error(
                "Binalyze AIR returned an empty response while creating the case. "
                "Make sure the integration is configured with ok_codes that include 201 (Created)."
            )

        readable_output = tableToMarkdown(
            "Binalyze AIR – Create Case Result",
            result,
            headers=("success", "result", "statusCode", "errors", "caseId"),
            headerTransform=string_to_table_header,
        )

        # Return the created case ID (if present) in the context data
        case_id = result.get("result", {}).get("_id") or result.get("result", {}).get("caseId")
        return CommandResults(
            outputs_prefix="BinalyzeAIR.Case",
            outputs_key_field="caseId",
            outputs={"CaseID": case_id, "Result": result.get("result"), "Success": result.get("success")},
            readable_output=readable_output,
        )
    # <<< END CREATE-CASE

    """ Entrypoint """


    def main() -> None:  # pragma: no cover
        api_key: str = demisto.params().get("api_key")
        base_url: str = demisto.params()["server"]
        verify_certificate: bool = not demisto.params().get("insecure", False)
        proxy: bool = demisto.params().get("proxy", False)
        command: str = demisto.command()
        args: dict[str, Any] = demisto.args()
        headers: dict[str, Any] = {
            "Authorization": f"Bearer {api_key}",
            "User-Agent": "Binalyze AIR",
            "Content-type": "application/json",
            "Accept-Charset": "UTF-8",
        }

        if command == "binalyze-air-download-file":
            headers["Accept"]="application/octet-stream"
        try:
            demisto.debug(f"Command being called is {demisto.command()}")
            client: Client = Client(base_url=base_url, verify=verify_certificate, headers=headers, proxy=proxy, ok_codes=(200, 201, 202, 204, 404))
            if command == "test-module":
                return_results(test_connection(client))
            elif command == "binalyze-air-acquire":
                return_results(air_acquire_command(client, args))
            elif command == "binalyze-air-isolate":
                return_results(air_isolate_command(client, args))
            elif command == "binalyze-air-create-triage-rule":
                return_results(binalyze_air_create_triage_rule_command(client, args))
            elif command == "binalyze-air-assign-triage-task":
                return_results(binalyze_air_assign_triage_task_command(client, args))
            elif command == "binalyze-air-download-file":

                return_results(binalyze_air_download_file_command(client, args))
            elif command == "binalyze-air-update-triage-rule":
                return_results(binalyze_air_update_triage_rule_command(client, args))
            elif command == "binalyze-air-validate-triage-rule":
                return_results(binalyze_air_validate_triage_rule_command(client, args))
            elif command == "binalyze-air-create-case":
                return_results(binalyze_air_create_case_command(client, args))
        except Exception as ex:
            demisto.error(traceback.format_exc())  # print the traceback
            return_error(f'Failed to execute "{command}". Error: {str(ex)}')


    if __name__ in ("__main__", "__builtin__", "builtins"):  # pragma: no cover
        main()

    register_module_line('Binalyze AIR', 'end', __line__())
  subtype: python3
  type: python
fromversion: 6.0.0
tests:
- No tests (auto formatted)
