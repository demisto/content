id: Intezer - Process Phishing Email
version: -1
fromversion: 6.5.0
name: Intezer - Process Phishing Email
description: Analyze the given email's attachments and URLs on Intezer Analyze.
tags:
- Phishing
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 58779620-48f6-4c0e-83f2-907286ebbf05
    type: start
    task:
      id: 58779620-48f6-4c0e-83f2-907286ebbf05
      version: -1
      name: ""
      description: start
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 90,
          "y": -110
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: c820b329-66a0-4821-8281-e8833b472757
    type: condition
    task:
      id: c820b329-66a0-4821-8281-e8833b472757
      version: -1
      name: Is Intezer Module Enabled
      description: Checks if there is an instance of the Intezer integration enabled.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "25"
      "yes":
      - "14"
      - "18"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: Intezer v2
                    ignorecase: true
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
                    ignorecase: true
                accessor: brand
            iscontext: true
          right:
            value: {}
    view: |-
      {
        "position": {
          "x": 90,
          "y": 75
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 821c17cb-f2cc-41e7-8136-6bf210a4ae9c
    type: regular
    task:
      id: 821c17cb-f2cc-41e7-8136-6bf210a4ae9c
      version: -1
      name: Intezer - Analyze URL
      description: Checks the URL reputation.
      script: Intezer v2|||intezer-analyze-url
      type: regular
      iscommand: true
      brand: Intezer v2
    nexttasks:
      '#none#':
      - "16"
    scriptarguments:
      file_hash:
        complex:
          root: inputs.url
      url:
        simple: ${inputs.URL.Data}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 420,
          "y": 540
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 99dbc81c-f299-4ab3-8646-acaded7b8e2c
    type: condition
    task:
      id: 99dbc81c-f299-4ab3-8646-acaded7b8e2c
      version: -1
      name: Is there a url to analyze?
      description: Checks if there is a url to analyze.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "25"
      "yes":
      - "13"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: ${inputs
                accessor: URL}
            iscontext: true
    view: |-
      {
        "position": {
          "x": 410,
          "y": 330
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: 3a90498c-d4da-42da-87cd-b3fd60160be3
    type: playbook
    task:
      id: 3a90498c-d4da-42da-87cd-b3fd60160be3
      version: -1
      name: GenericPolling
      description: |-
        Use this playbook as a sub-playbook to block execution of the master playbook until a remote action is complete.
        This playbook implements polling by continuously running the command in Step \#2 until the operation completes.
        The remote action should have the following structure:

        1. Initiate the operation.
        2. Poll to check if the operation completed.
        3. (optional) Get the results of the operation.
      playbookName: GenericPolling
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      AdditionalPollingCommandArgNames:
        simple: analysis_type
      AdditionalPollingCommandArgValues:
        simple: Url
      Ids:
        complex:
          root: Intezer
          accessor: Analysis.ID
      Interval:
        complex:
          root: inputs.Interval
      PollingCommandArgName:
        simple: analysis_id
      PollingCommandName:
        simple: intezer-get-analysis-result
      Timeout:
        complex:
          root: inputs.Timeout
      dt:
        simple: Intezer.Analysis(val.Status !== 'Done')
    separatecontext: false
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": 420,
          "y": 745
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 38f800ba-1f51-4fe7-8950-b54bc68450d8
    type: regular
    task:
      id: 38f800ba-1f51-4fe7-8950-b54bc68450d8
      version: -1
      name: Intezer - get analysis result
      description: Wait and get analysis results. Supports file analysis, url and
        endpoint analysis.
      script: Intezer v2|||intezer-get-analysis-result
      type: regular
      iscommand: true
      brand: Intezer v2
    nexttasks:
      '#none#':
      - "25"
    scriptarguments:
      analysis_id:
        complex:
          root: Intezer
          accessor: Analysis.ID
      analysis_type:
        simple: Url
    separatecontext: false
    continueonerror: true
    view: |-
      {
        "position": {
          "x": 420,
          "y": 970
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: a433505a-4ed0-4094-8197-20d1f5d40bb8
    type: condition
    task:
      id: a433505a-4ed0-4094-8197-20d1f5d40bb8
      version: -1
      name: Is there a file to analyze?
      description: Check if the file exists in Intezer genome database
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "25"
      "yes":
      - "23"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: ${inputs
                accessor: File}
            iscontext: true
    view: |-
      {
        "position": {
          "x": -200,
          "y": 330
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: ad125c1f-7c95-452c-80f9-a79340a6cf96
    type: regular
    task:
      id: ad125c1f-7c95-452c-80f9-a79340a6cf96
      version: -1
      name: Intezer - Analyze attachment
      description: Checks file reputation for uploaded file (up to 150MB)
      script: Intezer v2|||intezer-analyze-by-file
      type: regular
      iscommand: true
      brand: Intezer v2
    nexttasks:
      '#none#':
      - "20"
    scriptarguments:
      file_entry_id:
        simple: ${inputs.File.EntryID}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -200,
          "y": 980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: 8f788e35-3608-4889-892d-441bf0f0f00b
    type: playbook
    task:
      id: 8f788e35-3608-4889-892d-441bf0f0f00b
      version: -1
      name: GenericPolling
      description: |-
        Use this playbook as a sub-playbook to block execution of the master playbook until a remote action is complete.
        This playbook implements polling by continuously running the command in Step \#2 until the operation completes.
        The remote action should have the following structure:

        1. Initiate the operation.
        2. Poll to check if the operation completed.
        3. (optional) Get the results of the operation.
      playbookName: GenericPolling
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      AdditionalPollingCommandArgNames:
        simple: analysis_type
      AdditionalPollingCommandArgValues:
        simple: File
      Ids:
        complex:
          root: Intezer
          accessor: Analysis.ID
      Interval:
        complex:
          root: inputs.Interval
      PollingCommandArgName:
        simple: analysis_id
      PollingCommandName:
        simple: intezer-get-analysis-result
      Timeout:
        complex:
          root: inputs.Timeout
      dt:
        simple: Intezer.Analysis(val.Status !== 'Done')
    separatecontext: false
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": -200,
          "y": 1215
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: cff5e115-1d1f-420c-8f60-513fbb023032
    type: regular
    task:
      id: cff5e115-1d1f-420c-8f60-513fbb023032
      version: -1
      name: Intezer - get analysis result
      description: Wait and get analysis results. Supports file analysis, url and
        endpoint analysis.
      script: Intezer v2|||intezer-get-analysis-result
      type: regular
      iscommand: true
      brand: Intezer v2
    nexttasks:
      '#none#':
      - "25"
    scriptarguments:
      analysis_id:
        complex:
          root: Intezer
          accessor: Analysis.ID
      analysis_type:
        simple: File
    separatecontext: false
    continueonerror: true
    view: |-
      {
        "position": {
          "x": -200,
          "y": 1440
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: 249d5f97-0010-45f9-8364-8e2db0f5e501
    type: regular
    task:
      id: 249d5f97-0010-45f9-8364-8e2db0f5e501
      version: -1
      name: Get File Analysis
      description: Checks file reputation of the given hash, supports SHA256, SHA1
        and MD5 by looking at the latest available report
      script: Intezer v2|||intezer-get-latest-report
      type: regular
      iscommand: true
      brand: Intezer v2
    nexttasks:
      '#error#':
      - "19"
      '#none#':
      - "24"
    scriptarguments:
      file_hash:
        simple: ${inputs.File.SHA256}
    separatecontext: false
    continueonerror: true
    view: |-
      {
        "position": {
          "x": -200,
          "y": 540
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: 002deef5-d969-4af9-8743-6010ad8429f7
    type: condition
    task:
      id: 002deef5-d969-4af9-8743-6010ad8429f7
      version: -1
      name: Check If the Analysis exists
      description: Check if the analysis exists in Intezer genome database
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "19"
      "yes":
      - "21"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isTrue
          left:
            value:
              simple: File.ExistsInIntezer
            iscontext: true
          right:
            value: {}
    view: |-
      {
        "position": {
          "x": -200,
          "y": 730
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 0f8a92a6-ced6-438a-846a-52b1cc0dd609
    type: playbook
    task:
      id: 0f8a92a6-ced6-438a-846a-52b1cc0dd609
      version: -1
      name: Calculate Severity - Generic v2
      description: |-
        Calculate and assign the incident severity based on the highest returned severity level from the following calculations:

        - DBotScores of indicators
        - Critical assets
        - Email authenticity
        - Current incident severity
        - Microsoft Headers
      playbookName: Calculate Severity - Generic v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "26"
    scriptarguments:
      Account:
        complex:
          root: Account
          transformers:
          - operator: uniq
      CriticalEndpoints:
        simple: admin
      CriticalGroups:
        simple: admins,administrators
      CriticalUsers:
        simple: admin,administrator
      DBotScore:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Vendor
                iscontext: true
              right:
                value:
                  simple: Intezer
      EmailAuthenticityCheck:
        complex:
          root: Email
          accessor: AuthenticityCheck
          transformers:
          - operator: uniq
      Endpoint:
        complex:
          root: Endpoint
          transformers:
          - operator: uniq
      MicrosoftHeadersSeverityCheck:
        simple: ${Email.MicrosoftHeadersSeverityCheck}
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
      forEach: true
    view: |-
      {
        "position": {
          "x": 230,
          "y": 1840
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: b5d58467-15b8-48a2-86af-c387fb947ce6
    type: title
    task:
      id: b5d58467-15b8-48a2-86af-c387fb947ce6
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ""
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 230,
          "y": 2010
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "18_25_#default#": 0.37,
      "5_14_yes": 0.46,
      "5_18_yes": 0.28,
      "5_25_#default#": 0.5
    },
    "paper": {
      "dimensions": {
        "height": 2185,
        "width": 1000,
        "x": -200,
        "y": -110
      }
    }
  }
inputs:
- key: Interval
  value:
    simple: "1"
  required: true
  description: How often the polling command should run (in minutes).
  playbookInputQuery: null
- key: Timeout
  value:
    simple: "15"
  required: true
  description: Amount of time to wait before a timeout occurs  (in minutes).
  playbookInputQuery: null
- key: File
  value: {}
  required: false
  description: A file object that represents an email attachment
  playbookInputQuery: null
- key: URL
  value: {}
  required: false
  description: The URL object
  playbookInputQuery: null
outputs:
- contextPath: URL.Data
  description: The submitted Url
  type: string
- contextPath: URL.Malicious.Vendor
  description: For malicious Url, the vendor that made the decision
  type: string
- contextPath: URL.Metadata
  description: Metadata returned from Intezer analysis.
  type: Unknown
- contextPath: URL.ExistsInIntezer
  description: Does the url exists on Intezer
  type: Boolean
- contextPath: DBotScore
  description: The DBotScore object.
  type: unknown
- contextPath: DBotScore.Indicator
  description: The indicator that was tested.
  type: string
- contextPath: DBotScore.Type
  description: The indicator type.
  type: string
- contextPath: DBotScore.Vendor
  description: Vendor used to calculate the score.
  type: string
- contextPath: DBotScore.Score
  description: The actual score.
  type: number
- contextPath: File.Metadata
  description: Metadata returned from Intezer analysis (analysis id, analysis url,
    family, family type, sha256, verdict, sub_verdict). Metadata will be returned
    only for supported files.
- contextPath: File.ExistsInIntezer
  description: Does the file exists on Intezer genome database
- contextPath: File.Malicious.Vendor
  description: For malicious files, the vendor that made the decision
tests:
- No tests (auto formatted)
