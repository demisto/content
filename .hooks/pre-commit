#!/bin/bash

# validating that each modified file has a valid schema, release notes, proper prefix & suffix
echo "Validating files..."
if [[ -z "${WINDIR}" ]]
    then
        PYTHONPATH="`pwd`:${PYTHONPATH}" python Tests/scripts/validate_files.py -t true
    else
        python Tests/scripts/validate_files.py
fi

RES=$?

echo ""
if [[ -n "$CONTENT_PRECOMMIT_RUN_DEV_TASKS" ]]; then
    echo "Running content dev tasks (flake8, mypy, pylint, pytst) as env variable CONTENT_PRECOMMIT_RUN_DEV_TASKS is set."
    ./Tests/scripts/run_all_pkg_dev_tasks.sh
    RES=$(($RES + $?))
else    
    echo "Skipping running dev tasks (flake8, mypy, pylint, pytest). If you want to run this as part of the precommit hook"
    echo 'set CONTENT_PRECOMMIT_RUN_DEV_TASKS=1. You can add the following line to ~/.zshrc:'
    echo 'echo "export CONTENT_PRECOMMIT_RUN_DEV_TASKS=1" >> ~/.zshrc'
fi

if [[ $RES -ne 0 ]]
  then
    echo "Please fix the aforementioned errors and then commit again"
    exit 1
fi


# prevent push to master
if [ -z "$1"  ]; then
    protected_branch='master'
    current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')
    if [ $protected_branch = $current_branch ]; then
        echo "pushing to master is not allowed"
        exit 1
    fi
fi