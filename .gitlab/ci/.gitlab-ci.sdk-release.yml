.release-sdk:
  rules:
    - if: '$SDK_RELEASE == "true"'


trigger-nightlies:
  stage: trigger-nightlies
  extends:
    - .release-sdk
    - .default-job-settings
  artifacts:
    expire_in: 48 hrs
    paths:
      - ${CI_PROJECT_DIR}/artifacts/*
    when: always
  variables:
    BRANCH_NAME: $BRANCH_NAME
    CONTENT_CI_TOKEN: $CONTENT_CI_TOKEN
    CONTENT_INTERNAL_DIST_TRIGGER_NIGHTLY: $CONTENT_INTERNAL_DIST_TRIGGER_NIGHTLY
    SLACK_CHANNEL: $SLACK_CHANNEL
    RELEASE_VERSION: $RELEASE_VERSION
    GITHUB_TOKEN: $GITHUB_TOKEN
    ARTIFACTS_FOLDER: "${CI_PROJECT_DIR}/artifacts/"
  script:
    - echo $RELEASE_VERSION
#    - python3 ./Tests/sdk_release/create_release_branch.py -t $GITHUB_TOKEN -b $RELEASE_VERSION
    - PIPELINE_ID=$(python3 ./Utils/trigger_private_build.py --nightly --private-branch-name add-sdk-ref --github-token "${GITHUB_TOKEN}" --slack-channel "${SLACK_CHANNEL}" --sdk-ref $RELEASE_VERSION)
    - echo "PIPELINE_ID =" $PIPELINE_ID
    - echo $PIPELINE_ID > ${ARTIFACTS_FOLDER}/PIPELINE_ID.txt
#    - export PIPELINE_ID=$(./Utils/gitlab_triggers/trigger_content_internal_dist_nightly_build.sh -ct $CONTENT_INTERNAL_DIST_TRIGGER_NIGHTLY -sdk $RELEASE_VERSION | jq .id)
#    - echo "PIPELINE_ID = " $PIPELINE_ID
#    - echo $PIPELINE_ID > ${ARTIFACTS_FOLDER}/PIPELINE_ID.txt
    - echo "test"
#    - python3 ./Tests/scripts/gitlab_slack_notifier_copy.py -s "${SLACK_TOKEN}" -t "test message"
#    - ./Utils/gitlab_triggers/trigger_content_nightly_build.sh -ct $CI_TOKEN



wait-for-build-to-finish:
  stage: wait-for-build-to-finish
  extends:
    - .release-sdk
    - .default-job-settings
  dependencies:
    - trigger-nightlies
  needs:
    - trigger-nightlies
  artifacts:
    expire_in: 48 hrs
    paths:
      - ${CI_PROJECT_DIR}/artifacts/*
  variables:
    ARTIFACTS_FOLDER: "${CI_PROJECT_DIR}/artifacts/"
  script:
    - PIPELINE_ID=$(head -n 1 ${ARTIFACTS_FOLDER}/PIPELINE_ID.txt)
    - echo "PIPELINE_ID =" $PIPELINE_ID
#    - python3 ./Tests/sdk_release/wait_for_pipeline.py -g $GITLAB_API_TOKEN -p $PIPELINE_ID -pid 1738
