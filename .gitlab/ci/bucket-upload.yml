.bucket-upload-rule:
  rules:
    - if: '$BUCKET_UPLOAD'

.start_tunnel: &start_tunnel
  - echo "=====Start Tunnel====="
  - echo "Open an ssh tunnel to the demisto servers and wait until the tunnels are established"
  - echo "Add ssh configurations"
  - |
    if [ -z $INSTANCE_CREATED ]; then
      echo "Skipping - instance was not created"
    else
      # Modifying ssh config file
      echo "Host 10.0.*
        StrictHostKeyChecking no
        LogLevel ERROR
        ProxyJump content-build@content-build-lb.demisto.works  # disable-secrets-detection
       Host content-build-lb.demisto.works
        Port 43567
        UserKnownHostsFile /dev/null
        StrictHostKeyChecking no
        LogLevel ERROR" >> ~/.ssh/config
    fi
  - echo "Open SSH Tunnel"
  - Tests/scripts/open_ssh_tunnel.sh

.check_user_permissions_to_upload_packs: &check_user_permissions_to_upload_packs
  - echo "=====Check User Permissions to Upload Packs=====" # if bucket upload and uploading to marketplace-dist
  - |
    if [[ -n "${BUCKET_UPLOAD}" || -n "${FORCE_BUCKET_UPLOAD}" ]] && [[ "$GCS_MARKET_BUCKET" == "marketplace-dist" ]]; then
      CONTENT_LEADERS=$(curl -sS "https://api.github.com/orgs/demisto/teams/content-leaders/members" -H "Authorization: token ${GITHUB_TOKEN}")
      echo "recieved content leaders"
      LEADER_NAMES=$(echo $CONTENT_LEADERS | jq -r ".[].login")
      LEADER_NAMES=$(echo "${LEADER_NAMES}" "content-bot" )
      if [[ -z "$GITLAB_USER_NAME" ]] || [[ -z "`echo $LEADER_NAMES | grep -w "$GITLAB_USER_NAME"`" ]]; then
        echo -e "User '$GITLAB_USER_NAME' is not allowed to trigger this build, only one of:\n${LEADER_NAMES}"
        exit 1
      else
        echo "User '${GITLAB_USER_NAME}' is allowed to upload packs / force upload packs."
      fi
    fi

.install_packs_in_server:
  needs: ["create-instances"]
  stage: run-instances
  artifacts:
    expire_in: 48 hrs
    paths:
      - /builds/xsoar/content/artifacts/*
  variables:
    INSTANCE_CREATED: "true"
    SSH_TUNNEL_TIMEOUT: 10
    TIME_TO_LIVE: ""
  extends: .bucket-upload-rule
  script:
    - *start_tunnel
    - echo "=====Get Instance Variables====="
    - echo INSTANCE_ROLE="$INSTANCE_ROLE"
    - echo INSTANCE_CREATED="$INSTANCE_CREATED"
    - echo "=====Wait Until Server Ready====="
    - python3 ./Tests/scripts/wait_until_server_ready.py "$INSTANCE_ROLE"
    - echo "=====Install Packs====="
    - ./Tests/Marketplace/install_packs.sh "$INSTANCE_ROLE"
    - echo "=====Destroy Instances====="
    - |
      if [ -n "${CONTRIB_BRANCH}" ]; then
        echo "Skipping - not running in contribution instance"
      else
        python3 ./Tests/scripts/destroy_instances.py $ARTIFACTS_FOLDER $ENV_RESULTS_PATH "$INSTANCE_ROLE" "$TIME_TO_LIVE"
        export PSWD=$(jq .serverLogsZipPassword < $(cat secret_conf_path) | cut -d \" -f 2)
        zip -P $PSWD -j $ARTIFACTS_FOLDER/Logs.zip $ARTIFACTS_FOLDER/server*.log || ((($? > 0)) && echo "Didnâ€™t find any server logs, skipping this stage" && exit 0)
        rm -f $ARTIFACTS_FOLDER/server*.log
      fi

install-packs-in-server6_0:
  extends: .install_packs_in_server
  variables:
    INSTANCE_ROLE: "Server 6.0"

install-packs-in-server-master:
  extends: .install_packs_in_server
  variables:
    INSTANCE_ROLE: "Server Master"

upload-packs-to-marketplace:
  needs: ["run-validations", "run-unittests-and-lint", "install-packs-in-server6_0", "install-packs-in-server-master"]
  stage: upload-to-marketplace
  artifacts:
    expire_in: 48 hrs
    paths:
      - /builds/xsoar/content/artifacts/*
  variables:
    INSTANCE_ROLE: "Server Master"
    INSTANCE_CREATED: "true"
    SSH_TUNNEL_TIMEOUT: 10
    TIME_TO_LIVE: ""
  rules:
    - if: '$BUCKET_UPLOAD == "true"'
  script:
    - *start_tunnel
    - *check_user_permissions_to_upload_packs
    - echo "=====Upload Packs To Marketplace Storage====="
    - |
      if [[ "$CI_COMMIT_BRANCH" == "master" ]] || [[ "$GCS_MARKET_BUCKET" != "marketplace-dist" ]]; then
        EXTRACT_FOLDER=$(mktemp -d)
        PACK_ARTIFACTS=$ARTIFACTS_FOLDER/content_packs.zip
        PACKS_DEPENDENCIES=$ARTIFACTS_FOLDER/packs_dependencies.json
        CI_COMMIT_BRANCH=${CI_COMMIT_BRANCH:-unknown}
        GCS_BUILD_BUCKET="marketplace-ci-build"
        if [[ $GCS_MARKET_BUCKET != "marketplace-dist" ]]; then
          STORAGE_BASE_PATH="upload-flow/builds/$CI_COMMIT_BRANCH/$CI_PIPELINE_ID/content/packs"
        fi
        python3 ./Tests/Marketplace/copy_and_upload_packs.py -a $PACK_ARTIFACTS -e $EXTRACT_FOLDER -pb "$GCS_MARKET_BUCKET" -bb "$GCS_BUILD_BUCKET" -s $GCS_MARKET_KEY -n $CI_PIPELINE_ID -c $CI_COMMIT_BRANCH -pbp "$STORAGE_BASE_PATH"
      fi
    - echo "=====Validate Premium Packs====="
    - |
      if [[ "$CI_COMMIT_BRANCH" == "master" ]] || [[ "$GCS_MARKET_BUCKET" != "marketplace-dist" ]]; then
        ./Tests/scripts/validate_premium_packs.sh "$INSTANCE_ROLE"
      else
        echo "Skipping Premium Packs Validation"
      fi

force-pack-upload:
  stage: upload-to-marketplace
  needs: ["create-instances"]
  rules:
    - if: '$FORCE_BUCKET_UPLOAD == "true"'
  script:
    - *check_user_permissions_to_upload_packs
    - EXTRACT_FOLDER=$(mktemp -d)
    - PACK_ARTIFACTS=$ARTIFACTS_FOLDER/content_packs.zip
    - PACKS_DEPENDENCIES=$ARTIFACTS_FOLDER/packs_dependencies.json
    - CI_COMMIT_BRANCH=${CI_COMMIT_BRANCH:-unknown}
    - GCS_BUILD_BUCKET="marketplace-ci-build"
    - |
      if [[ $GCS_MARKET_BUCKET != "marketplace-dist" ]]; then
          STORAGE_BASE_PATH="upload-flow/builds/$CI_COMMIT_BRANCH/$CI_PIPELINE_ID/content/packs"
      fi
    - python3 ./Tests/Marketplace/copy_and_upload_packs.py -a $PACK_ARTIFACTS -e $EXTRACT_FOLDER -pb "$GCS_MARKET_BUCKET" -bb "$GCS_BUILD_BUCKET" -s $GCS_MARKET_KEY -n $CI_PIPELINE_ID -c $CI_COMMIT_BRANCH -p "${PACKS_TO_UPLOAD}" -pbp "${STORAGE_BASE_PATH}"
