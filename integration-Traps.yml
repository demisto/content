category: Endpoint
commonfields:
  id: Traps
  version: -1
configuration:
- defaultvalue: ""
  display: Server URL
  name: url
  required: true
  type: 0
- defaultvalue: ""
  display: Application ID
  name: application_id
  required: true
  type: 0
- defaultvalue: ""
  display: Private Key
  name: private_key
  required: true
  type: 14
- defaultvalue: ""
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ""
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
description: |-
  Endpoint protection and response stops threats on endpoints and coordinates enforcement with network and cloud security to prevent successful cyberattacks.
  The integration enables the following abilities:
    - Initiate scans.
    - Retrieve files from events.
    - Isolate endpoints.
    - Quarantine files.
    - Add and remove hashes from blacklist.
    - Getting endpoints info.
detaileddescription: "## Traps TMS\n**Endpoint protection and response stops threats
  on endpoints and coordinates enforcement with network and cloud security to prevent
  successful cyberattacks.**\n\n### Integrations credentials\n1. To create your API
  key and client ID go to the Traps TMS UI. \n2. Click the settings button and choose
  API Keys. \n3. Click the **Add** button to create new API Key. \n4. Beware to copy
  and save your API key as you will not be able to restore it. When coping the API
  Key note to include the whole text. \n5. Paste the API Key and with Client ID back
  to the Traps integration configuration in Demisto. \n"
display: Palo Alto Networks Traps
image: data:image/png;base64,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
name: Traps
script:
  commands:
  - arguments:
    - description: Endpoint ID.
      isArray: true
      name: endpoint_id
      required: true
    description: Returns details for the specified endpoint.
    name: traps-get-endpoint-by-id
    outputs:
    - contextPath: Traps.Endpoint.ID
      description: The ID of the endpoint.
      type: String
    - contextPath: Traps.Endpoint.Name
      description: The name of the endpoint.
      type: String
    - contextPath: Traps.Endpoint.Domain
      description: The domain of the endpoint.
      type: date
    - contextPath: Traps.Endpoint.Platform
      description: The OS of the endpoint.
      type: String
    - contextPath: Traps.Endpoint.Status
      description: The status of the endpoint.
      type: String
    - contextPath: Traps.Endpoint.IP
      description: The IP address of the endpoint.
      type: String
    - contextPath: Traps.Endpoint.ComputerSid
      description: The computer SID.
      type: String
    - contextPath: Traps.Endpoint.IsCompromised
      description: Whether the endpoint is compromised.
      type: String
    - contextPath: Traps.Endpoint.OsVersion
      description: The version of the OS on the endpoint.
      type: String
    - contextPath: Traps.Endpoint.OsProductType
      description: The OS type of the endpoint.
      type: String
    - contextPath: Traps.Endpoint.OsProductName
      description: The name of the OS on the endpoint.
      type: String
    - contextPath: Traps.Endpoint.Is64
      description: The bitness of the OS on the endpoint.
      type: String
    - contextPath: Traps.Endpoint.LastSeen
      description: The date/time of the last active ping.
      type: String
    - contextPath: Traps.Endpoint.LastUser
      description: The last active user on the machine.
      type: String
  - arguments:
    - description: The ID of the endpoint.
      name: endpoint_id
      required: true
    - description: The name of the file to retrieve (including path).
      name: file_name
      required: true
    - description: The ID of the event.
      name: event_id
      required: true
    description: Executes a file retrieve operation / SAM on the specified agent.
    name: traps-endpoint-files-retrieve
    outputs:
    - contextPath: Traps.FileRetrieve.EndpointID
      description: The ID of the endpoint.
      type: String
    - contextPath: Traps.FileRetrieve.OperationID
      description: The ID of the operation.
      type: String
    - contextPath: Traps.FileRetrieve.Type
      description: The type of operation.
      type: String
  - arguments:
    - description: The ID of the endpoint.
      name: endpoint_id
      required: true
    description: Performs a scan operation on the specified endpoint.
    name: traps-endpoint-scan
    outputs:
    - contextPath: Traps.Scan.EndpointID
      description: The ID of the endpoint.
      type: String
    - contextPath: Traps.Scan.OperationID
      description: The ID of the operation.
      type: String
    - contextPath: Traps.Scan.Type
      description: The type of operation.
      type: String
  - arguments:
    - description: The ID of the event to modify.
      name: event_id
      required: true
    - auto: PREDEFINED
      description: The new status for the event.
      name: status
      predefined:
      - new
      - investigating
      - closed
    - description: A comment for the event.
      name: comment
    description: Modifies the status and adds a comment to an existing event.
    name: traps-event-update
  - arguments:
    - description: A comma-separated list of IDs for events to modify.
      isArray: true
      name: event_ids
      required: true
    - auto: PREDEFINED
      description: The new status for the event.
      name: status
      predefined:
      - new
      - investigating
      - closed
      required: true
    description: Modifies the status of multiple events.
    name: traps-event-bulk-update-status
  - arguments:
    - description: The SHA256 hash to add to the blacklist.
      name: hash_id
      required: true
    description: Adds the specified file hash to the blacklist.
    name: traps-hash-blacklist
    outputs:
    - contextPath: Traps.File.BlacklistStatus
      description: The status of the file hash ("blacklisted" or "none").
      type: String
    - contextPath: Traps.File.SHA256
      description: The SHA256 hash of the file.
      type: String
  - arguments:
    - description: The SHA256 hash to remove from the blacklist.
      name: hash_id
      required: true
    description: Removes the specified file hash from the blacklist.
    name: traps-hash-blacklist-remove
    outputs:
    - contextPath: Traps.File.BlacklistStatus
      description: The status of the file hash ("blacklisted" or "none").
      type: String
    - contextPath: Traps.File.SHA256
      description: The SHA256 hash of the file.
      type: String
  - arguments:
    - description: A comma-separated list of SHA256 file hashes for which to return
        the blacklist status.
      isArray: true
      name: hash_ids
      required: true
    description: Returns the blacklist status of the specified file hashes.
    name: traps-hashes-blacklist-status
    outputs:
    - contextPath: Traps.File.BlacklistStatus
      description: The blacklist status of the file hash. Can be "blacklisted" or
        "none".
      type: String
    - contextPath: Traps.File.SHA256
      description: The SHA256 hash of the file.
      type: String
  - arguments:
    - description: The ID of the event for which to create a quarantine entry..
      name: event_id
      required: true
    description: Creates a quarantine entry for the specified event.
    name: traps-event-quarantine
    outputs:
    - contextPath: Traps.Quarantine.EventID
      description: The ID of the event.
      type: String
    - contextPath: Traps.Quarantine.OperationID
      description: The ID of the operation.
      type: String
    - contextPath: Traps.Quarantine.Type
      description: The type of operation.
      type: String
  - arguments:
    - description: The ID of the endpoint to isolate.
      name: endpoint_id
      required: true
    description: Isolates the specified endpoint.
    name: traps-endpoint-isolate
    outputs:
    - contextPath: Traps.Isolate.EndpointID
      description: The ID of the endpoint.
      type: String
    - contextPath: Traps.Isolate.OperationID
      description: The ID of the operation.
      type: String
    - contextPath: Traps.Isolate.Type
      description: The type of operation.
      type: String
  - arguments:
    - description: The ID of the operation for which to get the result of the quarantine
        operation.
      name: operation_id
      required: true
    description: Returns the result of the specified quarantine operation.
    name: traps-event-quarantine-result
    outputs:
    - contextPath: Traps.QuarantineResult.SHA256
      description: The SHA256 hash of the file.
      type: String
    - contextPath: Traps.QuarantineResult.FilePath
      description: The file path on the endpoint.
      type: String
    - contextPath: Traps.QuarantineResult.OperationID
      description: The ID of the operation.
      type: String
    - contextPath: Traps.QuarantineResult.Status
      description: The status of the quarantine operation.
      type: String
  - arguments:
    - description: The ID of the operation.
      name: operation_id
      required: true
    description: Returns the status of the specified endpoint isolate operation.
    name: traps-endpoint-isolate-status
    outputs:
    - contextPath: Traps.IsolateResult.OperationID
      description: Operation ID. Use this to retrieve status / results.
      type: String
    - contextPath: Traps.IsolateResult.Status
      description: The status of the isolation operation.
      type: String
  - arguments:
    - description: The ID of the operation.
      name: operation_id
      required: true
    description: Returns the result of the endpoint file retrieve operation.
    name: traps-endpoint-files-retrieve-result
  - arguments:
    - description: The ID of the operation.
      name: operation_id
      required: true
    description: Returns the results of an endpoint scan operation.
    name: traps-endpoint-scan-result
    outputs:
    - contextPath: Traps.ScanResult.FileScanned
      description: The number of scanned files.
      type: Number
    - contextPath: Traps.ScanResult.FilesFailed
      description: The number of files that were not scanned.
      type: Number
    - contextPath: Traps.ScanResult.MalwareFound
      description: The number of detected malware.
      type: Number
    - contextPath: Traps.ScanResult.OperationID
      description: The ID of the operation.
      type: String
    - contextPath: Traps.ScanResult.Status
      description: The status of the scan.
      type: String
  dockerimage: demisto/pyjwt3:1.0.0.1284
  runonce: false
  script: |-
    ''' IMPORTS '''




    import json
    import requests
    import copy
    import jwt

    # Disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    ''' GLOBALS/PARAMS '''
    PARAMS = demisto.params()
    # Remove trailing slash to prevent wrong URL path to service
    SERVER = PARAMS['url'][:-1] \
        if (PARAMS['url'] and PARAMS['url'].endswith('/')) else PARAMS['url']
    # Should we use SSL
    USE_SSL = not PARAMS.get('insecure', False)
    # Service base URL
    BASE_URL = SERVER + '/xapi/v1/'
    APPLICATION_ID = PARAMS.get('application_id')
    PRIVATE_KEY = PARAMS.get('private_key')
    # Headers to be sent in requests
    REQUEST_HEADERS = {
        'Content-Type': 'application/json'
    }

    OUTPUTS = {
        'get_endpoint_by_id': {
            'ID': 'guid',
            'Name': 'name',
            'Domain': 'domain',
            'Platform': 'platform',
            'Status': 'status',
            'IP': 'ip',
            'ComputerSid': 'computerSid',
            'IsCompromised': 'compromised',
            'OsVersion': 'osVersion',
            'OsProductType': 'osProductType',
            'OsProductName': 'osProductName',
            'Is64': 'is64',
            'LastSeen': 'lastSeen',
            'LastUser': 'lastUser'
        },
        'endpoint_files_retrieve': {
            'OperationID': 'operationId'
        },
        'endpoint_isolate': {
            'OperationID': 'operationId'
        },
        'endpoint_scan': {
            'OperationID': 'operationId'
        },
        'event_bulk_update_status': {
            'EventID': 'eventGuid'
        },
        'hashes_blacklist_status': {
            'SHA256': 'hash',
            'BlacklistStatus': 'status'
        },
        'event_quarantine_result': {
            'SHA256': 'fileHash',
            'FilePath': 'filePath'
        },
        'endpoint_scan_result': {
            'FileScanned': 'filesScanned',
            'FilesFailed': 'filesFailed',
            'MalwareFound': 'malwareFound'
        }
    }

    # OUTPUT_EXCEPTIONS

    ''' HELPER FUNCTIONS '''


    def create_headers(with_auth):
        headers = copy.deepcopy(REQUEST_HEADERS)
        if with_auth:
            token = generate_auth_token().decode('utf-8')
            headers['Authorization'] = f'Bearer {token}'
        return headers


    def http_request(method, url_suffix, plain_url=False, params=None, data=None, operation_err=None, parse_response=True,
                     with_auth=True):
        # A wrapper for requests lib to send our requests and handle requests and responses better
        try:
            res = requests.request(
                method,
                BASE_URL + url_suffix if not plain_url else url_suffix,
                verify=USE_SSL,
                params=params,
                data=json.dumps(data) if data else data,
                headers=create_headers(with_auth),
            )
        except requests.exceptions.ConnectionError:
            return_error(f'Error connecting to Traps server. Please check your connection and you server address')
        if parse_response:
            res = extract_and_validate_http_response(res, operation_err, plain_url)
        return res


    def extract_and_validate_http_response(resp, operation_err_message, test=False):
        try:
            resp.raise_for_status()
            return resp.json() if not test else resp.content
        except requests.exceptions.HTTPError:
            try:
                err_message = resp.json().get('message')
            except Exception:
                try:
                    err_obj = json.loads(xml2json(resp.text))
                    err_message = demisto.get(err_obj, 'Error.Message')
                except Exception:
                    err_message = f'Could not parse error'
            return_error(f'{operation_err_message}: \n{err_message}')


    def health_check():
        path = f'{SERVER}/xapi/health-check'
        server_status = http_request('GET', path, plain_url=True).decode('utf-8')
        if server_status == '"Ok"':
            return
        else:
            return_error(f'Server health-check failed. Status returned was: {server_status}')


    def generate_auth_token():
        key = PRIVATE_KEY
        data = {'appId': APPLICATION_ID}
        token = jwt.encode(data, key, algorithm='RS256')
        return token


    def parse_data_from_response(resp_obj, operation_name=None):
        new_data_obj = {}  # type: dict
        outputs_obj = OUTPUTS[operation_name]
        for key, val in outputs_obj.items():
            new_data_obj[key] = resp_obj.get(val)

        return new_data_obj


    def get_endpoint_by_id(endpoint_id):
        path = f'agents/{endpoint_id}'
        endpoint_data = http_request('GET', path, operation_err=f'Get endpoint {endpoint_id} failed')
        return parse_data_from_response(endpoint_data, 'get_endpoint_by_id'), endpoint_data


    def endpoint_files_retrieve(endpoint_id, file_name, event_id):
        path = f'agents/{endpoint_id}/files-retrieve'
        data = {
            'incidentId': event_id,
            'files': [
                {
                    "path": file_name
                }
            ]
        }
        resp = http_request('POST', path, data=data,
                            operation_err=f'Files retrieve command on endpoint {endpoint_id} failed')
        operation_obj = parse_data_from_response(resp, 'endpoint_files_retrieve')
        operation_obj.update({
            'EndpointID': endpoint_id,
            'Type': 'files-retrieve'
        })
        return operation_obj


    def endpoint_scan(endpoint_id):
        path = f'agents/{endpoint_id}/scan'
        resp = http_request('POST', path, operation_err=f'Scanning endpoint: {endpoint_id} failed')
        operation_obj = parse_data_from_response(resp, 'endpoint_scan')
        operation_obj.update({
            'EndpointID': endpoint_id,
            'Type': 'endpoint-scan'
        })
        return operation_obj


    def endpoint_scan_result(operation_id):
        status, additional_data = sam_operation(operation_id, f'Could not get scan results')
        scan_data = parse_data_from_response(additional_data.get('scanData'),
                                             'endpoint_scan_result') if additional_data else {}
        scan_data['Status'] = status
        scan_data['OperationID'] = operation_id
        return scan_data


    def update_event_status(event_ids, status):
        path = f'events/status'
        data = {
            "guids": event_ids,
            "status": status
        }
        resp = http_request('PATCH', path, data=data, operation_err=f'Update events {event_ids} status failed')
        return resp


    def update_event_comment(event_id, comment):
        path = f'events/{event_id}/comment'
        data = {
            "comment": comment
        }
        http_request('POST', path, data=data, operation_err=f'Update event: {event_id} comment failed')
        return


    def event_update_status_and_command(event_id, status, comment):
        if not status and not comment:
            return_error('Please add a status or a comment. Neither was given')
        if status:
            resp = update_event_status([event_id], status)
            if resp.get('failed'):
                return_error(f'Update status for event: {event_id} has failed')
        if comment:
            update_event_comment(event_id, comment)
        return


    def event_bulk_update_status(event_ids, status):
        ids_obj = update_event_status(event_ids, status)
        # maybe should be changed to a separate function
        results = {
            'UpdateSuccess': list(
                map(lambda id_obj: parse_data_from_response(id_obj, 'event_bulk_update_status'), ids_obj.get('succeeded'))),
            'UpdateFail': list(
                map(lambda id_obj: parse_data_from_response(id_obj, 'event_bulk_update_status'), ids_obj.get('failed'))),
            'UpdateIgnored': list(
                map(lambda id_obj: parse_data_from_response(id_obj, 'event_bulk_update_status'), ids_obj.get('ignored')))
        }
        return results


    def hash_blacklist(hash_id):
        path = f'hashes/{hash_id}/blacklist'
        result = http_request('POST', path, operation_err=f'Failed to blacklist {hash_id}')
        return result.get('status')


    def remove_hash_from_blacklist(hash_id):
        path = f'hashes/{hash_id}/blacklist-remove'
        result = http_request('POST', path, operation_err=f'Failed to remove {hash_id} from blacklist')
        return result.get('status')


    # TODO: Check if needed error message.
    def hashes_blacklist_status(hash_ids):
        path = f'hashes/blacklist-status'
        data = {
            'hashes': hash_ids
        }
        ids_obj = http_request('POST', path, data=data, operation_err='Failed to get hashes status')
        result = list(map(lambda id_obj: parse_data_from_response(id_obj, 'hashes_blacklist_status'), ids_obj))
        return result


    def event_quarantine(event_id):
        path = f'events/{event_id}/quarantine'
        resp = http_request('POST', path, operation_err=f'Quarantine event {event_id} failed')
        message_ids = resp.get('operationId').get('samMessageIds')
        operations = []
        for op_id in message_ids:
            operations.append({
                'EventID': event_id,
                'Type': 'event-quarantine',
                'OperationID': op_id
            })
        return operations


    def endpoint_isolate(endpoint_id):
        path = f'agents/{endpoint_id}/isolate'
        resp = http_request('POST', path, operation_err=f'Isolation of endpoint: {endpoint_id} failed')
        operation_obj = parse_data_from_response(resp, 'endpoint_isolate')
        operation_obj.update({
            'EndpointID': endpoint_id,
            'Type': 'endpoint-isolate'
        })
        return operation_obj


    def sam_operation(operation_id, operation_err):
        """
        This functions invokes an API call to the sam operation endpoint on Traps server to get the operation status and/or
        results.
        :param operation_id: the operation on which to get the status/results
        :param operation_err: The error to return in case of a failure (changes according to the command fired.)
        :return:
            status: the status of the operation.
            additional_data: additional data regarding the operation (like scan results)
        """
        path = f'sam/operations/{operation_id}'
        result = http_request('GET', path, operation_err=operation_err)
        if result.get('summaryData').get('incompatible'):
            return_error(f'{operation_err} incompatible operation')
        if result.get('summaryData').get('samExists'):
            return 'ignored', None
        for status_obj in result.get('statuses'):
            if status_obj.get('count') > 0:
                return status_obj.get('status'), result.get('additionalData')
        return_error(f'{operation_err}: Could not retrieve status')


    def endpoint_isolate_status(operation_id):
        status, _ = sam_operation(operation_id, f'Could not get endpoint isolate status')
        return {'Status': status, 'OperationID': operation_id}


    def event_quarantine_result(operation_id):
        status, additional_data = sam_operation(operation_id, f'Could not get event quarantine status')
        quarantine_data = parse_data_from_response(additional_data.get('quarantineData'),
                                                   'event_quarantine_result') if additional_data else {}
        quarantine_data['Status'] = status
        quarantine_data['OperationID'] = operation_id
        return quarantine_data


    def endpoint_files_retrieve_result(operation_id):
        status, additional_data = sam_operation(operation_id, f'Failed to get file retrieve results')
        if status == 'finished':
            file_info = additional_data.get('uploadData')
            file_name = file_info.get('fileName')
            url = file_info.get('downloadUrl')
            data = http_request('GET', url, plain_url=True, operation_err=f'Unable to download file.', with_auth=False)
            demisto.results(fileResult(filename=file_name, data=data))
        return {'Status': status, 'OperationID': operation_id}


    ''' COMMANDS + REQUESTS FUNCTIONS '''


    def test_module_command():
        health_check()
        res = http_request('GET', 'agents/1', parse_response=False)
        if res.status_code == 403:
            return_error(f'Error connecting to server. Check your Application ID and Private key')
        return


    def get_endpoint_by_id_command():
        args = demisto.args()
        endpoint_id = args.get('endpoint_id')
        endpoint_data, raw_data = get_endpoint_by_id(endpoint_id)
        md = tableToMarkdown(f'Endpoint {endpoint_id} data:', endpoint_data, headerTransform=pascalToSpace)
        context = {'Traps.Endpoint(val.ID == obj.ID)': createContext(endpoint_data)}
        return_outputs(md, context, raw_response=raw_data)


    def endpoint_files_retrieve_command():
        args = demisto.args()
        endpoint_id = args.get('endpoint_id')
        file_name = args.get('file_name')
        event_id = args.get('event_id')
        operation_obj = endpoint_files_retrieve(endpoint_id, file_name, event_id)
        md = tableToMarkdown(f'Files retrieve command on endpoint: {endpoint_id} received', operation_obj,
                             headerTransform=pascalToSpace)
        context = {'Traps.FileRetrieve(val.OperationID == obj.OperationID)': operation_obj}
        return_outputs(md, context)


    def endpoint_files_retrieve_result_command():
        args = demisto.args()
        operation_id = args.get('operation_id')
        status_obj = endpoint_files_retrieve_result(operation_id)
        md = f'### File retrieval status is: {status_obj.get("Status")}'
        context = {'Traps.FileRetrieveResult(val.OperationID == obj.OperationID)': status_obj}
        return_outputs(md, context)


    def endpoint_scan_command():
        args = demisto.args()
        endpoint_id = args.get('endpoint_id')
        operation_obj = endpoint_scan(endpoint_id)
        md = tableToMarkdown(f'Scan command on endpoint: {endpoint_id} received', operation_obj,
                             headerTransform=pascalToSpace)
        context = {'Traps.Scan(val.OperationID == obj.OperationID)': operation_obj}
        return_outputs(md, context)


    def endpoint_scan_result_command():
        args = demisto.args()
        operation_id = args.get('operation_id')
        status_obj = endpoint_scan_result(operation_id)
        context = {f'Traps.ScanResult(val.OperationID == obj.OperationID)': status_obj}
        md = tableToMarkdown(f'Status of scan operation: {operation_id}', status_obj, headerTransform=pascalToSpace)
        return_outputs(md, context)


    def event_update_command():
        args = demisto.args()
        event_id = args.get('event_id')
        status = args.get('status')
        comment = args.get('comment')
        event_update_status_and_command(event_id, status, comment)
        md = f'### Event: {event_id} was updated'
        md += f'\n##### New status: {status}' if status else ''
        md += f'\n##### New comment: {comment}' if comment else ''
        return_outputs(md, None)


    def event_bulk_update_status_command():
        args = demisto.args()
        event_ids = argToList(args.get('event_ids'))
        status = args.get('status')
        results = event_bulk_update_status(event_ids, status)
        md = tableToMarkdown('Successfully updated', results.get('UpdateSuccess'), headerTransform=pascalToSpace)
        md += tableToMarkdown('Failed to update', results.get('UpdateFail'), headerTransform=pascalToSpace)
        md += tableToMarkdown('Ignored', results.get('UpdateIgnored'), headerTransform=pascalToSpace)
        return_outputs(md, {})


    def event_quarantine_command():
        args = demisto.args()
        event_id = args.get('event_id')
        operations = event_quarantine(event_id)
        md = tableToMarkdown(f'Quarantine command on event: {event_id} received', operations,
                             headerTransform=pascalToSpace)
        context = {'Traps.Quarantine(val.OperationID == obj.OperationID)': operations}
        return_outputs(md, context)


    def event_quarantine_result_command():
        args = demisto.args()
        operation_id = args.get('operation_id')
        status_obj = event_quarantine_result(operation_id)
        context = {f'Traps.QuarantineResult(val.OperationID == obj.OperationID)': status_obj}
        md = tableToMarkdown(f'Status of quarantine operation: {operation_id}', status_obj, headerTransform=pascalToSpace)
        return_outputs(md, context)


    def hash_blacklist_command():
        args = demisto.args()
        hash_id = args.get('hash_id')
        status = hash_blacklist(hash_id)
        context = {}  # type: dict
        if status == 'success':
            md = f'#### Successfully blacklisted: {hash_id}'
            status_obj = {
                'SHA256': hash_id,
                'BlacklistStatus': 'blacklisted'
            }
            context = {'Traps.File(val.SHA256 == obj.SHA256)': status_obj}

        elif status == 'ignore':
            md = f'#### Hash: {hash_id} already appears in blacklist'
        else:
            md = f'#### Failed to blacklist: {hash_id}'
        return_outputs(md, context)


    def hash_blacklist_remove_command():
        args = demisto.args()
        hash_id = args.get('hash_id')
        status = remove_hash_from_blacklist(hash_id)
        context = {}  # type: dict
        if status == 'success':
            md = f'#### Successfully removed {hash_id} from blacklist'
            status_obj = {
                'SHA256': hash_id,
                'BlacklistStatus': 'none'
            }
            context = {'Traps.File(val.SHA256 == obj.SHA256)': status_obj}
        else:
            md = f'#### Failed to remove {hash_id} from blacklist:'

        return_outputs(md, context)


    def hashes_blacklist_status_command():
        args = demisto.args()
        hash_ids = args.get('hash_ids').split(',')
        ids_obj = hashes_blacklist_status(hash_ids)
        md = tableToMarkdown('Hashes status:', ids_obj, headerTransform=pascalToSpace)
        context = {'Traps.File(val.SHA256 == obj.SHA256)': ids_obj}
        return_outputs(md, context)


    def endpoint_isolate_command():
        args = demisto.args()
        endpoint_id = args.get('endpoint_id')
        operation_obj = endpoint_isolate(endpoint_id)
        md = tableToMarkdown(f'Isolate command on endpoint {endpoint_id} received', operation_obj,
                             headerTransform=pascalToSpace)
        context = {'Traps.Isolate(val.OperationID == obj.OperationID)': operation_obj}
        return_outputs(md, context)


    def endpoint_isolate_status_command():
        args = demisto.args()
        operation_id = args.get('operation_id')
        isolate_status = endpoint_isolate_status(operation_id)
        md = f'### Isolate status is: {isolate_status.get("Status")}'
        context = {f'Traps.IsolateResult(val.OperationID == obj.OperationID)': isolate_status}
        return_outputs(md, context)


    def main():
        # Remove proxy if not set to true in params
        handle_proxy()

        ''' COMMANDS MANAGER / SWITCH PANEL '''

        LOG('Command being called is %s' % (demisto.command()))

        try:
            if demisto.command() == 'test-module':
                # This is the call made when pressing the integration test button.
                test_module_command()
                demisto.results('ok')
            elif demisto.command() == 'traps-get-endpoint-by-id':
                get_endpoint_by_id_command()
            elif demisto.command() == 'traps-endpoint-files-retrieve':
                endpoint_files_retrieve_command()
            elif demisto.command() == 'traps-endpoint-files-retrieve-result':
                endpoint_files_retrieve_result_command()
            elif demisto.command() == 'traps-endpoint-scan':
                endpoint_scan_command()
            elif demisto.command() == 'traps-endpoint-scan-result':
                endpoint_scan_result_command()
            elif demisto.command() == 'traps-event-update':
                event_update_command()
            elif demisto.command() == 'traps-event-bulk-update-status':
                event_bulk_update_status_command()
            elif demisto.command() == 'traps-hash-blacklist':
                hash_blacklist_command()
            elif demisto.command() == 'traps-hash-blacklist-remove':
                hash_blacklist_remove_command()
            elif demisto.command() == 'traps-hashes-blacklist-status':
                hashes_blacklist_status_command()
            elif demisto.command() == 'traps-event-quarantine':
                event_quarantine_command()
            elif demisto.command() == 'traps-event-quarantine-result':
                event_quarantine_result_command()
            elif demisto.command() == 'traps-endpoint-isolate':
                endpoint_isolate_command()
            elif demisto.command() == 'traps-endpoint-isolate-status':
                endpoint_isolate_status_command()
        # Log exceptions
        except Exception as e:
            return_error(e)


    if __name__ in ["__builtin__", "builtins", "__main__"]:
        main()
  subtype: python3
  type: python
system: true
