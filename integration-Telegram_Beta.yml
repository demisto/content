beta: true
category: Messaging
commonfields:
  id: Telegram_Beta
  version: -1
configuration:
- defaultvalue: ""
  display: API Token
  name: token
  required: true
  type: 4
description: Telegram integration
detaileddescription: "Note: This is a beta Integration, which lets you implement and
  test pre-release software. Since the integration is beta, it might contain bugs.
  Updates to the integration during the beta phase might include non-backward compatible
  features. We appreciate your feedback on the quality and usability of the integration
  to help us identify issues, fix them, and continually improve. \n"
display: Telegram (Beta)
image: data:image/png;base64,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
name: Telegram_Beta
script:
  commands:
  - arguments:
    - description: The recipient ID
      name: userID
      required: true
    - description: The recipient username
      name: username
      required: true
    - description: The message to send
      name: message
      required: true
    description: Sends a message
    name: telegram-send-message
  - arguments: []
    description: List users
    name: telegram-list-users
  dockerimage: demisto/python3:3.7.3.221
  runonce: false
  script: |2-


    ''' IMPORTS '''

    import json
    import requests

    # Disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    ''' GLOBALS/PARAMS '''

    TOKEN = demisto.params().get('token')
    BASE_URL = 'https://api.telegram.org/bot{}/'.format(TOKEN)

    ''' HELPER FUNCTIONS '''


    def http_request(method, url_suffix, params=None, data=None):
        result = requests.request(
            method,
            BASE_URL + url_suffix,
            verify=False,
            params=params,
            data=data
        )
        if result.status_code not in {200}:
            return_error('Error in API call to Telegram Integration [%d] - %s' % (result.status_code, result.reason))

        return result.json()


    def get_updates():
        return http_request('GET', 'getUpdates')


    def get_bot():
        return http_request('GET', 'getMe')


    def item_to_incident(item):
        incident = {
            'name': 'Example Incident: ' + item.get('name'),
            'occurred': item.get('createdDate'),
            'rawJSON': json.dumps(item)
        }

        return incident


    ''' COMMANDS + REQUESTS FUNCTIONS '''


    def test_module():
        """
        Performs basic get request to get item samples
        """
        contents = get_bot()
        if contents['ok']:
            demisto.results("ok")
        else:
            error_code = contents['error_code']
            description = contents['description']
            demisto.results(f'{error_code} {description}')


    def telegram_send_message():
        """
        Gets details about a items using IDs or some other filters
        """
        user_id = demisto.args().get('userID')
        if user_id is None:
            username = demisto.args().get('username')
            if username is not None:
                user_id = str(get_user_id(username))

        if user_id is None:
            return_error(f'username {username} does not exists, please use list_user command')
        message = demisto.args().get('message')
        contents = http_request('GET', "sendMessage?chat_id=" + user_id + "&amp&text=" + message)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': contents,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Message sent', contents, 'result', removeNull=True),
            'EntryContext': contents
        })


    def get_users():
        users = {}

        contents = get_updates()
        for result in contents['result']:
            user_data = result['message']
            if 'username' in user_data['from']:
                users[user_data['from']['username']] = user_data['from']['id']
            # not all users have a username, so no choice but to save by their first_name (data can be overwritten)
            else:
                users[user_data['from']['first_name']] = user_data['from']['id']
        return users


    def telegram_list_users():
        users = get_users()

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': users,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Users', users, removeNull=True),

            'EntryContext': users
        })


    def get_user_id(username):
        users = get_users()
        if username in users:
            return users[username]
        else:
            return


    ''' COMMANDS MANAGER / SWITCH PANEL '''


    def main():
        LOG(f'command is {demisto.command()}')

        try:
            # Remove proxy if not set to true in params
            handle_proxy()

            if demisto.command() == 'test-module':
                test_module()
            elif demisto.command() == 'send-message':
                telegram_send_message()
            elif demisto.command() == 'list-users':
                telegram_list_users()

        except Exception as ex:
            return_error(str(ex))


    if __name__ == "__builtin__" or __name__ == "builtins":
        main()
  type: python
system: true
