category: Data Enrichment & Threat Intelligence
commonfields:
  id: OpenPhish
  version: -1
configuration:
- defaultvalue: "true"
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- defaultvalue: "1"
  display: Database refresh interval (hours)
  name: fetchIntervalHours
  required: false
  type: 0
- defaultvalue: "false"
  display: Trust any certificate (unsecure)
  name: insecure
  required: false
  type: 8
description: OpenPhish uses proprietary Artificial Intelligence algorithms to automatically
  identify zero-day phishing sites and provide comprehensive, actionable, real-time
  threat intelligence.
display: OpenPhish
image: data:image/png;base64,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
name: OpenPhish
script:
  commands:
  - arguments:
    - default: true
      description: URL to check
      name: url
      required: true
    description: Check URL Reputation
    name: url
    outputs:
    - contextPath: URL.Data
      description: Bad URLs found
    - contextPath: URL.Malicious.Vendor
      description: For malicious URLs, the vendor that made the decision
    - contextPath: URL.Malicious.Description
      description: For malicious URLs, the reason for the vendor to make the decision
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
    - contextPath: DBotScore.Type
      description: The type of the indicator
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
    - contextPath: DBotScore.Score
      description: The actual score
  - arguments: []
    description: Reload OpenPhish database
    name: openphish-reload
  - arguments: []
    description: Show OpenPhish database status
    name: openphish-status
  runonce: false
  script: |
    var listSource = 'https://openphish.com/feed.txt';
    var listUpdateIntervalHours = 1;

    var isNumber = function(obj) {
        return (obj == parseFloat(obj) && obj > 0);
    }

    if (isNumber(params.fetchIntervalHours)) {
        listUpdateIntervalHours = params.fetchIntervalHours;
    }

    var getList = function() {
        var res = http(listSource,{Method: 'GET'},params.insecure,params.proxy);
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }
        var list = res.Body.split("\n");
        var obj={};
        for (var i=0;i<list.length;i++) {
            var item = removeBackslash(list[i]);
            obj[item]=true;
        }
        return obj;
    };

    var reload = function() {
        var list = getList();
        var data={'list':list,'timestamp':new Date().getTime()};
        setIntegrationContext(data);
        return data;
    };

    var isReloadNeeded = function(data) {
        if (!data || !data.timestamp || !data.list) {
            return true;
        }
        now = new Date().getTime();
        if (data.timestamp < now - (1000 * 3600 * listUpdateIntervalHours)) {
            return true;
        }
        return false;
    }

    var removeBackslash=function(pUrl) {
        var url=pUrl;
        if (url[url.length - 1] == '/') {
            url = url.substr(0,url.length - 1);
        }
        return url;
    }
    var doURL = function(pUrl) {
        var data = getIntegrationContext();
        if (isReloadNeeded(data)) {
            data = reload();
        }
        var url = removeBackslash(pUrl);
        var ec = {};
        var md = "### OpenPhish Database - URL Query\n";

        if (data.list[url]) {
            var dbotScore=3;
            addMalicious(ec, outputPaths.url, {
                Data: args.url,
                Malicious: {Vendor: 'OpenPhish', Description: 'Match found in OpenPhish database'}
            });
            ec.DBotScore = {Indicator: args.url, Type: 'url', Vendor: 'OpenPhish', Score: dbotScore};

            md += "#### Found matches for URL " + args.url + "\n";
        } else {
            ec.DBotScore = {Indicator: args.url, Type: 'url', Vendor: 'OpenPhish', Score: 0};
            md += "#### No matches for URL " + args.url + "\n";
        }
        var res = {'url':args.url, 'match': true};
        return {Type: entryTypes.note, Contents: res, ContentsFormat: formats.json, HumanReadable: md, EntryContext: ec};
    }
    switch (command) {
        case 'test-module':
            if (!isNumber(params.fetchIntervalHours)) {
                throw 'OpenPhish error: Please provide a numeric value (and bigger than 0) for Database refresh interval (hours)';
            }
            var list=getList();
            if (Object.keys(list).length === 0) {
                throw 'Error - could not fetch OpenPhish database';
            }
            return 'ok';
        case 'url':
            return doURL(args.url);
        case 'openphish-reload':
            data=reload();
            var md = "OpenPhish Database reloaded\n";
            md += "Total **" + Object.keys(data.list).length + "** URLs loaded.\n";
            return({Type: entryTypes.note, Contents: {}, ContentsFormat: formats.json, HumanReadable: md});
        case 'openphish-status':
            data=getIntegrationContext();
            var md = "OpenPhish Database Status\n";
            if (!data || !data.list) {
                md += "Database not loaded.\n"
            } else {
                md += "Total **" + Object.keys(data.list).length + "** URLs loaded.\n";
                md += "Last load time **" + new Date(data.timestamp).toString() + "**\n";
            }
            return({Type: entryTypes.note, Contents: {}, ContentsFormat: formats.json, HumanReadable: md});
        default:
            throw 'OpenPhis error: unknown command';
    }
  type: javascript
system: true
