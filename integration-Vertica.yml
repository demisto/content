category: Database
commonfields:
  id: Vertica
  version: -1
configuration:
- defaultvalue: ""
  display: Host (myhost.example.com)
  name: url
  required: true
  type: 0
- defaultvalue: ""
  display: Database
  name: database (mydb)
  required: true
  type: 0
- defaultvalue: ""
  display: Username
  name: credentials
  required: true
  type: 9
- defaultvalue: "5433"
  display: Port
  name: port
  required: false
  type: 0
description: Analytic database management software
display: Vertica
image: data:image/png;base64,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
name: Vertica
script:
  commands:
  - arguments:
    - description: A SQL query to perform on the Vertica database.
      name: query
      required: true
    - defaultValue: "50"
      description: The maximum number of results to be returned from the query. (Use
        0 for all results)
      name: limit
    description: Executes a query on the Vertica database.
    name: vertica-query
    outputs:
    - contextPath: Vertica.Query
      description: The original query.
      type: string
    - contextPath: Vertica.Row
      description: The content of rows.
      type: string
  dockerimage: demisto/vertica:1.0.0.150
  runonce: false
  script: |2-


    from datetime import datetime

    # fix for: https://github.com/vertica/vertica-python/issues/296
    # (we need this for running in non-root where getpass will fail as uid doesn't map to a user name)
    import getpass


    class FixGetPass():
        def __init__(self):
            self.getpass_getuser_org = getpass.getuser

            def getuser_no_fail():
                # getuser() fails on some systems. Provide a sane default.
                user = 'vertica'
                try:
                    if self.getpass_getuser_org:
                        user = self.getpass_getuser_org()
                except (NameError, KeyError):
                    pass
                return user
            getpass.getuser = getuser_no_fail

        def __del__(self):
            if self.getpass_getuser_org and getpass:
                getpass.getuser = self.getpass_getuser_org


    _fix_getpass = FixGetPass()

    ''' IMPORTS '''

    import vertica_python  # noqa: E402

    ''' HELPER FUNCTIONS '''


    def convert_datetime_to_string(v):
        """
        Parses datetime object into string
        """
        if isinstance(v, datetime):
            return v.strftime('%Y-%m-%dT%H:%M:%S')
        return v


    def connect_db():
        USERNAME = demisto.params().get('credentials').get('identifier')
        PASSWORD = demisto.params().get('credentials').get('password')
        DATABASE = demisto.params().get('database')
        PORT = int(demisto.params().get('port', 5433))
        SERVER = demisto.params()['url'][:-1] if (demisto.params()['url'] and demisto.params()
                                                  ['url'].endswith('/')) else demisto.params()['url']
        DB_PARAMS = {
            'host': SERVER,
            'port': PORT,
            'user': USERNAME,
            'password': PASSWORD,
            'database': DATABASE,
            'connection_timeout': 5
        }
        try:
            connection = vertica_python.connect(**DB_PARAMS)
            return connection
        except vertica_python.errors.ConnectionError as err:
            return_error('Could not connect to DB, re-check DB params. Error: {}'.format(err))


    ''' COMMANDS + QUERY FUNCTIONS '''


    def test_module(cursor):
        """
        Performs basic query on default system tables
        """
        cursor.execute('SELECT * FROM system_tables ORDER BY table_schema, table_name LIMIT 2;')
        cursor.fetchall()
        if cursor.rowcount == 0:
            return_error('No results were returned from the DB.')
        demisto.results('ok')


    def query_command(cursor):
        """
        Execute a query against the DB
        """
        # Init main vars
        contents = []  # type: list
        context = {}
        title = ''
        human_readable = 'No results found'
        # Get arguments from user
        query = demisto.args().get('query')
        limit = int(demisto.args().get('limit', 50))
        # Query and get raw response (list of ordered dicts)
        rows = query_request(query, cursor)

        # Parse response into context & content entries
        if rows:
            if limit:
                rows = rows[:limit]

            for i, row in enumerate(rows):
                rows[i] = {underscoreToCamelCase(k): convert_datetime_to_string(v) for k, v in row.items()}

            contents = rows
            context['Vertica(val.Query && val.Query === obj.Query)'] = {
                'Query': query,
                'Row': rows
            }

            title = 'Vertica Query Results'
            human_readable = tableToMarkdown(title, contents, removeNull=True)

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['json'],
            'Contents': contents,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': human_readable,
            'EntryContext': context
        })


    def query_request(query, cursor):
        try:
            cursor.execute(query)
        except vertica_python.errors.MissingRelation:
            return_error('Error while executing query.')
        rows = cursor.fetchall()
        # If row count is empty or number of results is unknown (in that case we want to prevent unexpected results)
        if cursor.rowcount in {0, -1}:
            return False
        else:
            return rows


    ''' COMMANDS MANAGER / SWITCH PANEL '''


    def main():
        LOG('Command being called is %s' % (demisto.command()))
        connection = None
        try:
            connection = connect_db()
            cursor = connection.cursor('dict')
            if demisto.command() == 'test-module':
                test_module(cursor)
            elif demisto.command() == 'vertica-query':
                query_command(cursor)
        # Log exceptions
        except Exception as e:
            LOG(e)
            LOG.print_log()
            raise
        finally:
            if connection is not None:
                try:
                    connection.close()
                except Exception as ex:
                    demisto.error("Vertica failed connection.close(): {}".format(ex))


    # python2 uses __builtin__ python3 uses builtins
    if __name__ == "__builtin__" or __name__ == "builtins":
        main()
  subtype: python3
  type: python
system: true
