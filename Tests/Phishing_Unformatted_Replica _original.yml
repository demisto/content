id: 78c03e11-7947-4587-8c5e-9dd7fd69133c
version: 3
contentitemexportablefields:
  contentitemfields:
    packID: ""
    itemVersion: 3.3.8
    fromServerVersion: 6.1.0
    toServerVersion: ""
vcShouldKeepItemLegacyProdMachine: false
name: Phishing Unformatted Replica
description: "This playbook investigates and remediates a potential phishing incident.
  It engages with the user who triggered the incident while investigating the incident
  itself.\n\nNote: \n- Final remediation tasks are always decided by a human analyst.
  \n- Please do not rerun this playbook inside a phishing incident since it can produce
  an unexpected result. Create a new incident instead if needed."
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 1de7eceb-5dd5-43db-8427-7784a33e391c
    type: start
    task:
      id: 1de7eceb-5dd5-43db-8427-7784a33e391c
      version: -1
      name: ""
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "20"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": -510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 884633f5-3250-40e1-8d58-a037f0261e52
    type: regular
    task:
      id: 884633f5-3250-40e1-8d58-a037f0261e52
      version: -1
      name: Assign to analyst
      description: Assigns the incident to an analyst based on the analyst's organizational
        role.
      scriptName: AssignAnalystToIncident
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    scriptarguments:
      onCall:
        complex:
          root: inputs.OnCall
          transformers:
          - operator: toLowerCase
      roles:
        complex:
          root: inputs.Role
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -260,
          "y": 2590
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "2":
    id: "2"
    taskid: 0a3f234c-4d62-467c-84fb-511b4ccf2160
    type: regular
    task:
      id: 0a3f234c-4d62-467c-84fb-511b4ccf2160
      version: -1
      name: Manually review the incident
      description: Reviews the incident to determine if the email that the user reported
        is malicious.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "16"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -770,
          "y": 3085
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "3":
    id: "3"
    taskid: 850661f6-af22-4797-8731-2bc4439ad097
    type: regular
    task:
      id: 850661f6-af22-4797-8731-2bc4439ad097
      version: -1
      name: Close investigation
      description: Closes the investigation.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "13"
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -897.5,
          "y": 5210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "4":
    id: "4"
    taskid: f9c57393-cdb5-4965-80f3-9c4b4e70f488
    type: title
    task:
      id: f9c57393-cdb5-4965-80f3-9c4b4e70f488
      version: -1
      name: Triage
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "10"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": 330
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: b2286cdf-d1ab-4123-8231-d803e299df55
    type: regular
    task:
      id: b2286cdf-d1ab-4123-8231-d803e299df55
      version: -1
      name: Acknowledge incident was received
      description: |
        Sends an auto-response to the user reporting the incident that the incident was received and is being handled.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "25"
    scriptarguments:
      body:
        simple: "Hi ${.=function(val) { if(!(val.Account.length > 1)) return val.incident.reporteremailaddress;
          var reporter = val.incident.reporteremailaddress; var account = val.Account
          && val.Account.filter(function(acc) { return acc.DisplayName && (acc.Email
          \ === reporter || Array.isArray(acc.Email) && acc.Email.indexOf(reporter)
          > -1) }); return account && account[0] && account[0].DisplayName[0] || reporter
          || ''; }(val)},\nWe've received your email and are investigating.\nPlease
          do not touch the email until further notice.\n\nCordially, \n  Your friendly
          neighborhood security team"
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        complex:
          root: incident
          accessor: reporteremailaddress
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 940,
          "y": 660
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "6":
    id: "6"
    taskid: d0821056-9c4e-491e-8317-0f38ef480157
    type: condition
    task:
      id: d0821056-9c4e-491e-8317-0f38ef480157
      version: -1
      name: Is the email malicious?
      description: Determines if the email is malicious based on the calculated severity.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "15"
      Malicious:
      - "14"
    separatecontext: false
    conditions:
    - label: Malicious
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              simple: incident.severity
            iscontext: true
          right:
            value:
              simple: "2"
    view: |-
      {
        "position": {
          "x": -260,
          "y": 2765
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: 867ac5c9-0f60-443d-8607-038f78d0d89e
    type: regular
    task:
      id: 867ac5c9-0f60-443d-8607-038f78d0d89e
      version: -1
      name: Update the user that the reported email is safe
      description: Sends an email to the user explaining that the email they reported
        is safe.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      body:
        simple: |-
          Hi ${.=function(val) { if(!(val.Account.length > 1)) return val.incident.reporteremailaddress; var reporter = val.incident.reporteremailaddress; var account = val.Account && val.Account.filter(function(acc) { return acc.DisplayName && (acc.Email  === reporter || Array.isArray(acc.Email) && acc.Email.indexOf(reporter) > -1) }); return account && account[0] && account[0].DisplayName[0] || reporter || ''; }(val)},
          We've concluded that the email you forwarded to us is safe. In case you think the verdict is not accurate and the email is suspicious, please contact our SOC team.
          Thank you for your alertness and your participation in keeping our organization secure.

          Cordially,
            Your security team
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        complex:
          root: incident
          accessor: reporteremailaddress
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -1230,
          "y": 3640
        }
      }
    note: false
    timertriggers:
    - fieldname: detectionsla
      action: stop
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: 1eb46c47-2b20-4cec-8574-ea48b99bba0a
    type: title
    task:
      id: 1eb46c47-2b20-4cec-8574-ea48b99bba0a
      version: -1
      name: Engage with User
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "23"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 940,
          "y": 330
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: 5d443ee6-faab-478e-8909-11ce78505222
    type: playbook
    task:
      id: 5d443ee6-faab-478e-8909-11ce78505222
      version: -1
      name: Detonate File - Generic
      description: Detonate file through active integrations that support file detonation
      playbookName: Detonate File - Generic
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    separatecontext: true
    view: |-
      {
        "position": {
          "x": 200,
          "y": 630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: 432f443b-1849-437f-86d3-2a26d81a8ec0
    type: playbook
    task:
      id: 432f443b-1849-437f-86d3-2a26d81a8ec0
      version: -1
      name: Process Email - Generic v2
      description: |
        This playbook adds email details to the relevant context entities and handles original email attachments.

        The v2 playbook enables parsing email artifacts more efficiently, including:
        - Using incident fields and not incident labels.
        - Providing separate paths to "Phishing Alerts".
        - Using the new "Get Original Email - Generic v2" playbook to retrieve original emails as EML files from the following integrations:
          * EWS v2
          * Microsoft Graph Mail integration
          * Gmail
          * FireEye EX and FireEye CM
          * Proofpoint Protection Server
          * Agari Phishing Defense (EWS v2, MSGraph Mail, Gmail)
          * Mimecast
      playbookName: Process Email - Generic v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "24"
      - "9"
      - "32"
      - "44"
    scriptarguments:
      Email:
        complex:
          root: incident
          accessor: emailto
      EmailCC:
        complex:
          root: incident
          accessor: emailcc
      EmailFileToExtract:
        complex:
          root: inputs.EmailFileToExtract
      EmailFormat:
        complex:
          root: incident
          accessor: emailformat
      EmailFrom:
        complex:
          root: incident
          accessor: emailfrom
      EmailHeaders:
        complex:
          root: incident
          accessor: phishingreporteremailheaders
      EmailHtml:
        complex:
          root: incident
          accessor: emailhtml
      EmailSubject:
        complex:
          root: incident
          accessor: emailsubject
      EmailText:
        complex:
          root: incident
          accessor: emailbody
      File:
        complex:
          root: File
      GetOriginalEmail:
        complex:
          root: inputs.GetOriginalEmail
      MessageID:
        complex:
          root: incident
          accessor: emailmessageid
      Thread-Topic:
        complex:
          root: incident
          accessor: emailsubject
      UserID:
        complex:
          root: incident
          accessor: reporteremailaddress
    separatecontext: true
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": 460
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: 774c4677-2576-4c72-8325-f8c62e51b5c2
    type: title
    task:
      id: 774c4677-2576-4c72-8325-f8c62e51b5c2
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "35"
      - "36"
      - "37"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 352.5,
          "y": 3880
        }
      }
    note: false
    timertriggers:
    - fieldname: remediationsla
      action: start
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 450ee40d-8b0d-4da1-80b5-925e07280529
    type: playbook
    task:
      id: 450ee40d-8b0d-4da1-80b5-925e07280529
      version: -1
      name: Search And Delete Emails - Generic v2
      description: 'This playbook searches and deletes emails with similar attributes
        of a malicious email using one of the following integrations: * EWS * Office
        365 * Gmail * Agari Phishing Defense'
      playbookName: Search And Delete Emails - Generic v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      AttachmentName:
        complex:
          root: incident
          accessor: attachmentname
      From:
        complex:
          root: incident
          accessor: reportedemailfrom
          transformers:
          - operator: ExtractEmailTransformer
      O365AllowNotFoundExchangeLocations:
        complex:
          root: inputs.O365AllowNotFoundSearchLocations
      O365DeleteType:
        complex:
          root: inputs.O365DeleteType
      O365ExchangeLocation:
        complex:
          root: .
          transformers:
          - operator: If-Then-Else
            args:
              condition:
                value:
                  simple: lhs==rhs
              else:
                value:
                  simple: incident.reportedemailto
                iscontext: true
              equals: {}
              lhs:
                value:
                  simple: inputs.O365ExchangeLocation
                iscontext: true
              options: {}
              rhs:
                value:
                  simple: All
              then:
                value:
                  simple: All
      O365ExchangeLocationExclusion:
        complex:
          root: inputs.O365ExchangeLocationExclusion
      O365KQL:
        simple: from:${incident.reportedemailfrom} AND subject:"${incident.reportedemailsubject}"
      SearchAndDeleteIntegration:
        complex:
          root: inputs.SearchAndDeleteIntegration
      SearchThisWeek:
        simple: "true"
      Subject:
        complex:
          root: incident
          accessor: emailsubject
    separatecontext: true
    view: |-
      {
        "position": {
          "x": 352.5,
          "y": 4835
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: bbafda95-8406-4437-8a92-26e095b1a626
    type: title
    task:
      id: bbafda95-8406-4437-8a92-26e095b1a626
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -897.5,
          "y": 5395
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 7d8889d4-89e5-4138-8695-2db151c9c763
    type: title
    task:
      id: 7d8889d4-89e5-4138-8695-2db151c9c763
      version: -1
      name: Email Is Malicious
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "46"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 162.5,
          "y": 2940
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 25868d58-9adf-4d5e-8015-5c0ad8330a27
    type: title
    task:
      id: 25868d58-9adf-4d5e-8015-5c0ad8330a27
      version: -1
      name: Undetermined
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -770,
          "y": 2940
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: 58d28e52-4358-4ef0-8bf4-79c1d3672003
    type: condition
    task:
      id: 58d28e52-4358-4ef0-8bf4-79c1d3672003
      version: -1
      name: Is the email malicious?
      description: Is the email that the user reported malicious?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "No":
      - "48"
      "yes":
      - "46"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -770,
          "y": 3250
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: 4f0f4c08-731c-4115-8391-01afeaead4ad
    type: regular
    task:
      id: 4f0f4c08-731c-4115-8391-01afeaead4ad
      version: -1
      name: Manually remediate  the incident
      description: "To manually remediate a phishing incident you need to:\n1. Search
        for and delete similar emails.\n2. Inform the organization about the threat.\n3.
        Hunt relevant IOCs.\n4. Update proxies and firewalls as necessary.\n5. Block
        the malicious sender/domain in the mail-gateway. "
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -250,
          "y": 4210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: e460a149-cdf3-4eec-8a46-95d708f4e36f
    type: condition
    task:
      id: e460a149-cdf3-4eec-8a46-95d708f4e36f
      version: -1
      name: Should emails be searched and deleted?
      description: Checks whether the **SearchAndDelete** playbook input is set to
        True.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "21"
      "Yes":
      - "49"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.SearchAndDelete
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 352.5,
          "y": 4210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: df2c90b9-61d5-47c9-896a-702d46ef2582
    type: condition
    task:
      id: df2c90b9-61d5-47c9-896a-702d46ef2582
      version: -1
      name: Should indicators be blocked automatically?
      description: Checks whether the **BlockIndicators** playbook input is set to
        True.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "21"
      "yes":
      - "33"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: inputs.BlockIndicators
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: inputs.BlockIndicators
                      iscontext: true
                    right:
                      value:
                        simple: "True"
                    ignorecase: true
            iscontext: true
    view: |-
      {
        "position": {
          "x": 950,
          "y": 4210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: 4f2c1d8a-fc65-40ed-85d4-b75f78f2fd43
    type: title
    task:
      id: 4f2c1d8a-fc65-40ed-85d4-b75f78f2fd43
      version: -1
      name: Start Detection Timer
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "55"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": -340
        }
      }
    note: false
    timertriggers:
    - fieldname: detectionsla
      action: start
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: 52508e42-b151-46e9-8a46-9d354b78c2a2
    type: title
    task:
      id: 52508e42-b151-46e9-8a46-9d354b78c2a2
      version: -1
      name: Stop Remediation Timer
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "3"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 670,
          "y": 5070
        }
      }
    note: false
    timertriggers:
    - fieldname: remediationsla
      action: stop
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: b2c23471-ae36-4fe7-8f18-3ec9501d7b6e
    type: title
    task:
      id: b2c23471-ae36-4fe7-8f18-3ec9501d7b6e
      version: -1
      name: Indicator Enrichment
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -260,
          "y": 1180
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: 405c458f-9cb8-4aaa-85d5-ef2b844fbd07
    type: playbook
    task:
      id: 405c458f-9cb8-4aaa-85d5-ef2b844fbd07
      version: -1
      name: Email Address Enrichment - Generic v2.1
      description: |-
        Enrich email addresses.
        - Get information from Active Directory for internal addresses
        - Get the domain-squatting reputation for external addresses
      playbookName: Email Address Enrichment - Generic v2.1
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      Email:
        complex:
          root: incident
          accessor: reporteremailaddress
          transformers:
          - operator: uniq
      InternalDomains:
        complex:
          root: inputs.InternalDomains
          transformers:
          - operator: uniq
    separatecontext: true
    view: |-
      {
        "position": {
          "x": 940,
          "y": 480
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: cdc7ba32-41a0-416d-8a1b-74569f8f3b63
    type: playbook
    task:
      id: cdc7ba32-41a0-416d-8a1b-74569f8f3b63
      version: -1
      name: Extract Indicators From File - Generic v2
      description: |-
        This playbook extracts indicators from a file.
        Supported file types:
        - CSV
        - PDF
        - TXT
        - HTM, HTML
        - DOC, DOCX
        - PPT
        - PPTX
        - RTF
        - XLS
        - XLSX
        - XML
        - XLSM
        - DOCM
        - PPTM
        - DOTM
        - XLSB
        - DOT
        - PPSM
      playbookName: Extract Indicators From File - Generic v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "54"
      - "56"
    separatecontext: true
    view: |-
      {
        "position": {
          "x": -720,
          "y": 630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "25":
    id: "25"
    taskid: 17caaef5-7006-4a4f-8f41-a333db3246f9
    type: title
    task:
      id: 17caaef5-7006-4a4f-8f41-a333db3246f9
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "38"
      - "27"
      - "40"
      - "51"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -260,
          "y": 1510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "26":
    id: "26"
    taskid: a96316ea-d6b5-42ee-82ba-2bacb0aa9d6f
    type: condition
    task:
      id: a96316ea-d6b5-42ee-82ba-2bacb0aa9d6f
      version: -1
      name: Should the email be authenticated?
      description: Checks whether the email should be authenticated using DKIM, SPF,
        and DMARC. This checks if "AuthenticateEmail" output is set to "True" and
        if there are headers from an email to authenticate.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "30"
      "yes":
      - "28"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.AuthenticateEmail
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
      - - operator: isExists
          left:
            value:
              complex:
                root: Email
                accessor: HeadersMap
            iscontext: true
    view: |-
      {
        "position": {
          "x": 390,
          "y": 1795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "27":
    id: "27"
    taskid: 19191289-da20-4fd4-8b9d-67b95069c4b2
    type: title
    task:
      id: 19191289-da20-4fd4-8b9d-67b95069c4b2
      version: -1
      name: Email Authenticity Check
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "26"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 390,
          "y": 1650
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: 4d388082-77be-4f91-8cba-51dba3d033b2
    type: regular
    task:
      id: 4d388082-77be-4f91-8cba-51dba3d033b2
      version: -1
      name: Authenticate email
      description: Checks the authenticity of an email based on the email's SPF, DMARC,
        and DKIM.
      scriptName: CheckEmailAuthenticity
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      headers:
        complex:
          root: Email
          accessor: Headers
          transformers:
          - operator: uniq
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 392.5,
          "y": 1980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "29":
    id: "29"
    taskid: 980313a8-c897-40d8-8b36-2255dbcc18a1
    type: regular
    task:
      id: 980313a8-c897-40d8-8b36-2255dbcc18a1
      version: -1
      name: Save authenticity check result to incident field
      description: Saves the email authenticity verdict in an incident field.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "30"
    scriptarguments:
      emailauthenticitycheck:
        complex:
          root: Email
          accessor: AuthenticityCheck
          transformers:
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Undetermined
              toReplace:
                value:
                  simple: undetermined
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Pass
              toReplace:
                value:
                  simple: pass
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Fail
              toReplace:
                value:
                  simple: fail
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Suspicious
              toReplace:
                value:
                  simple: suspicious
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 392.5,
          "y": 2175
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "30":
    id: "30"
    taskid: 30af1271-7dac-4ae0-8311-b9e5eb9666c0
    type: playbook
    task:
      id: 30af1271-7dac-4ae0-8311-b9e5eb9666c0
      version: -1
      name: Calculate Severity - Generic v2
      description: |-
        Calculate and assign the incident severity based on the highest returned severity level from the following calculations:

        - DBotScores of indicators
        - Critical assets
        - Email authenticity
        - Current incident severity
        - Microsoft Headers
      playbookName: Calculate Severity - Generic v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "1"
    separatecontext: true
    view: |-
      {
        "position": {
          "x": -260,
          "y": 2380
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: 31b1399b-9c64-409b-8bfc-81de002f05ae
    type: regular
    task:
      id: 31b1399b-9c64-409b-8bfc-81de002f05ae
      version: -1
      name: Save reporter email address in field
      description: Saves the email address of the email reporter in an incident field.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "8"
      - "4"
    scriptarguments:
      reporteremailaddress:
        complex:
          root: incident
          accessor: emailfrom
          transformers:
          - operator: ExtractEmailTransformer
    reputationcalc: 1
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -260,
          "y": 110
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "32":
    id: "32"
    taskid: 4cc932c0-65a1-41d1-82bf-65b2a1ae0d88
    type: title
    task:
      id: 4cc932c0-65a1-41d1-82bf-65b2a1ae0d88
      version: -1
      name: Machine Learning
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "54"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -1522.5,
          "y": 630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 44139397-d869-4d6d-8461-17586ae1412a
    type: playbook
    task:
      id: 44139397-d869-4d6d-8461-17586ae1412a
      version: -1
      name: Block Indicators - Generic v2
      description: |+
        This playbook blocks malicious Indicators using all integrations that are enabled, using the following sub-playbooks:

        - Block URL - Generic
        - Block Account - Generic
        - Block IP - Generic v2
        - Block File - Generic v2
        - Block Email - Generic
        - Block Domain - Generic

      playbookName: Block Indicators - Generic v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      AutoCommit:
        simple: "No"
      CustomBlockRule:
        simple: "True"
      CustomURLCategory:
        simple: Demisto Remediation - Malicious URLs
      EmailToBlock:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: email
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: uniq
      IP:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: ip
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: uniq
      MD5:
        complex:
          root: DBotScore
          filters:
          - - operator: stringHasLength
              left:
                value:
                  simple: DBotScore.Indicator
                iscontext: true
              right:
                value:
                  simple: "32"
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: file
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: hash
              ignorecase: true
          accessor: Indicator
          transformers:
          - operator: uniq
      SHA256:
        complex:
          root: DBotScore
          filters:
          - - operator: stringHasLength
              left:
                value:
                  simple: DBotScore.Indicator
                iscontext: true
              right:
                value:
                  simple: "64"
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: file
              ignorecase: true
            - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: hash
              ignorecase: true
          accessor: Indicator
          transformers:
          - operator: uniq
      URL:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: url
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: uniq
      URLListName:
        simple: Demisto Remediation - URL EDL
      Username:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Type
                iscontext: true
              right:
                value:
                  simple: username
              ignorecase: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "3"
          accessor: Indicator
          transformers:
          - operator: uniq
    separatecontext: true
    view: |-
      {
        "position": {
          "x": 950,
          "y": 4795
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "34":
    id: "34"
    taskid: de86fcea-10ac-4cce-8456-9a85777ddf4c
    type: playbook
    task:
      id: de86fcea-10ac-4cce-8456-9a85777ddf4c
      version: -1
      name: Entity Enrichment - Phishing v2
      description: Enrich entities using one or more integrations
      playbookName: Entity Enrichment - Phishing v2
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "25"
    scriptarguments:
      Domain:
        complex:
          root: Domain
          accessor: Name
          transformers:
          - operator: uniq
      Email:
        complex:
          root: Account.Email.Address
          filters:
          - - operator: isNotEqualString
              left:
                value:
                  simple: Account.Email.Address
                iscontext: true
              right:
                value:
                  simple: incident.reporteremailaddress
                iscontext: true
          transformers:
          - operator: uniq
      Hostname:
        complex:
          root: Endpoint
          accessor: Hostname
          transformers:
          - operator: uniq
      IP:
        complex:
          root: IP
          accessor: Address
          transformers:
          - operator: uniq
      InternalDomains:
        complex:
          root: inputs.InternalDomains
      InternalRange:
        complex:
          root: inputs.InternalRange
      MD5:
        complex:
          root: File
          accessor: MD5
          transformers:
          - operator: uniq
      ResolveIP:
        simple: "False"
      SHA1:
        complex:
          root: File
          accessor: SHA1
          transformers:
          - operator: uniq
      SHA256:
        complex:
          root: File
          accessor: SHA256
          transformers:
          - operator: uniq
      URL:
        complex:
          root: URL
          accessor: Data
          transformers:
          - operator: uniq
      Username:
        complex:
          root: Account
          accessor: Username
          transformers:
          - operator: uniq
    separatecontext: true
    view: |-
      {
        "position": {
          "x": -260,
          "y": 1320
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "35":
    id: "35"
    taskid: 0abd2288-a66a-4b2e-8e20-d6becde75c18
    type: title
    task:
      id: 0abd2288-a66a-4b2e-8e20-d6becde75c18
      version: -1
      name: Block Indicators
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "19"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 950,
          "y": 4070
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "36":
    id: "36"
    taskid: 03e908d6-c0bf-449a-83be-7be5bf8c78a5
    type: title
    task:
      id: 03e908d6-c0bf-449a-83be-7be5bf8c78a5
      version: -1
      name: Search & Delete Email
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "18"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 352.5,
          "y": 4070
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "37":
    id: "37"
    taskid: 8a0f7f05-f123-4a9d-8dcf-f11b8d3ee322
    type: title
    task:
      id: 8a0f7f05-f123-4a9d-8dcf-f11b8d3ee322
      version: -1
      name: Manual Remediation
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -250,
          "y": 4070
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "38":
    id: "38"
    taskid: 20e074c1-4e0f-46ed-8766-b5c7ff7c06f8
    type: title
    task:
      id: 20e074c1-4e0f-46ed-8766-b5c7ff7c06f8
      version: -1
      name: Email Campaign Search
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "39"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -260,
          "y": 1650
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 8a23b893-821d-402b-8c00-51c5617bf0b9
    type: playbook
    task:
      id: 8a23b893-821d-402b-8c00-51c5617bf0b9
      version: -1
      name: Detect & Manage Phishing Campaigns
      description: |-
        This playbook is used to find, create and manage phishing campaigns. When a number of similar phishing incidents exist in the system, the playbook can be used to do the following:
        1. Find and link related incidents to the same phishing attack (a phishing campaign).
        2. Search for an existing Phishing Campaign incident, or create a new incident for the linked Phishing incidents.
        3. Link all detected phishing incidents to the Phishing Campaign incident that was found or that was created previously.
        4. Update the Phishing Campaign incident with the latest data about the campaign, and update all related phishing incidents to indicate that they are part of the campaign.
      playbookName: Detect & Manage Phishing Campaigns
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "30"
    scriptarguments:
      AutomaticallyLinkIncidents:
        simple: "True"
    separatecontext: true
    view: |-
      {
        "position": {
          "x": -260,
          "y": 1785
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "40":
    id: "40"
    taskid: eb60d401-8f44-4860-823e-4f86b2989cc8
    type: title
    task:
      id: eb60d401-8f44-4860-823e-4f86b2989cc8
      version: -1
      name: Microsoft's Headers Check
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "41"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -907.5,
          "y": 1650
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: 777aed66-f80a-462f-895d-605c4aecde51
    type: condition
    task:
      id: 777aed66-f80a-462f-895d-605c4aecde51
      version: -1
      name: Check Microsoft's Headers?
      description: Whether to check Microsoft's proprietary email headers.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "30"
      "yes":
      - "42"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.CheckMicrosoftHeaders
            iscontext: true
          right:
            value:
              simple: "True"
    view: |-
      {
        "position": {
          "x": -907.5,
          "y": 1785
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "42":
    id: "42"
    taskid: 217da237-a671-449b-8f2c-a458d3957faf
    type: playbook
    task:
      id: 217da237-a671-449b-8f2c-a458d3957faf
      version: -1
      name: Process Microsoft's Anti-Spam Headers
      description: "This playbook stores the SCL, BCL, and PCL scores if they exist
        to the associated incident fields (Phishing SCL Score, Phishing PCL Score,
        and Phishing BCL Score).\nIt also does the following:\n1) Sets the email classification
        to \"spam\" if the SCL score is equal to or greater than 5.\n2) Sets the incident
        severity according to the playbook inputs (default is: PCL/BCL - Medium, SCL
        - Low). The severity of the incident is set only when one (or more) of the
        following occurs:\n  - PCL (Phishing Confidence Level) For a score between
        and including 4-8: The message content is likely to be phishing.\n  - [BCL](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/bulk-complaint-level-values?view=o365-worldwide)
        (Bulk Complaint Level) For a score between and including 4-7: The message
        is from a bulk sender that generates a mixed number of complaints. \n    For
        a score between and including 8-9: The message is from a bulk sender that
        generates a high number of complaints.\n  - [SCL](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/spam-confidence-levels?view=o365-worldwide)
        (Spam Confidence Level) For a score between and including 5-6: Spam filtering
        marks the message as spam. \n    For a score of 9: Spam filtering marks the
        message as high confidence spam. See [anti-spam stamps](https://docs.microsoft.com/en-us/exchange/antispam-and-antimalware/antispam-protection/antispam-stamps?view=exchserver-2019)."
      playbookName: Process Microsoft's Anti-Spam Headers
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "30"
    separatecontext: true
    view: |-
      {
        "position": {
          "x": -907.5,
          "y": 1980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "43":
    id: "43"
    taskid: 544deb74-00ea-4c89-850f-94344a09dd5a
    type: playbook
    task:
      id: 544deb74-00ea-4c89-850f-94344a09dd5a
      version: -1
      name: Detonate URL - Generic
      description: Detonate URL through active integrations that support URL detonation.
      playbookName: Detonate URL - Generic
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      URL:
        complex:
          root: URL
          transformers:
          - operator: uniq
    separatecontext: true
    view: |-
      {
        "position": {
          "x": -260,
          "y": 880
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "44":
    id: "44"
    taskid: 3caada20-daa5-4242-88ce-57e98c4558dd
    type: condition
    task:
      id: 3caada20-daa5-4242-88ce-57e98c4558dd
      version: -1
      name: Detonate URL?
      description: Whether to detonate URLs in supported sandboxes.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "22"
      "yes":
      - "43"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.DetonateURL
            iscontext: true
          right:
            value:
              simple: "True"
          ignorecase: true
    view: |-
      {
        "position": {
          "x": -260,
          "y": 630
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: dcfaeac1-cd61-423c-8ba8-de2b8c8d57b1
    type: regular
    task:
      id: dcfaeac1-cd61-423c-8ba8-de2b8c8d57b1
      version: -1
      name: Update the user that the reported email is malicious
      description: Sends an email to the user explaining that the email they reported
        is malicious.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      body:
        simple: |-
          Hi ${.=function(val) { if(!(val.Account.length > 1)) return val.incident.reporteremailaddress; var reporter = val.incident.reporteremailaddress; var account = val.Account && val.Account.filter(function(acc) { return acc.DisplayName && (acc.Email  === reporter || Array.isArray(acc.Email) && acc.Email.indexOf(reporter) > -1) }); return account && account[0] && account[0].DisplayName[0] || reporter || ''; }(val)},
          We've concluded that the email you forwarded to us is malicious. No further action is required on your part. Good job on detecting and forwarding it to us!

          All the best,
            Your security team
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        complex:
          root: incident
          accessor: reporteremailaddress
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 110,
          "y": 3650
        }
      }
    note: false
    timertriggers:
    - fieldname: detectionsla
      action: stop
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: 5b8f9513-1ab4-4a9a-8cc9-eadf6ba73ff8
    type: condition
    task:
      id: 5b8f9513-1ab4-4a9a-8cc9-eadf6ba73ff8
      version: -1
      name: Can the user be informed about the verdict?
      description: Checks whether the user can be informed about the verdict of the
        incident.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "11"
      yes - phishing:
      - "45"
      yes - phishing campaign:
      - "47"
    separatecontext: false
    conditions:
    - label: yes - phishing campaign
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: PartOfCampaign
            iscontext: true
          right:
            value: {}
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: reporteremailaddress
            iscontext: true
    - label: yes - phishing
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: reporteremailaddress
            iscontext: true
    view: |-
      {
        "position": {
          "x": 352.5,
          "y": 3440
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: 08bcfe51-379c-4bad-813d-25a05d62f47f
    type: regular
    task:
      id: 08bcfe51-379c-4bad-813d-25a05d62f47f
      version: -1
      name: Update the user that the email is a malicious campaign
      description: Sends an email to the user explaining that the email they reported
        is malicious.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      body:
        simple: |-
          Hi ${.=function(val) { if(!(val.Account.length > 1)) return val.incident.reporteremailaddress; var reporter = val.incident.reporteremailaddress; var account = val.Account && val.Account.filter(function(acc) { return acc.DisplayName && (acc.Email  === reporter || Array.isArray(acc.Email) && acc.Email.indexOf(reporter) > -1) }); return account && account[0] && account[0].DisplayName[0] || reporter || ''; }(val)},
          We've concluded that the email you forwarded to us is part of a bigger phishing campaign that targeted our company. No further action is required on your part. Good job on detecting and forwarding it to us!

          All the best,
            Your security team
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        complex:
          root: incident
          accessor: reporteremailaddress
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 580,
          "y": 3650
        }
      }
    note: false
    timertriggers:
    - fieldname: detectionsla
      action: stop
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: 4e8274fd-3ba4-4210-81d1-5326c2e1f409
    type: condition
    task:
      id: 4e8274fd-3ba4-4210-81d1-5326c2e1f409
      version: -1
      name: Can the user be informed about the verdict?
      description: Checks whether the user can be informed about the verdict of the
        incident.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "3"
      "Yes":
      - "7"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: reporteremailaddress
            iscontext: true
          right:
            value: {}
    view: |-
      {
        "position": {
          "x": -897.5,
          "y": 3440
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "49":
    id: "49"
    taskid: a9b2f695-351b-4849-8065-6ebfecee066d
    type: condition
    task:
      id: a9b2f695-351b-4849-8065-6ebfecee066d
      version: -1
      name: Check if original email was retrieved
      description: Checks if the original email was retrieved using the email listener
        integration.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "21"
      "yes":
      - "12"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: reportedemailfrom
            iscontext: true
    view: |-
      {
        "position": {
          "x": 352.5,
          "y": 4510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "50":
    id: "50"
    taskid: 7d3fed4e-0cc7-4137-82b1-2cc0560f8fba
    type: condition
    task:
      id: 7d3fed4e-0cc7-4137-82b1-2cc0560f8fba
      version: -1
      name: Did domain-squatting occur?
      description: Checks whether the attacker tried to squat another domain involved
        in this incident.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "30"
      "yes":
      - "52"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Vendor
                      iscontext: true
                    right:
                      value:
                        simple: DomainSquatting
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: incident.reportedemailfrom
                      iscontext: true
                - - operator: greaterThanOrEqual
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "2"
            iscontext: true
    view: |-
      {
        "position": {
          "x": 960,
          "y": 1785
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "51":
    id: "51"
    taskid: 2b3e5e0c-0997-4550-86c6-ab6ac1acda55
    type: title
    task:
      id: 2b3e5e0c-0997-4550-86c6-ab6ac1acda55
      version: -1
      name: Domain-squatting
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "50"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 960,
          "y": 1650
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "52":
    id: "52"
    taskid: a4f7a6fe-a830-4f97-893c-5eb83765cc57
    type: regular
    task:
      id: a4f7a6fe-a830-4f97-893c-5eb83765cc57
      version: -1
      name: Save domain-squatting result to incident field
      description: commands.local.cmd.set.incident
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "30"
    scriptarguments:
      domainsquattingresult:
        complex:
          root: DBotScore
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Vendor
                iscontext: true
              right:
                value:
                  simple: DomainSquatting
          - - operator: isEqualString
              left:
                value:
                  simple: DBotScore.Indicator
                iscontext: true
              right:
                value:
                  simple: incident.reportedemailfrom
                iscontext: true
          - - operator: greaterThanOrEqual
              left:
                value:
                  simple: DBotScore.Score
                iscontext: true
              right:
                value:
                  simple: "2"
          accessor: Indicator
          transformers:
          - operator: uniq
          - operator: split
            args:
              delimiter:
                value:
                  simple: '@'
          - operator: LastArrayElement
          - operator: concat
            args:
              prefix:
                value:
                  simple: The attacker used the domain **
              suffix: {}
          - operator: concat
            args:
              prefix: {}
              suffix:
                value:
                  simple: '** which looks like another domain involved in this incident.'
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 950,
          "y": 1980
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "53":
    id: "53"
    taskid: 2ee6e5df-f046-4b41-8e9d-53871f77ccd7
    type: title
    task:
      id: 2ee6e5df-f046-4b41-8e9d-53871f77ccd7
      version: -1
      name: Reporter Address specified
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "4"
      - "8"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 300,
          "y": 110
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "54":
    id: "54"
    taskid: 9313fe62-ac56-4f32-8ba6-18eeb35c5c6e
    type: playbook
    task:
      id: 9313fe62-ac56-4f32-8ba6-18eeb35c5c6e
      version: -1
      name: Phishing - Machine Learning Analysis
      description: Runs various machine-learning based checks on phishing emails and
        URLs, in an attempt to predict whether they are phishing or benign.
      playbookName: Phishing - Machine Learning Analysis
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "30"
    scriptarguments:
      DBotPredictURLPhishingURLsNumber:
        complex:
          root: inputs.DBotPredictURLPhishingURLsNumber
      EmailHTML:
        complex:
          root: Email
          accessor: HTML
      EmailSubject:
        complex:
          root: Email
          accessor: Subject
      EmailText:
        complex:
          root: Email
          accessor: Text
      ExtractedURLsFromFiles:
        complex:
          root: ExtractedURLsFromFiles
          transformers:
          - operator: uniq
      PhishingModelName:
        complex:
          root: inputs.PhishingModelName
    separatecontext: true
    view: |-
      {
        "position": {
          "x": -1522.5,
          "y": 825
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "55":
    id: "55"
    taskid: b52830fd-cc82-452f-8b01-cdd058c2a323
    type: condition
    task:
      id: b52830fd-cc82-452f-8b01-cdd058c2a323
      version: -1
      name: Was the reporter of the phishing email specified?
      description: Checks whether the email address of the phishing email reporter
        was specified on incident creation, so that an acknowledgement email can be
        sent to them.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "No":
      - "31"
      No - Manual:
      - "4"
      "Yes":
      - "53"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: incident
                accessor: reporteremailaddress
            iscontext: true
          right:
            value: {}
    - label: No - Manual
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: incident.sourceBrand
            iscontext: true
          right:
            value:
              simple: Manual
    - label: "No"
      condition:
      - - operator: isNotEqualString
          left:
            value:
              simple: incident.sourceBrand
            iscontext: true
          right:
            value:
              simple: Manual
    view: |-
      {
        "position": {
          "x": -497.5,
          "y": -180
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "56":
    id: "56"
    taskid: dfd04ee6-2ce8-410b-828a-301efab195a2
    type: condition
    task:
      id: dfd04ee6-2ce8-410b-828a-301efab195a2
      version: -1
      name: Was a file with macro found?
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "22"
      "yes":
      - "57"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: Oletools.Olevba.ole_command_result
                accessor: macro_src_code
            iscontext: true
    view: |-
      {
        "position": {
          "x": -720,
          "y": 820
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "57":
    id: "57"
    taskid: 7bfb5860-e377-4352-8006-79f4dd298c14
    type: regular
    task:
      id: 7bfb5860-e377-4352-8006-79f4dd298c14
      version: -1
      name: Set Macro Source Code field
      description: commands.local.cmd.set.incident
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      macrosourcecode:
        complex:
          root: Oletools.Olevba.ole_command_result
          accessor: macro_src_code
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -720,
          "y": 1005
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {},
    "paper": {
      "dimensions": {
        "height": 5970,
        "width": 2862.5,
        "x": -1522.5,
        "y": -510
      }
    }
  }
inputs:
- key: Role
  value:
    simple: Administrator
  required: true
  description: The default role to assign the incident to.
  playbookInputQuery: null
- key: SearchAndDelete
  value:
    simple: "False"
  required: false
  description: |-
    Enables the Search and Delete capability.
    For a malicious email, the "Search and Delete" sub-playbook looks for other instances of the email and deletes them pending analyst approval.
  playbookInputQuery: null
- key: BlockIndicators
  value:
    simple: "False"
  required: false
  description: |-
    Enables the Block Indicators capability.
    For a malicious email, the "Block Indicators" sub-playbook blocks all malicious indicators in the relevant integrations.
  playbookInputQuery: null
- key: AuthenticateEmail
  value:
    simple: "True"
  required: false
  description: Determines whether the authenticity of the email should be verified
    using SPF, DKIM, and DMARC.
  playbookInputQuery: null
- key: OnCall
  value:
    simple: "False"
  required: false
  description: Set to True to assign only the user that is currently on shift.
  playbookInputQuery: null
- key: SearchAndDeleteIntegration
  value:
    simple: EWS
  required: false
  description: |-
    Determines which product and playbook is used to search and delete the phishing email from user inboxes.
      - Set this to "O365" to use the "O365 - Security And Compliance - Search And Delete" playbook.
      - Set this to "EWS" to use the "Search And Delete Emails - EWS" playbook.
      - Set this to "Gmail" to use the "Search And Delete - Gmail" playbook.
  playbookInputQuery: null
- key: O365DeleteType
  value:
    simple: Soft
  required: false
  description: |-
    Sets the method to delete emails in the "O365 - Security And Compliance - Search And Delete" playbook. Can be "Soft" (recoverable), or "Hard" (unrecoverable). Leave empty to decide manually for each email incident.
    This is only applicable if the SearchAndDeleteIntegration input is set to "O365".
  playbookInputQuery: null
- key: O365ExchangeLocation
  value: {}
  required: false
  description: The exchange location. Determines from where to search and delete emails
    using O365 playbooks. Use the value "All" to search all mailboxes. If no input
    provided, it will search and delete the email only from the recipient's mailboxes.
    Note - Searching all mailboxes may take a significant amount of time. This input
    is used only when searching and deleting emails in O365 and only applies if the
    SearchAndDeleteIntegration input is set to O365.
  playbookInputQuery: null
- key: O365AllowNotFoundSearchLocations
  value:
    simple: "False"
  required: false
  description: Used only when searching and deleting emails in O365. Determines whether
    to include mailboxes other than regular user mailboxes in the compliance search.
  playbookInputQuery: null
- key: O365ExchangeLocationExclusion
  value: {}
  required: false
  description: Used only when searching and deleting emails in O365. A comma-separated
    list of mailboxes/distribution groups to exclude when you use the value "All"
    for the O365ExchangeLocation input.
  playbookInputQuery: null
- key: CheckMicrosoftHeaders
  value:
    simple: "True"
  required: false
  description: Whether to check Microsoft headers for BCL/PCL/SCL scores and set the
    "Severity" and "Email Classification" accordingly.
  playbookInputQuery: null
- key: InternalDomains
  value: {}
  required: false
  description: A CSV list of internal domains. The list is used to determine whether
    an email address is internal or external.
  playbookInputQuery: null
- key: DetonateURL
  value:
    simple: "False"
  required: false
  description: Determines whether to use the "URL Detonation" playbook. Detonating
    a URL may take a few minutes.
  playbookInputQuery: null
- key: InternalRange
  value: {}
  required: false
  description: |-
    This input is used in the "Entity Enrichment - Phishing v2" playbook.
    A list of internal IP ranges to check IP addresses against. The list should be provided in CIDR notation, separated by commas. An example of a list of ranges is: "172.16.0.0/12,10.0.0.0/8,192.168.0.0/16" (without quotes). If a list is not provided, uses the default list provided in the IsIPInRanges script (the known IPv4 private address ranges).
  playbookInputQuery: null
- key: PhishingModelName
  value: {}
  required: false
  description: Optional - the name of a pre-trained phishing model to predict phishing
    type using machine learning.
  playbookInputQuery: null
- key: GetOriginalEmail
  value:
    simple: "False"
  required: false
  description: |-
    For forwarded emails. When "True", retrieves the original email in the thread.

    You must have the necessary permissions in your email service to execute global search.

    - For EWS: eDiscovery
    - For Gmail: Google Apps Domain-Wide Delegation of Authority
    - For MSGraph: As described in these links
    https://docs.microsoft.com/en-us/graph/api/message-get
    https://docs.microsoft.com/en-us/graph/api/user-list-messages
  playbookInputQuery: null
- key: DBotPredictURLPhishingURLsNumber
  value:
    simple: "3"
  required: false
  description: |-
    The number of URLs to extract from the email HTML and analyze in the "DBotPredictURLPhishing" automation.
    This automation runs several checks to determine the score of the URLs found in the email, sets a verdict for URLs found as "Suspicious" or "Malicious", and adds these URLs as indicators. Based on the verdict, the incident severity is set (Medium for "Suspicious" and High for "Malicious").
    Note:
    - You need to install the "Phishing URL" pack to use this automation.
    - False/True positives are possible.
    - This automation may take a few minutes to run.
    - To increase result accuracy, it is recommended to install and enable the "Whois" pack (optional).
  playbookInputQuery: null
- key: EmailFileToExtract
  value:
    simple: Inner file
  required: false
  description: |-
    Reported emails and emails retrieved during playbook execution can contain multiple nested email files. For example, an EML nested inside another EML file.
    If multiple level files are detected, this field determines which file represents the phishing email.

    For example:
    User1 receives an email from Attacker. User1 attaches the email as an EML file and sends the email to User2.
    User2 also attaches that email as a file, and reports it as phishing. In this case, the phishing email would be the "inner file" (as opposed to "outer file").

    Possible values are: Inner file, Outer file, All files.
    Inner file: The file at the deepest level is parsed. If there is only one file, that file is parsed.
    Outer file: The file at the first level is parsed.
    All files: All files are parsed. Do not use this option in the phishing playbook, as there should only be one phishing email per playbook run.
  playbookInputQuery: null
outputs: []
sourceplaybookid: Phishing Unformatted Replica
