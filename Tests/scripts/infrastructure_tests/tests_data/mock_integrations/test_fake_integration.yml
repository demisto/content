commonfields:
  id: test_fake_integration
  version: -1
name: test_fake_integration
display: test_fake_integration
fromversion: 6.0.0
category: Messaging
image: data:image/png;base64,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
description: Use the Zoom integration manage your Zoom users and meetings
configuration:
- display: ""
  name: apiKey
  defaultvalue: ""
  type: 4
  required: true
- display: ""
  name: apiSecret
  defaultvalue: ""
  type: 4
  required: true
- display: Use system proxy settings
  name: proxy
  defaultvalue: ""
  type: 8
  required: false
- display: Incident type
  name: incidentType
  required: false
  type: 13
- display: Fetch incidents
  name: isFetch
  required: false
  type: 8
  defaultvalue: 7 days
- display: First fetch timestamp (<number> <time unit>, e.g., 12 hours, 7 days)
  name: first_fetch
  required: false
  type: 0
- defaultvalue: '50'
  name: max_fetch
  required: false
  type: 0
script:
  script: |
    import datetime
    import jwt
    import requests
    import json
    import shutil
    from zipfile import ZipFile

    if not demisto.getParam('proxy'):
        del os.environ['HTTP_PROXY']
        del os.environ['HTTPS_PROXY']
        del os.environ['http_proxy']
        del os.environ['https_proxy']


    def get_jwt(apiKey, apiSecret):
        """
        Encode the JWT token given the api ket and secret
        """
        tt = datetime.datetime.now()
        expire_time = int(tt.strftime('%s')) + 5000
        payload  = {
            'iss': apiKey,
            'exp': expire_time
        }
        encoded = jwt.encode(payload, apiSecret, algorithm='HS256')
        return encoded


    URL = 'https://api.zoom.us/v2/'
    ACCESS_TOKEN = get_jwt(demisto.getParam('apiKey'), demisto.getParam('apiSecret'))
    PARAMS = {'access_token': ACCESS_TOKEN}
    HEADERS = {'Content-Type': 'application/json', 'Accept': 'application/json'}


    def return_error(data):
        """
        Return error as result and exit
        """
        demisto.results({
            'Type': entryTypes['error'],
            'ContentsFormat': formats['text'],
            'Contents' : data
        })
        sys.exit(0)


    if demisto.command() == 'test-module':
        res = requests.get(URL + 'users', headers=HEADERS, params=PARAMS)
        if res.status_code == requests.codes.ok:
            demisto.results('ok')
        else:
            return_error('Error testing [%d] - %s' % (res.status_code, res.text))

    elif demisto.command() == 'zoom-create-user':
        ut = demisto.getArg('user_type')
        user_type = 1  # Basic
        if ut == 'Pro':
            user_type = 2
        elif ut == 'Corporate':
            user_type = 3
        res = requests.post(URL + 'users', headers=HEADERS, params=PARAMS, json={
            'action': 'create',
            'user_info': {
                'email': demisto.getArg('email'),
                'type': user_type,
                'first_name': demisto.getArg('first_name'),
                'last_name': demisto.getArg('last_name')
            }
        })
        if res.status_code == requests.codes.created:
            data = res.json()
            demisto.results({
                'Type': entryTypes['note'],
                'ContentsFormat': formats['json'],
                'Contents': data,
                'HumanReadable': 'User created successfully with ID %s' % data.get('id'),
                'EntryContext': {'Zoom.User': data}
            })
        else:
            return_error('User creation failed: [%d] - %s' % (res.status_code, res.text))

    elif demisto.command() == 'zoom-list-users':
        params = {
            'access_token': ACCESS_TOKEN,
            'status': demisto.getArg('status'),
            'page_size': demisto.getArg('page-size'),
            'page_number': demisto.getArg('page-number')
        }
        res = requests.get(URL + 'users', headers=HEADERS, params=params)
        if res.status_code == requests.codes.ok:
            data = res.json()
            md = tableToMarkdown('Users', data.get('users'), ['id', 'first_name', 'last_name', 'email', 'type'])
            md += '\n' + tableToMarkdown('Metadata', [data], ['page_count', 'page_number', 'page_size', 'total_records'])
            demisto.results({
                'Type': entryTypes['note'],
                'ContentsFormat': formats['json'],
                'Contents': data,
                'HumanReadable': md,
                'EntryContext': {
                    'Zoom.User': data.get('users'),
                    'Zoom.Metadata': {
                        'Count': data.get('page_count'),
                        'Number': data.get('page_number'),
                        'Size': data.get('page_size'),
                        'Total': data.get('total_records')
                    }
                }
            })
        else:
            return_error('User creation failed: [%d] - %s' % (res.status_code, res.text))

    elif demisto.command() == 'zoom-delete-user':
        params = {
            'access_token': ACCESS_TOKEN,
            'action': demisto.getArg('action')
        }
        res = requests.delete(URL + 'users/' + demisto.getArg('user'), headers=HEADERS, params=params)
        if res.status_code == requests.codes.no_content:
            demisto.results('User %s deleted successfully' % demisto.getArg('user'))
        else:
            return_error('User creation failed: [%d] - %s' % (res.status_code, res.text))

    elif demisto.command() == 'zoom-create-meeting':
        auto_recording = "none"
        if (demisto.getArg('auto_record_meeting') == 'yes'):
            auto_recording = "cloud"
        params = {
            'type': 1,
            'topic': demisto.getArg('topic'),
            'settings': {
                'join_before_host': True,
                'auto_recording': auto_recording
            }
        }
        if (demisto.args()['type'] == 'Scheduled'):
            params.update({
                'type': 2,
                'start_time': demisto.getArg('start-time'),
                'timezone': demisto.getArg('timezone'),
            })
        res = requests.post(URL + "users/%s/meetings" % demisto.getArg('user'), headers=HEADERS, params=PARAMS, json=params)
        if res.status_code == requests.codes.created:
            data = res.json()
            md = 'Meeting created successfully.\nStart it [here](%s) and join [here](%s).' % (data.get('start_url'), data.get('join_url'))
            demisto.results({
                'Type': entryTypes['note'],
                'ContentsFormat': formats['json'],
                'Contents': data,
                'HumanReadable': md,
                'EntryContext': {'Zoom.Meeting': data}
            })
        else:
            return_error('Meeting creation failed: [%d] - %s' % (res.status_code, res.text))

    elif demisto.command() == 'zoom-fetch-recording':
        meeting = demisto.getArg('meeting_id')
        res = requests.get(URL + 'meetings/%s/recordings' % meeting, headers=HEADERS, params=PARAMS)
        if res.status_code == requests.codes.ok:
            data = res.json()
            recording_files = data['recording_files']
            for file in recording_files:
                download_url = file['download_url']
                r = requests.get(download_url, stream=True)
                if r.status_code < 200 or r.status_code > 299:
                    return_error('Unable to download recording for meeting %s: [%d] - %s' % (meeting, r.status_code, r.text))

                filename = 'recording_%s_%s.mp4' % (meeting, file['id'])
                with open(filename, 'wb') as f:
                    r.raw.decode_content = True
                    shutil.copyfileobj(r.raw, f)

                demisto.results(file_result_existing_file(filename))
                rf = requests.delete(URL + 'meetings/%s/recordings/%s' % (meeting, file['id']), headers=HEADERS, params=PARAMS)
                if rf.status_code == requests.codes.no_content:
                    demisto.results('File ' + filename + ' was moved to trash.')
                else:
                    demisto.results('Failed to delete file ' + filename + '.')
        else:
            return_error('Download of recording failed: [%d] - %s' % (res.status_code, res.text))
    else:
        return_error('Unrecognized command: ' + demisto.command())
  commands:
  - name: zoom-create-user
    arguments:
    - name: first_name
      required: true
      description: First name of the new user
    - name: last_name
      required: true
      description: Last name of the new user
    - name: email
      required: true
      description: The email of the new user
    - name: user_type
      auto: PREDEFINED
      predefined:
      - Basic
      - Pro
      - Corporate
      description: The type of the newly created user
      defaultValue: Basic
    outputs:
    - contextPath: Zoom.User.id
      description: The ID of the created user
      type: string
    - contextPath: Zoom.User.first_name
      description: First name of the created user
      type: string
    - contextPath: Zoom.User.last_name
      description: Last name for the created user
      type: string
    - contextPath: Zoom.User.email
      description: Email of the created user
      type: string
    - contextPath: Zoom.User.created_at
      description: Created date of the user
      type: date
    - contextPath: Zoom.User.type
      description: The type of the user
      type: number
    description: Create a new user in zoom account
    execution: true
  - name: zoom-create-meeting
    arguments:
    - name: type
      required: true
      default: true
      auto: PREDEFINED
      predefined:
      - Instant
      - Scheduled
      description: The type of the meeting
      defaultValue: Instant
    - name: user
      required: true
      description: email address or id of user for meeting
    - name: topic
      required: true
      description: The topic of the meeting
    - name: auto-record-meeting
      auto: PREDEFINED
      predefined:
      - "yes"
      - "no"
      description: 'Record zoom meeting? '
      defaultValue: "no"
    - name: start-time
      description: Meeting start time. When using a format like “yyyy-MM-dd’T'HH:mm:ss'Z’”,
        always use GMT time. When using a format like “yyyy-MM-dd’T'HH:mm:ss”, you
        should use local time and you will need to specify the time zone. Only used
        for scheduled meetings and recurring meetings with fixed time.
    - name: timezone
      description: 'Timezone to format start_time. For example, “America/Los_Angeles”.
        For scheduled meetings only. '
    outputs:
    - contextPath: Zoom.Meeting.join_url
      description: Join url for the meeting
      type: string
    - contextPath: Zoom.Meeting.id
      description: Meeting id of the new meeting that is created
      type: string
    - contextPath: Zoom.Meeting.start_url
      description: The URL to start the meeting
      type: string
    description: Create a new zoom meeting (scheduled or instant)
  - name: zoom-fetch-recording
    arguments:
    - name: meeting_id
      required: true
      description: Meeting id to get the recording
    outputs:
    - contextPath: File.SHA256
      description: Attachment's SHA256
    - contextPath: File.SHA1
      description: Attachment's SHA1
    - contextPath: File.MD5
      description: Attachment's MD5
    - contextPath: File.Name
      description: Attachment's Name
    - contextPath: File.Info
      description: Attachment's Info
    - contextPath: File.Size
      description: Attachment's Size (In Bytes)
    - contextPath: File.Extension
      description: Attachment's Extension
    - contextPath: File.Type
      description: Attachment's Type
    - contextPath: File.EntryID
      description: Attachment's EntryID
    - contextPath: File.SSDeep
      description: Attachment's SSDeep hash
    description: Get meeting record and save as file in the warroom
  - name: zoom-list-users
    arguments:
    - name: status
      default: true
      auto: PREDEFINED
      predefined:
      - active
      - inactive
      - pending
      description: Which status of users to list
      defaultValue: active
    - name: page-size
      description: Number of users to return. Max 300.
      defaultValue: "30"
    - name: page-number
      description: Which page of results to return
      defaultValue: "1"
    outputs:
    - contextPath: Zoom.Metadata.Count
      description: Total page count available
      type: number
    - contextPath: Zoom.Metadata.Number
      description: Current page number
      type: number
    - contextPath: Zoom.Metadata.Size
      description: Number of results in current page
      type: number
    - contextPath: Zoom.Metadata.Total
      description: Total number of records
      type: number
    - contextPath: Zoom.User.id
      description: ID of the user
      type: string
    - contextPath: Zoom.User.first_name
      description: First name of user
      type: string
    - contextPath: Zoom.User.last_name
      description: Last name of user
      type: string
    - contextPath: Zoom.User.email
      description: Email of user
      type: string
    - contextPath: Zoom.User.type
      description: Type of user
      type: number
    - contextPath: Zoom.User.created_at
      description: Date when user was created
      type: date
    - contextPath: Zoom.User.dept
      description: Department for user
      type: string
    - contextPath: Zoom.User.verified
      description: Is the user verified
      type: number
    - contextPath: Zoom.User.last_login_time
      description: Last login time of the user
      type: date
    - contextPath: Zoom.User.timezone
      description: Default timezone for the user
      type: string
    - contextPath: Zoom.User.pmi
      description: PMI of user
      type: string
    - contextPath: Zoom.User.group_ids
      description: Groups user belongs to
      type: string
    description: List the existing users
  - name: zoom-delete-user
    arguments:
    - name: user
      required: true
      default: true
      description: The user ID or email to delete
    - name: action
      auto: PREDEFINED
      predefined:
      - disassociate
      - delete
      description: The action to take
      defaultValue: disassociate
    description: Delete a user from Zoom
    execution: true
  dockerimage: demisto/pyjwt:1.0
  isfetch: true
  subtype: python3
  type: python
  longRunning: false
  longRunningPort: false
  runonce: false
tests:
- No tests (auto formatted)
