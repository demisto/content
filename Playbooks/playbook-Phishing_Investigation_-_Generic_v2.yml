id: Phishing Investigation - Generic v2
version: -1
fromversion: 4.5.0
name: Phishing Investigation - Generic v2
description: 'Use this playbook to investigate and remediate a potential phishing
  incident. The playbook simultaneously engages with the user that triggered the incident,
  while investigating the incident itself.


  The final remediation tasks are always decided by a human analyst.'
starttaskid: '0'
tasks:
  '0':
    id: '0'
    taskid: ac4755be-b17d-4464-8224-15aee51d29de
    type: start
    task:
      id: ac4755be-b17d-4464-8224-15aee51d29de
      version: -1
      name: ''
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '39'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 592.5,\n    \"y\": -90\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '2':
    id: '2'
    taskid: b8fe1f1e-c1ae-499e-83d7-f466009b5790
    type: regular
    task:
      id: b8fe1f1e-c1ae-499e-83d7-f466009b5790
      version: -1
      name: Assign to analyst
      description: Assign the incident to an analyst based on the analyst's organizational
        role.
      scriptName: AssignAnalystToIncident
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '15'
    scriptarguments:
      assignBy: {}
      email: {}
      roles:
        complex:
          root: inputs.Role
      username: {}
    reputationcalc: 1
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 642.5,\n    \"y\": 2810\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '7':
    id: '7'
    taskid: d6dfa5b6-7756-4f6f-8e97-c9c7bcd67ad7
    type: regular
    task:
      id: d6dfa5b6-7756-4f6f-8e97-c9c7bcd67ad7
      version: -1
      name: Manually review the incident
      description: Review the incident to determine if the email that the user reported
        is malicious.
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '33'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 130,\n    \"y\": 3305\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '8':
    id: '8'
    taskid: 11da73b5-8815-42ea-89e6-d17ed25787d9
    type: regular
    task:
      id: 11da73b5-8815-42ea-89e6-d17ed25787d9
      version: -1
      name: Close investigation
      description: Close the investigation.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - '29'
    scriptarguments:
      assetid: {}
      closeNotes: {}
      closeReason: {}
      id: {}
      importantfield: {}
      test2: {}
      timefield1: {}
    reputationcalc: 1
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 710,\n    \"y\": 5050\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '11':
    id: '11'
    taskid: 61327623-b9c8-4683-892e-82ed6a2005f7
    type: title
    task:
      id: 61327623-b9c8-4683-892e-82ed6a2005f7
      version: -1
      name: Triage
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '26'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 7.5,\n    \"y\": 195\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '12':
    id: '12'
    taskid: 3fa6bd94-e6fa-4cad-8e42-a35aa3370a56
    type: regular
    task:
      id: 3fa6bd94-e6fa-4cad-8e42-a35aa3370a56
      version: -1
      name: Store the email address of the reporting user
      description: Store the email address of the user that reported the incident.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '53'
      - '85'
    scriptarguments:
      append: {}
      key:
        simple: ReporterAddress
      value:
        complex:
          root: incident
          accessor: labels.Email/from
    reputationcalc: 1
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 1182.5,\n    \"y\": 350\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '13':
    id: '13'
    taskid: 9551bc3f-272d-4db9-8a40-30b48d1ba33b
    type: regular
    task:
      id: 9551bc3f-272d-4db9-8a40-30b48d1ba33b
      version: -1
      name: Acknowledge incident was received
      description: 'Send an auto-response to user that reported the incident, informing
        them the incident was received and being handled.

        '
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ''
    nexttasks:
      '#none#':
      - '2'
    scriptarguments:
      additionalHeader: {}
      attachCIDs: {}
      attachIDs: {}
      attachNames: {}
      bcc: {}
      body:
        simple: "Hi ${.=function(val) { var reporter = val.ReporterAddress ;var account\
          \ = val.Account.filter(function(acc) { return acc.DisplayName && acc.Email\
          \ && acc.Email.Address === reporter }); return account[0] && account[0].DisplayName\
          \ || reporter; }(val)},\nWe've received your email and are investigating.\n\
          Please do not touch the email until further notice.\n\nCordially, \n  Your\
          \ friendly neighborhood security team"
      cc: {}
      from: {}
      htmlBody: {}
      replyTo: {}
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      templateParams: {}
      to:
        complex:
          root: incident
          accessor: labels.Email/from
      transientFile: {}
      transientFileCID: {}
      transientFileContent: {}
    reputationcalc: 1
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 1182.5,\n    \"y\": 710\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '15':
    id: '15'
    taskid: 4defb0e5-cc6d-4939-8e4b-d69e261714f1
    type: condition
    task:
      id: 4defb0e5-cc6d-4939-8e4b-d69e261714f1
      version: -1
      name: Is the email malicious?
      description: Determines if the email is malicious based on the calculated severity.
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '31'
      'Malicious ':
      - '30'
    separatecontext: false
    conditions:
    - label: 'Malicious '
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              simple: incident.severity
            iscontext: true
          right:
            value:
              simple: '2'
    view: "{\n  \"position\": {\n    \"x\": 642.5,\n    \"y\": 2985\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '16':
    id: '16'
    taskid: 417da9df-5b58-4530-8dae-8591592a06df
    type: regular
    task:
      id: 417da9df-5b58-4530-8dae-8591592a06df
      version: -1
      name: Update  the user that the reported email is safe
      description: Send an email to the user explaining that the email they reported
        is safe.
      scriptName: SendEmail
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '8'
    scriptarguments:
      attachIDs: {}
      bcc: {}
      body:
        simple: "Hi ${.=val.Account.DisplayName && val.Email.Address === val.incident.labels['Email/from']\
          \ ? val.Account.DisplayName : val.incident.labels['Email/from']},\nWe've\
          \ concluded that the email you forwarded to us is safe.\nThank you for your\
          \ alertness and your participation in keeping our organization secure.\n\
          \nCordially,\n  Your security team"
      cc: {}
      htmlBody: {}
      noteEntryID: {}
      replyTo: {}
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        simple: ${incident.labels.Email/from}
    reputationcalc: 1
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 130,\n    \"y\": 3930\n  }\n}"
    note: false
    timertriggers:
    - fieldname: detectionsla
      action: stop
    ignoreworker: false
  '17':
    id: '17'
    taskid: 38d12767-452d-438e-8361-2c19bdb6bc65
    type: regular
    task:
      id: 38d12767-452d-438e-8361-2c19bdb6bc65
      version: -1
      name: Update  the user that the reported email is malicious
      description: Send an email to the user explaining that the email they reported
        is malicious.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ''
    nexttasks:
      '#none#':
      - '27'
    scriptarguments:
      attachIDs: {}
      attachNames: {}
      bcc: {}
      body:
        simple: "Hi ${.=val.Account.DisplayName && val.Email.Address === val.incident.labels['Email/from']\
          \ ? val.Account.DisplayName : val.incident.labels['Email/from']},\nWe've\
          \ concluded that the email you forwarded to us is malicious. No further\
          \ action is required on your part. Good job on detecting and forwarding\
          \ it to us!\n\nAll the best,\n  Your security team"
      cc: {}
      htmlBody: {}
      replyTo: {}
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        simple: ${incident.labels.Email/from}
      transientFile: {}
      transientFileContent: {}
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 1070,\n    \"y\": 3940\n  }\n}"
    note: false
    timertriggers:
    - fieldname: detectionsla
      action: stop
    ignoreworker: false
  '18':
    id: '18'
    taskid: dda5420c-7de7-4f2d-8da5-09f3ed8a12b9
    type: title
    task:
      id: dda5420c-7de7-4f2d-8da5-09f3ed8a12b9
      version: -1
      name: Engage with User
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '12'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 1182.5,\n    \"y\": 195\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '22':
    id: '22'
    taskid: be406ffc-c93b-4890-830c-2536ffbedc6e
    type: playbook
    task:
      id: be406ffc-c93b-4890-830c-2536ffbedc6e
      version: -1
      name: Detonate File - Generic
      playbookName: Detonate File - Generic
      type: playbook
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '56'
    separatecontext: true
    view: "{\n  \"position\": {\n    \"x\": 272.5,\n    \"y\": 530\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '26':
    id: '26'
    taskid: 151f9ed5-3b43-4380-8ced-9892eb91104d
    type: playbook
    task:
      id: 151f9ed5-3b43-4380-8ced-9892eb91104d
      version: -1
      name: Process Email - Generic
      playbookName: Process Email - Generic
      type: playbook
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '55'
      - '22'
    separatecontext: true
    view: "{\n  \"position\": {\n    \"x\": 7.5,\n    \"y\": 340\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '27':
    id: '27'
    taskid: 421eef34-f338-4c46-89cf-844afa2a2e48
    type: title
    task:
      id: 421eef34-f338-4c46-89cf-844afa2a2e48
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '37'
      - '36'
      - '34'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 1070,\n    \"y\": 4140\n  }\n}"
    note: false
    timertriggers:
    - fieldname: remediationsla
      action: start
    ignoreworker: false
  '28':
    id: '28'
    taskid: f168df65-a9bf-4305-881a-7d740ebde500
    type: playbook
    task:
      id: f168df65-a9bf-4305-881a-7d740ebde500
      version: -1
      name: Search And Delete Emails - Generic
      playbookName: Search And Delete Emails - Generic
      type: playbook
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '43'
    separatecontext: true
    view: "{\n  \"position\": {\n    \"x\": 1062.5,\n    \"y\": 4515\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '29':
    id: '29'
    taskid: fc429ec3-8231-46f6-8b25-2c7a06d2f005
    type: title
    task:
      id: fc429ec3-8231-46f6-8b25-2c7a06d2f005
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ''
      description: ''
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 715,\n    \"y\": 5215\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '30':
    id: '30'
    taskid: c2119cb4-091b-433a-8aeb-dac70d4a296e
    type: title
    task:
      id: c2119cb4-091b-433a-8aeb-dac70d4a296e
      version: -1
      name: Email Is Malicious
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '17'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 1062.5,\n    \"y\": 3160\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '31':
    id: '31'
    taskid: d560749b-2218-466f-856e-18986e9a1885
    type: title
    task:
      id: d560749b-2218-466f-856e-18986e9a1885
      version: -1
      name: Undetermined
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '7'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 130,\n    \"y\": 3160\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '33':
    id: '33'
    taskid: 231bb05f-9f96-4a43-82a4-70b3ef434bf8
    type: condition
    task:
      id: 231bb05f-9f96-4a43-82a4-70b3ef434bf8
      version: -1
      name: Is the email malicious?
      description: Is the email that the user reported malicious?
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      'No':
      - '16'
      'Yes':
      - '17'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 130,\n    \"y\": 3470\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '34':
    id: '34'
    taskid: 945915a4-395f-444f-8500-c80791cddcfd
    type: regular
    task:
      id: 945915a4-395f-444f-8500-c80791cddcfd
      version: -1
      name: Manually remediate  the incident
      description: 'Consider the following:

        1. Search for and delete similar emails

        2. Inform the organization about the threat

        3. Hunt the relevant IOCs

        4. Update proxies and firewalls as necessary

        5. Block the malicious sender/ domain in the mail-gateway '
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '43'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 620,\n    \"y\": 4310\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '36':
    id: '36'
    taskid: 0c8816d8-8be2-4bed-8f12-02f70a25dd60
    type: condition
    task:
      id: 0c8816d8-8be2-4bed-8f12-02f70a25dd60
      version: -1
      name: Execute the "Search and Delete" sub-playbook?
      description: Verify that the "Search and Delete" parameter is set to "True"?
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '43'
      'yes':
      - '28'
    separatecontext: false
    conditions:
    - label: 'yes'
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: inputs.SearchAndDelete
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: inputs.SearchAndDelete
                      iscontext: true
                    right:
                      value:
                        simple: 'True'
                    ignorecase: true
            iscontext: true
    view: "{\n  \"position\": {\n    \"x\": 1070,\n    \"y\": 4310\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '37':
    id: '37'
    taskid: 2c4bace5-7d57-4846-89ce-78ddee6e40c8
    type: condition
    task:
      id: 2c4bace5-7d57-4846-89ce-78ddee6e40c8
      version: -1
      name: Execute the "Block Indicators" sub-playbook?
      description: Verify that the "Block indicators" parameter is set to "True"?
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '43'
      'yes':
      - '38'
    separatecontext: false
    conditions:
    - label: 'yes'
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: inputs.BlockIndicators
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: inputs.BlockIndicators
                      iscontext: true
                    right:
                      value:
                        simple: 'True'
                    ignorecase: true
            iscontext: true
    view: "{\n  \"position\": {\n    \"x\": 1510,\n    \"y\": 4310\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '38':
    id: '38'
    taskid: d32af5b0-4287-49f7-82da-ca70c78d4345
    type: playbook
    task:
      id: d32af5b0-4287-49f7-82da-ca70c78d4345
      version: -1
      name: Block Indicators - Generic
      playbookName: Block Indicators - Generic
      type: playbook
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '43'
    separatecontext: true
    view: "{\n  \"position\": {\n    \"x\": 1510,\n    \"y\": 4515\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '39':
    id: '39'
    taskid: 151326c6-7adc-48bf-8710-6b0b01d86f48
    type: title
    task:
      id: 151326c6-7adc-48bf-8710-6b0b01d86f48
      version: -1
      name: Start Detection Timer
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '18'
      - '11'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 592.5,\n    \"y\": 40\n  }\n}"
    note: false
    timertriggers:
    - fieldname: detectionsla
      action: start
    ignoreworker: false
  '43':
    id: '43'
    taskid: 17f9d1ad-24e9-4ddc-813f-15ff190032a1
    type: title
    task:
      id: 17f9d1ad-24e9-4ddc-813f-15ff190032a1
      version: -1
      name: Stop Remediation Timer
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '8'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 710,\n    \"y\": 4910\n  }\n}"
    note: false
    timertriggers:
    - fieldname: remediationsla
      action: stop
    ignoreworker: false
  '47':
    id: '47'
    taskid: 9d139a23-b310-40bd-8c57-925fd2737e4c
    type: playbook
    task:
      id: 9d139a23-b310-40bd-8c57-925fd2737e4c
      version: -1
      name: File Enrichment - Generic v2
      description: ''
      playbookName: File Enrichment - Generic v2
      type: playbook
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '56'
    scriptarguments:
      MD5:
        complex:
          root: File
          accessor: MD5
          transformers:
          - operator: uniq
      SHA1:
        complex:
          root: File
          accessor: SHA1
          transformers:
          - operator: uniq
      SHA256:
        complex:
          root: File
          accessor: SHA256
          transformers:
          - operator: uniq
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
    view: "{\n  \"position\": {\n    \"x\": -490,\n    \"y\": 860\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '48':
    id: '48'
    taskid: cc58bc17-c526-423c-8450-291cf70d3beb
    type: playbook
    task:
      id: cc58bc17-c526-423c-8450-291cf70d3beb
      version: -1
      name: IP Enrichment - External - Generic v2
      description: ''
      playbookName: IP Enrichment - External - Generic v2
      type: playbook
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '56'
    scriptarguments:
      IP:
        complex:
          root: IP
          accessor: Address
          transformers:
          - operator: uniq
      InternalRange: {}
      ResolveIP:
        simple: 'False'
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
    view: "{\n  \"position\": {\n    \"x\": -52.5,\n    \"y\": 860\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '49':
    id: '49'
    taskid: 81a1c597-fa66-4ebc-86cb-7155baa405de
    type: playbook
    task:
      id: 81a1c597-fa66-4ebc-86cb-7155baa405de
      version: -1
      name: Email Address Enrichment - Generic v2.1
      description: ''
      playbookName: Email Address Enrichment - Generic v2.1
      type: playbook
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '56'
    scriptarguments:
      Domain:
        complex:
          root: Domain
          accessor: Name
          transformers:
          - operator: uniq
      Email:
        complex:
          root: Account
          accessor: Email.Address
          transformers:
          - operator: uniq
      InternalDomains: {}
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
    view: "{\n  \"position\": {\n    \"x\": -490,\n    \"y\": 1020\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '50':
    id: '50'
    taskid: 6b8f702e-45cc-4004-8009-e4c985f01338
    type: playbook
    task:
      id: 6b8f702e-45cc-4004-8009-e4c985f01338
      version: -1
      name: URL Enrichment - Generic v2
      description: ''
      playbookName: URL Enrichment - Generic v2
      type: playbook
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '56'
    scriptarguments:
      Rasterize:
        simple: 'True'
      URL:
        complex:
          root: URL
          accessor: Data
          transformers:
          - operator: uniq
      VerifyURL:
        simple: 'False'
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
    view: "{\n  \"position\": {\n    \"x\": -52.5,\n    \"y\": 1020\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '51':
    id: '51'
    taskid: a4b8af21-21d7-471c-8290-0deb9ee23e89
    type: playbook
    task:
      id: a4b8af21-21d7-471c-8290-0deb9ee23e89
      version: -1
      name: Domain Enrichment - Generic v2
      description: ''
      playbookName: Domain Enrichment - Generic v2
      type: playbook
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '56'
    scriptarguments:
      Domain:
        complex:
          root: Domain
          accessor: Name
          transformers:
          - operator: uniq
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
    view: "{\n  \"position\": {\n    \"x\": -52.5,\n    \"y\": 1180\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '52':
    id: '52'
    taskid: 29d97b94-fad1-490d-8ddb-b0e16c107da8
    type: title
    task:
      id: 29d97b94-fad1-490d-8ddb-b0e16c107da8
      version: -1
      name: Indicator Enrichment
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '48'
      - '47'
      - '50'
      - '49'
      - '51'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": -272.5,\n    \"y\": 710\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '53':
    id: '53'
    taskid: 9efe139c-3485-464d-8122-1a3bc8587888
    type: playbook
    task:
      id: 9efe139c-3485-464d-8122-1a3bc8587888
      version: -1
      name: Email Address Enrichment - Generic v2.1
      description: ''
      playbookName: Email Address Enrichment - Generic v2.1
      type: playbook
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '13'
    scriptarguments:
      Domain:
        complex:
          root: Domain
          transformers:
          - operator: uniq
      Email:
        complex:
          root: ReporterAddress
          transformers:
          - operator: uniq
      InternalDomains: {}
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
    view: "{\n  \"position\": {\n    \"x\": 1182.5,\n    \"y\": 530\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '55':
    id: '55'
    taskid: 675eab21-6e48-46f8-8c48-831d694b90bc
    type: playbook
    task:
      id: 675eab21-6e48-46f8-8c48-831d694b90bc
      version: -1
      name: Extract Indicators From File - Generic v2
      playbookName: Extract Indicators From File - Generic v2
      type: playbook
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '52'
    separatecontext: true
    view: "{\n  \"position\": {\n    \"x\": -272.5,\n    \"y\": 530\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '56':
    id: '56'
    taskid: 54dab694-bd86-4fb5-8c85-b01dfd91a15d
    type: title
    task:
      id: 54dab694-bd86-4fb5-8c85-b01dfd91a15d
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '79'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": -260,\n    \"y\": 1510\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '79':
    id: '79'
    taskid: d18654f5-16fd-441e-8db0-4e55f0df0f43
    type: condition
    task:
      id: d18654f5-16fd-441e-8db0-4e55f0df0f43
      version: -1
      name: Should the email be authenticated?
      description: Whether the email should be authenticated using DKIM, SPF and DMARC.
        This checks whether "AuthenticateEmail" output is set to "True" and whether
        there are headers from an email to authenticate.
      type: condition
      iscommand: false
      brand: ''
    nexttasks:
      '#default#':
      - '84'
      'yes':
      - '80'
    separatecontext: false
    conditions:
    - label: 'yes'
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.AuthenticateEmail
            iscontext: true
          right:
            value:
              simple: 'True'
          ignorecase: true
      - - operator: isExists
          left:
            value:
              complex:
                root: Email
                accessor: HeadersMap
            iscontext: true
    view: "{\n  \"position\": {\n    \"x\": -260,\n    \"y\": 1680\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '80':
    id: '80'
    taskid: 254b1455-3c72-4a76-85ef-603e9cd4cda4
    type: title
    task:
      id: 254b1455-3c72-4a76-85ef-603e9cd4cda4
      version: -1
      name: Email Authenticity Check
      type: title
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '82'
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": -260,\n    \"y\": 1910\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '82':
    id: '82'
    taskid: 29937a18-e577-40bd-8a5a-64bb1e4abac6
    type: regular
    task:
      id: 29937a18-e577-40bd-8a5a-64bb1e4abac6
      version: -1
      name: Authenticate email
      description: Checks the authenticity of an email based on the email's SPF, DMARC,
        and DKIM.
      scriptName: CheckEmailAuthenticity
      type: regular
      iscommand: false
      brand: ''
    nexttasks:
      '#none#':
      - '83'
    scriptarguments:
      DKIM_override_fail: {}
      DKIM_override_neutral: {}
      DKIM_override_none: {}
      DKIM_override_pass: {}
      DKIM_override_permerror: {}
      DKIM_override_policy: {}
      DKIM_override_temperror: {}
      DMARC_override_fail: {}
      DMARC_override_none: {}
      DMARC_override_pass: {}
      DMARC_override_permerror: {}
      DMARC_override_temperror: {}
      SPF_override_fail: {}
      SPF_override_neutral: {}
      SPF_override_none: {}
      SPF_override_pass: {}
      SPF_override_permerror: {}
      SPF_override_softfail: {}
      SPF_override_temperror: {}
      headers:
        complex:
          root: Email
          accessor: HeadersMap
          transformers:
          - operator: uniq
    reputationcalc: 1
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": -260,\n    \"y\": 2080\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '83':
    id: '83'
    taskid: e80e3f5a-a74f-44a8-8e83-8eee96def1d0
    type: regular
    task:
      id: e80e3f5a-a74f-44a8-8e83-8eee96def1d0
      version: -1
      name: Save authenticity check result to incident field
      description: Save the verdict, regarding the authenticity of the email, in an
        incident field.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - '84'
    scriptarguments:
      addLabels: {}
      affecteddata: {}
      affecteddatatype: {}
      affectedhosts: {}
      affectedindividualscontactinformation: {}
      affectedips: {}
      app: {}
      approximatenumberofaffecteddatasubjects: {}
      assetid: {}
      attachmentcount: {}
      attachmentextension: {}
      attachmenthash: {}
      attachmentid: {}
      attachmentitem: {}
      attachmentname: {}
      attachmentsize: {}
      attachmenttype: {}
      backupowner: {}
      bugtraq: {}
      campaigntargetcount: {}
      campaigntargets: {}
      city: {}
      closeNotes: {}
      closeReason: {}
      companyaddress: {}
      companycity: {}
      companycountry: {}
      companyhasinsuranceforthebreach: {}
      companyname: {}
      companypostalcode: {}
      contactaddress: {}
      contactname: {}
      country: {}
      countrywherebusinesshasitsmainestablishment: {}
      countrywherethebreachtookplace: {}
      criticalassets: {}
      customFields: {}
      cve: {}
      cvss: {}
      dataencryptionstatus: {}
      datetimeofthebreach: {}
      daysbetweenreportcreation: {}
      deleteEmptyField: {}
      dest: {}
      destinationip: {}
      destntdomain: {}
      details: {}
      detectedusers: {}
      dpoemailaddress: {}
      duration: {}
      emailaddress: {}
      emailauthenticitycheck:
        complex:
          root: Email
          accessor: AuthenticityCheck
          transformers:
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Undetermined
              toReplace:
                value:
                  simple: undetermined
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Pass
              toReplace:
                value:
                  simple: pass
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Fail
              toReplace:
                value:
                  simple: fail
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: Suspicious
              toReplace:
                value:
                  simple: suspicious
      emailbcc: {}
      emailbody: {}
      emailbodyformat: {}
      emailbodyhtml: {}
      emailbodyhtmlraw: {}
      emailcc: {}
      emailclientname: {}
      emailfrom: {}
      emailfromdisplayname: {}
      emailhtml: {}
      emailinreplyto: {}
      emailkeywords: {}
      emailmessageid: {}
      emailreceived: {}
      emailreplyto: {}
      emailreturnpath: {}
      emailsenderdomain: {}
      emailsenderip: {}
      emailsize: {}
      emailsource: {}
      emailsubject: {}
      emailsubjectlanguage: {}
      emailto: {}
      emailtocount: {}
      emailurlclicked: {}
      eventid: {}
      falses: {}
      fetchid: {}
      fetchtype: {}
      filehash: {}
      filename: {}
      filepath: {}
      hostid: {}
      hostname: {}
      htmlimage: {}
      htmlrenderedimage: {}
      id: {}
      important: {}
      importantfield: {}
      isthedatasubjecttodpia: {}
      labels: {}
      likelyimpact: {}
      maliciouscauseifthecauseisamaliciousattack: {}
      malwarefamily: {}
      mdtest: {}
      measurestomitigate: {}
      myfield: {}
      name: {}
      occurred: {}
      owner: {}
      phase: {}
      phishingsubtype: {}
      possiblecauseofthebreach: {}
      postalcode: {}
      relateddomain: {}
      replacePlaybook: {}
      reporteduser: {}
      reportinguser: {}
      roles: {}
      screenshot: {}
      screenshot2: {}
      sectorofaffectedparty: {}
      selector: {}
      severity: {}
      signature: {}
      single: {}
      single2: {}
      sizenumberofemployees: {}
      sizeturnover: {}
      sla: {}
      slaField: {}
      source: {}
      src: {}
      srcntdomain: {}
      srcuser: {}
      systems: {}
      telephoneno: {}
      test: {}
      test2: {}
      testfield: {}
      timeassignedtolevel2: {}
      timefield1: {}
      timelevel1: {}
      type: {}
      user: {}
      username: {}
      vendorid: {}
      vendorproduct: {}
      vulnerabilitycategory: {}
      whereisdatahosted: {}
      xdr: {}
    reputationcalc: 1
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": -260,\n    \"y\": 2255\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '84':
    id: '84'
    taskid: 32673e2e-72fc-4a00-8054-7e0f357a6981
    type: playbook
    task:
      id: 32673e2e-72fc-4a00-8054-7e0f357a6981
      version: -1
      name: Calculate Severity - Generic v2
      playbookName: Calculate Severity - Generic v2
      type: playbook
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '2'
    separatecontext: true
    view: "{\n  \"position\": {\n    \"x\": 212.5,\n    \"y\": 2560\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '85':
    id: '85'
    taskid: c325df0c-5e0f-4ba9-8863-0b0c18410025
    type: regular
    task:
      id: c325df0c-5e0f-4ba9-8863-0b0c18410025
      version: -1
      name: Save reporter email address in field
      description: Saves the email address of the reporter of the email, in an incident
        field.
      script: Builtin|||setIncident
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - '13'
    scriptarguments:
      addLabels: {}
      affecteddata: {}
      affecteddatatype: {}
      affectedhosts: {}
      affectedindividualscontactinformation: {}
      affectedips: {}
      app: {}
      approximatenumberofaffecteddatasubjects: {}
      assetid: {}
      attachmentcount: {}
      attachmentextension: {}
      attachmenthash: {}
      attachmentid: {}
      attachmentitem: {}
      attachmentname: {}
      attachmentsize: {}
      attachmenttype: {}
      backupowner: {}
      bugtraq: {}
      campaigntargetcount: {}
      campaigntargets: {}
      city: {}
      closeNotes: {}
      closeReason: {}
      companyaddress: {}
      companycity: {}
      companycountry: {}
      companyhasinsuranceforthebreach: {}
      companyname: {}
      companypostalcode: {}
      contactaddress: {}
      contactname: {}
      country: {}
      countrywherebusinesshasitsmainestablishment: {}
      countrywherethebreachtookplace: {}
      criticalassets: {}
      customFields: {}
      cve: {}
      cvss: {}
      dataencryptionstatus: {}
      datetimeofthebreach: {}
      daysbetweenreportcreation: {}
      deleteEmptyField: {}
      dest: {}
      destinationip: {}
      destntdomain: {}
      details: {}
      detectedusers: {}
      dpoemailaddress: {}
      duration: {}
      emailaddress: {}
      emailauthenticitycheck: {}
      emailbcc: {}
      emailbody: {}
      emailbodyformat: {}
      emailbodyhtml: {}
      emailcc: {}
      emailclassification: {}
      emailclientname: {}
      emailfrom: {}
      emailfromdisplayname: {}
      emailheaders: {}
      emailhtml: {}
      emailinreplyto: {}
      emailkeywords: {}
      emailmessageid: {}
      emailreceived: {}
      emailreplyto: {}
      emailreturnpath: {}
      emailsenderdomain: {}
      emailsenderip: {}
      emailsize: {}
      emailsource: {}
      emailsubject: {}
      emailsubjectlanguage: {}
      emailto: {}
      emailtocount: {}
      emailurlclicked: {}
      eventid: {}
      falses: {}
      fetchid: {}
      fetchtype: {}
      filehash: {}
      filename: {}
      filepath: {}
      hostid: {}
      hostname: {}
      htmlimage: {}
      htmlrenderedimage: {}
      id: {}
      important: {}
      importantfield: {}
      isthedatasubjecttodpia: {}
      labels: {}
      likelyimpact: {}
      maliciouscauseifthecauseisamaliciousattack: {}
      malwarefamily: {}
      mdtest: {}
      measurestomitigate: {}
      myfield: {}
      name: {}
      occurred: {}
      owner: {}
      phase: {}
      phishingsubtype: {}
      possiblecauseofthebreach: {}
      postalcode: {}
      relateddomain: {}
      replacePlaybook: {}
      reporteduser: {}
      reporteremailaddress:
        complex:
          root: ReporterAddress
      reportinguser: {}
      roles: {}
      screenshot: {}
      screenshot2: {}
      sectorofaffectedparty: {}
      selector: {}
      severity: {}
      signature: {}
      single: {}
      single2: {}
      sizenumberofemployees: {}
      sizeturnover: {}
      sla: {}
      slaField: {}
      source: {}
      src: {}
      srcntdomain: {}
      srcuser: {}
      systems: {}
      telephoneno: {}
      test: {}
      test2: {}
      testfield: {}
      timeassignedtolevel2: {}
      timefield1: {}
      timelevel1: {}
      type: {}
      urlsslverification: {}
      user: {}
      username: {}
      vendorid: {}
      vendorproduct: {}
      vulnerabilitycategory: {}
      whereisdatahosted: {}
      xdr: {}
      xdralertcount: {}
      xdralerts: {}
      xdrassigneduseremail: {}
      xdrassigneduserprettyname: {}
      xdrdescription: {}
      xdrdetectiontime: {}
      xdrfileartifacts: {}
      xdrhighseverityalertcount: {}
      xdrincidentid: {}
      xdrlowseverityalertcount: {}
      xdrmediumseverityalertcount: {}
      xdrnetworkartifacts: {}
      xdrnotes: {}
      xdrresolvecomment: {}
      xdrstatus: {}
      xdrurl: {}
      xdrusercount: {}
    reputationcalc: 1
    separatecontext: false
    view: "{\n  \"position\": {\n    \"x\": 1650,\n    \"y\": 530\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
  '86':
    id: '86'
    taskid: b88d67de-5b86-49e0-8e3d-14a93ca89b8b
    type: playbook
    task:
      id: b88d67de-5b86-49e0-8e3d-14a93ca89b8b
      version: -1
      name: URL Enrichment - Generic v2
      playbookName: URL Enrichment - Generic v2
      type: playbook
      iscommand: false
      brand: ''
      description: ''
    nexttasks:
      '#none#':
      - '56'
    scriptarguments:
      Rasterize:
        simple: 'True'
      URL:
        complex:
          root: URL
          accessor: Data
          transformers:
          - operator: uniq
      VerifyURL:
        simple: 'False'
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ''
      wait: 1
    view: "{\n  \"position\": {\n    \"x\": -52.5,\n    \"y\": 1020\n  }\n}"
    note: false
    timertriggers: []
    ignoreworker: false
view: "{\n  \"linkLabelsPosition\": {\n    \"15_30_Malicious \": 0.48,\n    \"15_31_#default#\"\
  : 0.44,\n    \"33_16_No\": 0.64,\n    \"33_17_Yes\": 0.19,\n    \"36_43_#default#\"\
  : 0.39,\n    \"37_43_#default#\": 0.23,\n    \"79_80_yes\": 0.49,\n    \"79_84_#default#\"\
  : 0.34\n  },\n  \"paper\": {\n    \"dimensions\": {\n      \"height\": 5370,\n \
  \     \"width\": 2520,\n      \"x\": -490,\n      \"y\": -90\n    }\n  }\n}"
inputs:
- key: Role
  value:
    simple: Administrator
  required: true
  description: The default role to assign the incident to.
- key: SearchAndDelete
  value:
    simple: 'False'
  required: false
  description: 'Enable the "Search and Delete" capability (can be either "True" or
    "False").

    In case of a malicious email, the "Search and Delete" sub-playbook will look for
    other instances of the email and delete them pending analyst approval.'
- key: BlockIndicators
  value:
    simple: 'False'
  required: false
  description: 'Enable the "Block Indicators" capability (can be either "True" or
    "False").

    In case of a malicious email, the "Block Indicators" sub-playbook will block all
    malicious indicators in the relevant integrations.'
- key: AuthenticateEmail
  value:
    simple: 'False'
  required: false
  description: Whether the authenticity of the email should be verified, using SPF,
    DKIM and DMARC.
outputs: []
tests:
  - Phishing v2 Test - Attachment
  - Phishing v2 Test - Inline
