id: Phishing Investigation - Generic
version: -1
name: Phishing Investigation - Generic
fromversion: 4.0.0
description: |-
  Use this playbook to investigate and remediate a potential phishing incident. The playbook simultaneously engages with the user that triggered the incident, while investigating the incident itself.

  The final remediation tasks are always decided by a human analyst.
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 5a4404c0-4129-49fe-80ac-a61b5531d4c4
    type: start
    task:
      id: 5a4404c0-4129-49fe-80ac-a61b5531d4c4
      version: -1
      name: ""
      description: ""
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
      - "18"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 480,
          "y": 50
        }
      }
    note: false
  "2":
    id: "2"
    taskid: 43361c07-97a5-4c6a-8843-bdaa9d3bc9a8
    type: regular
    task:
      id: 43361c07-97a5-4c6a-8843-bdaa9d3bc9a8
      version: -1
      name: Assign to analyst
      description: Assign the incident to an analyst based on the analyst's organizational
        role.
      scriptName: AssignAnalystToIncident
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      assignBy: {}
      email: {}
      roles:
        complex:
          root: inputs.Role
      username: {}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 480,
          "y": 1040
        }
      }
    note: false
  "6":
    id: "6"
    taskid: 0c44545c-5168-492a-83f8-7a6366eeac5b
    type: playbook
    task:
      id: 0c44545c-5168-492a-83f8-7a6366eeac5b
      version: -1
      name: ""
      description: ""
      playbookName: Calculate Severity - Generic
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "2"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 265,
          "y": 865
        }
      }
    note: false
  "7":
    id: "7"
    taskid: a25b9178-3384-4c5a-87b9-93c2fd372799
    type: regular
    task:
      id: a25b9178-3384-4c5a-87b9-93c2fd372799
      version: -1
      name: Manually review the incident
      description: Review the incident to determine if the email that the user reported
        is malicious.
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 275,
          "y": 1535
        }
      }
    note: false
  "8":
    id: "8"
    taskid: 5f263ec0-8b61-4e15-877d-58e1e352f026
    type: regular
    task:
      id: 5f263ec0-8b61-4e15-877d-58e1e352f026
      version: -1
      name: Close investigation
      description: Close the investigation.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    nexttasks:
      '#none#':
      - "29"
    scriptarguments:
      notes:
        simple: 'Default enrichment playbook '
      reason: {}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 480,
          "y": 2525
        }
      }
    note: false
  "11":
    id: "11"
    taskid: 48eae842-558c-4a1d-8cea-dc7ce46a1557
    type: title
    task:
      id: 48eae842-558c-4a1d-8cea-dc7ce46a1557
      version: -1
      name: Triage
      description: ""
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "37"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 265,
          "y": 195
        }
      }
    note: false
  "12":
    id: "12"
    taskid: 7fb1c374-f175-4d6f-8381-6fcb23a11b71
    type: regular
    task:
      id: 7fb1c374-f175-4d6f-8381-6fcb23a11b71
      version: -1
      name: Store the email address of the reporting user
      description: Store the email address of the user that reported the incident.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: Account.Email.Address
      value:
        complex:
          root: incident
          accessor: labels.Email/from
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 910,
          "y": 690
        }
      }
    note: false
  "13":
    id: "13"
    taskid: 1a8b8392-bb45-467b-8913-7becfe1eb971
    type: regular
    task:
      id: 1a8b8392-bb45-467b-8913-7becfe1eb971
      version: -1
      name: Acknowledge incident was received
      description: |
        Send an auto-response to user that reported the incident, informing them the incident was received and being handled.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "2"
    scriptarguments:
      attachIDs: {}
      attachNames: {}
      bcc: {}
      body:
        simple: "Hi ${.=val.Account.DisplayName && val.Email.Address === val.incident.labels['Email/from']
          ? val.Account.DisplayName : val.incident.labels['Email/from']},\nWe've received
          your email and are investigating.\nPlease do not touch the email until further
          notice.\n\nCordially, \n  Your friendly neighborhood security team"
      cc: {}
      htmlBody: {}
      replyTo: {}
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        complex:
          root: incident
          accessor: labels.Email/from
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 910,
          "y": 865
        }
      }
    note: false
  "15":
    id: "15"
    taskid: f380bc98-e0a8-4afa-8ef4-da0c267d76b7
    type: condition
    task:
      id: f380bc98-e0a8-4afa-8ef4-da0c267d76b7
      version: -1
      name: Is the email malicious?
      description: Determine if the email is malicious based on the calculated severity.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "31"
      'Malicious ':
      - "30"
    separatecontext: false
    conditions:
    - label: 'Malicious '
      condition:
      - - operator: greaterThanOrEqual
          left:
            value:
              simple: incident.severity
            iscontext: true
          right:
            value:
              simple: "2"
    view: |-
      {
        "position": {
          "x": 480,
          "y": 1215
        }
      }
    note: false
  "16":
    id: "16"
    taskid: b068accd-b72a-4795-8b87-a472dc4d390e
    type: regular
    task:
      id: b068accd-b72a-4795-8b87-a472dc4d390e
      version: -1
      name: Update the user that the reported email is safe
      description: Send an email to the user explaining that the email they reported
        is safe.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "8"
    scriptarguments:
      attachIDs: {}
      attachNames: {}
      bcc: {}
      body:
        simple: |-
          Hi ${.=val.Account.DisplayName && val.Email.Address === val.incident.labels['Email/from'] ? val.Account.DisplayName : val.incident.labels['Email/from']},
          We've concluded that the email you forwarded to us is safe.
          Thank you for your alertness and your participation in keeping our organization secure.

          Cordially,
            Your security team
      cc: {}
      htmlBody: {}
      replyTo: {}
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        simple: ${incident.labels.Email/from}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 265,
          "y": 2350
        }
      }
    note: false
  "17":
    id: "17"
    taskid: d022c508-37bc-42c2-8a3b-8ebb758311bc
    type: regular
    task:
      id: d022c508-37bc-42c2-8a3b-8ebb758311bc
      version: -1
      name: Update the user that the reported email is malicious
      description: Send an email to the user explaining that the email they reported
        is malicious.
      script: '|||send-mail'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "27"
    scriptarguments:
      attachIDs: {}
      attachNames: {}
      bcc: {}
      body:
        simple: |-
          Hi ${.=val.Account.DisplayName && val.Email.Address === val.incident.labels['Email/from'] ? val.Account.DisplayName : val.incident.labels['Email/from']},
          We've concluded that the email you forwarded to us is malicious. We've taken steps to blacklist the sender and quarantine the email. Good job on detecting and forwarding it to us!

          All the best,
            Your security team
      cc: {}
      htmlBody: {}
      replyTo: {}
      subject:
        simple: 'Re: Phishing Investigation - ${incident.name}'
      to:
        simple: ${incident.labels.Email/from}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 695,
          "y": 2030
        }
      }
    note: false
  "18":
    id: "18"
    taskid: a0b00a3d-6094-47f0-81cd-0848521c938b
    type: title
    task:
      id: a0b00a3d-6094-47f0-81cd-0848521c938b
      version: -1
      name: Engage with User
      description: ""
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "12"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 910,
          "y": 530
        }
      }
    note: false
  "22":
    id: "22"
    taskid: 15c8b77e-d5b5-4079-8aa1-1f6fe05a3ab3
    type: playbook
    task:
      id: 15c8b77e-d5b5-4079-8aa1-1f6fe05a3ab3
      version: -1
      name: Detonate File - Generic
      description: ""
      playbookName: Detonate File - Generic
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    separatecontext: true
    view: |-
      {
        "position": {
          "x": 480,
          "y": 690
        }
      }
    note: false
  "25":
    id: "25"
    taskid: b2fdfd0d-0e76-4cad-893c-6466075b4184
    type: playbook
    task:
      id: b2fdfd0d-0e76-4cad-893c-6466075b4184
      version: -1
      name: Entity Enrichment - Generic
      description: ""
      playbookName: Entity Enrichment - Generic
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "6"
    separatecontext: true
    view: |-
      {
        "position": {
          "x": 50,
          "y": 690
        }
      }
    note: false
  "27":
    id: "27"
    taskid: 31f3c0cc-fbc4-4798-8f7a-d5a1b67ead33
    type: title
    task:
      id: 31f3c0cc-fbc4-4798-8f7a-d5a1b67ead33
      version: -1
      name: Remediate
      description: ""
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "34"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 695,
          "y": 2205
        }
      }
    note: false
  "29":
    id: "29"
    taskid: 6bf8c0b0-cbdd-4e7c-8701-1b4463e99315
    type: title
    task:
      id: 6bf8c0b0-cbdd-4e7c-8701-1b4463e99315
      version: -1
      name: Done
      description: ""
      type: title
      iscommand: false
      brand: ""
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 480,
          "y": 2700
        }
      }
    note: false
  "30":
    id: "30"
    taskid: a8fd738c-c95d-43b6-82cd-9b5c37607d0d
    type: title
    task:
      id: a8fd738c-c95d-43b6-82cd-9b5c37607d0d
      version: -1
      name: Malicious
      description: ""
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 695,
          "y": 1885
        }
      }
    note: false
  "31":
    id: "31"
    taskid: 5ad5eb18-2b82-4d7d-82f5-3afb20c7130f
    type: title
    task:
      id: 5ad5eb18-2b82-4d7d-82f5-3afb20c7130f
      version: -1
      name: Undetermined
      description: ""
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "7"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 275,
          "y": 1390
        }
      }
    note: false
  "33":
    id: "33"
    taskid: 04934c83-5d6d-4b39-8f5d-1ac1c75ba1a9
    type: condition
    task:
      id: 04934c83-5d6d-4b39-8f5d-1ac1c75ba1a9
      version: -1
      name: Is the email malicious?
      description: Is the email that the user reported malicious?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      "No":
      - "16"
      "yes":
      - "30"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 275,
          "y": 1710
        }
      }
    note: false
  "34":
    id: "34"
    taskid: 6e77409a-1ab4-43ca-8983-d243a67f3fb0
    type: regular
    task:
      id: 6e77409a-1ab4-43ca-8983-d243a67f3fb0
      version: -1
      name: Manually remediate  the incident
      description: "Consider the following:\n1. Search for and delete similar emails\n2.
        Inform the organization about the threat\n3. Hunt the relevant IOCs\n4. Update
        proxies and firewalls as necessary\n5. Block the malicious sender/ domain
        in the mail-gateway "
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "8"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 695,
          "y": 2350
        }
      }
    note: false
  "35":
    id: "35"
    taskid: ca48cc1d-4a4b-4af4-8da4-d3f1df888f7a
    type: playbook
    task:
      id: ca48cc1d-4a4b-4af4-8da4-d3f1df888f7a
      version: -1
      name: Extract Indicators From File - Generic
      description: ""
      playbookName: Extract Indicators From File - Generic
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "25"
    separatecontext: true
    view: |-
      {
        "position": {
          "x": 50,
          "y": 515
        }
      }
    note: false
  "37":
    id: "37"
    taskid: 05262fc3-6fc0-4f84-885d-c4b0b53e7366
    type: playbook
    task:
      id: 05262fc3-6fc0-4f84-885d-c4b0b53e7366
      version: -1
      name: Process Email - Generic
      description: ""
      playbookName: Process Email - Generic
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "35"
      - "22"
    scriptarguments:
      Email:
        complex:
          root: incident
          accessor: labels.Email
      Email/cc:
        complex:
          root: incident
          accessor: labels.CC
      Email/format:
        complex:
          root: incident
          accessor: labels.Email/format
      Email/from:
        complex:
          root: incident
          accessor: labels.Email/from
      Email/headers:
        complex:
          root: incident
          accessor: labels.Email/headers
      Email/html:
        complex:
          root: incident
          accessor: labels.Email/html
      Email/subject:
        complex:
          root: incident
          accessor: labels.Email/subject
      Email/text:
        complex:
          root: incident
          accessor: labels.Email/text
      File:
        complex:
          root: File
      GetOriginalEmail:
        complex:
          root: inputs.GetOriginalEmail
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
    view: |-
      {
        "position": {
          "x": 265,
          "y": 340
        }
      }
    note: false
view: |-
  {
    "linkLabelsPosition": {},
    "paper": {
      "dimensions": {
        "height": 2715,
        "width": 1240,
        "x": 50,
        "y": 50
      }
    }
  }
inputs:
- key: Role
  value:
    simple: Administrator
  required: true
  description: The default role to assign the incident to.
- key: SearchAndDelete
  value:
    simple: "False"
  required: false
  description: |-
    Enable the "Search and Delete" capability (can be either "True" or "False").
    In case of a malicious email, the "Search and Delete" sub-playbook will look for other instances of the email and delete them pending analyst approval.
- key: BlockIndicators
  value:
    simple: "False"
  required: false
  description: |-
    Enable the "Block Indicators" capability (can be either "True" or "False").
    In case of a malicious email, the "Block Indicators" sub-playbook will block all malicious indicators in the relevant integrations.
- key: GetOriginalEmail
  value:
    simple: "False"
  required: false
  description: '**add description**'
outputs: []
releaseNotes: "-"
tests:
- Phishing test - attachment
- Phishing test - Inline
