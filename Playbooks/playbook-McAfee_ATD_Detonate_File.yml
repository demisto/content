id: Detonate File - McAfee ATD
version: -1
name: Detonate File - McAfee ATD
fromversion: 4.0.0
description: |-
  Detonates a File using the McAfee Advanced Threat Defense sandbox.
  Advanced Threat Defense supports the following File Types:
  32-bit Portable Executables (PE)files; 64-bit PE+files
  exe, sys, dll, com, scr, cpl, ocx, cgi
  Microsoft Office Suite documents
  doc,dotm, docx, dotx, xls, ppam, xlsx, pps, xlsb, ppsx, xlsm, ppsm, ppt, ppt, pptx, pptm, rtf, shs, xltm, sldm, xltx, sldx, xlam, thmx, docm, xar
  Just Systems Ichitaro documents
  jtd, jtdc
  Adobe
  pdf, swf
  Compressed files
  gz, 7z, tgz, msi, zip, lzh, cab, lzma, rar
  Android application package
  apk, Java, JAR, CLASS, Java Script, Java bin files
  Image files
  jpeg, png, gif
  Other file types
  cmd, ace, bat, arj, vbs, chm, xml, lnk, url, mof, htm, ocx, html, potm, eml, potx, msg, ps1, vb, reg, vba, wsc, vbe, wsf, vbs, wsh
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 96daa53e-7dc4-4627-8ded-f9d2d9effc0e
    type: start
    task:
      id: 96daa53e-7dc4-4627-8ded-f9d2d9effc0e
      version: -1
      name: ""
      description: '-'
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "7"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 50,
          "y": 50
        }
      }
    note: false
  "1":
    id: "1"
    taskid: 9322d482-2fbb-49e2-8eb1-405540d5566f
    type: regular
    task:
      id: 9322d482-2fbb-49e2-8eb1-405540d5566f
      version: -1
      name: McafeeATD Upload File
      description: Uploads the submission to McAfee ATD.
      script: McAfee Advanced Threat Defense|||atd-file-upload
      type: regular
      iscommand: true
      brand: McAfee Advanced Threat Defense
    nexttasks:
      '#none#':
      - "8"
    scriptarguments:
      analyzeAgain: {}
      dstIp: {}
      entryID:
        complex:
          root: inputs.File.EntryID
      fileName: {}
      filePriorityQ: {}
      messageId: {}
      skipTaskId: {}
      srcIp: {}
      submitType:
        simple: "0"
      url: {}
      vmProfileList: {}
      xMode: {}
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 387.5,
          "y": 895
        }
      }
    note: false
  "2":
    id: "2"
    taskid: 7a66e1e0-9aee-47ea-8656-d5fb893e4534
    type: playbook
    task:
      id: 7a66e1e0-9aee-47ea-8656-d5fb893e4534
      version: -1
      name: GenericPolling
      description: |-
        Use as a sub-playbook to block execution of the master playbook until a remote action is complete.
        This playbook implements polling by continually running the command in Step #2 until the operation completes.
        The remote action should have the following structure:

        1. Initiate the operation.
        2. Poll to check if the operation completed.
        3. (optional) Get the results of the operation.
      playbookName: GenericPolling
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "9"
    scriptarguments:
      Ids:
        complex:
          root: ATD.Task.taskId
      Interval:
        complex:
          root: inputs.Interval
      PollingCommandArgName:
        simple: taskId
      PollingCommandName:
        simple: atd-check-status
      Timeout:
        complex:
          root: inputs.Timeout
      dt:
        simple: ATD.Task(val.status != 'Completed').taskId
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
    view: |-
      {
        "position": {
          "x": 500,
          "y": 1245
        }
      }
    note: false
  "3":
    id: "3"
    taskid: a0bd90bf-819c-4cdc-8042-b2fec7d11fba
    type: regular
    task:
      id: a0bd90bf-819c-4cdc-8042-b2fec7d11fba
      version: -1
      name: McAfeeATD Get Report
      description: Retrieve the reports from McAfee ATD.
      script: McAfee Advanced Threat Defense|||atd-get-report
      type: regular
      iscommand: true
      brand: McAfee Advanced Threat Defense
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      jobId: {}
      taskId:
        complex:
          root: ATD
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: ATD.Task.status
                iscontext: true
              right:
                value:
                  simple: Completed
          accessor: Task
          transformers:
          - operator: getField
            args:
              field:
                value:
                  simple: taskId
      threshold: {}
      type:
        simple: pdf
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 500,
          "y": 1595
        }
      }
    note: false
  "5":
    id: "5"
    taskid: d99dfba4-ef07-4d4e-8d1e-df1efb3f4b98
    type: title
    task:
      id: d99dfba4-ef07-4d4e-8d1e-df1efb3f4b98
      version: -1
      name: Done
      description: finished
      type: title
      iscommand: false
      brand: ""
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 70,
          "y": 1770
        }
      }
    note: false
  "7":
    id: "7"
    taskid: 21b70868-a0cc-42a9-82af-df2a7f50f0b3
    type: condition
    task:
      id: 21b70868-a0cc-42a9-82af-df2a7f50f0b3
      version: -1
      name: Is McAfee ATD sandbox enabled?
      description: |
        Verify that there is a valid instance of McAfee ATD enabled.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      "yes":
      - "12"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: modules
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.brand
                      iscontext: true
                    right:
                      value:
                        simple: McAfee Advanced Threat Defense
                - - operator: isEqualString
                    left:
                      value:
                        simple: modules.state
                      iscontext: true
                    right:
                      value:
                        simple: active
                accessor: brand
            iscontext: true
    view: |-
      {
        "position": {
          "x": 50,
          "y": 195
        }
      }
    note: false
  "8":
    id: "8"
    taskid: 03944d64-6abd-48ad-8867-18784038057b
    type: condition
    task:
      id: 03944d64-6abd-48ad-8867-18784038057b
      version: -1
      name: Filter taskId
      description: Checks that valid files only have been sent to detonation.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      "yes":
      - "2"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: ATD
                filters:
                - - operator: isNotEqualNumber
                    left:
                      value:
                        simple: ATD.Task.taskId
                      iscontext: true
                    right:
                      value:
                        simple: "-1"
                accessor: Task
                transformers:
                - operator: getField
                  args:
                    field:
                      value:
                        simple: taskId
            iscontext: true
    view: |-
      {
        "position": {
          "x": 387.5,
          "y": 1070
        }
      }
    note: false
  "9":
    id: "9"
    taskid: 47b0dcaa-96e7-4bb9-81ff-7281e13098ff
    type: regular
    task:
      id: 47b0dcaa-96e7-4bb9-81ff-7281e13098ff
      version: -1
      name: atd-check-status
      description: Updates the status of the tasks in the context.
      script: McAfee Advanced Threat Defense|||atd-check-status
      type: regular
      iscommand: true
      brand: McAfee Advanced Threat Defense
    nexttasks:
      '#none#':
      - "3"
    scriptarguments:
      jobId: {}
      taskId:
        complex:
          root: ATD.Task.taskId
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 500,
          "y": 1420
        }
      }
    note: false
  "10":
    id: "10"
    taskid: e31d8838-ba49-481b-8f63-ad0e147447f0
    type: condition
    task:
      id: e31d8838-ba49-481b-8f63-ad0e147447f0
      version: -1
      name: Is File type supported?
      description: Check if file type is supported.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      "yes":
      - "1"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              complex:
                root: File
                filters:
                - - operator: match
                    left:
                      value:
                        simple: File.Type
                      iscontext: true
                    right:
                      value:
                        simple: .*(?:EXE|SYS|DLL|COM|SCR|CPL|OCX|CGI|DOC|DOTM|DOCX|DOTX|XLS|PPAM|XSLX|PPS|XLSB|PPSX|XLSM|PPSM|PPT|PPTX|PPTM|RTF|SHS|XLTM|SLDM|XLTX|SLDX|XLAM|THMX|DOCM|XAR|JTD|JTDC|PDF|SWF|GZ|7Z|TGZ|MSI|ZIP|LZH|CAB|LZMA|APK|JAR|CLASS|JPEG|PNG|GIF|CMD|ACE|BAT|ARJ|VBS|CHM|XML|LNK|URL|MOF|HTM|OCX|HTML|POTM|EML|POTX|MSG|PS1|VB|REG|VBA|WSC|VBE|WSF|VBS|WSH)\b
                    ignorecase: true
                  - operator: match
                    left:
                      value:
                        simple: File.Extension
                      iscontext: true
                    right:
                      value:
                        simple: .*(?:EXE|SYS|DLL|COM|SCR|CPL|OCX|CGI|DOC|DOTM|DOCX|DOTX|XLS|PPAM|XSLX|PPS|XLSB|PPSX|XLSM|PPSM|PPT|PPTX|PPTM|RTF|SHS|XLTM|SLDM|XLTX|SLDX|XLAM|THMX|DOCM|XAR|JTD|JTDC|PDF|SWF|GZ|7Z|TGZ|MSI|ZIP|LZH|CAB|LZMA|APK|JAR|CLASS|JPEG|PNG|GIF|CMD|ACE|BAT|ARJ|VBS|CHM|XML|LNK|URL|MOF|HTM|OCX|HTML|POTM|EML|POTX|MSG|PS1|VB|REG|VBA|WSC|VBE|WSF|VBS|WSH)\b
                    ignorecase: true
                  - operator: match
                    left:
                      value:
                        simple: File.Info
                      iscontext: true
                    right:
                      value:
                        simple: .*(?:EXE|SYS|DLL|COM|SCR|CPL|OCX|CGI|DOC|DOTM|DOCX|DOTX|XLS|PPAM|XSLX|PPS|XLSB|PPSX|XLSM|PPSM|PPT|PPTX|PPTM|RTF|SHS|XLTM|SLDM|XLTX|SLDX|XLAM|THMX|DOCM|XAR|JTD|JTDC|PDF|SWF|GZ|7Z|TGZ|MSI|ZIP|LZH|CAB|LZMA|APK|JAR|CLASS|JPEG|PNG|GIF|CMD|ACE|BAT|ARJ|VBS|CHM|XML|LNK|URL|MOF|HTM|OCX|HTML|POTM|EML|POTX|MSG|PS1|VB|REG|VBA|WSC|VBE|WSF|VBS|WSH)\b
                    ignorecase: true
                accessor: EntryID
            iscontext: true
          ignorecase: true
    view: |-
      {
        "position": {
          "x": 275,
          "y": 720
        }
      }
    note: false
  "11":
    id: "11"
    taskid: 7f9c3d69-1369-4a6d-81bd-494dd37e4248
    type: regular
    task:
      id: 7f9c3d69-1369-4a6d-81bd-494dd37e4248
      version: -1
      name: Set File to context
      description: Set the file object into context.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "10"
    scriptarguments:
      append: {}
      key:
        simple: File
      value:
        complex:
          root: inputs.File
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 275,
          "y": 545
        }
      }
    note: false
  "12":
    id: "12"
    taskid: bf9c5c89-4440-432a-8071-b1d1a2784be7
    type: condition
    task:
      id: bf9c5c89-4440-432a-8071-b1d1a2784be7
      version: -1
      name: Is there a File to Detonate?
      description: Checks that there is a file in the playbookâ€™s input.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "5"
      "yes":
      - "11"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isExists
          left:
            value:
              simple: inputs.File
            iscontext: true
    view: |-
      {
        "position": {
          "x": 216,
          "y": 391
        }
      }
    note: false
view: |-
  {
    "linkLabelsPosition": {},
    "paper": {
      "dimensions": {
        "height": 1785,
        "width": 830,
        "x": 50,
        "y": 50
      }
    }
  }
inputs:
- key: File
  value:
    complex:
      root: File
  required: false
  description: The file to detonate. File is taken from the context.
- key: Interval
  value:
    simple: "1"
  required: false
  description: Polling frequency - how often the polling command should run (minutes)
- key: Timeout
  value:
    simple: "15"
  required: false
  description: How much time to wait before a timeout occurs (minutes)
outputs:
- contextPath: DBotScore.Type
  description: The type of the indicator (only in case of report type=json)
  type: string
- contextPath: InfoFile.EntryID
  description: The EntryID of the report file
- contextPath: DBotScore.Vendor
  description: Vendor used to calculate the score (only in case of report type=json)
  type: string
- contextPath: IP.Address
  description: IP's relevant to the sample
  type: string
- contextPath: DBotScore.Score
  description: The actual score (only in case of report type=json)
  type: number
- contextPath: DBotScore.Indicator
  description: The indicator we tested (only in case of report type=json)
  type: string
- contextPath: InfoFile.Extension
  description: The extension of the report file
  type: string
- contextPath: InfoFile.Name
  description: The name of the report file
  type: string
- contextPath: InfoFile.Info
  description: The info of the report file
  type: string
- contextPath: InfoFile.Size
  description: The size of the report file
  type: number
- contextPath: InfoFile.Type
  description: The type of the report file
  type: string
releaseNotes: "-"