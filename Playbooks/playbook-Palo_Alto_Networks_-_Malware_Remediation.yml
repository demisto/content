id: Palo Alto Networks - Malware Remediation
version: -1
name: Palo Alto Networks - Malware Remediation
description: This Playbook performs malicious IOC remediation using Palo Alto Networks
  integrations.
starttaskid: "0"
fromversion: 4.5.0
tasks:
  "0":
    id: "0"
    taskid: adb3c4fd-1bc9-4283-886c-139ad1c3364b
    type: start
    task:
      id: adb3c4fd-1bc9-4283-886c-139ad1c3364b
      version: -1
      name: ""
      description: ""
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "39"
      - "40"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1230,
          "y": 230
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "3":
    id: "3"
    taskid: c982eec5-0af4-4065-86de-dc0b32527693
    type: playbook
    task:
      id: c982eec5-0af4-4065-86de-dc0b32527693
      version: -1
      name: Add Indicator to Miner - Palo Alto MineMeld
      description: Add indicators to the relevant Miner using MineMeld.
      playbookName: Add Indicator to Miner - Palo Alto MineMeld
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      Indicator:
        complex:
          root: inputs.IP
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: inputs.URL
                iscontext: true
          - operator: join
            args:
              separator:
                value:
                  simple: ','
      MinerName:
        complex:
          root: inputs.Miner
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
    view: |-
      {
        "position": {
          "x": 2650,
          "y": 1030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "4":
    id: "4"
    taskid: e55528f0-40c6-455c-865c-88f61ab2b5ca
    type: title
    task:
      id: e55528f0-40c6-455c-865c-88f61ab2b5ca
      version: -1
      name: PAN OS - Custom URL Category
      description: ""
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 210,
          "y": 510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "8":
    id: "8"
    taskid: a0c30c06-f029-4353-8174-184599e10235
    type: title
    task:
      id: a0c30c06-f029-4353-8174-184599e10235
      version: -1
      name: PAN OS - Dynamic Address Group
      description: ""
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "12"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 800,
          "y": 510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "11":
    id: "11"
    taskid: 4e6e3319-33cf-4400-8eda-003f4fb401e8
    type: title
    task:
      id: 4e6e3319-33cf-4400-8eda-003f4fb401e8
      version: -1
      name: Done
      description: ""
      type: title
      iscommand: false
      brand: ""
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1230,
          "y": 1200
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "12":
    id: "12"
    taskid: f0493764-ccaa-4068-8aef-ee47c042d285
    type: condition
    task:
      id: f0493764-ccaa-4068-8aef-ee47c042d285
      version: -1
      name: Use Dynamic Address Group?
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "11"
      "yes":
      - "49"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: inputs.DAG
            iscontext: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.IP
            iscontext: true
    view: |-
      {
        "position": {
          "x": 800,
          "y": 640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "13":
    id: "13"
    taskid: 2aa3cc8b-26d6-41f4-8805-78e9cf9514b3
    type: condition
    task:
      id: 2aa3cc8b-26d6-41f4-8805-78e9cf9514b3
      version: -1
      name: Use Custom URL Category?
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "11"
      "yes":
      - "42"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.CustomURLCategory
            iscontext: true
    view: |-
      {
        "position": {
          "x": 210,
          "y": 640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "14":
    id: "14"
    taskid: 20c4f0d7-d0df-4f3a-8fdf-f993ff2298ab
    type: title
    task:
      id: 20c4f0d7-d0df-4f3a-8fdf-f993ff2298ab
      version: -1
      name: PAN OS - Custom Block Rule
      description: ""
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "15"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -980,
          "y": 510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "15":
    id: "15"
    taskid: d3bd51ea-c8ec-423c-828f-c01643ee987d
    type: condition
    task:
      id: d3bd51ea-c8ec-423c-828f-c01643ee987d
      version: -1
      name: Use Custom Block Rules?
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "11"
      "yes":
      - "41"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isEqualString
          left:
            value:
              simple: inputs.CustomBlockRule
            iscontext: true
          right:
            value:
              simple: "True"
    view: |-
      {
        "position": {
          "x": -980,
          "y": 650
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "18":
    id: "18"
    taskid: 337db9ed-cbee-401e-8a60-d3350b1bc176
    type: title
    task:
      id: 337db9ed-cbee-401e-8a60-d3350b1bc176
      version: -1
      name: Block IP/URL IOCs - EDL
      description: ""
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "20"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 1660,
          "y": 510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "20":
    id: "20"
    taskid: 4e073370-2f58-4137-8de1-418ea248707d
    type: condition
    task:
      id: 4e073370-2f58-4137-8de1-418ea248707d
      version: -1
      name: Use External Dynamic List?
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "11"
      "yes":
      - "50"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: inputs.IPListName
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              simple: inputs.URLListName
            iscontext: true
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.EDLServerIP
            iscontext: true
    view: |-
      {
        "position": {
          "x": 1660,
          "y": 640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "39":
    id: "39"
    taskid: 9363d5f6-c255-4572-8c51-d7eefea29e36
    type: title
    task:
      id: 9363d5f6-c255-4572-8c51-d7eefea29e36
      version: -1
      name: PAN OS Remediation
      description: ""
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "14"
      - "8"
      - "4"
      - "18"
      - "43"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 470,
          "y": 370
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "40":
    id: "40"
    taskid: 04c776c9-3fcd-427b-83a1-b53188e23f1b
    type: title
    task:
      id: 04c776c9-3fcd-427b-83a1-b53188e23f1b
      version: -1
      name: Update TI - MimeMeld
      description: ""
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "46"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": 2250,
          "y": 370
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "41":
    id: "41"
    taskid: c1281ac2-d444-4d5c-814f-2c9fd4f39733
    type: playbook
    task:
      id: c1281ac2-d444-4d5c-814f-2c9fd4f39733
      version: -1
      name: PAN-OS - Block IP - Custom Block Rule
      description: |-
        This playbook blocks IP addresses using Palo Alto Networks Panorama or Firewall using Custom Block Rules.
        The playbook receives malicious IP addresses as inputs, creates a custom bi-directional rule to block them, and commits
        the configuration.

        ***Note - The playbook does not check if the IP address is already blocked.
      playbookName: PAN-OS - Block IP - Custom Block Rule
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      AutoCommit:
        complex:
          root: inputs.AutoCommit
      IP:
        complex:
          root: inputs.IP
      LogForwarding:
        complex:
          root: inputs.LogForwarding
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
    view: |-
      {
        "position": {
          "x": -980,
          "y": 1030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "42":
    id: "42"
    taskid: b015e7b0-3e3f-4b57-8485-b8295a005a1a
    type: playbook
    task:
      id: b015e7b0-3e3f-4b57-8485-b8295a005a1a
      version: -1
      name: PAN-OS - Block URL - Custom URL Category
      description: |-
        This playbook blocks URLs using Palo Alto Networks Panorama or Firewall using Custom URL Categories.
        The playbook checks whether the input URL category already exists, and if the URLs are a part of this category. 
        Otherwise, it creates the category, blocks the URLs, and commits the configuration.
      playbookName: PAN-OS - Block URL - Custom URL Category
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      AutoCommit:
        complex:
          root: inputs.AutoCommit
      CustomURLCategory:
        complex:
          root: inputs.CustomURLCategory
      LogForwarding:
        complex:
          root: inputs.LogForwarding
      URL:
        complex:
          root: inputs.URL
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
    view: |-
      {
        "position": {
          "x": 210,
          "y": 1030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "43":
    id: "43"
    taskid: d19bb712-ec3e-4633-87bc-dc251fda55e2
    type: title
    task:
      id: d19bb712-ec3e-4633-87bc-dc251fda55e2
      version: -1
      name: PAN OS - Static Address Group
      description: ""
      type: title
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "44"
    separatecontext: false
    view: |-
      {
        "position": {
          "x": -390,
          "y": 510
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "44":
    id: "44"
    taskid: 8dec314c-29f4-45bd-8094-7e74be7a23d8
    type: condition
    task:
      id: 8dec314c-29f4-45bd-8094-7e74be7a23d8
      version: -1
      name: Use Static Address Group?
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "11"
      "yes":
      - "45"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.StaticAddressGroup
            iscontext: true
    view: |-
      {
        "position": {
          "x": -390,
          "y": 640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "45":
    id: "45"
    taskid: bec0674c-909a-4a38-8aaa-6ba82b91a6b6
    type: playbook
    task:
      id: bec0674c-909a-4a38-8aaa-6ba82b91a6b6
      version: -1
      name: PAN-OS - Block IP - Static Address Group
      description: |-
        This playbook blocks IP addresses using Palo Alto Networks Panorama or Firewall using Static Address Groups.
        The playbook receives malicious IP addresses and an address group name as inputs, checks if the addresses 
        are not already a part of the address group, adds them and commits the configuration.

        ***Note - The playbook does not block the address group communication using a policy block rule. This step
        will be executed once outside of the playbook.
      playbookName: PAN-OS - Block IP - Static Address Group
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      AddressGroupName:
        complex:
          root: inputs.StaticAddressGroup
      AutoCommit:
        complex:
          root: inputs.AutoCommit
      IP:
        complex:
          root: inputs.IP
      LogForwarding:
        complex:
          root: inputs.LogForwarding
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
    view: |-
      {
        "position": {
          "x": -390,
          "y": 1030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "46":
    id: "46"
    taskid: fee48f31-8a5b-4e0c-881e-23dbc170da99
    type: condition
    task:
      id: fee48f31-8a5b-4e0c-881e-23dbc170da99
      version: -1
      name: Use Minemeld?
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "11"
      "yes":
      - "47"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: inputs.Miner
            iscontext: true
    view: |-
      {
        "position": {
          "x": 2250,
          "y": 640
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "47":
    id: "47"
    taskid: 2f96958c-7052-474c-847b-c227a08d2900
    type: condition
    task:
      id: 2f96958c-7052-474c-847b-c227a08d2900
      version: -1
      name: Are there indicators to update?
      description: ""
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "11"
      "yes":
      - "3"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.IP
            iscontext: true
        - operator: isNotEmpty
          left:
            value:
              complex:
                root: inputs.URL
            iscontext: true
    view: |-
      {
        "position": {
          "x": 2480,
          "y": 810
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "49":
    id: "49"
    taskid: e7eca846-8780-4a9c-8b04-95cf206d4510
    type: playbook
    task:
      id: e7eca846-8780-4a9c-8b04-95cf206d4510
      version: -1
      name: PAN-OS DAG Configuration
      description: "This playbook utilizes the Dynamic Address Group (DAG) capability
        of PAN-OS.\nDAG enables analysts to create a rule one time, where the group
        is the source/destination, and adds IP addresses dynamically without the need
        to commit the configuration every time.\n\nThe playbook checks if the given
        tag already exists. If the tag exists, the IP address is added to the
        tag.\n\nIf the tag does not exist, a new address group is created with the
        given tag and a matching rule, and the configuration is committed. \n"
      playbookName: PAN-OS DAG Configuration
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      address_group_name:
        simple: Demisto - Remediation IP Address Group
      auto_commit:
        complex:
          root: inputs.AutoCommit
      ip_list:
        complex:
          root: inputs.IP
      log-forwarding-object-name:
        complex:
          root: inputs.LogForwarding
          filters:
          - - operator: isNotEmpty
              left:
                value:
                  simple: inputs.LogForwarding
                iscontext: true
      rule_name:
        simple: Demisto Block Rule - ${incident.id}
      tag_name:
        complex:
          root: inputs.DAG
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
    view: |-
      {
        "position": {
          "x": 800,
          "y": 1030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
  "50":
    id: "50"
    taskid: 8bf3f18e-81d8-40c5-854a-ebb5571420f0
    type: playbook
    task:
      id: 8bf3f18e-81d8-40c5-854a-ebb5571420f0
      version: -1
      name: PAN-OS - Block IP and URL - External Dynamic List
      description: |-
        This playbook blocks IP addresses and URLs using Palo Alto Networks Panorama or Firewall External Dynamic Lists.
        It checks if the EDL configuration is in place with the 'PAN-OS EDL Setup' sub-playbook (otherwise the list
        is configured), and adds the input IPs and URLs to the relevant lists.
      playbookName: PAN-OS - Block IP and URL - External Dynamic List
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "11"
    scriptarguments:
      AutoCommit:
        complex:
          root: inputs.AutoCommit
      EDLServerIP:
        complex:
          root: inputs.EDLServerIP
      IP:
        complex:
          root: inputs.IP
          transformers:
          - operator: uniq
      IPListName:
        complex:
          root: inputs.IPListName
      LogForwarding:
        complex:
          root: inputs.LogForwarding
          filters:
          - - operator: isNotEmpty
              left:
                value:
                  simple: inputs.LogForwarding
                iscontext: true
      URL:
        complex:
          root: inputs.URL
          transformers:
          - operator: uniq
      URLListName:
        complex:
          root: inputs.URLListName
    separatecontext: true
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
    view: |-
      {
        "position": {
          "x": 1660,
          "y": 1030
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
view: |-
  {
    "linkLabelsPosition": {
      "12_11_#default#": 0.37,
      "13_11_#default#": 0.17,
      "13_42_yes": 0.71,
      "15_11_#default#": 0.1,
      "15_41_yes": 0.73,
      "20_11_#default#": 0.36,
      "44_11_#default#": 0.12,
      "44_45_yes": 0.71,
      "46_11_#default#": 0.24,
      "47_11_#default#": 0.16
    },
    "paper": {
      "dimensions": {
        "height": 1035,
        "width": 4010,
        "x": -980,
        "y": 230
      }
    }
  }
inputs:
- key: DAG
  value: {}
  required: false
  description: |-
    This input establishes whether Palo Alto Networks Panorama or Firewall Dynamic Address Groups are used.
    Specify Dynamic Address Group tag name for IP handling.
- key: CustomURLCategory
  value: {}
  required: false
  description: |-
    This input establishes whether Palo Alto Networks Panorama or Firewall Custom URL Categories are used.
    Specify Category name for URL handling.
- key: CustomBlockRule
  value:
    simple: "False"
  required: false
  description: |
    This input establishes whether Palo Alto Networks Panorama or Firewall Custom block rules are used.
    Specify True to use Custom Block Rules.
- key: IPListName
  value: {}
  required: false
  description: |-
    This input establishes whether Palo Alto Networks Panorama or Firewall External Dynamic Lists, are used for IP Blockage.
    Specify the EDL name for IP handling.
- key: IP
  value:
    complex:
      root: IP
      filters:
      - - operator: isExists
          left:
            value:
              simple: IP.Malicious
            iscontext: true
      accessor: Address
      transformers:
      - operator: uniq
  required: false
  description: Malicious IP Addresses to block.
- key: URL
  value:
    complex:
      root: URL
      filters:
      - - operator: isExists
          left:
            value:
              simple: URL.Malicious
            iscontext: true
      accessor: Data
      transformers:
      - operator: uniq
  required: false
  description: Malicious URLs to block.
- key: LogForwarding
  value: {}
  required: false
  description: Panorama log forwarding object name.
- key: StaticAddressGroup
  value: {}
  required: false
  description: |-
    This input establishes whether Palo Alto Networks Panorama or Firewall Static address groups are used.
    Specify Static address group name for IP handling.
- key: Miner
  value: {}
  required: false
  description: |-
    This input establishes whether Palo Alto Networks Minemeld is used. Specify Miner name to
    update with the malicious indicators.
- key: AutoCommit
  value:
    simple: "No"
  required: false
  description: |-
    This input establishes whether to commit the configuration automatically.
    Yes - Commit automatically.
    No - Commit manually.
- key: URLListName
  value: {}
  required: false
  description: |-
    This input establishes whether Palo Alto Networks Panorama or Firewall External Dynamic Lists are used for URL Blockage.
    Specify the EDL name for URL handling.
- key: EDLServerIP
  value: {}
  required: false
  description: |-
    This input establishes whether Palo Alto Networks Panorama or Firewall External Dynamic Lists are used:
    * The IP address of the web server on which the files are stored.
    * The web server IP address is configured in the integration instance.
outputs: []
tests:
  - Palo Alto Networks - Malware Remediation Test
