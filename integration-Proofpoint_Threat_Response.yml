beta: true
category: Email Gateway
commonfields:
  id: Proofpoint Threat Response
  version: -1
configuration:
- defaultvalue: ""
  display: Server URL (e.g. https://192.168.0.1)
  name: url
  required: true
  type: 0
- defaultvalue: ""
  display: API Key
  name: apikey
  required: true
  type: 4
- defaultvalue: "true"
  display: Trust any certificate (unsecure)
  name: insecure
  required: false
  type: 8
- defaultvalue: "false"
  display: Use system proxy
  name: proxy
  required: false
  type: 8
- defaultvalue: ""
  display: ID of IPs blacklist
  name: blacklist_ip
  required: false
  type: 0
- defaultvalue: ""
  display: ID of Domains blacklist
  name: blacklist_domain
  required: false
  type: 0
- defaultvalue: ""
  display: ID of URLs blacklist
  name: blacklist_url
  required: false
  type: 0
- defaultvalue: ""
  display: ID of hashes blacklist
  name: blacklist_hash
  required: false
  type: 0
description: Threat management platform to orchestrate and automate incident response.
detaileddescription: |
  In order to create API Key
    Settings -> API Key -> Add api key
    Note: This is a beta Integration, which lets you implement and test pre-release software. Since the integration is beta, it might contain bugs. Updates to the integration during the beta phase might include non-backward compatible features. We appreciate your feedback on the quality and usability of the integration to help us identify issues, fix them, and continually improve.
display: Proofpoint Threat Response (Beta)
image: data:image/png;base64,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
name: Proofpoint Threat Response
script:
  commands:
  - arguments:
    - description: ID of the list
      name: list-id
      required: true
    description: Get list items
    name: proofpoint-tr-get-list
  - arguments:
    - name: list-id
      required: true
    - description: 'Could be ip,url,domain,hash. For example: "192.168.1.1,192.168.1.2"'
      isArray: true
      name: indicator
      required: true
    - description: Comment regarding the member
      name: comment
    - description: Expiration of the  member
      name: expiration
    description: Add member to list
    execution: true
    name: proofpoint-tr-add-to-list
  - arguments:
    - description: List of IPs
      isArray: true
      name: ip
      required: true
    - description: Expiration of the IP
      name: expiration
    description: 'Block IP '
    execution: true
    name: proofpoint-tr-block-ip
  - arguments:
    - description: List of domains
      isArray: true
      name: domain
      required: true
    - description: Expiration of the Domain
      name: expiration
    description: Block Domain
    name: proofpoint-tr-block-domain
  - arguments:
    - description: ID of the list
      name: list-id
      required: true
    - description: Filter for the search. For example, "1.1" will return [1.1.1.1,
        22.22.1.1,1.1.22.22]
      name: filter
      required: true
    description: 'Return a list of indicators '
    name: proofpoint-tr-search-indicator
  - arguments:
    - description: ID of the list
      name: list-id
      required: true
    - description: 'Could be ip,url,domain,hash. For example: "demisto.com"'
      name: indicator
      required: true
    description: Delete an indicator from a list
    name: proofpoint-tr-delete-indicator
  - arguments:
    - description: List of URLs
      isArray: true
      name: url
      required: true
    - description: Expiration of the URLs
      name: expiration
    description: Block URL
    name: proofpoint-tr-block-url
  - arguments:
    - description: List of hashes
      isArray: true
      name: hash
      required: true
    - description: Expiration of the hash
      name: expiration
    description: Block hash
    name: proofpoint-tr-block-hash
  runonce: false
  script: |2-


    ''' IMPORTS '''
    import requests
    import json
    requests.packages.urllib3.disable_warnings()

    if not demisto.getParam('proxy'):
        del os.environ['HTTP_PROXY']
        del os.environ['HTTPS_PROXY']
        del os.environ['http_proxy']
        del os.environ['https_proxy']

    ''' GLOBAL VARS '''
    BASE_URL = demisto.params().get('url')
    if BASE_URL[-1] != '/':
        BASE_URL += '/'
    API_KEY = demisto.params().get('apikey')
    VERIFY_CERTIFICATE = False

    ''' COMMAND FUNCTIONS '''


    def get_list(list_id):
        fullurl = BASE_URL + 'api/lists/{}/members.json'.format(list_id)
        res = requests.get(
            fullurl,
            headers={
                'Content-Type': 'application/json',
                'Authorization': API_KEY
            },
            verify=VERIFY_CERTIFICATE
        )

        if res.status_code < 200 or res.status_code >= 300:
            return_error('Get list failed. URL: {}, StatusCode: {}, Response: {}'.format(fullurl, res.status_code, res.text))

        return res.json()


    def get_list_command():
        ''' Retrieves all indicators of a the given list ID in Threat Response '''
        list_id = demisto.args().get('list-id')
        list_items = get_list(list_id)

        demisto.results({'list': list_items})


    def add_to_list(list_id, indicator, comment, expiration):
        fullurl = BASE_URL + 'api/lists/{}/members.json'.format(list_id)

        indicator = {
            'member': indicator
        }
        if comment:
            indicator['description'] = comment

        if expiration:
            indicator['expiration'] = expiration

        res = requests.post(
            fullurl,
            headers={
                'Authorization': API_KEY
            },
            verify=VERIFY_CERTIFICATE,
            json=indicator
        )

        if res.status_code < 200 or res.status_code >= 300:
            return_error('Add to list failed. URL: {}, Request Body: {}, StatusCode: {}, Response: {}'.format(
                fullurl, json.dumps(indicator), res.status_code, res.content))

        return res.json()


    def add_to_list_command():
        ''' Adds given indicators to the given list ID in Threat Response '''
        list_id = demisto.args().get('list-id')
        indicators = argToList(demisto.args().get('indicator'))
        comment = demisto.args().get('comment')
        expiration = demisto.args().get('expiration')

        message = ''
        for indicator in indicators:
            add_to_list(list_id, indicator, comment, expiration)
            message += '{} added successfully to {}\n'.format(indicator, list_id)

        demisto.results(message)


    def block_ip_command():
        ''' Adds given IPs to the relevant blacklist in Threat Response '''
        list_id = demisto.params().get('blacklist_ip')
        ips = argToList(demisto.args().get('ip'))
        expiration = demisto.args().get('expiration')

        message = ''
        for ip in ips:
            add_to_list(list_id, ip, None, expiration)
            message += '{} added successfully to block_ip list\n'.format(ip)

        demisto.results(message)


    def block_domain_command():
        ''' Adds given domains to the relevant blacklist in Threat Response '''
        list_id = demisto.params().get('blacklist_domain')
        domains = argToList(demisto.args().get('domain'))
        expiration = demisto.args().get('expiration')

        message = ''
        for domain in domains:
            add_to_list(list_id, domain, None, expiration)
            message += '{} added successfully to block_domain list\n'.format(domain)

        demisto.results(message)


    def block_url_command():
        ''' Adds given URLs to the relevant blacklist in Threat Response '''
        list_id = demisto.params().get('blacklist_url')
        urls = argToList(demisto.args().get('url'))
        expiration = demisto.args().get('expiration')

        message = ''
        for url in urls:
            add_to_list(list_id, url, None, expiration)
            message += '{} added successfully to block_url list\n'.format(url)

        demisto.results(message)


    def block_hash_command():
        ''' Adds given hashes to the relevant blacklist in Threat Response '''
        list_id = demisto.params().get('blacklist_hash')
        hashes = argToList(demisto.args().get('hash'))
        expiration = demisto.args().get('expiration')

        message = ''
        for h in hashes:
            add_to_list(list_id, h, None, expiration)
            message += '{} added successfully to block_hash list\n'.format(h)

        demisto.results(message)


    def search_indicators(list_id, indicator_filter):
        list_indicators = get_list(list_id)
        found_items = []
        for item in list_indicators:
            item_indicator = demisto.get(item, 'host.host')
            if indicator_filter in item_indicator:
                found_items.append(item)

        return found_items


    def search_indicator_command():
        ''' Retrieves indicators of a list, using a filter '''
        list_id = demisto.args().get('list-id')
        indicator_filter = demisto.args().get('filter')
        found = search_indicators(list_id, indicator_filter)

        demisto.results({'indicators': found})


    def delete_indicator(list_id, indicator_filter):
        indicator = search_indicators(list_id, indicator_filter)
        if len(indicator) == 0:
            return_error('{} not exists in {}'.format(indicator_filter, list_id))

        indicator_id = indicator.get('id')  # pylint: disable=E1101
        fullurl = BASE_URL + 'api/lists/{}/members/{}.json'.format(list_id, indicator_id)
        res = requests.delete(
            fullurl,
            headers={
                'Authorization': API_KEY
            },
            verify=VERIFY_CERTIFICATE
        )
        if res.status_code < 200 or res.status_code >= 300:
            return_error('Delete indicator failed. URL: {}, StatusCode: {}, Response: {}'.format(fullurl, res.status_code, res.text))


    def delete_indicator_command():
        ''' Deletes an indicator from a list '''
        list_id = demisto.args().get('list-id')
        indicator = demisto.args().get('indicator')
        delete_indicator(list_id, indicator)

        demisto.results('{} deleted successfully from list {}'.format(list_id, indicator))


    def test():
        get_list(demisto.params().get('blacklist_ip'))


    ''' EXECUTION CODE '''
    LOG('command is %s' % (demisto.command(), ))
    if demisto.command() == 'test-module':
        test()
        demisto.results('ok')

    elif demisto.command() == 'proofpoint-tr-get-list':
        get_list_command()

    elif demisto.command() == 'proofpoint-tr-add-to-list':
        add_to_list_command()

    elif demisto.command() == 'proofpoint-tr-block-ip':
        block_ip_command()

    elif demisto.command() == 'proofpoint-tr-block-domain':
        block_domain_command()

    elif demisto.command() == 'proofpoint-tr-block-url':
        block_url_command()

    elif demisto.command() == 'proofpoint-tr-block-hash':
        block_hash_command()

    elif demisto.command() == 'proofpoint-tr-delete-indicator':
        delete_indicator_command()

    elif demisto.command() == 'proofpoint-tr-search-indicator':
        search_indicator_command()
  type: python
system: true
