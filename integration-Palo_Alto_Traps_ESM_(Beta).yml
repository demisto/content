beta: true
category: Endpoint
commonfields:
  id: Palo Alto Traps ESM (Beta)
  version: -1
configuration:
- defaultvalue: ""
  display: URL of Traps ESM Server
  name: url
  required: true
  type: 0
- defaultvalue: ""
  display: Username of Account to be used.
  name: username
  required: false
  type: 0
- defaultvalue: ""
  display: Password of Account to be used.
  name: password
  required: false
  type: 4
description: Palo Alto Traps ESM beta integration.
detaileddescription: |
  Note: This is a beta Integration, which lets you implement and test pre-release software. Since the integration is beta, it might contain bugs. Updates to the integration during the beta phase might include non-backward compatible features. We appreciate your feedback on the quality and usability of the integration to help us identify issues, fix them, and continually improve.
display: Palo Alto Traps ESM (Beta)
image: data:image/png;base64,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
name: Palo Alto Traps ESM (Beta)
script:
  commands:
  - arguments:
    - name: hash
      required: true
    description: Retrieve details about a specific hash
    name: traps-esm-hash-detail
  - arguments:
    - description: Hash to be changed.
      name: hash
      required: true
    - auto: PREDEFINED
      description: Verdict of the hash.
      name: verdict
      predefined:
      - Benign
      - Malware
      required: true
    description: Override a verdict for a specific hash.
    name: traps-esm-override-hash-verdict
  dockerimage: demisto/btfl-soup:1.0.0.925
  runonce: false
  script: |2-



    ''' IMPORTS '''

    import json
    import requests
    from bs4 import BeautifulSoup
    from base64 import b64decode, b64encode
    from Crypto.PublicKey import RSA
    from Crypto.Cipher import PKCS1_v1_5

    # Disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    ''' GLOBALS/PARAMS '''

    USERNAME = demisto.params().get('username')
    PASSWORD = demisto.params().get('password')
    URL = demisto.params().get('url')

    USE_SSL = False


    def logout_traps():
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/74.0.3729.131 Safari/537.36",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,"
                      "application/signed-exchange;v=b3",
            "Accept-Language": "Accept-Language:en-US,en;q=0.9",
            "Accept-Encoding": "gzip, deflate"
        }
        result = requests.request('GET', URL + '/EndpointSecurityManager/Account/Logout',
                                  headers=headers, verify=USE_SSL)
        c = result.content
        demisto.results(c)


    def get_new_request_token(cookies):
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/74.0.3729.131 Safari/537.36",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,"
                      "application/signed-exchange;v=b3",
            "Accept-Language": "Accept-Language:en-US,en;q=0.9",
            "Accept-Encoding": "gzip, deflate"
        }
        result = requests.request('GET', URL + '/EndpointSecurityManager/HashManagement/Hashes',
                                  headers=headers, verify=USE_SSL, cookies=cookies)
        # Extracting Token
        c = result.content
        request_verification_token = None

        soup = BeautifulSoup(c, 'html.parser')
        request_verification_obj = soup.find('input', {"name": "__RequestVerificationToken"})
        request_verification_token = request_verification_obj['value']
        return request_verification_token


    def get_ct_cookie():
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/74.0.3729.131 Safari/537.36",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,"
                      "application/signed-exchange;v=b3",
            "Accept-Language": "Accept-Language:en-US,en;q=0.9",
            "Accept-Encoding": "gzip, deflate"
        }
        result = requests.request('GET', URL + '/EndpointSecurityManager/Account/Login',
                                  headers=headers, verify=USE_SSL)
        # Extracting Token
        c = result.content
        soup = BeautifulSoup(c, 'html.parser')
        request_verification_obj = soup.find('input', {"name": "__RequestVerificationToken"})
        request_verification_token = request_verification_obj['value']

        # Extracting Cookie
        cookie_dough = result.cookies
        ct_value = None
        for cookie in cookie_dough:
            baked_cookie = cookie.__dict__
            if baked_cookie['name'] == 'ct':
                ct_value = baked_cookie['value']
        return request_verification_token, ct_value


    def get_rsa_csid_key(request_verification_token, ct_value):
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/74.0.3729.131 Safari/537.36",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,"
                      "application/signed-exchange;v=b3",
            "Accept-Language": "Accept-Language:en-US,en;q=0.9",
            "Accept-Encoding": "gzip, deflate",
            "token": request_verification_token
        }
        cookies = {'ct': ct_value}
        result = requests.request('POST', URL + '/EndpointSecurityManager/Account/PublicKey',
                                  headers=headers, cookies=cookies, verify=USE_SSL)
        # Extracting Cookie
        cookie_dough = result.cookies
        csid = None
        for cookie in cookie_dough:
            baked_cookie = cookie.__dict__
            if baked_cookie['name'] == 'csid':
                csid = baked_cookie['value']
        # Extracting RSA
        key = result.json().get('key')
        salt = result.json().get('salt')
        return key, salt, csid


    def bytes_to_integer(data):
        output = 0
        size = len(data)
        for index in range(size):
            output |= data[index] << (8 * (size - 1 - index))
        return output


    def get_auth_cookie():
        request_verification_token, ct_value = get_ct_cookie()
        key, salt, csid = get_rsa_csid_key(request_verification_token, ct_value)
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/74.0.3729.131 Safari/537.36",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,"
                      "application/signed-exchange;v=b3",
            "Accept-Language": "Accept-Language:en-US,en;q=0.9",
            "Accept-Encoding": "gzip, deflate",
            "token": request_verification_token
        }
        cookies = {
            'ct': ct_value,
            'csid': csid
        }
        salted_password = (salt + PASSWORD).encode()

        keyDER = b64decode(key)
        keyPub = RSA.importKey(keyDER)

        # Encrypt the session key with the public RSA key
        cipher_rsa = PKCS1_v1_5.new(keyPub)
        encrypted_pass = cipher_rsa.encrypt(salted_password)
        b64pass = b64encode(encrypted_pass)

        payload = {
            "Username": USERNAME,
            "Password": b64pass
        }
        result = requests.request('POST', URL + '/EndpointSecurityManager/Account/Login',
                                  headers=headers, cookies=cookies, data=payload, verify=USE_SSL)
        # Extracting Cookie
        cookie_dough = result.cookies
        csid = None
        for cookie in cookie_dough:
            baked_cookie = cookie.__dict__
            if baked_cookie['name'] == 'auth':
                cookies['auth'] = baked_cookie['value']
        return request_verification_token, cookies


    def traps_esm_hash_detail():
        request_verification_token, cookies = get_auth_cookie()
        file_hash = demisto.args().get('hash')
        token = get_new_request_token(cookies)
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/74.0.3729.131 Safari/537.36",
            "Accept": "application/json, text/javascript, */*; q=0.01",
            "Accept-Language": "Accept-Language:en-US,en;q=0.9",
            "Accept-Encoding": "gzip, deflate",
            "Referer": URL + "/EndpointSecurityManager/HashManagement/Hashes",
            "X-Requested-With": "XMLHttpRequest",
            "Origin": URL,
            "Content-Type": "application/json; charset=UTF-8",
            "Token": token
        }
        payload_raw = {
            'hash': file_hash
        }

        payload = json.dumps(payload_raw)

        auth_cookie = {
            'ct': cookies['ct'],
            'csid': cookies['csid'],
            'auth': cookies['auth']
        }

        result = requests.request('POST', URL + '/EndpointSecurityManager/HashManagement/HashesDetail',
                                  headers=headers, cookies=auth_cookie, data=payload, verify=USE_SSL)

        hash_results = json.loads(result.content)

        hr_table = {
            'Result': hash_results['LocalAnalysis'][0]['Result'],
            'Verdict History': hash_results['VerdictHistory'],
            'Quarantined': hash_results['Quarantined']
        }

        ec = {
            'TrapsESM': hash_results
        }

        demisto.results({
            'Type': entryTypes['note'],
            'ContentsFormat': formats['markdown'],
            'Contents': 'The verdict of hash {} is {}'.format(file_hash, hash_results['LocalAnalysis'][0]['Result']),
            'HumanReadable': tableToMarkdown('Hash Verdict for {}'.format(file_hash), hr_table),
            'EntryContext': ec
        })


    def traps_esm_override_hash_verdict():
        request_verification_token, cookies = get_auth_cookie()
        token = get_new_request_token(cookies)
        file_hash = demisto.args().get('hash')
        verdict = demisto.args().get('verdict')
        headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) "
                          "Chrome/74.0.3729.131 Safari/537.36",
            "Accept": "application/json, text/javascript, */*; q=0.01",
            "Accept-Language": "Accept-Language:en-US,en;q=0.9",
            "Accept-Encoding": "gzip, deflate",
            "X-Requested-With": "XMLHttpRequest",
            "Origin": URL,
            "Content-Type": "application/json; charset=UTF-8",
            "token": token
        }
        payload = {
            'request': [file_hash],
            'verdict': verdict
        }

        result = requests.request('POST', URL + '/EndpointSecurityManager/HashManagement/OverrideHashVerdict',
                                  headers=headers, cookies=cookies, data=payload, verify=USE_SSL)

        demisto.results(result.content)


    ''' COMMANDS MANAGER / SWITCH PANEL '''

    LOG('Command being called is %s' % (demisto.command()))

    try:
        if demisto.command() == 'test-module':
            auth_cookie = get_auth_cookie()
            if auth_cookie:
                demisto.results('ok')
        elif demisto.command() == 'traps-esm-hash-detail':
            traps_esm_hash_detail()
        elif demisto.command() == 'traps-esm-override-hash-verdict':
            traps_esm_override_hash_verdict()

    # Log exceptions
    except Exception as e:
        LOG(str(e))
        LOG.print_log()
        raise
  type: python
system: true
