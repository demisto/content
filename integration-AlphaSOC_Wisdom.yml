category: Data Enrichment & Threat Intelligence
commonfields:
  id: AlphaSOC Wisdom
  version: -1
configuration:
- defaultvalue: ""
  display: AlphaSOC Wisdom API Key
  name: APIKey
  required: true
  type: 4
- defaultvalue: ""
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- defaultvalue: ""
  display: Trust any certificate (unsecure)
  name: insecure
  required: false
  type: 8
description: DNS and IP threat intelligence via the AlphaSOC platform
detaileddescription: |-
  Donâ€™t have an API key? Register at [https://alphasoc.com/wisdom](https://alphasoc.com/wisdom)

  ---

  [Click here](https://www.alphasoc.com/docs/wisdom-output-format) to discover the various flags returned by Wisdom.
display: AlphaSOC Wisdom
image: data:image/png;base64,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
name: AlphaSOC Wisdom
script:
  commands:
  - arguments:
    - description: Enter a domain or URL (e.g. www.cnn.com)
      name: domain
      required: true
    description: Returns a list of flags (categories and features) assigned to a domain
      by AlphaSOC Threat Intelligence
    name: wisdom-domain-flags
    outputs:
    - contextPath: Domain.Name
      description: Domain name
    - contextPath: Wisdom.Flag
      description: The AlphaSOC security category or feature
  - arguments:
    - defaultValue: tcp
      description: Transport layer protocol (tcp, udp, icmp)
      name: proto
      required: true
    - description: IPv4 or IPv6
      name: ip
      required: true
    - description: Destination port
      name: port
      required: true
    description: Returns a list of flags (categories and features) assigned to an
      IP connection (defined by protocol, destination address and port number) by
      AlphaSOC Threat Intelligence
    name: wisdom-ip-flags
    outputs:
    - contextPath: Wisdom.Flag
      description: The AlphaSOC security category or feature
  runonce: false
  script: |-
    var wisdomURL = 'https://api.alphasoc.net/v1/wisdom'

    var sendRequest = function(requestUrl) {
        var res = http(
            requestUrl,
            {
                Method: 'GET',
                Headers: {
                    Authorization: ['Basic ' + btoa(params.APIKey + ':')],
                    Accept: ['application/json']
                }
            },
            params.insecure,
            params.proxy
        );

        if (!res || res.StatusCode < 200 || res.StatusCode >= 300) {
            var errorString = '';

            if (res.StatusCode === 401 || res.StatusCode === 403) {
                errorString = '\n\nError: Invalid API key\n';
            }

            errorString += '\nRequest Failed'
                + '\nRequestUrl: ' + requestUrl
                + '\nStatus code: ' + res.StatusCode
                + '\nResponse: ' + JSON.stringify(res);
            throw errorString;
        }

        try {
            return JSON.parse(res.Body);
        } catch (err) {
            throw 'Failed to parse JSON response: ' + res.Body + '\n';
        }
    };

    var extractDomainName = function(url) {
        var hostname;

        //find & remove protocol (http, ftp, etc.) and get the hostname
        if (url.indexOf("://") > -1) {
            hostname = url.split('/')[2];
        }
        else {
            hostname = url ? url.split('/')[0] : '';
        }

        //find & remove port number
        hostname = hostname.split(':')[0];

        return hostname;
    }

    var getDomainWisdom = function(domain) {
        var extractedDomain = extractDomainName(domain);
        var url = wisdomURL + '?q=' + extractedDomain;
        var result = sendRequest(url);

        var ec = {
            Domain: {Name: extractedDomain},
            Wisdom: {Flag: result.flags}
        }

        var md = '#### AlphaSOC Wisdom Flags for __' + extractedDomain + '__\n';

        if (result.flags.length === 0) {
            md += '__No flags.__\n';
        } else {
            for (var i = 0; i < result.flags.length; i++) {
                md += '- ' + result.flags[i] + '\n';
            }
        }

        return {
            Type: entryTypes.note,
            EntryContext: ec,

            ContentsFormat: formats.json,
            Contents: result,

            ReadableContentsFormat: formats.markdown,
            HumanReadable: md
        };
    }

    var getIPWisdom = function(proto, ip, port) {
        var escapedIP = ip.indexOf(':') > 0 ? '[' + ip + ']' : ip;
        var query = proto + ':' + escapedIP + ':' + port;
        var url = wisdomURL + '?q=' + query;
        var result = sendRequest(url);

        var ec = {
            Wisdom: {Flag: result.flags}
        }

        var md = '#### AlphaSOC Wisdom Flags for __' + query + '__\n';

        if (result.flags.length === 0) {
            md += '__No flags.__\n';
        } else {
            for (var i = 0; i < result.flags.length; i++) {
                md += '- ' + result.flags[i] + '\n';
            }
        }

        return {
            Type: entryTypes.note,
            EntryContext: ec,

            ContentsFormat: formats.json,
            Contents: result,

            ReadableContentsFormat: formats.markdown,
            HumanReadable: md
        };
    }

    // The command input arg holds the command sent from the user.
    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            getDomainWisdom('example.com');
            return 'ok';
        case 'wisdom-domain-flags':
            return getDomainWisdom(args.domain);
        case 'wisdom-ip-flags':
            return getIPWisdom(args.proto, args.ip, args.port)
        default:
    }
  type: javascript
system: true
