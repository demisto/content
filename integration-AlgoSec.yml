category: Network Security
commonfields:
  id: AlgoSec
  version: -1
configuration:
- defaultvalue: ""
  display: Server URL (e.g. https://192.168.0.1)
  name: server
  required: true
  type: 0
- defaultvalue: ""
  display: Credentials
  name: credentials
  required: true
  type: 9
- defaultvalue: ""
  display: Trust any certificate (unsecure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ""
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
description: Algosec BusinessFlow(ABF), Firewall Analyzer (AFA) and FireFlow(AFF).
display: AlgoSec
image: data:image/png;base64,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
name: AlgoSec
script:
  commands:
  - arguments:
    - default: true
      description: ID of requested change request
      name: ticketId
      required: true
    description: Retrieves a FireFlow change request by its ID
    name: algosec-get-ticket
  - arguments:
    - description: A free text description of the issue
      name: description
    - description: A list of device names, on which the change should be made
      name: devices
    - description: |
        The device action to perform for the traffic. This can be either
        of the following: \U0010FC00 1 - Allow the traffic \U0010FC00 0 - Block the
        traffic
      name: action
      predefined:
      - "0"
      - "1"
      required: true
    - description: The destination address to perform the action on
      name: destAddress
      required: true
    - description: The source address to perform the action on
      name: sourceAddress
      required: true
    - description: The email address of the requestor
      name: requestor
      required: true
    - description: The change request's title
      name: subject
      required: true
    - description: The device service or port for the connection, for example, "http"
        or ￼￼￼￼￼￼￼￼Mandatory "tcp/123"
      name: service
      required: true
    - description: The user for the connection
      name: user
      required: true
    - description: The application for the connection
      name: application
      required: true
    description: Creates a new FireFlow change request
    name: algosec-create-ticket
  - arguments:
    - default: true
      description: The IP/Subnet to search
      name: address
      required: true
    - auto: PREDEFINED
      description: The search method for the address
      name: type
      predefined:
      - INTERSECT
      - CONTAINED
      - CONTAINING
      - EXACT
    description: Find applications containing network objects related to IP address
      using BusinessFlow
    name: algosec-get-applications
  - arguments:
    - default: true
      description: The IP/Subnet to search
      name: address
      required: true
    - auto: PREDEFINED
      description: The search method for the address (default is INTERSECT)
      name: type
      predefined:
      - INTERSECT
      - CONTAINED
      - CONTAINING
      - EXACT
    description: Find network objects related to IP address
    name: algosec-get-network-object
  - arguments:
    - default: true
      description: source(s) for the query. Multiple values are separated by commas
        (,)
      name: source
      required: true
    - description: destination(s) for the query. Multiple values are separated by
        commas (,)
      name: destination
      required: true
    - description: service(s) for the query. Multiple values are separated by commas
        (,)
      name: service
      required: true
    - description: user for the query
      name: user
    - description: application for the query
      name: application
    description: Performs a batch traffic simulation query using Firewall Analyzer
    name: algosec-query
  runonce: false
  script: |-
    var username = params.credentials.identifier;
    var password = params.credentials.password;
    var server = params.server.replace(/[\/]+$/, '');
    var insecure = params.insecure;
    var proxy = params.proxy;
    var baseAFF = server + '/WebServices/WSDispatcher.pl';
    var baseAFA = server + '/afa/php/ws.php';
    var baseBF = server + '/BusinessFlow/rest/v1/network_objects/find';

    function fillInSoapContent(content, service) {
        var request = service === 'AFF' ? '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:wsh="https://www.algosec.com/WSHandler"><soapenv:Header/><soapenv:Body>%content%</soapenv:Body></soapenv:Envelope>' : '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:afa="https://www.algosec.com/afa-ws"><soapenv:Header/><soapenv:Body>%content%</soapenv:Body></soapenv:Envelope>';
        return replaceInTemplates(request, {content: content});
    }

    function fillInSOAPRequestTemplate(method, content, service) {
        var template = service === 'AFF' ? '<wsh:%method%><FFWSHeader><version>1</version></FFWSHeader>%content%</wsh:%method%>' : '<afa:%method%>%content%</afa:%method%>';
        return fillInSoapContent(replaceInTemplates(template, {content: content, method: method}), service);
    }

    var responseDict = {
        'authenticate': /<sessionId xsi:type="xsd:string">(.*)<\/sessionId/,
        'getTicket': /<soap:Body>((.|\n)*)<\/soap:Body/,
        'createTicket': /<soap:Body>((.|\n)*)<\/soap:Body/,
        'ConnectRequest': /<SessionID>(.*)<\/SessionID/,
        'DisconnectRequest': /<ns1:DisconnectResponse>(.*)<\/ns1:DisconnectResponse/,
        'QueryRequest': /<SOAP-ENV:Body>((.|\n)*)<\/SOAP-ENV:Body/
    };

    var commandToMethod = {
        'algosec-get-ticket': 'getTicket',
        'algosec-create-ticket': 'createTicket',
        'algosec-query': 'QueryRequest'
    };

    var commandToURL = {
        'algosec-get-applications': '/applications',
        'algosec-get-network-object': ''
    };

    var sessionData = '<sessionId>%sessionId%</sessionId>';
    var methodDict = {
        'authenticate': '<username>%username%</username><password>%password%</password>',
        'getTicket': sessionData + '<ticketId>%ticketId%</ticketId>',
        'trafficLines': '<trafficLines><action>%action%</action><trafficDestination><address>%destAddress%</address></trafficDestination><trafficService><service>ftp</service></trafficService><trafficSource><address>%sourceAddress%</address></trafficSource><trafficUser><user>%user%</user></trafficUser><trafficApplication><application>%application%</application></trafficApplication></trafficLines>',
        'createTicket': sessionData + '<ticket><requestor>%requestor%</requestor><subject>%subject%</subject>%trafficLines%</ticket>',
        'ConnectRequest': '<UserName>%username%</UserName><Password>%password%</Password>',
        'DisconnectRequest': '<SessionID>%sessionId%</SessionID>',
        'QueryRequest': '<SessionID>%sessionId%</SessionID><QueryInput>%query%</QueryInput>',
        'QueryInput': '<Source>%source%</Source><Destination>%destination%</Destination><Service>%service%</Service>'
    };

    var affCommands = ['algosec-create-ticket', 'algosec-get-ticket'];
    var bfCommands = ['algosec-get-applications', 'algosec-get-network-object'];

    function createTemplate(method, args) {
        switch (method) {
            case 'createTicket':
                var trafficLines =
                (args.description ? '<description>"%description%"</description>' : '') +
                methodDict['trafficLines'];
                return replaceInTemplates(methodDict[method], {trafficLines: trafficLines});
            case 'QueryRequest':
                var query = methodDict['QueryInput'] +
                (args.user ? '<User>%user%</User>' : '') +
                (args.application ? '<Application>%application%</Application>' : '');
                return replaceInTemplates(methodDict[method], {query: query});
            default:
                return methodDict[method];
        }
    }

    function sendSOAPRequest(method, args, service) {
        var req = fillInSOAPRequestTemplate(method, replaceInTemplates(createTemplate(method, args), args), service);
        var res = http(
            service === 'AFF' ? baseAFF : baseAFA,
            {
                Method: 'POST',
                Body: req
            },
            insecure,
            proxy
        );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
                throw 'Failed to ' + method + ', request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
            }
        return res.Body;
    }

    function sendRESTRequest(url, args) {
        var res = http(
            baseBF + url + encodeToURLQuery(args),
            {
                Method: 'GET',
                Username: username,
                Password: password
            },
            insecure,
            proxy
        );
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
                throw 'Failed to ' + url + ', request status code: ' + res.StatusCode + ' and Body: ' + res.Body + '.';
            }
        return res.Body;
    }

    function sendAndParse(method, args, service) {
        var responseXML = sendSOAPRequest(method, args, service);
        var match = responseDict[method].exec(responseXML);
        if (match && match[1]) {
            return match[1];
        }
        throw method +' failed';
    }

    if (command === 'test-module') {
        if (sendAndParse('authenticate', {username: username, password: password}, 'AFF')) {
            return 'ok';
        }
        return 'something is wrong';
    }

    if (affCommands.indexOf(command) !== -1) {
        args.sessionId = sendAndParse('authenticate', {username: username, password: password}, 'AFF');
        return JSON.parse(x2j(sendAndParse(commandToMethod[command], args, 'AFF')));
    }

    if (bfCommands.indexOf(command) !== -1) {
        return JSON.parse(sendRESTRequest(commandToURL[command] ,args));
    }

    args.sessionId = sendAndParse('ConnectRequest', {username: username, password: password}, 'AFA');
    res = JSON.parse(x2j(sendAndParse(commandToMethod[command], args)));
    sendAndParse('DisconnectRequest', {sessionId: args.sessionId}, 'AFA');
    return res;
  type: javascript
system: true
