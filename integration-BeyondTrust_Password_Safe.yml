category: Authentication
commonfields:
  id: BeyondTrust Password Safe
  version: -1
configuration:
- defaultvalue: ""
  display: Server URL (e.g  https://192.168.0.1)
  name: url
  required: true
  type: 0
- defaultvalue: ""
  display: Username
  name: credentials
  required: true
  type: 9
- defaultvalue: ""
  display: API Key
  name: key
  required: true
  type: 4
- defaultvalue: ""
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ""
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- defaultvalue: ""
  display: Fetch credentials
  name: isFetchCredentials
  required: false
  type: 8
- defaultvalue: ""
  display: System Name (optional for fetch credentials)
  name: system_name
  required: false
  type: 0
description: Unified password and session management for seamless accountability and
  control over privileged accounts.
detaileddescription: |
  To configure an integration instance, you need your BeyondTrust API key. The API key is generated after you configure an API Registration. For detailed instructions, see the [BeyondTrust Password Safe Admin Guide](https://www.beyondtrust.com/docs/password-safe/documents/6-9/ps-admin-6-9-0.pdf).
display: BeyondTrust Password Safe
image: data:image/png;base64,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
name: BeyondTrust Password Safe
script:
  commands:
  - arguments: []
    description: Returns a list of managed accounts that the current user has permissions
      to request.
    name: beyondtrust-get-managed-accounts
    outputs:
    - contextPath: BeyondTrust.Account.PlatformID
      description: ID of the managed system platform.
      type: Number
    - contextPath: BeyondTrust.Account.SystemID
      description: ID of the managed system.
      type: Number
    - contextPath: BeyondTrust.Account.SystemName
      description: Name of the managed system.
      type: String
    - contextPath: BeyondTrust.Account.DomainName
      description: ID of the managed account.
      type: Number
    - contextPath: BeyondTrust.Account.AccountName
      description: Name of the managed account.
      type: String
    - contextPath: BeyondTrust.Account.InstanceName
      description: Database instance name of a database-type managed system.
      type: String
    - contextPath: BeyondTrust.Account.DefualtReleaseDuration
      description: Default release duration.
      type: Number
    - contextPath: BeyondTrust.Account.MaximumReleaseDuration
      description: Maximum release duration.
      type: Number
    - contextPath: BeyondTrust.Account.LastChangeDate
      description: The date and time of the last password change.
      type: Date
    - contextPath: BeyondTrust.Account.NexeChangeDate
      description: The date and time of the next scheduled password change.
      type: Date
    - contextPath: BeyondTrust.Account.IsChanging
      description: True if the account credentials are in the process of changing,
        otherwise false.
      type: Boolean
    - contextPath: BeyondTrust.Account.IsISAAccess
      description: True if the account is for Information Systems Administrator (ISA)
        access, otherwise false.
      type: Boolean
    - contextPath: BeyondTrust.Account.AccountID
      description: ID of the managed account.
      type: Number
  - arguments: []
    description: Returns a list of managed systems.
    name: beyondtrust-get-managed-systems
    outputs:
    - contextPath: BeyondTrust.System.Port
      description: The port used to connect to the host. If null and the related Platform.PortFlag
        is true, Password Safe uses Platform.DefaultPort for communication.
      type: Number
    - contextPath: BeyondTrust.System.Timeout
      description: Connection timeout – Length of time in seconds before a slow or
        unresponsive connection to the system fails.
      type: String
    - contextPath: BeyondTrust.System.ResetPasswordOnMismatchFlag
      description: True to queue a password change when scheduled password test fails,
        otherwise false.
      type: Boolean
    - contextPath: BeyondTrust.System.ChangeFrequencyDays
      description: When ChangeFrequencyType is “xdays”, the frequency with which the
        password changes (between 1-90 days).
      type: Number
    - contextPath: BeyondTrust.System.ISAReleaseDuration
      description: Default Information Systems Administrator (ISA) release duration.
      type: Number
    - contextPath: BeyondTrust.System.FunctionalAccountID
      description: ID of the functional account used for local Managed Account password
        changes.
      type: Number
    - contextPath: BeyondTrust.System.ChangeFrequencyType
      description: 'The change frequency for scheduled password changes: "first"–
        Changes are scheduled for the first day of the month; "last"– Changes are
        scheduled for the last day of the month; "xdays"– Changes are scheduled every
        "x" days (see ChangeFrequencyDays)'
      type: String
    - contextPath: BeyondTrust.System.DirectoryID
      description: ID of the directory. Is set if the Managed System is a Directory.
      type: Number
    - contextPath: BeyondTrust.System.ManagedAssetID
      description: ID of the Managed System.
      type: Number
    - contextPath: BeyondTrust.System.AssetID
      description: ID of the asset. Is set if the Managed System is an Asset or a
        Database.
      type: Number
    - contextPath: BeyondTrust.System.PlatformID
      description: ID of the Managed System Platform.
      type: Number
    - contextPath: BeyondTrust.System.ElevationCommand
      description: Elevation command to use (sudo, pbrun, or pmrun).
      type: String
    - contextPath: BeyondTrust.System.CheckPasswordFlag
      description: True to enable password testing, otherwise false.
      type: Boolean
    - contextPath: BeyondTrust.System.CloudID
      description: ID of the Cloud System. Is set if the Managed System is a Cloud
        System.
      type: Number
    - contextPath: BeyondTrust.System.DSSKeyRuleID
      description: ID of the default DSS Key Rule assigned to Managed Accounts that
        were created under this Managed System.
      type: Number
    - contextPath: BeyondTrust.System.PasswordRuleID
      description: ID of the default Password Rule assigned to Managed Accounts that
        were created under this Managed System.
      type: Number
    - contextPath: BeyondTrust.System.NetBiosName
      description: Domain NetBIOS name. Setting this value will allow Password Safe
        to fall back to the NetBIOS name, if needed.
      type: String
    - contextPath: BeyondTrust.System.DatabaseID
      description: ID of the database. Is set if the Managed System is a Database.
      type: Number
    - contextPath: BeyondTrust.System.MaxReleaseDuration
      description: Default maximum release duration.
      type: Number
    - contextPath: BeyondTrust.System.ChangePasswordAfterAnyReleaseFlag
      description: True to change passwords on release of a request, otherwise false.
      type: Boolean
    - contextPath: BeyondTrust.System.SystemName
      description: Name of the related entity (Asset, Directory, Database, or Cloud).
      type: String
    - contextPath: BeyondTrust.System.ReleaseDuration
      description: Default release duration.
      type: Number
    - contextPath: BeyondTrust.System.ContactEmail
      description: Email address of the user that manages the system.
      type: String
    - contextPath: BeyondTrust.System.Description
      description: The description of the system.
      type: String
    - contextPath: BeyondTrust.System.ChangeTime
      description: Time (UTC) that password changes are scheduled to occur.
      type: String
    - contextPath: BeyondTrust.System.AutoManagementFlag
      description: True if password auto-management is enabled, otherwise false.
      type: Boolean
    - contextPath: BeyondTrust.System.LoginAccountID
      description: ID of the Functional Account used for SSH session logins.
      type: Number
  - arguments:
    - auto: PREDEFINED
      description: The type of access requested (View, RDP, SSH). Defualt is "View".
      name: access_type
      predefined:
      - View
      - RDP
      - SSH
    - description: ID of the Managed System to request. Get the ID from get-managed
        accounts command
      name: system_id
      required: true
    - description: ID of the Managed Account to request. Get the ID from get-managed
        accounts command
      name: account_id
      required: true
    - description: The request duration (in minutes).
      name: duration_minutes
      required: true
    - description: The reason for the request.
      name: reason
    - auto: PREDEFINED
      description: The conflict resolution option to use if an existing request is
        found for the same user, system and account ("reuse" or "renew").
      name: conflict_option
      predefined:
      - reuse
      - renew
    description: Creates a new credentials release request.
    name: beyondtrust-create-release-request
    outputs:
    - contextPath: BeyondTrust.Request.Credentials
      description: The credentials for the requested ID.
      type: String
    - contextPath: BeyondTrust.Request.RequestID
      description: The request ID.
      type: Number
  - arguments:
    - description: ID of the request to release.
      name: request_id
      required: true
    - description: A reason or comment why the request is being released.
      name: reason
    description: Checks-in/releases a request before it expires.
    name: beyondtrust-check-in-credentials
  - arguments:
    - description: ID of the Request for which to retrieve the credentials
      name: request_id
      required: true
    description: Retrieves the credentials for an approved and active (not expired)
      credentials release request.
    name: beyondtrust-get-credentials
  - arguments:
    - description: ID of the account for which to set the credentials.
      name: account_id
      required: true
    - description: The new password to set. If not given, generates a new, random
        password.
      name: password
    - description: The new public key to set on the host. This is required if PrivateKey
        is given and updateSystem=true.
      name: public_key
    - description: The private key to set (provide Passphrase if encrypted).
      name: private_key
    - description: The passphrase to use for an encrypted private key.
      name: pass_phrase
    - auto: PREDEFINED
      defaultValue: "true"
      description: Whether to update the credentials on the referenced system.
      name: update_system
      predefined:
      - "true"
      - "false"
    description: Updates the credentials for a Managed Account, optionally applying
      the change to the Managed System.
    name: beyondtrust-change-credentials
  dockerimage: demisto/python3:3.7.3.286
  runonce: false
  script: |2-




    ''' IMPORTS '''

    import json
    import requests
    from typing import List, Dict

    # Disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    ''' GLOBALS/PARAMS '''

    USERNAME = demisto.params().get('credentials', {}).get('identifier')
    PASSWORD = demisto.params().get('credentials', {}).get('password')
    API_KEY = demisto.params().get('key')
    SYSTEM_NAME = demisto.params().get('system_name')
    # Remove trailing slash to prevent wrong URL path to service
    SERVER = demisto.params()['url'][:-1] \
        if (demisto.params()['url'] and demisto.params()['url'].endswith('/')) else demisto.params()['url']
    # Should we use SSL
    USE_SSL = not demisto.params().get('insecure', False)
    # Service base URL
    BASE_URL = SERVER + '/BeyondTrust/api/public/v3'
    # Headers to be sent in requests
    HEADERS = {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
    }

    SESSION = requests.session()
    ERR_DICT = {
        '4031': 'User does not have permission.',
        '4034': 'Request is not yet approved.',
        '4091': 'Conflicting request exists. This user or another user has already requested a password for the'
                'specified account'
    }


    ''' HELPER FUNCTIONS '''


    def http_request(method: str, suffix_url: str, data=None):
        """
        A wrapper for requests lib to send our requests and handle requests
        and responses better

        Parameters
        ----------
        method : str
            HTTP method, e.g. 'GET', 'POST' ... etc.
        suffix_url : str
            API endpoint.
        data: str
            Data to be sent in a 'POST' request.

        Returns
        -------
        Response from having made the request.
        """
        url = BASE_URL + suffix_url
        try:
            res = SESSION.request(
                method,
                url,
                verify=USE_SSL,
                data=data,  # type: ignore
                headers=HEADERS
            )
        except requests.exceptions.SSLError:
            ssl_error = 'Could not connect to BeyondTrust: Could not verify certificate.'
            return return_error(ssl_error)
        except (requests.exceptions.ConnectionError, requests.exceptions.Timeout,
                requests.exceptions.TooManyRedirects, requests.exceptions.RequestException) as e:
            connection_error = f'Could not connect to BeyondTrust: {e}'
            return return_error(connection_error)

        # Handle error responses gracefully
        if res.status_code not in {200, 201, 204}:
            txt = res.text
            if txt in ERR_DICT:
                txt = ERR_DICT[txt]
            elif res.status_code in ERR_DICT:
                txt = ERR_DICT[txt]
            elif res.status_code == 401:
                txt = 'Wrong credentials.'
            return_error(f'Error in API call to BeyondSafe Integration [{res.status_code}] - {txt})')
        try:
            return res.json()
        except ValueError:
            return None


    def signin():
        """
        Starts a session in BeyondTrust
        """
        suffix_url = '/Auth/SignAppin'
        header = {'Authorization': f'PS-Auth key={API_KEY}; runas={USERNAME}; pwd=[{PASSWORD}];'}
        SESSION.headers.update(header)
        http_request('POST', suffix_url)


    def signout():
        """
        Ends a session
        """

        suffix_url = '/auth/signout'
        http_request('POST', suffix_url)


    ''' COMMANDS + REQUESTS FUNCTIONS '''


    def get_managed_accounts_request():
        """
        Request for all managed accounts
        """
        suffix_url = '/managedaccounts'
        response = http_request('GET', suffix_url)

        return response


    def get_managed_accounts():
        """
        Returns a list of Managed Accounts that can be requested by the current user.
        """
        data = []
        headers = ['AccountName', 'AccountID', 'AssetName', 'AssetID', 'DomainName', 'LastChangeDate', 'NextChangeDate']
        managed_accounts = get_managed_accounts_request()
        for account in managed_accounts:
            data.append({
                'LastChangeDate': account.get('LastChangeDate'),
                'NextChangeDate': account.get('NextChangeDate'),
                'AssetID': account.get('SystemId'),
                'AssetName': account.get('SystemName'),
                'DomainName': account.get('DomainName'),
                'AccountID': account.get('AccountId'),
                'AccountName': account.get('AccountName')

            })

        entry_context = {'BeyondTrust.Account(val.AccountID === obj.AccountID)': managed_accounts}

        return_outputs(tableToMarkdown('BeyondTrust Managed Accounts', data, headers, removeNull=True), entry_context,
                       managed_accounts)


    def get_managed_systems_request() -> List[Dict]:
        """
        Request for all managed systems
        """
        suffix_url = '/managedsystems'
        response = http_request('GET', suffix_url)

        return response


    def get_managed_systems():
        """
        Returns a list of Managed Systems.
        """
        data = []
        managed_systems = get_managed_systems_request()
        for managed_system in managed_systems:
            data.append({
                'ManagedAssetID': managed_system.get('ManagedSystemID'),
                'ChangeFrequencyDays': managed_system.get('ChangeFrequencyDays'),
                'AssetID': managed_system.get('AssetID'),
                'DatabaseID': managed_system.get('DatabaseID'),
                'DirectoryID': managed_system.get('DirectoryID'),
                'AssetName': managed_system.get('SystemName'),
                'PlatformID': managed_system.get('PlatformID'),
                'Port': managed_system.get('Port')
            })

        entry_context = {'BeyondTrust.System(val.ManagedAssetID === obj.ManagedAssetID)': managed_systems}

        return_outputs(tableToMarkdown('BeyondTrust Managed Systems', data, removeNull=True), entry_context,
                       managed_systems)


    def create_release_request(data: str):
        """
        Request for credentials release
        """
        suffix_url = '/requests'
        response = http_request('POST', suffix_url, data=data)

        return response


    def create_release():
        """
        Creates a new release request.
        Retrieves the credentials for an approved and active (not expired) credentials release request.

        demisto parameter: (string) access_type
            The type of access requested (View, RDP, SSH). Defualt is "View".

        demisto parameter: (int) system_id
            ID of the Managed System to request.

        demisto parameter: (int) account_id
            ID of the Managed Account to request.

        demisto parameter: (int) duration_minutes
            The request duration (in minutes).

        demisto parameter: (string) reason
            The reason for the request.

        demisto parameter: (int) access_policy_schedule_id
            The Schedule ID of an Access Policy to use for the request. If omitted, automatically selects the best schedule.

        demisto parameter: (bool) conflict_option
            The conflict resolution option to use if an existing request is found for the same user,
            system, and account ("reuse" or "renew").
        """
        access_type = demisto.args().get('access_type')
        system_id = demisto.args().get('system_id')
        account_id = demisto.args().get('account_id')
        duration_minutes = demisto.args().get('duration_minutes')
        reason = demisto.args().get('reason')
        conflict_option = demisto.args().get('conflict_option')

        data = {
            'SystemId': system_id,
            'AccountId': account_id,
            'DurationMinutes': duration_minutes
        }

        if access_type:
            data['AccessType'] = access_type

        if reason:
            data['Reason'] = reason

        if conflict_option:
            data['ConflictOption'] = conflict_option

        request = create_release_request(str(data))
        request_id = str(request)

        credentials = get_credentials_request(request_id)

        response = {
            'RequestID': request_id,
            'Password': credentials
        }

        entry_context = {'BeyondTrust.Request(val.AccountID === obj.AccountID)': createContext(response)}
        return_outputs(tableToMarkdown('The new release was created successfully.', response), entry_context, response)


    def get_credentials_request(request_id: str):
        """
        Request for specific credentials
        """

        suffix_url = '/credentials/' + request_id
        response = http_request('GET', suffix_url)

        return response


    def get_credentials():
        """
        Retrieves the credentials for an approved and active (not expired) credentials release request.

        demisto parameter: (int) request_id
            ID of the Request for which to retrieve the credentials
        """

        request_id = demisto.args().get('request_id')
        request = str(request_id)
        response = get_credentials_request(request)

        demisto.results('The credentials for BeyondTrust request: ' + response)


    def check_in_credentials_request(request_id: str, data: dict):
        """
        Request for check-in credentials

        """
        suffix_url = f'/Requests/{request_id}/Checkin'
        response = http_request('PUT', suffix_url, data=json.dumps(data))

        return response


    def check_in_credentials():
        """
        Checks-in/releases a request before it has expired.

        demisto parameter: (int) request_id
            ID of the request to release.

        demisto parameter: (string) reason
            A reason or comment why the request is being released.

        """
        request_id = demisto.args().get('request_id')
        reason = str(demisto.args().get('reason'))

        data = {'Reason': reason if reason else ''}

        check_in_credentials_request(request_id, data)

        demisto.results('The release was successfully checked-in/released')


    def change_credentials_request(account_id: str, data: dict):
        """
        Request to change credentials
        """
        suffix_url = f'/ManagedAccounts/{account_id}/Credentials'
        response = http_request('PUT', suffix_url, data=json.dumps(data))

        return response


    def change_credentials():
        """
        Updates the credentials for a Managed Account, optionally applying the change to the Managed System.

        demisto parameter: (int) account_id
            ID of the account for which to set the credentials.

        demisto parameter: (string) password
            The new password to set. If not given, generates a new, random password.

        demisto parameter: (string) public_key
            The new public key to set on the host. This is required if PrivateKey is given and updateSystem=true.

        demisto parameter: (string) private_key
            The private key to set (provide Passphrase if encrypted).

        demisto parameter: (string) pass_phrase
            The passphrase to use for an encrypted private key.

        demisto parameter: (bool) update_system
            Whether to update the credentials on the referenced system.

        """
        account_id = demisto.args().get('account_id')
        password = demisto.args().get('password')
        public_key = demisto.args().get('public_key')
        private_key = demisto.args().get('private_key')
        pass_phrase = demisto.args().get('pass_phrase')
        update_system = demisto.args().get('update_system')

        data = {
            'AccountId': account_id
        }

        if password:
            data['Password'] = password

        if private_key:
            if public_key and update_system is True:
                data['PrivateKey'] = private_key
                data['PublicKey'] = public_key
            else:
                return_error('Missing public key')

        if pass_phrase:
            data['Passphrase'] = pass_phrase

        change_credentials_request(account_id, data)

        demisto.results('The password has been changed')


    def fetch_credentials():
        """
        Returns: Account's credentials
        """
        credentials = []
        identifier = demisto.args().get('identifier')
        duration_minutes = 1
        account_info = get_managed_accounts_request()

        for account in account_info:
            account_name = account.get('AccountName')
            system_name = account.get('SystemName')
            if SYSTEM_NAME and system_name != SYSTEM_NAME:
                continue
            item = {
                'SystemId': account.get('SystemId'),
                'AccountId': account.get('AccountId'),
                'DurationMinutes': duration_minutes
            }

            release_id = create_release_request(str(item))

            password = get_credentials_request(str(release_id))

            credentials.append({
                'user': account_name,
                'password': password,
                'name': system_name + '_' + account_name
            })

        if identifier:
            credentials = list(filter(lambda c: c.get('name', '') == identifier, credentials))

        demisto.credentials(credentials)


    ''' COMMANDS MANAGER / SWITCH PANEL '''

    LOG('Command being called is %s' % (demisto.command()))

    try:
        handle_proxy()
        signin()
        if demisto.command() == 'test-module':
            # This is the call made when pressing the integration test button.
            get_managed_accounts_request()
            demisto.results('ok')
        elif demisto.command() == 'beyondtrust-get-managed-accounts':
            get_managed_accounts()
        elif demisto.command() == 'beyondtrust-get-managed-systems':
            get_managed_systems()
        elif demisto.command() == 'beyondtrust-create-release-request':
            create_release()
        elif demisto.command() == 'beyondtrust-get-credentials':
            get_credentials()
        elif demisto.command() == 'beyondtrust-check-in-credentials':
            check_in_credentials()
        elif demisto.command() == 'beyondtrust-change-credentials':
            change_credentials()
        elif demisto.command() == 'fetch-credentials':
            fetch_credentials()

    # Log exceptions
    except Exception as e:
        LOG(str(e))
        LOG.print_log()
        raise
    finally:
        signout()
  subtype: python3
  type: python
system: true
