category: Network Security
commonfields:
  id: F5 firewall
  version: -1
configuration:
- defaultvalue: ""
  display: URL
  name: url
  required: true
  type: 0
- defaultvalue: "34993"
  display: Port
  name: port
  required: true
  type: 0
- defaultvalue: ""
  display: Credentials
  name: credentials
  required: true
  type: 9
- defaultvalue: "false"
  display: Advanced login - set to true to authenticate via LDAP, AD etc
  name: advancedLogin
  required: false
  type: 8
- defaultvalue: ""
  display: Trust any certificate (unsecure)
  name: insecure
  required: false
  type: 8
- defaultvalue: "true"
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
description: Manages F5 firewall rules
display: F5 firewall
image: data:image/png;base64,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
name: F5 firewall
script:
  commands:
  - arguments: []
    description: Creates an F5 firewall policy
    name: f5-create-policy
  - arguments:
    - default: true
      description: The policy name the rule will be associated with
      name: policy-name
      required: true
    description: Creates a rule in a specific policy
    name: f5-create-rule
  - arguments:
    - default: true
      description: The policy name that the rules displayed are associated with
      name: policy-name
      required: true
    description: List all the rules of a specific policy
    name: f5-list-rules
  - arguments:
    - default: true
      description: policy-name
      name: The policy name the rule is associated with
      required: true
    - description: The rule name to modify
      name: rule-name
      required: true
    description: Modifies an F5 rule in a specific policy
    name: f5-modify-rule
  - arguments:
    - default: true
      description: The policy name the rule is associated with
      name: policy-name
      required: true
    - description: The rule name to delete
      name: rule-name
      required: true
    description: Delete an F5 rule
    name: f5-del-rule
  - arguments:
    - default: true
      description: The new enforced policy to add to global policy
      name: enforcedPolicy
      required: true
    description: Add specific policy to global policy
    name: f5-modify-global-policy
  - arguments: []
    description: Display global policy
    name: f5-show-global-policy
  - arguments:
    - default: true
      description: The policy name to delete
      name: policy-name
      required: true
    description: Delete a policy
    name: f5-del-policy
  - arguments:
    - description: Client IP address
      name: resource-ip
      required: true
    description: Lists all the sessions with client ip for the given username
    name: f5-list-all-user-sessions
  runonce: false
  script: |-
    // The command input arg holds the command sent from the user.
    var testUrl = 'mgmt/shared/echo';
    var loginReferenceUrl = 'mgmt/shared/authn/login';

    var serverUrl = params.url.replace(/[\/]+$/, '') + ':' + params.port + '/';
    var proxy = params.proxy;
    var insecure = params.insecure;

    var getF5SecurityToken = function() {
        var url = serverUrl + loginReferenceUrl;
        var httpParams = {
                Method: 'POST',
                Body: JSON.stringify({
                    'username': params.credentials.identifier,
                    'password': params.credentials.password,
                    'loginProviderName': 'tmos'
                })
            };
        var res = http(url, httpParams, insecure, proxy);
        if (res.StatusCode !== 200) {
            throw 'Failed getting token from F5';
        }
        return JSON.parse(res.Body).token.token;
    };

    var sendRequest = function(method, uri, body) {
        var url = serverUrl + uri;
        var httpParams = {
                Method: method,
                Body: body
            };
        if (params.advancedLogin) {
            httpParams.Headers = {
                'X-F5-Auth-Token': [getF5SecurityToken()]
            };
        } else {
            httpParams.Username = params.credentials.identifier;
            httpParams.Password = params.credentials.password;
        }
        res = http(url, httpParams, insecure, proxy);
        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Failed getting ' + url + ' from F5, status code ' + res.StatusCode + ' and body ' + res.Body;
        }
        return JSON.parse(res.Body);
    };

    var methodDictionary = {
        show: 'GET',
        list: 'GET',
        del: 'DELETE',
        modify: 'PATCH',
        create: 'POST'
    };

    var uriDictionary = {
        'f5-create-policy': 'security/firewall/policy',
        'f5-create-rule': 'security/firewall/policy/~Common~%policy-name%/rules',
        'f5-list-rules': 'security/firewall/policy/~Common~%policy-name%/rules',
        'f5-modify-rule': 'security/firewall/policy/~Common~%policy-name%/rules/%rule-name%',
        'f5-delete-rule': 'security/firewall/policy/~Common~%policy-name%/rules/%rule-name%',
        'f5-modify-global-policy': 'security/firewall/globalRules/',
        'f5-show-global-policy': 'security/firewall/globalRules',
        'f5-del-policy': 'security/firewall/policy/~Common~%policy-name%',
        'f5-list-all-user-sessions': 'apm/access-info/stats?ver=13.0.0&options=logon-user,%resource-ip%'
    };

    var getMethod = function(command) {
        return methodDictionary[command.split('-')[1]];
    }

    var getUrl = function(command, args) {
        return 'mgmt/tm/' + replaceInTemplatesAndRemove(uriDictionary[command], args);
    }

    var buildBody = function(command, args) {
        switch (getMethod(command)) {
            case 'PATCH':
            case 'POST':
                break;
            default:
                return undefined;
        }
        return JSON.stringify(args);
    }
    switch (command) {
        case 'test-module':
            if (sendRequest('GET', testUrl)) {
                return 'ok';
            }
            return 'Gevald!!';
        default:
            return sendRequest(getMethod(command), getUrl(command, args), buildBody(command, args));
    }
  type: javascript
system: true
