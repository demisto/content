category: Network Security
commonfields:
  id: Imperva Skyfence
  version: -1
configuration:
- defaultvalue: ""
  display: Server URL (e.g., 123.168.01.222)
  name: url
  required: true
  type: 0
- defaultvalue: ""
  display: Client ID
  name: clientId
  required: true
  type: 4
- defaultvalue: ""
  display: Client Secret
  name: clientSecret
  required: true
  type: 4
- defaultvalue: "true"
  display: Insecure (over HTTP)
  name: insecure
  required: false
  type: 8
description: The Imperva Skyfence Cloud Gateway is a Cloud Access Security Broker
  (CASB) that provides visibility and control over sanctioned and unsanctioned cloud
  apps to enable their safe and productive use.
detaileddescription: "To use the Imperva Skyfence integration, you need to retrieve
  your credentials, and generate an authentication to use for all requests.\n\n##
  Get your credentials\nIn the Skyfence platform, the customer ID is the \"Client
  ID\", and the password is the \"Client Secret\".\n- To obtain these credentials,
  go to the Skyfence platform and navigate to **Settings > API**.\n \n## Generate
  an authentication token\nAll API requests require authentication. The authentication
  model is OAuth 2.0, which requires an authentication token. To receive an authentication
  token, the client performs\na token request by providing a customer ID and password.
  The received token is used in all requests.  \n \nImportant/:/ The Client Secret
  is displayed only during the initial use. Make sure you copy the Client Secret for
  further reference."
display: Imperva Skyfence
image: data:image/png;base64,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
name: Imperva Skyfence
script:
  commands:
  - arguments: []
    description: Returns a list of, and basic details for, all managed and un-managed
      endpoints.
    name: imp-sf-list-endpoints
  - arguments:
    - default: true
      description: The ID of the endpoint. Run the "imp-sf-list-endpoints" command
        to return a list.
      name: endpointId
      required: true
    - description: Enroll/Revoke endpoint status. Can be "enroll" or "revoke".
      name: action
      required: true
    description: Updates the status (enroll or revoke) of an endpoint. You can run
      this command on an endpoint with any status, but the most common use case is
      endpoints with a status of pending.
    execution: true
    name: imp-sf-set-endpoint-status
  runonce: false
  script: |-
    if (typeof params.insecure === 'string' || !params.insecure) {
        params.insecure = params.insecure === 'true' ? true : false;
    }
    var fixUrl = function(url) {
        fixedUrl = '';
        if (url.indexOf("http") !== 0) {
            if (params.insecure) {
                fixedUrl = 'http://' + url;
            } else {
                fixedUrl = 'https://' + url;
            }
        }
        return fixedUrl;
    };
    var parseResponse = function(resp) {
        var res = null;
        if (resp.StatusCode >= 200 && resp.StatusCode < 300) {
            try {
                res = JSON.parse(resp.Body);
            } catch (e) {
                res = resp.Body;
            }
        } else {
          err = resp.Status;
          if (resp.Body) {
              err += '\n' + resp.Body;
          }
          throw err;
        }
        if (res && res.length && res.length > 1 ) {
            // response body is array, then put it into object
            // we don't want to return array
            return { result: res };
        } else if (res && res.length === 0) {
            return {};
        } else {
            return res;
        }
    };
    var url = fixUrl(params.url);
    var login = function(params) {
        var fullUrl = fixUrl(params.url) + '/cm/api/v1.0/oauth2/token';
        var body = {
            grant_type: 'client_credentials',
            client_id: params.clientId,
            client_secret: params.clientSecret
        };
        var res = httpMultipart(
            fullUrl,
            '',
            {
                Method: 'POST'
            },
            body,
            params.insecure
        );
        return parseResponse(res);
    };
    var listEndpoints = function(url, token) {
        var fullUrl = fixUrl(url) + '/cm/api/v1.0/endpoint';
        var res = http(
            fullUrl,
            {
                Method: 'GET',
                Headers: {'Authorization': ['Bearer ' + token]}
            },
            params.insecure
        );
        return parseResponse(res);
    };
    var setEndpointStatus = function(url, token, endpointId, action) {
        // validate action
        // action can be "enroll" or "revoke"
        if (action !== 'enroll' && action !== 'revoke') {
            throw 'action must be "enroll" or "revoke"!';
        }
        var fullUrl = fixUrl(url) + '/cm/api/v1.0/endpoint/' + endpointId;
        var res = http(
            fullUrl,
            {
                Method: 'POST',
                Headers: {
                    'Authorization': ['Bearer ' + token],
                    'Content-Type': ['application/json']
                },
                Body: JSON.stringify({
                    action: action
                })
            },
            params.insecure
        );
        parseResponse(res);
        return 'Success';
    };
    switch(command) {
        case 'test-module':
            login(params);
            return true;
        case 'imp-sf-list-endpoints':
            var loginRes = login(params);
            return listEndpoints(params.url, loginRes.access_token);
        case 'imp-sf-set-endpoint-status':
            var loginRes = login(params);
            return setEndpointStatus(params.url, loginRes.access_token, args.endpointId, args.action);
        default:
            return true;
    }
  type: javascript
system: true
