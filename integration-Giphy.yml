category: Utilities
commonfields:
  id: Giphy
  version: -1
configuration:
- defaultvalue: http://api.giphy.com/v1/gifs/random
  display: Giphy URL
  name: url
  required: true
  type: 0
- defaultvalue: ""
  display: API Key
  name: apikey
  required: true
  type: 4
description: Display random GIF in the War Room (e.g. !giphy hello). Powered By Giphy.
detaileddescription: |-
  You can get API Key from: https://github.com/Giphy/GiphyAPI#access-and-api-keys.

  Powered By Giphy.
display: Giphy
image: data:image/png;base64,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
name: Giphy
script:
  commands:
  - arguments:
    - default: true
      description: The GIF tag to limit randomness by
      name: tag
    - auto: PREDEFINED
      description: Returns the response as JSON
      name: as-json
      predefined:
      - "true"
      - "false"
    description: Display random GIF in the War Room (e.g. !giphy hello)
    name: giphy
  runonce: false
  script: |-
    var sendRequest = function(tag) {
        var serverUrl = params.url;
        if (serverUrl[serverUrl.length - 1] === '/') {
          serverUrl = serverUrl.substring(0, serverUrl.length - 1);
        }

        var apiKey = params.apikey;
        var requestUrl = serverUrl + '?api_key=' + apiKey + '&tag=' + encodeURIComponent(tag);
        var res = http(requestUrl, { Method: 'GET' });

        if (res.StatusCode < 200 || res.StatusCode >= 300) {
            throw 'Request Failed.\nStatus code: ' + res.StatusCode + '.\nBody: ' + JSON.stringify(res) + '.';
        }

        return JSON.parse(res.Body);
    };

    // The command input arg holds the command sent from the user.
    switch (command) {
        // This is the call made when pressing the integration test button.
        case 'test-module':
            if (sendRequest(tag)) {
                return 'ok';
            }
            return 'not ok';
        case 'giphy':
            var tag = args.tag;
            var asJson = args['as-json'] === 'true';
            var res = sendRequest(tag);

            if (asJson) {
                return res;
            }

            if (res.data && res.data.fixed_height_downsampled_url) {
                var url = res.data.fixed_height_downsampled_url;
                return {
                    ContentsFormat: 'markdown',
                    Type: 1,
                    Contents: '![Giphy ' + tag + '](' + url + ')'
                };
            }

            return 'Nothing found :(';
        default:
            // do nothing
    }
  type: javascript
system: true
