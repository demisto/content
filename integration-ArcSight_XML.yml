category: Analytics & SIEM
commonfields:
  id: ArcSight XML
  version: -1
configuration:
- defaultvalue: ""
  display: Fetch incidents
  name: isFetch
  required: false
  type: 8
- defaultvalue: ""
  display: Incident type
  name: incidentType
  required: false
  type: 13
- defaultvalue: ""
  display: Directory from which to get XML files and create incidents.
  name: inputDirPath
  required: true
  type: 0
- defaultvalue: ""
  display: Directory to which put command XML files.
  name: commandsDirPath
  required: true
  type: 0
description: Create incidents and updates cases of ArcSight ESM SIEM through XML files.
  By Micro Focus (Formerly HPE Software).
display: ArcSight XML
image: data:image/png;base64,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
name: ArcSight XML
script:
  commands:
  - arguments:
    - description: ID of the case.
      name: caseId
      required: true
    - description: Name of the case.
      name: name
      required: true
    - description: The stage of the case.
      name: stage
      required: true
    description: Create an XML to update a case.
    name: arcsight-update-case
  - arguments: []
    description: Used for testing, should fetch xml file and return Demisto incident
      object
    name: arcsight-fetch-xml
  isfetch: true
  runonce: false
  script: |+
    import os
    import glob
    import datetime
    import json


    SECURITY_EVENT_START_TAG = '<SecurityEvent id="%s"'
    SECURITY_EVENT_END_TAG = '</SecurityEvent>'

    LIST_CASE_ENTRIES = ['caseEvents', 'childOf', 'ownedBy']
    TIME_CASE_ENTRIES = ['detectionTime', 'estimatedStartTime']

    SYSTEM = ''
    URI_PREFIX = ''
    TOREPLACE = '\\"\\<\\>\\(\\)'

    XML_TEMPLATE = """<?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE archive SYSTEM "../../schema/xml/archive/arcsight-archive.dtd">
    <archive buildVersion="6.9.1.2195.0" buildTime="2-9-2016_19:0:8" createTime="{0}">
        <ArchiveCreationParameters>
            <action>insert</action>
            <format>xml.external.case</format>
            <include>
                <list>
                    <ref type="Case" uri="{2}" id="{1}"/>
                </list>
            </include>
        </ArchiveCreationParameters>
        <Case id="{1}" name="{3}" action="insert" >
            <stage>{4}</stage>
        </Case>
    </archive>"""

    FILENAME_TEMPLATE = 'ExternalEventTrackingData_{0}.xml'


    def ref_to_dict(item):
        return {'type': item.get('type'), 'uri': item.get('uri'), 'id': item.get('id')}


    def build_case_data(case):
        case_data = {case_child.tag: case_child.text for case_child in case}

        # fix timestamp entries
        for name in TIME_CASE_ENTRIES:
            if name in case_data:
                case_data[name] = str(datetime.datetime.fromtimestamp(int(case_data[name]) / 1000))

        # fix list entries
        for name in LIST_CASE_ENTRIES:
            list_entry = case.find(name)
            if list_entry is not None:
                case_data[name] = json.dumps([ref_to_dict(item) for item in list_entry[0]])

        # convert to a list of 'type' and 'value'
        case_data = [{'type': key, 'value': value} for key, value in case_data.iteritems()]

        return case_data


    def parse_arcsight_xml(filepath):
        with open(filepath, 'rb') as f:
            xml_content = f.read()

        root_json = json.loads(xml2json(xml_content))
        archive_cases = root_json.get('archive', {}).get('Case')
        if archive_cases is not None and not isinstance(archive_cases, list):
            archive_cases = [archive_cases]

        cases = root_json.get('Case')
        if cases is not None and not isinstance(cases, list):
            cases = [cases]

        all_cases = []
        if cases:
            all_cases = cases
        if archive_cases:
            all_cases = archive_cases + all_cases

        archive_security_events = root_json.get('archive', {}).get('SecurityEvent')
        if archive_security_events is not None and not isinstance(archive_security_events, list):
            archive_security_events = [archive_security_events]

        security_events = root_json.get('SecurityEvent')
        if security_events is not None and not isinstance(security_events, list):
            security_events = [security_events]

        all_security_events = []
        if security_events:
            all_security_events = security_events
        if archive_security_events:
            all_security_events = archive_security_events + all_security_events

        incidents = []
        for case in all_cases:
            case_event_ids = demisto.dt(case, 'caseEvents.list.ref.@id')
            case_events = []

            for security_event in all_security_events:
                event_id = security_event.get('@id')
                if event_id in case_event_ids:
                    case_events.append(security_event)

            incident = {
                'name': '#{} - {}'.format(case.get('@id'), case.get('@name')),
                'details': json.dumps(case_events, indent=4),
                'rawJSON': json.dumps(case)
            }
            incidents.append(incident)

        os.remove(filepath)

        return incidents


    def get_incidents_from_xmls():
        filepaths = glob.glob(os.path.join(demisto.params()['inputDirPath'], '*.xml'))
        incidents = []
        for filepath in filepaths:
            incidents += parse_arcsight_xml(filepath)

        return incidents


    def create_file_locally(data, filepath):
        with open(filepath, 'w') as f:
            f.write(data)


    def update_case():
        case_id = demisto.args()['caseId']
        name = demisto.args()['name']
        stage = demisto.args()['stage']
        uri = URI_PREFIX + demisto.args()['name']
        now = time.strftime('%m-%d-%Y_%H-%M-%S.000')

        filename = FILENAME_TEMPLATE.format(now)
        filepath = os.path.join(demisto.params()['commandsDirPath'], filename)
        data = XML_TEMPLATE.format(now, case_id, uri, name, stage)

        create_file_locally(data, filepath)

        demisto.results('Modified stage to %s in case %s.' % (stage, case_id))


    if demisto.command() == 'test-module':
        demisto.results('ok')
        sys.exit(0)

    elif demisto.command() == 'fetch-incidents' or demisto.command() == 'arcsight-fetch-xml':
        incidents = get_incidents_from_xmls()
        demisto.incidents(incidents)
        sys.exit(0)

    elif demisto.command() == 'arcsight-update-case':
        update_case()

  type: python
system: true
