category: Case Management
commonfields:
  id: Centreon
  version: -1
configuration:
- defaultvalue: ""
  display: Server URL (e.g. http://147.75.33.100:20016/)
  name: server
  required: true
  type: 0
- defaultvalue: ""
  display: Username
  name: credentials
  required: true
  type: 9
- defaultvalue: ""
  display: Trust any certificate (unsecure)
  name: insecure
  required: false
  type: 8
- defaultvalue: ""
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
description: IT & Network Monitoring
display: Centreon
image: data:image/png;base64,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
name: Centreon
script:
  commands:
  - arguments:
    - auto: PREDEFINED
      description: 'select the predefined filter like in the monitoring view: all,
        unhandled, problems'
      name: viewType
      predefined:
      - all
      - unhandled
      - problems
    - description: 'the fields list that you want to get separated by a ”,”. For example:
        fields=id,name,alias,address'
      name: fields
    - auto: PREDEFINED
      description: the status of hosts that you want to get (up, down, unreachable,
        pending, all)
      name: status
      predefined:
      - up
      - down
      - unreachable
      - pending
      - all
    - description: hostgroup id filter. For example, hostgroup=2
      name: hostgroup
    - description: instance id filter. For example, instance=2
      name: instance
    - description: search pattern applied on host name. For example, search="localhost"
      name: search
    - description: a specific criticality
      name: criticality
    - auto: PREDEFINED
      description: asc,desc
      name: sortType
      predefined:
      - asc
      - desc
    - description: number of lines that you want
      name: limit
    - description: page number
      name: number
    description: 'All the monitoring information regarding hosts '
    name: centreon-get-host-status
    outputs:
    - contextPath: Centreon.Host.Output
      description: Host output
      type: string
    - contextPath: Centreon.Host.Name
      description: Host name
      type: string
    - contextPath: Centreon.Host.State
      description: Host state
    - contextPath: Centreon.Host.Address
      description: Host address
      type: string
    - contextPath: Centreon.Host.Id
      description: Host id
      type: number
  - arguments:
    - auto: PREDEFINED
      description: 'select the predefined filter like in the monitoring view: all,
        unhandled, problems'
      name: viewType
      predefined:
      - all
      - unhandled
      - problems
    - description: the fields list that you want to get separated by ",". For example,
        fields=id,description,host_id
      name: fields
    - auto: PREDEFINED
      description: the status of services that you want to get (ok, warning, critical,
        unknown, pending, all)
      name: status
      predefined:
      - ok
      - warning
      - critical
      - unknown
      - pending
      - all
    - description: hostgroup id filter. For example, hostgroup=2
      name: hostgroup
    - description: servicegroup id filter
      name: servicegroup
    - description: instance id filter. For example, instance=2
      name: instance
    - description: search pattern applied on service
      name: search
    - description: search pattern applied on host
      name: searchHost
    - description: search pattern applied on output
      name: searchOutput
    - description: a specific criticality
      name: criticality
    - auto: PREDEFINED
      description: asc or desc
      name: sortType
      predefined:
      - asc
      - desc
    - description: the amount of lines that you want
      name: limit
    - description: page number
      name: number
    description: All the monitoring information regarding services
    name: centreon-get-service-status
    outputs:
    - contextPath: Centreon.Service.Output
      description: Service output
      type: string
    - contextPath: Centreon.Service.Name
      description: Service name
      type: string
    - contextPath: Centreon.Service.ServiceId
      description: Service id
      type: number
    - contextPath: Centreon.Service.Description
      description: Service description
      type: string
    - contextPath: Centreon.Service.State
      description: Service state
  runonce: false
  script: |
    ''' IMPORTS '''
    import requests
    import json
    import os
    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    ''' GLOBAL VARS '''
    SERVER_NAME=demisto.params()['server']
    USERNAME=demisto.params()['credentials']['identifier']
    PASSWORD=demisto.params()['credentials']['password']

    BASE_URL= SERVER_NAME + 'centreon/api/index.php?'
    USE_SSL = True if demisto.params().get('insecure') else False
    DEFAULT_HEADERS = {
        'Content-Type': 'application/json'
    }

    ''' HELPER FUNCTIONS '''
    def httpRequest(method, urlSuffix, data, headers):
        data = {} if data is None else data

        url = BASE_URL + urlSuffix
        LOG('running %s request with url=%s\theaders=%s' % (method, url, headers))

        try:
            res = requests.request(method,
                url,
                verify=USE_SSL,
                params=data,
                headers=headers
            )
            res.raise_for_status()
            return res.json()

        except Exception, e:
            LOG(e)
            raise(e)

    def httpPost(urlSuffix, data=None, files=None):
        data = {} if data is None else data
        url = BASE_URL + urlSuffix
        LOG('running request with url=%s\tdata=%s\tfiles=%s' % (url, data, files))
        try:
            res = requests.post(url, data=data)
            res.raise_for_status()
            return res.json()

        except Exception, e:
            LOG(e)
            raise (e)

    def login():
      # retrieves an authentication token from Centreon
        cmd_url = 'action=authenticate'
        data = {
            'username': USERNAME,
            'password': PASSWORD
        }
        result = httpPost(cmd_url, data=data)
        return result['authToken']

    def transform_host_vals(key, value):
        # "down" and "unreachable" states can be added here after their value would be known
        host_service_status = {
          '0': "Up",
          '4': "Pending"
        }
        if (key == 'State' and value in host_service_status):
          return host_service_status[value]
        return value

    def to_upper_camel_case(word):
        return ''.join(x.capitalize() or '_' for x in word.split('_'))

    ''' COMMANDS FUNCTIONS '''

    def get_host_status():
        """ Returns the status of the connected hosts. """

        args = demisto.args()
        token = login()
        DEFAULT_HEADERS['centreon-auth-token'] = token
        cmd_url = 'object=centreon_realtime_hosts&action=list'
        return httpRequest('GET', cmd_url, args, DEFAULT_HEADERS)


    def get_host_status_command():
        """ corresponds to 'centreon-get-host-status' command. Brings the status of the connected hosts."""

        response = get_host_status()
        if (len(response) == 0):
            return "No Hosts found"

        # changing the keys from underscore notation to UpperCamelCase notation
        camel_case_response = [dict((to_upper_camel_case(k),v) for k, v in dic.iteritems()) for dic in response]
        # for the human readable - only including keys which has values. Also, transforming values from ints to readable text
        list_for_md = [dict((k, transform_host_vals(k,v)) for k, v in dic.iteritems() if (v==0 or v)) for dic in camel_case_response]

        entry = {
            'Type': entryTypes['note'],
            'Contents': camel_case_response,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Centreon Hosts status', list_for_md),
            'EntryContext': {
                  'Centreon.Host(val.Id==obj.Id)': camel_case_response
            }
        }

        return entry

    def get_service_status():
        """ Returns the status of the connected services. """

        args = demisto.args()
        token = login()
        DEFAULT_HEADERS['centreon-auth-token'] = token
        cmd_url = 'object=centreon_realtime_services&action=list'
        return httpRequest('GET', cmd_url, args, DEFAULT_HEADERS)

    def get_service_status_command():
        """ corresponds to 'centreon-get-service-status' command. Brings the status of the connected services. """

        response = get_service_status()
        if (len(response) == 0):
            return "No Services found"

        # changing the keys from underscore notation to UpperCamelCase notation
        camel_case_response = [dict((to_upper_camel_case(k),v) for k, v in dic.iteritems()) for dic in response]
        # for the human readable - only including keys which has values. Also, transforming values from ints to readable text
        list_for_md = [dict((k, transform_host_vals(k,v)) for k, v in dic.iteritems() if (v==0 or v)) for dic in camel_case_response]

        entry = {
            'Type': entryTypes['note'],
            'Contents': camel_case_response,
            'ContentsFormat': formats['json'],
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown('Centreon Services status', list_for_md),
            'EntryContext': {
                  'Centreon.Service(val.ServiceId==obj.ServiceId)': camel_case_response
            }
        }

        return entry

    ''' EXECUTION CODE '''
    LOG('command is %s' % (demisto.command(), ))
    try:
        handle_proxy()
        if demisto.command() == 'test-module':
            # This is the call made when pressing the integration test button.
            if get_host_status():
                demisto.results('ok')
            else:
                demisto.results('test failed')
        elif demisto.command() == 'centreon-get-host-status':
            demisto.results(get_host_status_command())
        elif demisto.command() == 'centreon-get-service-status':
            demisto.results(get_service_status_command())

    except Exception, e:
        LOG(e.message)
        LOG.print_log()
        raise
  type: python
system: true
